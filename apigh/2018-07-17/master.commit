{
  "sha": "39def2838ba03ba0e3bf0abc943fa61d298953a3",
  "node_id": "MDY6Q29tbWl0MTE1OTE5NDY6MzlkZWYyODM4YmEwM2JhMGUzYmYwYWJjOTQzZmE2MWQyOTg5NTNhMw==",
  "commit": {
    "author": {
      "name": "Mihai Ionut Vilcu",
      "email": "ionutvmi@gmail.com",
      "date": "2013-07-28T23:28:49Z"
    },
    "committer": {
      "name": "Mihai Ionut Vilcu",
      "email": "ionutvmi@gmail.com",
      "date": "2013-07-28T23:28:49Z"
    },
    "message": "Initial commit",
    "tree": {
      "sha": "bb414afe089b520a840caaec10685e680a3e7c47",
      "url": "https://api.github.com/repos/ionutvmi/master-comments-system/git/trees/bb414afe089b520a840caaec10685e680a3e7c47"
    },
    "url": "https://api.github.com/repos/ionutvmi/master-comments-system/git/commits/39def2838ba03ba0e3bf0abc943fa61d298953a3",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/ionutvmi/master-comments-system/commits/39def2838ba03ba0e3bf0abc943fa61d298953a3",
  "html_url": "https://github.com/ionutvmi/master-comments-system/commit/39def2838ba03ba0e3bf0abc943fa61d298953a3",
  "comments_url": "https://api.github.com/repos/ionutvmi/master-comments-system/commits/39def2838ba03ba0e3bf0abc943fa61d298953a3/comments",
  "author": {
    "login": "ionutvmi",
    "id": 3531898,
    "node_id": "MDQ6VXNlcjM1MzE4OTg=",
    "avatar_url": "https://avatars3.githubusercontent.com/u/3531898?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ionutvmi",
    "html_url": "https://github.com/ionutvmi",
    "followers_url": "https://api.github.com/users/ionutvmi/followers",
    "following_url": "https://api.github.com/users/ionutvmi/following{/other_user}",
    "gists_url": "https://api.github.com/users/ionutvmi/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ionutvmi/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ionutvmi/subscriptions",
    "organizations_url": "https://api.github.com/users/ionutvmi/orgs",
    "repos_url": "https://api.github.com/users/ionutvmi/repos",
    "events_url": "https://api.github.com/users/ionutvmi/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ionutvmi/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "ionutvmi",
    "id": 3531898,
    "node_id": "MDQ6VXNlcjM1MzE4OTg=",
    "avatar_url": "https://avatars3.githubusercontent.com/u/3531898?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ionutvmi",
    "html_url": "https://github.com/ionutvmi",
    "followers_url": "https://api.github.com/users/ionutvmi/followers",
    "following_url": "https://api.github.com/users/ionutvmi/following{/other_user}",
    "gists_url": "https://api.github.com/users/ionutvmi/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ionutvmi/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ionutvmi/subscriptions",
    "organizations_url": "https://api.github.com/users/ionutvmi/orgs",
    "repos_url": "https://api.github.com/users/ionutvmi/repos",
    "events_url": "https://api.github.com/users/ionutvmi/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ionutvmi/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "4155b52314762540e88bdc10a398945f4af260ee",
      "url": "https://api.github.com/repos/ionutvmi/master-comments-system/commits/4155b52314762540e88bdc10a398945f4af260ee",
      "html_url": "https://github.com/ionutvmi/master-comments-system/commit/4155b52314762540e88bdc10a398945f4af260ee"
    }
  ],
  "stats": {
    "total": 504,
    "additions": 443,
    "deletions": 61
  },
  "files": [
    {
      "sha": "ec525bbc9d580e0c28ab0a78fb04addff8468000",
      "filename": "README.md",
      "status": "modified",
      "additions": 81,
      "deletions": 1,
      "changes": 82,
      "blob_url": "https://github.com/ionutvmi/master-comments-system/blob/39def2838ba03ba0e3bf0abc943fa61d298953a3/README.md",
      "raw_url": "https://github.com/ionutvmi/master-comments-system/raw/39def2838ba03ba0e3bf0abc943fa61d298953a3/README.md",
      "contents_url": "https://api.github.com/repos/ionutvmi/master-comments-system/contents/README.md?ref=39def2838ba03ba0e3bf0abc943fa61d298953a3",
      "patch": "@@ -1 +1,81 @@\n-Still in development...\n\\ No newline at end of file\n+Master Comments System\n+=======================\n+\n+This is a very compact comments system with basic options: \n+* Comments can be accepted from all users or only registered users.  \n+* Admin can Edit/Delete/Ban.  \n+* Users can Edit/Delete their last posted comment.  \n+* Admin can view the IP/Browser of the user who posted the comment.  \n+* Easy integration in any kind of script.\n+* It's meant to be easy to use for basic usage, very compact and flexible.\n+\n+How to use\n+--------------\n+```php\n+\n+include 'comments.class.php';\n+\n+\n+$db_details = array(\n+\t'db_host' => 'localhost',\n+\t'db_user' => 'root',\n+\t'db_pass' => '',\n+\t'db_name' => 'test'\n+\t);\n+\n+$page_id = 1;\n+\n+$comments = new Comments_System($db_details);\n+\n+$comments->grabComment($page_id);\n+\n+if($comments->success)\n+\techo \"<div class='alert alert-success' id='comm_status'>\".$comments->success.\"</div>\";\n+else if($comments->error)\n+\techo \"<div class='alert alert-error' id='comm_status'>\".$comments->error.\"</div>\";\n+\n+// a simple form\n+echo $comments->generateForm();\n+\n+// we show the posted comments\n+echo $comments->generateComments($page_id); // we pass the page id\n+```\n+\n+You have lots of settings you can tweak\n+-------------\n+```php\n+\n+\tvar $settings = array(\n+\t\t\t'comments_table' => '_comments', // the name of the table in which the comments will be hold\n+\t\t\t'banned_table' => '_banned', // the name of the table in which the comments will be hold\n+\t\t\t'auto_install' => true, // if the class is not already installed it will attempt to install it\n+\t\t\t'public' => true, // if true unregistered users are allowed to post a comment\n+\t\t\t'optional_email' => false, // if true users don't need to enter a valid email\n+\t\t\t'isAdmin' => false, // if true some extra options are displyed delete\n+\t\t\t'adminStyle' => array( // special formating to admin messages\n+\t\t\t\t'username' => 'color: #0000ff; font-weidth: bold;', \n+\t\t\t\t'box' => 'background-color: #FFFCDD'\n+\t\t\t),\n+\t\t\t'user_details' => array( // if public is false we use this user details to the added message\n+\t\t\t\t'name' => 'user',\n+\t\t\t\t'email' => 'not_reply@gmail.com', \n+\t\t\t\t),\n+\t\t\t'sort' => 'ORDER BY `id` DESC', // the sort, this is pasted as is so make sure it is parsed\n+\t\t);\n+```\n+\n+\n+\n+\n+\n+ScreenShoots  \n+-----------------\n+![screen1](http://puu.sh/3O69V.png)  \n+--------------\n+![screen2](http://puu.sh/3O6ot.png)  \n+\n+\n+Contribute\n+---------------\n+Any contribution is gladly welcomed.  \n+This is still in early stages so if you find bugs you can report bugs [here](https://github.com/ionutvmi/master-comments-system/issues)\n\\ No newline at end of file"
    },
    {
      "sha": "dab4e9152157a864535bf1d6eef7039206be1d75",
      "filename": "admin_mode.php",
      "status": "added",
      "additions": 41,
      "deletions": 0,
      "changes": 41,
      "blob_url": "https://github.com/ionutvmi/master-comments-system/blob/39def2838ba03ba0e3bf0abc943fa61d298953a3/admin_mode.php",
      "raw_url": "https://github.com/ionutvmi/master-comments-system/raw/39def2838ba03ba0e3bf0abc943fa61d298953a3/admin_mode.php",
      "contents_url": "https://api.github.com/repos/ionutvmi/master-comments-system/contents/admin_mode.php?ref=39def2838ba03ba0e3bf0abc943fa61d298953a3",
      "patch": "@@ -0,0 +1,41 @@\n+<!DOCTYPE html>\n+<html>\n+    <head>\n+        <link href=\"//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css\" rel=\"stylesheet\"/>\n+        <title></title>\n+    </head>\n+    <body>\n+\n+<?php\n+\n+include 'comments.class.php';\n+\n+\n+$db_details = array(\n+\t'db_host' => 'localhost',\n+\t'db_user' => 'root',\n+\t'db_pass' => '',\n+\t'db_name' => 'test'\n+\t);\n+\n+\n+$settings = array('isAdmin' => true, 'public' => false); // that is all you need to specify to be in admin mode :D\n+\n+$page_id = 1;\n+\n+$comments = new Comments_System($db_details, $settings);\n+\n+$comments->grabComment($page_id);\n+\n+if($comments->success)\n+\techo \"<div class='alert alert-success' id='comm_status'>\".$comments->success.\"</div>\";\n+else if($comments->error)\n+\techo \"<div class='alert alert-error' id='comm_status'>\".$comments->error.\"</div>\";\n+\n+// a simple form\n+echo $comments->generateForm();\n+\n+// we show the posted comments\n+echo $comments->generateComments($page_id); // we pass the page id\n+\n+?>"
    },
    {
      "sha": "0ebfa3cd2df0d8e96fe5148077fca0f5545812b4",
      "filename": "comments.class.php",
      "status": "modified",
      "additions": 197,
      "deletions": 60,
      "changes": 257,
      "blob_url": "https://github.com/ionutvmi/master-comments-system/blob/39def2838ba03ba0e3bf0abc943fa61d298953a3/comments.class.php",
      "raw_url": "https://github.com/ionutvmi/master-comments-system/raw/39def2838ba03ba0e3bf0abc943fa61d298953a3/comments.class.php",
      "contents_url": "https://api.github.com/repos/ionutvmi/master-comments-system/contents/comments.class.php?ref=39def2838ba03ba0e3bf0abc943fa61d298953a3",
      "patch": "@@ -8,7 +8,7 @@\n * The intention is to make this a stand alone class so we are using ``mysqli`` to handle the mysql interactions\n * \ttherefor you will need to pass your mysql details also\n * @author  Mihai Ionut Vilcu (ionutvmi@gmail.com)\n-* 07-July-2013\n+* July-2013\n */\n class Comments_System\n {\n@@ -17,7 +17,8 @@ class Comments_System\n \t * @var array\n \t */\n \tvar $settings = array(\n-\t\t\t'table_name' => '_comments', // the name of the table in which the comments will be hold\n+\t\t\t'comments_table' => '_comments', // the name of the table in which the comments will be hold\n+\t\t\t'banned_table' => '_banned', // the name of the table in which the comments will be hold\n \t\t\t'auto_install' => true, // if the class is not already installed it will attempt to install it\n \t\t\t'public' => true, // if true unregistered users are allowed to post a comment\n \t\t\t'optional_email' => false, // if true users don't need to enter a valid email\n@@ -36,14 +37,17 @@ class Comments_System\n \tvar $error = false; // it will hold an error message if any\n \tvar $success = false; // it will hold an success message if any\n \tvar $tmp = false; // it will carry some temporary data\n-\tvar\t$ignore = array('comm_edit', 'comm_del', 'comm_reply', 'comm_ban'); // keep the url clean\n+\tvar\t$ignore = array('comm_edit', 'comm_del', 'comm_reply', 'comm_ban', 'comm_unban'); // keep the url clean\n+\tvar $checked_ips = array(); // will hold the ips checked if banned or not\n \n \t/**\n \t * setup the mysql connction and some settings\n \t * @param array $db_details contains the database details\n \t * @param array  $settings   settings to overwrite the default ones\n \t */\n \tfunction __construct($db_details , $settings = array())  {\n+\t\tif(session_id() == '')\n+\t\t\tsession_start();\n \n \t\t// we first manage the mysql connection\n \t\t$this->link = @mysqli_connect($db_details['db_host'], $db_details['db_user'], $db_details['db_pass']);\n@@ -55,24 +59,38 @@ function __construct($db_details , $settings = array())  {\n \t\t// we add the new settings if any\n \t\t$this->settings = array_merge($this->settings, $settings);\n \n-\t\t$this->settings['table_name'] = str_replace(\"`\", \"``\", $this->settings['table_name']);\n+\t\t$this->settings['comments_table'] = str_replace(\"`\", \"``\", $this->settings['comments_table']);\n \n \t\t// auto install\n-\t\tif($this->settings['auto_install'] && !@mysqli_num_rows(mysqli_query($this->link, \"SELECT `id` FROM `\".$this->settings['table_name'].\"`\")))\n+\t\tif($this->settings['auto_install'] && !@mysqli_num_rows(mysqli_query($this->link, \"SELECT `id` FROM `\".$this->settings['comments_table'].\"`\")))\n \t\t\t$this->install();\n \n \n \t\t// edit comment\n-\t\tif(isset($_POST['comm_edit']) && ($comm = mysqli_query($this->link, \"SELECT * FROM `\".$this->settings['table_name'].\"` \n+\t\tif(isset($_POST['comm_edit']) && ($comm = mysqli_query($this->link, \"SELECT * FROM `\".$this->settings['comments_table'].\"` \n \t\t\t\tWHERE `id`='\".(int)$_POST['comm_edit'].\"'\")))\n \t\t{\n \t\t\t// if the comment exists and the user has the rights to edit it\n \t\t\tif(mysqli_num_rows($comm) && $this->hasRights(mysqli_fetch_object($comm))) {\n-\t\t\t\t$this->grabComment(1, (int)$_POST['comm_edit']);\n+\t\t\t\t$this->grabComment($_SESSION['comm_pageid'], (int)$_POST['comm_edit']);\n \t\t\t\t$this->tmp = \"edited\";\n \t\t\t}\n \t\t}\n \n+\n+\t\t// delete comment\n+\t\tif(isset($_POST['comm_del']))\n+\t\t\tif($this->delComm($_POST['comm_del']))\n+\t\t\t\t$this->success = \"Comment deleted !\";\n+\n+\t\t// bann ip\n+\t\tif( isset($_GET['comm_ban']) && $this->banIP($_GET['comm_ban']) ) // we banned the ip\n+\t\t\t$this->success = \"IP banned !\";\n+\t\t\n+\t\t// UnBann ip\n+\t\tif( isset($_GET['comm_unban']) && $this->unBanIP($_GET['comm_unban']) )\n+\t\t\t$this->success = \"IP UnBanned !\";\n+\n \t\treturn true;\n \t}\n \n@@ -81,15 +99,35 @@ function __construct($db_details , $settings = array())  {\n \tfunction grabComment($pageid, $update_id = false) {\n \t\tif(session_id() == '')\n \t\t\tsession_start();\n-\t\t\n+\n+\t\t$_SESSION['comm_pageid'] = $pageid;\n \n \t\t// we make sure it's a valid post\n \t\tif(isset($_POST['comm_submit']) && isset($_SESSION['comm_token']) && ($_POST['comm_token'] === $_SESSION['comm_token']) &&\n \t\t\t($this->tmp != 'edited')) { // we make sure we don't handle the data again if it was an edit\n \n-\t\t\t$name = $_POST['comm_name'];\n+\t\t\t$name = isset($_POST['comm_name']) ? $_POST['comm_name'] : '';\n+\t\t\t$email = isset($_POST['comm_email']) ? $_POST['comm_email'] : '';\n \t\t\t\n-\t\t\t$min = $this->settings['public'] ? 2 : 0;\n+\t\t\t$min = 2;\n+\n+\t\t\tif( !$this->settings['public'] ) { // if it's not public we use the provided details\n+\t\t\t\t// if it's not public and it has $_POST[name] something is wrong\n+\t\t\t\tif(isset($_POST['comm_name'])){\n+\t\t\t\t\t$this->error = \"Something is wrong !\";\n+\t\t\t\t\treturn false;\n+\t\t\t\t}\n+\n+\t\t\t\t$min = 0;\n+\t\t\t\t$name = $this->settings['user_details']['name'];\n+\t\t\t\t$email = $this->settings['user_details']['email'];\n+\n+\t\t\t}\n+\n+\t\t\tif($this->isBanned($this->ip())) {\n+\t\t\t\t$this->error = \"You are banned !\";\n+\t\t\t\treturn false;\n+\t\t\t}\n \n \t\t\tif(!isset($name[$min])){\n \t\t\t\t$this->error = \"Invalid name !\";\n@@ -102,7 +140,6 @@ function grabComment($pageid, $update_id = false) {\n \t\t\t\treturn false;\n \t\t\t}\n \n-\t\t\t$email = $_POST['comm_email'];\n \n \t\t\t// we check in case the email is not valid\n \t\t\tif(!$this->settings['optional_email']) \n@@ -113,28 +150,36 @@ function grabComment($pageid, $update_id = false) {\n \n \n \t\t\t// we check if it's an update or a new message \n-\t\t\tif($update_id && mysqli_query($this->link, \"UPDATE `\".$this->settings['table_name'].\"` SET \n-\t\t\t\t`name` = '\".mysqli_real_escape_string($this->link, $name).\"',\n-\t\t\t\t`message` = '\".mysqli_real_escape_string($this->link, $message).\"',\n-\t\t\t\t`email` = '\".mysqli_real_escape_string($this->link, $email).\"'\n-\t\t\t\tWHERE `id` = '\".(int)$update_id.\"'\")) {\n+\t\t\tif($update_id) {\n+\t\t\t\tif( $this->settings['public'] )\n+\t\t\t\t\t$upd_fields = \",`name` = '\".mysqli_real_escape_string($this->link, $name).\"',\n+\t\t\t\t\t\t\t\t\t`email` = '\".mysqli_real_escape_string($this->link, $email).\"'\";\n+\t\t\t\telse\t\t\t\n+\t\t\t\t\t$upd_fields = '';\n+\n+\n+\t\t\t\tif(mysqli_query($this->link, \"UPDATE `\".$this->settings['comments_table'].\"` SET \n+\t\t\t\t\t`message` = '\".mysqli_real_escape_string($this->link, $message).\"'\n+\t\t\t\t\t$upd_fields\n+\t\t\t\t\tWHERE `id` = '\".(int)$update_id.\"'\")) {\n \n-\t\t\t\t\t$this->success = \"Comment edited successfully !\";\n-\t\t\t\t\treturn true;\n+\t\t\t\t\t\t$this->success = \"Comment edited successfully !\";\n+\t\t\t\t\t\treturn true;\n+\t\t\t\t}\n \t\t\t}\n \n \n \t\t\t// we check if this is a valid reply\n \t\t\tif(isset($_POST['comm_reply']) && \n-\t\t\t\tmysqli_num_rows(mysqli_query($this->link, \"SELECT `id` FROM `\".$this->settings['table_name'].\"` \n+\t\t\t\tmysqli_num_rows(mysqli_query($this->link, \"SELECT `id` FROM `\".$this->settings['comments_table'].\"` \n \t\t\t\t\tWHERE `id`= '\".(int)$_POST['comm_reply'].\"' AND `parent`  = '0'\")))\t\t\t\t\t\n \t\t\t\t\t$reply = \",`parent` = '\".(int)$_POST['comm_reply'].\"'\";\n \t\t\t\telse\n \t\t\t\t\t$reply = '';\n \n \n \n-\t\t\tif(mysqli_query($this->link, \"INSERT INTO `\".$this->settings['table_name'].\"` SET \n+\t\t\tif(mysqli_query($this->link, \"INSERT INTO `\".$this->settings['comments_table'].\"` SET \n \t\t\t\t`name` = '\".mysqli_real_escape_string($this->link, $name).\"',\n \t\t\t\t`message` = '\".mysqli_real_escape_string($this->link, $message).\"',\n \t\t\t\t`time` = '\".time().\"',\n@@ -159,10 +204,22 @@ function grabComment($pageid, $update_id = false) {\n \t\t}\n \t}\n \n-\n+\t/**\n+\t * Lists the comments for the inserted page id\n+\t * @param  integer $pageid  \n+\t * @param  integer $perpage \n+\t * @return string           the generated html code\n+\t */\n \tfunction generateComments($pageid = 0, $perpage = 10) {\n+\n+\t\tif(session_id() == '')\n+\t\t\tsession_start();\n+\n+\t\t$_SESSION['comm_pageid'] = $pageid;\n+\n \t\t$html =\"<ul class='media-list'>\";\n \n+\t\t\n \t\t$comments = $this->getComments($pageid, $perpage);\n \t\t\n \n@@ -192,10 +249,11 @@ function generateComments($pageid = 0, $perpage = 10) {\n \t\t\t\t$browser = explode(\" \", $comment->browser);\n \t\t\t\t$show_extra = \"($comment->email | \".$browser[0].\" | $comment->ip)\";\n \t\t\t}\n-\n+\t\t\t$is_del = (isset($_GET['comm_del']) && ($_GET['comm_del'] === $comment->id) && $this->hasRights($comment))\n+\t\t\t\t\t\t? \" background-color: #FFDE89; border: 1px solid red;\" : null;\n \n \t\t\t$html .= \"\n-\t\t\t<li class='media' id='$comment->id' style='$style'>\n+\t\t\t<li class='media' id='$comment->id' style='\".$style.$is_del.\"'>\n \t\t\t\t<a class='pull-left' href='http://gravatar.com'>\n \t\t\t\t<img class='media-object' src='http://gravatar.com/avatar/\".md5($comment->email).\"'>\n \t\t\t\t</a>\n@@ -210,8 +268,12 @@ function generateComments($pageid = 0, $perpage = 10) {\n \t\t\t\t\t\t<small class='muted'>\".$this->tsince($comment->time).\"</small>\n \t\t\t\t\t\t\".$this->admin_options($comment).\"\n \t\t\t\t\t</h4>\n-\t\t\t\t\t<p>\".nl2br($this->html($comment->message)).\"</p>\n-\t\t\t\t\t$show_reply\";\n+\t\t\t\t\t<p>\".nl2br($this->html($comment->message)).\"</p>\";\n+\n+\t\t\tif($is_del)\n+\t\t\t\t$html .= $this->gennerateConfirm('', 'comm_del', $comment->id);\n+\t\t\telse\n+\t\t\t\t$html .= $show_reply;\n \n \t\t\t\t$html .= $this->generateReplies($comment->id).\"\n \t\t\t\t</div>\n@@ -247,10 +309,11 @@ function generateReplies($comm_id, $limit = 3) {\n \t\t\t\t$browser = explode(\" \", $comment->browser);\n \t\t\t\t$show_extra = \"($comment->email | \".$browser[0].\" | $comment->ip)\";\n \t\t\t}\n-\n+\t\t\t$is_del = (isset($_GET['comm_del']) && ($_GET['comm_del'] === $comment->id) && $this->hasRights($comment))\n+\t\t\t\t\t\t? \" background-color: #FFDE89; border: 1px solid red;\" : null;\n \n \t\t\t$html .= \"\n-\t\t\t<div class='media' id='$comment->id' style='$style'>\n+\t\t\t<div class='media' id='$comment->id' style='\". $style. $is_del .\"'>\n \t\t\t\t<a class='pull-left' href='http://gravatar.com'>\n \t\t\t\t<img class='media-object' src='http://gravatar.com/avatar/\".md5($comment->email).\"'>\n \t\t\t\t</a>\t\n@@ -267,11 +330,12 @@ function generateReplies($comm_id, $limit = 3) {\n \t\t\t\t\t\t\".$this->admin_options($comment).\"\n \t\t\t\t\t</h4>\n \t\t\t\t\t<p>\".nl2br($this->html($comment->message)).\"</p>\";\n+\t\t\t\n+\t\t\tif($is_del)\n+\t\t\t\t$html .= $this->gennerateConfirm('', 'comm_del', $comment->id);\n \n+\t\t\t$html .= \"</div></div>\";\n \n-\n-\t\t\t$html .= \"</div>\n-\t\t\t</div>\";\n \t}\n \n \treturn $html;\n@@ -293,31 +357,35 @@ function generateForm($location =  '', $type = 0, $comment = false) {\n \t\telse\n \t\t\t$title = \"Post a comment\";\n \n-\n+\t\t$show_name_email = '';\n+\t\t\n+\t\tif( $this->settings['public'] ) {\n+\t\t\t$show_name_email = \"<div class='control-group'>\n+\t\t\t  <label class='control-label' for='comm_name'>Name</label>\n+\t\t\t  <div class='controls'>\n+\t\t\t\t<input id='comm_name' name='comm_name' type='text' class='input-xlarge' value='$comment->name'>\n+\t\t\t\t\n+\t\t\t  </div>\n+\t\t\t</div>\n+\n+\t\t\t<div class='control-group'>\n+\t\t\t  <label class='control-label' for='comm_email'>Email</label>\n+\t\t\t  <div class='controls'>\n+\t\t\t\t<input id='comm_email' name='comm_email' type='text' class='input-xlarge' value='$comment->email'>\n+\t\t\t  \t<p>\n+\t\t\t  \t\".($this->settings['optional_email'] ? \"(optional, it will not be public.)\" : \"\").\"\n+\t\t\t  \t</p>\n+\t\t\t  </div>\n+\t\t\t</div>\";\n+\t\t}\n \n \n \t\t$html = \"\n \t<form class='form-horizontal' action='$location#comm_status' method='post'>\n \t\t<fieldset>\n \t\t<legend>$title</legend>\n \n-\t\t<div class='control-group'>\n-\t\t  <label class='control-label' for='comm_name'>Name</label>\n-\t\t  <div class='controls'>\n-\t\t\t<input id='comm_name' name='comm_name' type='text' class='input-xlarge' value='$comment->name'>\n-\t\t\t\n-\t\t  </div>\n-\t\t</div>\n-\n-\t\t<div class='control-group'>\n-\t\t  <label class='control-label' for='comm_email'>Email</label>\n-\t\t  <div class='controls'>\n-\t\t\t<input id='comm_email' name='comm_email' type='text' class='input-xlarge' value='$comment->email'>\n-\t\t  \t<p>\n-\t\t  \t\".($this->settings['optional_email'] ? \"(optional, it will not be public.)\" : \"\").\"\n-\t\t  \t</p>\n-\t\t  </div>\n-\t\t</div>\n+\t\t$show_name_email\n \n \t\t<div class='control-group'>\n \t\t  <label class='control-label' for='comm_msg'>Message</label>\n@@ -347,7 +415,7 @@ function generateForm($location =  '', $type = 0, $comment = false) {\n \t */\n \tfunction install() {\n \n-\t\t$sql = \"CREATE TABLE IF NOT EXISTS `\".$this->settings['table_name'].\"` (\n+\t\t$sql = \"CREATE TABLE IF NOT EXISTS `\".$this->settings['comments_table'].\"` (\n \t\t  `id` int(11) NOT NULL AUTO_INCREMENT,\n \t\t  `name` varchar(255) NOT NULL,\n \t\t  `message` text NOT NULL,\n@@ -361,8 +429,12 @@ function install() {\n \t\t  PRIMARY KEY (`id`)\n \t\t);\";\n \n+\t\t$sql2 = \"CREATE TABLE IF NOT EXISTS `_banned` (\n+\t\t  `ip` varchar(255) NOT NULL,\n+\t\t  UNIQUE KEY `ip` (`ip`)\n+\t\t);\";\n \n-\t\tif(mysqli_query($this->link, $sql))\n+\t\tif(mysqli_query($this->link, $sql) && mysqli_query($this->link, $sql2))\n \t\t\treturn true;\n \n \t\treturn false;\n@@ -377,7 +449,7 @@ function install() {\n \tfunction getComments($pageid = 0, $perpage = 10) {\n \t\t$comments = array();\n \n-\t\t$sql = \"SELECT * FROM `\".$this->settings['table_name'].\"` WHERE `parent` = 0 \";\n+\t\t$sql = \"SELECT * FROM `\".$this->settings['comments_table'].\"` WHERE `parent` = 0 \";\n \n \t\tif($pageid)\n \t\t\t$sql .= \"AND `pageid` = '\".mysqli_real_escape_string($this->link, $pageid).\"'\";\n@@ -415,7 +487,7 @@ function getComments($pageid = 0, $perpage = 10) {\n \tfunction getReplies($comm_id = 0, $limit = 3) {\n \t\t$comments = array();\n \n-\t\t$sql = \"SELECT * FROM `\".$this->settings['table_name'].\"` \n+\t\t$sql = \"SELECT * FROM `\".$this->settings['comments_table'].\"` \n \t\t\tWHERE `parent` = '\".mysqli_real_escape_string($this->link, $comm_id).\"'\";\n \n \t\t// limitation\n@@ -587,17 +659,16 @@ function queryString($type = '', $ignore = array()) {\n \t * generates a confirmation form\n \t * @return string the html code of the form\n \t */\n-\tfunction gennerateConfirm($location = '', $info = false) {\n+\tfunction gennerateConfirm($location = '', $info_name = 'comm_del', $info_value = 0, $submit = \"I&#39;m sure, Delete\") {\n \n \t\tif($location == '')\n \t\t\t$location = \"?\".$this->queryString('', $this->ignore);\n \n \treturn \"<form class='form-horizontal' action='$location' method='post'>\n-\t\t<h3 class='text-center'>Are you sure ?</h3>\n-\t\t<div class='control-group text-center'>\n+\t\t<div class='control-group'>\n \t\t  <div class='controls'>\n-\t\t  \".($info ? \"<input type='hidden' name='comm_info' value='$info'>\" : \"\").\"\n-\t\t\t<input type='submit' id='comm_submit' name='comm_confirm' class='btn btn-primary' value='YES'>\n+\t\t  \".($info_name ? \"<input type='hidden' name='$info_name' value='$info_value'>\" : \"\").\"\n+\t\t\t<input type='submit' id='comm_submit' name='comm_confirm' class='btn btn-primary' value='$submit'>\n \t\t\t<a href='\".$_SERVER['HTTP_REFERER'].\"' class='btn'>Cancel</a>\n \t\t  </div>\n \t\t</div>\n@@ -626,8 +697,10 @@ function admin_options($comment) {\n \t\tif($this->hasRights($comment))\n \t\t\treturn \"<a href='?\".$this->queryString('', $this->ignore).\"&comm_edit=$comment->id#$comment->id'>Edit</a> \n \t\t\t\t| <a href='?\".$this->queryString('', $this->ignore).\"&comm_del=$comment->id#$comment->id'>Delete</a>\".\n-\t\t\t\t($this->settings['isAdmin'] ? \n-\t\t\t\t\t\" | <a href='?\".$this->queryString('', $this->ignore).\"&comm_ban=$comment->id#$comment->id'>Ban</a>\" : \"\");\n+\t\t\t\t($this->settings['isAdmin'] ? //if is admin \n+\t\t\t\t\t\" | <a href='?\".$this->queryString('', $this->ignore).\"&comm_\".\n+\t\t\t\t\t($this->isBanned($comment->ip) ? \"un\" : \"\").\"ban=\".urlencode($comment->ip).\"'>\".\n+\t\t\t\t\t($this->isBanned($comment->ip) ? \"Un\" : \"\").\"Ban</a>\" : \"\");\n \t}\n \n \n@@ -641,7 +714,7 @@ function admin_options($comment) {\n \tfunction generatePages($pageid, $perpage = 10){\n \n \n-\t\t$sql = \"SELECT `id` FROM `\".$this->settings['table_name'].\"` WHERE `parent` = 0 \";\n+\t\t$sql = \"SELECT `id` FROM `\".$this->settings['comments_table'].\"` WHERE `parent` = 0 \";\n \n \t\tif($pageid)\n \t\t\t$sql .=  \" AND `pageid`='\".(int)$pageid.\"'\";\n@@ -677,6 +750,70 @@ function generatePages($pageid, $perpage = 10){\n \t\treturn $html;\n \t}\n \n+\t/**\n+\t * deletes comment based on the comment id, it also checks for the rights of the user.\n+\t * @param  interger $comment_id the id of the comment to be deleted\n+\t * @return boolean             true on success\n+\t */\n+\tfunction delComm($comment_id) {\n+\t\t$comm = mysqli_query($this->link, \"SELECT `id` FROM `\".$this->settings['comments_table'].\"` WHERE `id` = '\".(int)$comment_id.\"'\");\n+\t\tif(mysqli_num_rows($comm) && $this->hasRights(mysqli_fetch_object($comm))) {\n+\t\t\tmysqli_query($this->link, \"DELETE FROM `\".$this->settings['comments_table'].\"` \n+\t\t\t\tWHERE `id` = '\".(int)$comment_id.\"' OR `parent` = '\".(int)$comment_id.\"'\");\n+\n+\t\t\treturn true;\n+\t\t}\n+\n+\t\treturn false;\n+\t}\n+\t/**\n+\t * Adds the inserted ip in the banned list\n+\t * @param  string $ip the ip to be banned\n+\t */\n+\tfunction banIP( $ip ) {\n+\t\tif($this->settings['isAdmin'])\n+\t\t\tif(mysqli_query($this->link, \"INSERT INTO `\".$this->settings['banned_table'].\"` \n+\t\t\t\tSET `ip` = '\".mysqli_real_escape_string($this->link, $ip).\"'\"))\n+\t\t\t\treturn true;\n+\t\treturn false;\n+\t}\n+\n+\t/**\n+\t * Deletes an ip from the banned list.\n+\t * @param  string $ip the ip to be unbanned\n+\t */\n+\tfunction unBanIP( $ip ) {\n+\t\tif($this->settings['isAdmin']) {\n+\t\t\tmysqli_query($this->link, \"DELETE FROM `\".$this->settings['banned_table'].\"` \n+\t\t\t\tWHERE `ip` = '\".mysqli_real_escape_string($this->link, $ip).\"'\");\n+\t\t\treturn true;\n+\t\t}\n+\n+\t\treturn false;\n+\t}\n+\t/**\n+\t * checks if an ip is banned\n+\t * @param  string $ip ip to be checked\n+\t * @return boolean     true if the ip is banned\n+\t */\n+\tfunction isBanned( $ip ) {\n+\t\t// no need to check the same ip 2 times in a row\n+\t\tif(count($this->checked_ips) && in_array($ip, array_keys($this->checked_ips)))\n+\t\t\treturn $this->checked_ips[$ip];\n+\n+\t\t$this->checked_ips[$ip] = $ip;\n+\n+\n+\t\tif(mysqli_num_rows(mysqli_query($this->link, \"SELECT * FROM `\".$this->settings['banned_table'].\"` \n+\t\t\tWHERE `ip` = '\".mysqli_real_escape_string($this->link, $ip).\"'\"))) {\n+\t\t\t$this->checked_ips[$ip] = true;\n+\t\t\treturn true;\n+\t\t}\n+\t\t$this->checked_ips[$ip] = false;\n+\n+\n+\t\treturn false;\n+\t}\n \n }\n "
    },
    {
      "sha": "e61dd6ac49677c11fee2b6399de4e48065de91d6",
      "filename": "examples.php",
      "status": "added",
      "additions": 58,
      "deletions": 0,
      "changes": 58,
      "blob_url": "https://github.com/ionutvmi/master-comments-system/blob/39def2838ba03ba0e3bf0abc943fa61d298953a3/examples.php",
      "raw_url": "https://github.com/ionutvmi/master-comments-system/raw/39def2838ba03ba0e3bf0abc943fa61d298953a3/examples.php",
      "contents_url": "https://api.github.com/repos/ionutvmi/master-comments-system/contents/examples.php?ref=39def2838ba03ba0e3bf0abc943fa61d298953a3",
      "patch": "@@ -0,0 +1,58 @@\n+<!DOCTYPE html>\n+<html>\n+    <head>\n+        <link href=\"//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css\" rel=\"stylesheet\"/>\n+        <title></title>\n+    </head>\n+    <body>\n+\n+\n+\n+\n+\n+\n+Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aut, voluptatem, ad, commodi maiores sapiente quis atque necessitatibus officia libero officiis expedita tempore id ut cum blanditiis quam magni temporibus dolor. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aut, voluptatem, ad, commodi maiores sapiente quis atque necessitatibus officia libero officiis expedita tempore id ut cum blanditiis quam magni temporibus dolor. <br><br>\n+Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aut, voluptatem, ad, commodi maiores sapiente quis atque necessitatibus officia libero officiis expedita tempore id ut cum blanditiis quam magni temporibus dolor. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aut, voluptatem, ad, commodi maiores sapiente quis atque necessitatibus officia libero officiis expedita tempore id ut cum blanditiis quam magni temporibus dolor. <br><br>\n+Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aut, voluptatem, ad, commodi maiores sapiente quis atque necessitatibus officia libero officiis expedita tempore id ut cum blanditiis quam magni temporibus dolor. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aut, voluptatem, ad, commodi maiores sapiente quis atque necessitatibus officia libero officiis expedita tempore id ut cum blanditiis quam magni temporibus dolor. <br><br>\n+Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aut, voluptatem, ad, commodi maiores sapiente quis atque necessitatibus officia libero officiis expedita tempore id ut cum blanditiis quam magni temporibus dolor. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aut, voluptatem, ad, commodi maiores sapiente quis atque necessitatibus officia libero officiis expedita tempore id ut cum blanditiis quam magni temporibus dolor. <br><br>\n+\n+\n+\n+\n+\n+\n+\n+\n+\n+<?php\n+\n+include 'comments.class.php';\n+\n+\n+$db_details = array(\n+\t'db_host' => 'localhost',\n+\t'db_user' => 'root',\n+\t'db_pass' => '',\n+\t'db_name' => 'test'\n+\t);\n+\n+$page_id = 1;\n+\n+$comments = new Comments_System($db_details);\n+\n+$comments->grabComment($page_id);\n+\n+if($comments->success)\n+\techo \"<div class='alert alert-success' id='comm_status'>\".$comments->success.\"</div>\";\n+else if($comments->error)\n+\techo \"<div class='alert alert-error' id='comm_status'>\".$comments->error.\"</div>\";\n+\n+// a simple form\n+echo $comments->generateForm();\n+\n+// we show the posted comments\n+echo $comments->generateComments($page_id); // we pass the page id\n+\n+\n+\n+?>"
    },
    {
      "sha": "9daf1b32b47088dee6247cf850585b3a6a0a40fb",
      "filename": "registered_user.php",
      "status": "added",
      "additions": 66,
      "deletions": 0,
      "changes": 66,
      "blob_url": "https://github.com/ionutvmi/master-comments-system/blob/39def2838ba03ba0e3bf0abc943fa61d298953a3/registered_user.php",
      "raw_url": "https://github.com/ionutvmi/master-comments-system/raw/39def2838ba03ba0e3bf0abc943fa61d298953a3/registered_user.php",
      "contents_url": "https://api.github.com/repos/ionutvmi/master-comments-system/contents/registered_user.php?ref=39def2838ba03ba0e3bf0abc943fa61d298953a3",
      "patch": "@@ -0,0 +1,66 @@\n+<!DOCTYPE html>\n+<html>\n+    <head>\n+        <link href=\"//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css\" rel=\"stylesheet\"/>\n+        <title></title>\n+    </head>\n+    <body>\n+\n+\n+\n+\n+\n+\n+Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aut, voluptatem, ad, commodi maiores sapiente quis atque necessitatibus officia libero officiis expedita tempore id ut cum blanditiis quam magni temporibus dolor. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aut, voluptatem, ad, commodi maiores sapiente quis atque necessitatibus officia libero officiis expedita tempore id ut cum blanditiis quam magni temporibus dolor. <br><br>\n+Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aut, voluptatem, ad, commodi maiores sapiente quis atque necessitatibus officia libero officiis expedita tempore id ut cum blanditiis quam magni temporibus dolor. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aut, voluptatem, ad, commodi maiores sapiente quis atque necessitatibus officia libero officiis expedita tempore id ut cum blanditiis quam magni temporibus dolor. <br><br>\n+Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aut, voluptatem, ad, commodi maiores sapiente quis atque necessitatibus officia libero officiis expedita tempore id ut cum blanditiis quam magni temporibus dolor. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aut, voluptatem, ad, commodi maiores sapiente quis atque necessitatibus officia libero officiis expedita tempore id ut cum blanditiis quam magni temporibus dolor. <br><br>\n+Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aut, voluptatem, ad, commodi maiores sapiente quis atque necessitatibus officia libero officiis expedita tempore id ut cum blanditiis quam magni temporibus dolor. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aut, voluptatem, ad, commodi maiores sapiente quis atque necessitatibus officia libero officiis expedita tempore id ut cum blanditiis quam magni temporibus dolor. <br><br>\n+\n+\n+\n+\n+\n+\n+\n+\n+\n+<?php\n+\n+include 'comments.class.php';\n+\n+\n+$db_details = array(\n+\t'db_host' => 'localhost',\n+\t'db_user' => 'root',\n+\t'db_pass' => '',\n+\t'db_name' => 'test'\n+\t);\n+\n+$page_id = 1;\n+\n+$settings = array(\n+\t'public' => 0,\n+\t'user_details' => array(\n+\t\t'name' => 'MyUsername',\n+\t\t'email' => 'admin@google.com'\n+\t\t)\n+\t);\n+\n+$comments = new Comments_System($db_details, $settings);\n+\n+$comments->grabComment($page_id);\n+\n+if($comments->success)\n+\techo \"<div class='alert alert-success' id='comm_status'>\".$comments->success.\"</div>\";\n+else if($comments->error)\n+\techo \"<div class='alert alert-error' id='comm_status'>\".$comments->error.\"</div>\";\n+\n+// a simple form\n+echo $comments->generateForm();\n+\n+// we show the posted comments\n+echo $comments->generateComments($page_id); // we pass the page id\n+\n+\n+\n+?>"
    }
  ]
}
