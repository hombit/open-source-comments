{
  "sha": "c801d18bd95059be32e51de21b02c2b7c4f3aa15",
  "node_id": "MDY6Q29tbWl0NjI2ODQxOTpjODAxZDE4YmQ5NTA1OWJlMzJlNTFkZTIxYjAyYzJiN2M0ZjNhYTE1",
  "commit": {
    "author": {
      "name": "Benoît Latinier",
      "email": "benoit@latinier.fr",
      "date": "2018-07-27T11:30:27Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2018-07-27T11:30:27Z"
    },
    "message": "Merge pull request #452 from Rocket1184/fetaure/client-async-comment-load\n\nAsync comment loading for dynamic websites",
    "tree": {
      "sha": "d59e11d8b0c9f5a6460e5b2d4cd1669b8fbe2e9c",
      "url": "https://api.github.com/repos/posativ/isso/git/trees/d59e11d8b0c9f5a6460e5b2d4cd1669b8fbe2e9c"
    },
    "url": "https://api.github.com/repos/posativ/isso/git/commits/c801d18bd95059be32e51de21b02c2b7c4f3aa15",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJbWwJTCRBK7hj4Ov3rIwAAdHIIAG45blYIKMq88rE/sTb+VKKX\nYi73k/ux5BeyWt7i5GppJvxPLctqoVnWtHfH6mYSmyHboGKh4KbTfffCs0k+LJxF\nR/W+Rux8Ki1h+l3/lWJ548fOsenCuE+Br1mBi+QvrY9gApb0NnKsowVi6jKfkdRU\nZTPycboP4uc8vhZURMaJ2cYiMjPI47B36hxGG3aPz6O+g+0vLI0Y7Iad/sB9HScM\nbBWla55AY7m6HiY971YmD4ToJJZpOrgHnj3qxepdqZv+jJB/wlg+XfICCHUE0YPE\ndHKtisi1x5QEYSrnqCzSp/sDjavjRsftT37WD+ncNX9JTFrxZhd9/kzdP1mdCbs=\n=Cg9h\n-----END PGP SIGNATURE-----\n",
      "payload": "tree d59e11d8b0c9f5a6460e5b2d4cd1669b8fbe2e9c\nparent 1d9cea88314bcad0d917c5b66bf16dc782849a3d\nparent 7f2b4eec8c574da587729f83e1b31be8083ec60b\nauthor Benoît Latinier <benoit@latinier.fr> 1532691027 +0200\ncommitter GitHub <noreply@github.com> 1532691027 +0200\n\nMerge pull request #452 from Rocket1184/fetaure/client-async-comment-load\n\nAsync comment loading for dynamic websites"
    }
  },
  "url": "https://api.github.com/repos/posativ/isso/commits/c801d18bd95059be32e51de21b02c2b7c4f3aa15",
  "html_url": "https://github.com/posativ/isso/commit/c801d18bd95059be32e51de21b02c2b7c4f3aa15",
  "comments_url": "https://api.github.com/repos/posativ/isso/commits/c801d18bd95059be32e51de21b02c2b7c4f3aa15/comments",
  "author": {
    "login": "blatinier",
    "id": 1086629,
    "node_id": "MDQ6VXNlcjEwODY2Mjk=",
    "avatar_url": "https://avatars0.githubusercontent.com/u/1086629?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/blatinier",
    "html_url": "https://github.com/blatinier",
    "followers_url": "https://api.github.com/users/blatinier/followers",
    "following_url": "https://api.github.com/users/blatinier/following{/other_user}",
    "gists_url": "https://api.github.com/users/blatinier/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/blatinier/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/blatinier/subscriptions",
    "organizations_url": "https://api.github.com/users/blatinier/orgs",
    "repos_url": "https://api.github.com/users/blatinier/repos",
    "events_url": "https://api.github.com/users/blatinier/events{/privacy}",
    "received_events_url": "https://api.github.com/users/blatinier/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "1d9cea88314bcad0d917c5b66bf16dc782849a3d",
      "url": "https://api.github.com/repos/posativ/isso/commits/1d9cea88314bcad0d917c5b66bf16dc782849a3d",
      "html_url": "https://github.com/posativ/isso/commit/1d9cea88314bcad0d917c5b66bf16dc782849a3d"
    },
    {
      "sha": "7f2b4eec8c574da587729f83e1b31be8083ec60b",
      "url": "https://api.github.com/repos/posativ/isso/commits/7f2b4eec8c574da587729f83e1b31be8083ec60b",
      "html_url": "https://github.com/posativ/isso/commit/7f2b4eec8c574da587729f83e1b31be8083ec60b"
    }
  ],
  "stats": {
    "total": 92,
    "additions": 73,
    "deletions": 19
  },
  "files": [
    {
      "sha": "324d52dab691eab1443d27d933b63823a55d19a0",
      "filename": "CONTRIBUTORS.txt",
      "status": "modified",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "blob_url": "https://github.com/posativ/isso/blob/c801d18bd95059be32e51de21b02c2b7c4f3aa15/CONTRIBUTORS.txt",
      "raw_url": "https://github.com/posativ/isso/raw/c801d18bd95059be32e51de21b02c2b7c4f3aa15/CONTRIBUTORS.txt",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/CONTRIBUTORS.txt?ref=c801d18bd95059be32e51de21b02c2b7c4f3aa15",
      "patch": "@@ -95,5 +95,8 @@ In chronological order:\n * Steffen Prince @sprin\n   * Upgrade to Misaka 2\n \n+* Rocka <i@rocka.me>\n+  * Implementation and documentation about async comment loading\n+\n * [Your name or handle] <[email or website]>\n   * [Brief summary of your changes]"
    },
    {
      "sha": "3f4a1f9704826e227dae358df6e414531dadf553",
      "filename": "docs/docs/extras/advanced-integration.rst",
      "status": "modified",
      "additions": 31,
      "deletions": 0,
      "changes": 31,
      "blob_url": "https://github.com/posativ/isso/blob/c801d18bd95059be32e51de21b02c2b7c4f3aa15/docs/docs/extras/advanced-integration.rst",
      "raw_url": "https://github.com/posativ/isso/raw/c801d18bd95059be32e51de21b02c2b7c4f3aa15/docs/docs/extras/advanced-integration.rst",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/docs/docs/extras/advanced-integration.rst?ref=c801d18bd95059be32e51de21b02c2b7c4f3aa15",
      "patch": "@@ -23,3 +23,34 @@ Now, either include `count.min.js` if you want to show only the comment count\n \n You can have as many comments counters as you want in a page, and they will be\n merged into a single `GET` request.\n+\n+Asynchronous comments loading\n+-----------------------------\n+\n+Isso will automatically fetch comments after `DOMContentLoaded` event. However\n+in the case where your website is creating content dynamically (eg. via ajax),\n+you need to re-fetch comment thread manually. Here is how you can re-fetch the\n+comment thread:\n+\n+.. code-block:: js\n+\n+    window.Isso.fetchComments()\n+\n+It will delete all comments under the thread but not the PostBox, fetch\n+comments with `data-isso-id` attribute of the element `section#isso-thread` (if\n+that attribute does not exist, fallback to `window.location.pathname`), then\n+fill comments into the thread. In other words, you should change `data-isso-id`\n+attribute of the element `section#isso-thread` (or modify the pathname with\n+`location.pushState`) before you can get new comments. And the thread element\n+itself should *NOT* be touched or removed.\n+\n+If you removed the `section#isso-thread` element, just create another element\n+with same TagName and ID in which you wish comments to be placed, then call the\n+`init` method of `Isso`:\n+\n+.. code-block:: js\n+\n+    window.Isso.init()\n+\n+Then Isso will initialize the comment section and fetch comments, as if the page\n+was loaded."
    },
    {
      "sha": "4e4337bb4ae5de243393e6eeec666998662cdc7b",
      "filename": "isso/js/app/api.js",
      "status": "modified",
      "additions": 4,
      "deletions": 4,
      "changes": 8,
      "blob_url": "https://github.com/posativ/isso/blob/c801d18bd95059be32e51de21b02c2b7c4f3aa15/isso/js/app/api.js",
      "raw_url": "https://github.com/posativ/isso/raw/c801d18bd95059be32e51de21b02c2b7c4f3aa15/isso/js/app/api.js",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/isso/js/app/api.js?ref=c801d18bd95059be32e51de21b02c2b7c4f3aa15",
      "patch": "@@ -3,7 +3,7 @@ define([\"app/lib/promise\", \"app/globals\"], function(Q, globals) {\n     \"use strict\";\n \n     var salt = \"Eech7co8Ohloopo9Ol6baimi\",\n-        location = window.location.pathname;\n+        location = function() { return window.location.pathname };\n \n     var script, endpoint,\n         js = document.getElementsByTagName(\"script\");\n@@ -91,7 +91,7 @@ define([\"app/lib/promise\", \"app/globals\"], function(Q, globals) {\n \n     var create = function(tid, data) {\n         var deferred = Q.defer();\n-        curl(\"POST\", endpoint + \"/new?\" + qs({uri: tid || location}), JSON.stringify(data),\n+        curl(\"POST\", endpoint + \"/new?\" + qs({uri: tid || location()}), JSON.stringify(data),\n             function (rv) {\n                 if (rv.status === 201 || rv.status === 202) {\n                     deferred.resolve(JSON.parse(rv.body));\n@@ -142,7 +142,7 @@ define([\"app/lib/promise\", \"app/globals\"], function(Q, globals) {\n         if (typeof(nested_limit) === 'undefined') { nested_limit = \"inf\"; }\n         if (typeof(parent) === 'undefined') { parent = null; }\n \n-        var query_dict = {uri: tid || location, after: lastcreated, parent: parent};\n+        var query_dict = {uri: tid || location(), after: lastcreated, parent: parent};\n \n         if(limit !== \"inf\") {\n             query_dict['limit'] = limit;\n@@ -193,7 +193,7 @@ define([\"app/lib/promise\", \"app/globals\"], function(Q, globals) {\n \n \n     var feed = function(tid) {\n-        return endpoint + \"/feed?\" + qs({uri: tid || location});\n+        return endpoint + \"/feed?\" + qs({uri: tid || location()});\n     };\n \n     var preview = function(text) {"
    },
    {
      "sha": "4e796c1b4773fb688c0a923d8ec8fb6cdf84f493",
      "filename": "isso/js/embed.js",
      "status": "modified",
      "additions": 35,
      "deletions": 15,
      "changes": 50,
      "blob_url": "https://github.com/posativ/isso/blob/c801d18bd95059be32e51de21b02c2b7c4f3aa15/isso/js/embed.js",
      "raw_url": "https://github.com/posativ/isso/raw/c801d18bd95059be32e51de21b02c2b7c4f3aa15/isso/js/embed.js",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/isso/js/embed.js?ref=c801d18bd95059be32e51de21b02c2b7c4f3aa15",
      "patch": "@@ -12,53 +12,62 @@ require([\"app/lib/ready\", \"app/config\", \"app/i18n\", \"app/api\", \"app/isso\", \"app/\n     jade.set(\"pluralize\", i18n.pluralize);\n     jade.set(\"svg\", svg);\n \n-    domready(function() {\n+    var isso_thread;\n+    var heading;\n+\n+    function init() {\n+        isso_thread = $('#isso-thread');\n+        heading = $.new(\"h4\");\n \n-        if (config[\"css\"]) {\n+        if (config[\"css\"] && $(\"style#isso-style\") === null) {\n             var style = $.new(\"style\");\n+            style.id = \"isso-style\";\n             style.type = \"text/css\";\n             style.textContent = css.inline;\n             $(\"head\").append(style);\n         }\n \n         count();\n \n-        if ($(\"#isso-thread\") === null) {\n+        if (isso_thread === null) {\n             return console.log(\"abort, #isso-thread is missing\");\n         }\n \n         if (config[\"feed\"]) {\n             var feedLink = $.new('a', i18n.translate('atom-feed'));\n             var feedLinkWrapper = $.new('span.isso-feedlink');\n-            feedLink.href = api.feed($(\"#isso-thread\").getAttribute(\"data-isso-id\"));\n-            feedLinkWrapper.appendChild(feedLink);\n-            $(\"#isso-thread\").append(feedLinkWrapper);\n+            feedLink.href = api.feed(isso_thread.getAttribute(\"data-isso-id\"));\n+            feedLinkWrapper.append(feedLink);\n+            isso_thread.append(feedLinkWrapper);\n         }\n-        $(\"#isso-thread\").append($.new('h4'));\n-        $(\"#isso-thread\").append(new isso.Postbox(null));\n-        $(\"#isso-thread\").append('<div id=\"isso-root\"></div>');\n+        isso_thread.append(heading);\n+        isso_thread.append(new isso.Postbox(null));\n+        isso_thread.append('<div id=\"isso-root\"></div>');\n+    }\n \n-        api.fetch($(\"#isso-thread\").getAttribute(\"data-isso-id\"),\n+    function fetchComments() {\n+        $('#isso-root').textContent = '';\n+        api.fetch(isso_thread.getAttribute(\"data-isso-id\") || location.pathname,\n             config[\"max-comments-top\"],\n             config[\"max-comments-nested\"]).then(\n-            function(rv) {\n+            function (rv) {\n                 if (rv.total_replies === 0) {\n-                    $(\"#isso-thread > h4\").textContent = i18n.translate(\"no-comments\");\n+                    heading.textContent = i18n.translate(\"no-comments\");\n                     return;\n                 }\n \n                 var lastcreated = 0;\n                 var count = rv.total_replies;\n                 rv.replies.forEach(function(comment) {\n                     isso.insert(comment, false);\n-                    if(comment.created > lastcreated) {\n+                    if (comment.created > lastcreated) {\n                         lastcreated = comment.created;\n                     }\n                     count = count + comment.total_replies;\n                 });\n-                $(\"#isso-thread > h4\").textContent = i18n.pluralize(\"num-comments\", count);\n+                heading.textContent = i18n.pluralize(\"num-comments\", count);\n \n-                if(rv.hidden_replies > 0) {\n+                if (rv.hidden_replies > 0) {\n                     isso.insert_loader(rv, lastcreated);\n                 }\n \n@@ -70,5 +79,16 @@ require([\"app/lib/ready\", \"app/config\", \"app/i18n\", \"app/api\", \"app/isso\", \"app/\n                 console.log(err);\n             }\n         );\n+    }\n+\n+    domready(function() {\n+        init();\n+        fetchComments();\n     });\n+\n+    window.Isso = {\n+        init: init,\n+        fetchComments: fetchComments\n+    };\n+\n });"
    }
  ]
}
