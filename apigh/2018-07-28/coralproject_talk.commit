{
  "sha": "65a166b860357d2b8ca566a273381dcd523e59e3",
  "node_id": "MDY6Q29tbWl0NzI0NTQyNDI6NjVhMTY2Yjg2MDM1N2QyYjhjYTU2NmEyNzMzODFkY2Q1MjNlNTllMw==",
  "commit": {
    "author": {
      "name": "Kim Gardner",
      "email": "kgardnr@gmail.com",
      "date": "2018-07-27T20:25:07Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2018-07-27T20:25:07Z"
    },
    "message": "Merge pull request #1767 from coralproject/token-fix\n\nToken Handling",
    "tree": {
      "sha": "2a2035d886b830a72e4c4edbc899a909534b580b",
      "url": "https://api.github.com/repos/coralproject/talk/git/trees/2a2035d886b830a72e4c4edbc899a909534b580b"
    },
    "url": "https://api.github.com/repos/coralproject/talk/git/commits/65a166b860357d2b8ca566a273381dcd523e59e3",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJbW3+jCRBK7hj4Ov3rIwAAdHIIAA+9nItYjas3+CNGtZMlVvgo\nkPtbBMDC5jw5Q/L08MQkMGWEdjoqaar4Y9fBrwmO+QKHSeOzs7tK5IgPeJssZyre\n7WUbLu13ZCC0a1rKNfPsHIVto30U1PUL+eo/mQUo4jOh6na4cuFfCCclGQ/PhMVH\n27yQtqsl1Np7b3li3B291g0xnZuJ/3EL/rrEErAwVvut9o1ABTi/4g0RTC2w/zIf\nnrZSiOYz+PziZVAVSgW4k20U3hV6dNxpZjgiVzVLJO348IZ5pkzGxjihOXQPguyf\nYAqeLN7+0D2s8AEKX6Lsy3tAVCloSlofTbYTz9V4toghXbxocwGBtQ6YQti5cGg=\n=33qR\n-----END PGP SIGNATURE-----\n",
      "payload": "tree 2a2035d886b830a72e4c4edbc899a909534b580b\nparent 30ae9a82c14d7c62b78b661d6e1b26d6b7e6c838\nparent eb4bcb71c4a903004b224cc6fcfdbf1892b1b617\nauthor Kim Gardner <kgardnr@gmail.com> 1532723107 +0100\ncommitter GitHub <noreply@github.com> 1532723107 +0100\n\nMerge pull request #1767 from coralproject/token-fix\n\nToken Handling"
    }
  },
  "url": "https://api.github.com/repos/coralproject/talk/commits/65a166b860357d2b8ca566a273381dcd523e59e3",
  "html_url": "https://github.com/coralproject/talk/commit/65a166b860357d2b8ca566a273381dcd523e59e3",
  "comments_url": "https://api.github.com/repos/coralproject/talk/commits/65a166b860357d2b8ca566a273381dcd523e59e3/comments",
  "author": {
    "login": "kgardnr",
    "id": 1077300,
    "node_id": "MDQ6VXNlcjEwNzczMDA=",
    "avatar_url": "https://avatars2.githubusercontent.com/u/1077300?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/kgardnr",
    "html_url": "https://github.com/kgardnr",
    "followers_url": "https://api.github.com/users/kgardnr/followers",
    "following_url": "https://api.github.com/users/kgardnr/following{/other_user}",
    "gists_url": "https://api.github.com/users/kgardnr/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/kgardnr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kgardnr/subscriptions",
    "organizations_url": "https://api.github.com/users/kgardnr/orgs",
    "repos_url": "https://api.github.com/users/kgardnr/repos",
    "events_url": "https://api.github.com/users/kgardnr/events{/privacy}",
    "received_events_url": "https://api.github.com/users/kgardnr/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "30ae9a82c14d7c62b78b661d6e1b26d6b7e6c838",
      "url": "https://api.github.com/repos/coralproject/talk/commits/30ae9a82c14d7c62b78b661d6e1b26d6b7e6c838",
      "html_url": "https://github.com/coralproject/talk/commit/30ae9a82c14d7c62b78b661d6e1b26d6b7e6c838"
    },
    {
      "sha": "eb4bcb71c4a903004b224cc6fcfdbf1892b1b617",
      "url": "https://api.github.com/repos/coralproject/talk/commits/eb4bcb71c4a903004b224cc6fcfdbf1892b1b617",
      "html_url": "https://github.com/coralproject/talk/commit/eb4bcb71c4a903004b224cc6fcfdbf1892b1b617"
    }
  ],
  "stats": {
    "total": 29,
    "additions": 16,
    "deletions": 13
  },
  "files": [
    {
      "sha": "079d56dcf458031b414dda7bcfd3834bf5c1a2ef",
      "filename": "client/coral-framework/actions/auth.js",
      "status": "modified",
      "additions": 3,
      "deletions": 3,
      "changes": 6,
      "blob_url": "https://github.com/coralproject/talk/blob/65a166b860357d2b8ca566a273381dcd523e59e3/client/coral-framework/actions/auth.js",
      "raw_url": "https://github.com/coralproject/talk/raw/65a166b860357d2b8ca566a273381dcd523e59e3/client/coral-framework/actions/auth.js",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/client/coral-framework/actions/auth.js?ref=65a166b860357d2b8ca566a273381dcd523e59e3",
      "patch": "@@ -17,19 +17,19 @@ export const checkLogin = () => (\n       if (!result.user) {\n         cleanAuthData(localStorage);\n         dispatch(checkLoginSuccess(null));\n+        client.resetWebsocket();\n         return;\n       }\n \n-      // Reset the websocket.\n-      client.resetWebsocket();\n-\n       dispatch(checkLoginSuccess(result.user));\n       pym.sendMessage('coral-auth-changed', JSON.stringify(result.user));\n+      client.resetWebsocket();\n     })\n     .catch(error => {\n       if (error.status && error.status === 401 && localStorage) {\n         // Unauthorized.\n         cleanAuthData(localStorage);\n+        client.resetWebsocket();\n       } else {\n         console.error(error);\n       }"
    },
    {
      "sha": "d1c6e23fe1d08ae18c8bbf5970924f8d4df713e4",
      "filename": "client/coral-framework/reducers/config.js",
      "status": "modified",
      "additions": 9,
      "deletions": 2,
      "changes": 11,
      "blob_url": "https://github.com/coralproject/talk/blob/65a166b860357d2b8ca566a273381dcd523e59e3/client/coral-framework/reducers/config.js",
      "raw_url": "https://github.com/coralproject/talk/raw/65a166b860357d2b8ca566a273381dcd523e59e3/client/coral-framework/reducers/config.js",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/client/coral-framework/reducers/config.js?ref=65a166b860357d2b8ca566a273381dcd523e59e3",
      "patch": "@@ -3,9 +3,11 @@ import {\n   ENABLE_PLUGINS_DEBUG,\n   DISABLE_PLUGINS_DEBUG,\n } from '../constants/config';\n-import { LOGOUT } from '../constants/auth';\n+import { LOGOUT, SET_AUTH_TOKEN } from '../constants/auth';\n \n-const initialState = {};\n+const initialState = {\n+  auth_token: null,\n+};\n \n export default function config(state = initialState, action) {\n   switch (action.type) {\n@@ -30,6 +32,11 @@ export default function config(state = initialState, action) {\n         ...state,\n         auth_token: null,\n       };\n+    case SET_AUTH_TOKEN:\n+      return {\n+        ...state,\n+        auth_token: action.token || null,\n+      };\n     case MERGE_CONFIG:\n       return {\n         ...state,"
    },
    {
      "sha": "be0955d8fe1c44c088ce4b244cce5653a7d56e0a",
      "filename": "client/coral-framework/services/bootstrap.js",
      "status": "modified",
      "additions": 4,
      "deletions": 8,
      "changes": 12,
      "blob_url": "https://github.com/coralproject/talk/blob/65a166b860357d2b8ca566a273381dcd523e59e3/client/coral-framework/services/bootstrap.js",
      "raw_url": "https://github.com/coralproject/talk/raw/65a166b860357d2b8ca566a273381dcd523e59e3/client/coral-framework/services/bootstrap.js",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/client/coral-framework/services/bootstrap.js?ref=65a166b860357d2b8ca566a273381dcd523e59e3",
      "patch": "@@ -42,17 +42,13 @@ const getAuthToken = (store, storage) => {\n   let state = store.getState();\n \n   if (state.config && state.config.auth_token) {\n-    // if an auth_token exists in config, use it.\n-    return state.config.auth_token;\n+    // If the embed is called with `embed.login(token)`, and the browser is not\n+    // capable of storing the token in localStorage, then we would have\n+    // persisted it to the redux state.\n+    return state.config.auth_token || state.auth.token;\n   } else if (!bowser.safari && !bowser.ios && storage) {\n     // Use local storage auth tokens where there's a stable api.\n     return storage.getItem('token');\n-  } else if (state.auth && state.auth.token) {\n-    // Use the redux token state if the remaining methods fall out. If the embed\n-    // is called with `embed.login(token)`, and the browser is not capable of\n-    // storing the token in localStorage, then we would have persisted it to the\n-    // redux state.\n-    return state.auth.token;\n   }\n \n   return null;"
    }
  ]
}
