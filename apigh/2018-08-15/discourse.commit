{
  "sha": "ac3b0f0164c2d9e79237fa312bc57846383e1348",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODphYzNiMGYwMTY0YzJkOWU3OTIzN2ZhMzEyYmM1Nzg0NjM4M2UxMzQ4",
  "commit": {
    "author": {
      "name": "Neil Lalonde",
      "email": "neillalonde@gmail.com",
      "date": "2018-08-14T21:29:43Z"
    },
    "committer": {
      "name": "Neil Lalonde",
      "email": "neillalonde@gmail.com",
      "date": "2018-08-15T16:37:52Z"
    },
    "message": "REFACTOR: move remap out of script into a class",
    "tree": {
      "sha": "8207e6851ecc815ffc509bff9dba70e1604d4f85",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/8207e6851ecc815ffc509bff9dba70e1604d4f85"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/ac3b0f0164c2d9e79237fa312bc57846383e1348",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/ac3b0f0164c2d9e79237fa312bc57846383e1348",
  "html_url": "https://github.com/discourse/discourse/commit/ac3b0f0164c2d9e79237fa312bc57846383e1348",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/ac3b0f0164c2d9e79237fa312bc57846383e1348/comments",
  "author": {
    "login": "nlalonde",
    "id": 151885,
    "node_id": "MDQ6VXNlcjE1MTg4NQ==",
    "avatar_url": "https://avatars2.githubusercontent.com/u/151885?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nlalonde",
    "html_url": "https://github.com/nlalonde",
    "followers_url": "https://api.github.com/users/nlalonde/followers",
    "following_url": "https://api.github.com/users/nlalonde/following{/other_user}",
    "gists_url": "https://api.github.com/users/nlalonde/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nlalonde/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nlalonde/subscriptions",
    "organizations_url": "https://api.github.com/users/nlalonde/orgs",
    "repos_url": "https://api.github.com/users/nlalonde/repos",
    "events_url": "https://api.github.com/users/nlalonde/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nlalonde/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "nlalonde",
    "id": 151885,
    "node_id": "MDQ6VXNlcjE1MTg4NQ==",
    "avatar_url": "https://avatars2.githubusercontent.com/u/151885?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nlalonde",
    "html_url": "https://github.com/nlalonde",
    "followers_url": "https://api.github.com/users/nlalonde/followers",
    "following_url": "https://api.github.com/users/nlalonde/following{/other_user}",
    "gists_url": "https://api.github.com/users/nlalonde/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nlalonde/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nlalonde/subscriptions",
    "organizations_url": "https://api.github.com/users/nlalonde/orgs",
    "repos_url": "https://api.github.com/users/nlalonde/repos",
    "events_url": "https://api.github.com/users/nlalonde/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nlalonde/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "7b089f7af453685a743106f3310ce4535f1d1963",
      "url": "https://api.github.com/repos/discourse/discourse/commits/7b089f7af453685a743106f3310ce4535f1d1963",
      "html_url": "https://github.com/discourse/discourse/commit/7b089f7af453685a743106f3310ce4535f1d1963"
    }
  ],
  "stats": {
    "total": 81,
    "additions": 51,
    "deletions": 30
  },
  "files": [
    {
      "sha": "45755fb3310e9e39fc703b22d435f7dd8b1494a1",
      "filename": "lib/remap.rb",
      "status": "added",
      "additions": 43,
      "deletions": 0,
      "changes": 43,
      "blob_url": "https://github.com/discourse/discourse/blob/ac3b0f0164c2d9e79237fa312bc57846383e1348/lib/remap.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/ac3b0f0164c2d9e79237fa312bc57846383e1348/lib/remap.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/lib/remap.rb?ref=ac3b0f0164c2d9e79237fa312bc57846383e1348",
      "patch": "@@ -0,0 +1,43 @@\n+class Remap\n+  def initialize(from, to, regex: false, verbose: false)\n+    @from = from\n+    @to = to\n+    @regex = regex\n+    @verbose = verbose\n+  end\n+\n+  def perform\n+    sql = \"SELECT table_name, column_name\n+FROM information_schema.columns\n+WHERE table_schema='public' and (data_type like 'char%' or data_type like 'text%') and is_updatable = 'YES'\"\n+\n+    cnn = ActiveRecord::Base.connection.raw_connection\n+\n+    results = cnn.async_exec(sql).to_a\n+\n+    results.each do |result|\n+      table_name = result[\"table_name\"]\n+      column_name = result[\"column_name\"]\n+\n+      log \"Remapping #{table_name} #{column_name}\"\n+\n+      result = if @regex\n+        cnn.async_exec(\"UPDATE #{table_name}\n+          SET #{column_name} = regexp_replace(#{column_name}, $1, $2, 'g')\n+          WHERE NOT #{column_name} IS NULL\n+            AND #{column_name} <> regexp_replace(#{column_name}, $1, $2, 'g')\", [@from, @to])\n+      else\n+        cnn.async_exec(\"UPDATE #{table_name}\n+          SET #{column_name} = replace(#{column_name}, $1, $2)\n+          WHERE NOT #{column_name} IS NULL\n+            AND #{column_name} <> replace(#{column_name}, $1, $2)\", [@from, @to])\n+      end\n+\n+      log \"#{result.cmd_tuples} rows affected!\"\n+    end\n+  end\n+\n+  def log(message)\n+    puts(message) if @verbose\n+  end\n+end"
    },
    {
      "sha": "3cf57078fe2564a3631c02552803e4dbaf5b6223",
      "filename": "script/discourse",
      "status": "modified",
      "additions": 8,
      "deletions": 30,
      "changes": 38,
      "blob_url": "https://github.com/discourse/discourse/blob/ac3b0f0164c2d9e79237fa312bc57846383e1348/script/discourse",
      "raw_url": "https://github.com/discourse/discourse/raw/ac3b0f0164c2d9e79237fa312bc57846383e1348/script/discourse",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/script/discourse?ref=ac3b0f0164c2d9e79237fa312bc57846383e1348",
      "patch": "@@ -30,6 +30,7 @@ class DiscourseCLI < Thor\n   option :regex, type: :boolean\n   def remap(from, to)\n     load_rails\n+    require 'remap'\n \n     if options[:regex]\n       puts \"Rewriting all occurences of #{from} to #{to} using regexp_replace\"\n@@ -237,36 +238,13 @@ class DiscourseCLI < Thor\n   end\n \n   def do_remap(from, to, regex = false)\n-    sql = \"SELECT table_name, column_name\n-FROM information_schema.columns\n-WHERE table_schema='public' and (data_type like 'char%' or data_type like 'text%') and is_updatable = 'YES'\"\n-\n-    cnn = ActiveRecord::Base.connection.raw_connection\n-\n-    results = cnn.async_exec(sql).to_a\n-\n-    results.each do |result|\n-      table_name = result[\"table_name\"]\n-      column_name = result[\"column_name\"]\n-      puts \"Remapping #{table_name} #{column_name}\"\n-      begin\n-        result = if regex\n-          cnn.async_exec(\"UPDATE #{table_name}\n-            SET #{column_name} = regexp_replace(#{column_name}, $1, $2, 'g')\n-            WHERE NOT #{column_name} IS NULL\n-              AND #{column_name} <> regexp_replace(#{column_name}, $1, $2, 'g')\", [from, to])\n-        else\n-          cnn.async_exec(\"UPDATE #{table_name}\n-            SET #{column_name} = replace(#{column_name}, $1, $2)\n-            WHERE NOT #{column_name} IS NULL\n-              AND #{column_name} <> replace(#{column_name}, $1, $2)\", [from, to])\n-        end\n-        puts \"#{result.cmd_tuples} rows affected!\"\n-      rescue => ex\n-        puts \"Error: #{ex}\"\n-        puts \"The remap has only been partially applied due to the error above. Please re-run the script again.\"\n-        exit(1)\n-      end\n+    begin\n+      Remap.new(from, to, regex: regex, verbose: true).perform\n+      puts 'Done', ''\n+    rescue => ex\n+      puts \"Error: #{ex}\"\n+      puts \"The remap has only been partially applied due to the error above. Please re-run the script again.\"\n+      exit(1)\n     end\n   end\n "
    }
  ]
}
