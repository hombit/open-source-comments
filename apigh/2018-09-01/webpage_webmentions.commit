{
  "sha": "349e0e55cc8ef41494debe9d4fc114bccf23be7a",
  "node_id": "MDY6Q29tbWl0MTI2ODkxODQ6MzQ5ZTBlNTVjYzhlZjQxNDk0ZGViZTlkNGZjMTE0YmNjZjIzYmU3YQ==",
  "commit": {
    "author": {
      "name": "Pelle Wessman",
      "email": "pelle@kodfabrik.se",
      "date": "2018-08-31T17:03:06Z"
    },
    "committer": {
      "name": "Pelle Wessman",
      "email": "pelle@kodfabrik.se",
      "date": "2018-08-31T17:03:22Z"
    },
    "message": "Move to \"knex-migrator-extension\" for migrations",
    "tree": {
      "sha": "6e076f1f47c57997b75d18133437a7addce075e9",
      "url": "https://api.github.com/repos/voxpelli/webpage-webmentions/git/trees/6e076f1f47c57997b75d18133437a7addce075e9"
    },
    "url": "https://api.github.com/repos/voxpelli/webpage-webmentions/git/commits/349e0e55cc8ef41494debe9d4fc114bccf23be7a",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/voxpelli/webpage-webmentions/commits/349e0e55cc8ef41494debe9d4fc114bccf23be7a",
  "html_url": "https://github.com/voxpelli/webpage-webmentions/commit/349e0e55cc8ef41494debe9d4fc114bccf23be7a",
  "comments_url": "https://api.github.com/repos/voxpelli/webpage-webmentions/commits/349e0e55cc8ef41494debe9d4fc114bccf23be7a/comments",
  "author": {
    "login": "voxpelli",
    "id": 34457,
    "node_id": "MDQ6VXNlcjM0NDU3",
    "avatar_url": "https://avatars1.githubusercontent.com/u/34457?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/voxpelli",
    "html_url": "https://github.com/voxpelli",
    "followers_url": "https://api.github.com/users/voxpelli/followers",
    "following_url": "https://api.github.com/users/voxpelli/following{/other_user}",
    "gists_url": "https://api.github.com/users/voxpelli/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/voxpelli/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/voxpelli/subscriptions",
    "organizations_url": "https://api.github.com/users/voxpelli/orgs",
    "repos_url": "https://api.github.com/users/voxpelli/repos",
    "events_url": "https://api.github.com/users/voxpelli/events{/privacy}",
    "received_events_url": "https://api.github.com/users/voxpelli/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "voxpelli",
    "id": 34457,
    "node_id": "MDQ6VXNlcjM0NDU3",
    "avatar_url": "https://avatars1.githubusercontent.com/u/34457?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/voxpelli",
    "html_url": "https://github.com/voxpelli",
    "followers_url": "https://api.github.com/users/voxpelli/followers",
    "following_url": "https://api.github.com/users/voxpelli/following{/other_user}",
    "gists_url": "https://api.github.com/users/voxpelli/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/voxpelli/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/voxpelli/subscriptions",
    "organizations_url": "https://api.github.com/users/voxpelli/orgs",
    "repos_url": "https://api.github.com/users/voxpelli/repos",
    "events_url": "https://api.github.com/users/voxpelli/events{/privacy}",
    "received_events_url": "https://api.github.com/users/voxpelli/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "82e54e63af38b27242ed6364620bfa68446ca0c8",
      "url": "https://api.github.com/repos/voxpelli/webpage-webmentions/commits/82e54e63af38b27242ed6364620bfa68446ca0c8",
      "html_url": "https://github.com/voxpelli/webpage-webmentions/commit/82e54e63af38b27242ed6364620bfa68446ca0c8"
    }
  ],
  "stats": {
    "total": 97,
    "additions": 40,
    "deletions": 57
  },
  "files": [
    {
      "sha": "ea39a8718b50b4629584c0a6f1b53dd60f6b9bc4",
      "filename": "lib/install-schema.js",
      "status": "modified",
      "additions": 1,
      "deletions": 47,
      "changes": 48,
      "blob_url": "https://github.com/voxpelli/webpage-webmentions/blob/349e0e55cc8ef41494debe9d4fc114bccf23be7a/lib/install-schema.js",
      "raw_url": "https://github.com/voxpelli/webpage-webmentions/raw/349e0e55cc8ef41494debe9d4fc114bccf23be7a/lib/install-schema.js",
      "contents_url": "https://api.github.com/repos/voxpelli/webpage-webmentions/contents/lib/install-schema.js?ref=349e0e55cc8ef41494debe9d4fc114bccf23be7a",
      "patch": "@@ -1,10 +1,5 @@\n 'use strict';\n \n-// Copied from https://github.com/tgriesser/knex/pull/2695/files to replace previous call to now deleted this._migrationData()\n-const _interopRequireWildcard = function (obj) { if (obj && obj.__esModule) { return obj; } else { const newObj = {}; if (obj != null) { for (let key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } };\n-const _migrationListResolver = require('knex/lib/migrate/migration-list-resolver');\n-const migrationListResolver = _interopRequireWildcard(_migrationListResolver);\n-\n const knex = require('./knex');\n const options = require('./config');\n const tables = [\n@@ -99,33 +94,6 @@ const install = function () {\n   // *** End of schema definition ***\n \n   ]).then(() => {\n-    // Ensure that migrations not needed due to new install becomes flagged as already installed\n-\n-    const migrator = knex.migrate;\n-\n-    // Own code to tell that the new schema already is up to date\n-    const setInitialMigrationState = function (config) {\n-      this.config = this.setConfig(config);\n-      return migrationListResolver\n-        .listAllAndCompleted(this.config, this.knex, this._absoluteConfigDir())\n-        .then(result => {\n-          const migrations = [];\n-          const migrationTime = new Date();\n-\n-          result[0].forEach(migration => {\n-            migrations.push({\n-              name: migration,\n-              batch: 0,\n-              migration_time: migrationTime\n-            });\n-          });\n-\n-          return knex(this.config.tableName).insert(migrations);\n-        });\n-    };\n-\n-    return setInitialMigrationState.call(migrator);\n-  }).then(() => {\n     if (options.env !== 'production') {\n       return knex('accounts').insert({\n         'service': 'dummy',\n@@ -138,18 +106,4 @@ const install = function () {\n \n install.tables = tables;\n \n-if (require.main !== module) {\n-  module.exports = install;\n-} else {\n-  install()\n-    .then(() => {\n-      knex.destroy();\n-\n-      console.log('Success!');\n-    })\n-    .catch(err => {\n-      knex.destroy();\n-\n-      console.error('Failed with error:', err);\n-    });\n-}\n+module.exports = install;"
    },
    {
      "sha": "59e5a7a6cc41a18ddd1db84141b315febcbeb7e3",
      "filename": "lib/knex.js",
      "status": "modified",
      "additions": 14,
      "deletions": 2,
      "changes": 16,
      "blob_url": "https://github.com/voxpelli/webpage-webmentions/blob/349e0e55cc8ef41494debe9d4fc114bccf23be7a/lib/knex.js",
      "raw_url": "https://github.com/voxpelli/webpage-webmentions/raw/349e0e55cc8ef41494debe9d4fc114bccf23be7a/lib/knex.js",
      "contents_url": "https://api.github.com/repos/voxpelli/webpage-webmentions/contents/lib/knex.js?ref=349e0e55cc8ef41494debe9d4fc114bccf23be7a",
      "patch": "@@ -1,6 +1,18 @@\n 'use strict';\n \n-module.exports = require('knex')({\n+const pathModule = require('path');\n+\n+const db = Object.freeze({\n   client: 'pg',\n-  connection: require('./config').db\n+  connection: require('./config').db,\n+  migrations: {\n+    install: pathModule.join(__dirname, './lib/install-schema'),\n+    directory: pathModule.join(__dirname, './migrations')\n+  }\n });\n+\n+module.exports = {\n+  development: db,\n+  staging: db,\n+  production: db\n+};"
    },
    {
      "sha": "3fc65ac4a3c1d253601fc27799e7db9f06587f06",
      "filename": "package.json",
      "status": "modified",
      "additions": 4,
      "deletions": 3,
      "changes": 7,
      "blob_url": "https://github.com/voxpelli/webpage-webmentions/blob/349e0e55cc8ef41494debe9d4fc114bccf23be7a/package.json",
      "raw_url": "https://github.com/voxpelli/webpage-webmentions/raw/349e0e55cc8ef41494debe9d4fc114bccf23be7a/package.json",
      "contents_url": "https://api.github.com/repos/voxpelli/webpage-webmentions/contents/package.json?ref=349e0e55cc8ef41494debe9d4fc114bccf23be7a",
      "patch": "@@ -22,6 +22,7 @@\n     \"faker\": \"^2.1.1\",\n     \"fetch-politely\": \"^2.0.0-1\",\n     \"knex\": \"^0.15.2\",\n+    \"knex-migrator-extension\": \"^0.1.4\",\n     \"lodash.clonedeep\": \"^4.5.0\",\n     \"lodash.escape\": \"^4.0.1\",\n     \"lodash.intersection\": \"^4.4.0\",\n@@ -55,9 +56,9 @@\n     \"test\": \"concurrently -r 'eslint .' 'installed-check -n -e -i newrelic' 'npm run --silent dependency-check' 'npm run --silent mocha'\",\n     \"build\": \"node -e \\\"require('grunt').tasks(['build']);\\\"\",\n     \"build-dev\": \"node -e \\\"require('grunt').tasks(['build-dev']);\\\"\",\n-    \"install-schema\": \"node lib/install-schema.js\",\n-    \"migrate-schema\": \"./node_modules/.bin/knex migrate:latest\",\n-    \"rollback-schema\": \"./node_modules/.bin/knex migrate:rollback\"\n+    \"install-schema\": \"knex-migrator-extension migrate:install\",\n+    \"migrate-schema\": \"knex-migrator-extension migrate:latest\",\n+    \"rollback-schema\": \"knex-migrator-extension migrate:rollback\"\n   },\n   \"private\": true,\n   \"devDependencies\": {"
    },
    {
      "sha": "d1b983e50accfa7f061828b8510187484bbeb42a",
      "filename": "yarn.lock",
      "status": "modified",
      "additions": 21,
      "deletions": 5,
      "changes": 26,
      "blob_url": "https://github.com/voxpelli/webpage-webmentions/blob/349e0e55cc8ef41494debe9d4fc114bccf23be7a/yarn.lock",
      "raw_url": "https://github.com/voxpelli/webpage-webmentions/raw/349e0e55cc8ef41494debe9d4fc114bccf23be7a/yarn.lock",
      "contents_url": "https://api.github.com/repos/voxpelli/webpage-webmentions/contents/yarn.lock?ref=349e0e55cc8ef41494debe9d4fc114bccf23be7a",
      "patch": "@@ -429,7 +429,7 @@ bluebird@3.4.x:\n   version \"3.4.7\"\n   resolved \"https://registry.yarnpkg.com/bluebird/-/bluebird-3.4.7.tgz#f72d760be09b7f76d08ed8fae98b289a8d05fab3\"\n \n-bluebird@^3.5.1:\n+bluebird@^3.0.5, bluebird@^3.5.1:\n   version \"3.5.1\"\n   resolved \"https://registry.yarnpkg.com/bluebird/-/bluebird-3.5.1.tgz#d9551f9de98f1fcda1e683d17ee91a0602ee2eb9\"\n \n@@ -628,7 +628,7 @@ chalk@2.3.2:\n     escape-string-regexp \"^1.0.5\"\n     supports-color \"^5.3.0\"\n \n-chalk@^1.0.0, chalk@^1.1.3:\n+chalk@^1.0.0, chalk@^1.1.1, chalk@^1.1.3:\n   version \"1.1.3\"\n   resolved \"https://registry.yarnpkg.com/chalk/-/chalk-1.1.3.tgz#a8115c55e4a702fe4d150abd3872822a7e09fc98\"\n   dependencies:\n@@ -763,7 +763,7 @@ commander@2.15.1:\n   version \"2.15.1\"\n   resolved \"https://registry.yarnpkg.com/commander/-/commander-2.15.1.tgz#df46e867d0fc2aec66a34662b406a9ccafff5b0f\"\n \n-commander@^2.16.0:\n+commander@^2.16.0, commander@^2.9.0:\n   version \"2.17.1\"\n   resolved \"https://registry.yarnpkg.com/commander/-/commander-2.17.1.tgz#bd77ab7de6de94205ceacc72f1716d29f20a77bf\"\n \n@@ -2119,6 +2119,10 @@ installed-check@^2.2.0:\n     read-package-json \"^2.0.3\"\n     semver \"^5.1.0\"\n \n+interpret@^0.6.6:\n+  version \"0.6.6\"\n+  resolved \"https://registry.yarnpkg.com/interpret/-/interpret-0.6.6.tgz#fecd7a18e7ce5ca6abfb953e1f86213a49f1625b\"\n+\n interpret@^1.1.0:\n   version \"1.1.0\"\n   resolved \"https://registry.yarnpkg.com/interpret/-/interpret-1.1.0.tgz#7ed1b1410c6a0e0f78cf95d3b8440c63f78b8614\"\n@@ -2468,6 +2472,18 @@ kind-of@^6.0.0, kind-of@^6.0.2:\n   version \"6.0.2\"\n   resolved \"https://registry.yarnpkg.com/kind-of/-/kind-of-6.0.2.tgz#01146b36a6218e64e58f3a8d66de5d7fc6f6d051\"\n \n+knex-migrator-extension@^0.1.4:\n+  version \"0.1.4\"\n+  resolved \"https://registry.yarnpkg.com/knex-migrator-extension/-/knex-migrator-extension-0.1.4.tgz#d41043d308a30275057c330400e7eb8b8ca5f8ef\"\n+  dependencies:\n+    bluebird \"^3.0.5\"\n+    chalk \"^1.1.1\"\n+    commander \"^2.9.0\"\n+    interpret \"^0.6.6\"\n+    liftoff \"^2.2.0\"\n+    minimist \"^1.2.0\"\n+    tildify \"^1.1.2\"\n+\n knex@^0.15.2:\n   version \"0.15.2\"\n   resolved \"https://registry.yarnpkg.com/knex/-/knex-0.15.2.tgz#6059b87489605f4cc87599a6d2a9d265709e9340\"\n@@ -2510,7 +2526,7 @@ levn@^0.3.0, levn@~0.3.0:\n     prelude-ls \"~1.1.2\"\n     type-check \"~0.3.2\"\n \n-liftoff@2.5.0:\n+liftoff@2.5.0, liftoff@^2.2.0:\n   version \"2.5.0\"\n   resolved \"https://registry.yarnpkg.com/liftoff/-/liftoff-2.5.0.tgz#2009291bb31cea861bbf10a7c15a28caf75c31ec\"\n   dependencies:\n@@ -4263,7 +4279,7 @@ through@2, through@^2.3.6:\n   version \"2.3.8\"\n   resolved \"https://registry.yarnpkg.com/through/-/through-2.3.8.tgz#0dd4c9ffaabc357960b1b724115d7e0e86a2e1f5\"\n \n-tildify@1.2.0:\n+tildify@1.2.0, tildify@^1.1.2:\n   version \"1.2.0\"\n   resolved \"https://registry.yarnpkg.com/tildify/-/tildify-1.2.0.tgz#dcec03f55dca9b7aa3e5b04f21817eb56e63588a\"\n   dependencies:"
    }
  ]
}
