{
  "sha": "30619c244ce30efe83af2788f5023974d140ebd6",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODozMDYxOWMyNDRjZTMwZWZlODNhZjI3ODhmNTAyMzk3NGQxNDBlYmQ2",
  "commit": {
    "author": {
      "name": "Régis Hanol",
      "email": "regis@hanol.fr",
      "date": "2018-09-13T16:53:53Z"
    },
    "committer": {
      "name": "Régis Hanol",
      "email": "regis@hanol.fr",
      "date": "2018-09-13T16:53:53Z"
    },
    "message": "FIX: don't index urls to local files",
    "tree": {
      "sha": "94240ad6cc0de965d47f194adabf0aee48556857",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/94240ad6cc0de965d47f194adabf0aee48556857"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/30619c244ce30efe83af2788f5023974d140ebd6",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/30619c244ce30efe83af2788f5023974d140ebd6",
  "html_url": "https://github.com/discourse/discourse/commit/30619c244ce30efe83af2788f5023974d140ebd6",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/30619c244ce30efe83af2788f5023974d140ebd6/comments",
  "author": {
    "login": "ZogStriP",
    "id": 362783,
    "node_id": "MDQ6VXNlcjM2Mjc4Mw==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/362783?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ZogStriP",
    "html_url": "https://github.com/ZogStriP",
    "followers_url": "https://api.github.com/users/ZogStriP/followers",
    "following_url": "https://api.github.com/users/ZogStriP/following{/other_user}",
    "gists_url": "https://api.github.com/users/ZogStriP/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ZogStriP/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ZogStriP/subscriptions",
    "organizations_url": "https://api.github.com/users/ZogStriP/orgs",
    "repos_url": "https://api.github.com/users/ZogStriP/repos",
    "events_url": "https://api.github.com/users/ZogStriP/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ZogStriP/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "ZogStriP",
    "id": 362783,
    "node_id": "MDQ6VXNlcjM2Mjc4Mw==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/362783?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ZogStriP",
    "html_url": "https://github.com/ZogStriP",
    "followers_url": "https://api.github.com/users/ZogStriP/followers",
    "following_url": "https://api.github.com/users/ZogStriP/following{/other_user}",
    "gists_url": "https://api.github.com/users/ZogStriP/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ZogStriP/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ZogStriP/subscriptions",
    "organizations_url": "https://api.github.com/users/ZogStriP/orgs",
    "repos_url": "https://api.github.com/users/ZogStriP/repos",
    "events_url": "https://api.github.com/users/ZogStriP/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ZogStriP/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "a6502ce8796d09698e99b3ce400aab3113353a45",
      "url": "https://api.github.com/repos/discourse/discourse/commits/a6502ce8796d09698e99b3ce400aab3113353a45",
      "html_url": "https://github.com/discourse/discourse/commit/a6502ce8796d09698e99b3ce400aab3113353a45"
    }
  ],
  "stats": {
    "total": 30,
    "additions": 27,
    "deletions": 3
  },
  "files": [
    {
      "sha": "f76b9037e8d6ce9df42ed5e55929060590dd8328",
      "filename": "app/services/search_indexer.rb",
      "status": "modified",
      "additions": 5,
      "deletions": 3,
      "changes": 8,
      "blob_url": "https://github.com/discourse/discourse/blob/30619c244ce30efe83af2788f5023974d140ebd6/app/services/search_indexer.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/30619c244ce30efe83af2788f5023974d140ebd6/app/services/search_indexer.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/services/search_indexer.rb?ref=30619c244ce30efe83af2788f5023974d140ebd6",
      "patch": "@@ -167,6 +167,8 @@ def self.index(obj, force: false)\n \n   class HtmlScrubber < Nokogiri::XML::SAX::Document\n \n+    DIACRITICS ||= /([\\u0300-\\u036f]|[\\u1AB0-\\u1AFF]|[\\u1DC0-\\u1DFF]|[\\u20D0-\\u20FF])/\n+\n     def self.strip_diacritics(str)\n       s = str.unicode_normalize(:nfkd)\n       s.gsub!(DIACRITICS, \"\")\n@@ -196,12 +198,12 @@ def start_element(_, attributes = [])\n       attributes = Hash[*attributes.flatten]\n \n       ATTRIBUTES.each do |name|\n-        characters(attributes[name]) if attributes[name].present?\n+        if attributes[name].present?\n+          characters(attributes[name]) unless name == \"href\" && UrlHelper.is_local(attributes[name])\n+        end\n       end\n     end\n \n-    DIACRITICS ||= /([\\u0300-\\u036f]|[\\u1AB0-\\u1AFF]|[\\u1DC0-\\u1DFF]|[\\u20D0-\\u20FF])/\n-\n     def characters(str)\n       str = HtmlScrubber.strip_diacritics(str) if @strip_diacritics\n       scrubbed << \" #{str} \""
    },
    {
      "sha": "a9f309a48909ea25e2482bb85c191dd2963f0b05",
      "filename": "spec/services/search_indexer_spec.rb",
      "status": "modified",
      "additions": 22,
      "deletions": 0,
      "changes": 22,
      "blob_url": "https://github.com/discourse/discourse/blob/30619c244ce30efe83af2788f5023974d140ebd6/spec/services/search_indexer_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/30619c244ce30efe83af2788f5023974d140ebd6/spec/services/search_indexer_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/services/search_indexer_spec.rb?ref=30619c244ce30efe83af2788f5023974d140ebd6",
      "patch": "@@ -2,6 +2,7 @@\n \n describe SearchIndexer do\n   let(:post_id) { 99 }\n+\n   it 'correctly indexes chinese' do\n     SiteSetting.default_locale = 'zh_CN'\n     data = \"你好世界\"\n@@ -37,6 +38,27 @@\n     expect(scrubbed).to eq(\" HELLO Heterogeneite Здравствуите هتاف للترحيب 你好 \")\n   end\n \n+  it \"doesn't index local files\" do\n+    html = <<~HTML\n+      <p><img src=\"https://www.discourse.org/logo.png\" alt=\"Discourse\"></p>\n+      <p><img src=\"#{Discourse.base_url_no_prefix}/uploads/episodeinteractive/original/3X/0/f/0f40b818356bdc1d80acfa905034e95cfd112a3a.png\" alt=\"51%20PM\" width=\"289\" height=\"398\"></p>\n+      <div class=\"lightbox-wrapper\">\n+        <a class=\"lightbox\" href=\"#{Discourse.base_url_no_prefix}/uploads/episodeinteractive/original/3X/1/6/16790095df3baf318fb2eb1d7e5d7860dc45d48b.jpg\" data-download-href=\"#{Discourse.base_url_no_prefix}/uploads/episodeinteractive/16790095df3baf318fb2eb1d7e5d7860dc45d48b\" title=\"Untitled design (21).jpg\" rel=\"nofollow noopener\">\n+          <img src=\"#{Discourse.base_url_no_prefix}/uploads/episodeinteractive/optimized/3X/1/6/16790095df3baf318fb2eb1d7e5d7860dc45d48b_1_563x500.jpg\" alt=\"Untitled%20design%20(21)\" width=\"563\" height=\"500\">\n+          <div class=\"meta\">\n+            <span class=\"filename\">Untitled design (21).jpg</span>\n+            <span class=\"informations\">1280x1136 472 KB</span>\n+            <span class=\"expand\"></span>\n+          </div>\n+        </a>\n+      </div>\n+    HTML\n+\n+    scrubbed = SearchIndexer::HtmlScrubber.scrub(html).gsub(/\\s+/, \" \")\n+\n+    expect(scrubbed).to eq(\" Discourse 51%20PM Untitled design (21).jpg Untitled%20design%20(21) Untitled design (21).jpg 1280x1136 472 KB \")\n+  end\n+\n   it 'correctly indexes a post according to version' do\n     # Preparing so that they can be indexed to right version\n     SearchIndexer.update_posts_index(post_id, \"dummy\", \"\", nil, nil)"
    }
  ]
}
