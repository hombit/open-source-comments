{
  "sha": "7b97a8fca24368babac477a47ff4ac547cf14060",
  "node_id": "MDY6Q29tbWl0NzI0NTQyNDI6N2I5N2E4ZmNhMjQzNjhiYWJhYzQ3N2E0N2ZmNGFjNTQ3Y2YxNDA2MA==",
  "commit": {
    "author": {
      "name": "Wyatt Johnson",
      "email": "wyattjoh@gmail.com",
      "date": "2018-10-02T16:21:45Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2018-10-02T16:21:45Z"
    },
    "message": "Passport Fix (#1955)\n\n* fix: Fixed bug in passport access\r\n\r\n* fix: resolved issues with postMessage and static urls",
    "tree": {
      "sha": "ac87199c4ed7471f2066a0794b655a7919f9a56b",
      "url": "https://api.github.com/repos/coralproject/talk/git/trees/ac87199c4ed7471f2066a0794b655a7919f9a56b"
    },
    "url": "https://api.github.com/repos/coralproject/talk/git/commits/7b97a8fca24368babac477a47ff4ac547cf14060",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJbs5sZCRBK7hj4Ov3rIwAAdHIIABU7aH2wDC/mwFwqUj7c4E6F\nvd+7v7Qkz6GeIZmSDaJ5UTYOpc5B9DkTFnAvFq/1bV6RJuSCiV657ZgdrT/uwk8K\nvYS9jrHBpSMIXFSIeribgXh3OsoQtFb8bYz9DSxQhrPwgPoaofntTL+bNZqqFty4\n/9/6ggPCnpdrmyP0KP2roh1qtwkkEj/9CPXB4kR1IesL/Ifts+1SrhMWqMrb/LhB\njGLgQK68hSdiuXtTH81ADzJ6z5O4i8MltJ6uuDHDjEQFepYURSQ4lMFtbe0cX3pw\ngDSgrKKvsuJR2gmT3QZgGG9xiNdDCAAdPq+/qTFLn1cEEE8+x8eZak0pRA1uf8A=\n=w9Lu\n-----END PGP SIGNATURE-----\n",
      "payload": "tree ac87199c4ed7471f2066a0794b655a7919f9a56b\nparent 6bff2de3718f0517e29ba432d9dc2eb3598e77e8\nauthor Wyatt Johnson <wyattjoh@gmail.com> 1538497305 +0000\ncommitter GitHub <noreply@github.com> 1538497305 +0000\n\nPassport Fix (#1955)\n\n* fix: Fixed bug in passport access\r\n\r\n* fix: resolved issues with postMessage and static urls\r\n"
    }
  },
  "url": "https://api.github.com/repos/coralproject/talk/commits/7b97a8fca24368babac477a47ff4ac547cf14060",
  "html_url": "https://github.com/coralproject/talk/commit/7b97a8fca24368babac477a47ff4ac547cf14060",
  "comments_url": "https://api.github.com/repos/coralproject/talk/commits/7b97a8fca24368babac477a47ff4ac547cf14060/comments",
  "author": {
    "login": "wyattjoh",
    "id": 633002,
    "node_id": "MDQ6VXNlcjYzMzAwMg==",
    "avatar_url": "https://avatars2.githubusercontent.com/u/633002?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wyattjoh",
    "html_url": "https://github.com/wyattjoh",
    "followers_url": "https://api.github.com/users/wyattjoh/followers",
    "following_url": "https://api.github.com/users/wyattjoh/following{/other_user}",
    "gists_url": "https://api.github.com/users/wyattjoh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wyattjoh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wyattjoh/subscriptions",
    "organizations_url": "https://api.github.com/users/wyattjoh/orgs",
    "repos_url": "https://api.github.com/users/wyattjoh/repos",
    "events_url": "https://api.github.com/users/wyattjoh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wyattjoh/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "6bff2de3718f0517e29ba432d9dc2eb3598e77e8",
      "url": "https://api.github.com/repos/coralproject/talk/commits/6bff2de3718f0517e29ba432d9dc2eb3598e77e8",
      "html_url": "https://github.com/coralproject/talk/commit/6bff2de3718f0517e29ba432d9dc2eb3598e77e8"
    }
  ],
  "stats": {
    "total": 24,
    "additions": 17,
    "deletions": 7
  },
  "files": [
    {
      "sha": "b396572ecd3262ca195b15329da63546853748e4",
      "filename": "client/coral-auth-callback/src/index.js",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/7b97a8fca24368babac477a47ff4ac547cf14060/client/coral-auth-callback/src/index.js",
      "raw_url": "https://github.com/coralproject/talk/raw/7b97a8fca24368babac477a47ff4ac547cf14060/client/coral-auth-callback/src/index.js",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/client/coral-auth-callback/src/index.js?ref=7b97a8fca24368babac477a47ff4ac547cf14060",
      "patch": "@@ -4,7 +4,7 @@ import { createPostMessage } from 'coral-framework/services/postMessage';\n \n document.addEventListener('DOMContentLoaded', () => {\n   const staticConfig = getStaticConfiguration();\n-  const { STATIC_ORIGIN: origin } = staticConfig;\n+  const { BASE_ORIGIN: origin } = staticConfig;\n   const postMessage = createPostMessage(origin);\n \n   // Get the auth element and parse it as JSON by decoding it."
    },
    {
      "sha": "c96893d4e82f6948e01540b160e6a2cb0e85ca4b",
      "filename": "client/coral-framework/services/bootstrap.js",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/7b97a8fca24368babac477a47ff4ac547cf14060/client/coral-framework/services/bootstrap.js",
      "raw_url": "https://github.com/coralproject/talk/raw/7b97a8fca24368babac477a47ff4ac547cf14060/client/coral-framework/services/bootstrap.js",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/client/coral-framework/services/bootstrap.js?ref=7b97a8fca24368babac477a47ff4ac547cf14060",
      "patch": "@@ -136,7 +136,7 @@ export async function createContext({\n   });\n \n   const staticConfig = getStaticConfiguration();\n-  let { LIVE_URI: liveUri, STATIC_ORIGIN: origin } = staticConfig;\n+  let { LIVE_URI: liveUri, BASE_ORIGIN: origin } = staticConfig;\n   if (liveUri == null) {\n     // The protocol must match the origin protocol, secure/insecure.\n     const protocol = location.protocol === 'https:' ? 'wss' : 'ws';"
    },
    {
      "sha": "c497428132e51274af9b88e02eaf9990dfbbc7b1",
      "filename": "middleware/staticTemplate.js",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/7b97a8fca24368babac477a47ff4ac547cf14060/middleware/staticTemplate.js",
      "raw_url": "https://github.com/coralproject/talk/raw/7b97a8fca24368babac477a47ff4ac547cf14060/middleware/staticTemplate.js",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/middleware/staticTemplate.js?ref=7b97a8fca24368babac477a47ff4ac547cf14060",
      "patch": "@@ -5,6 +5,7 @@ const { merge } = require('lodash');\n \n const {\n   BASE_URL,\n+  BASE_ORIGIN,\n   BASE_PATH,\n   MOUNT_PATH,\n   STATIC_URL,\n@@ -29,6 +30,7 @@ const TALK_CLIENT_ENV = Object.keys(process.env)\n       LIVE_URI: WEBSOCKET_LIVE_URI,\n       STATIC_URL,\n       STATIC_ORIGIN,\n+      BASE_ORIGIN,\n     }\n   );\n "
    },
    {
      "sha": "8ae9108c48e2aa6d04ae157c10528723210c53ec",
      "filename": "services/passport.js",
      "status": "modified",
      "additions": 10,
      "deletions": 5,
      "changes": 15,
      "blob_url": "https://github.com/coralproject/talk/blob/7b97a8fca24368babac477a47ff4ac547cf14060/services/passport.js",
      "raw_url": "https://github.com/coralproject/talk/raw/7b97a8fca24368babac477a47ff4ac547cf14060/services/passport.js",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/services/passport.js?ref=7b97a8fca24368babac477a47ff4ac547cf14060",
      "patch": "@@ -19,6 +19,7 @@ const ms = require('ms');\n const _ = require('lodash');\n const { attachStaticLocals } = require('../middleware/staticTemplate');\n const { encodeJSONForHTML } = require('./response');\n+const { STATIC_URL, BASE_URL } = require('../url');\n \n // Create a redis client to use for authentication.\n const { createClientFactory } = require('./redis');\n@@ -97,10 +98,14 @@ const HandleGenerateCredentials = (req, res, next) => (err, user) => {\n   res.json({ user, token });\n };\n \n-const generateAuthPopupCallbackCSP = req =>\n-  req.locals.STATIC_URL && req.locals.BASE_URL !== req.locals.STATIC_URL\n-    ? `default-src 'self' ${req.locals.STATIC_URL};`\n-    : \"default-src 'self';\";\n+/**\n+ * authPopupCallbackCSP is the header sent via Content-Security-Policy when\n+ * a social callback request is being made.\n+ */\n+const authPopupCallbackCSP = (() =>\n+  STATIC_URL && BASE_URL !== STATIC_URL\n+    ? `default-src 'self' ${STATIC_URL.replace(/\\/$/, '')};`\n+    : \"default-src 'self';\")();\n \n /**\n  * Returns the response to the login attempt via a popup callback with some JS.\n@@ -111,7 +116,7 @@ const HandleAuthPopupCallback = (req, res, next) => (err, user) => {\n   res.header('Pragma', 'no-cache');\n \n   // Ensure the only scripts that can run here are those on the Talk domain.\n-  res.header('Content-Security-Policy', generateAuthPopupCallbackCSP(req));\n+  res.header('Content-Security-Policy', authPopupCallbackCSP);\n \n   // Attach static locals to the response locals object.\n   attachStaticLocals(res.locals);"
    },
    {
      "sha": "f38f17e4f5f8173eb4ecdab34a81a6401b0e4d5a",
      "filename": "url.js",
      "status": "modified",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "blob_url": "https://github.com/coralproject/talk/blob/7b97a8fca24368babac477a47ff4ac547cf14060/url.js",
      "raw_url": "https://github.com/coralproject/talk/raw/7b97a8fca24368babac477a47ff4ac547cf14060/url.js",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/url.js?ref=7b97a8fca24368babac477a47ff4ac547cf14060",
      "patch": "@@ -11,6 +11,8 @@ const BASE_URL = trailingSlash(ROOT_URL);\n // The BASE_PATH is simply the path component of the BASE_URL.\n const BASE_PATH = new URL(BASE_URL).pathname;\n \n+const BASE_ORIGIN = new URL(BASE_URL).origin;\n+\n // The MOUNT_PATH is derived from the BASE_PATH, if it is provided and enabled.\n // This will mount all the application routes onto it.\n const MOUNT_PATH = ROOT_URL_MOUNT_PATH ? BASE_PATH : '/';\n@@ -22,6 +24,7 @@ const STATIC_ORIGIN = new URL(STATIC_URI).origin;\n \n module.exports = {\n   BASE_URL,\n+  BASE_ORIGIN,\n   BASE_PATH,\n   MOUNT_PATH,\n   STATIC_URL,"
    }
  ]
}
