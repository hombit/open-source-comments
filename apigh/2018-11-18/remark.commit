{
  "sha": "3e657709eb94752ae64abc5272301c3f756a2274",
  "node_id": "MDY6Q29tbWl0MTE0ODI5NTAzOjNlNjU3NzA5ZWI5NDc1MmFlNjRhYmM1MjcyMzAxYzNmNzU2YTIyNzQ=",
  "commit": {
    "author": {
      "name": "Igor Adamenko",
      "email": "igoradamenko@users.noreply.github.com",
      "date": "2018-11-15T23:54:20Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2018-11-15T23:54:20Z"
    },
    "message": "Merge pull request #219 from Reeywhaar/third-party-cookie-crash\n\nthird party cookies blocked fallback",
    "tree": {
      "sha": "baf1a11bc777f0521cb221590d5b6141b5fc72a1",
      "url": "https://api.github.com/repos/umputun/remark/git/trees/baf1a11bc777f0521cb221590d5b6141b5fc72a1"
    },
    "url": "https://api.github.com/repos/umputun/remark/git/commits/3e657709eb94752ae64abc5272301c3f756a2274",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJb7gcsCRBK7hj4Ov3rIwAAdHIIAD8iODUyVpNyP0P5T+H7AyHG\nSvbdk0sFsfVaBbF+Ms+7pVpp03OVfHK6EL/2PpVjmVTXAmRw5C5NIFWR0B1vvtDC\nYYGraLUsw5plWZ7VdxSilhSHaCH/k8S3ybP6R8LajjQ+9am352FyiPehuS94X3t7\nEo9m/AGM6HdHj8m9qbOIUBvDKdSJiiKYBHPFfNf2SlH+jM0fZMiZV9oHk1wOb1lz\nGOswLsutbsAGAGvKqnbJF7nRurOSZp1HkvPX5T8edOCdv70Xy4XyKYGZjl66jbIi\nd/dPt04bxf80BzmFJjhviinIgdDwMoF8/1NEUR6sBZO/zzlCwPvkVRp//zgQbtE=\n=Jt2y\n-----END PGP SIGNATURE-----\n",
      "payload": "tree baf1a11bc777f0521cb221590d5b6141b5fc72a1\nparent 7233e957747184c3885325c521a4d46f558c962e\nparent 8e48605b75d0205dabf13bc4c631e610fd3e7d72\nauthor Igor Adamenko <igoradamenko@users.noreply.github.com> 1542326060 +0200\ncommitter GitHub <noreply@github.com> 1542326060 +0200\n\nMerge pull request #219 from Reeywhaar/third-party-cookie-crash\n\nthird party cookies blocked fallback"
    }
  },
  "url": "https://api.github.com/repos/umputun/remark/commits/3e657709eb94752ae64abc5272301c3f756a2274",
  "html_url": "https://github.com/umputun/remark/commit/3e657709eb94752ae64abc5272301c3f756a2274",
  "comments_url": "https://api.github.com/repos/umputun/remark/commits/3e657709eb94752ae64abc5272301c3f756a2274/comments",
  "author": {
    "login": "igoradamenko",
    "id": 6537798,
    "node_id": "MDQ6VXNlcjY1Mzc3OTg=",
    "avatar_url": "https://avatars3.githubusercontent.com/u/6537798?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/igoradamenko",
    "html_url": "https://github.com/igoradamenko",
    "followers_url": "https://api.github.com/users/igoradamenko/followers",
    "following_url": "https://api.github.com/users/igoradamenko/following{/other_user}",
    "gists_url": "https://api.github.com/users/igoradamenko/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/igoradamenko/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/igoradamenko/subscriptions",
    "organizations_url": "https://api.github.com/users/igoradamenko/orgs",
    "repos_url": "https://api.github.com/users/igoradamenko/repos",
    "events_url": "https://api.github.com/users/igoradamenko/events{/privacy}",
    "received_events_url": "https://api.github.com/users/igoradamenko/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "7233e957747184c3885325c521a4d46f558c962e",
      "url": "https://api.github.com/repos/umputun/remark/commits/7233e957747184c3885325c521a4d46f558c962e",
      "html_url": "https://github.com/umputun/remark/commit/7233e957747184c3885325c521a4d46f558c962e"
    },
    {
      "sha": "8e48605b75d0205dabf13bc4c631e610fd3e7d72",
      "url": "https://api.github.com/repos/umputun/remark/commits/8e48605b75d0205dabf13bc4c631e610fd3e7d72",
      "html_url": "https://github.com/umputun/remark/commit/8e48605b75d0205dabf13bc4c631e610fd3e7d72"
    }
  ],
  "stats": {
    "total": 206,
    "additions": 182,
    "deletions": 24
  },
  "files": [
    {
      "sha": "5301d7ae10bb233036d3113c50d6a2fd6b50b2fd",
      "filename": "web/app/common/constants.js",
      "status": "modified",
      "additions": 26,
      "deletions": 0,
      "changes": 26,
      "blob_url": "https://github.com/umputun/remark/blob/3e657709eb94752ae64abc5272301c3f756a2274/web/app/common/constants.js",
      "raw_url": "https://github.com/umputun/remark/raw/3e657709eb94752ae64abc5272301c3f756a2274/web/app/common/constants.js",
      "contents_url": "https://api.github.com/repos/umputun/remark/contents/web/app/common/constants.js?ref=3e657709eb94752ae64abc5272301c3f756a2274",
      "patch": "@@ -38,3 +38,29 @@ export const BLOCKING_DURATIONS = [\n     value: `${60 * 24}m`,\n   },\n ];\n+\n+/**\n+ * Defines if browser storage features (cookies, localsrotage)\n+ * are available or blocked via browser preferences\n+ */\n+export const IS_STORAGE_AVAILABLE = (() => {\n+  try {\n+    localStorage.setItem('localstorage_availability_test', null);\n+    localStorage.removeItem('localstorage_availability_test');\n+  } catch (e) {\n+    return false;\n+  }\n+  return true;\n+})();\n+\n+/**\n+ * Defines whether iframe loaded in cross origin environment\n+ * Usefull for checking if some privacy restriction may be applied\n+ */\n+export const IS_THIRD_PARTY = (() => {\n+  try {\n+    return window.parent.location.host !== window.location.host;\n+  } catch (e) {\n+    return true;\n+  }\n+})();"
    },
    {
      "sha": "00187297119f8500698a23f0b1b9e868e8a86d82",
      "filename": "web/app/common/localStorage.js",
      "status": "added",
      "additions": 22,
      "deletions": 0,
      "changes": 22,
      "blob_url": "https://github.com/umputun/remark/blob/3e657709eb94752ae64abc5272301c3f756a2274/web/app/common/localStorage.js",
      "raw_url": "https://github.com/umputun/remark/raw/3e657709eb94752ae64abc5272301c3f756a2274/web/app/common/localStorage.js",
      "contents_url": "https://api.github.com/repos/umputun/remark/contents/web/app/common/localStorage.js?ref=3e657709eb94752ae64abc5272301c3f756a2274",
      "patch": "@@ -0,0 +1,22 @@\n+import { IS_STORAGE_AVAILABLE } from 'common/constants';\n+\n+const failMessage = 'remark42: localStorage access denied, check browser preferences';\n+\n+export const setItem = IS_STORAGE_AVAILABLE\n+  ? localStorage.setItem.bind(localStorage)\n+  : () => {\n+      console.error(failMessage); // eslint-disable-line no-console\n+    };\n+\n+export const getItem = IS_STORAGE_AVAILABLE\n+  ? localStorage.getItem.bind(localStorage)\n+  : () => {\n+      console.error(failMessage); // eslint-disable-line no-console\n+      return null;\n+    };\n+\n+export const removeItem = IS_STORAGE_AVAILABLE\n+  ? localStorage.removeItem.bind(localStorage)\n+  : () => {\n+      console.error(failMessage); // eslint-disable-line no-console\n+    };"
    },
    {
      "sha": "0926ddefb5634fb9e32da7b14dbaaca50492aab2",
      "filename": "web/app/components/auth-panel/auth-panel.jsx",
      "status": "modified",
      "additions": 40,
      "deletions": 22,
      "changes": 62,
      "blob_url": "https://github.com/umputun/remark/blob/3e657709eb94752ae64abc5272301c3f756a2274/web/app/components/auth-panel/auth-panel.jsx",
      "raw_url": "https://github.com/umputun/remark/raw/3e657709eb94752ae64abc5272301c3f756a2274/web/app/components/auth-panel/auth-panel.jsx",
      "contents_url": "https://api.github.com/repos/umputun/remark/contents/web/app/components/auth-panel/auth-panel.jsx?ref=3e657709eb94752ae64abc5272301c3f756a2274",
      "patch": "@@ -4,7 +4,7 @@ import { h, Component } from 'preact';\n import UserId from './__user-id/auth-panel__user-id';\n import Dropdown, { DropdownItem } from 'components/dropdown';\n import Button from 'components/button';\n-import { PROVIDER_NAMES } from 'common/constants';\n+import { PROVIDER_NAMES, IS_STORAGE_AVAILABLE, IS_THIRD_PARTY } from 'common/constants';\n import { requestDeletion } from 'utils/email';\n import { getHandleClickProps } from 'common/accessibility';\n \n@@ -76,28 +76,46 @@ export default class AuthPanel extends Component {\n           </div>\n         )}\n \n-        {!loggedIn && (\n-          <div className=\"auth-panel__column\">\n-            Sign in to comment using{' '}\n-            {providers.map((provider, i) => {\n-              const comma = i === 0 ? '' : i === providers.length - 1 ? ' or ' : ', ';\n-\n-              return (\n-                <span>\n-                  {comma}\n-                  <span\n-                    className=\"auth-panel__pseudo-link\"\n-                    {...getHandleClickProps(() => props.onSignIn(provider))}\n-                    role=\"link\"\n-                  >\n-                    {PROVIDER_NAMES[provider]}\n+        {IS_STORAGE_AVAILABLE &&\n+          !loggedIn && (\n+            <div className=\"auth-panel__column\">\n+              Sign in to comment using{' '}\n+              {providers.map((provider, i) => {\n+                const comma = i === 0 ? '' : i === providers.length - 1 ? ' or ' : ', ';\n+\n+                return (\n+                  <span>\n+                    {comma}\n+                    <span\n+                      className=\"auth-panel__pseudo-link\"\n+                      {...getHandleClickProps(() => props.onSignIn(provider))}\n+                      role=\"link\"\n+                    >\n+                      {PROVIDER_NAMES[provider]}\n+                    </span>\n                   </span>\n-                </span>\n-              );\n-            })}\n-            {'.'}\n-          </div>\n-        )}\n+                );\n+              })}\n+              {'.'}\n+            </div>\n+          )}\n+\n+        {!IS_STORAGE_AVAILABLE &&\n+          IS_THIRD_PARTY && (\n+            <div className=\"auth-panel__column\">\n+              Disable third-party cookies blocking to sign in or open comments in{' '}\n+              <a\n+                class=\"auth-panel__pseudo-link\"\n+                href={`${window.location.origin}/web/comments.html${window.location.search}`}\n+                target=\"_blank\"\n+              >\n+                new page\n+              </a>\n+            </div>\n+          )}\n+\n+        {!IS_STORAGE_AVAILABLE &&\n+          !IS_THIRD_PARTY && <div className=\"auth-panel__column\">Allow cookies to sign in and comment</div>}\n \n         <div className=\"auth-panel__column\">\n           {user.admin && ("
    },
    {
      "sha": "a239b0fa261858fecd1ceceed84c0849baa167a7",
      "filename": "web/app/components/thread/getCollapsedComments.js",
      "status": "modified",
      "additions": 2,
      "deletions": 1,
      "changes": 3,
      "blob_url": "https://github.com/umputun/remark/blob/3e657709eb94752ae64abc5272301c3f756a2274/web/app/components/thread/getCollapsedComments.js",
      "raw_url": "https://github.com/umputun/remark/raw/3e657709eb94752ae64abc5272301c3f756a2274/web/app/components/thread/getCollapsedComments.js",
      "contents_url": "https://api.github.com/repos/umputun/remark/contents/web/app/components/thread/getCollapsedComments.js?ref=3e657709eb94752ae64abc5272301c3f756a2274",
      "patch": "@@ -1,5 +1,6 @@\n import { LS_COLLAPSE_KEY } from 'common/constants';\n+import { getItem as localStorageGetItem } from 'common/localStorage';\n \n-const getCollapsedComments = () => JSON.parse(localStorage.getItem(LS_COLLAPSE_KEY) || '[]');\n+const getCollapsedComments = () => JSON.parse(localStorageGetItem(LS_COLLAPSE_KEY) || '[]');\n \n export default getCollapsedComments;"
    },
    {
      "sha": "53b29b629db2a66886d611d81a9b56a71aac9bcf",
      "filename": "web/app/components/thread/saveCollapsedComments.js",
      "status": "modified",
      "additions": 2,
      "deletions": 1,
      "changes": 3,
      "blob_url": "https://github.com/umputun/remark/blob/3e657709eb94752ae64abc5272301c3f756a2274/web/app/components/thread/saveCollapsedComments.js",
      "raw_url": "https://github.com/umputun/remark/raw/3e657709eb94752ae64abc5272301c3f756a2274/web/app/components/thread/saveCollapsedComments.js",
      "contents_url": "https://api.github.com/repos/umputun/remark/contents/web/app/components/thread/saveCollapsedComments.js?ref=3e657709eb94752ae64abc5272301c3f756a2274",
      "patch": "@@ -1,5 +1,6 @@\n import { LS_COLLAPSE_KEY } from 'common/constants';\n+import { setItem as localStorageSetItem } from 'common/localStorage';\n \n-const saveCollapsedComments = comments => localStorage.setItem(LS_COLLAPSE_KEY, JSON.stringify(comments));\n+const saveCollapsedComments = comments => localStorageSetItem(LS_COLLAPSE_KEY, JSON.stringify(comments));\n \n export default saveCollapsedComments;"
    },
    {
      "sha": "40a8653cda98828c53064473c3d4ce9f8621abd6",
      "filename": "web/comments.ejs",
      "status": "added",
      "additions": 85,
      "deletions": 0,
      "changes": 85,
      "blob_url": "https://github.com/umputun/remark/blob/3e657709eb94752ae64abc5272301c3f756a2274/web/comments.ejs",
      "raw_url": "https://github.com/umputun/remark/raw/3e657709eb94752ae64abc5272301c3f756a2274/web/comments.ejs",
      "contents_url": "https://api.github.com/repos/umputun/remark/contents/web/comments.ejs?ref=3e657709eb94752ae64abc5272301c3f756a2274",
      "patch": "@@ -0,0 +1,85 @@\n+<!DOCTYPE html>\n+<html lang=\"en\">\n+  <head>\n+    <meta charset=\"utf-8\" />\n+    <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />\n+    <title>Remark42 demo</title>\n+    <style>\n+      body {\n+        margin: 0;\n+        padding: 20px;\n+        text-align: center;\n+        font: 18px/24px Helvetica, Arial, sans-serif;\n+        color: #333;\n+      }\n+\n+      article {\n+        display: block;\n+        text-align: left;\n+        max-width: 640px;\n+        margin: 0 auto;\n+      }\n+\n+      h1 {\n+        font-size: 50px;\n+        margin-left: -0.05em;\n+      }\n+\n+      ul {\n+        color: rgb(23, 67, 78);\n+      }\n+\n+      a {\n+        color: rgb(79, 187, 214);\n+        text-decoration: none;\n+      }\n+\n+      a:hover {\n+        color: rgb(94, 167, 177);\n+        text-decoration: underline;\n+      }\n+    </style>\n+  </head>\n+  <body>\n+    <article>\n+      <h1><a href=\"https://remark42.com/\">Remark42</a></h1>\n+      <p id=\"title\"></p>\n+      <div id=\"remark42\"></div>\n+    </article>\n+\n+    <script>\n+      var query = (function() {\n+        if (window.location.search.length === 0) return {};\n+        return window.location.search\n+          .substr(1)\n+          .split('&')\n+          .map(function(item) {\n+            return item.split('=');\n+          })\n+          .reduce(function(carry, item) {\n+            carry[item[0]] = decodeURIComponent(item[1]);\n+            return carry;\n+          }, {});\n+      })();\n+\n+      if (query.site_id && query.url) {\n+        var titleElement = document.getElementById('title');\n+        titleElement.innerHTML = 'Comments for <a href=\"' + query.url + '\">' + query.url + '</a>';\n+\n+        var remark_config = {\n+          site_id: query.site_id,\n+          url: query.url,\n+        };\n+\n+        (function() {\n+          var d = document,\n+            s = d.createElement('script');\n+          s.src = '/web/embed.js';\n+          s.type = 'text/javascript';\n+          (d.head || d.body).appendChild(s);\n+        })();\n+      }\n+    </script>\n+    <noscript> Please enable JavaScript to view the comments powered by Remark. </noscript>\n+  </body>\n+</html>"
    },
    {
      "sha": "869af3a11c77be0b4ebb414e8b4381061b228fed",
      "filename": "web/webpack.config.js",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/umputun/remark/blob/3e657709eb94752ae64abc5272301c3f756a2274/web/webpack.config.js",
      "raw_url": "https://github.com/umputun/remark/raw/3e657709eb94752ae64abc5272301c3f756a2274/web/webpack.config.js",
      "contents_url": "https://api.github.com/repos/umputun/remark/contents/web/webpack.config.js?ref=3e657709eb94752ae64abc5272301c3f756a2274",
      "patch": "@@ -114,6 +114,11 @@ module.exports = {\n       filename: 'last-comments.html',\n       inject: false,\n     }),\n+    new Html({\n+      template: path.resolve(__dirname, 'comments.ejs'),\n+      filename: 'comments.html',\n+      inject: false,\n+    }),\n     new ExtractText({\n       filename: `remark.css`,\n       allChunks: true,"
    }
  ]
}
