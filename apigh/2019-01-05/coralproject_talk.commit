{
  "sha": "dd0601a80132d2849c53ef7eaf12ff382f3920b9",
  "node_id": "MDY6Q29tbWl0NzI0NTQyNDI6ZGQwNjAxYTgwMTMyZDI4NDljNTNlZjdlYWYxMmZmMzgyZjM5MjBiOQ==",
  "commit": {
    "author": {
      "name": "Kim Gardner",
      "email": "kgardnr@gmail.com",
      "date": "2018-12-19T20:53:30Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2018-12-19T20:53:30Z"
    },
    "message": "Merge pull request #2135 from coralproject/concurrency\n\nConcurrency",
    "tree": {
      "sha": "1af22b5b895d30cdf27dacba0b99d9daea393f4d",
      "url": "https://api.github.com/repos/coralproject/talk/git/trees/1af22b5b895d30cdf27dacba0b99d9daea393f4d"
    },
    "url": "https://api.github.com/repos/coralproject/talk/git/commits/dd0601a80132d2849c53ef7eaf12ff382f3920b9",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJcGq/KCRBK7hj4Ov3rIwAAdHIIAEjyL39bqzGJeSxGibHQ6mnG\n6e/TXvKrL1ihfnwGrcJB5jlhwNI+28bW2fQG8kj9hGcK4jHP7nx/CDnrfyk+0rEm\nQ4+Al8t4bI5tMI5w01E1szWDIIuAxVrLf98RRD5T42DClvjR4G8XY5zIXIVuJfnY\n3X7kvdh4G7xwTOxkGI3LvMOJ/DH+pQRAiEzS09tOdK5FKj9u37nrqFFU7/xKiSZl\ng8ISy+fCUXv4neSaDGpl8FUM3uCJt5yrOs2JBU15l3u688GPyo6mBOXwkB/8O59+\n+Ee5hfcbapkE5eDDaBG5cAWuMkrOCD/h3wd3x9fOCc9JdgC9hjmBPKiM1idckzw=\n=Pm0C\n-----END PGP SIGNATURE-----\n",
      "payload": "tree 1af22b5b895d30cdf27dacba0b99d9daea393f4d\nparent 08f579225b13e4d0c41367ca262ff097d416a76a\nparent 9f7d4858710c5f7b1c8ab131ebf97e9c6014052c\nauthor Kim Gardner <kgardnr@gmail.com> 1545252810 +0000\ncommitter GitHub <noreply@github.com> 1545252810 +0000\n\nMerge pull request #2135 from coralproject/concurrency\n\nConcurrency"
    }
  },
  "url": "https://api.github.com/repos/coralproject/talk/commits/dd0601a80132d2849c53ef7eaf12ff382f3920b9",
  "html_url": "https://github.com/coralproject/talk/commit/dd0601a80132d2849c53ef7eaf12ff382f3920b9",
  "comments_url": "https://api.github.com/repos/coralproject/talk/commits/dd0601a80132d2849c53ef7eaf12ff382f3920b9/comments",
  "author": {
    "login": "kgardnr",
    "id": 1077300,
    "node_id": "MDQ6VXNlcjEwNzczMDA=",
    "avatar_url": "https://avatars2.githubusercontent.com/u/1077300?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/kgardnr",
    "html_url": "https://github.com/kgardnr",
    "followers_url": "https://api.github.com/users/kgardnr/followers",
    "following_url": "https://api.github.com/users/kgardnr/following{/other_user}",
    "gists_url": "https://api.github.com/users/kgardnr/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/kgardnr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kgardnr/subscriptions",
    "organizations_url": "https://api.github.com/users/kgardnr/orgs",
    "repos_url": "https://api.github.com/users/kgardnr/repos",
    "events_url": "https://api.github.com/users/kgardnr/events{/privacy}",
    "received_events_url": "https://api.github.com/users/kgardnr/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "08f579225b13e4d0c41367ca262ff097d416a76a",
      "url": "https://api.github.com/repos/coralproject/talk/commits/08f579225b13e4d0c41367ca262ff097d416a76a",
      "html_url": "https://github.com/coralproject/talk/commit/08f579225b13e4d0c41367ca262ff097d416a76a"
    },
    {
      "sha": "9f7d4858710c5f7b1c8ab131ebf97e9c6014052c",
      "url": "https://api.github.com/repos/coralproject/talk/commits/9f7d4858710c5f7b1c8ab131ebf97e9c6014052c",
      "html_url": "https://github.com/coralproject/talk/commit/9f7d4858710c5f7b1c8ab131ebf97e9c6014052c"
    }
  ],
  "stats": {
    "total": 39,
    "additions": 31,
    "deletions": 8
  },
  "files": [
    {
      "sha": "0a63aa6cf8c0b9fe164b1d927f377a0fa4571587",
      "filename": "bin/cli-serve",
      "status": "modified",
      "additions": 17,
      "deletions": 5,
      "changes": 22,
      "blob_url": "https://github.com/coralproject/talk/blob/dd0601a80132d2849c53ef7eaf12ff382f3920b9/bin/cli-serve",
      "raw_url": "https://github.com/coralproject/talk/raw/dd0601a80132d2849c53ef7eaf12ff382f3920b9/bin/cli-serve",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/bin/cli-serve?ref=dd0601a80132d2849c53ef7eaf12ff382f3920b9",
      "patch": "@@ -1,8 +1,10 @@\n #!/usr/bin/env node\n \n+const throng = require('throng');\n+const { CONCURRENCY } = require('../config');\n+const { logger } = require('../services/logging');\n const util = require('./util');\n const program = require('commander');\n-const serve = require('../serve');\n \n //==============================================================================\n // Setting up the program command line arguments.\n@@ -22,8 +24,18 @@ program\n   )\n   .parse(process.argv);\n \n-// Start serving.\n-serve(program).catch(err => {\n-  console.error(err);\n-  util.shutdown(1);\n+throng({\n+  workers: CONCURRENCY,\n+  start: i => {\n+    logger.info({ workerID: i }, 'started worker');\n+\n+    // Load in the serve.\n+    const serve = require('../serve');\n+\n+    // Start serving.\n+    serve(program).catch(err => {\n+      console.error(err);\n+      util.shutdown(1);\n+    });\n+  },\n });"
    },
    {
      "sha": "d01ad88170a0ce9fa77349b8b91c27991c20b4ff",
      "filename": "config.js",
      "status": "modified",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "blob_url": "https://github.com/coralproject/talk/blob/dd0601a80132d2849c53ef7eaf12ff382f3920b9/config.js",
      "raw_url": "https://github.com/coralproject/talk/raw/dd0601a80132d2849c53ef7eaf12ff382f3920b9/config.js",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/config.js?ref=dd0601a80132d2849c53ef7eaf12ff382f3920b9",
      "patch": "@@ -217,6 +217,9 @@ const CONFIG = {\n   // messages through the websocket to keep the socket alive.\n   KEEP_ALIVE: process.env.TALK_KEEP_ALIVE || '30s',\n \n+  // CONCURRENCY is the number of workers that will serve traffic.\n+  CONCURRENCY: parseInt(process.env.TALK_CONCURRENCY || '1'),\n+\n   //------------------------------------------------------------------------------\n   // Cache configuration\n   //------------------------------------------------------------------------------"
    },
    {
      "sha": "fce56b05743c1609d650c625918eac526723672c",
      "filename": "package.json",
      "status": "modified",
      "additions": 2,
      "deletions": 1,
      "changes": 3,
      "blob_url": "https://github.com/coralproject/talk/blob/dd0601a80132d2849c53ef7eaf12ff382f3920b9/package.json",
      "raw_url": "https://github.com/coralproject/talk/raw/dd0601a80132d2849c53ef7eaf12ff382f3920b9/package.json",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/package.json?ref=dd0601a80132d2849c53ef7eaf12ff382f3920b9",
      "patch": "@@ -1,6 +1,6 @@\n {\n   \"name\": \"talk\",\n-  \"version\": \"4.6.11\",\n+  \"version\": \"4.7.0\",\n   \"description\": \"A better commenting experience from Mozilla, The New York Times, and the Washington Post. https://coralproject.net\",\n   \"main\": \"app.js\",\n   \"private\": true,\n@@ -205,6 +205,7 @@\n     \"style-loader\": \"^0.16.0\",\n     \"subscriptions-transport-ws\": \"^0.7.2\",\n     \"supports-color\": \"^4\",\n+    \"throng\": \"^4.0.0\",\n     \"timeago.js\": \"^2.0.3\",\n     \"timekeeper\": \"^1.0.0\",\n     \"tlds\": \"^1.196.0\","
    },
    {
      "sha": "9db766d0e51d42076887b9909b18dcd2a11c170e",
      "filename": "services/kue.js",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/coralproject/talk/blob/dd0601a80132d2849c53ef7eaf12ff382f3920b9/services/kue.js",
      "raw_url": "https://github.com/coralproject/talk/raw/dd0601a80132d2849c53ef7eaf12ff382f3920b9/services/kue.js",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/services/kue.js?ref=dd0601a80132d2849c53ef7eaf12ff382f3920b9",
      "patch": "@@ -91,12 +91,12 @@ class Task {\n   static shutdown() {\n     debug('Shutting down the Queue');\n \n-    return new Promise((resolve, reject) => {\n+    return new Promise(resolve => {\n       // Shutdown and give the queue 5 seconds to shutdown before we start\n       // killing jobs.\n       getQueue().shutdown(5000, err => {\n         if (err) {\n-          return reject(err);\n+          return resolve();\n         }\n \n         debug('Queue shut down.');"
    },
    {
      "sha": "e5f1afb142a8125d2924d20ada40c311b436605f",
      "filename": "yarn.lock",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/dd0601a80132d2849c53ef7eaf12ff382f3920b9/yarn.lock",
      "raw_url": "https://github.com/coralproject/talk/raw/dd0601a80132d2849c53ef7eaf12ff382f3920b9/yarn.lock",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/yarn.lock?ref=dd0601a80132d2849c53ef7eaf12ff382f3920b9",
      "patch": "@@ -12823,6 +12823,13 @@ throat@^4.0.0:\n   resolved \"https://registry.yarnpkg.com/throat/-/throat-4.1.0.tgz#89037cbc92c56ab18926e6ba4cbb200e15672a6a\"\n   integrity sha1-iQN8vJLFarGJJua6TLsgDhVnKmo=\n \n+throng@^4.0.0:\n+  version \"4.0.0\"\n+  resolved \"https://registry.yarnpkg.com/throng/-/throng-4.0.0.tgz#983c6ba1993b58eae859998aa687ffe88df84c17\"\n+  integrity sha1-mDxroZk7WOroWZmKpof/6I34TBc=\n+  dependencies:\n+    lodash.defaults \"^4.0.1\"\n+\n through2@^2.0.0:\n   version \"2.0.3\"\n   resolved \"https://registry.yarnpkg.com/through2/-/through2-2.0.3.tgz#0004569b37c7c74ba39c43f3ced78d1ad94140be\""
    }
  ]
}
