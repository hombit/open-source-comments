{
  "sha": "95f9a369a5c23771ad7fd8f3a6dd290052b3bea1",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODo5NWY5YTM2OWE1YzIzNzcxYWQ3ZmQ4ZjNhNmRkMjkwMDUyYjNiZWEx",
  "commit": {
    "author": {
      "name": "Joffrey JAFFEUX",
      "email": "j.jaffeux@gmail.com",
      "date": "2019-01-18T16:24:18Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2019-01-18T16:24:18Z"
    },
    "message": "FIX: ensures visits reports are correcttly differencing mobile/all (#6905)",
    "tree": {
      "sha": "f0d0470bec5c47bf3b01332edfebfd81cdf5b43f",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/f0d0470bec5c47bf3b01332edfebfd81cdf5b43f"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/95f9a369a5c23771ad7fd8f3a6dd290052b3bea1",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJcQf2yCRBK7hj4Ov3rIwAAdHIIAEirRlWyirMcEhv6K5TRe609\nReLLO6lSEkkOExh3OhMo4QVuuyZO9HrkqrOJ9jtwROH4tyaLJRAT0WX+SFJyKmPJ\nlpLJtX3+qpQDFuqUAwu7lOeDtIcHxflmLrOn53XfZlCBWbNjaIFZlE+S2MtB37KS\nSN7dq23GptDKLrU2QteySdEYPu33N6Srfnh9jW8Ruf59eao1DHLghiLgLE7fe+ue\nbynNPJIxE7PDXFsRGpi1aSwKi5mHPxYjOqjCwegRRwEXHotNroPvaAittX3XvxRw\nkrd62nOhVsOildaW9ub5vcrCFjEhIGcoNng0/7EZjG4bktcZeNuOQ3BPOIz/suc=\n=zzbl\n-----END PGP SIGNATURE-----\n",
      "payload": "tree f0d0470bec5c47bf3b01332edfebfd81cdf5b43f\nparent 7908a522a07a8fde1348c36f6587c8b395adc2ae\nauthor Joffrey JAFFEUX <j.jaffeux@gmail.com> 1547828658 +0100\ncommitter GitHub <noreply@github.com> 1547828658 +0100\n\nFIX: ensures visits reports are correcttly differencing mobile/all (#6905)\n\n"
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/95f9a369a5c23771ad7fd8f3a6dd290052b3bea1",
  "html_url": "https://github.com/discourse/discourse/commit/95f9a369a5c23771ad7fd8f3a6dd290052b3bea1",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/95f9a369a5c23771ad7fd8f3a6dd290052b3bea1/comments",
  "author": {
    "login": "jjaffeux",
    "id": 339945,
    "node_id": "MDQ6VXNlcjMzOTk0NQ==",
    "avatar_url": "https://avatars3.githubusercontent.com/u/339945?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jjaffeux",
    "html_url": "https://github.com/jjaffeux",
    "followers_url": "https://api.github.com/users/jjaffeux/followers",
    "following_url": "https://api.github.com/users/jjaffeux/following{/other_user}",
    "gists_url": "https://api.github.com/users/jjaffeux/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jjaffeux/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jjaffeux/subscriptions",
    "organizations_url": "https://api.github.com/users/jjaffeux/orgs",
    "repos_url": "https://api.github.com/users/jjaffeux/repos",
    "events_url": "https://api.github.com/users/jjaffeux/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jjaffeux/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "7908a522a07a8fde1348c36f6587c8b395adc2ae",
      "url": "https://api.github.com/repos/discourse/discourse/commits/7908a522a07a8fde1348c36f6587c8b395adc2ae",
      "html_url": "https://github.com/discourse/discourse/commit/7908a522a07a8fde1348c36f6587c8b395adc2ae"
    }
  ],
  "stats": {
    "total": 32,
    "additions": 30,
    "deletions": 2
  },
  "files": [
    {
      "sha": "fa110517900d07e85f5f276d701e9d390df28aa1",
      "filename": "app/models/report.rb",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/discourse/discourse/blob/95f9a369a5c23771ad7fd8f3a6dd290052b3bea1/app/models/report.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/95f9a369a5c23771ad7fd8f3a6dd290052b3bea1/app/models/report.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/models/report.rb?ref=95f9a369a5c23771ad7fd8f3a6dd290052b3bea1",
      "patch": "@@ -234,7 +234,7 @@ def self.report_visits(report)\n     basic_report_about report, UserVisit, :by_day, report.start_date, report.end_date, report.group_id\n     add_counts report, UserVisit, 'visited_at'\n \n-    report.prev30Days = UserVisit.where(mobile: true).where(\"visited_at >= ? and visited_at < ?\", report.start_date - 30.days, report.start_date).count\n+    report.prev30Days = UserVisit.where(\"visited_at >= ? and visited_at < ?\", report.start_date - 30.days, report.start_date).count\n   end\n \n   def self.report_mobile_visits(report)"
    },
    {
      "sha": "5bc013e0af94b6535002fce476e83d249a7cdf1c",
      "filename": "spec/models/report_spec.rb",
      "status": "modified",
      "additions": 29,
      "deletions": 1,
      "changes": 30,
      "blob_url": "https://github.com/discourse/discourse/blob/95f9a369a5c23771ad7fd8f3a6dd290052b3bea1/spec/models/report_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/95f9a369a5c23771ad7fd8f3a6dd290052b3bea1/spec/models/report_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/models/report_spec.rb?ref=95f9a369a5c23771ad7fd8f3a6dd290052b3bea1",
      "patch": "@@ -114,14 +114,42 @@\n         freeze_time DateTime.parse('2000-01-01')\n         user.user_visits.create(visited_at: 1.hour.from_now)\n         user.user_visits.create(visited_at: 1.day.ago)\n-        user.user_visits.create(visited_at: 2.days.ago)\n+        user.user_visits.create(visited_at: 2.days.ago, mobile: true)\n+        user.user_visits.create(visited_at: 45.days.ago)\n+        user.user_visits.create(visited_at: 46.days.ago, mobile: true)\n+\n         expect(report.data).to be_present\n+        expect(report.data.count).to eq(3)\n         expect(report.data.select { |v| v[:x].today? }).to be_present\n+        expect(report.prev30Days).to eq(2)\n       end\n \n     end\n   end\n \n+  describe 'mobile visits report' do\n+    let(:report) { Report.find('mobile_visits') }\n+\n+    include_examples 'no data'\n+\n+    context \"with visits\" do\n+      let(:user) { Fabricate(:user) }\n+\n+      it \"returns a report with data\" do\n+        freeze_time DateTime.parse('2000-01-01')\n+        user.user_visits.create(visited_at: 1.hour.from_now)\n+        user.user_visits.create(visited_at: 2.days.ago, mobile: true)\n+        user.user_visits.create(visited_at: 45.days.ago)\n+        user.user_visits.create(visited_at: 46.days.ago, mobile: true)\n+\n+        expect(report.data).to be_present\n+        expect(report.data.count).to eq(1)\n+        expect(report.data.select { |v| v[:x].today? }).not_to be_present\n+        expect(report.prev30Days).to eq(1)\n+      end\n+    end\n+  end\n+\n   [:signup, :topic, :post, :flag, :like, :email].each do |arg|\n     describe \"#{arg} report\" do\n       pluralized = arg.to_s.pluralize"
    }
  ]
}
