{
  "sha": "97e17fe084d493655d1542495ffa494fd9003a08",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODo5N2UxN2ZlMDg0ZDQ5MzY1NWQxNTQyNDk1ZmZhNDk0ZmQ5MDAzYTA4",
  "commit": {
    "author": {
      "name": "Rishabh",
      "email": "rishabh.nambiar@discourse.org",
      "date": "2019-01-20T15:14:07Z"
    },
    "committer": {
      "name": "Rishabh",
      "email": "rishabh.nambiar@discourse.org",
      "date": "2019-01-20T15:25:27Z"
    },
    "message": "FIX: Use ENV values instead of 'S3Helper.s3_options' in migrate_to_s3\n\nThis commit makes the rake task operational for all regions for s3. If we declare s3_endpoint as https://s3.amazonaws.com while\ncreating an instance of Aws::S3::Client, head_bucket fails for all s3 regions apart from us-east-1. The commit manually defines all\nparameters for Aws::S3::Client apart from s3_endpoint to bypass this problem make this task usable for AWS S3.\n\nRemoving s3_endpoint from the payload means that custom endpoints like Minio/DO Spaces for will not work in the meantime and we'll\nhave to add support for a custom `s3_endpoint` in the future.\n\nThis commit follows up on 60790eb0.",
    "tree": {
      "sha": "214e5f7d9bd37b6099ba23a3e2c7320de91b729e",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/214e5f7d9bd37b6099ba23a3e2c7320de91b729e"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/97e17fe084d493655d1542495ffa494fd9003a08",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/97e17fe084d493655d1542495ffa494fd9003a08",
  "html_url": "https://github.com/discourse/discourse/commit/97e17fe084d493655d1542495ffa494fd9003a08",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/97e17fe084d493655d1542495ffa494fd9003a08/comments",
  "author": {
    "login": "rishabhnambiar",
    "id": 5862206,
    "node_id": "MDQ6VXNlcjU4NjIyMDY=",
    "avatar_url": "https://avatars3.githubusercontent.com/u/5862206?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rishabhnambiar",
    "html_url": "https://github.com/rishabhnambiar",
    "followers_url": "https://api.github.com/users/rishabhnambiar/followers",
    "following_url": "https://api.github.com/users/rishabhnambiar/following{/other_user}",
    "gists_url": "https://api.github.com/users/rishabhnambiar/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rishabhnambiar/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rishabhnambiar/subscriptions",
    "organizations_url": "https://api.github.com/users/rishabhnambiar/orgs",
    "repos_url": "https://api.github.com/users/rishabhnambiar/repos",
    "events_url": "https://api.github.com/users/rishabhnambiar/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rishabhnambiar/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "rishabhnambiar",
    "id": 5862206,
    "node_id": "MDQ6VXNlcjU4NjIyMDY=",
    "avatar_url": "https://avatars3.githubusercontent.com/u/5862206?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rishabhnambiar",
    "html_url": "https://github.com/rishabhnambiar",
    "followers_url": "https://api.github.com/users/rishabhnambiar/followers",
    "following_url": "https://api.github.com/users/rishabhnambiar/following{/other_user}",
    "gists_url": "https://api.github.com/users/rishabhnambiar/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rishabhnambiar/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rishabhnambiar/subscriptions",
    "organizations_url": "https://api.github.com/users/rishabhnambiar/orgs",
    "repos_url": "https://api.github.com/users/rishabhnambiar/repos",
    "events_url": "https://api.github.com/users/rishabhnambiar/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rishabhnambiar/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "90823eaca669520f7edc8f105582bfeb63ff54a3",
      "url": "https://api.github.com/repos/discourse/discourse/commits/90823eaca669520f7edc8f105582bfeb63ff54a3",
      "html_url": "https://github.com/discourse/discourse/commit/90823eaca669520f7edc8f105582bfeb63ff54a3"
    }
  ],
  "stats": {
    "total": 12,
    "additions": 8,
    "deletions": 4
  },
  "files": [
    {
      "sha": "cb99d69daf1936faa49a49d74a189798b400cd0f",
      "filename": "lib/tasks/uploads.rake",
      "status": "modified",
      "additions": 8,
      "deletions": 4,
      "changes": 12,
      "blob_url": "https://github.com/discourse/discourse/blob/97e17fe084d493655d1542495ffa494fd9003a08/lib/tasks/uploads.rake",
      "raw_url": "https://github.com/discourse/discourse/raw/97e17fe084d493655d1542495ffa494fd9003a08/lib/tasks/uploads.rake",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/lib/tasks/uploads.rake?ref=97e17fe084d493655d1542495ffa494fd9003a08",
      "patch": "@@ -244,14 +244,18 @@ def migrate_to_s3\n     exit 3\n   end\n \n-  bucket_has_folder_path = true if GlobalSetting.s3_bucket.include? \"/\"\n-  s3 = Aws::S3::Client.new(S3Helper.s3_options(GlobalSetting))\n+  bucket_has_folder_path = true if ENV[\"DISCOURSE_S3_BUCKET\"].include? \"/\"\n+\n+  s3 = Aws::S3::Client.new(\n+    region: ENV[\"DISCOURSE_S3_REGION\"],\n+    access_key_id: ENV[\"DISCOURSE_S3_ACCESS_KEY_ID\"],\n+    secret_access_key: ENV[\"DISCOURSE_S3_SECRET_ACCESS_KEY\"])\n \n   if bucket_has_folder_path\n-    bucket, folder = S3Helper.get_bucket_and_folder_path(GlobalSetting.s3_bucket)\n+    bucket, folder = S3Helper.get_bucket_and_folder_path(ENV[\"DISCOURSE_S3_BUCKET\"])\n     folder = File.join(folder, \"/\")\n   else\n-    bucket, folder = GlobalSetting.s3_bucket, \"\"\n+    bucket, folder = ENV[\"DISCOURSE_S3_BUCKET\"], \"\"\n   end\n \n   begin"
    }
  ]
}
