{
  "sha": "7e4edcfae8a3c0e664b836ee7c5f28b47853a2f8",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODo3ZTRlZGNmYWU4YTNjMGU2NjRiODM2ZWU3YzVmMjhiNDc4NTNhMmY4",
  "commit": {
    "author": {
      "name": "Vinoth Kannan",
      "email": "vinothkannan@vinkas.com",
      "date": "2019-01-26T19:51:56Z"
    },
    "committer": {
      "name": "Vinoth Kannan",
      "email": "vinothkannan@vinkas.com",
      "date": "2019-01-26T19:51:56Z"
    },
    "message": "FIX: Convert lightbox html into proper image markdown",
    "tree": {
      "sha": "a732a873591afe7d5a20f15da3697761dd3be490",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/a732a873591afe7d5a20f15da3697761dd3be490"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/7e4edcfae8a3c0e664b836ee7c5f28b47853a2f8",
    "comment_count": 1,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/7e4edcfae8a3c0e664b836ee7c5f28b47853a2f8",
  "html_url": "https://github.com/discourse/discourse/commit/7e4edcfae8a3c0e664b836ee7c5f28b47853a2f8",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/7e4edcfae8a3c0e664b836ee7c5f28b47853a2f8/comments",
  "author": {
    "login": "vinothkannans",
    "id": 9372109,
    "node_id": "MDQ6VXNlcjkzNzIxMDk=",
    "avatar_url": "https://avatars0.githubusercontent.com/u/9372109?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vinothkannans",
    "html_url": "https://github.com/vinothkannans",
    "followers_url": "https://api.github.com/users/vinothkannans/followers",
    "following_url": "https://api.github.com/users/vinothkannans/following{/other_user}",
    "gists_url": "https://api.github.com/users/vinothkannans/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vinothkannans/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vinothkannans/subscriptions",
    "organizations_url": "https://api.github.com/users/vinothkannans/orgs",
    "repos_url": "https://api.github.com/users/vinothkannans/repos",
    "events_url": "https://api.github.com/users/vinothkannans/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vinothkannans/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "vinothkannans",
    "id": 9372109,
    "node_id": "MDQ6VXNlcjkzNzIxMDk=",
    "avatar_url": "https://avatars0.githubusercontent.com/u/9372109?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vinothkannans",
    "html_url": "https://github.com/vinothkannans",
    "followers_url": "https://api.github.com/users/vinothkannans/followers",
    "following_url": "https://api.github.com/users/vinothkannans/following{/other_user}",
    "gists_url": "https://api.github.com/users/vinothkannans/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vinothkannans/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vinothkannans/subscriptions",
    "organizations_url": "https://api.github.com/users/vinothkannans/orgs",
    "repos_url": "https://api.github.com/users/vinothkannans/repos",
    "events_url": "https://api.github.com/users/vinothkannans/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vinothkannans/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "a72ed6278bf177bb76ad9788c8a11fcb3a65eb01",
      "url": "https://api.github.com/repos/discourse/discourse/commits/a72ed6278bf177bb76ad9788c8a11fcb3a65eb01",
      "html_url": "https://github.com/discourse/discourse/commit/a72ed6278bf177bb76ad9788c8a11fcb3a65eb01"
    }
  ],
  "stats": {
    "total": 31,
    "additions": 27,
    "deletions": 4
  },
  "files": [
    {
      "sha": "ee3bd1e0e3e12f409bb136b55ff08c15a1fc4f78",
      "filename": "app/assets/javascripts/discourse/lib/to-markdown.js.es6",
      "status": "modified",
      "additions": 12,
      "deletions": 4,
      "changes": 16,
      "blob_url": "https://github.com/discourse/discourse/blob/7e4edcfae8a3c0e664b836ee7c5f28b47853a2f8/app/assets/javascripts/discourse/lib/to-markdown.js.es6",
      "raw_url": "https://github.com/discourse/discourse/raw/7e4edcfae8a3c0e664b836ee7c5f28b47853a2f8/app/assets/javascripts/discourse/lib/to-markdown.js.es6",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/assets/javascripts/discourse/lib/to-markdown.js.es6?ref=7e4edcfae8a3c0e664b836ee7c5f28b47853a2f8",
      "patch": "@@ -8,6 +8,9 @@ const msoListClasses = [\n   \"MsoListParagraphCxSpMiddle\",\n   \"MsoListParagraphCxSpLast\"\n ];\n+const hasChild = (e, n) => {\n+  return (e.children || []).some(c => c.name === n);\n+};\n \n export class Tag {\n   constructor(name, prefix = \"\", suffix = \"\", inline = false) {\n@@ -194,14 +197,19 @@ export class Tag {\n       }\n \n       decorate(text) {\n-        const attr = this.element.attributes;\n+        const e = this.element;\n+        const attr = e.attributes;\n \n         if (/^mention/.test(attr.class) && \"@\" === text[0]) {\n           return text;\n-        }\n-\n-        if (\"hashtag\" === attr.class && \"#\" === text[0]) {\n+        } else if (\"hashtag\" === attr.class && \"#\" === text[0]) {\n           return text;\n+        } else if (\n+          [\"lightbox\", \"d-lazyload\"].includes(attr.class) &&\n+          hasChild(e, \"img\")\n+        ) {\n+          text = attr.title || \"\";\n+          return \"![\" + text + \"](\" + attr.href + \")\";\n         }\n \n         if (attr.href && text !== attr.href) {"
    },
    {
      "sha": "f63a004c26309e10a8949cec48641932e517ae8c",
      "filename": "test/javascripts/lib/to-markdown-test.js.es6",
      "status": "modified",
      "additions": 15,
      "deletions": 0,
      "changes": 15,
      "blob_url": "https://github.com/discourse/discourse/blob/7e4edcfae8a3c0e664b836ee7c5f28b47853a2f8/test/javascripts/lib/to-markdown-test.js.es6",
      "raw_url": "https://github.com/discourse/discourse/raw/7e4edcfae8a3c0e664b836ee7c5f28b47853a2f8/test/javascripts/lib/to-markdown-test.js.es6",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/test/javascripts/lib/to-markdown-test.js.es6?ref=7e4edcfae8a3c0e664b836ee7c5f28b47853a2f8",
      "patch": "@@ -352,3 +352,18 @@ QUnit.test(\"keeps emoji syntax for custom emoji\", assert => {\n \n   assert.equal(toMarkdown(html), markdown);\n });\n+\n+QUnit.test(\"converts image lightboxes to markdown\", assert => {\n+  let html = `\n+  <a class=\"lightbox\" href=\"https://d11a6trkgmumsb.cloudfront.net/uploads/default/original/1X/8hkjhk7692f6afed3cb99d43ab2abd4e30aa8cba.jpeg\" data-download-href=\"https://d11a6trkgmumsb.cloudfront.net/uploads/default/8hkjhk7692f6afed3cb99d43ab2abd4e30aa8cba\" title=\"sherlock3_sig.jpg\" rel=\"nofollow noopener\"><img src=\"https://d11a6trkgmumsb.cloudfront.net/uploads/default/optimized/1X/8hkjhk7692f6afed3cb99d43ab2abd4e30aa8cba_2_689x459.jpeg\" alt=\"sherlock3_sig\" width=\"689\" height=\"459\" class=\"d-lazyload\" srcset=\"https://d11a6trkgmumsb.cloudfront.net/uploads/default/optimized/1X/8hkjhk7692f6afed3cb99d43ab2abd4e30aa8cba_2_689x459.jpeg, https://d11a6trkgmumsb.cloudfront.net/uploads/default/optimized/1X/8hkjhk7692f6afed3cb99d43ab2abd4e30aa8cba_2_1033x688.jpeg 1.5x, https://d11a6trkgmumsb.cloudfront.net/uploads/default/optimized/1X/8hkjhk7692f6afed3cb99d43ab2abd4e30aa8cba_2_1378x918.jpeg 2x\"><div class=\"meta\">\n+  <span class=\"filename\">sherlock3_sig.jpg</span><span class=\"informations\">5496Ã—3664 2 MB</span><span class=\"expand\"></span>\n+  </div></a>\n+  `;\n+  const markdown = `![sherlock3_sig.jpg](https://d11a6trkgmumsb.cloudfront.net/uploads/default/original/1X/8hkjhk7692f6afed3cb99d43ab2abd4e30aa8cba.jpeg)`;\n+\n+  assert.equal(toMarkdown(html), markdown);\n+\n+  html = `<a class=\"lightbox\" href=\"https://d11a6trkgmumsb.cloudfront.net/uploads/default/original/1X/8hkjhk7692f6afed3cb99d43ab2abd4e30aa8cba.jpeg\" data-download-href=\"https://d11a6trkgmumsb.cloudfront.net/uploads/default/8hkjhk7692f6afed3cb99d43ab2abd4e30aa8cba\" title=\"sherlock3_sig.jpg\" rel=\"nofollow noopener\"><img src=\"https://d11a6trkgmumsb.cloudfront.net/uploads/default/optimized/1X/8hkjhk7692f6afed3cb99d43ab2abd4e30aa8cba_2_689x459.jpeg\" alt=\"sherlock3_sig\" width=\"689\" height=\"459\" class=\"d-lazyload\" srcset=\"https://d11a6trkgmumsb.cloudfront.net/uploads/default/optimized/1X/8hkjhk7692f6afed3cb99d43ab2abd4e30aa8cba_2_689x459.jpeg, https://d11a6trkgmumsb.cloudfront.net/uploads/default/optimized/1X/8hkjhk7692f6afed3cb99d43ab2abd4e30aa8cba_2_1033x688.jpeg 1.5x, https://d11a6trkgmumsb.cloudfront.net/uploads/default/optimized/1X/8hkjhk7692f6afed3cb99d43ab2abd4e30aa8cba_2_1378x918.jpeg 2x\"></a>`;\n+\n+  assert.equal(toMarkdown(html), markdown);\n+});"
    }
  ]
}
