{
  "sha": "7cd621778d6ef4e4f379ee0a12424b4f2c506045",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODo3Y2Q2MjE3NzhkNmVmNGU0ZjM3OWVlMGExMjQyNGI0ZjJjNTA2MDQ1",
  "commit": {
    "author": {
      "name": "Penar Musaraj",
      "email": "pmusaraj@gmail.com",
      "date": "2019-04-17T16:25:13Z"
    },
    "committer": {
      "name": "Penar Musaraj",
      "email": "pmusaraj@gmail.com",
      "date": "2019-04-17T16:25:13Z"
    },
    "message": "FEATURE: Native app banner improvements\n\nThis commit adds some improvements to native app banners for iOS and Android\n\n- iOS and Android now have separate settings for native app banners\n\n- app banners will now only show for users on TL1 and up\n\n- app ids are now in a hidden site setting to allow sites to switch to their own app, if desired\n\n- iOS only: the site URL is passed to the app arguments",
    "tree": {
      "sha": "e6d3c8d58f28c0d273eb0df9502c21eb8ca95ed4",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/e6d3c8d58f28c0d273eb0df9502c21eb8ca95ed4"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/7cd621778d6ef4e4f379ee0a12424b4f2c506045",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/7cd621778d6ef4e4f379ee0a12424b4f2c506045",
  "html_url": "https://github.com/discourse/discourse/commit/7cd621778d6ef4e4f379ee0a12424b4f2c506045",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/7cd621778d6ef4e4f379ee0a12424b4f2c506045/comments",
  "author": {
    "login": "pmusaraj",
    "id": 368961,
    "node_id": "MDQ6VXNlcjM2ODk2MQ==",
    "avatar_url": "https://avatars1.githubusercontent.com/u/368961?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pmusaraj",
    "html_url": "https://github.com/pmusaraj",
    "followers_url": "https://api.github.com/users/pmusaraj/followers",
    "following_url": "https://api.github.com/users/pmusaraj/following{/other_user}",
    "gists_url": "https://api.github.com/users/pmusaraj/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pmusaraj/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pmusaraj/subscriptions",
    "organizations_url": "https://api.github.com/users/pmusaraj/orgs",
    "repos_url": "https://api.github.com/users/pmusaraj/repos",
    "events_url": "https://api.github.com/users/pmusaraj/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pmusaraj/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "pmusaraj",
    "id": 368961,
    "node_id": "MDQ6VXNlcjM2ODk2MQ==",
    "avatar_url": "https://avatars1.githubusercontent.com/u/368961?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pmusaraj",
    "html_url": "https://github.com/pmusaraj",
    "followers_url": "https://api.github.com/users/pmusaraj/followers",
    "following_url": "https://api.github.com/users/pmusaraj/following{/other_user}",
    "gists_url": "https://api.github.com/users/pmusaraj/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pmusaraj/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pmusaraj/subscriptions",
    "organizations_url": "https://api.github.com/users/pmusaraj/orgs",
    "repos_url": "https://api.github.com/users/pmusaraj/repos",
    "events_url": "https://api.github.com/users/pmusaraj/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pmusaraj/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "14f9d40e486c39e74abfacdebbda86db1a8afd70",
      "url": "https://api.github.com/repos/discourse/discourse/commits/14f9d40e486c39e74abfacdebbda86db1a8afd70",
      "html_url": "https://github.com/discourse/discourse/commit/14f9d40e486c39e74abfacdebbda86db1a8afd70"
    }
  ],
  "stats": {
    "total": 50,
    "additions": 43,
    "deletions": 7
  },
  "files": [
    {
      "sha": "e7d16a58af9a1b4fef2189aae69707ca0f3cc668",
      "filename": "app/controllers/metadata_controller.rb",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/discourse/discourse/blob/7cd621778d6ef4e4f379ee0a12424b4f2c506045/app/controllers/metadata_controller.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/7cd621778d6ef4e4f379ee0a12424b4f2c506045/app/controllers/metadata_controller.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/controllers/metadata_controller.rb?ref=7cd621778d6ef4e4f379ee0a12424b4f2c506045",
      "patch": "@@ -51,13 +51,13 @@ def default_manifest\n \n     manifest[:short_name] = SiteSetting.short_title if SiteSetting.short_title.present?\n \n-    if SiteSetting.native_app_install_banner\n+    if current_user && current_user.trust_level >= 1 && SiteSetting.native_app_install_banner_android\n       manifest = manifest.merge(\n         prefer_related_applications: true,\n         related_applications: [\n           {\n             platform: \"play\",\n-            id: \"com.discourse\"\n+            id: SiteSetting.android_app_id\n           }\n         ]\n       )"
    },
    {
      "sha": "a5410864abaadb86c5eb35871b985f32f763afc1",
      "filename": "app/helpers/application_helper.rb",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/discourse/discourse/blob/7cd621778d6ef4e4f379ee0a12424b4f2c506045/app/helpers/application_helper.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/7cd621778d6ef4e4f379ee0a12424b4f2c506045/app/helpers/application_helper.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/helpers/application_helper.rb?ref=7cd621778d6ef4e4f379ee0a12424b4f2c506045",
      "patch": "@@ -325,6 +325,10 @@ def customization_disabled?\n     request.env[ApplicationController::NO_CUSTOM]\n   end\n \n+  def include_ios_native_app_banner?\n+    current_user && current_user.trust_level >= 1 && SiteSetting.native_app_install_banner_ios\n+  end\n+\n   def allow_plugins?\n     !request.env[ApplicationController::NO_PLUGINS]\n   end"
    },
    {
      "sha": "092d29116b2603f952ae38fc37ae89881a758067",
      "filename": "app/views/layouts/application.html.erb",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/discourse/discourse/blob/7cd621778d6ef4e4f379ee0a12424b4f2c506045/app/views/layouts/application.html.erb",
      "raw_url": "https://github.com/discourse/discourse/raw/7cd621778d6ef4e4f379ee0a12424b4f2c506045/app/views/layouts/application.html.erb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/views/layouts/application.html.erb?ref=7cd621778d6ef4e4f379ee0a12424b4f2c506045",
      "patch": "@@ -46,8 +46,8 @@\n     <%= render_google_universal_analytics_code %>\n     <link rel=\"manifest\" href=\"<%= Discourse.base_uri %>/manifest.webmanifest\" crossorigin=\"use-credentials\">\n \n-    <%- if SiteSetting.native_app_install_banner? %>\n-        <meta name=\"apple-itunes-app\" content=\"app-id=1173672076\">\n+    <%- if include_ios_native_app_banner? %>\n+        <meta name=\"apple-itunes-app\" content=\"app-id=<%= SiteSetting.ios_app_id %>, app-argument=discourse://new?siteUrl=<%= Discourse.base_url %>\">\n     <%- end %>\n \n     <%= render partial: \"common/discourse_stylesheet\" %>"
    },
    {
      "sha": "24e0147cee51d4aef34412b24b53a5062cf326fa",
      "filename": "config/locales/server.en.yml",
      "status": "modified",
      "additions": 3,
      "deletions": 1,
      "changes": 4,
      "blob_url": "https://github.com/discourse/discourse/blob/7cd621778d6ef4e4f379ee0a12424b4f2c506045/config/locales/server.en.yml",
      "raw_url": "https://github.com/discourse/discourse/raw/7cd621778d6ef4e4f379ee0a12424b4f2c506045/config/locales/server.en.yml",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/config/locales/server.en.yml?ref=7cd621778d6ef4e4f379ee0a12424b4f2c506045",
      "patch": "@@ -1892,7 +1892,9 @@ en:\n \n     topic_page_title_includes_category: \"Topic page title includes the category name.\"\n \n-    native_app_install_banner: \"Asks recurring visitors to install Discourse native app.\"\n+    native_app_install_banner_ios: \"Displays DiscourseHub app banner on iOS devices to regular users (trust level 1 and up).\"\n+\n+    native_app_install_banner_android: \"Displays DiscourseHub app banner on Android devices to regular users (trust level 1 and up).\"\n \n     share_anonymized_statistics: \"Share anonymized usage statistics.\"\n "
    },
    {
      "sha": "86ae8b3c31da46326242791f8c7ed0a1f06c2d32",
      "filename": "config/site_settings.yml",
      "status": "modified",
      "additions": 12,
      "deletions": 2,
      "changes": 14,
      "blob_url": "https://github.com/discourse/discourse/blob/7cd621778d6ef4e4f379ee0a12424b4f2c506045/config/site_settings.yml",
      "raw_url": "https://github.com/discourse/discourse/raw/7cd621778d6ef4e4f379ee0a12424b4f2c506045/config/site_settings.yml",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/config/site_settings.yml?ref=7cd621778d6ef4e4f379ee0a12424b4f2c506045",
      "patch": "@@ -1826,7 +1826,17 @@ uncategorized:\n     default: true\n     client: true\n \n-  native_app_install_banner: false\n+  native_app_install_banner_ios: false\n+\n+  native_app_install_banner_android: false\n+\n+  ios_app_id:\n+    default: \"1173672076\"\n+    hidden: true\n+\n+  android_app_id:\n+    default: \"com.discourse\"\n+    hidden: true\n \n   pwa_display_browser_regex:\n     default: \"iPad|iPhone\"\n@@ -1913,7 +1923,7 @@ user_preferences:\n       - normal\n       - larger\n       - largest\n-  \n+\n   default_title_count_mode:\n     type: enum\n     default: notifications"
    },
    {
      "sha": "57423a7be97f08a8205e683e69796fbbf4e28737",
      "filename": "db/migrate/20190417135049_migrate_native_app_banner_site_setting.rb",
      "status": "added",
      "additions": 20,
      "deletions": 0,
      "changes": 20,
      "blob_url": "https://github.com/discourse/discourse/blob/7cd621778d6ef4e4f379ee0a12424b4f2c506045/db/migrate/20190417135049_migrate_native_app_banner_site_setting.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/7cd621778d6ef4e4f379ee0a12424b4f2c506045/db/migrate/20190417135049_migrate_native_app_banner_site_setting.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/db/migrate/20190417135049_migrate_native_app_banner_site_setting.rb?ref=7cd621778d6ef4e4f379ee0a12424b4f2c506045",
      "patch": "@@ -0,0 +1,20 @@\n+class MigrateNativeAppBannerSiteSetting < ActiveRecord::Migration[5.2]\n+  def up\n+    execute \"INSERT INTO site_settings(name, data_type, value, created_at, updated_at)\n+             SELECT 'native_app_install_banner_android', 5, value, now(), now()\n+             FROM site_settings\n+             WHERE name = 'native_app_install_banner'\"\n+\n+    execute \"UPDATE site_settings\n+             SET name = 'native_app_install_banner_ios'\n+             WHERE name = 'native_app_install_banner'\"\n+  end\n+\n+  def down\n+    execute \"UPDATE site_settings\n+             SET name = 'native_app_install_banner'\n+             WHERE name = 'native_app_install_banner_ios'\"\n+\n+    execute \"DELETE FROM site_settings WHERE name = 'native_app_install_banner_android'\"\n+  end\n+end"
    }
  ]
}
