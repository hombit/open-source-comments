{
  "sha": "812905cbb6f7bd31532d8bc594c5cb50a9feb341",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODo4MTI5MDVjYmI2ZjdiZDMxNTMyZDhiYzU5NGM1Y2I1MGE5ZmViMzQx",
  "commit": {
    "author": {
      "name": "Robin Ward",
      "email": "robin.ward@gmail.com",
      "date": "2019-04-30T16:54:53Z"
    },
    "committer": {
      "name": "Robin Ward",
      "email": "robin.ward@gmail.com",
      "date": "2019-04-30T16:54:53Z"
    },
    "message": "FIX: Recursively delete nested replies\n\nPreviously we were only deleting top level replies",
    "tree": {
      "sha": "6a2fbf21309dc21121ae8b9e70dd57f1294600fe",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/6a2fbf21309dc21121ae8b9e70dd57f1294600fe"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/812905cbb6f7bd31532d8bc594c5cb50a9feb341",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/812905cbb6f7bd31532d8bc594c5cb50a9feb341",
  "html_url": "https://github.com/discourse/discourse/commit/812905cbb6f7bd31532d8bc594c5cb50a9feb341",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/812905cbb6f7bd31532d8bc594c5cb50a9feb341/comments",
  "author": {
    "login": "eviltrout",
    "id": 17538,
    "node_id": "MDQ6VXNlcjE3NTM4",
    "avatar_url": "https://avatars0.githubusercontent.com/u/17538?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/eviltrout",
    "html_url": "https://github.com/eviltrout",
    "followers_url": "https://api.github.com/users/eviltrout/followers",
    "following_url": "https://api.github.com/users/eviltrout/following{/other_user}",
    "gists_url": "https://api.github.com/users/eviltrout/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/eviltrout/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/eviltrout/subscriptions",
    "organizations_url": "https://api.github.com/users/eviltrout/orgs",
    "repos_url": "https://api.github.com/users/eviltrout/repos",
    "events_url": "https://api.github.com/users/eviltrout/events{/privacy}",
    "received_events_url": "https://api.github.com/users/eviltrout/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "eviltrout",
    "id": 17538,
    "node_id": "MDQ6VXNlcjE3NTM4",
    "avatar_url": "https://avatars0.githubusercontent.com/u/17538?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/eviltrout",
    "html_url": "https://github.com/eviltrout",
    "followers_url": "https://api.github.com/users/eviltrout/followers",
    "following_url": "https://api.github.com/users/eviltrout/following{/other_user}",
    "gists_url": "https://api.github.com/users/eviltrout/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/eviltrout/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/eviltrout/subscriptions",
    "organizations_url": "https://api.github.com/users/eviltrout/orgs",
    "repos_url": "https://api.github.com/users/eviltrout/repos",
    "events_url": "https://api.github.com/users/eviltrout/events{/privacy}",
    "received_events_url": "https://api.github.com/users/eviltrout/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "5edb5c8b034f7cb0a14106b160f04f0c9508aa9e",
      "url": "https://api.github.com/repos/discourse/discourse/commits/5edb5c8b034f7cb0a14106b160f04f0c9508aa9e",
      "html_url": "https://github.com/discourse/discourse/commit/5edb5c8b034f7cb0a14106b160f04f0c9508aa9e"
    }
  ],
  "stats": {
    "total": 20,
    "additions": 18,
    "deletions": 2
  },
  "files": [
    {
      "sha": "cf5829b611b2199f9b28af5eaca18358171a6939",
      "filename": "app/models/reviewable_flagged_post.rb",
      "status": "modified",
      "additions": 4,
      "deletions": 2,
      "changes": 6,
      "blob_url": "https://github.com/discourse/discourse/blob/812905cbb6f7bd31532d8bc594c5cb50a9feb341/app/models/reviewable_flagged_post.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/812905cbb6f7bd31532d8bc594c5cb50a9feb341/app/models/reviewable_flagged_post.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/models/reviewable_flagged_post.rb?ref=812905cbb6f7bd31532d8bc594c5cb50a9feb341",
      "patch": "@@ -211,7 +211,8 @@ def perform_delete_and_ignore(performed_by, args)\n   def perform_delete_and_ignore_replies(performed_by, args)\n     result = perform_ignore(performed_by, args)\n \n-    replies = PostReply.where(post_id: post.id).includes(:reply).map(&:reply)\n+    reply_ids = post.reply_ids(Guardian.new(performed_by), only_replies_to_single_post: false)\n+    replies = Post.where(id: reply_ids.map { |r| r[:id] })\n     PostDestroyer.new(performed_by, post).destroy\n     replies.each { |reply| PostDestroyer.new(performed_by, reply).destroy }\n \n@@ -227,7 +228,8 @@ def perform_delete_and_agree(performed_by, args)\n   def perform_delete_and_agree_replies(performed_by, args)\n     result = agree(performed_by, args)\n \n-    replies = PostReply.where(post_id: post.id).includes(:reply).map(&:reply)\n+    reply_ids = post.reply_ids(Guardian.new(performed_by), only_replies_to_single_post: false)\n+    replies = Post.where(id: reply_ids.map { |r| r[:id] })\n     PostDestroyer.new(performed_by, post).destroy\n     replies.each { |reply| PostDestroyer.new(performed_by, reply).destroy }\n "
    },
    {
      "sha": "4ca31603315c7abfca05f41fe718632561876efd",
      "filename": "spec/models/reviewable_flagged_post_spec.rb",
      "status": "modified",
      "additions": 14,
      "deletions": 0,
      "changes": 14,
      "blob_url": "https://github.com/discourse/discourse/blob/812905cbb6f7bd31532d8bc594c5cb50a9feb341/spec/models/reviewable_flagged_post_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/812905cbb6f7bd31532d8bc594c5cb50a9feb341/spec/models/reviewable_flagged_post_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/models/reviewable_flagged_post_spec.rb?ref=812905cbb6f7bd31532d8bc594c5cb50a9feb341",
      "patch": "@@ -131,13 +131,20 @@ def pending_count\n         reply_to_post_number: post.post_number,\n         topic_id: post.topic_id\n       )\n+      nested_reply = PostCreator.create(\n+        Fabricate(:user),\n+        raw: 'this is the reply text2',\n+        reply_to_post_number: reply.post_number,\n+        topic_id: post.topic_id\n+      )\n       post.reload\n \n       reviewable.perform(moderator, :delete_and_ignore_replies)\n       expect(reviewable).to be_ignored\n       expect(score.reload).to be_ignored\n       expect(post.reload.deleted_at).to be_present\n       expect(reply.reload.deleted_at).to be_present\n+      expect(nested_reply.reload.deleted_at).to be_present\n     end\n \n     it \"delete_and_agree agrees with the flags and deletes post\" do\n@@ -154,13 +161,20 @@ def pending_count\n         reply_to_post_number: post.post_number,\n         topic_id: post.topic_id\n       )\n+      nested_reply = PostCreator.create(\n+        Fabricate(:user),\n+        raw: 'this is the reply text2',\n+        reply_to_post_number: reply.post_number,\n+        topic_id: post.topic_id\n+      )\n       post.reload\n \n       reviewable.perform(moderator, :delete_and_agree_replies)\n       expect(reviewable).to be_approved\n       expect(score.reload).to be_agreed\n       expect(post.reload.deleted_at).to be_present\n       expect(reply.reload.deleted_at).to be_present\n+      expect(nested_reply.reload.deleted_at).to be_present\n     end\n \n     it \"disagrees with the flags\" do"
    }
  ]
}
