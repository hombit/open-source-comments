{
  "sha": "b5c8f5f900704e41371555c87a2a403a38cf9b85",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODpiNWM4ZjVmOTAwNzA0ZTQxMzcxNTU1Yzg3YTJhNDAzYTM4Y2Y5Yjg1",
  "commit": {
    "author": {
      "name": "Régis Hanol",
      "email": "regis@hanol.fr",
      "date": "2019-05-09T16:01:35Z"
    },
    "committer": {
      "name": "Régis Hanol",
      "email": "regis@hanol.fr",
      "date": "2019-05-09T16:01:35Z"
    },
    "message": "SPEC: ensure never remap readonly columns\n\nFollow-up to bfcbfd78",
    "tree": {
      "sha": "34659839c5a5d1b834c3991a9e16dba43b7bb6aa",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/34659839c5a5d1b834c3991a9e16dba43b7bb6aa"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/b5c8f5f900704e41371555c87a2a403a38cf9b85",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/b5c8f5f900704e41371555c87a2a403a38cf9b85",
  "html_url": "https://github.com/discourse/discourse/commit/b5c8f5f900704e41371555c87a2a403a38cf9b85",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/b5c8f5f900704e41371555c87a2a403a38cf9b85/comments",
  "author": {
    "login": "ZogStriP",
    "id": 362783,
    "node_id": "MDQ6VXNlcjM2Mjc4Mw==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/362783?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ZogStriP",
    "html_url": "https://github.com/ZogStriP",
    "followers_url": "https://api.github.com/users/ZogStriP/followers",
    "following_url": "https://api.github.com/users/ZogStriP/following{/other_user}",
    "gists_url": "https://api.github.com/users/ZogStriP/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ZogStriP/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ZogStriP/subscriptions",
    "organizations_url": "https://api.github.com/users/ZogStriP/orgs",
    "repos_url": "https://api.github.com/users/ZogStriP/repos",
    "events_url": "https://api.github.com/users/ZogStriP/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ZogStriP/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "ZogStriP",
    "id": 362783,
    "node_id": "MDQ6VXNlcjM2Mjc4Mw==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/362783?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ZogStriP",
    "html_url": "https://github.com/ZogStriP",
    "followers_url": "https://api.github.com/users/ZogStriP/followers",
    "following_url": "https://api.github.com/users/ZogStriP/following{/other_user}",
    "gists_url": "https://api.github.com/users/ZogStriP/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ZogStriP/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ZogStriP/subscriptions",
    "organizations_url": "https://api.github.com/users/ZogStriP/orgs",
    "repos_url": "https://api.github.com/users/ZogStriP/repos",
    "events_url": "https://api.github.com/users/ZogStriP/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ZogStriP/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "2a45933ff2ac22ef59189586cd91c145aed9afed",
      "url": "https://api.github.com/repos/discourse/discourse/commits/2a45933ff2ac22ef59189586cd91c145aed9afed",
      "html_url": "https://github.com/discourse/discourse/commit/2a45933ff2ac22ef59189586cd91c145aed9afed"
    }
  ],
  "stats": {
    "total": 22,
    "additions": 20,
    "deletions": 2
  },
  "files": [
    {
      "sha": "32ce37a258a4869eb3d9225dab8241bf274411f0",
      "filename": "lib/db_helper.rb",
      "status": "modified",
      "additions": 4,
      "deletions": 2,
      "changes": 6,
      "blob_url": "https://github.com/discourse/discourse/blob/b5c8f5f900704e41371555c87a2a403a38cf9b85/lib/db_helper.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/b5c8f5f900704e41371555c87a2a403a38cf9b85/lib/db_helper.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/lib/db_helper.rb?ref=b5c8f5f900704e41371555c87a2a403a38cf9b85",
      "patch": "@@ -1,3 +1,5 @@\n+require_dependency \"migration/base_dropper\"\n+\n class DbHelper\n \n   REMAP_SQL ||= <<~SQL\n@@ -23,7 +25,7 @@ def self.remap(from, to, anchor_left: false, anchor_right: false, excluded_table\n     text_columns = Hash.new { |h, k| h[k] = [] }\n \n     DB.query(REMAP_SQL).each do |r|\n-      unless triggers.include?(\"#{r.table_name}_#{r.column_name}_readonly\")\n+      unless triggers.include?(Migration::BaseDropper.readonly_trigger_name(r.table_name, r.column_name))\n         text_columns[r.table_name] << r.column_name\n       end\n     end\n@@ -55,7 +57,7 @@ def self.regexp_replace(pattern, replacement, flags: \"gi\", match: \"~*\", excluded\n     text_columns = Hash.new { |h, k| h[k] = [] }\n \n     DB.query(REMAP_SQL).each do |r|\n-      unless triggers.include?(\"#{r.table_name}_#{r.column_name}_readonly\")\n+      unless triggers.include?(Migration::BaseDropper.readonly_trigger_name(r.table_name, r.column_name))\n         text_columns[r.table_name] << r.column_name\n       end\n     end"
    },
    {
      "sha": "af834dc197ae3c7d40e4422dc6ec9f359fc4d072",
      "filename": "spec/lib/db_helper_spec.rb",
      "status": "modified",
      "additions": 16,
      "deletions": 0,
      "changes": 16,
      "blob_url": "https://github.com/discourse/discourse/blob/b5c8f5f900704e41371555c87a2a403a38cf9b85/spec/lib/db_helper_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/b5c8f5f900704e41371555c87a2a403a38cf9b85/spec/lib/db_helper_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/lib/db_helper_spec.rb?ref=b5c8f5f900704e41371555c87a2a403a38cf9b85",
      "patch": "@@ -2,6 +2,7 @@\n \n require 'rails_helper'\n require_dependency 'db_helper'\n+require_dependency 'migration/column_dropper'\n \n RSpec.describe DbHelper do\n   describe '.remap' do\n@@ -42,6 +43,21 @@\n \n       expect(post.reload.cooked).to eq('test')\n     end\n+\n+    it \"does not remap readonly columns\" do\n+      post = Fabricate(:post, raw: \"This is a test\", cooked: \"This is a test\")\n+\n+      Migration::ColumnDropper.mark_readonly(\"posts\", \"cooked\")\n+\n+      DbHelper.remap(\"test\", \"something else\")\n+\n+      post.reload\n+\n+      expect(post.raw).to eq(\"This is a something else\")\n+      expect(post.cooked).to eq(\"This is a test\")\n+\n+      DB.exec \"DROP FUNCTION #{Migration::BaseDropper.readonly_function_name(\"posts\", \"cooked\")} CASCADE\"\n+    end\n   end\n \n   describe \".regexp_replace\" do"
    }
  ]
}
