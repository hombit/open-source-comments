{
  "sha": "d95a68b837d6f38a30aec32fd0cb1f7535472bf3",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODpkOTVhNjhiODM3ZDZmMzhhMzBhZWMzMmZkMGNiMWY3NTM1NDcyYmYz",
  "commit": {
    "author": {
      "name": "Robin Ward",
      "email": "robin.ward@gmail.com",
      "date": "2019-05-27T16:27:16Z"
    },
    "committer": {
      "name": "Robin Ward",
      "email": "robin.ward@gmail.com",
      "date": "2019-05-27T16:27:16Z"
    },
    "message": "FEATURE: When suspending a user, allow the Delete + Replies action\n\nPreviously you could only delete the post",
    "tree": {
      "sha": "1b9ea5177f84a6421b10fb58025b95b81ebfc262",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/1b9ea5177f84a6421b10fb58025b95b81ebfc262"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/d95a68b837d6f38a30aec32fd0cb1f7535472bf3",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/d95a68b837d6f38a30aec32fd0cb1f7535472bf3",
  "html_url": "https://github.com/discourse/discourse/commit/d95a68b837d6f38a30aec32fd0cb1f7535472bf3",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/d95a68b837d6f38a30aec32fd0cb1f7535472bf3/comments",
  "author": {
    "login": "eviltrout",
    "id": 17538,
    "node_id": "MDQ6VXNlcjE3NTM4",
    "avatar_url": "https://avatars0.githubusercontent.com/u/17538?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/eviltrout",
    "html_url": "https://github.com/eviltrout",
    "followers_url": "https://api.github.com/users/eviltrout/followers",
    "following_url": "https://api.github.com/users/eviltrout/following{/other_user}",
    "gists_url": "https://api.github.com/users/eviltrout/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/eviltrout/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/eviltrout/subscriptions",
    "organizations_url": "https://api.github.com/users/eviltrout/orgs",
    "repos_url": "https://api.github.com/users/eviltrout/repos",
    "events_url": "https://api.github.com/users/eviltrout/events{/privacy}",
    "received_events_url": "https://api.github.com/users/eviltrout/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "eviltrout",
    "id": 17538,
    "node_id": "MDQ6VXNlcjE3NTM4",
    "avatar_url": "https://avatars0.githubusercontent.com/u/17538?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/eviltrout",
    "html_url": "https://github.com/eviltrout",
    "followers_url": "https://api.github.com/users/eviltrout/followers",
    "following_url": "https://api.github.com/users/eviltrout/following{/other_user}",
    "gists_url": "https://api.github.com/users/eviltrout/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/eviltrout/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/eviltrout/subscriptions",
    "organizations_url": "https://api.github.com/users/eviltrout/orgs",
    "repos_url": "https://api.github.com/users/eviltrout/repos",
    "events_url": "https://api.github.com/users/eviltrout/events{/privacy}",
    "received_events_url": "https://api.github.com/users/eviltrout/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "192562745fbf9d2796309df284de9f9ca4bd2eaa",
      "url": "https://api.github.com/repos/discourse/discourse/commits/192562745fbf9d2796309df284de9f9ca4bd2eaa",
      "html_url": "https://github.com/discourse/discourse/commit/192562745fbf9d2796309df284de9f9ca4bd2eaa"
    }
  ],
  "stats": {
    "total": 40,
    "additions": 33,
    "deletions": 7
  },
  "files": [
    {
      "sha": "543a8baf3c957f6743fd97f41640895813408eda",
      "filename": "app/assets/javascripts/admin/components/penalty-post-action.js.es6",
      "status": "modified",
      "additions": 2,
      "deletions": 1,
      "changes": 3,
      "blob_url": "https://github.com/discourse/discourse/blob/d95a68b837d6f38a30aec32fd0cb1f7535472bf3/app/assets/javascripts/admin/components/penalty-post-action.js.es6",
      "raw_url": "https://github.com/discourse/discourse/raw/d95a68b837d6f38a30aec32fd0cb1f7535472bf3/app/assets/javascripts/admin/components/penalty-post-action.js.es6",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/assets/javascripts/admin/components/penalty-post-action.js.es6?ref=d95a68b837d6f38a30aec32fd0cb1f7535472bf3",
      "patch": "@@ -1,6 +1,7 @@\n import computed from \"ember-addons/ember-computed-decorators\";\n \n-const ACTIONS = [\"delete\", \"edit\", \"none\"];\n+const ACTIONS = [\"delete\", \"delete_replies\", \"edit\", \"none\"];\n+\n export default Ember.Component.extend({\n   postId: null,\n   postAction: null,"
    },
    {
      "sha": "fc699c8c20f1947c5e95e39ab92824a760acee1b",
      "filename": "app/controllers/admin/users_controller.rb",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/discourse/discourse/blob/d95a68b837d6f38a30aec32fd0cb1f7535472bf3/app/controllers/admin/users_controller.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/d95a68b837d6f38a30aec32fd0cb1f7535472bf3/app/controllers/admin/users_controller.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/controllers/admin/users_controller.rb?ref=d95a68b837d6f38a30aec32fd0cb1f7535472bf3",
      "patch": "@@ -551,6 +551,8 @@ def perform_post_action\n       case params[:post_action]\n       when 'delete'\n         PostDestroyer.new(current_user, post).destroy\n+      when \"delete_replies\"\n+        PostDestroyer.delete_with_replies(current_user, post)\n       when 'edit'\n         revisor = PostRevisor.new(post)\n "
    },
    {
      "sha": "a8eea800d3e92589658832911763598db7a5dc60",
      "filename": "app/models/reviewable_flagged_post.rb",
      "status": "modified",
      "additions": 1,
      "deletions": 6,
      "changes": 7,
      "blob_url": "https://github.com/discourse/discourse/blob/d95a68b837d6f38a30aec32fd0cb1f7535472bf3/app/models/reviewable_flagged_post.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/d95a68b837d6f38a30aec32fd0cb1f7535472bf3/app/models/reviewable_flagged_post.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/models/reviewable_flagged_post.rb?ref=d95a68b837d6f38a30aec32fd0cb1f7535472bf3",
      "patch": "@@ -229,12 +229,7 @@ def perform_delete_and_agree(performed_by, args)\n \n   def perform_delete_and_agree_replies(performed_by, args)\n     result = agree(performed_by, args)\n-\n-    reply_ids = post.reply_ids(Guardian.new(performed_by), only_replies_to_single_post: false)\n-    replies = Post.where(id: reply_ids.map { |r| r[:id] })\n-    PostDestroyer.new(performed_by, post).destroy\n-    replies.each { |reply| PostDestroyer.new(performed_by, reply).destroy }\n-\n+    PostDestroyer.delete_with_replies(performed_by, post)\n     result\n   end\n "
    },
    {
      "sha": "f11cf849bdece3714920f9805242ff63217c96c6",
      "filename": "config/locales/client.en.yml",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/discourse/discourse/blob/d95a68b837d6f38a30aec32fd0cb1f7535472bf3/config/locales/client.en.yml",
      "raw_url": "https://github.com/discourse/discourse/raw/d95a68b837d6f38a30aec32fd0cb1f7535472bf3/config/locales/client.en.yml",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/config/locales/client.en.yml?ref=d95a68b837d6f38a30aec32fd0cb1f7535472bf3",
      "patch": "@@ -3877,6 +3877,7 @@ en:\n         delete_posts_failed: \"There was a problem deleting the posts.\"\n         penalty_post_actions: \"What would you like to do with the associated post?\"\n         penalty_post_delete: \"Delete the post\"\n+        penalty_post_delete_replies: \"Delete the post + any replies\"\n         penalty_post_edit: \"Edit the post\"\n         penalty_post_none: \"Do nothing\"\n         penalty_count: \"Penalty Count\""
    },
    {
      "sha": "e0c5ff3991ccd742bd0e878afe6c05d86ea9e6c3",
      "filename": "lib/post_destroyer.rb",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/discourse/discourse/blob/d95a68b837d6f38a30aec32fd0cb1f7535472bf3/lib/post_destroyer.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/d95a68b837d6f38a30aec32fd0cb1f7535472bf3/lib/post_destroyer.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/lib/post_destroyer.rb?ref=d95a68b837d6f38a30aec32fd0cb1f7535472bf3",
      "patch": "@@ -39,6 +39,13 @@ def self.destroy_stubs\n     end\n   end\n \n+  def self.delete_with_replies(performed_by, post)\n+    reply_ids = post.reply_ids(Guardian.new(performed_by), only_replies_to_single_post: false)\n+    replies = Post.where(id: reply_ids.map { |r| r[:id] })\n+    PostDestroyer.new(performed_by, post).destroy\n+    replies.each { |reply| PostDestroyer.new(performed_by, reply).destroy }\n+  end\n+\n   def initialize(user, post, opts = {})\n     @user = user\n     @post = post"
    },
    {
      "sha": "718b735e51c2f301c85593ac5afe40e7cbdb4591",
      "filename": "spec/requests/admin/users_controller_spec.rb",
      "status": "modified",
      "additions": 20,
      "deletions": 0,
      "changes": 20,
      "blob_url": "https://github.com/discourse/discourse/blob/d95a68b837d6f38a30aec32fd0cb1f7535472bf3/spec/requests/admin/users_controller_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/d95a68b837d6f38a30aec32fd0cb1f7535472bf3/spec/requests/admin/users_controller_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/requests/admin/users_controller_spec.rb?ref=d95a68b837d6f38a30aec32fd0cb1f7535472bf3",
      "patch": "@@ -185,6 +185,26 @@\n         expect(response.status).to eq(200)\n       end\n \n+      it \"can delete an associated post and its replies\" do\n+        reply = PostCreator.create(\n+          Fabricate(:user),\n+          raw: 'this is the reply text',\n+          reply_to_post_number: post.post_number,\n+          topic_id: post.topic_id\n+        )\n+        nested_reply = PostCreator.create(\n+          Fabricate(:user),\n+          raw: 'this is the reply text2',\n+          reply_to_post_number: reply.post_number,\n+          topic_id: post.topic_id\n+        )\n+        put \"/admin/users/#{user.id}/suspend.json\", params: suspend_params.merge(post_action: 'delete_replies')\n+        expect(post.reload.deleted_at).to be_present\n+        expect(reply.reload.deleted_at).to be_present\n+        expect(nested_reply.reload.deleted_at).to be_present\n+        expect(response.status).to eq(200)\n+      end\n+\n       it \"can edit an associated post\" do\n         put \"/admin/users/#{user.id}/suspend.json\", params: suspend_params.merge(\n           post_action: 'edit',"
    }
  ]
}
