{
  "sha": "ae386b963aeaf7af931f22a7d0ab9bc777837661",
  "node_id": "MDY6Q29tbWl0MTA1NjMzMjI6YWUzODZiOTYzYWVhZjdhZjkzMWYyMmE3ZDBhYjliYzc3NzgzNzY2MQ==",
  "commit": {
    "author": {
      "name": "Kaj Magnus Lindberg",
      "email": "kajmagnus3@gmail.com",
      "date": "2019-05-26T03:21:19Z"
    },
    "committer": {
      "name": "Kaj Magnus Lindberg",
      "email": "kajmagnus3@gmail.com",
      "date": "2019-05-26T07:09:03Z"
    },
    "message": "Make the forum embeddable: just avoid hiding things\n\nWhen in an iframe, and isn't an embedded comments discussion or editor,\navoid hiding the topbar and sidebar — this (seems to) make Talkyard work\nin an iframe as an embedded forum.",
    "tree": {
      "sha": "54794049cc17a5c0a42dbba6e4a50909a3b87958",
      "url": "https://api.github.com/repos/debiki/talkyard/git/trees/54794049cc17a5c0a42dbba6e4a50909a3b87958"
    },
    "url": "https://api.github.com/repos/debiki/talkyard/git/commits/ae386b963aeaf7af931f22a7d0ab9bc777837661",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/debiki/talkyard/commits/ae386b963aeaf7af931f22a7d0ab9bc777837661",
  "html_url": "https://github.com/debiki/talkyard/commit/ae386b963aeaf7af931f22a7d0ab9bc777837661",
  "comments_url": "https://api.github.com/repos/debiki/talkyard/commits/ae386b963aeaf7af931f22a7d0ab9bc777837661/comments",
  "author": {
    "login": "kajmagnus",
    "id": 7477359,
    "node_id": "MDQ6VXNlcjc0NzczNTk=",
    "avatar_url": "https://avatars1.githubusercontent.com/u/7477359?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/kajmagnus",
    "html_url": "https://github.com/kajmagnus",
    "followers_url": "https://api.github.com/users/kajmagnus/followers",
    "following_url": "https://api.github.com/users/kajmagnus/following{/other_user}",
    "gists_url": "https://api.github.com/users/kajmagnus/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/kajmagnus/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kajmagnus/subscriptions",
    "organizations_url": "https://api.github.com/users/kajmagnus/orgs",
    "repos_url": "https://api.github.com/users/kajmagnus/repos",
    "events_url": "https://api.github.com/users/kajmagnus/events{/privacy}",
    "received_events_url": "https://api.github.com/users/kajmagnus/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "kajmagnus",
    "id": 7477359,
    "node_id": "MDQ6VXNlcjc0NzczNTk=",
    "avatar_url": "https://avatars1.githubusercontent.com/u/7477359?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/kajmagnus",
    "html_url": "https://github.com/kajmagnus",
    "followers_url": "https://api.github.com/users/kajmagnus/followers",
    "following_url": "https://api.github.com/users/kajmagnus/following{/other_user}",
    "gists_url": "https://api.github.com/users/kajmagnus/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/kajmagnus/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kajmagnus/subscriptions",
    "organizations_url": "https://api.github.com/users/kajmagnus/orgs",
    "repos_url": "https://api.github.com/users/kajmagnus/repos",
    "events_url": "https://api.github.com/users/kajmagnus/events{/privacy}",
    "received_events_url": "https://api.github.com/users/kajmagnus/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "24a5facb903174c8a775ad6caa8642b0e7e61d1e",
      "url": "https://api.github.com/repos/debiki/talkyard/commits/24a5facb903174c8a775ad6caa8642b0e7e61d1e",
      "html_url": "https://github.com/debiki/talkyard/commit/24a5facb903174c8a775ad6caa8642b0e7e61d1e"
    }
  ],
  "stats": {
    "total": 35,
    "additions": 22,
    "deletions": 13
  },
  "files": [
    {
      "sha": "230f42f43d63a0833f78d384a776aa5162ad3634",
      "filename": "app/debiki/PageTpi.scala",
      "status": "modified",
      "additions": 0,
      "deletions": 1,
      "changes": 1,
      "blob_url": "https://github.com/debiki/talkyard/blob/ae386b963aeaf7af931f22a7d0ab9bc777837661/app/debiki/PageTpi.scala",
      "raw_url": "https://github.com/debiki/talkyard/raw/ae386b963aeaf7af931f22a7d0ab9bc777837661/app/debiki/PageTpi.scala",
      "contents_url": "https://api.github.com/repos/debiki/talkyard/contents/app/debiki/PageTpi.scala?ref=ae386b963aeaf7af931f22a7d0ab9bc777837661",
      "patch": "@@ -148,7 +148,6 @@ class SiteTpi protected (\n     views.html.debikiScriptsHead(\n       this, // Could remove all params below, use 'this' instead in the template.\n       siteId = siteId,\n-      anyPageRole = anyCurrentPageRole,\n       reactStoreSafeJsonString = reactStoreSafeJsonString,\n       isInLoginWindow = isInLoginWindow,\n       isAdminApp = isAdminApp,"
    },
    {
      "sha": "9ffbf9b9c0c5cc0154b961034ddd66c43f65232d",
      "filename": "app/views/debikiScriptsHead.scala.html",
      "status": "modified",
      "additions": 9,
      "deletions": 7,
      "changes": 16,
      "blob_url": "https://github.com/debiki/talkyard/blob/ae386b963aeaf7af931f22a7d0ab9bc777837661/app/views/debikiScriptsHead.scala.html",
      "raw_url": "https://github.com/debiki/talkyard/raw/ae386b963aeaf7af931f22a7d0ab9bc777837661/app/views/debikiScriptsHead.scala.html",
      "contents_url": "https://api.github.com/repos/debiki/talkyard/contents/app/views/debikiScriptsHead.scala.html?ref=ae386b963aeaf7af931f22a7d0ab9bc777837661",
      "patch": "@@ -15,15 +15,12 @@\n  * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n  *@\n \n-@(tpi: debiki.SiteTpi, siteId: Int,\n-  // CLEAN_UP remove anyPageRole, they're in the store json already, don't dupl!\n-  anyPageRole: Option[com.debiki.core.PageType],\n-  isInLoginWindow: Boolean,\n-  isAdminApp: Boolean,\n+@(tpi: debiki.SiteTpi, siteId: Int, isInLoginWindow: Boolean, isAdminApp: Boolean,\n   reactStoreSafeJsonString: String, minMaxJs: String, minMaxCss: String)\n \n @import tpi.globals\n @import com.debiki.core.PageType.InfoPageMaxId\n+@import com.debiki.core.PageType.EmbeddedComments\n @import org.owasp.encoder.Encode\n \n @altPageIdOrUndefined = @{\n@@ -114,7 +111,12 @@\n var _isInIframe;\n try { _isInIframe = window.self !== window.top; }\n catch (e) { _isInIframe = true; }\n-if (_isInIframe) _doc.className += ' s_InIframe';\n+\n+var _isInEmbCmtsIframe = (_cp || {}).pageRole === @{ EmbeddedComments.toInt } && _isInIframe;\n+\n+@* This css class hides the topbar and sidebars — they'd be confusing in an embedded\n+blog comments discussion section.  COULD RENAME to s_InEmbCmtsIframe ? *@\n+if (_isInEmbCmtsIframe) _doc.className += ' s_InIframe';\n \n @* In FF, in an embedded comments iframe, this error might happen, when doing getItem(..):  [7IWD20ZQ1]\n   \"SecurityError: The operation is insecure\"\n@@ -207,7 +209,7 @@\n   isInLoginWindow: @isInLoginWindowBoolStr,\n   isInLoginPopup: @isInLoginWindowBoolStr && _isInIframe,@* broken ?? checks in *iframe* ?? *@\n   isInIframe: _isInIframe,\n-  isInEmbeddedCommentsIframe: @{ if (anyPageRole.isDefined) \"_isInIframe\" else \"false\" },\n+  isInEmbeddedCommentsIframe: _isInEmbCmtsIframe,\n   isInAdminArea: @{ if (isAdminApp) \"true\" else \"false\" },\n   embeddingOrigin: @Html(embeddingOriginOrUndefined),\n   embeddingUrl: @Html(embeddingUrlOrUndefined),"
    },
    {
      "sha": "998c0a51b656ce40fe1c22214405e3b6104a690c",
      "filename": "client/app-editor/editor/editor.editor.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/debiki/talkyard/blob/ae386b963aeaf7af931f22a7d0ab9bc777837661/client/app-editor/editor/editor.editor.ts",
      "raw_url": "https://github.com/debiki/talkyard/raw/ae386b963aeaf7af931f22a7d0ab9bc777837661/client/app-editor/editor/editor.editor.ts",
      "contents_url": "https://api.github.com/repos/debiki/talkyard/contents/client/app-editor/editor/editor.editor.ts?ref=ae386b963aeaf7af931f22a7d0ab9bc777837661",
      "patch": "@@ -951,7 +951,7 @@ export const Editor = createComponent({\n \n   saveStuff: function() {\n     const isReplying = this.state.replyToPostNrs.length > 0;\n-    const loginToWhat = eds.isInIframe && isReplying ?\n+    const loginToWhat = eds.isInEmbeddedEditor && isReplying ?\n       LoginReason.PostEmbeddedComment : LoginReason.SubmitEditorText;\n \n     // Email verification shouldn't be needed immediately, checked by this constraint:"
    },
    {
      "sha": "cc0a6be70c48014fa040bd579f43c469cb484771",
      "filename": "client/app-more/login/login-dialog.more.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/debiki/talkyard/blob/ae386b963aeaf7af931f22a7d0ab9bc777837661/client/app-more/login/login-dialog.more.ts",
      "raw_url": "https://github.com/debiki/talkyard/raw/ae386b963aeaf7af931f22a7d0ab9bc777837661/client/app-more/login/login-dialog.more.ts",
      "contents_url": "https://api.github.com/repos/debiki/talkyard/contents/client/app-more/login/login-dialog.more.ts?ref=ae386b963aeaf7af931f22a7d0ab9bc777837661",
      "patch": "@@ -102,7 +102,7 @@ const LoginDialog = createClassAndFactory({\n   open: function(isSignUp: boolean, loginReason: LoginReason | string,\n         anyReturnToUrl?: string, callback?: () => void, preventClose?: boolean) {\n \n-    dieIf(eds.isInIframe, 'Login dialog in iframe [EdE5KER2]');\n+    dieIf(isInSomeEmbCommentsIframe(), 'Login dialog in some emb cmnts iframe [EdE5KER2]');\n \n     // The login reason might be a stringified number from the url, so try to convert to enum.\n     // Some login reasons are enums, others are strings. CLEAN_UP: Change the strings to enums."
    },
    {
      "sha": "be11263d6fa208c1c6d04d919bf3a12b2ea10c93",
      "filename": "client/app-slim/ReactActions.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/debiki/talkyard/blob/ae386b963aeaf7af931f22a7d0ab9bc777837661/client/app-slim/ReactActions.ts",
      "raw_url": "https://github.com/debiki/talkyard/raw/ae386b963aeaf7af931f22a7d0ab9bc777837661/client/app-slim/ReactActions.ts",
      "contents_url": "https://api.github.com/repos/debiki/talkyard/contents/client/app-slim/ReactActions.ts?ref=ae386b963aeaf7af931f22a7d0ab9bc777837661",
      "patch": "@@ -79,7 +79,7 @@ export function loadMyself(afterwardsCallback?) {\n   // deleted by the server.)\n \n   Server.loadMyself((user) => {\n-    if (eds.isInIframe) {\n+    if (isInSomeEmbCommentsIframe()) {\n       // Tell the embedded comments or embedded editor iframe that we just logged in.\n       window.parent.postMessage(JSON.stringify([\n         'justLoggedIn', { user }]),  // [JLGDIN]"
    },
    {
      "sha": "baf39c21d8d002bbf7ade78355a3dac296ea74c4",
      "filename": "client/app-slim/init-all-react-roots.ts",
      "status": "modified",
      "additions": 3,
      "deletions": 1,
      "changes": 4,
      "blob_url": "https://github.com/debiki/talkyard/blob/ae386b963aeaf7af931f22a7d0ab9bc777837661/client/app-slim/init-all-react-roots.ts",
      "raw_url": "https://github.com/debiki/talkyard/raw/ae386b963aeaf7af931f22a7d0ab9bc777837661/client/app-slim/init-all-react-roots.ts",
      "contents_url": "https://api.github.com/repos/debiki/talkyard/contents/client/app-slim/init-all-react-roots.ts?ref=ae386b963aeaf7af931f22a7d0ab9bc777837661",
      "patch": "@@ -112,7 +112,9 @@ export function startMainReactRoot(reactRenderMethodName: 'render' | 'hydrate')\n   else {\n     // Compare with [2FKB5P].\n \n-    const isEmbCmts: boolean = eds.isInEmbeddedCommentsIframe; // CLEAN_UP always false? remove DO_AFTER 2018-09-01? [2KBFU4]\n+    // (Currently always false, however maybe start using, if adding options for hiding\n+    // nav buttons, if in emb forum iframe?)\n+    const isEmbCmts: boolean = eds.isInEmbeddedCommentsIframe;\n     // @ifdef DEBUG\n     dieIf(isEmbCmts, 'TyE2RKBP3');\n     // @endif"
    },
    {
      "sha": "9c00c0feaf064ac90fd11f415f3d377641591761",
      "filename": "client/app-slim/login/login-if-needed.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/debiki/talkyard/blob/ae386b963aeaf7af931f22a7d0ab9bc777837661/client/app-slim/login/login-if-needed.ts",
      "raw_url": "https://github.com/debiki/talkyard/raw/ae386b963aeaf7af931f22a7d0ab9bc777837661/client/app-slim/login/login-if-needed.ts",
      "contents_url": "https://api.github.com/repos/debiki/talkyard/contents/client/app-slim/login/login-if-needed.ts?ref=ae386b963aeaf7af931f22a7d0ab9bc777837661",
      "patch": "@@ -49,6 +49,8 @@ export function loginIfNeededReturnToAnchor(\n     success();\n   }\n   else if (eds.isInIframe) {\n+    // ... or only if isInSomeEmbCommentsIframe()?\n+\n     // (Previously, a Chrome 63 bug: https://bugs.chromium.org/p/chromium/issues/detail?id=796912\n     // required an ugly workaround here: to poll and see if a session cookie suddenly appeared.\n     // DO_AFTER Remove this comment 2019-06-01? [4PKGTEW20])"
    },
    {
      "sha": "aac7c62078bb9664eeaafbc483c4fe55ce33467f",
      "filename": "client/app-slim/prelude.ts",
      "status": "modified",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "blob_url": "https://github.com/debiki/talkyard/blob/ae386b963aeaf7af931f22a7d0ab9bc777837661/client/app-slim/prelude.ts",
      "raw_url": "https://github.com/debiki/talkyard/raw/ae386b963aeaf7af931f22a7d0ab9bc777837661/client/app-slim/prelude.ts",
      "contents_url": "https://api.github.com/repos/debiki/talkyard/contents/client/app-slim/prelude.ts?ref=ae386b963aeaf7af931f22a7d0ab9bc777837661",
      "patch": "@@ -144,6 +144,9 @@ export function isCommunitySite(): boolean {\n }\n \n \n+export function isInSomeEmbCommentsIframe(): boolean {\n+  return eds.isInEmbeddedCommentsIframe || eds.isInEmbeddedEditor;\n+}\n \n /**\n  * Finds the main embedded comments window, where the per page temporary xsrf token"
    },
    {
      "sha": "bc84bba33639686d2bfc862aa1e36c7c55662ce3",
      "filename": "client/app-slim/pubsub/subscriptions.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/debiki/talkyard/blob/ae386b963aeaf7af931f22a7d0ab9bc777837661/client/app-slim/pubsub/subscriptions.ts",
      "raw_url": "https://github.com/debiki/talkyard/raw/ae386b963aeaf7af931f22a7d0ab9bc777837661/client/app-slim/pubsub/subscriptions.ts",
      "contents_url": "https://api.github.com/repos/debiki/talkyard/contents/client/app-slim/pubsub/subscriptions.ts?ref=ae386b963aeaf7af931f22a7d0ab9bc777837661",
      "patch": "@@ -146,7 +146,7 @@ function subscribeToServerEventsDirectly(me: Myself) {\n   // Or maybe server-sent-events [sse].\n   // And because 2) the aborted poll requests, result in error messages in the dev\n   // console, possibly making technical blog writers confused.\n-  if (eds.isInIframe)\n+  if (isInSomeEmbCommentsIframe())\n     return;\n \n   Server.sendLongPollingRequest(me.id, (response) => {"
    },
    {
      "sha": "34e29c24432e39bb38927d02d950d98b89c935d8",
      "filename": "client/app-slim/slim-bundle.d.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/debiki/talkyard/blob/ae386b963aeaf7af931f22a7d0ab9bc777837661/client/app-slim/slim-bundle.d.ts",
      "raw_url": "https://github.com/debiki/talkyard/raw/ae386b963aeaf7af931f22a7d0ab9bc777837661/client/app-slim/slim-bundle.d.ts",
      "contents_url": "https://api.github.com/repos/debiki/talkyard/contents/client/app-slim/slim-bundle.d.ts?ref=ae386b963aeaf7af931f22a7d0ab9bc777837661",
      "patch": "@@ -261,6 +261,7 @@ declare namespace debiki2 {\n \n   function whenMsToIsoDate(whenMs: number): string;\n \n+  function isInSomeEmbCommentsIframe(): boolean;\n   function isBlogCommentsSite(): boolean;\n   function isCommunitySite(): boolean;\n "
    }
  ]
}
