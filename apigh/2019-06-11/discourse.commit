{
  "sha": "3d7c26c15e6a4c834129addef752548208944a40",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODozZDdjMjZjMTVlNmE0YzgzNDEyOWFkZGVmNzUyNTQ4MjA4OTQ0YTQw",
  "commit": {
    "author": {
      "name": "Robin Ward",
      "email": "robin.ward@gmail.com",
      "date": "2019-06-11T16:41:27Z"
    },
    "committer": {
      "name": "Joffrey JAFFEUX",
      "email": "j.jaffeux@gmail.com",
      "date": "2019-06-11T16:41:27Z"
    },
    "message": "FIX: Memory Leaks w/ Container (#7750)\n\nGives instance initializers the ability to add a `teardown` method that\r\nwill be called between tests to clean up after themselves.",
    "tree": {
      "sha": "ca7e71fed4264dee21c8a0fcc618194ee6e63010",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/ca7e71fed4264dee21c8a0fcc618194ee6e63010"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/3d7c26c15e6a4c834129addef752548208944a40",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/3d7c26c15e6a4c834129addef752548208944a40",
  "html_url": "https://github.com/discourse/discourse/commit/3d7c26c15e6a4c834129addef752548208944a40",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/3d7c26c15e6a4c834129addef752548208944a40/comments",
  "author": {
    "login": "eviltrout",
    "id": 17538,
    "node_id": "MDQ6VXNlcjE3NTM4",
    "avatar_url": "https://avatars0.githubusercontent.com/u/17538?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/eviltrout",
    "html_url": "https://github.com/eviltrout",
    "followers_url": "https://api.github.com/users/eviltrout/followers",
    "following_url": "https://api.github.com/users/eviltrout/following{/other_user}",
    "gists_url": "https://api.github.com/users/eviltrout/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/eviltrout/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/eviltrout/subscriptions",
    "organizations_url": "https://api.github.com/users/eviltrout/orgs",
    "repos_url": "https://api.github.com/users/eviltrout/repos",
    "events_url": "https://api.github.com/users/eviltrout/events{/privacy}",
    "received_events_url": "https://api.github.com/users/eviltrout/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "jjaffeux",
    "id": 339945,
    "node_id": "MDQ6VXNlcjMzOTk0NQ==",
    "avatar_url": "https://avatars3.githubusercontent.com/u/339945?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jjaffeux",
    "html_url": "https://github.com/jjaffeux",
    "followers_url": "https://api.github.com/users/jjaffeux/followers",
    "following_url": "https://api.github.com/users/jjaffeux/following{/other_user}",
    "gists_url": "https://api.github.com/users/jjaffeux/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jjaffeux/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jjaffeux/subscriptions",
    "organizations_url": "https://api.github.com/users/jjaffeux/orgs",
    "repos_url": "https://api.github.com/users/jjaffeux/repos",
    "events_url": "https://api.github.com/users/jjaffeux/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jjaffeux/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "47095a7fa1551e771257408883d8e3f71a687ce1",
      "url": "https://api.github.com/repos/discourse/discourse/commits/47095a7fa1551e771257408883d8e3f71a687ce1",
      "html_url": "https://github.com/discourse/discourse/commit/47095a7fa1551e771257408883d8e3f71a687ce1"
    }
  ],
  "stats": {
    "total": 34,
    "additions": 25,
    "deletions": 9
  },
  "files": [
    {
      "sha": "3edee0161e21aad4d7b42d9d1066dad667ffd3bf",
      "filename": "app/assets/javascripts/discourse/initializers/csrf-token.js.es6",
      "status": "modified",
      "additions": 16,
      "deletions": 9,
      "changes": 25,
      "blob_url": "https://github.com/discourse/discourse/blob/3d7c26c15e6a4c834129addef752548208944a40/app/assets/javascripts/discourse/initializers/csrf-token.js.es6",
      "raw_url": "https://github.com/discourse/discourse/raw/3d7c26c15e6a4c834129addef752548208944a40/app/assets/javascripts/discourse/initializers/csrf-token.js.es6",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/assets/javascripts/discourse/initializers/csrf-token.js.es6?ref=3d7c26c15e6a4c834129addef752548208944a40",
      "patch": "@@ -1,21 +1,28 @@\n //  Append our CSRF token to AJAX requests when necessary.\n \n-let installedFilter = false;\n+let installed = false;\n+let callbacks = $.Callbacks();\n \n export default {\n   name: \"csrf-token\",\n-  initialize: function(container) {\n+  initialize(container) {\n     // Add a CSRF token to all AJAX requests\n     let session = container.lookup(\"session:main\");\n     session.set(\"csrfToken\", $(\"meta[name=csrf-token]\").attr(\"content\"));\n \n-    if (!installedFilter) {\n-      $.ajaxPrefilter(function(options, originalOptions, xhr) {\n-        if (!options.crossDomain) {\n-          xhr.setRequestHeader(\"X-CSRF-Token\", session.get(\"csrfToken\"));\n-        }\n-      });\n-      installedFilter = true;\n+    if (!installed) {\n+      $.ajaxPrefilter(callbacks.fire);\n+      installed = true;\n     }\n+\n+    callbacks.add(function(options, originalOptions, xhr) {\n+      if (!options.crossDomain) {\n+        xhr.setRequestHeader(\"X-CSRF-Token\", session.get(\"csrfToken\"));\n+      }\n+    });\n+  },\n+\n+  teardown() {\n+    callbacks.empty();\n   }\n };"
    },
    {
      "sha": "9d9d859da1a43ead4204adb9f4702bf88e78c608",
      "filename": "test/javascripts/test_helper.js",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/discourse/discourse/blob/3d7c26c15e6a4c834129addef752548208944a40/test/javascripts/test_helper.js",
      "raw_url": "https://github.com/discourse/discourse/raw/3d7c26c15e6a4c834129addef752548208944a40/test/javascripts/test_helper.js",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/test/javascripts/test_helper.js?ref=3d7c26c15e6a4c834129addef752548208944a40",
      "patch": "@@ -169,6 +169,15 @@ QUnit.testDone(function() {\n     });\n   });\n \n+  Discourse._runInitializer(\"instanceInitializers\", function(\n+    name,\n+    initializer\n+  ) {\n+    if (initializer && initializer.teardown) {\n+      initializer.teardown();\n+    }\n+  });\n+\n   // attempts to remove any subscribed message bus callback\n   window.MessageBus.callbacks.forEach(function(callback) {\n     window.MessageBus.unsubscribe(callback.channel, callback.func);"
    }
  ]
}
