{
  "sha": "ce8e09963903fcad725002b2d42b54b4af5d0930",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODpjZThlMDk5NjM5MDNmY2FkNzI1MDAyYjJkNDJiNTRiNGFmNWQwOTMw",
  "commit": {
    "author": {
      "name": "Gerhard Schlager",
      "email": "mail@gerhard-schlager.at",
      "date": "2019-07-12T19:09:57Z"
    },
    "committer": {
      "name": "Gerhard Schlager",
      "email": "mail@gerhard-schlager.at",
      "date": "2019-07-12T19:10:10Z"
    },
    "message": "FEATURE: Use configured quotation marks in fancy topic title",
    "tree": {
      "sha": "4abf5badb13b6ab0dec91f82a8a4f0f5c49e7f93",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/4abf5badb13b6ab0dec91f82a8a4f0f5c49e7f93"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/ce8e09963903fcad725002b2d42b54b4af5d0930",
    "comment_count": 1,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/ce8e09963903fcad725002b2d42b54b4af5d0930",
  "html_url": "https://github.com/discourse/discourse/commit/ce8e09963903fcad725002b2d42b54b4af5d0930",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/ce8e09963903fcad725002b2d42b54b4af5d0930/comments",
  "author": {
    "login": "gschlager",
    "id": 473736,
    "node_id": "MDQ6VXNlcjQ3MzczNg==",
    "avatar_url": "https://avatars3.githubusercontent.com/u/473736?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gschlager",
    "html_url": "https://github.com/gschlager",
    "followers_url": "https://api.github.com/users/gschlager/followers",
    "following_url": "https://api.github.com/users/gschlager/following{/other_user}",
    "gists_url": "https://api.github.com/users/gschlager/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gschlager/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gschlager/subscriptions",
    "organizations_url": "https://api.github.com/users/gschlager/orgs",
    "repos_url": "https://api.github.com/users/gschlager/repos",
    "events_url": "https://api.github.com/users/gschlager/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gschlager/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "gschlager",
    "id": 473736,
    "node_id": "MDQ6VXNlcjQ3MzczNg==",
    "avatar_url": "https://avatars3.githubusercontent.com/u/473736?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gschlager",
    "html_url": "https://github.com/gschlager",
    "followers_url": "https://api.github.com/users/gschlager/followers",
    "following_url": "https://api.github.com/users/gschlager/following{/other_user}",
    "gists_url": "https://api.github.com/users/gschlager/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gschlager/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gschlager/subscriptions",
    "organizations_url": "https://api.github.com/users/gschlager/orgs",
    "repos_url": "https://api.github.com/users/gschlager/repos",
    "events_url": "https://api.github.com/users/gschlager/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gschlager/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "8f89254554b6f80e575330083c3e5ceddcb7d8ac",
      "url": "https://api.github.com/repos/discourse/discourse/commits/8f89254554b6f80e575330083c3e5ceddcb7d8ac",
      "html_url": "https://github.com/discourse/discourse/commit/8f89254554b6f80e575330083c3e5ceddcb7d8ac"
    }
  ],
  "stats": {
    "total": 53,
    "additions": 50,
    "deletions": 3
  },
  "files": [
    {
      "sha": "160d19e84e6aae64325c8488107b83a1070b4e67",
      "filename": "app/models/site_setting.rb",
      "status": "modified",
      "additions": 18,
      "deletions": 0,
      "changes": 18,
      "blob_url": "https://github.com/discourse/discourse/blob/ce8e09963903fcad725002b2d42b54b4af5d0930/app/models/site_setting.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/ce8e09963903fcad725002b2d42b54b4af5d0930/app/models/site_setting.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/models/site_setting.rb?ref=ce8e09963903fcad725002b2d42b54b4af5d0930",
      "patch": "@@ -3,6 +3,7 @@\n require 'site_setting_extension'\n require_dependency 'global_path'\n require_dependency 'site_settings/yaml_loader'\n+require 'htmlentities'\n \n class SiteSetting < ActiveRecord::Base\n   extend GlobalPath\n@@ -122,6 +123,7 @@ def self.reset_cached_settings!\n     @attachment_content_type_blacklist_regex = nil\n     @attachment_filename_blacklist_regex = nil\n     @unicode_username_whitelist_regex = nil\n+    @pretty_quote_entities = nil\n   end\n \n   def self.attachment_content_type_blacklist_regex\n@@ -137,6 +139,22 @@ def self.unicode_username_character_whitelist_regex\n       ? Regexp.new(SiteSetting.unicode_username_character_whitelist) : nil\n   end\n \n+  def self.pretty_quote_entities\n+    @pretty_quote_entities ||= begin\n+      htmlentities = HTMLEntities.new\n+      quotation_marks = SiteSetting.markdown_typographer_quotation_marks\n+        .split(\"|\")\n+        .map { |quote| htmlentities.encode(quote, :basic, :named, :decimal) }\n+\n+      {\n+        double_left_quote: quotation_marks[0],\n+        double_right_quote: quotation_marks[1],\n+        single_left_quote: quotation_marks[2],\n+        single_right_quote: quotation_marks[3]\n+      }\n+    end\n+  end\n+\n   # helpers for getting s3 settings that fallback to global\n   class Upload\n     def self.s3_cdn_url"
    },
    {
      "sha": "4fd4c67e6fd532593e3052a90bd65f8ac5c6faf6",
      "filename": "app/models/topic.rb",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/discourse/discourse/blob/ce8e09963903fcad725002b2d42b54b4af5d0930/app/models/topic.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/ce8e09963903fcad725002b2d42b54b4af5d0930/app/models/topic.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/models/topic.rb?ref=ce8e09963903fcad725002b2d42b54b4af5d0930",
      "patch": "@@ -336,7 +336,7 @@ def limit_private_messages_per_day\n \n   def self.fancy_title(title)\n     return unless escaped = ERB::Util.html_escape(title)\n-    fancy_title = Emoji.unicode_unescape(HtmlPrettify.render(escaped))\n+    fancy_title = Emoji.unicode_unescape(HtmlPrettify.render(escaped, SiteSetting.pretty_quote_entities))\n     fancy_title.length > Topic.max_fancy_title_length ? escaped : fancy_title\n   end\n "
    },
    {
      "sha": "c339091d5868825ddd82bc05e1f6fd78d9bd6354",
      "filename": "lib/html_prettify.rb",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/discourse/discourse/blob/ce8e09963903fcad725002b2d42b54b4af5d0930/lib/html_prettify.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/ce8e09963903fcad725002b2d42b54b4af5d0930/lib/html_prettify.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/lib/html_prettify.rb?ref=ce8e09963903fcad725002b2d42b54b4af5d0930",
      "patch": "@@ -10,8 +10,8 @@\n #\n \n class HtmlPrettify < String\n-  def self.render(html)\n-    new(html).to_html\n+  def self.render(html, entities = {})\n+    new(html, [2], entities).to_html\n   end\n \n   # Create a new RubyPants instance with the text in +string+."
    },
    {
      "sha": "e91c4a6f319fdd932dfb455a01638b4941bbf208",
      "filename": "lib/tasks/topics.rake",
      "status": "modified",
      "additions": 19,
      "deletions": 0,
      "changes": 19,
      "blob_url": "https://github.com/discourse/discourse/blob/ce8e09963903fcad725002b2d42b54b4af5d0930/lib/tasks/topics.rake",
      "raw_url": "https://github.com/discourse/discourse/raw/ce8e09963903fcad725002b2d42b54b4af5d0930/lib/tasks/topics.rake",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/lib/tasks/topics.rake?ref=ce8e09963903fcad725002b2d42b54b4af5d0930",
      "patch": "@@ -83,6 +83,25 @@ task \"topics:watch_all_replied_topics\" => :environment do\n   puts \"\", \"Done\"\n end\n \n+task \"topics:update_fancy_titles\" => :environment do\n+  if !SiteSetting.title_fancy_entities?\n+    puts \"fancy topic titles are disabled\"\n+    return\n+  end\n+\n+  DB.exec(\"UPDATE topics SET fancy_title = NULL\")\n+\n+  total = Topic.count\n+  count = 0\n+\n+  Topic.find_each do |topic|\n+    topic.fancy_title\n+    print_status(count += 1, total)\n+  end\n+\n+  puts \"\", \"Done\"\n+end\n+\n def print_status(current, max)\n   print \"\\r%9d / %d (%5.1f%%)\" % [current, max, ((current.to_f / max.to_f) * 100).round(1)]\n end"
    },
    {
      "sha": "510146a0bb85c4ade0a7ea40aa53618e79c8e610",
      "filename": "spec/models/topic_spec.rb",
      "status": "modified",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/discourse/discourse/blob/ce8e09963903fcad725002b2d42b54b4af5d0930/spec/models/topic_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/ce8e09963903fcad725002b2d42b54b4af5d0930/spec/models/topic_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/models/topic_spec.rb?ref=ce8e09963903fcad725002b2d42b54b4af5d0930",
      "patch": "@@ -390,6 +390,16 @@ def build_topic_with_title(title)\n         expect(topic.fancy_title).to eq(long_title)\n       end\n \n+      it \"uses the configured quote entities\" do\n+        SiteSetting.markdown_typographer_quotation_marks = \"„|“|‚|‘\"\n+        topic.title = %q|\"Weißt du\", sagte er, \"was 'Discourse' ist?\"|\n+        expect(topic.fancy_title).to eq('&bdquo;Weißt du&ldquo;, sagte er, &bdquo;was &sbquo;Discourse&lsquo; ist?&ldquo;')\n+\n+        SiteSetting.markdown_typographer_quotation_marks = \"«\\u00A0|\\u00A0»|‹\\u00A0|\\u00A0›\"\n+        topic.title = '\"Qui vivra verra\"'\n+        expect(topic.fancy_title).to eq('&laquo;&nbsp;Qui vivra verra&nbsp;&raquo;')\n+      end\n+\n       context 'readonly mode' do\n         before do\n           Discourse.enable_readonly_mode"
    }
  ]
}
