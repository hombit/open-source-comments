{
  "sha": "eb26bee046c264602933f43d29c734a7e266928e",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODplYjI2YmVlMDQ2YzI2NDYwMjkzM2Y0M2QyOWM3MzRhN2UyNjY5Mjhl",
  "commit": {
    "author": {
      "name": "Roman Rizzi",
      "email": "rizziromanalejandro@gmail.com",
      "date": "2019-07-19T18:17:58Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2019-07-19T18:17:58Z"
    },
    "message": "DEV: group_list site settings should store IDs instead of group names (#7860)\n\n* DEV: group_list site settings should store IDs instead of group names\r\n\r\n* Ship site setting to know when we should migrate group_list settings\r\n\r\n* Migrate existing group_list site settings\r\n\r\n* Bump migration timestamp and don't set null when migrating is not possible.",
    "tree": {
      "sha": "28e327f7363f26c6c946f06ad86f992f2bd7742a",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/28e327f7363f26c6c946f06ad86f992f2bd7742a"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/eb26bee046c264602933f43d29c734a7e266928e",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdMglWCRBK7hj4Ov3rIwAAdHIIAH79ma4xo7VpKXXru6oKifC/\nwORJTZa//I9COMTCxA7uxDqk5VOTLJUcSpuLDhIcINZrk9nzuVYrGQHUWrb1IPjx\n4KlIwk9GieLbavDX8mOhpbAbDs9SzrOXuLcIj5bCRPoeyKAlWs0fcQMRzNGgaOwp\nEWf9f8Hy0BDk8LOu9+nw1oHptzr5ZwoXizWROqKkRw2pZuaa+fOMytrv81KwaBzf\nSYiHaRgUnZWooExufCF5MjBRDPH4igwQugYFZ587qdDwAFl39xZXPT3JCtxsCLDv\nt3Md6eTOqGHmoNORvkR8/zHLcfGtpMQ8jhBcuikK817fI69u61EPplA1yx69ZOM=\n=aO/S\n-----END PGP SIGNATURE-----\n",
      "payload": "tree 28e327f7363f26c6c946f06ad86f992f2bd7742a\nparent e47e0af123b43dfba622c3f984a3f7f68578c8ed\nauthor Roman Rizzi <rizziromanalejandro@gmail.com> 1563560278 -0300\ncommitter GitHub <noreply@github.com> 1563560278 -0300\n\nDEV: group_list site settings should store IDs instead of group names (#7860)\n\n* DEV: group_list site settings should store IDs instead of group names\r\n\r\n* Ship site setting to know when we should migrate group_list settings\r\n\r\n* Migrate existing group_list site settings\r\n\r\n* Bump migration timestamp and don't set null when migrating is not possible.\r\n"
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/eb26bee046c264602933f43d29c734a7e266928e",
  "html_url": "https://github.com/discourse/discourse/commit/eb26bee046c264602933f43d29c734a7e266928e",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/eb26bee046c264602933f43d29c734a7e266928e/comments",
  "author": {
    "login": "romanrizzi",
    "id": 5025816,
    "node_id": "MDQ6VXNlcjUwMjU4MTY=",
    "avatar_url": "https://avatars1.githubusercontent.com/u/5025816?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/romanrizzi",
    "html_url": "https://github.com/romanrizzi",
    "followers_url": "https://api.github.com/users/romanrizzi/followers",
    "following_url": "https://api.github.com/users/romanrizzi/following{/other_user}",
    "gists_url": "https://api.github.com/users/romanrizzi/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/romanrizzi/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/romanrizzi/subscriptions",
    "organizations_url": "https://api.github.com/users/romanrizzi/orgs",
    "repos_url": "https://api.github.com/users/romanrizzi/repos",
    "events_url": "https://api.github.com/users/romanrizzi/events{/privacy}",
    "received_events_url": "https://api.github.com/users/romanrizzi/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "e47e0af123b43dfba622c3f984a3f7f68578c8ed",
      "url": "https://api.github.com/repos/discourse/discourse/commits/e47e0af123b43dfba622c3f984a3f7f68578c8ed",
      "html_url": "https://github.com/discourse/discourse/commit/e47e0af123b43dfba622c3f984a3f7f68578c8ed"
    }
  ],
  "stats": {
    "total": 42,
    "additions": 35,
    "deletions": 7
  },
  "files": [
    {
      "sha": "0ab60a34361145e6d9f3bab1ebc2508dc069daf9",
      "filename": "app/assets/javascripts/admin/components/site-settings/group-list.js.es6",
      "status": "modified",
      "additions": 3,
      "deletions": 1,
      "changes": 4,
      "blob_url": "https://github.com/discourse/discourse/blob/eb26bee046c264602933f43d29c734a7e266928e/app/assets/javascripts/admin/components/site-settings/group-list.js.es6",
      "raw_url": "https://github.com/discourse/discourse/raw/eb26bee046c264602933f43d29c734a7e266928e/app/assets/javascripts/admin/components/site-settings/group-list.js.es6",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/assets/javascripts/admin/components/site-settings/group-list.js.es6?ref=eb26bee046c264602933f43d29c734a7e266928e",
      "patch": "@@ -3,6 +3,8 @@ import computed from \"ember-addons/ember-computed-decorators\";\n export default Ember.Component.extend({\n   @computed()\n   groupChoices() {\n-    return this.site.get(\"groups\").map(g => g.name);\n+    return this.site.get(\"groups\").map(g => {\n+      return { name: g.name, id: g.id.toString() };\n+    });\n   }\n });"
    },
    {
      "sha": "005f14398eefd0af637ecb717db3d65367ecfc62",
      "filename": "app/assets/javascripts/admin/templates/components/site-settings/group-list.hbs",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/discourse/discourse/blob/eb26bee046c264602933f43d29c734a7e266928e/app/assets/javascripts/admin/templates/components/site-settings/group-list.hbs",
      "raw_url": "https://github.com/discourse/discourse/raw/eb26bee046c264602933f43d29c734a7e266928e/app/assets/javascripts/admin/templates/components/site-settings/group-list.hbs",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/assets/javascripts/admin/templates/components/site-settings/group-list.hbs?ref=eb26bee046c264602933f43d29c734a7e266928e",
      "patch": "@@ -1,3 +1,3 @@\n-{{list-setting settingValue=value choices=groupChoices settingName=setting.setting}}\n+{{list-setting settingValue=value choices=groupChoices settingName='name'}}\n {{setting-validation-message message=validationMessage}}\n <div class='desc'>{{{unbound setting.description}}}</div>"
    },
    {
      "sha": "6a81fe17b0b2d291077b910b15439f44d9244a5f",
      "filename": "db/migrate/20190717133743_migrate_group_list_site_settings.rb",
      "status": "added",
      "additions": 27,
      "deletions": 0,
      "changes": 27,
      "blob_url": "https://github.com/discourse/discourse/blob/eb26bee046c264602933f43d29c734a7e266928e/db/migrate/20190717133743_migrate_group_list_site_settings.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/eb26bee046c264602933f43d29c734a7e266928e/db/migrate/20190717133743_migrate_group_list_site_settings.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/db/migrate/20190717133743_migrate_group_list_site_settings.rb?ref=eb26bee046c264602933f43d29c734a7e266928e",
      "patch": "@@ -0,0 +1,27 @@\n+# frozen_string_literal: true\n+\n+class MigrateGroupListSiteSettings < ActiveRecord::Migration[5.2]\n+  def up\n+    migrate_value(:name, :id)\n+  end\n+\n+  def down\n+    migrate_value(:id, :name)\n+  end\n+\n+  def migrate_value(from, to)\n+    cast_type = from == :id ? '::int[]' : ''\n+    DB.exec <<~SQL\n+      UPDATE site_settings\n+      SET value = COALESCE(array_to_string(\n+        (\n+          SELECT array_agg(groups.#{to})\n+          FROM groups\n+          WHERE groups.#{from} = ANY (string_to_array(site_settings.value, '|', '')#{cast_type})\n+        ),\n+        '|', ''\n+      ), site_settings.value)\n+      WHERE data_type = #{SiteSettings::TypeSupervisor.types[:group_list]}\n+    SQL\n+  end\n+end"
    },
    {
      "sha": "b7cf9a91c05f087c43ec2508cc8ca72c4267606b",
      "filename": "lib/discourse.rb",
      "status": "modified",
      "additions": 0,
      "deletions": 1,
      "changes": 1,
      "blob_url": "https://github.com/discourse/discourse/blob/eb26bee046c264602933f43d29c734a7e266928e/lib/discourse.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/eb26bee046c264602933f43d29c734a7e266928e/lib/discourse.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/lib/discourse.rb?ref=eb26bee046c264602933f43d29c734a7e266928e",
      "patch": "@@ -743,5 +743,4 @@ def self.running_in_rack?\n   def self.skip_post_deployment_migrations?\n     ['1', 'true'].include?(ENV[\"SKIP_POST_DEPLOYMENT_MIGRATIONS\"]&.to_s)\n   end\n-\n end"
    },
    {
      "sha": "f998ccbd0b0238c2b50a059366027fba0a0405d9",
      "filename": "test/javascripts/admin/components/group-list-setting-test.js.es6",
      "status": "modified",
      "additions": 4,
      "deletions": 4,
      "changes": 8,
      "blob_url": "https://github.com/discourse/discourse/blob/eb26bee046c264602933f43d29c734a7e266928e/test/javascripts/admin/components/group-list-setting-test.js.es6",
      "raw_url": "https://github.com/discourse/discourse/raw/eb26bee046c264602933f43d29c734a7e266928e/test/javascripts/admin/components/group-list-setting-test.js.es6",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/test/javascripts/admin/components/group-list-setting-test.js.es6?ref=eb26bee046c264602933f43d29c734a7e266928e",
      "patch": "@@ -32,7 +32,7 @@ componentTest(\"default\", {\n         setting: \"foo_bar\",\n         type: \"group_list\",\n         validValues: undefined,\n-        value: \"Donuts\"\n+        value: \"1\"\n       })\n     );\n   },\n@@ -42,16 +42,16 @@ componentTest(\"default\", {\n \n     assert.equal(\n       subject.header().value(),\n-      \"Donuts\",\n+      \"1\",\n       \"it selects the setting's value\"\n     );\n \n     await subject.expand();\n-    await subject.selectRowByValue(\"Cheese cake\");\n+    await subject.selectRowByValue(\"2\");\n \n     assert.equal(\n       subject.header().value(),\n-      \"Donuts,Cheese cake\",\n+      \"1,2\",\n       \"it allows to select a setting from the list of choices\"\n     );\n   }"
    }
  ]
}
