{
  "sha": "4b9d35cd0e6d2050f8103f9b5314fe43000f5e42",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODo0YjlkMzVjZDBlNmQyMDUwZjgxMDNmOWI1MzE0ZmU0MzAwMGY1ZTQy",
  "commit": {
    "author": {
      "name": "Neil Lalonde",
      "email": "neillalonde@gmail.com",
      "date": "2019-08-06T16:45:28Z"
    },
    "committer": {
      "name": "Neil Lalonde",
      "email": "neillalonde@gmail.com",
      "date": "2019-08-06T16:45:28Z"
    },
    "message": "FEATURE: add option to always send excerpts in emails\n\nEnable the new setting \"post excerpts in emails\" to send excerpts\ninstead of complete posts in notification emails. Control the length of\nexcerpts with the \"post excerpt maxlength\" setting.",
    "tree": {
      "sha": "536681a9db05b2b77b8967a7038640f256820b9c",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/536681a9db05b2b77b8967a7038640f256820b9c"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/4b9d35cd0e6d2050f8103f9b5314fe43000f5e42",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/4b9d35cd0e6d2050f8103f9b5314fe43000f5e42",
  "html_url": "https://github.com/discourse/discourse/commit/4b9d35cd0e6d2050f8103f9b5314fe43000f5e42",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/4b9d35cd0e6d2050f8103f9b5314fe43000f5e42/comments",
  "author": {
    "login": "nlalonde",
    "id": 151885,
    "node_id": "MDQ6VXNlcjE1MTg4NQ==",
    "avatar_url": "https://avatars2.githubusercontent.com/u/151885?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nlalonde",
    "html_url": "https://github.com/nlalonde",
    "followers_url": "https://api.github.com/users/nlalonde/followers",
    "following_url": "https://api.github.com/users/nlalonde/following{/other_user}",
    "gists_url": "https://api.github.com/users/nlalonde/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nlalonde/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nlalonde/subscriptions",
    "organizations_url": "https://api.github.com/users/nlalonde/orgs",
    "repos_url": "https://api.github.com/users/nlalonde/repos",
    "events_url": "https://api.github.com/users/nlalonde/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nlalonde/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "nlalonde",
    "id": 151885,
    "node_id": "MDQ6VXNlcjE1MTg4NQ==",
    "avatar_url": "https://avatars2.githubusercontent.com/u/151885?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nlalonde",
    "html_url": "https://github.com/nlalonde",
    "followers_url": "https://api.github.com/users/nlalonde/followers",
    "following_url": "https://api.github.com/users/nlalonde/following{/other_user}",
    "gists_url": "https://api.github.com/users/nlalonde/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nlalonde/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nlalonde/subscriptions",
    "organizations_url": "https://api.github.com/users/nlalonde/orgs",
    "repos_url": "https://api.github.com/users/nlalonde/repos",
    "events_url": "https://api.github.com/users/nlalonde/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nlalonde/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "a475c384d8c8ddfecfca121fb6ac2050ff7d7aa6",
      "url": "https://api.github.com/repos/discourse/discourse/commits/a475c384d8c8ddfecfca121fb6ac2050ff7d7aa6",
      "html_url": "https://github.com/discourse/discourse/commit/a475c384d8c8ddfecfca121fb6ac2050ff7d7aa6"
    }
  ],
  "stats": {
    "total": 23,
    "additions": 22,
    "deletions": 1
  },
  "files": [
    {
      "sha": "cc30418c062b7c58753bd5b0b2e0c8deaef0cfd6",
      "filename": "app/views/email/notification.html.erb",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/discourse/discourse/blob/4b9d35cd0e6d2050f8103f9b5314fe43000f5e42/app/views/email/notification.html.erb",
      "raw_url": "https://github.com/discourse/discourse/raw/4b9d35cd0e6d2050f8103f9b5314fe43000f5e42/app/views/email/notification.html.erb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/views/email/notification.html.erb?ref=4b9d35cd0e6d2050f8103f9b5314fe43000f5e42",
      "patch": "@@ -5,7 +5,7 @@\n   <%- if SiteSetting.private_email? %>\n     <p><%= t('system_messages.contents_hidden') %></p>\n   <% else %>\n-    <%= render partial: 'email/post', locals: { post: post, use_excerpt: false } %>\n+    <%= render partial: 'email/post', locals: { post: post, use_excerpt: SiteSetting.post_excerpts_in_emails } %>\n \n     <% if in_reply_to_post.present? || context_posts.present? %>\n       <div class='footer'>%{respond_instructions}</div>"
    },
    {
      "sha": "c40cdf9ee5a9aa61c99716734c23ab820c32f6bf",
      "filename": "config/locales/server.en.yml",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/discourse/discourse/blob/4b9d35cd0e6d2050f8103f9b5314fe43000f5e42/config/locales/server.en.yml",
      "raw_url": "https://github.com/discourse/discourse/raw/4b9d35cd0e6d2050f8103f9b5314fe43000f5e42/config/locales/server.en.yml",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/config/locales/server.en.yml?ref=4b9d35cd0e6d2050f8103f9b5314fe43000f5e42",
      "patch": "@@ -1815,6 +1815,7 @@ en:\n     always_show_trimmed_content: \"Always show trimmed part of incoming emails. WARNING: might reveal email addresses.\"\n     private_email: \"Don't include content from posts or topics in email title or email body. NOTE: also disables digest emails.\"\n     email_total_attachment_size_limit_kb: \"Max total size of files attached to outgoing emails. Set to 0 to disable sending of attachments.\"\n+    post_excerpts_in_emails: \"In notification emails, always send excerpts instead of full posts\"\n \n     manual_polling_enabled: \"Push emails using the API for email replies.\"\n     pop3_polling_enabled: \"Poll via POP3 for email replies.\""
    },
    {
      "sha": "ad28491b7d90d51664fc934d4d22e6480bc6495b",
      "filename": "config/site_settings.yml",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/discourse/discourse/blob/4b9d35cd0e6d2050f8103f9b5314fe43000f5e42/config/site_settings.yml",
      "raw_url": "https://github.com/discourse/discourse/raw/4b9d35cd0e6d2050f8103f9b5314fe43000f5e42/config/site_settings.yml",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/config/site_settings.yml?ref=4b9d35cd0e6d2050f8103f9b5314fe43000f5e42",
      "patch": "@@ -1034,6 +1034,7 @@ email:\n   email_total_attachment_size_limit_kb:\n     default: 0\n     max: 51200\n+  post_excerpts_in_emails: false\n \n files:\n   max_image_size_kb:"
    },
    {
      "sha": "420655b2ac25dd035f139d66300965c6f51a30b8",
      "filename": "spec/mailers/user_notifications_spec.rb",
      "status": "modified",
      "additions": 19,
      "deletions": 0,
      "changes": 19,
      "blob_url": "https://github.com/discourse/discourse/blob/4b9d35cd0e6d2050f8103f9b5314fe43000f5e42/spec/mailers/user_notifications_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/4b9d35cd0e6d2050f8103f9b5314fe43000f5e42/spec/mailers/user_notifications_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/mailers/user_notifications_spec.rb?ref=4b9d35cd0e6d2050f8103f9b5314fe43000f5e42",
      "patch": "@@ -336,6 +336,25 @@\n       expect(mail.text_part.to_s).to_not include(response.raw)\n       expect(mail.text_part.to_s).to_not include(topic.url)\n     end\n+\n+    it \"includes excerpt when post_excerpts_in_emails is enabled\" do\n+      paragraphs = [\n+        \"This is the first paragraph, but you should read more.\",\n+        \"And here is its friend, the second paragraph.\"\n+      ]\n+      SiteSetting.post_excerpts_in_emails = true\n+      SiteSetting.post_excerpt_maxlength = paragraphs.first.length\n+      response.update_attributes!(raw: paragraphs.join(\"\\n\\n\"))\n+      mail = UserNotifications.user_replied(\n+        user,\n+        post: response,\n+        notification_type: notification.notification_type,\n+        notification_data_hash: notification.data_hash\n+      )\n+      mail_html = mail.html_part.body.to_s\n+      expect(mail_html.scan(/#{paragraphs[0]}/).count).to eq(1)\n+      expect(mail_html.scan(/#{paragraphs[1]}/).count).to eq(0)\n+    end\n   end\n \n   describe '.user_posted' do"
    }
  ]
}
