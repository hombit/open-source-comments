{
  "sha": "b500ef77d78f76e34216f1367e58482a8c957270",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODpiNTAwZWY3N2Q3OGY3NmUzNDIxNmYxMzY3ZTU4NDgyYThjOTU3Mjcw",
  "commit": {
    "author": {
      "name": "Eduardo Poleo",
      "email": "eduardopoleo@gmail.com",
      "date": "2019-08-08T16:48:53Z"
    },
    "committer": {
      "name": "RÃ©gis Hanol",
      "email": "regis@hanol.fr",
      "date": "2019-08-08T16:48:53Z"
    },
    "message": "Poll migration is not idempotent (#7964)\n\nThe migration script is not idempotent due to database constrains on the\r\npoll related objects, namely:\r\n\r\npolls: index_polls_on_post_id_and_name (post_id,name) UNIQUE\r\npoll_options: index_poll_options_on_poll_id_and_digest  (poll_id,digest) UNIQUE\r\npoll_votes:  index_poll_votes_on_poll_id_and_poll_option_id_and_user_id  (poll_id,poll_option_id,user_id) UNIQUE\r\n\r\nThis change skips a particular poll migration if it's already found on\r\nthe db.",
    "tree": {
      "sha": "6d60b4ab5ed133a848e9717972431c27e68ecf31",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/6d60b4ab5ed133a848e9717972431c27e68ecf31"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/b500ef77d78f76e34216f1367e58482a8c957270",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/b500ef77d78f76e34216f1367e58482a8c957270",
  "html_url": "https://github.com/discourse/discourse/commit/b500ef77d78f76e34216f1367e58482a8c957270",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/b500ef77d78f76e34216f1367e58482a8c957270/comments",
  "author": {
    "login": "eduardopoleo",
    "id": 6976960,
    "node_id": "MDQ6VXNlcjY5NzY5NjA=",
    "avatar_url": "https://avatars2.githubusercontent.com/u/6976960?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/eduardopoleo",
    "html_url": "https://github.com/eduardopoleo",
    "followers_url": "https://api.github.com/users/eduardopoleo/followers",
    "following_url": "https://api.github.com/users/eduardopoleo/following{/other_user}",
    "gists_url": "https://api.github.com/users/eduardopoleo/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/eduardopoleo/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/eduardopoleo/subscriptions",
    "organizations_url": "https://api.github.com/users/eduardopoleo/orgs",
    "repos_url": "https://api.github.com/users/eduardopoleo/repos",
    "events_url": "https://api.github.com/users/eduardopoleo/events{/privacy}",
    "received_events_url": "https://api.github.com/users/eduardopoleo/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "ZogStriP",
    "id": 362783,
    "node_id": "MDQ6VXNlcjM2Mjc4Mw==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/362783?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ZogStriP",
    "html_url": "https://github.com/ZogStriP",
    "followers_url": "https://api.github.com/users/ZogStriP/followers",
    "following_url": "https://api.github.com/users/ZogStriP/following{/other_user}",
    "gists_url": "https://api.github.com/users/ZogStriP/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ZogStriP/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ZogStriP/subscriptions",
    "organizations_url": "https://api.github.com/users/ZogStriP/orgs",
    "repos_url": "https://api.github.com/users/ZogStriP/repos",
    "events_url": "https://api.github.com/users/ZogStriP/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ZogStriP/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "7c83d2eeb261ac676a8320e6a704752c56fd242e",
      "url": "https://api.github.com/repos/discourse/discourse/commits/7c83d2eeb261ac676a8320e6a704752c56fd242e",
      "html_url": "https://github.com/discourse/discourse/commit/7c83d2eeb261ac676a8320e6a704752c56fd242e"
    }
  ],
  "stats": {
    "total": 2,
    "additions": 2,
    "deletions": 0
  },
  "files": [
    {
      "sha": "047164f4a517c639b9279b9e0e3a6b4cf7dbfecc",
      "filename": "plugins/poll/db/post_migrate/20180820080623_migrate_polls_data.rb",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/discourse/discourse/blob/b500ef77d78f76e34216f1367e58482a8c957270/plugins/poll/db/post_migrate/20180820080623_migrate_polls_data.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/b500ef77d78f76e34216f1367e58482a8c957270/plugins/poll/db/post_migrate/20180820080623_migrate_polls_data.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/plugins/poll/db/post_migrate/20180820080623_migrate_polls_data.rb?ref=b500ef77d78f76e34216f1367e58482a8c957270",
      "patch": "@@ -95,6 +95,8 @@ def up\n         step = poll[\"step\"].to_i.clamp(0, max)\n         anonymous_voters = poll[\"anonymous_voters\"].to_i.clamp(0, PG_INTEGER_MAX)\n \n+        next if Poll.exists?(post_id: r.post_id, name: escape(name))\n+\n         poll_id = execute(<<~SQL\n           INSERT INTO polls (\n             post_id,"
    }
  ]
}
