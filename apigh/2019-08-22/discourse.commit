{
  "sha": "34a76bf106b54d5b4df97c36d19c6175c782da9b",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODozNGE3NmJmMTA2YjU0ZDViNGRmOTdjMzZkMTljNjE3NWM3ODJkYTli",
  "commit": {
    "author": {
      "name": "Dan Ungureanu",
      "email": "dan@ungureanu.me",
      "date": "2019-08-22T15:42:45Z"
    },
    "committer": {
      "name": "RÃ©gis Hanol",
      "email": "regis@hanol.fr",
      "date": "2019-08-22T15:42:45Z"
    },
    "message": "FIX: Do not set destination_url cookie after deleting own account. (#8028)\n\ndestination_url cookie is used to redirect the user to the a private\r\npage after they have logged in. After deleting own account, a user's\r\npages would be refreshed which would set the destination_url, cookie\r\nthat can cause a redirect to an invalid page after logging in again.\r\n\r\nReproduction steps:\r\n\r\n1. User is at `/u/:username/preferences/account` and deletes account by\r\nrequesting DELETE `/u/:username.json`.\r\n\r\n2. User is being destroyed and a MessageBus message (`file-change`,\r\n`['refresh']`) is published.\r\n\r\n3. User receives response to DELETE request, but page may be or not\r\nrefreshed. Anyway, since they can no longer see the preferences page,\r\nthey are redirected to `/login` and `destination_url` cookie is set,\r\nthat will redirect on next login (but to the previous preferences page).",
    "tree": {
      "sha": "fceffea31b4312fa1374a5e53abcd5a9cdfc651a",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/fceffea31b4312fa1374a5e53abcd5a9cdfc651a"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/34a76bf106b54d5b4df97c36d19c6175c782da9b",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/34a76bf106b54d5b4df97c36d19c6175c782da9b",
  "html_url": "https://github.com/discourse/discourse/commit/34a76bf106b54d5b4df97c36d19c6175c782da9b",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/34a76bf106b54d5b4df97c36d19c6175c782da9b/comments",
  "author": {
    "login": "udan11",
    "id": 4147664,
    "node_id": "MDQ6VXNlcjQxNDc2NjQ=",
    "avatar_url": "https://avatars1.githubusercontent.com/u/4147664?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/udan11",
    "html_url": "https://github.com/udan11",
    "followers_url": "https://api.github.com/users/udan11/followers",
    "following_url": "https://api.github.com/users/udan11/following{/other_user}",
    "gists_url": "https://api.github.com/users/udan11/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/udan11/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/udan11/subscriptions",
    "organizations_url": "https://api.github.com/users/udan11/orgs",
    "repos_url": "https://api.github.com/users/udan11/repos",
    "events_url": "https://api.github.com/users/udan11/events{/privacy}",
    "received_events_url": "https://api.github.com/users/udan11/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "ZogStriP",
    "id": 362783,
    "node_id": "MDQ6VXNlcjM2Mjc4Mw==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/362783?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ZogStriP",
    "html_url": "https://github.com/ZogStriP",
    "followers_url": "https://api.github.com/users/ZogStriP/followers",
    "following_url": "https://api.github.com/users/ZogStriP/following{/other_user}",
    "gists_url": "https://api.github.com/users/ZogStriP/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ZogStriP/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ZogStriP/subscriptions",
    "organizations_url": "https://api.github.com/users/ZogStriP/orgs",
    "repos_url": "https://api.github.com/users/ZogStriP/repos",
    "events_url": "https://api.github.com/users/ZogStriP/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ZogStriP/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "e94f67e2da7c08780329544c7989c5efee8fd875",
      "url": "https://api.github.com/repos/discourse/discourse/commits/e94f67e2da7c08780329544c7989c5efee8fd875",
      "html_url": "https://github.com/discourse/discourse/commit/e94f67e2da7c08780329544c7989c5efee8fd875"
    }
  ],
  "stats": {
    "total": 2,
    "additions": 1,
    "deletions": 1
  },
  "files": [
    {
      "sha": "bc3c1e3aac19251eb4b3e0abf1dc00be5b584662",
      "filename": "app/services/user_destroyer.rb",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/discourse/discourse/blob/34a76bf106b54d5b4df97c36d19c6175c782da9b/app/services/user_destroyer.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/34a76bf106b54d5b4df97c36d19c6175c782da9b/app/services/user_destroyer.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/services/user_destroyer.rb?ref=34a76bf106b54d5b4df97c36d19c6175c782da9b",
      "patch": "@@ -111,7 +111,7 @@ def destroy(user, opts = {})\n           end\n           StaffActionLogger.new(deleted_by).log_user_deletion(user, opts.slice(:context))\n         end\n-        MessageBus.publish \"/file-change\", [\"refresh\"], user_ids: [result.id]\n+        MessageBus.publish \"/logout\", result.id, user_ids: [result.id]\n       end\n     end\n "
    }
  ]
}
