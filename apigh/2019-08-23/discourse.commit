{
  "sha": "39c31a3d7693fae488461079c6f0c2bc7305c02e",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODozOWMzMWEzZDc2OTNmYWU0ODg0NjEwNzljNmYwYzJiYzczMDVjMDJl",
  "commit": {
    "author": {
      "name": "Rafael dos Santos Silva",
      "email": "xfalcox@gmail.com",
      "date": "2019-08-23T14:52:47Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2019-08-23T14:52:47Z"
    },
    "message": "FEATURE: Protect against replay attacks when using TLS 1.3 0-RTT (#8020)",
    "tree": {
      "sha": "6f57ec95dda854b62b653bd375cda76d67cc4f1f",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/6f57ec95dda854b62b653bd375cda76d67cc4f1f"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/39c31a3d7693fae488461079c6f0c2bc7305c02e",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdX/2/CRBK7hj4Ov3rIwAAdHIIADNklKEfSM6QLXpzRcnnIlRA\nobfsgVwnvN9mddiaeE9T/jZmJ1VXdcJWfXpuO41SfdH8NnkZpvCYH0bGfXpzQI7/\nRlY8Quw2TgVwVP4vPoByDbs77LZ2xq/dyhTLHW1Bj5xbzbhqaTVGmIS5AUdJDLKw\nTBaOVzbgzZIkXzr6K0jaY/0Vvi4M2xxK1Lhc6VO5Jqwn0/SZrOB7cUhs3taTz3AE\nfGqX/KizarHiLNcNPP/YT0hcnbf/uQHXt9U8ZFGyz85uZjmfO3uxnSf9ohboeu/+\nRiAK9Tzj/IfkzhVZAfebSO308qXFNXg6Rt5M+YQcNbp0Yn7D9nnctA7VZbW9q2c=\n=bhth\n-----END PGP SIGNATURE-----\n",
      "payload": "tree 6f57ec95dda854b62b653bd375cda76d67cc4f1f\nparent 171618e7d6bc173c06ecbe246cb89b665da53a3c\nauthor Rafael dos Santos Silva <xfalcox@gmail.com> 1566571967 -0300\ncommitter GitHub <noreply@github.com> 1566571967 -0300\n\nFEATURE: Protect against replay attacks when using TLS 1.3 0-RTT (#8020)\n\n"
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/39c31a3d7693fae488461079c6f0c2bc7305c02e",
  "html_url": "https://github.com/discourse/discourse/commit/39c31a3d7693fae488461079c6f0c2bc7305c02e",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/39c31a3d7693fae488461079c6f0c2bc7305c02e/comments",
  "author": {
    "login": "xfalcox",
    "id": 1385470,
    "node_id": "MDQ6VXNlcjEzODU0NzA=",
    "avatar_url": "https://avatars3.githubusercontent.com/u/1385470?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/xfalcox",
    "html_url": "https://github.com/xfalcox",
    "followers_url": "https://api.github.com/users/xfalcox/followers",
    "following_url": "https://api.github.com/users/xfalcox/following{/other_user}",
    "gists_url": "https://api.github.com/users/xfalcox/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/xfalcox/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/xfalcox/subscriptions",
    "organizations_url": "https://api.github.com/users/xfalcox/orgs",
    "repos_url": "https://api.github.com/users/xfalcox/repos",
    "events_url": "https://api.github.com/users/xfalcox/events{/privacy}",
    "received_events_url": "https://api.github.com/users/xfalcox/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "171618e7d6bc173c06ecbe246cb89b665da53a3c",
      "url": "https://api.github.com/repos/discourse/discourse/commits/171618e7d6bc173c06ecbe246cb89b665da53a3c",
      "html_url": "https://github.com/discourse/discourse/commit/171618e7d6bc173c06ecbe246cb89b665da53a3c"
    }
  ],
  "stats": {
    "total": 30,
    "additions": 30,
    "deletions": 0
  },
  "files": [
    {
      "sha": "cef1abf66464ff48fdd6796525337d455dd6d832",
      "filename": "config/application.rb",
      "status": "modified",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "blob_url": "https://github.com/discourse/discourse/blob/39c31a3d7693fae488461079c6f0c2bc7305c02e/config/application.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/39c31a3d7693fae488461079c6f0c2bc7305c02e/config/application.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/config/application.rb?ref=39c31a3d7693fae488461079c6f0c2bc7305c02e",
      "patch": "@@ -214,6 +214,9 @@ def config.database_configuration\n     config.middleware.delete Rack::ETag\n \n     unless Rails.env.development?\n+      require 'middleware/early_data_check'\n+      config.middleware.insert_after Rack::MethodOverride, Middleware::EarlyDataCheck\n+\n       require 'middleware/enforce_hostname'\n       config.middleware.insert_after Rack::MethodOverride, Middleware::EnforceHostname\n     end"
    },
    {
      "sha": "dd3ced6995a68dfc028e3059095aa0d1995e48e2",
      "filename": "lib/middleware/early_data_check.rb",
      "status": "added",
      "additions": 27,
      "deletions": 0,
      "changes": 27,
      "blob_url": "https://github.com/discourse/discourse/blob/39c31a3d7693fae488461079c6f0c2bc7305c02e/lib/middleware/early_data_check.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/39c31a3d7693fae488461079c6f0c2bc7305c02e/lib/middleware/early_data_check.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/lib/middleware/early_data_check.rb?ref=39c31a3d7693fae488461079c6f0c2bc7305c02e",
      "patch": "@@ -0,0 +1,27 @@\n+# frozen_string_literal: true\n+\n+module Middleware\n+  class EarlyDataCheck\n+    def initialize(app, settings = nil)\n+      @app = app\n+    end\n+\n+    # When a new connection happens, and it uses TLS 1.3 0-RTT\n+    # the reverse proxy will set the header `Early-Data` to 1.\n+    # Due to 0-RTT susceptibility to Replay Attacks only GET\n+    # requests for anonymous users are allowed.\n+    # Reference: https://tools.ietf.org/html/rfc8446#appendix-E.5\n+    def call(env)\n+      if env['HTTP_EARLY_DATA'].to_s == '1' &&\n+         (env['REQUEST_METHOD'] != 'GET' || CurrentUser.has_auth_cookie?(env))\n+        [\n+          425,\n+          { 'Content-Type' => 'text/html', 'Content-Length' => '9' },\n+          ['Too Early']\n+        ]\n+      else\n+        @app.call(env)\n+      end\n+    end\n+  end\n+end"
    }
  ]
}
