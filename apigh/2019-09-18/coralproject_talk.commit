{
  "sha": "741739bc169a15f37d6bd2e9485c8e95dc7262a4",
  "node_id": "MDY6Q29tbWl0NzI0NTQyNDI6NzQxNzM5YmMxNjlhMTVmMzdkNmJkMmU5NDg1YzhlOTVkYzcyNjJhNA==",
  "commit": {
    "author": {
      "name": "Nick Funk",
      "email": "nick.funk@outlook.com",
      "date": "2019-09-18T16:17:32Z"
    },
    "committer": {
      "name": "Kim Gardner",
      "email": "kgardnr@gmail.com",
      "date": "2019-09-18T16:17:31Z"
    },
    "message": "Un-feature a comment when it is rejected (#2555)\n\nAlso decrements the featured count for the story if rejected using the\r\nin-stream moderation.\r\n\r\nCORL-554",
    "tree": {
      "sha": "22c19016272a0fc0bcc8a93c060eddc1e28d0c1d",
      "url": "https://api.github.com/repos/coralproject/talk/git/trees/22c19016272a0fc0bcc8a93c060eddc1e28d0c1d"
    },
    "url": "https://api.github.com/repos/coralproject/talk/git/commits/741739bc169a15f37d6bd2e9485c8e95dc7262a4",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/coralproject/talk/commits/741739bc169a15f37d6bd2e9485c8e95dc7262a4",
  "html_url": "https://github.com/coralproject/talk/commit/741739bc169a15f37d6bd2e9485c8e95dc7262a4",
  "comments_url": "https://api.github.com/repos/coralproject/talk/commits/741739bc169a15f37d6bd2e9485c8e95dc7262a4/comments",
  "author": {
    "login": "nick-funk",
    "id": 5751504,
    "node_id": "MDQ6VXNlcjU3NTE1MDQ=",
    "avatar_url": "https://avatars2.githubusercontent.com/u/5751504?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nick-funk",
    "html_url": "https://github.com/nick-funk",
    "followers_url": "https://api.github.com/users/nick-funk/followers",
    "following_url": "https://api.github.com/users/nick-funk/following{/other_user}",
    "gists_url": "https://api.github.com/users/nick-funk/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nick-funk/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nick-funk/subscriptions",
    "organizations_url": "https://api.github.com/users/nick-funk/orgs",
    "repos_url": "https://api.github.com/users/nick-funk/repos",
    "events_url": "https://api.github.com/users/nick-funk/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nick-funk/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "kgardnr",
    "id": 1077300,
    "node_id": "MDQ6VXNlcjEwNzczMDA=",
    "avatar_url": "https://avatars2.githubusercontent.com/u/1077300?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/kgardnr",
    "html_url": "https://github.com/kgardnr",
    "followers_url": "https://api.github.com/users/kgardnr/followers",
    "following_url": "https://api.github.com/users/kgardnr/following{/other_user}",
    "gists_url": "https://api.github.com/users/kgardnr/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/kgardnr/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kgardnr/subscriptions",
    "organizations_url": "https://api.github.com/users/kgardnr/orgs",
    "repos_url": "https://api.github.com/users/kgardnr/repos",
    "events_url": "https://api.github.com/users/kgardnr/events{/privacy}",
    "received_events_url": "https://api.github.com/users/kgardnr/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "2cc32d43320d48bd7afe627fdf2002b09d79b640",
      "url": "https://api.github.com/repos/coralproject/talk/commits/2cc32d43320d48bd7afe627fdf2002b09d79b640",
      "html_url": "https://github.com/coralproject/talk/commit/2cc32d43320d48bd7afe627fdf2002b09d79b640"
    }
  ],
  "stats": {
    "total": 103,
    "additions": 87,
    "deletions": 16
  },
  "files": [
    {
      "sha": "c2f8d79de16517a257d3771be4c6401cc5d88635",
      "filename": "src/core/client/stream/tabs/Comments/Comment/ModerationDropdown/ModerationActionsContainer.tsx",
      "status": "modified",
      "additions": 7,
      "deletions": 3,
      "changes": 10,
      "blob_url": "https://github.com/coralproject/talk/blob/741739bc169a15f37d6bd2e9485c8e95dc7262a4/src/core/client/stream/tabs/Comments/Comment/ModerationDropdown/ModerationActionsContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/741739bc169a15f37d6bd2e9485c8e95dc7262a4/src/core/client/stream/tabs/Comments/Comment/ModerationDropdown/ModerationActionsContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/stream/tabs/Comments/Comment/ModerationDropdown/ModerationActionsContainer.tsx?ref=741739bc169a15f37d6bd2e9485c8e95dc7262a4",
      "patch": "@@ -44,12 +44,16 @@ const ModerationActionsContainer: FunctionComponent<Props> = ({\n     }\n     approve({ commentID: comment.id, commentRevisionID: comment.revision.id });\n   }, [approve, comment]);\n-  const onReject = useCallback(() => {\n+  const onReject = useCallback(async () => {\n     if (!comment.revision) {\n       return;\n     }\n-    reject({ commentID: comment.id, commentRevisionID: comment.revision.id });\n-  }, [approve, comment]);\n+    await reject({\n+      commentID: comment.id,\n+      commentRevisionID: comment.revision.id,\n+      storyID: story.id,\n+    });\n+  }, [approve, comment, story]);\n   const onFeature = useCallback(() => {\n     if (!comment.revision) {\n       return;"
    },
    {
      "sha": "bcccaa9a69893bb5a5078835a7170b3afbd2d7a4",
      "filename": "src/core/client/stream/tabs/Comments/Comment/ModerationDropdown/ModerationDropdownContainer.tsx",
      "status": "modified",
      "additions": 6,
      "deletions": 1,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/741739bc169a15f37d6bd2e9485c8e95dc7262a4/src/core/client/stream/tabs/Comments/Comment/ModerationDropdown/ModerationDropdownContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/741739bc169a15f37d6bd2e9485c8e95dc7262a4/src/core/client/stream/tabs/Comments/Comment/ModerationDropdown/ModerationDropdownContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/stream/tabs/Comments/Comment/ModerationDropdown/ModerationDropdownContainer.tsx?ref=741739bc169a15f37d6bd2e9485c8e95dc7262a4",
      "patch": "@@ -47,7 +47,11 @@ const ModerationDropdownContainer: FunctionComponent<Props> = ({\n           />\n         </Dropdown>\n       ) : (\n-        <UserBanPopoverContainer comment={comment} onDismiss={onDismiss} />\n+        <UserBanPopoverContainer\n+          comment={comment}\n+          story={story}\n+          onDismiss={onDismiss}\n+        />\n       )}\n     </div>\n   );\n@@ -76,6 +80,7 @@ const enhanced = withFragmentContainer<Props>({\n     fragment ModerationDropdownContainer_story on Story {\n       id\n       ...ModerationActionsContainer_story\n+      ...UserBanPopoverContainer_story\n     }\n   `,\n   viewer: graphql`"
    },
    {
      "sha": "7c3abe602cd1d287c3d312475dbcf0eba6e3fa91",
      "filename": "src/core/client/stream/tabs/Comments/Comment/ModerationDropdown/RejectCommentMutation.ts",
      "status": "modified",
      "additions": 28,
      "deletions": 7,
      "changes": 35,
      "blob_url": "https://github.com/coralproject/talk/blob/741739bc169a15f37d6bd2e9485c8e95dc7262a4/src/core/client/stream/tabs/Comments/Comment/ModerationDropdown/RejectCommentMutation.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/741739bc169a15f37d6bd2e9485c8e95dc7262a4/src/core/client/stream/tabs/Comments/Comment/ModerationDropdown/RejectCommentMutation.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/stream/tabs/Comments/Comment/ModerationDropdown/RejectCommentMutation.ts?ref=741739bc169a15f37d6bd2e9485c8e95dc7262a4",
      "patch": "@@ -13,33 +13,54 @@ let clientMutationId = 0;\n \n const RejectCommentMutation = createMutation(\n   \"rejectComment\",\n-  (environment: Environment, input: MutationInput<MutationTypes>) =>\n+  (\n+    environment: Environment,\n+    input: MutationInput<MutationTypes> & { storyID: string }\n+  ) =>\n     commitMutationPromiseNormalized<MutationTypes>(environment, {\n       mutation: graphql`\n         mutation RejectCommentMutation($input: RejectCommentInput!) {\n           rejectComment(input: $input) {\n             comment {\n               status\n+              tags {\n+                code\n+              }\n+              story {\n+                commentCounts {\n+                  tags {\n+                    FEATURED\n+                  }\n+                }\n+              }\n             }\n             clientMutationId\n           }\n         }\n       `,\n+      variables: {\n+        input: {\n+          commentID: input.commentID,\n+          commentRevisionID: input.commentRevisionID,\n+          clientMutationId: (clientMutationId++).toString(),\n+        },\n+      },\n       optimisticResponse: {\n         rejectComment: {\n           comment: {\n             id: input.commentID,\n             status: GQLCOMMENT_STATUS.REJECTED,\n+            story: {\n+              commentCounts: {\n+                tags: {\n+                  FEATURED: 0,\n+                },\n+              },\n+            },\n           },\n           clientMutationId: clientMutationId.toString(),\n         },\n       },\n-      variables: {\n-        input: {\n-          ...input,\n-          clientMutationId: (clientMutationId++).toString(),\n-        },\n-      },\n       updater: store => {\n         store.get(input.commentID)!.setValue(\"REJECT\", \"lastViewerAction\");\n       },"
    },
    {
      "sha": "d34bf90cce9edf841629e69e31759529d6ef2fb7",
      "filename": "src/core/client/stream/tabs/Comments/Comment/UserBanPopover/UserBanPopoverContainer.tsx",
      "status": "modified",
      "additions": 14,
      "deletions": 2,
      "changes": 16,
      "blob_url": "https://github.com/coralproject/talk/blob/741739bc169a15f37d6bd2e9485c8e95dc7262a4/src/core/client/stream/tabs/Comments/Comment/UserBanPopover/UserBanPopoverContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/741739bc169a15f37d6bd2e9485c8e95dc7262a4/src/core/client/stream/tabs/Comments/Comment/UserBanPopover/UserBanPopoverContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/stream/tabs/Comments/Comment/UserBanPopover/UserBanPopoverContainer.tsx?ref=741739bc169a15f37d6bd2e9485c8e95dc7262a4",
      "patch": "@@ -7,6 +7,7 @@ import { useCoralContext } from \"coral-framework/lib/bootstrap\";\n import { getMessage } from \"coral-framework/lib/i18n\";\n import { useMutation, withFragmentContainer } from \"coral-framework/lib/relay\";\n import { UserBanPopoverContainer_comment } from \"coral-stream/__generated__/UserBanPopoverContainer_comment.graphql\";\n+import { UserBanPopoverContainer_story } from \"coral-stream/__generated__/UserBanPopoverContainer_story.graphql\";\n import CLASSES from \"coral-stream/classes\";\n import { Box, Button, Flex, Typography } from \"coral-ui/components\";\n \n@@ -18,10 +19,12 @@ import styles from \"./UserBanPopoverContainer.css\";\n interface Props {\n   onDismiss: () => void;\n   comment: UserBanPopoverContainer_comment;\n+  story: UserBanPopoverContainer_story;\n }\n \n const UserBanPopoverContainer: FunctionComponent<Props> = ({\n   comment,\n+  story,\n   onDismiss,\n }) => {\n   const user = comment.author!;\n@@ -41,10 +44,14 @@ const UserBanPopoverContainer: FunctionComponent<Props> = ({\n       ),\n     });\n     if (!rejected && comment.revision) {\n-      reject({ commentID: comment.id, commentRevisionID: comment.revision.id });\n+      reject({\n+        commentID: comment.id,\n+        commentRevisionID: comment.revision.id,\n+        storyID: story.id,\n+      });\n     }\n     onDismiss();\n-  }, [user, banUser, onDismiss, localeBundles]);\n+  }, [user, banUser, onDismiss, localeBundles, comment, story]);\n   return (\n     <Box className={cn(styles.root, CLASSES.banUserPopover.$root)} p={3}>\n       <Localized id=\"comments-userBanPopover-title\" $username={user.username}>\n@@ -98,6 +105,11 @@ const enhanced = withFragmentContainer<Props>({\n       }\n     }\n   `,\n+  story: graphql`\n+    fragment UserBanPopoverContainer_story on Story {\n+      id\n+    }\n+  `,\n })(UserBanPopoverContainer);\n \n export default enhanced;"
    },
    {
      "sha": "ebe46f16a8841faf88ccc62430cb3a453427f6e5",
      "filename": "src/core/client/stream/test/comments/stream/moderation.spec.tsx",
      "status": "modified",
      "additions": 13,
      "deletions": 1,
      "changes": 14,
      "blob_url": "https://github.com/coralproject/talk/blob/741739bc169a15f37d6bd2e9485c8e95dc7262a4/src/core/client/stream/test/comments/stream/moderation.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/741739bc169a15f37d6bd2e9485c8e95dc7262a4/src/core/client/stream/test/comments/stream/moderation.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/stream/test/comments/stream/moderation.spec.tsx?ref=741739bc169a15f37d6bd2e9485c8e95dc7262a4",
      "patch": "@@ -12,7 +12,18 @@ import {\n import { featuredTag, moderators, settings, stories } from \"../../fixtures\";\n import create from \"./create\";\n \n-const story = stories[0];\n+function createStory() {\n+  const base = stories[0];\n+\n+  for (const edge of base.comments.edges) {\n+    const node = edge.node;\n+    node.story = base;\n+  }\n+\n+  return base;\n+}\n+\n+const story = createStory();\n const firstComment = story.comments.edges[0].node;\n const viewer = moderators[0];\n \n@@ -33,6 +44,7 @@ async function createTestRenderer(\n     ),\n     initLocalState: (localRecord, source, environment) => {\n       localRecord.setValue(story.id, \"storyID\");\n+\n       if (params.initLocalState) {\n         params.initLocalState(localRecord, source, environment);\n       }"
    },
    {
      "sha": "fd63c3acc9c7c3023404f125b9f94ddb07445e4b",
      "filename": "src/core/server/graph/tenant/mutators/Actions.ts",
      "status": "modified",
      "additions": 11,
      "deletions": 1,
      "changes": 12,
      "blob_url": "https://github.com/coralproject/talk/blob/741739bc169a15f37d6bd2e9485c8e95dc7262a4/src/core/server/graph/tenant/mutators/Actions.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/741739bc169a15f37d6bd2e9485c8e95dc7262a4/src/core/server/graph/tenant/mutators/Actions.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/tenant/mutators/Actions.ts?ref=741739bc169a15f37d6bd2e9485c8e95dc7262a4",
      "patch": "@@ -1,8 +1,11 @@\n import TenantContext from \"coral-server/graph/tenant/context\";\n+import { hasTag } from \"coral-server/models/comment\";\n+import { removeTag } from \"coral-server/services/comments\";\n import { approve, reject } from \"coral-server/services/comments/moderation\";\n import {\n   GQLApproveCommentInput,\n   GQLRejectCommentInput,\n+  GQLTAG,\n } from \"../schema/__generated__/types\";\n \n export const Actions = (ctx: TenantContext) => ({\n@@ -17,5 +20,12 @@ export const Actions = (ctx: TenantContext) => ({\n       commentID: input.commentID,\n       commentRevisionID: input.commentRevisionID,\n       moderatorID: ctx.user!.id,\n-    }),\n+    }).then(comment =>\n+      // if a comment was previously featured\n+      // and is now rejected, we need to remove the\n+      // featured tag\n+      hasTag(comment, GQLTAG.FEATURED)\n+        ? removeTag(ctx.mongo, ctx.tenant, comment.id, GQLTAG.FEATURED)\n+        : comment\n+    ),\n });"
    },
    {
      "sha": "46d13adbaa3ce042125a91e8bfff345f5408bf38",
      "filename": "src/core/server/models/comment/helpers.ts",
      "status": "modified",
      "additions": 8,
      "deletions": 1,
      "changes": 9,
      "blob_url": "https://github.com/coralproject/talk/blob/741739bc169a15f37d6bd2e9485c8e95dc7262a4/src/core/server/models/comment/helpers.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/741739bc169a15f37d6bd2e9485c8e95dc7262a4/src/core/server/models/comment/helpers.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/comment/helpers.ts?ref=741739bc169a15f37d6bd2e9485c8e95dc7262a4",
      "patch": "@@ -1,4 +1,7 @@\n-import { GQLCOMMENT_STATUS } from \"coral-server/graph/tenant/schema/__generated__/types\";\n+import {\n+  GQLCOMMENT_STATUS,\n+  GQLTAG,\n+} from \"coral-server/graph/tenant/schema/__generated__/types\";\n \n import { Comment } from \"./comment\";\n import { MODERATOR_STATUSES, PUBLISHED_STATUSES } from \"./constants\";\n@@ -73,3 +76,7 @@ export function calculateRejectionRate(counts: CommentStatusCounts): number {\n \n   return rejected / (published + rejected);\n }\n+\n+export function hasTag(comment: Pick<Comment, \"tags\">, tag: GQLTAG) {\n+  return comment.tags.some(v => v.type === tag);\n+}"
    }
  ]
}
