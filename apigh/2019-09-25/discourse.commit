{
  "sha": "02731ef33ef53acd3ad013b3ab29f6286eed8b9d",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODowMjczMWVmMzNlZjUzYWNkM2FkMDEzYjNhYjI5ZjYyODZlZWQ4Yjlk",
  "commit": {
    "author": {
      "name": "Vinoth Kannan",
      "email": "vinothkannan@vinkas.com",
      "date": "2019-09-24T17:47:59Z"
    },
    "committer": {
      "name": "Vinoth Kannan",
      "email": "vinothkannan@vinkas.com",
      "date": "2019-09-24T17:47:59Z"
    },
    "message": "FIX: include video tags and short urls in 'have_uploads' method.\n\nWhile checking the existence of upload in posts we must include <video> tags and 'short-url' format of upload URLs.",
    "tree": {
      "sha": "782451edcf15f221735e8d0633532927c44a797e",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/782451edcf15f221735e8d0633532927c44a797e"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/02731ef33ef53acd3ad013b3ab29f6286eed8b9d",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/02731ef33ef53acd3ad013b3ab29f6286eed8b9d",
  "html_url": "https://github.com/discourse/discourse/commit/02731ef33ef53acd3ad013b3ab29f6286eed8b9d",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/02731ef33ef53acd3ad013b3ab29f6286eed8b9d/comments",
  "author": {
    "login": "vinothkannans",
    "id": 9372109,
    "node_id": "MDQ6VXNlcjkzNzIxMDk=",
    "avatar_url": "https://avatars0.githubusercontent.com/u/9372109?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vinothkannans",
    "html_url": "https://github.com/vinothkannans",
    "followers_url": "https://api.github.com/users/vinothkannans/followers",
    "following_url": "https://api.github.com/users/vinothkannans/following{/other_user}",
    "gists_url": "https://api.github.com/users/vinothkannans/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vinothkannans/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vinothkannans/subscriptions",
    "organizations_url": "https://api.github.com/users/vinothkannans/orgs",
    "repos_url": "https://api.github.com/users/vinothkannans/repos",
    "events_url": "https://api.github.com/users/vinothkannans/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vinothkannans/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "vinothkannans",
    "id": 9372109,
    "node_id": "MDQ6VXNlcjkzNzIxMDk=",
    "avatar_url": "https://avatars0.githubusercontent.com/u/9372109?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vinothkannans",
    "html_url": "https://github.com/vinothkannans",
    "followers_url": "https://api.github.com/users/vinothkannans/followers",
    "following_url": "https://api.github.com/users/vinothkannans/following{/other_user}",
    "gists_url": "https://api.github.com/users/vinothkannans/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vinothkannans/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vinothkannans/subscriptions",
    "organizations_url": "https://api.github.com/users/vinothkannans/orgs",
    "repos_url": "https://api.github.com/users/vinothkannans/repos",
    "events_url": "https://api.github.com/users/vinothkannans/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vinothkannans/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "cb8fa4697024ed70620d362aca21b34cd6ec29ff",
      "url": "https://api.github.com/repos/discourse/discourse/commits/cb8fa4697024ed70620d362aca21b34cd6ec29ff",
      "html_url": "https://github.com/discourse/discourse/commit/cb8fa4697024ed70620d362aca21b34cd6ec29ff"
    }
  ],
  "stats": {
    "total": 18,
    "additions": 14,
    "deletions": 4
  },
  "files": [
    {
      "sha": "2d2cb253e46c2f084e11cc0aa9c21d4962295ce3",
      "filename": "app/models/post.rb",
      "status": "modified",
      "additions": 13,
      "deletions": 4,
      "changes": 17,
      "blob_url": "https://github.com/discourse/discourse/blob/02731ef33ef53acd3ad013b3ab29f6286eed8b9d/app/models/post.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/02731ef33ef53acd3ad013b3ab29f6286eed8b9d/app/models/post.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/models/post.rb?ref=02731ef33ef53acd3ad013b3ab29f6286eed8b9d",
      "patch": "@@ -116,10 +116,19 @@ class Post < ActiveRecord::Base\n   }\n \n   scope :have_uploads, -> {\n-    where(\n-      \"(posts.cooked LIKE '%<a %' OR posts.cooked LIKE '%<img %') AND (posts.cooked LIKE ? OR posts.cooked LIKE '%/original/%' OR posts.cooked LIKE '%/optimized/%' OR posts.cooked LIKE '%data-orig-src=%')\",\n-      \"%/uploads/#{RailsMultisite::ConnectionManagement.current_db}/%\"\n-    )\n+    where(\"\n+          (\n+            posts.cooked LIKE '%<a %' OR\n+            posts.cooked LIKE '%<img %' OR\n+            posts.cooked LIKE '%<video %'\n+          ) AND (\n+            posts.cooked LIKE ? OR\n+            posts.cooked LIKE '%/original/%' OR\n+            posts.cooked LIKE '%/optimized/%' OR\n+            posts.cooked LIKE '%data-orig-src=%' OR\n+            posts.cooked LIKE '%/uploads/short-url/%'\n+          )\", \"%/uploads/#{RailsMultisite::ConnectionManagement.current_db}/%\"\n+        )\n   }\n \n   delegate :username, to: :user"
    },
    {
      "sha": "92d4aafad167aa8de46f0599f5953e1f70a0634f",
      "filename": "spec/models/post_spec.rb",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/discourse/discourse/blob/02731ef33ef53acd3ad013b3ab29f6286eed8b9d/spec/models/post_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/02731ef33ef53acd3ad013b3ab29f6286eed8b9d/spec/models/post_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/models/post_spec.rb?ref=02731ef33ef53acd3ad013b3ab29f6286eed8b9d",
      "patch": "@@ -1356,6 +1356,7 @@ def updates_topic_updated_at\n       ids << Fabricate(:post, cooked: \"A post with optimized image <img src='https://cdn.example.com/bucket/optimized/1X/abc/defghijklmno.png'>\").id\n       Fabricate(:post, cooked: \"A post with external link <a href='https://example.com/wp-content/uploads/abcdef.gif'>\")\n       ids << Fabricate(:post, cooked: 'A post with missing upload <img src=\"https://cdn.example.com/images/transparent.png\" data-orig-src=\"upload://defghijklmno.png\">').id\n+      ids << Fabricate(:post, cooked: 'A post with video upload <video width=\"100%\" height=\"100%\" controls=\"\"><source src=\"https://cdn.example.com/uploads/short-url/XefghijklmU9.mp4\"><a href=\"https://cdn.example.com/uploads/short-url/XefghijklmU9.mp4\">https://cdn.example.com/uploads/short-url/XefghijklmU9.mp4</a></video>').id\n       expect(Post.have_uploads.order(:id).pluck(:id)).to eq(ids)\n     end\n   end"
    }
  ]
}
