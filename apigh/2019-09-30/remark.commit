{
  "sha": "6b2addc280289939f2a29edcd3db89cbc44ed6e0",
  "node_id": "MDY6Q29tbWl0MTE0ODI5NTAzOjZiMmFkZGMyODAyODk5MzlmMmEyOWVkY2QzZGI4OWNiYzQ0ZWQ2ZTA=",
  "commit": {
    "author": {
      "name": "Misha Vyrtsev",
      "email": "reeywhaar@gmail.com",
      "date": "2019-09-29T20:38:09Z"
    },
    "committer": {
      "name": "Umputun",
      "email": "umputun@gmail.com",
      "date": "2019-09-29T20:38:09Z"
    },
    "message": "Fix #430 (#440)\n\n* add postMessage util\r\n\r\n* use scrollTo via postMessage (fixes \"scroll to parent\" on Safari #430)\r\n\r\n* use postMessage",
    "tree": {
      "sha": "b74132497d434d852e815690ba82d363f3044d80",
      "url": "https://api.github.com/repos/umputun/remark/git/trees/b74132497d434d852e815690ba82d363f3044d80"
    },
    "url": "https://api.github.com/repos/umputun/remark/git/commits/6b2addc280289939f2a29edcd3db89cbc44ed6e0",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/umputun/remark/commits/6b2addc280289939f2a29edcd3db89cbc44ed6e0",
  "html_url": "https://github.com/umputun/remark/commit/6b2addc280289939f2a29edcd3db89cbc44ed6e0",
  "comments_url": "https://api.github.com/repos/umputun/remark/commits/6b2addc280289939f2a29edcd3db89cbc44ed6e0/comments",
  "author": {
    "login": "Reeywhaar",
    "id": 884649,
    "node_id": "MDQ6VXNlcjg4NDY0OQ==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/884649?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Reeywhaar",
    "html_url": "https://github.com/Reeywhaar",
    "followers_url": "https://api.github.com/users/Reeywhaar/followers",
    "following_url": "https://api.github.com/users/Reeywhaar/following{/other_user}",
    "gists_url": "https://api.github.com/users/Reeywhaar/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Reeywhaar/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Reeywhaar/subscriptions",
    "organizations_url": "https://api.github.com/users/Reeywhaar/orgs",
    "repos_url": "https://api.github.com/users/Reeywhaar/repos",
    "events_url": "https://api.github.com/users/Reeywhaar/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Reeywhaar/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "umputun",
    "id": 535880,
    "node_id": "MDQ6VXNlcjUzNTg4MA==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/535880?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/umputun",
    "html_url": "https://github.com/umputun",
    "followers_url": "https://api.github.com/users/umputun/followers",
    "following_url": "https://api.github.com/users/umputun/following{/other_user}",
    "gists_url": "https://api.github.com/users/umputun/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/umputun/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/umputun/subscriptions",
    "organizations_url": "https://api.github.com/users/umputun/orgs",
    "repos_url": "https://api.github.com/users/umputun/repos",
    "events_url": "https://api.github.com/users/umputun/events{/privacy}",
    "received_events_url": "https://api.github.com/users/umputun/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "9fbdff106dcfe4b4bcb68b8df697ccb0a10c7d72",
      "url": "https://api.github.com/repos/umputun/remark/commits/9fbdff106dcfe4b4bcb68b8df697ccb0a10c7d72",
      "html_url": "https://github.com/umputun/remark/commit/9fbdff106dcfe4b4bcb68b8df697ccb0a10c7d72"
    }
  ],
  "stats": {
    "total": 39,
    "additions": 33,
    "deletions": 6
  },
  "files": [
    {
      "sha": "0ed6d8208788c0a4f3f4b7deeff983e4e91b0a5e",
      "filename": "frontend/app/components/auth-panel/auth-panel.tsx",
      "status": "modified",
      "additions": 3,
      "deletions": 2,
      "changes": 5,
      "blob_url": "https://github.com/umputun/remark/blob/6b2addc280289939f2a29edcd3db89cbc44ed6e0/frontend/app/components/auth-panel/auth-panel.tsx",
      "raw_url": "https://github.com/umputun/remark/raw/6b2addc280289939f2a29edcd3db89cbc44ed6e0/frontend/app/components/auth-panel/auth-panel.tsx",
      "contents_url": "https://api.github.com/repos/umputun/remark/contents/frontend/app/components/auth-panel/auth-panel.tsx?ref=6b2addc280289939f2a29edcd3db89cbc44ed6e0",
      "patch": "@@ -15,6 +15,7 @@ import { EmailLoginForm, EmailLoginFormConnected } from './__email-login-form';\n import { StoreState } from '@app/store';\n import { ProviderState } from '@app/store/provider/reducers';\n import debounce from '@app/utils/debounce';\n+import postMessage from '@app/utils/postMessage';\n \n export interface Props {\n   user: User | null;\n@@ -122,8 +123,8 @@ export class AuthPanel extends Component<Props, State> {\n   toggleUserInfoVisibility() {\n     const user = this.props.user;\n     if (window.parent && user) {\n-      const data = JSON.stringify({ isUserInfoShown: true, user });\n-      window.parent.postMessage(data, '*');\n+      const data = { isUserInfoShown: true, user };\n+      postMessage(data);\n     }\n   }\n "
    },
    {
      "sha": "2fe104c27e4f820cd86119f0f141f834ba6b5e64",
      "filename": "frontend/app/components/comment/comment.tsx",
      "status": "modified",
      "additions": 5,
      "deletions": 1,
      "changes": 6,
      "blob_url": "https://github.com/umputun/remark/blob/6b2addc280289939f2a29edcd3db89cbc44ed6e0/frontend/app/components/comment/comment.tsx",
      "raw_url": "https://github.com/umputun/remark/raw/6b2addc280289939f2a29edcd3db89cbc44ed6e0/frontend/app/components/comment/comment.tsx",
      "contents_url": "https://api.github.com/repos/umputun/remark/contents/frontend/app/components/comment/comment.tsx?ref=6b2addc280289939f2a29edcd3db89cbc44ed6e0",
      "patch": "@@ -20,6 +20,7 @@ import { AvatarIcon } from '@app/components/avatar-icon';\n import Countdown from '../countdown';\n import { boundActions } from './connected-comment';\n import { getPreview, uploadImage } from '@app/common/api';\n+import postMessage from '@app/utils/postMessage';\n \n export type Props = {\n   user: User | null;\n@@ -288,7 +289,10 @@ export class Comment extends Component<Props, State> {\n     const parentCommentNode = document.getElementById(`${COMMENT_NODE_CLASSNAME_PREFIX}${pid}`);\n \n     if (parentCommentNode) {\n-      parentCommentNode.scrollIntoView();\n+      const top = parentCommentNode.getBoundingClientRect().top;\n+      if (!postMessage({ scrollTo: top })) {\n+        parentCommentNode.scrollIntoView();\n+      }\n     }\n   };\n "
    },
    {
      "sha": "dd54163122e378be443f6f78e6302e38c85992a6",
      "filename": "frontend/app/components/root/root.tsx",
      "status": "modified",
      "additions": 2,
      "deletions": 1,
      "changes": 3,
      "blob_url": "https://github.com/umputun/remark/blob/6b2addc280289939f2a29edcd3db89cbc44ed6e0/frontend/app/components/root/root.tsx",
      "raw_url": "https://github.com/umputun/remark/raw/6b2addc280289939f2a29edcd3db89cbc44ed6e0/frontend/app/components/root/root.tsx",
      "contents_url": "https://api.github.com/repos/umputun/remark/contents/frontend/app/components/root/root.tsx?ref=6b2addc280289939f2a29edcd3db89cbc44ed6e0",
      "patch": "@@ -41,6 +41,7 @@ import { Thread } from '@app/components/thread';\n import { uploadImage, getPreview } from '@app/common/api';\n import { isUserAnonymous } from '@app/utils/isUserAnonymous';\n import { bindActions } from '@app/utils/actionBinder';\n+import postMessage from '@app/utils/postMessage';\n \n const mapStateToProps = (state: StoreState) => ({\n   user: state.user,\n@@ -141,7 +142,7 @@ export class Root extends Component<Props, State> {\n \n       if (comment) {\n         setTimeout(() => {\n-          window.parent.postMessage(JSON.stringify({ scrollTo: comment.getBoundingClientRect().top }), '*');\n+          postMessage({ scrollTo: comment.getBoundingClientRect().top });\n         }, 500);\n       }\n     }"
    },
    {
      "sha": "bbce3bab5c3e18c7772ddf490e0b0bc7db561ca0",
      "filename": "frontend/app/components/user-info/user-info.tsx",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/umputun/remark/blob/6b2addc280289939f2a29edcd3db89cbc44ed6e0/frontend/app/components/user-info/user-info.tsx",
      "raw_url": "https://github.com/umputun/remark/raw/6b2addc280289939f2a29edcd3db89cbc44ed6e0/frontend/app/components/user-info/user-info.tsx",
      "contents_url": "https://api.github.com/repos/umputun/remark/contents/frontend/app/components/user-info/user-info.tsx?ref=6b2addc280289939f2a29edcd3db89cbc44ed6e0",
      "patch": "@@ -10,6 +10,7 @@ import { userInfo } from '@app/common/user-info-settings';\n \n import LastCommentsList from './last-comments-list';\n import { AvatarIcon } from '../avatar-icon';\n+import postMessage from '@app/utils/postMessage';\n \n interface Props {\n   comments: Comment[] | null;\n@@ -70,8 +71,7 @@ class UserInfo extends Component<Props, State> {\n   static onKeyDown(e: KeyboardEvent): void {\n     // ESCAPE key pressed\n     if (e.keyCode === 27) {\n-      const data = JSON.stringify({ isUserInfoShown: false });\n-      window.parent.postMessage(data, '*');\n+      postMessage({ isUserInfoShown: false });\n     }\n   }\n }"
    },
    {
      "sha": "6cdf7160530e37a7bcb1965d54e2a6ee6d3f54cb",
      "filename": "frontend/app/utils/postMessage.ts",
      "status": "added",
      "additions": 21,
      "deletions": 0,
      "changes": 21,
      "blob_url": "https://github.com/umputun/remark/blob/6b2addc280289939f2a29edcd3db89cbc44ed6e0/frontend/app/utils/postMessage.ts",
      "raw_url": "https://github.com/umputun/remark/raw/6b2addc280289939f2a29edcd3db89cbc44ed6e0/frontend/app/utils/postMessage.ts",
      "contents_url": "https://api.github.com/repos/umputun/remark/contents/frontend/app/utils/postMessage.ts?ref=6b2addc280289939f2a29edcd3db89cbc44ed6e0",
      "patch": "@@ -0,0 +1,21 @@\n+import { User } from '@app/common/types';\n+\n+export type Message =\n+  | { inited: true }\n+  | {\n+      isUserInfoShown: true;\n+      user: User;\n+    }\n+  | { isUserInfoShown: false }\n+  | { scrollTo: number };\n+\n+/**\n+ * Sends message to parent window\n+ *\n+ * @returns request success of fail\n+ */\n+export default function postMessage(data: Message): boolean {\n+  if (!window.parent || window.parent === window) return false;\n+  window.parent.postMessage(JSON.stringify(data), '*');\n+  return true;\n+}"
    }
  ]
}
