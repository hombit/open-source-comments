{
  "sha": "d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODpkNDA3YmNhYjM2N2U3NWQ4NmNmYzczMWU3MmI4YzZjMWIzZWY0YzNm",
  "commit": {
    "author": {
      "name": "Jarek Radosz",
      "email": "jradosz@gmail.com",
      "date": "2019-10-01T16:04:40Z"
    },
    "committer": {
      "name": "RÃ©gis Hanol",
      "email": "regis@hanol.fr",
      "date": "2019-10-01T16:04:39Z"
    },
    "message": "FIX: Correctly escape category description text (#8107)\n\n* FIX: Correctly escape category description text\r\n\r\nThis bug has been introduced in db14e10943aeb87f3a2e06f02ca788986f039077.\r\n\r\n* Remove unnecessary `html_safe`\r\n\r\n`Theme.lookup_field` already returns html-safe strings: https://github.com/discourse/discourse/blob/7ad338e3e6dee158cd704e7e62395bf5df835f7f/app/models/theme.rb#L237-L242\r\n\r\n* Rename `description` where it's acutally `descriptionText`",
    "tree": {
      "sha": "149dd615bac09635d611b73a6a991d4aac9cc76d",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/149dd615bac09635d611b73a6a991d4aac9cc76d"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f",
  "html_url": "https://github.com/discourse/discourse/commit/d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f/comments",
  "author": {
    "login": "CvX",
    "id": 66961,
    "node_id": "MDQ6VXNlcjY2OTYx",
    "avatar_url": "https://avatars1.githubusercontent.com/u/66961?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/CvX",
    "html_url": "https://github.com/CvX",
    "followers_url": "https://api.github.com/users/CvX/followers",
    "following_url": "https://api.github.com/users/CvX/following{/other_user}",
    "gists_url": "https://api.github.com/users/CvX/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/CvX/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/CvX/subscriptions",
    "organizations_url": "https://api.github.com/users/CvX/orgs",
    "repos_url": "https://api.github.com/users/CvX/repos",
    "events_url": "https://api.github.com/users/CvX/events{/privacy}",
    "received_events_url": "https://api.github.com/users/CvX/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "ZogStriP",
    "id": 362783,
    "node_id": "MDQ6VXNlcjM2Mjc4Mw==",
    "avatar_url": "https://avatars0.githubusercontent.com/u/362783?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ZogStriP",
    "html_url": "https://github.com/ZogStriP",
    "followers_url": "https://api.github.com/users/ZogStriP/followers",
    "following_url": "https://api.github.com/users/ZogStriP/following{/other_user}",
    "gists_url": "https://api.github.com/users/ZogStriP/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ZogStriP/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ZogStriP/subscriptions",
    "organizations_url": "https://api.github.com/users/ZogStriP/orgs",
    "repos_url": "https://api.github.com/users/ZogStriP/repos",
    "events_url": "https://api.github.com/users/ZogStriP/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ZogStriP/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "f7923958e2932dd6d1dbf1209a53fc9cad7b6bf7",
      "url": "https://api.github.com/repos/discourse/discourse/commits/f7923958e2932dd6d1dbf1209a53fc9cad7b6bf7",
      "html_url": "https://github.com/discourse/discourse/commit/f7923958e2932dd6d1dbf1209a53fc9cad7b6bf7"
    }
  ],
  "stats": {
    "total": 27,
    "additions": 16,
    "deletions": 11
  },
  "files": [
    {
      "sha": "7f02dae2804453c756c9eef8c8ddda1cc6f6ef06",
      "filename": "app/assets/javascripts/discourse/helpers/category-link.js.es6",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/discourse/discourse/blob/d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f/app/assets/javascripts/discourse/helpers/category-link.js.es6",
      "raw_url": "https://github.com/discourse/discourse/raw/d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f/app/assets/javascripts/discourse/helpers/category-link.js.es6",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/assets/javascripts/discourse/helpers/category-link.js.es6?ref=d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f",
      "patch": "@@ -75,7 +75,7 @@ export function categoryLinkHTML(category, options) {\n registerUnbound(\"category-link\", categoryLinkHTML);\n \n function defaultCategoryLinkRenderer(category, opts) {\n-  let description = get(category, \"description_text\");\n+  let descriptionText = get(category, \"description_text\");\n   let restricted = get(category, \"read_restricted\");\n   let url = opts.url\n     ? opts.url\n@@ -121,7 +121,7 @@ function defaultCategoryLinkRenderer(category, opts) {\n     'data-drop-close=\"true\" class=\"' +\n     classNames +\n     '\"' +\n-    (description ? 'title=\"' + escapeExpression(description) + '\" ' : \"\") +\n+    (descriptionText ? 'title=\"' + descriptionText + '\" ' : \"\") +\n     \">\";\n \n   let categoryName = escapeExpression(get(category, \"name\"));"
    },
    {
      "sha": "29153014229fc3e61f1e148f78fa584c191f0b82",
      "filename": "app/assets/javascripts/select-kit/components/category-row.js.es6",
      "status": "modified",
      "additions": 3,
      "deletions": 3,
      "changes": 6,
      "blob_url": "https://github.com/discourse/discourse/blob/d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f/app/assets/javascripts/select-kit/components/category-row.js.es6",
      "raw_url": "https://github.com/discourse/discourse/raw/d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f/app/assets/javascripts/select-kit/components/category-row.js.es6",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/assets/javascripts/select-kit/components/category-row.js.es6?ref=d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f",
      "patch": "@@ -84,9 +84,9 @@ export default SelectKitRowComponent.extend({\n   },\n \n   @computed(\"category.description_text\")\n-  descriptionText(description) {\n-    if (description) {\n-      return this._formatCategoryDescription(description);\n+  descriptionText(descriptionText) {\n+    if (descriptionText) {\n+      return this._formatCategoryDescription(descriptionText);\n     }\n   },\n "
    },
    {
      "sha": "34f92d7985786e2c9e0f22c4f2f94950c804f9e3",
      "filename": "app/helpers/application_helper.rb",
      "status": "modified",
      "additions": 0,
      "deletions": 3,
      "changes": 3,
      "blob_url": "https://github.com/discourse/discourse/blob/d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f/app/helpers/application_helper.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f/app/helpers/application_helper.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/helpers/application_helper.rb?ref=d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f",
      "patch": "@@ -437,17 +437,14 @@ def replace_plugin_html(name)\n \n   def theme_lookup(name)\n     Theme.lookup_field(theme_ids, mobile_view? ? :mobile : :desktop, name)\n-      &.html_safe\n   end\n \n   def theme_translations_lookup\n     Theme.lookup_field(theme_ids, :translations, I18n.locale)\n-      &.html_safe\n   end\n \n   def theme_js_lookup\n     Theme.lookup_field(theme_ids, :extra_js, nil)\n-      &.html_safe\n   end\n \n   def discourse_stylesheet_link_tag(name, opts = {})"
    },
    {
      "sha": "af7b073166997826c34155e8313c83b119e362b2",
      "filename": "app/models/category.rb",
      "status": "modified",
      "additions": 2,
      "deletions": 1,
      "changes": 3,
      "blob_url": "https://github.com/discourse/discourse/blob/d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f/app/models/category.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f/app/models/category.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/models/category.rb?ref=d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f",
      "patch": "@@ -261,7 +261,8 @@ def description_text\n \n     @@cache ||= LruRedux::ThreadSafeCache.new(1000)\n     @@cache.getset(self.description) do\n-      Nokogiri::HTML.fragment(self.description).text.strip.html_safe\n+      text = Nokogiri::HTML.fragment(self.description).text.strip\n+      Rack::Utils.escape_html(text).html_safe\n     end\n   end\n "
    },
    {
      "sha": "dc6a0b0d4d0607954e039bc3d77e248cbfbf5861",
      "filename": "app/views/users/omniauth_callbacks/complete.html.erb",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/discourse/discourse/blob/d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f/app/views/users/omniauth_callbacks/complete.html.erb",
      "raw_url": "https://github.com/discourse/discourse/raw/d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f/app/views/users/omniauth_callbacks/complete.html.erb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/views/users/omniauth_callbacks/complete.html.erb?ref=d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f",
      "patch": "@@ -26,7 +26,7 @@\n   <div class=\"dialog\">\n     <p>\n       <%=t \"login.auth_complete\" %>\n-      <a href=\"<%= Discourse.base_url.html_safe %>?authComplete=true\"><%= t(\"login.click_to_continue\") %></a>\n+      <a href=\"<%= Discourse.base_url %>?authComplete=true\"><%= t(\"login.click_to_continue\") %></a>\n     </p>\n   </div>\n </body>"
    },
    {
      "sha": "76eb8c23d6502f43c810bcf5fb9c966d7549151f",
      "filename": "spec/components/category_badge_spec.rb",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/discourse/discourse/blob/d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f/spec/components/category_badge_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f/spec/components/category_badge_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/components/category_badge_spec.rb?ref=d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f",
      "patch": "@@ -14,4 +14,11 @@\n     expect(html).to include(ERB::Util.html_escape(\"<b>name</b>\"))\n     expect(html).to include(\"title='title'\")\n   end\n+\n+  it \"escapes code block contents\" do\n+    c = Fabricate(:category, description: '<code>\\' &lt;b id=\"x\"&gt;</code>')\n+    html = CategoryBadge.html_for(c)\n+\n+    expect(html).to include(\"title='&#x27; &lt;b id=&quot;x&quot;&gt;'\")\n+  end\n end"
    },
    {
      "sha": "66944834299894da22ed79b25c45f11fb1b5a0b5",
      "filename": "spec/models/category_spec.rb",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/discourse/discourse/blob/d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f/spec/models/category_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f/spec/models/category_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/models/category_spec.rb?ref=d407bcab367e75d86cfc731e72b8c6c1b3ef4c3f",
      "patch": "@@ -357,7 +357,7 @@\n       c = Category.new\n       expect(c.description_text).to be_nil\n       c.description = \"&lt;hello <a>test</a>.\"\n-      expect(c.description_text).to eq(\"<hello test.\")\n+      expect(c.description_text).to eq(\"&lt;hello test.\")\n     end\n   end\n "
    }
  ]
}
