{
  "sha": "4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
  "node_id": "MDY6Q29tbWl0NzI0NTQyNDI6NGExNDkyZTg4ZDY2ZGUyNmFlODMwNGNjOTVkN2JmNzQ5YjM5YTZiOA==",
  "commit": {
    "author": {
      "name": "Tessa Thornton",
      "email": "tessathornton@gmail.com",
      "date": "2019-10-02T18:41:53Z"
    },
    "committer": {
      "name": "Wyatt Johnson",
      "email": "wyattjoh@gmail.com",
      "date": "2019-10-02T18:41:53Z"
    },
    "message": "[CORL-90] moderator notes (#2601)\n\n* add moderator notes and mutations\r\n\r\n* add create moderator note mutation\r\n\r\n* add components for moderator notes\r\n\r\n* style moderator notes\r\n\r\n* update styles\r\n\r\n* prevent warning about optimistic update unused fields\r\n\r\n* fix incorrect comment\r\n\r\n* fix optimistic response shape\r\n\r\n* fix create note payload type\r\n\r\n* add migration for moderator notes\r\n\r\n* updates from feedback\r\n\r\n* add border width for firefox",
    "tree": {
      "sha": "717a0caefcd383aa8e523130ead6bfac9c7019c8",
      "url": "https://api.github.com/repos/coralproject/talk/git/trees/717a0caefcd383aa8e523130ead6bfac9c7019c8"
    },
    "url": "https://api.github.com/repos/coralproject/talk/git/commits/4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/coralproject/talk/commits/4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
  "html_url": "https://github.com/coralproject/talk/commit/4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
  "comments_url": "https://api.github.com/repos/coralproject/talk/commits/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/comments",
  "author": {
    "login": "tessalt",
    "id": 1789029,
    "node_id": "MDQ6VXNlcjE3ODkwMjk=",
    "avatar_url": "https://avatars3.githubusercontent.com/u/1789029?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tessalt",
    "html_url": "https://github.com/tessalt",
    "followers_url": "https://api.github.com/users/tessalt/followers",
    "following_url": "https://api.github.com/users/tessalt/following{/other_user}",
    "gists_url": "https://api.github.com/users/tessalt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tessalt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tessalt/subscriptions",
    "organizations_url": "https://api.github.com/users/tessalt/orgs",
    "repos_url": "https://api.github.com/users/tessalt/repos",
    "events_url": "https://api.github.com/users/tessalt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tessalt/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "wyattjoh",
    "id": 633002,
    "node_id": "MDQ6VXNlcjYzMzAwMg==",
    "avatar_url": "https://avatars2.githubusercontent.com/u/633002?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wyattjoh",
    "html_url": "https://github.com/wyattjoh",
    "followers_url": "https://api.github.com/users/wyattjoh/followers",
    "following_url": "https://api.github.com/users/wyattjoh/following{/other_user}",
    "gists_url": "https://api.github.com/users/wyattjoh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wyattjoh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wyattjoh/subscriptions",
    "organizations_url": "https://api.github.com/users/wyattjoh/orgs",
    "repos_url": "https://api.github.com/users/wyattjoh/repos",
    "events_url": "https://api.github.com/users/wyattjoh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wyattjoh/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "3a4eae87adece7810f85416d7d57fb823b413dfc",
      "url": "https://api.github.com/repos/coralproject/talk/commits/3a4eae87adece7810f85416d7d57fb823b413dfc",
      "html_url": "https://github.com/coralproject/talk/commit/3a4eae87adece7810f85416d7d57fb823b413dfc"
    }
  ],
  "stats": {
    "total": 909,
    "additions": 905,
    "deletions": 4
  },
  "files": [
    {
      "sha": "3523193d160baff9e8ba1cfbcf1eb00e0c4de1ee",
      "filename": "src/core/client/admin/components/UserHistoryDrawer/CreateModeratorNoteMutation.ts",
      "status": "added",
      "additions": 86,
      "deletions": 0,
      "changes": 86,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/CreateModeratorNoteMutation.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/CreateModeratorNoteMutation.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/UserHistoryDrawer/CreateModeratorNoteMutation.ts?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -0,0 +1,86 @@\n+import { pick } from \"lodash\";\n+import { graphql } from \"react-relay\";\n+import { Environment } from \"relay-runtime\";\n+\n+import { CreateModeratorNoteMutation as MutationTypes } from \"coral-admin/__generated__/CreateModeratorNoteMutation.graphql\";\n+import { getViewer } from \"coral-framework/helpers\";\n+import { CoralContext } from \"coral-framework/lib/bootstrap\";\n+import {\n+  commitMutationPromiseNormalized,\n+  createMutation,\n+  lookup,\n+  MutationInput,\n+} from \"coral-framework/lib/relay\";\n+import { GQLUser } from \"coral-framework/schema\";\n+\n+let clientMutationId = 0;\n+\n+const CreateModeratorNoteMutation = createMutation(\n+  \"createModeratorNote\",\n+  (\n+    environment: Environment,\n+    input: MutationInput<MutationTypes>,\n+    { uuidGenerator }: CoralContext\n+  ) => {\n+    const viewer = getViewer(environment)!;\n+    const notes =\n+      lookup<GQLUser>(environment, input.userID)!.moderatorNotes.map(note => {\n+        const createdBy = pick(note.createdBy, [\"username\", \"id\"]);\n+        return {\n+          ...pick(note, [\"id\", \"body\", \"createdAt\"]),\n+          createdBy,\n+        };\n+      }) || [];\n+    const now = new Date();\n+    return commitMutationPromiseNormalized<MutationTypes>(environment, {\n+      mutation: graphql`\n+        mutation CreateModeratorNoteMutation(\n+          $input: CreateModeratorNoteInput!\n+        ) {\n+          createModeratorNote(input: $input) {\n+            user {\n+              moderatorNotes {\n+                id\n+                body\n+                createdBy {\n+                  username\n+                  id\n+                }\n+                createdAt\n+              }\n+            }\n+            clientMutationId\n+          }\n+        }\n+      `,\n+      variables: {\n+        input: {\n+          ...input,\n+          clientMutationId: clientMutationId.toString(),\n+        },\n+      },\n+      optimisticResponse: {\n+        createModeratorNote: {\n+          user: {\n+            id: input.userID,\n+            moderatorNotes: [\n+              {\n+                id: uuidGenerator(),\n+                body: input.body,\n+                createdAt: now.toISOString(),\n+                createdBy: {\n+                  username: viewer.username,\n+                  id: viewer.id,\n+                } as any,\n+              },\n+              ...notes,\n+            ],\n+          },\n+          clientMutationId: (clientMutationId++).toString(),\n+        },\n+      },\n+    });\n+  }\n+);\n+\n+export default CreateModeratorNoteMutation;"
    },
    {
      "sha": "389f638be2d89961871020d82d19c6cdca414ccf",
      "filename": "src/core/client/admin/components/UserHistoryDrawer/DeleteModeratorNoteMutation.ts",
      "status": "added",
      "additions": 72,
      "deletions": 0,
      "changes": 72,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/DeleteModeratorNoteMutation.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/DeleteModeratorNoteMutation.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/UserHistoryDrawer/DeleteModeratorNoteMutation.ts?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -0,0 +1,72 @@\n+import { pick } from \"lodash\";\n+import { graphql } from \"react-relay\";\n+import { Environment } from \"relay-runtime\";\n+\n+import { DeleteModeratorNoteMutation as MutationTypes } from \"coral-admin/__generated__/DeleteModeratorNoteMutation.graphql\";\n+import { CoralContext } from \"coral-framework/lib/bootstrap\";\n+import {\n+  commitMutationPromiseNormalized,\n+  createMutation,\n+  lookup,\n+  MutationInput,\n+} from \"coral-framework/lib/relay\";\n+import { GQLUser } from \"coral-framework/schema\";\n+\n+let clientMutationId = 0;\n+\n+const DeleteModeratorNoteMutation = createMutation(\n+  \"deleteModeratorNote\",\n+  (\n+    environment: Environment,\n+    input: MutationInput<MutationTypes>,\n+    { uuidGenerator }: CoralContext\n+  ) => {\n+    const notes =\n+      lookup<GQLUser>(environment, input.userID)!.moderatorNotes.map(note => {\n+        const createdBy = pick(note.createdBy, [\"username\", \"id\"]);\n+        return {\n+          ...pick(note, [\"id\", \"body\", \"createdAt\"]),\n+          createdBy,\n+        };\n+      }) || [];\n+    return commitMutationPromiseNormalized<MutationTypes>(environment, {\n+      mutation: graphql`\n+        mutation DeleteModeratorNoteMutation(\n+          $input: DeleteModeratorNoteInput!\n+        ) {\n+          deleteModeratorNote(input: $input) {\n+            user {\n+              moderatorNotes {\n+                id\n+                body\n+                createdBy {\n+                  username\n+                  id\n+                }\n+                createdAt\n+              }\n+            }\n+            clientMutationId\n+          }\n+        }\n+      `,\n+      variables: {\n+        input: {\n+          ...input,\n+          clientMutationId: clientMutationId.toString(),\n+        },\n+      },\n+      optimisticResponse: {\n+        deleteModeratorNote: {\n+          user: {\n+            id: input.userID,\n+            moderatorNotes: notes.filter(note => note.id !== input.id),\n+          },\n+          clientMutationId: (clientMutationId++).toString(),\n+        },\n+      },\n+    });\n+  }\n+);\n+\n+export default DeleteModeratorNoteMutation;"
    },
    {
      "sha": "bb157a307a2db44e7ac7d16b914a49bdb159d26c",
      "filename": "src/core/client/admin/components/UserHistoryDrawer/ModeratorNote.css",
      "status": "added",
      "additions": 37,
      "deletions": 0,
      "changes": 37,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/ModeratorNote.css",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/ModeratorNote.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/UserHistoryDrawer/ModeratorNote.css?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -0,0 +1,37 @@\n+.root {\n+  \n+}\n+\n+.body {\n+  background-color: #f2f2f2;\n+  border-radius: 4px;\n+  padding: var(--spacing-4); \n+}\n+\n+.bodyType {\n+  color: var(--palette-text-dark);\n+}\n+\n+.leftBy {\n+  padding-left: var(--spacing-4);\n+  padding-right: var(--spacing-1);\n+  position: relative;\n+  color: var(--palette-grey-main);\n+}\n+\n+.leftBy:before {\n+  content: \"\";\n+  width: 4px;\n+  height: 4px;\n+  background-color: var(--palette-grey-main); \n+  position: absolute;\n+  border-radius: 50%;\n+  left: var(--spacing-1);\n+  top: 50%;\n+}\n+\n+.username {\n+  font-family: var(--font-family-serif);\n+  font-weight: var(--font-weight-medium);\n+  color: var(--palette-grey-main); \n+}\n\\ No newline at end of file"
    },
    {
      "sha": "790ae964672855bc755a3f9c2e6228ad351b033e",
      "filename": "src/core/client/admin/components/UserHistoryDrawer/ModeratorNote.tsx",
      "status": "added",
      "additions": 64,
      "deletions": 0,
      "changes": 64,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/ModeratorNote.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/ModeratorNote.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/UserHistoryDrawer/ModeratorNote.tsx?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -0,0 +1,64 @@\n+import { Localized } from \"fluent-react/compat\";\n+import React, { FunctionComponent, useCallback } from \"react\";\n+\n+import { Button, Flex, Icon, Timestamp, Typography } from \"coral-ui/components\";\n+\n+import styles from \"./ModeratorNote.css\";\n+\n+interface Props {\n+  body: string;\n+  moderator: string | null;\n+  createdAt: string;\n+  onDelete: ((id: string) => Promise<any>) | null;\n+  id: string;\n+}\n+\n+const ModeratorNote: FunctionComponent<Props> = ({\n+  moderator,\n+  createdAt,\n+  body,\n+  onDelete,\n+  id,\n+}) => {\n+  const deleteNote = useCallback(() => {\n+    if (onDelete) {\n+      onDelete(id);\n+    }\n+  }, [id]);\n+  return (\n+    <div>\n+      <div className={styles.body}>\n+        <Typography variant=\"bodyCopy\" className={styles.bodyType}>\n+          {body}\n+        </Typography>\n+      </div>\n+      <Flex justifyContent=\"space-between\">\n+        <Flex alignItems=\"center\">\n+          <Timestamp>{createdAt}</Timestamp>\n+          {moderator && (\n+            <>\n+              <Localized id=\"moderatorNote-left-by\">\n+                <Typography variant=\"timestamp\" className={styles.leftBy}>\n+                  Left by:\n+                </Typography>\n+              </Localized>\n+              <Typography className={styles.username} variant=\"timestamp\">\n+                {moderator}\n+              </Typography>\n+            </>\n+          )}\n+        </Flex>\n+        {onDelete && (\n+          <Localized id=\"moderatorNote-delete\">\n+            <Button size=\"small\" color=\"primary\" onClick={deleteNote}>\n+              <Icon>delete</Icon>\n+              <span>Delete</span>\n+            </Button>\n+          </Localized>\n+        )}\n+      </Flex>\n+    </div>\n+  );\n+};\n+\n+export default ModeratorNote;"
    },
    {
      "sha": "5bb53279f4127dca6fb5242481dbbc489c2fcaf5",
      "filename": "src/core/client/admin/components/UserHistoryDrawer/Tabs.css",
      "status": "modified",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/Tabs.css",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/Tabs.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/UserHistoryDrawer/Tabs.css?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -57,4 +57,12 @@\n .scrollable {\n   overflow-x: hidden;\n   overflow-y: auto;\n+}\n+\n+.redDot {\n+  background-color: var(--palette-error-main);\n+  width: 6px;\n+  height: 6px;\n+  border-radius: 50%;\n+  margin-left: 2px;\n }\n\\ No newline at end of file"
    },
    {
      "sha": "3e0ef6729656825b41c8a48bbb6b324a7bffdf01",
      "filename": "src/core/client/admin/components/UserHistoryDrawer/Tabs.tsx",
      "status": "modified",
      "additions": 40,
      "deletions": 3,
      "changes": 43,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/Tabs.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/Tabs.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/UserHistoryDrawer/Tabs.tsx?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -2,21 +2,34 @@ import cn from \"classnames\";\n import { Localized } from \"fluent-react/compat\";\n import React, { FunctionComponent, useCallback, useState } from \"react\";\n \n-import { Icon, Tab, TabBar, TabContent, TabPane } from \"coral-ui/components\";\n+import {\n+  Flex,\n+  Icon,\n+  Tab,\n+  TabBar,\n+  TabContent,\n+  TabPane,\n+} from \"coral-ui/components\";\n \n import UserDrawerAccountHistoryQuery from \"./UserDrawerAccountHistoryQuery\";\n+import UserDrawerNotesQuery from \"./UserDrawerNotesQuery\";\n import UserHistoryDrawerAllCommentsQuery from \"./UserHistoryDrawerAllCommentsQuery\";\n import UserHistoryDrawerRejectedCommentsQuery from \"./UserHistoryDrawerRejectedCommentsQuery\";\n \n import styles from \"./Tabs.css\";\n \n-type UserTabs = \"ALL_COMMENTS\" | \"REJECTED_COMMENTS\" | \"ACCOUNT_HISTORY\";\n+type UserTabs =\n+  | \"ALL_COMMENTS\"\n+  | \"REJECTED_COMMENTS\"\n+  | \"ACCOUNT_HISTORY\"\n+  | \"NOTES\";\n \n interface Props {\n   userID: string;\n+  notesCount: number;\n }\n \n-const UserHistoryTabs: FunctionComponent<Props> = ({ userID }) => {\n+const UserHistoryTabs: FunctionComponent<Props> = ({ userID, notesCount }) => {\n   const [currentTab, setCurrentTab] = useState<UserTabs>(\"ALL_COMMENTS\");\n \n   const onTabChanged = useCallback(\n@@ -62,6 +75,23 @@ const UserHistoryTabs: FunctionComponent<Props> = ({ userID }) => {\n             </Localized>\n           </div>\n         </Tab>\n+        <Tab tabID=\"NOTES\" onTabClick={onTabChanged}>\n+          <div\n+            className={cn(styles.tab, {\n+              [styles.activeTab]: currentTab === \"NOTES\",\n+            })}\n+          >\n+            <Icon size=\"sm\" className={styles.tabIcon}>\n+              subject\n+            </Icon>\n+            <Flex>\n+              <Localized id=\"moderate-user-drawer-tab-notes\">\n+                <span>Notes</span>\n+              </Localized>\n+              {notesCount > 0 && <div className={styles.redDot} />}\n+            </Flex>\n+          </div>\n+        </Tab>\n         <Tab tabID=\"ACCOUNT_HISTORY\" onTabClick={onTabChanged}>\n           <div\n             className={cn(styles.tab, {\n@@ -99,6 +129,13 @@ const UserHistoryTabs: FunctionComponent<Props> = ({ userID }) => {\n             </div>\n           </div>\n         </TabPane>\n+        <TabPane tabID=\"NOTES\">\n+          <div className={styles.container}>\n+            <div className={styles.scrollable}>\n+              <UserDrawerNotesQuery userID={userID} />\n+            </div>\n+          </div>\n+        </TabPane>\n       </TabContent>\n     </div>\n   );"
    },
    {
      "sha": "9b02bb6fe26dc10f592a405b2f2cca4b24787560",
      "filename": "src/core/client/admin/components/UserHistoryDrawer/UserDrawerNotesContainer.css",
      "status": "added",
      "additions": 31,
      "deletions": 0,
      "changes": 31,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/UserDrawerNotesContainer.css",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/UserDrawerNotesContainer.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/UserHistoryDrawer/UserDrawerNotesContainer.css?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -0,0 +1,31 @@\n+.root {\n+\n+}\n+\n+.textArea {\n+  width: 100%;\n+  box-sizing: border-box;\n+  height: calc(12 * var(--mini-unit));\n+  border-width: 1px;\n+  border-color: var(--palette-grey-main);\n+  padding: calc(0.5 * var(--mini-unit));\n+  border-radius: 2px;\n+  margin-bottom: var(--spacing-2);\n+  padding: var(--spacing-3);\n+  font-weight: var(--font-weight-regular);\n+  font-family: var(--font-family-sans-serif);\n+  font-size: calc(16rem / var(--rem-base));\n+  line-height: 1;\n+  letter-spacing: calc(0.2em / 16);\n+  color: var(--palette-text-primary);\n+}\n+\n+.textArea:focus {\n+  outline: none;\n+}\n+\n+.form {\n+  padding: var(--spacing-2) 0;\n+  border-bottom: 1px solid rgba(0, 0, 0, 0.12);\n+  margin-bottom: var(--spacing-4);\n+}"
    },
    {
      "sha": "6575efc9223a518e013e28ec7c1eb77175d9e290",
      "filename": "src/core/client/admin/components/UserHistoryDrawer/UserDrawerNotesContainer.tsx",
      "status": "added",
      "additions": 129,
      "deletions": 0,
      "changes": 129,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/UserDrawerNotesContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/UserDrawerNotesContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/UserHistoryDrawer/UserDrawerNotesContainer.tsx?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -0,0 +1,129 @@\n+import { Localized } from \"fluent-react/compat\";\n+import React, { FunctionComponent, useCallback } from \"react\";\n+\n+import { UserDrawerNotesContainer_user as UserData } from \"coral-admin/__generated__/UserDrawerNotesContainer_user.graphql\";\n+import { UserDrawerNotesContainer_viewer as ViewerData } from \"coral-admin/__generated__/UserDrawerNotesContainer_viewer.graphql\";\n+import {\n+  graphql,\n+  useMutation,\n+  withFragmentContainer,\n+} from \"coral-framework/lib/relay\";\n+import { required } from \"coral-framework/lib/validation\";\n+import { Button, Flex, HorizontalGutter } from \"coral-ui/components\";\n+import { FormApi } from \"final-form\";\n+import { Field, Form } from \"react-final-form\";\n+import CreateModeratorNoteMutation from \"./CreateModeratorNoteMutation\";\n+import DeleteModeratorNoteMutation from \"./DeleteModeratorNoteMutation\";\n+import ModeratorNote from \"./ModeratorNote\";\n+\n+import styles from \"./UserDrawerNotesContainer.css\";\n+\n+interface Props {\n+  user: UserData;\n+  viewer: ViewerData | null;\n+}\n+\n+const UserDrawerNotesContainer: FunctionComponent<Props> = ({\n+  user,\n+  viewer,\n+}) => {\n+  const createNote = useMutation(CreateModeratorNoteMutation);\n+  const deleteNote = useMutation(DeleteModeratorNoteMutation);\n+  const onDelete = useCallback(\n+    (id: string) => {\n+      return deleteNote({\n+        id,\n+        userID: user.id,\n+      });\n+    },\n+    [user]\n+  );\n+  const onSubmit = useCallback(\n+    async ({ body }, form: FormApi) => {\n+      await createNote({\n+        userID: user.id,\n+        body,\n+      });\n+      form.reset();\n+    },\n+    [user]\n+  );\n+  return (\n+    <div>\n+      <Form onSubmit={onSubmit}>\n+        {({ handleSubmit, submitError, invalid, submitting, ...formProps }) => (\n+          <form\n+            className={styles.form}\n+            onSubmit={handleSubmit}\n+            data-testid=\"userdrawer-notes-form\"\n+          >\n+            <Localized id=\"moderate-user-drawer-notes-field\">\n+              <Field\n+                className={styles.textArea}\n+                id=\"suspendModal-message\"\n+                component=\"textarea\"\n+                name=\"body\"\n+                validate={required}\n+                placeholder=\"Leave a note...\"\n+              />\n+            </Localized>\n+            <Flex justifyContent=\"flex-end\">\n+              <Localized id=\"moderate-user-drawer-notes-button\">\n+                <Button variant=\"filled\" color=\"primary\" type=\"submit\">\n+                  Add note\n+                </Button>\n+              </Localized>\n+            </Flex>\n+          </form>\n+        )}\n+      </Form>\n+      <HorizontalGutter size=\"double\">\n+        {user.moderatorNotes &&\n+          user.moderatorNotes\n+            .concat()\n+            .reverse()\n+            .map(\n+              note =>\n+                note && (\n+                  <ModeratorNote\n+                    key={note.id}\n+                    id={note.id}\n+                    body={note.body}\n+                    moderator={note.createdBy.username}\n+                    createdAt={note.createdAt}\n+                    onDelete={\n+                      viewer && viewer.id === note.createdBy.id\n+                        ? onDelete\n+                        : null\n+                    }\n+                  />\n+                )\n+            )}\n+      </HorizontalGutter>\n+    </div>\n+  );\n+};\n+\n+const enhanced = withFragmentContainer<Props>({\n+  user: graphql`\n+    fragment UserDrawerNotesContainer_user on User {\n+      id\n+      moderatorNotes {\n+        id\n+        body\n+        createdAt\n+        createdBy {\n+          username\n+          id\n+        }\n+      }\n+    }\n+  `,\n+  viewer: graphql`\n+    fragment UserDrawerNotesContainer_viewer on User {\n+      id\n+    }\n+  `,\n+})(UserDrawerNotesContainer);\n+\n+export default enhanced;"
    },
    {
      "sha": "3cdb5c5b95a87facfbe6bfb35244e11b26920999",
      "filename": "src/core/client/admin/components/UserHistoryDrawer/UserDrawerNotesQuery.css",
      "status": "added",
      "additions": 14,
      "deletions": 0,
      "changes": 14,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/UserDrawerNotesQuery.css",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/UserDrawerNotesQuery.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/UserHistoryDrawer/UserDrawerNotesQuery.css?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -0,0 +1,14 @@\n+.root {\n+  \n+}\n+\n+.spinner {\n+  text-align: center;\n+}\n+\n+.callout {\n+  width: 100%;\n+  font-family: var(--font-family-sans-serif);\n+  align-content: center;\n+  text-align: center;\n+}\n\\ No newline at end of file"
    },
    {
      "sha": "a0c2b5c1d8dbb0c681337929c661c1ea77355d85",
      "filename": "src/core/client/admin/components/UserHistoryDrawer/UserDrawerNotesQuery.tsx",
      "status": "added",
      "additions": 70,
      "deletions": 0,
      "changes": 70,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/UserDrawerNotesQuery.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/UserDrawerNotesQuery.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/UserHistoryDrawer/UserDrawerNotesQuery.tsx?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -0,0 +1,70 @@\n+import { graphql, QueryRenderer } from \"coral-framework/lib/relay\";\n+import { Localized } from \"fluent-react/compat\";\n+import React, { FunctionComponent } from \"react\";\n+import { ReadyState } from \"react-relay\";\n+\n+import { UserDrawerNotesQuery as QueryTypes } from \"coral-admin/__generated__/UserDrawerNotesQuery.graphql\";\n+\n+import { CallOut, Spinner } from \"coral-ui/components\";\n+\n+import UserDrawerNotesContainer from \"./UserDrawerNotesContainer\";\n+\n+import styles from \"./UserDrawerNotesQuery.css\";\n+\n+interface Props {\n+  userID: string;\n+}\n+\n+const UserDrawerNotesQuery: FunctionComponent<Props> = ({ userID }) => {\n+  return (\n+    <QueryRenderer<QueryTypes>\n+      query={graphql`\n+        query UserDrawerNotesQuery($userID: ID!) {\n+          user(id: $userID) {\n+            ...UserDrawerNotesContainer_user\n+          }\n+          viewer {\n+            ...UserDrawerNotesContainer_viewer\n+          }\n+        }\n+      `}\n+      variables={{ userID }}\n+      cacheConfig={{ force: true }}\n+      render={({ error, props }: ReadyState<QueryTypes[\"response\"]>) => {\n+        if (error) {\n+          return (\n+            <div className={styles.callout}>\n+              <CallOut>{error.message}</CallOut>\n+            </div>\n+          );\n+        }\n+\n+        if (!props) {\n+          return (\n+            <div className={styles.spinner}>\n+              <Spinner />\n+            </div>\n+          );\n+        }\n+\n+        if (!props.user) {\n+          return (\n+            <div className={styles.callout}>\n+              <CallOut>\n+                <Localized id=\"moderate-user-drawer-user-not-found \">\n+                  User not found.\n+                </Localized>\n+              </CallOut>\n+            </div>\n+          );\n+        }\n+\n+        return (\n+          <UserDrawerNotesContainer user={props.user} viewer={props.viewer} />\n+        );\n+      }}\n+    />\n+  );\n+};\n+\n+export default UserDrawerNotesQuery;"
    },
    {
      "sha": "8f1137716723afc4c586a8c2b673d67842cac8f6",
      "filename": "src/core/client/admin/components/UserHistoryDrawer/UserHistoryDrawerContainer.tsx",
      "status": "modified",
      "additions": 4,
      "deletions": 1,
      "changes": 5,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/UserHistoryDrawerContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/client/admin/components/UserHistoryDrawer/UserHistoryDrawerContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/UserHistoryDrawer/UserHistoryDrawerContainer.tsx?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -127,7 +127,7 @@ const UserHistoryDrawerContainer: FunctionComponent<Props> = ({\n       </div>\n       <hr className={styles.divider} />\n       <div className={styles.comments}>\n-        <Tabs userID={user.id} />\n+        <Tabs userID={user.id} notesCount={user.moderatorNotes.length} />\n       </div>\n     </>\n   );\n@@ -140,6 +140,9 @@ const enhanced = withFragmentContainer<Props>({\n       ...UserStatusChangeContainer_user\n       ...UserStatusDetailsContainer_user\n       ...RecentHistoryContainer_user\n+      moderatorNotes {\n+        id\n+      }\n       id\n       username\n       email"
    },
    {
      "sha": "e5d893a3e18af5aec978c549e6029ad0826acc34",
      "filename": "src/core/server/graph/tenant/mutators/Users.ts",
      "status": "modified",
      "additions": 21,
      "deletions": 0,
      "changes": 21,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/server/graph/tenant/mutators/Users.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/server/graph/tenant/mutators/Users.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/tenant/mutators/Users.ts?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -3,10 +3,12 @@ import { mapFieldsetToErrorCodes } from \"coral-server/graph/common/errors\";\n import TenantContext from \"coral-server/graph/tenant/context\";\n import { User } from \"coral-server/models/user\";\n import {\n+  addModeratorNote,\n   ban,\n   cancelAccountDeletion,\n   createToken,\n   deactivateToken,\n+  destroyModeratorNote,\n   ignore,\n   premod,\n   removeBan,\n@@ -35,8 +37,10 @@ import { deleteUser } from \"coral-server/services/users/delete\";\n import {\n   GQLBanUserInput,\n   GQLCancelAccountDeletionInput,\n+  GQLCreateModeratorNoteInput,\n   GQLCreateTokenInput,\n   GQLDeactivateTokenInput,\n+  GQLDeleteModeratorNoteInput,\n   GQLDeleteUserAccountInput,\n   GQLIgnoreUserInput,\n   GQLInviteUsersInput,\n@@ -203,6 +207,23 @@ export const Users = (ctx: TenantContext) => ({\n     updateAvatar(ctx.mongo, ctx.tenant, input.userID, input.avatar),\n   updateUserRole: async (input: GQLUpdateUserRoleInput) =>\n     updateRole(ctx.mongo, ctx.tenant, ctx.user!, input.userID, input.role),\n+  createModeratorNote: async (input: GQLCreateModeratorNoteInput) =>\n+    addModeratorNote(\n+      ctx.mongo,\n+      ctx.tenant,\n+      ctx.user!,\n+      input.userID,\n+      input.body,\n+      ctx.now\n+    ),\n+  deleteModeratorNote: async (input: GQLDeleteModeratorNoteInput) =>\n+    destroyModeratorNote(\n+      ctx.mongo,\n+      ctx.tenant,\n+      input.userID,\n+      input.id,\n+      ctx.user!\n+    ),\n   ban: async (input: GQLBanUserInput) =>\n     ban(\n       ctx.mongo,"
    },
    {
      "sha": "bd72168223f51e1f960bdf9ad78ad80143da38c2",
      "filename": "src/core/server/graph/tenant/resolvers/ModeratorNote.ts",
      "status": "added",
      "additions": 13,
      "deletions": 0,
      "changes": 13,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/server/graph/tenant/resolvers/ModeratorNote.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/server/graph/tenant/resolvers/ModeratorNote.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/tenant/resolvers/ModeratorNote.ts?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -0,0 +1,13 @@\n+import { GQLModeratorNoteTypeResolver } from \"coral-server/graph/tenant/schema/__generated__/types\";\n+import * as user from \"coral-server/models/user\";\n+\n+export const ModeratorNote: Required<\n+  GQLModeratorNoteTypeResolver<user.ModeratorNote>\n+> = {\n+  createdBy: ({ createdBy }, input, ctx) => {\n+    return ctx.loaders.Users.user.load(createdBy);\n+  },\n+  id: ({ id }) => id,\n+  body: ({ body }) => body,\n+  createdAt: ({ createdAt }) => createdAt,\n+};"
    },
    {
      "sha": "37c71f461cc456f88cf8dec746fd1be39add7329",
      "filename": "src/core/server/graph/tenant/resolvers/Mutation.ts",
      "status": "modified",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/server/graph/tenant/resolvers/Mutation.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/server/graph/tenant/resolvers/Mutation.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/tenant/resolvers/Mutation.ts?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -221,4 +221,12 @@ export const Mutation: Required<GQLMutationTypeResolver<void>> = {\n     user: await ctx.mutators.Users.deleteAccount(input),\n     clientMutationId: input.clientMutationId,\n   }),\n+  createModeratorNote: async (source, { input }, ctx) => ({\n+    user: await ctx.mutators.Users.createModeratorNote(input),\n+    clientMutationId: input.clientMutationId,\n+  }),\n+  deleteModeratorNote: async (source, { input }, ctx) => ({\n+    user: await ctx.mutators.Users.deleteModeratorNote(input),\n+    clientMutationId: input.clientMutationId,\n+  }),\n };"
    },
    {
      "sha": "bd217c10f1147b30384893e19017a256867165f0",
      "filename": "src/core/server/graph/tenant/resolvers/index.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/server/graph/tenant/resolvers/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/server/graph/tenant/resolvers/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/tenant/resolvers/index.ts?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -27,6 +27,7 @@ import { Invite } from \"./Invite\";\n import { LiveConfiguration } from \"./LiveConfiguration\";\n import { ModerationQueue } from \"./ModerationQueue\";\n import { ModerationQueues } from \"./ModerationQueues\";\n+import { ModeratorNote } from \"./ModeratorNote\";\n import { Mutation } from \"./Mutation\";\n import { OIDCAuthIntegration } from \"./OIDCAuthIntegration\";\n import { PremodStatus } from \"./PremodStatus\";\n@@ -92,6 +93,7 @@ const Resolvers: GQLResolver = {\n   User,\n   UserStatus,\n   UsernameStatus,\n+  ModeratorNote,\n };\n \n export default Resolvers;"
    },
    {
      "sha": "632aa8bdf1140966e54086aa8948efcb6f423bf6",
      "filename": "src/core/server/graph/tenant/schema/schema.graphql",
      "status": "modified",
      "additions": 96,
      "deletions": 0,
      "changes": 96,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/server/graph/tenant/schema/schema.graphql",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/server/graph/tenant/schema/schema.graphql",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/tenant/schema/schema.graphql?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -1571,6 +1571,28 @@ enum USER_STATUS {\n   PREMOD\n }\n \n+type ModeratorNote {\n+  \"\"\"\n+  id is the identifier of the Note.\n+  \"\"\"\n+  id: ID!\n+\n+  \"\"\"\n+  body is the content of the Note\n+  \"\"\"\n+  body: String!\n+\n+  \"\"\"\n+  createdAt is the date in which the Note was created.\n+  \"\"\"\n+  createdAt: Time!\n+\n+  \"\"\"\n+  createdBy is the Moderator that authored the Note.\n+  \"\"\"\n+  createdBy: User!\n+}\n+\n enum DIGEST_FREQUENCY {\n   \"\"\"\n   NONE will have the notifications send immediatly rather than bundling for digesting.\n@@ -1689,6 +1711,14 @@ type User {\n       permit: [SUSPENDED, BANNED, PENDING_DELETION]\n     )\n \n+  \"\"\"\n+  moderatorNotes are notes left by moderators about the User.\n+  \"\"\"\n+  moderatorNotes: [ModeratorNote!]!\n+    @auth(\n+      roles: [ADMIN, MODERATOR]\n+    )\n+\n   \"\"\"\n   ignoreable is a computed property based on the\n   user's role. Typically, users with elevated privileges\n@@ -4283,6 +4313,62 @@ type InviteUsersPayload {\n   clientMutationId: String!\n }\n \n+input CreateModeratorNoteInput {\n+  \"\"\"\n+  clientMutationId is required for Relay support.\n+  \"\"\"\n+  clientMutationId: String!\n+\n+  \"\"\"\n+  body is the content of the Note\n+  \"\"\"\n+  body: String!\n+\n+  \"\"\"\n+  userID the id of the User who is the subject of the note.\n+  \"\"\"\n+  userID: ID!\n+}\n+\n+input DeleteModeratorNoteInput {\n+  \"\"\"\n+  clientMutationId is required for Relay support.\n+  \"\"\"\n+  clientMutationId: String!\n+  \"\"\"\n+  userID is the user who is the subject of the note\n+  \"\"\"\n+  userID: ID!\n+  \"\"\"\n+  id is the identifier of the note\n+  \"\"\"\n+  id: ID!\n+}\n+\n+type CreateModeratorNotePayload {\n+  \"\"\"\n+  clientMutationId is required for Relay support.\n+  \"\"\"\n+  clientMutationId: String!\n+\n+  \"\"\"\n+  createdBy is the moderator who created the note\n+  user is the updated user.\n+  \"\"\"\n+  user: User!\n+}\n+\n+type DeleteModeratorNotePayload {\n+  \"\"\"\n+  clientMutationId is required for Relay support.\n+  \"\"\"\n+  clientMutationId: String!\n+  \"\"\"\n+  user is the updated user.\n+  \"\"\"\n+  user: User!\n+}\n+\n ##################\n # setEmail\n ##################\n@@ -5310,6 +5396,16 @@ type Mutation {\n   \"\"\"\n   removeUserPremod(input: RemovePremodUserInput!): RemovePremodUserPayload!\n     @auth(roles: [ADMIN, MODERATOR])\n+\n+  \"\"\"\n+  createModeratorNote creates a note on a user account.\n+  \"\"\"\n+  createModeratorNote(input: CreateModeratorNoteInput!): CreateModeratorNotePayload! @auth(roles: [ADMIN, MODERATOR])\n+\n+  \"\"\"\n+  deleteModeratorNote deletes a note on a user account.\n+  \"\"\"\n+  deleteModeratorNote(input: DeleteModeratorNoteInput!): DeleteModeratorNotePayload! @auth(roles: [ADMIN, MODERATOR])\n }\n \n ##################"
    },
    {
      "sha": "7e97fd2aa4f438130283b48ef62328e46925c752",
      "filename": "src/core/server/models/user/user.ts",
      "status": "modified",
      "additions": 106,
      "deletions": 0,
      "changes": 106,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/server/models/user/user.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/server/models/user/user.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/user/user.ts?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -103,6 +103,28 @@ export interface Token {\n   createdAt: Date;\n }\n \n+/**\n+ * ModeratorNote ModeratorNote is a note left by a moderator on the subject of a user.\n+ */\n+export interface ModeratorNote {\n+  /**\n+   * id is the identifier of the Note.\n+   */\n+  id: string;\n+  /**\n+   * body is the content of the Note\n+   */\n+  body: string;\n+  /**\n+   * createdAt is the date in which the Note was created.\n+   */\n+  createdAt: Date;\n+  /**\n+   * createdBy is the Moderator that authored the Note\n+   */\n+  createdBy: string;\n+}\n+\n /**\n  * SuspensionStatusHistory SuspensionStatusHistory is the list of all suspension\n  * events against a specific User.\n@@ -407,6 +429,11 @@ export interface User extends TenantResource {\n    */\n   ignoredUsers: IgnoredUser[];\n \n+  /**\n+   * moderatorNotes are notes left by moderators about the User.\n+   */\n+  moderatorNotes: ModeratorNote[];\n+\n   /**\n    * lastDownloadedAt is the last time the user requested to download their\n    * user data.\n@@ -478,6 +505,7 @@ async function findOrCreateUserInput(\n       onStaffReplies: false,\n       digestFrequency: GQLDIGEST_FREQUENCY.NONE,\n     },\n+    moderatorNotes: [],\n     profiles: [],\n     digests: [],\n     createdAt: now,\n@@ -2323,3 +2351,81 @@ export async function retrieveUserScheduledForDeletion(\n   );\n   return result.value || null;\n }\n+\n+/**\n+ * createModeratorNote will add a note to a users account\n+ * @param mongo the database to put the notification digests into\n+ * @param tenantID the ID of the Tenant that this User exists on\n+ * @param id the ID of the User who is the subject of the note\n+ * @param createdBy the ID of Moderator that is creating the note\n+ * @param note the contents of the note\n+ * @param now the current time that the note was created\n+ */\n+export async function createModeratorNote(\n+  mongo: Db,\n+  tenantID: string,\n+  id: string,\n+  createdBy: string,\n+  note: string,\n+  now = new Date()\n+) {\n+  const moderatorNote: ModeratorNote = {\n+    id: uuid(),\n+    createdAt: now,\n+    body: note,\n+    createdBy,\n+  };\n+  const result = await collection(mongo).findOneAndUpdate(\n+    { id, tenantID },\n+    {\n+      $push: {\n+        moderatorNotes: moderatorNote,\n+      },\n+    },\n+    {\n+      // False to return the updated document instead of the original\n+      // document.\n+      returnOriginal: false,\n+    }\n+  );\n+  if (!result.value) {\n+    throw new UserNotFoundError(id);\n+  }\n+\n+  return result.value;\n+}\n+\n+/**\n+ * deleteModeratorNote will remove a note from a user profile\n+ * @param mongo the database to put the notification digests into\n+ * @param tenantID the ID of the Tenant that this User exists on\n+ * @param userID the ID of the user\n+ * @param id the ID of the note to delete\n+ * @param createdBy the ID of the note author\n+ */\n+export async function deleteModeratorNote(\n+  mongo: Db,\n+  tenantID: string,\n+  userID: string,\n+  id: string,\n+  createdBy: string\n+) {\n+  const result = await collection(mongo).findOneAndUpdate(\n+    {\n+      id: userID,\n+      tenantID,\n+    },\n+    {\n+      $pull: {\n+        moderatorNotes: { id, createdBy },\n+      },\n+    },\n+    {\n+      returnOriginal: false,\n+    }\n+  );\n+  if (!result.value) {\n+    throw new UserNotFoundError(id);\n+  }\n+  return result.value;\n+}"
    },
    {
      "sha": "b5f04fd21d05f435158b74d04db31319d9a9aa17",
      "filename": "src/core/server/services/migrate/migrations/1569947670260_add_moderator_notes_to_user.ts",
      "status": "added",
      "additions": 51,
      "deletions": 0,
      "changes": 51,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/server/services/migrate/migrations/1569947670260_add_moderator_notes_to_user.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/server/services/migrate/migrations/1569947670260_add_moderator_notes_to_user.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/migrate/migrations/1569947670260_add_moderator_notes_to_user.ts?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -0,0 +1,51 @@\n+import { Db } from \"mongodb\";\n+\n+import collections from \"coral-server/services/mongodb/collections\";\n+\n+import Migration from \"coral-server/services/migrate/migration\";\n+\n+export default class extends Migration {\n+  public async up(mongo: Db, tenantID: string) {\n+    const result = await collections.users(mongo).updateMany(\n+      {\n+        tenantID,\n+        moderatorNotes: null,\n+      },\n+      {\n+        $set: {\n+          moderatorNotes: [],\n+        },\n+      }\n+    );\n+    this.log(tenantID).warn(\n+      {\n+        matchedCount: result.matchedCount,\n+        modifiedCount: result.matchedCount,\n+      },\n+      \"added empty moderatorNotes array\"\n+    );\n+  }\n+\n+  public async down(mongo: Db, tenantID: string) {\n+    const result = await collections.users(mongo).updateMany(\n+      {\n+        tenantID,\n+        moderatorNotes: {\n+          $exists: true,\n+        },\n+      },\n+      {\n+        $unset: {\n+          moderatorNotes: \"\",\n+        },\n+      }\n+    );\n+    this.log(tenantID).warn(\n+      {\n+        matchedCount: result.matchedCount,\n+        modifiedCount: result.matchedCount,\n+      },\n+      \"removed moderatorNotes\"\n+    );\n+  }\n+}"
    },
    {
      "sha": "93f9eca65f77237c198082ca93e8f3198a8af738",
      "filename": "src/core/server/services/users/index.ts",
      "status": "modified",
      "additions": 46,
      "deletions": 0,
      "changes": 46,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/server/services/users/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/core/server/services/users/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/users/index.ts?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -36,9 +36,11 @@ import {\n   consolidateUserBanStatus,\n   consolidateUserPremodStatus,\n   consolidateUserSuspensionStatus,\n+  createModeratorNote,\n   createUser,\n   createUserToken,\n   deactivateUserToken,\n+  deleteModeratorNote,\n   findOrCreateUser,\n   FindOrCreateUserInput,\n   ignoreUser,\n@@ -734,6 +736,50 @@ export async function updateAvatar(\n   return updateUserAvatar(mongo, tenant.id, userID, avatar);\n }\n \n+/**\n+ * addModeratorNote will add a note to the users account.\n+ *\n+ * @param mongo mongo database to interact with\n+ * @param tenant Tenant where the User will be banned on\n+ * @param moderator the Moderator that is creating the note\n+ * @param userID the ID of the User who is the subject of the note\n+ * @param note the contents of the note\n+ * @param now the current time that the note was created\n+ */\n+export async function addModeratorNote(\n+  mongo: Db,\n+  tenant: Tenant,\n+  moderator: User,\n+  userID: string,\n+  note: string,\n+  now = new Date()\n+) {\n+  if (!note || note.length < 1) {\n+    throw new Error(\"Note cannot be empty\");\n+  }\n+\n+  return createModeratorNote(mongo, tenant.id, userID, moderator.id, note, now);\n+}\n+\n+/**\n+ * destroyModeratorNote will remove a note from a user\n+ *\n+ * @param mongo mongo database to interact with\n+ * @param tenant Tenant where the User will be banned on\n+ * @param userID  id of the user who is the subjet\n+ * @param id  id of the note to delete\n+ */\n+\n+export async function destroyModeratorNote(\n+  mongo: Db,\n+  tenant: Tenant,\n+  userID: string,\n+  id: string,\n+  createdBy: User\n+) {\n+  return deleteModeratorNote(mongo, tenant.id, userID, id, createdBy.id);\n+}\n+\n /**\n  * ban will ban a specific user from interacting with Coral.\n  *"
    },
    {
      "sha": "5b2e0b15385a73132a290e3fd93ac3f817e714c2",
      "filename": "src/locales/en-US/admin.ftl",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/locales/en-US/admin.ftl",
      "raw_url": "https://github.com/coralproject/talk/raw/4a1492e88d66de26ae8304cc95d7bf749b39a6b8/src/locales/en-US/admin.ftl",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/locales/en-US/admin.ftl?ref=4a1492e88d66de26ae8304cc95d7bf749b39a6b8",
      "patch": "@@ -475,6 +475,7 @@ moderate-user-drawer-member-id =\n moderate-user-drawer-tab-all-comments = All Comments\n moderate-user-drawer-tab-rejected-comments = Rejected\n moderate-user-drawer-tab-account-history = Account History\n+moderate-user-drawer-tab-notes = Notes\n moderate-user-drawer-load-more = Load More\n moderate-user-drawer-all-no-comments = {$username} has not submitted any comments.\n moderate-user-drawer-rejected-no-comments = {$username} does not have any rejected comments.\n@@ -540,6 +541,12 @@ moderate-user-drawer-recent-history-tooltip-button =\n   .aria-label = Toggle recent comment history tooltip\n moderate-user-drawer-recent-history-tooltip-submitted = Submitted\n \n+moderate-user-drawer-notes-field = \n+  .placeholder = Leave a note...\n+moderate-user-drawer-notes-button = Add note\n+moderatorNote-left-by = Left by: \n+moderatorNote-delete = Delete\n+\n ## Create Username\n \n createUsername-createUsernameHeader = Create Username"
    }
  ]
}
