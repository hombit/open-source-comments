{
  "sha": "191687335be90079f0878850a34968166b84264b",
  "node_id": "MDY6Q29tbWl0NzI0NTQyNDI6MTkxNjg3MzM1YmU5MDA3OWYwODc4ODUwYTM0OTY4MTY2Yjg0MjY0Yg==",
  "commit": {
    "author": {
      "name": "Wyatt Johnson",
      "email": "wyattjoh@gmail.com",
      "date": "2019-10-04T17:00:25Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2019-10-04T17:00:25Z"
    },
    "message": "[CORL-682] OIDC Email and `setEmail` mutation (#2623)\n\n* fix: make email optional for oidc, fix schema perms\r\n\r\n- fixes #2622\r\n\r\n* fix: adjust defaults for heroku",
    "tree": {
      "sha": "a7ab766d240d303cfdb6fe28ce9684ae78bd9347",
      "url": "https://api.github.com/repos/coralproject/talk/git/trees/a7ab766d240d303cfdb6fe28ce9684ae78bd9347"
    },
    "url": "https://api.github.com/repos/coralproject/talk/git/commits/191687335be90079f0878850a34968166b84264b",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdl3qpCRBK7hj4Ov3rIwAAdHIIAIEhFnNgMQlM4UeYg2e+FEze\nyfyBTItp8dZeYdHnPiuDwC/d8IT3zDvwNZvIr0KgSDfBQ5mUJI+/E10Lp7bByKHf\ne6XrCNzrjlkL1yFv2ApYR6qMbhDUq8mraUdeAt3jvtJAGjclIwTen3CIGdE5NErt\ntjEBlfKOTskmBhPa6ZZUxOVscO0hkPAQOPRhphfW933xBWRY18R1fui2ltGwffAb\n+2GGuIIE2BEGN5K6kxd8xhW02q6ez/2HkvIVH6ShBVh+Rww0ULr46eQ81ZBmGndp\ngEPjOQE+0iS4q24Uyb8jwFtgJxOA1vdGIk/hD91vQQ7vC6++xv81t9tk5mU9rwU=\n=smWr\n-----END PGP SIGNATURE-----\n",
      "payload": "tree a7ab766d240d303cfdb6fe28ce9684ae78bd9347\nparent 33487be0ce113c6347f045b1164460e2259ba9cc\nauthor Wyatt Johnson <wyattjoh@gmail.com> 1570208425 +0000\ncommitter GitHub <noreply@github.com> 1570208425 +0000\n\n[CORL-682] OIDC Email and `setEmail` mutation (#2623)\n\n* fix: make email optional for oidc, fix schema perms\r\n\r\n- fixes #2622\r\n\r\n* fix: adjust defaults for heroku\r\n"
    }
  },
  "url": "https://api.github.com/repos/coralproject/talk/commits/191687335be90079f0878850a34968166b84264b",
  "html_url": "https://github.com/coralproject/talk/commit/191687335be90079f0878850a34968166b84264b",
  "comments_url": "https://api.github.com/repos/coralproject/talk/commits/191687335be90079f0878850a34968166b84264b/comments",
  "author": {
    "login": "wyattjoh",
    "id": 633002,
    "node_id": "MDQ6VXNlcjYzMzAwMg==",
    "avatar_url": "https://avatars2.githubusercontent.com/u/633002?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wyattjoh",
    "html_url": "https://github.com/wyattjoh",
    "followers_url": "https://api.github.com/users/wyattjoh/followers",
    "following_url": "https://api.github.com/users/wyattjoh/following{/other_user}",
    "gists_url": "https://api.github.com/users/wyattjoh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wyattjoh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wyattjoh/subscriptions",
    "organizations_url": "https://api.github.com/users/wyattjoh/orgs",
    "repos_url": "https://api.github.com/users/wyattjoh/repos",
    "events_url": "https://api.github.com/users/wyattjoh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wyattjoh/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "33487be0ce113c6347f045b1164460e2259ba9cc",
      "url": "https://api.github.com/repos/coralproject/talk/commits/33487be0ce113c6347f045b1164460e2259ba9cc",
      "html_url": "https://github.com/coralproject/talk/commit/33487be0ce113c6347f045b1164460e2259ba9cc"
    }
  ],
  "stats": {
    "total": 26,
    "additions": 17,
    "deletions": 9
  },
  "files": [
    {
      "sha": "bf26783ab8f0656eece0c9c965babd72e1503c0d",
      "filename": "app.json",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/coralproject/talk/blob/191687335be90079f0878850a34968166b84264b/app.json",
      "raw_url": "https://github.com/coralproject/talk/raw/191687335be90079f0878850a34968166b84264b/app.json",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/app.json?ref=191687335be90079f0878850a34968166b84264b",
      "patch": "@@ -21,6 +21,10 @@\n     \"ENABLE_GRAPHIQL\": {\n       \"description\": \"When true, this will enable the GraphiQL routes\",\n       \"value\": \"false\"\n+    },\n+    \"TRUST_PROXY\": {\n+      \"description\": \"When set to 1, it instructs Coral to trust up to one proxy, this is needed for authentication support\",\n+      \"value\": \"1\"\n     }\n   },\n   \"addons\": ["
    },
    {
      "sha": "bc1efa66591b3a7da5f5d1364ebf5b602159d124",
      "filename": "src/core/server/app/middleware/passport/strategies/oidc/index.ts",
      "status": "modified",
      "additions": 3,
      "deletions": 2,
      "changes": 5,
      "blob_url": "https://github.com/coralproject/talk/blob/191687335be90079f0878850a34968166b84264b/src/core/server/app/middleware/passport/strategies/oidc/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/191687335be90079f0878850a34968166b84264b/src/core/server/app/middleware/passport/strategies/oidc/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/app/middleware/passport/strategies/oidc/index.ts?ref=191687335be90079f0878850a34968166b84264b",
      "patch": "@@ -39,7 +39,7 @@ export interface OIDCIDToken {\n   iss: string;\n   sub: string;\n   exp: number; // TODO: use this as the source for how long an OIDC user can be logged in for\n-  email: string;\n+  email?: string;\n   email_verified?: boolean;\n   picture?: string;\n   name?: string;\n@@ -52,7 +52,7 @@ export const OIDCIDTokenSchema = Joi.object()\n     sub: Joi.string().required(),\n     iss: Joi.string().required(),\n     aud: Joi.string().required(),\n-    email: Joi.string().required(),\n+    email: Joi.string().default(undefined),\n     email_verified: Joi.boolean().default(false),\n     picture: Joi.string().default(undefined),\n     name: Joi.string().default(undefined),\n@@ -61,6 +61,7 @@ export const OIDCIDTokenSchema = Joi.object()\n   })\n   .optionalKeys([\n     \"picture\",\n+    \"email\",\n     \"email_verified\",\n     \"name\",\n     \"nickname\","
    },
    {
      "sha": "0ee661f29c91b05339f7e4c45ffc0f2100b6e37a",
      "filename": "src/core/server/graph/tenant/schema/schema.graphql",
      "status": "modified",
      "additions": 10,
      "deletions": 7,
      "changes": 17,
      "blob_url": "https://github.com/coralproject/talk/blob/191687335be90079f0878850a34968166b84264b/src/core/server/graph/tenant/schema/schema.graphql",
      "raw_url": "https://github.com/coralproject/talk/raw/191687335be90079f0878850a34968166b84264b/src/core/server/graph/tenant/schema/schema.graphql",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/tenant/schema/schema.graphql?ref=191687335be90079f0878850a34968166b84264b",
      "patch": "@@ -1714,10 +1714,7 @@ type User {\n   \"\"\"\n   moderatorNotes are notes left by moderators about the User.\n   \"\"\"\n-  moderatorNotes: [ModeratorNote!]!\n-    @auth(\n-      roles: [ADMIN, MODERATOR]\n-    )\n+  moderatorNotes: [ModeratorNote!]! @auth(roles: [ADMIN, MODERATOR])\n \n   \"\"\"\n   ignoreable is a computed property based on the\n@@ -5238,7 +5235,9 @@ type Mutation {\n   one already. This mutation will fail if the email address is already set.\n   \"\"\"\n   setEmail(input: SetEmailInput!): SetEmailPayload!\n-    @auth(permit: [MISSING_EMAIL, SUSPENDED, BANNED, PENDING_DELETION])\n+    @auth(\n+      permit: [MISSING_NAME, MISSING_EMAIL, SUSPENDED, BANNED, PENDING_DELETION]\n+    )\n \n   \"\"\"\n   setPassword will set the password on the current User if they have not set\n@@ -5400,12 +5399,16 @@ type Mutation {\n   \"\"\"\n   createModeratorNote creates a note on a user account.\n   \"\"\"\n-  createModeratorNote(input: CreateModeratorNoteInput!): CreateModeratorNotePayload! @auth(roles: [ADMIN, MODERATOR])\n+  createModeratorNote(\n+    input: CreateModeratorNoteInput!\n+  ): CreateModeratorNotePayload! @auth(roles: [ADMIN, MODERATOR])\n \n   \"\"\"\n   deleteModeratorNote deletes a note on a user account.\n   \"\"\"\n-  deleteModeratorNote(input: DeleteModeratorNoteInput!): DeleteModeratorNotePayload! @auth(roles: [ADMIN, MODERATOR])\n+  deleteModeratorNote(\n+    input: DeleteModeratorNoteInput!\n+  ): DeleteModeratorNotePayload! @auth(roles: [ADMIN, MODERATOR])\n }\n \n ##################"
    }
  ]
}
