{
  "sha": "9df473178b70387cccc8dcc9a595f7673491a639",
  "node_id": "MDY6Q29tbWl0NzI0NTQyNDI6OWRmNDczMTc4YjcwMzg3Y2NjYzhkY2M5YTU5NWY3NjczNDkxYTYzOQ==",
  "commit": {
    "author": {
      "name": "Tessa Thornton",
      "email": "tessathornton@gmail.com",
      "date": "2019-10-16T15:51:34Z"
    },
    "committer": {
      "name": "Wyatt Johnson",
      "email": "wyattjoh@gmail.com",
      "date": "2019-10-16T15:51:34Z"
    },
    "message": "[CORL-8] prevent repeat comments (#2632)\n\n* prevent users from reposting the same comment\r\n\r\n* fix tests\r\n\r\n* fix lints\r\n\r\n* update comments for users service\r\n\r\n* make updates based on review",
    "tree": {
      "sha": "055bb0b90ba793a87ef311869b6cecd8f4972ea2",
      "url": "https://api.github.com/repos/coralproject/talk/git/trees/055bb0b90ba793a87ef311869b6cecd8f4972ea2"
    },
    "url": "https://api.github.com/repos/coralproject/talk/git/commits/9df473178b70387cccc8dcc9a595f7673491a639",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/coralproject/talk/commits/9df473178b70387cccc8dcc9a595f7673491a639",
  "html_url": "https://github.com/coralproject/talk/commit/9df473178b70387cccc8dcc9a595f7673491a639",
  "comments_url": "https://api.github.com/repos/coralproject/talk/commits/9df473178b70387cccc8dcc9a595f7673491a639/comments",
  "author": {
    "login": "tessalt",
    "id": 1789029,
    "node_id": "MDQ6VXNlcjE3ODkwMjk=",
    "avatar_url": "https://avatars3.githubusercontent.com/u/1789029?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tessalt",
    "html_url": "https://github.com/tessalt",
    "followers_url": "https://api.github.com/users/tessalt/followers",
    "following_url": "https://api.github.com/users/tessalt/following{/other_user}",
    "gists_url": "https://api.github.com/users/tessalt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tessalt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tessalt/subscriptions",
    "organizations_url": "https://api.github.com/users/tessalt/orgs",
    "repos_url": "https://api.github.com/users/tessalt/repos",
    "events_url": "https://api.github.com/users/tessalt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tessalt/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "wyattjoh",
    "id": 633002,
    "node_id": "MDQ6VXNlcjYzMzAwMg==",
    "avatar_url": "https://avatars2.githubusercontent.com/u/633002?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wyattjoh",
    "html_url": "https://github.com/wyattjoh",
    "followers_url": "https://api.github.com/users/wyattjoh/followers",
    "following_url": "https://api.github.com/users/wyattjoh/following{/other_user}",
    "gists_url": "https://api.github.com/users/wyattjoh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wyattjoh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wyattjoh/subscriptions",
    "organizations_url": "https://api.github.com/users/wyattjoh/orgs",
    "repos_url": "https://api.github.com/users/wyattjoh/repos",
    "events_url": "https://api.github.com/users/wyattjoh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wyattjoh/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "1f7fdb0d00fbf0d16e7d04834897257de7045971",
      "url": "https://api.github.com/repos/coralproject/talk/commits/1f7fdb0d00fbf0d16e7d04834897257de7045971",
      "html_url": "https://github.com/coralproject/talk/commit/1f7fdb0d00fbf0d16e7d04834897257de7045971"
    }
  ],
  "stats": {
    "total": 245,
    "additions": 224,
    "deletions": 21
  },
  "files": [
    {
      "sha": "5ce58dfac1dde9fbb0131698a7100d45a9b35ec5",
      "filename": "src/core/client/admin/components/ModerateCard/MarkersContainer.spec.tsx",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/9df473178b70387cccc8dcc9a595f7673491a639/src/core/client/admin/components/ModerateCard/MarkersContainer.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/9df473178b70387cccc8dcc9a595f7673491a639/src/core/client/admin/components/ModerateCard/MarkersContainer.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/ModerateCard/MarkersContainer.spec.tsx?ref=9df473178b70387cccc8dcc9a595f7673491a639",
      "patch": "@@ -28,6 +28,7 @@ it(\"renders all markers\", () => {\n               COMMENT_DETECTED_SUSPECT_WORD: 1,\n               COMMENT_REPORTED_OFFENSIVE: 2,\n               COMMENT_REPORTED_SPAM: 3,\n+              COMMENT_DETECTED_REPEAT_POST: 1,\n             },\n           },\n         },\n@@ -71,6 +72,7 @@ it(\"renders some markers\", () => {\n               COMMENT_DETECTED_SUSPECT_WORD: 0,\n               COMMENT_REPORTED_OFFENSIVE: 2,\n               COMMENT_REPORTED_SPAM: 0,\n+              COMMENT_DETECTED_REPEAT_POST: 0,\n             },\n           },\n         },"
    },
    {
      "sha": "4143b8c0afd89cbc0439f61430545b6bbc8800d8",
      "filename": "src/core/client/admin/components/ModerateCard/MarkersContainer.tsx",
      "status": "modified",
      "additions": 14,
      "deletions": 5,
      "changes": 19,
      "blob_url": "https://github.com/coralproject/talk/blob/9df473178b70387cccc8dcc9a595f7673491a639/src/core/client/admin/components/ModerateCard/MarkersContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/9df473178b70387cccc8dcc9a595f7673491a639/src/core/client/admin/components/ModerateCard/MarkersContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/ModerateCard/MarkersContainer.tsx?ref=9df473178b70387cccc8dcc9a595f7673491a639",
      "patch": "@@ -32,7 +32,7 @@ const markers: Array<\n   c =>\n     (c.status === \"PREMOD\" && (\n       <Localized id=\"moderate-marker-preMod\" key={keyCounter++}>\n-        <Marker color=\"primary\">Pre-Mod</Marker>\n+        <Marker color=\"primary\">Pre-mod</Marker>\n       </Localized>\n     )) ||\n     null,\n@@ -48,7 +48,7 @@ const markers: Array<\n     (c.revision &&\n       c.revision.actionCounts.flag.reasons.COMMENT_DETECTED_BANNED_WORD && (\n         <Localized id=\"moderate-marker-bannedWord\" key={keyCounter++}>\n-          <Marker color=\"error\">Banned Word</Marker>\n+          <Marker color=\"error\">Banned word</Marker>\n         </Localized>\n       )) ||\n     null,\n@@ -57,7 +57,7 @@ const markers: Array<\n       c.revision.actionCounts.flag.reasons.COMMENT_DETECTED_SUSPECT_WORD && (\n         <Localized id=\"moderate-marker-suspectWord\" key={keyCounter++}>\n           <Marker color=\"error\" variant=\"filled\">\n-            Suspect Word\n+            Suspect word\n           </Marker>\n         </Localized>\n       )) ||\n@@ -66,7 +66,7 @@ const markers: Array<\n     (c.revision &&\n       c.revision.actionCounts.flag.reasons.COMMENT_DETECTED_SPAM && (\n         <Localized id=\"moderate-marker-spamDetected\" key={keyCounter++}>\n-          <Marker color=\"error\">Spam Detected</Marker>\n+          <Marker color=\"error\">Spam detected</Marker>\n         </Localized>\n       )) ||\n     null,\n@@ -78,11 +78,19 @@ const markers: Array<\n         </Localized>\n       )) ||\n     null,\n+  c =>\n+    (c.revision &&\n+      c.revision.actionCounts.flag.reasons.COMMENT_DETECTED_REPEAT_POST && (\n+        <Localized id=\"moderate-marker-repeatPost\" key={keyCounter++}>\n+          <Marker color=\"error\">Repeat comment</Marker>\n+        </Localized>\n+      )) ||\n+    null,\n   c =>\n     (c.revision &&\n       c.revision.actionCounts.flag.reasons.COMMENT_DETECTED_RECENT_HISTORY && (\n         <Localized id=\"moderate-marker-recentHistory\" key={keyCounter++}>\n-          <Marker color=\"error\">Recent History</Marker>\n+          <Marker color=\"error\">Recent history</Marker>\n         </Localized>\n       )) ||\n     null,\n@@ -162,6 +170,7 @@ const enhanced = withFragmentContainer<MarkersContainerProps>({\n               COMMENT_DETECTED_SUSPECT_WORD\n               COMMENT_REPORTED_OFFENSIVE\n               COMMENT_REPORTED_SPAM\n+              COMMENT_DETECTED_REPEAT_POST\n             }\n           }\n         }"
    },
    {
      "sha": "7d600f664800bd14d0961ac827bc4b67e14a624b",
      "filename": "src/core/client/admin/components/ModerateCard/__snapshots__/MarkersContainer.spec.tsx.snap",
      "status": "modified",
      "additions": 19,
      "deletions": 8,
      "changes": 27,
      "blob_url": "https://github.com/coralproject/talk/blob/9df473178b70387cccc8dcc9a595f7673491a639/src/core/client/admin/components/ModerateCard/__snapshots__/MarkersContainer.spec.tsx.snap",
      "raw_url": "https://github.com/coralproject/talk/raw/9df473178b70387cccc8dcc9a595f7673491a639/src/core/client/admin/components/ModerateCard/__snapshots__/MarkersContainer.spec.tsx.snap",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/ModerateCard/__snapshots__/MarkersContainer.spec.tsx.snap?ref=9df473178b70387cccc8dcc9a595f7673491a639",
      "patch": "@@ -16,6 +16,7 @@ exports[`renders all markers 1`] = `\n                   \"COMMENT_DETECTED_BANNED_WORD\": 1,\n                   \"COMMENT_DETECTED_LINKS\": 1,\n                   \"COMMENT_DETECTED_RECENT_HISTORY\": 1,\n+                  \"COMMENT_DETECTED_REPEAT_POST\": 1,\n                   \"COMMENT_DETECTED_SPAM\": 1,\n                   \"COMMENT_DETECTED_SUSPECT_WORD\": 1,\n                   \"COMMENT_DETECTED_TOXIC\": 1,\n@@ -54,7 +55,7 @@ exports[`renders all markers 1`] = `\n     <withPropsOnChange(Marker)\n       color=\"primary\"\n     >\n-      Pre-Mod\n+      Pre-mod\n     </withPropsOnChange(Marker)>\n   </Localized>\n   <Localized\n@@ -72,7 +73,7 @@ exports[`renders all markers 1`] = `\n     <withPropsOnChange(Marker)\n       color=\"error\"\n     >\n-      Banned Word\n+      Banned word\n     </withPropsOnChange(Marker)>\n   </Localized>\n   <Localized\n@@ -82,7 +83,7 @@ exports[`renders all markers 1`] = `\n       color=\"error\"\n       variant=\"filled\"\n     >\n-      Suspect Word\n+      Suspect word\n     </withPropsOnChange(Marker)>\n   </Localized>\n   <Localized\n@@ -91,7 +92,7 @@ exports[`renders all markers 1`] = `\n     <withPropsOnChange(Marker)\n       color=\"error\"\n     >\n-      Spam Detected\n+      Spam detected\n     </withPropsOnChange(Marker)>\n   </Localized>\n   <Localized\n@@ -103,13 +104,22 @@ exports[`renders all markers 1`] = `\n       Toxic\n     </withPropsOnChange(Marker)>\n   </Localized>\n+  <Localized\n+    id=\"moderate-marker-repeatPost\"\n+  >\n+    <withPropsOnChange(Marker)\n+      color=\"error\"\n+    >\n+      Repeat comment\n+    </withPropsOnChange(Marker)>\n+  </Localized>\n   <Localized\n     id=\"moderate-marker-recentHistory\"\n   >\n     <withPropsOnChange(Marker)\n       color=\"error\"\n     >\n-      Recent History\n+      Recent history\n     </withPropsOnChange(Marker)>\n   </Localized>\n   <withPropsOnChange(Marker)\n@@ -161,6 +171,7 @@ exports[`renders some markers 1`] = `\n                   \"COMMENT_DETECTED_BANNED_WORD\": 1,\n                   \"COMMENT_DETECTED_LINKS\": 0,\n                   \"COMMENT_DETECTED_RECENT_HISTORY\": 1,\n+                  \"COMMENT_DETECTED_REPEAT_POST\": 0,\n                   \"COMMENT_DETECTED_SPAM\": 0,\n                   \"COMMENT_DETECTED_SUSPECT_WORD\": 0,\n                   \"COMMENT_DETECTED_TOXIC\": 1,\n@@ -199,7 +210,7 @@ exports[`renders some markers 1`] = `\n     <withPropsOnChange(Marker)\n       color=\"primary\"\n     >\n-      Pre-Mod\n+      Pre-mod\n     </withPropsOnChange(Marker)>\n   </Localized>\n   <Localized\n@@ -208,7 +219,7 @@ exports[`renders some markers 1`] = `\n     <withPropsOnChange(Marker)\n       color=\"error\"\n     >\n-      Banned Word\n+      Banned word\n     </withPropsOnChange(Marker)>\n   </Localized>\n   <Localized\n@@ -226,7 +237,7 @@ exports[`renders some markers 1`] = `\n     <withPropsOnChange(Marker)\n       color=\"error\"\n     >\n-      Recent History\n+      Recent history\n     </withPropsOnChange(Marker)>\n   </Localized>\n   <withPropsOnChange(Marker)"
    },
    {
      "sha": "2f352e090698b43924161ff702c5410fd4a7ed16",
      "filename": "src/core/client/admin/test/fixtures.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/9df473178b70387cccc8dcc9a595f7673491a639/src/core/client/admin/test/fixtures.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/9df473178b70387cccc8dcc9a595f7673491a639/src/core/client/admin/test/fixtures.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/fixtures.ts?ref=9df473178b70387cccc8dcc9a595f7673491a639",
      "patch": "@@ -526,6 +526,7 @@ export const baseComment = createFixture<GQLComment>({\n           COMMENT_DETECTED_SUSPECT_WORD: 0,\n           COMMENT_REPORTED_OFFENSIVE: 0,\n           COMMENT_REPORTED_SPAM: 0,\n+          COMMENT_DETECTED_REPEAT_POST: 0,\n         },\n       },\n     },"
    },
    {
      "sha": "6c7327d41aa2cdd3e08d7029152efbbea4c6ffe9",
      "filename": "src/core/client/admin/test/moderate/__snapshots__/regularQueue.spec.tsx.snap",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/9df473178b70387cccc8dcc9a595f7673491a639/src/core/client/admin/test/moderate/__snapshots__/regularQueue.spec.tsx.snap",
      "raw_url": "https://github.com/coralproject/talk/raw/9df473178b70387cccc8dcc9a595f7673491a639/src/core/client/admin/test/moderate/__snapshots__/regularQueue.spec.tsx.snap",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/moderate/__snapshots__/regularQueue.spec.tsx.snap?ref=9df473178b70387cccc8dcc9a595f7673491a639",
      "patch": "@@ -1550,7 +1550,7 @@ exports[`renders reported queue with comments and load more 1`] = `\n               <span\n                 className=\"Marker-root Marker-colorPrimary Marker-variantRegular\"\n               >\n-                Pre-Mod\n+                Pre-mod\n               </span>\n               <span\n                 className=\"Marker-root Marker-colorError Marker-variantRegular\""
    },
    {
      "sha": "7853896fedaa260ecdcbb0ae83e4e59fd303981a",
      "filename": "src/core/client/test/helpers/fixture.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/9df473178b70387cccc8dcc9a595f7673491a639/src/core/client/test/helpers/fixture.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/9df473178b70387cccc8dcc9a595f7673491a639/src/core/client/test/helpers/fixture.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/test/helpers/fixture.ts?ref=9df473178b70387cccc8dcc9a595f7673491a639",
      "patch": "@@ -100,6 +100,7 @@ export function createComment(author?: GQLUser) {\n             COMMENT_DETECTED_SUSPECT_WORD: 0,\n             COMMENT_REPORTED_OFFENSIVE: 0,\n             COMMENT_REPORTED_SPAM: 0,\n+            COMMENT_DETECTED_REPEAT_POST: 0,\n           },\n         },\n       },\n@@ -147,6 +148,7 @@ export function createComment(author?: GQLUser) {\n           COMMENT_DETECTED_BANNED_WORD: 0,\n           COMMENT_DETECTED_SUSPECT_WORD: 0,\n           COMMENT_DETECTED_PREMOD_USER: 0,\n+          COMMENT_DETECTED_REPEAT_POST: 0,\n         },\n       },\n     },"
    },
    {
      "sha": "6b2e6246bf2ffc98778b51a6775c2071b1b91df1",
      "filename": "src/core/common/constants.ts",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/coralproject/talk/blob/9df473178b70387cccc8dcc9a595f7673491a639/src/core/common/constants.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/9df473178b70387cccc8dcc9a595f7673491a639/src/core/common/constants.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/common/constants.ts?ref=9df473178b70387cccc8dcc9a595f7673491a639",
      "patch": "@@ -63,3 +63,9 @@ export const COMMENT_LIMIT_WINDOW_SECONDS = 3;\n  * DEFAULT_SESSION_LENTTH is the length of time in seconds a session is valid for unless configured in tenant.\n  */\n export const DEFAULT_SESSION_LENGTH = 7776000;\n+\n+/**\n+ * COMMENT_REPEAT_POST_TIMESPAN is the length of time in seconds that a previous comment ID is stored for a\n+ * user to prevent them from posting the same comment repeatedly.\n+ */\n+export const COMMENT_REPEAT_POST_TIMESPAN = 21600;"
    },
    {
      "sha": "3f5b8111d634bc71cc6b3931e29bd157d04bd2cb",
      "filename": "src/core/common/errors.ts",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/coralproject/talk/blob/9df473178b70387cccc8dcc9a595f7673491a639/src/core/common/errors.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/9df473178b70387cccc8dcc9a595f7673491a639/src/core/common/errors.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/common/errors.ts?ref=9df473178b70387cccc8dcc9a595f7673491a639",
      "patch": "@@ -316,4 +316,10 @@ export enum ERROR_CODES {\n   RAW_QUERY_NOT_AUTHORIZED = \"RAW_QUERY_NOT_AUTHORIZED\",\n \n   USER_ALREADY_PREMOD = \"USER_ALREADY_PREMOD\",\n+\n+  /**\n+   * REPEAT_POST is returned if a user attempts to post the same comment more than once\n+   * in a row within a given time frame\n+   */\n+  REPEAT_POST = \"REPEAT_POST\",\n }"
    },
    {
      "sha": "6653aa9dae9b5398538455da9ab5be3469bbad9c",
      "filename": "src/core/server/errors/index.ts",
      "status": "modified",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/coralproject/talk/blob/9df473178b70387cccc8dcc9a595f7673491a639/src/core/server/errors/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/9df473178b70387cccc8dcc9a595f7673491a639/src/core/server/errors/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/errors/index.ts?ref=9df473178b70387cccc8dcc9a595f7673491a639",
      "patch": "@@ -580,6 +580,16 @@ export class SpamCommentError extends CoralError {\n   }\n }\n \n+export class RepeatPostCommentError extends CoralError {\n+  constructor() {\n+    super({\n+      code: ERROR_CODES.REPEAT_POST,\n+      type: ERROR_TYPES.MODERATION_NUDGE_ERROR,\n+      status: 400,\n+    });\n+  }\n+}\n+\n export class UserAlreadySuspendedError extends CoralError {\n   constructor(until: Date) {\n     super({"
    },
    {
      "sha": "4dc296d21d18b70cd123462b8186c656f26181c5",
      "filename": "src/core/server/errors/translations.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/9df473178b70387cccc8dcc9a595f7673491a639/src/core/server/errors/translations.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/9df473178b70387cccc8dcc9a595f7673491a639/src/core/server/errors/translations.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/errors/translations.ts?ref=9df473178b70387cccc8dcc9a595f7673491a639",
      "patch": "@@ -55,4 +55,5 @@ export const ERROR_TRANSLATIONS: Record<ERROR_CODES, string> = {\n   PERSISTED_QUERY_NOT_FOUND: \"error-persistedQueryNotFound\",\n   RAW_QUERY_NOT_AUTHORIZED: \"error-rawQueryNotAuthorized\",\n   USER_ALREADY_PREMOD: \"error-userAlreadyPremod\",\n+  REPEAT_POST: \"error-repeatPost\",\n };"
    },
    {
      "sha": "554b2bbbc130d93a7d6bf54ca72c2264c025cd5e",
      "filename": "src/core/server/graph/tenant/schema/schema.graphql",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/9df473178b70387cccc8dcc9a595f7673491a639/src/core/server/graph/tenant/schema/schema.graphql",
      "raw_url": "https://github.com/coralproject/talk/raw/9df473178b70387cccc8dcc9a595f7673491a639/src/core/server/graph/tenant/schema/schema.graphql",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/tenant/schema/schema.graphql?ref=9df473178b70387cccc8dcc9a595f7673491a639",
      "patch": "@@ -146,6 +146,11 @@ enum COMMENT_FLAG_DETECTED_REASON {\n   COMMENT_DETECTED_PREMOD_USER is used when a Comment author has been tagged as requiring premoderation\n   \"\"\"\n   COMMENT_DETECTED_PREMOD_USER\n+\n+  \"\"\"\n+  COMMENT_DETECTED_REPEAT_POST is used when a Comment's text exactly matches a previous recent comment from the same author\n+  \"\"\"\n+  COMMENT_DETECTED_REPEAT_POST\n }\n \n \"\"\"\n@@ -163,6 +168,7 @@ enum COMMENT_FLAG_REASON {\n   COMMENT_DETECTED_SUSPECT_WORD\n   COMMENT_DETECTED_RECENT_HISTORY\n   COMMENT_DETECTED_PREMOD_USER\n+  COMMENT_DETECTED_REPEAT_POST\n }\n \n \"\"\"\n@@ -198,6 +204,7 @@ type FlagReasonActionCounts {\n   COMMENT_DETECTED_SUSPECT_WORD: Int!\n   COMMENT_DETECTED_RECENT_HISTORY: Int!\n   COMMENT_DETECTED_PREMOD_USER: Int!\n+  COMMENT_DETECTED_REPEAT_POST: Int!\n }\n \n type Flag {"
    },
    {
      "sha": "ae0e998ffc2629e9ff3f6229a981ed72e7cfb55c",
      "filename": "src/core/server/locales/en-US/errors.ftl",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/9df473178b70387cccc8dcc9a595f7673491a639/src/core/server/locales/en-US/errors.ftl",
      "raw_url": "https://github.com/coralproject/talk/raw/9df473178b70387cccc8dcc9a595f7673491a639/src/core/server/locales/en-US/errors.ftl",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/locales/en-US/errors.ftl?ref=9df473178b70387cccc8dcc9a595f7673491a639",
      "patch": "@@ -57,3 +57,4 @@ error-passwordIncorrect = Incorrect password. Please try again.\n error-usernameAlreadyUpdated = You may only change your username once every { framework-timeago-time }.\n error-persistedQueryNotFound = The persisted query with ID { $id } was not found.\n error-rawQueryNotAuthorized = You are not authorized to execute this query.\n+error-repeatPost = Are you sure? This comment is very similar to your previous comment."
    },
    {
      "sha": "231b48750ca63c0ce5f2e5dac8c9ea571df53674",
      "filename": "src/core/server/models/action/__snapshots__/comment.spec.ts.snap",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/9df473178b70387cccc8dcc9a595f7673491a639/src/core/server/models/action/__snapshots__/comment.spec.ts.snap",
      "raw_url": "https://github.com/coralproject/talk/raw/9df473178b70387cccc8dcc9a595f7673491a639/src/core/server/models/action/__snapshots__/comment.spec.ts.snap",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/action/__snapshots__/comment.spec.ts.snap?ref=9df473178b70387cccc8dcc9a595f7673491a639",
      "patch": "@@ -21,6 +21,7 @@ Object {\n       \"COMMENT_DETECTED_LINKS\": 0,\n       \"COMMENT_DETECTED_PREMOD_USER\": 0,\n       \"COMMENT_DETECTED_RECENT_HISTORY\": 0,\n+      \"COMMENT_DETECTED_REPEAT_POST\": 0,\n       \"COMMENT_DETECTED_SPAM\": 0,\n       \"COMMENT_DETECTED_SUSPECT_WORD\": 0,\n       \"COMMENT_DETECTED_TOXIC\": 0,"
    },
    {
      "sha": "8e1abca9826617f97a38762b8f24facc73d25fd3",
      "filename": "src/core/server/services/comments/comments.ts",
      "status": "modified",
      "additions": 6,
      "deletions": 1,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/9df473178b70387cccc8dcc9a595f7673491a639/src/core/server/services/comments/comments.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/9df473178b70387cccc8dcc9a595f7673491a639/src/core/server/services/comments/comments.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/comments/comments.ts?ref=9df473178b70387cccc8dcc9a595f7673491a639",
      "patch": "@@ -49,7 +49,10 @@ import {\n import { AugmentedRedis } from \"coral-server/services/redis\";\n import { Request } from \"coral-server/types/express\";\n \n-import { updateUserLastWroteCommentTimestamp } from \"../users\";\n+import {\n+  updateUserLastCommentID,\n+  updateUserLastWroteCommentTimestamp,\n+} from \"../users\";\n import { addCommentActions, CreateAction } from \"./actions\";\n import { calculateCounts, calculateCountsDiff } from \"./moderation/counts\";\n import { PhaseResult, processForModeration } from \"./pipeline\";\n@@ -186,6 +189,8 @@ export async function create(\n     now\n   );\n \n+  await updateUserLastCommentID(redis, tenant, author, comment.id);\n+\n   // Pull the revision out.\n   const revision = getLatestRevision(comment);\n "
    },
    {
      "sha": "0895cb926a4ba547f6a25c1f803daf24553dec56",
      "filename": "src/core/server/services/comments/pipeline/phases/index.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/9df473178b70387cccc8dcc9a595f7673491a639/src/core/server/services/comments/pipeline/phases/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/9df473178b70387cccc8dcc9a595f7673491a639/src/core/server/services/comments/pipeline/phases/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/comments/pipeline/phases/index.ts?ref=9df473178b70387cccc8dcc9a595f7673491a639",
      "patch": "@@ -8,6 +8,7 @@ import { preModerate } from \"./preModerate\";\n import { premodUser } from \"./preModerateUser\";\n import { purify } from \"./purify\";\n import { recentCommentHistory } from \"./recentCommentHistory\";\n+import { repeatPost } from \"./repeatPost\";\n import { spam } from \"./spam\";\n import { staff } from \"./staff\";\n import { storyClosed } from \"./storyClosed\";\n@@ -25,6 +26,7 @@ export const moderationPhases: IntermediateModerationPhase[] = [\n   commentingDisabled,\n   linkify,\n   purify,\n+  repeatPost,\n   wordList,\n   staff,\n   toxic,"
    },
    {
      "sha": "6bd39ed774c03a1bfeff0461a89ea90e6aefcc2f",
      "filename": "src/core/server/services/comments/pipeline/phases/repeatPost.ts",
      "status": "added",
      "additions": 86,
      "deletions": 0,
      "changes": 86,
      "blob_url": "https://github.com/coralproject/talk/blob/9df473178b70387cccc8dcc9a595f7673491a639/src/core/server/services/comments/pipeline/phases/repeatPost.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/9df473178b70387cccc8dcc9a595f7673491a639/src/core/server/services/comments/pipeline/phases/repeatPost.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/comments/pipeline/phases/repeatPost.ts?ref=9df473178b70387cccc8dcc9a595f7673491a639",
      "patch": "@@ -0,0 +1,86 @@\n+import { RepeatPostCommentError } from \"coral-server/errors\";\n+import {\n+  GQLCOMMENT_FLAG_REASON,\n+  GQLCOMMENT_STATUS,\n+} from \"coral-server/graph/tenant/schema/__generated__/types\";\n+import logger from \"coral-server/logger\";\n+import { ACTION_TYPE } from \"coral-server/models/action/comment\";\n+import { getLatestRevision } from \"coral-server/models/comment/helpers\";\n+import {\n+  IntermediateModerationPhase,\n+  IntermediatePhaseResult,\n+} from \"coral-server/services/comments/pipeline\";\n+import { retrieveUserLastComment } from \"coral-server/services/users\";\n+\n+export const repeatPost: IntermediateModerationPhase = async ({\n+  story,\n+  mongo,\n+  tenant,\n+  comment,\n+  author,\n+  req,\n+  nudge,\n+  redis,\n+}): Promise<IntermediatePhaseResult | void> => {\n+  const log = logger.child(\n+    {\n+      tenantID: tenant.id,\n+    },\n+    true\n+  );\n+\n+  if (!comment.body) {\n+    return;\n+  }\n+\n+  try {\n+    log.trace(\"checking comment for repeat content\");\n+\n+    const lastComment = await retrieveUserLastComment(\n+      mongo,\n+      redis,\n+      tenant,\n+      author\n+    );\n+\n+    if (!lastComment) {\n+      return;\n+    }\n+\n+    const revision = getLatestRevision(lastComment);\n+    const isRepeatComment = revision.body === comment.body;\n+\n+    if (isRepeatComment) {\n+      log.trace({ isRepeatComment }, \"comment contains repeat content\");\n+\n+      // Throw an error if we're nudging instead of recording.\n+      if (nudge) {\n+        throw new RepeatPostCommentError();\n+      }\n+\n+      return {\n+        status: GQLCOMMENT_STATUS.SYSTEM_WITHHELD,\n+        actions: [\n+          {\n+            userID: null,\n+            actionType: ACTION_TYPE.FLAG,\n+            reason: GQLCOMMENT_FLAG_REASON.COMMENT_DETECTED_REPEAT_POST,\n+          },\n+        ],\n+        metadata: {},\n+      };\n+    }\n+\n+    log.trace({ isRepeatComment }, \"comment is not repeated\");\n+  } catch (err) {\n+    // Rethrow any RepeatPostError.\n+    if (err instanceof RepeatPostCommentError) {\n+      throw err;\n+    }\n+\n+    log.error(\n+      { err },\n+      \"could not determine if comment contained duplicate content\"\n+    );\n+  }\n+};"
    },
    {
      "sha": "de1173db7e924581f894b4901b1d1b3144a7e877",
      "filename": "src/core/server/services/users/users.ts",
      "status": "modified",
      "additions": 52,
      "deletions": 0,
      "changes": 52,
      "blob_url": "https://github.com/coralproject/talk/blob/9df473178b70387cccc8dcc9a595f7673491a639/src/core/server/services/users/users.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/9df473178b70387cccc8dcc9a595f7673491a639/src/core/server/services/users/users.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/users/users.ts?ref=9df473178b70387cccc8dcc9a595f7673491a639",
      "patch": "@@ -4,6 +4,7 @@ import { Db } from \"mongodb\";\n import {\n   ALLOWED_USERNAME_CHANGE_FREQUENCY,\n   COMMENT_LIMIT_WINDOW_SECONDS,\n+  COMMENT_REPEAT_POST_TIMESPAN,\n   DOWNLOAD_LIMIT_TIMEFRAME,\n } from \"coral-common/constants\";\n import { SCHEDULED_DELETION_TIMESPAN_DAYS } from \"coral-common/constants\";\n@@ -31,6 +32,7 @@ import {\n   GQLUSER_ROLE,\n } from \"coral-server/graph/tenant/schema/__generated__/types\";\n import logger from \"coral-server/logger\";\n+import { Comment, retrieveComment } from \"coral-server/models/comment\";\n import { Tenant } from \"coral-server/models/tenant\";\n import {\n   banUser,\n@@ -1190,6 +1192,13 @@ function userLastWroteCommentTimestampKey(\n   return `${tenant.id}:lastCommentTimestamp:${user.id}`;\n }\n \n+function userLastCommentIDKey(\n+  tenant: Pick<Tenant, \"id\">,\n+  user: Pick<User, \"id\">\n+) {\n+  return `${tenant.id}:lastCommentID:${user.id}`;\n+}\n+\n /**\n  * retrieveUserLastWroteCommentTimestamp will return the timestamp (if set) that\n  * the user last wrote a comment on. This will return null if the comment was\n@@ -1245,3 +1254,46 @@ export async function updateUserLastWroteCommentTimestamp(\n     throw new RateLimitExceeded(\"createComment\", 1);\n   }\n }\n+\n+/**\n+ * updateUserLastCommentID will update the id of the users most recent comment.\n+ *\n+ * @param redis the Redis instance that Coral interacts with\n+ * @param tenant the Tenant to operate on\n+ * @param user the User that we're setting the limit for\n+ * @param commentID the id of the comment\n+ */\n+export async function updateUserLastCommentID(\n+  redis: AugmentedRedis,\n+  tenant: Tenant,\n+  user: User,\n+  commentID: string\n+) {\n+  const key = userLastCommentIDKey(tenant, user);\n+\n+  await redis.set(key, commentID, \"EX\", COMMENT_REPEAT_POST_TIMESPAN);\n+}\n+\n+/**\n+ * retrieveUserLastComment will return the id (if set) of the comment that\n+ * the user last wrote. This will return null if the user has not made a comment\n+ * within the CURRENT_REPEAT_POST_TIMESPAN.\n+ *\n+ * @param mongo the db\n+ * @param redis the Redis instance that Coral interacts with\n+ * @param tenant the Tenant to operate on\n+ * @param user the User that we're looking up the limit for\n+ */\n+export async function retrieveUserLastComment(\n+  mongo: Db,\n+  redis: AugmentedRedis,\n+  tenant: Tenant,\n+  user: User\n+): Promise<Readonly<Comment> | null> {\n+  const id: string | null = await redis.get(userLastCommentIDKey(tenant, user));\n+  if (!id) {\n+    return null;\n+  }\n+\n+  return retrieveComment(mongo, tenant.id, id);\n+}"
    },
    {
      "sha": "5be68f0be389b32cfe88009f6ea095a0f32abdf5",
      "filename": "src/locales/en-US/admin.ftl",
      "status": "modified",
      "additions": 7,
      "deletions": 6,
      "changes": 13,
      "blob_url": "https://github.com/coralproject/talk/blob/9df473178b70387cccc8dcc9a595f7673491a639/src/locales/en-US/admin.ftl",
      "raw_url": "https://github.com/coralproject/talk/raw/9df473178b70387cccc8dcc9a595f7673491a639/src/locales/en-US/admin.ftl",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/locales/en-US/admin.ftl?ref=9df473178b70387cccc8dcc9a595f7673491a639",
      "patch": "@@ -387,16 +387,17 @@ moderate-navigation-pending = Pending\n moderate-navigation-unmoderated = unmoderated\n moderate-navigation-rejected = rejected\n \n-moderate-marker-preMod = Pre-Mod\n+moderate-marker-preMod = Pre-mod\n moderate-marker-link = Link\n-moderate-marker-bannedWord = Banned Word\n-moderate-marker-suspectWord = Suspect Word\n+moderate-marker-bannedWord = Banned word\n+moderate-marker-suspectWord = Suspect word\n moderate-marker-spam = Spam\n-moderate-marker-spamDetected = Spam Detected\n+moderate-marker-spamDetected = Spam detected\n moderate-marker-toxic = Toxic\n-moderate-marker-recentHistory = Recent History\n-moderate-marker-bodyCount = Body Count\n+moderate-marker-recentHistory = Recent history\n+moderate-marker-bodyCount = Body count\n moderate-marker-offensive = Offensive\n+moderate-marker-repeatPost = Repeat comment\n \n moderate-markers-details = Details\n moderate-flagDetails-offensive = Offensive"
    }
  ]
}
