{
  "sha": "74869b8a7f49aa634d1a2dac740eed45eca72c5a",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODo3NDg2OWI4YTdmNDlhYTYzNGQxYTJkYWM3NDBlZWQ0NWVjYTcyYzVh",
  "commit": {
    "author": {
      "name": "Penar Musaraj",
      "email": "pmusaraj@gmail.com",
      "date": "2019-11-04T14:16:50Z"
    },
    "committer": {
      "name": "Penar Musaraj",
      "email": "pmusaraj@gmail.com",
      "date": "2019-11-04T14:16:50Z"
    },
    "message": "FIX: Do not consider mobile app traffic as crawler visits\n\nFollowup to a4eb523a",
    "tree": {
      "sha": "f23af2c820da4f32bfb50822ddb0cb3323cfdda9",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/f23af2c820da4f32bfb50822ddb0cb3323cfdda9"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/74869b8a7f49aa634d1a2dac740eed45eca72c5a",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/74869b8a7f49aa634d1a2dac740eed45eca72c5a",
  "html_url": "https://github.com/discourse/discourse/commit/74869b8a7f49aa634d1a2dac740eed45eca72c5a",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/74869b8a7f49aa634d1a2dac740eed45eca72c5a/comments",
  "author": {
    "login": "pmusaraj",
    "id": 368961,
    "node_id": "MDQ6VXNlcjM2ODk2MQ==",
    "avatar_url": "https://avatars1.githubusercontent.com/u/368961?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pmusaraj",
    "html_url": "https://github.com/pmusaraj",
    "followers_url": "https://api.github.com/users/pmusaraj/followers",
    "following_url": "https://api.github.com/users/pmusaraj/following{/other_user}",
    "gists_url": "https://api.github.com/users/pmusaraj/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pmusaraj/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pmusaraj/subscriptions",
    "organizations_url": "https://api.github.com/users/pmusaraj/orgs",
    "repos_url": "https://api.github.com/users/pmusaraj/repos",
    "events_url": "https://api.github.com/users/pmusaraj/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pmusaraj/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "pmusaraj",
    "id": 368961,
    "node_id": "MDQ6VXNlcjM2ODk2MQ==",
    "avatar_url": "https://avatars1.githubusercontent.com/u/368961?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pmusaraj",
    "html_url": "https://github.com/pmusaraj",
    "followers_url": "https://api.github.com/users/pmusaraj/followers",
    "following_url": "https://api.github.com/users/pmusaraj/following{/other_user}",
    "gists_url": "https://api.github.com/users/pmusaraj/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pmusaraj/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pmusaraj/subscriptions",
    "organizations_url": "https://api.github.com/users/pmusaraj/orgs",
    "repos_url": "https://api.github.com/users/pmusaraj/repos",
    "events_url": "https://api.github.com/users/pmusaraj/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pmusaraj/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "f3f04f16436bc414eed6c1f3c646d7e1a43ef953",
      "url": "https://api.github.com/repos/discourse/discourse/commits/f3f04f16436bc414eed6c1f3c646d7e1a43ef953",
      "html_url": "https://github.com/discourse/discourse/commit/f3f04f16436bc414eed6c1f3c646d7e1a43ef953"
    }
  ],
  "stats": {
    "total": 21,
    "additions": 17,
    "deletions": 4
  },
  "files": [
    {
      "sha": "8c4ccc6afeb6fbc4bcc90024b1e2e21da7118b5a",
      "filename": "lib/middleware/anonymous_cache.rb",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/discourse/discourse/blob/74869b8a7f49aa634d1a2dac740eed45eca72c5a/lib/middleware/anonymous_cache.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/74869b8a7f49aa634d1a2dac740eed45eca72c5a/lib/middleware/anonymous_cache.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/lib/middleware/anonymous_cache.rb?ref=74869b8a7f49aa634d1a2dac740eed45eca72c5a",
      "patch": "@@ -66,7 +66,7 @@ def is_crawler?\n             if @env[DISCOURSE_RENDER] == \"crawler\" || CrawlerDetection.crawler?(user_agent, @env[\"HTTP_VIA\"])\n               :true\n             else\n-              user_agent.downcase.include?(\"discourse\") ? :true : :false\n+              user_agent.downcase.include?(\"discourse\") && !user_agent.downcase.include?(\"mobile\") ? :true : :false\n             end\n           end\n         @is_crawler == :true"
    },
    {
      "sha": "22fad3addc51d9494923bbfaa0e198e8a9be6220",
      "filename": "spec/components/middleware/request_tracker_spec.rb",
      "status": "modified",
      "additions": 16,
      "deletions": 3,
      "changes": 19,
      "blob_url": "https://github.com/discourse/discourse/blob/74869b8a7f49aa634d1a2dac740eed45eca72c5a/spec/components/middleware/request_tracker_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/74869b8a7f49aa634d1a2dac740eed45eca72c5a/spec/components/middleware/request_tracker_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/components/middleware/request_tracker_spec.rb?ref=74869b8a7f49aa634d1a2dac740eed45eca72c5a",
      "patch": "@@ -68,17 +68,30 @@ def log_tracked_view(val)\n       expect(ApplicationRequest.page_view_crawler.first.count).to eq(1)\n       expect(ApplicationRequest.page_view_anon_mobile.first.count).to eq(1)\n \n-      # log discourse User Agent requests as crawler for page views\n+      expect(ApplicationRequest.page_view_crawler.first.count).to eq(1)\n+    end\n+\n+    it \"can log Discourse user agent requests correctly\" do\n+      # log discourse api agents as crawlers for page view stats...\n       data = Middleware::RequestTracker.get_data(env(\n         \"HTTP_USER_AGENT\" => \"DiscourseAPI Ruby Gem 0.19.0\"\n       ), [\"200\", { \"Content-Type\" => 'text/html' }], 0.1)\n \n       Middleware::RequestTracker.log_request(data)\n       ApplicationRequest.write_cache!\n+      expect(ApplicationRequest.page_view_crawler.first.count).to eq(1)\n \n-      expect(ApplicationRequest.page_view_crawler.first.count).to eq(2)\n-    end\n+      # ...but count our mobile app user agents as regular visits\n+      data = Middleware::RequestTracker.get_data(env(\n+        \"HTTP_USER_AGENT\" => \"Mozilla/5.0 AppleWebKit/605.1.15 Mobile/15E148 DiscourseHub)\"\n+      ), [\"200\", { \"Content-Type\" => 'text/html' }], 0.1)\n+\n+      Middleware::RequestTracker.log_request(data)\n+      ApplicationRequest.write_cache!\n \n+      expect(ApplicationRequest.page_view_crawler.first.count).to eq(1)\n+      expect(ApplicationRequest.page_view_anon.first.count).to eq(1)\n+    end\n   end\n \n   context \"rate limiting\" do"
    }
  ]
}
