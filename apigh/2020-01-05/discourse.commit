{
  "sha": "d0630ea6eee88b0931ca0458940ddcd653af8159",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODpkMDYzMGVhNmVlZTg4YjA5MzFjYTA0NTg5NDBkZGNkNjUzYWY4MTU5",
  "commit": {
    "author": {
      "name": "Sam Saffron",
      "email": "sam.saffron@gmail.com",
      "date": "2020-01-05T11:08:13Z"
    },
    "committer": {
      "name": "Sam Saffron",
      "email": "sam.saffron@gmail.com",
      "date": "2020-01-05T11:08:13Z"
    },
    "message": "FIX: MaxMind DB file not downloading correctly\n\nPreviously we had the ability to download a simple .gz file\nnew changes mean we have a a tar.gz file that needs some levels\nof fiddling to get extracted correctly",
    "tree": {
      "sha": "280798b9a996cf1bad67f3c2756a8b6f3ea484b4",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/280798b9a996cf1bad67f3c2756a8b6f3ea484b4"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/d0630ea6eee88b0931ca0458940ddcd653af8159",
    "comment_count": 1,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/d0630ea6eee88b0931ca0458940ddcd653af8159",
  "html_url": "https://github.com/discourse/discourse/commit/d0630ea6eee88b0931ca0458940ddcd653af8159",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/d0630ea6eee88b0931ca0458940ddcd653af8159/comments",
  "author": {
    "login": "SamSaffron",
    "id": 5213,
    "node_id": "MDQ6VXNlcjUyMTM=",
    "avatar_url": "https://avatars1.githubusercontent.com/u/5213?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/SamSaffron",
    "html_url": "https://github.com/SamSaffron",
    "followers_url": "https://api.github.com/users/SamSaffron/followers",
    "following_url": "https://api.github.com/users/SamSaffron/following{/other_user}",
    "gists_url": "https://api.github.com/users/SamSaffron/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/SamSaffron/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/SamSaffron/subscriptions",
    "organizations_url": "https://api.github.com/users/SamSaffron/orgs",
    "repos_url": "https://api.github.com/users/SamSaffron/repos",
    "events_url": "https://api.github.com/users/SamSaffron/events{/privacy}",
    "received_events_url": "https://api.github.com/users/SamSaffron/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "SamSaffron",
    "id": 5213,
    "node_id": "MDQ6VXNlcjUyMTM=",
    "avatar_url": "https://avatars1.githubusercontent.com/u/5213?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/SamSaffron",
    "html_url": "https://github.com/SamSaffron",
    "followers_url": "https://api.github.com/users/SamSaffron/followers",
    "following_url": "https://api.github.com/users/SamSaffron/following{/other_user}",
    "gists_url": "https://api.github.com/users/SamSaffron/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/SamSaffron/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/SamSaffron/subscriptions",
    "organizations_url": "https://api.github.com/users/SamSaffron/orgs",
    "repos_url": "https://api.github.com/users/SamSaffron/repos",
    "events_url": "https://api.github.com/users/SamSaffron/events{/privacy}",
    "received_events_url": "https://api.github.com/users/SamSaffron/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "9a6606dd305f4f32ed464838fb4d85ac4788f259",
      "url": "https://api.github.com/repos/discourse/discourse/commits/9a6606dd305f4f32ed464838fb4d85ac4788f259",
      "html_url": "https://github.com/discourse/discourse/commit/9a6606dd305f4f32ed464838fb4d85ac4788f259"
    }
  ],
  "stats": {
    "total": 28,
    "additions": 25,
    "deletions": 3
  },
  "files": [
    {
      "sha": "6aa0f165055e6a1da8f66c74f3772bc5089cf647",
      "filename": "lib/discourse_ip_info.rb",
      "status": "modified",
      "additions": 25,
      "deletions": 3,
      "changes": 28,
      "blob_url": "https://github.com/discourse/discourse/blob/d0630ea6eee88b0931ca0458940ddcd653af8159/lib/discourse_ip_info.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/d0630ea6eee88b0931ca0458940ddcd653af8159/lib/discourse_ip_info.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/lib/discourse_ip_info.rb?ref=d0630ea6eee88b0931ca0458940ddcd653af8159",
      "patch": "@@ -44,11 +44,33 @@ def self.mmdb_download(name)\n       follow_redirect: false\n     )\n \n-    Discourse::Utils.execute_command(\"gunzip\", gz_file.path)\n+    filename = File.basename(gz_file.path)\n+\n+    dir = \"#{Dir.tmpdir}/#{SecureRandom.hex}\"\n+\n+    Discourse::Utils.execute_command(\n+      \"mkdir\", \"-p\", dir\n+    )\n+\n+    Discourse::Utils.execute_command(\n+      \"cp\",\n+      gz_file.path,\n+      \"#{dir}/#{filename}\"\n+    )\n+\n+    Discourse::Utils.execute_command(\n+      \"tar\",\n+      \"-xzvf\",\n+      \"#{dir}/#{filename}\",\n+      chdir: dir\n+    )\n+\n+    Dir[\"#{dir}/**/*.mmdb\"].each do |f|\n+      FileUtils.mv(f, mmdb_path(name))\n+    end\n \n-    path = gz_file.path.sub(/\\.gz\\z/, \"\")\n-    FileUtils.mv(path, mmdb_path(name))\n   ensure\n+    FileUtils.rm_r(dir, force: true) if dir\n     gz_file&.close!\n   end\n "
    }
  ]
}
