{
  "sha": "0dc3e8968a345f6f6591bc4cbe0773c06953ace8",
  "node_id": "MDY6Q29tbWl0NzI0NTQyNDI6MGRjM2U4OTY4YTM0NWY2ZjY1OTFiYzRjYmUwNzczYzA2OTUzYWNlOA==",
  "commit": {
    "author": {
      "name": "Wyatt Johnson",
      "email": "wyattjoh@gmail.com",
      "date": "2020-01-06T16:14:56Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2020-01-06T16:14:56Z"
    },
    "message": "fix: package upgrade (#2777)\n\nUpgraded some packages to latest. This should resolve #2774. Fixes were\r\nalso applied after types upgrades that helped discover other errors.",
    "tree": {
      "sha": "eed7114bfbed4b5e7c4f3ca587cc5e3db6661564",
      "url": "https://api.github.com/repos/coralproject/talk/git/trees/eed7114bfbed4b5e7c4f3ca587cc5e3db6661564"
    },
    "url": "https://api.github.com/repos/coralproject/talk/git/commits/0dc3e8968a345f6f6591bc4cbe0773c06953ace8",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeE10ACRBK7hj4Ov3rIwAAdHIIACjhN+NuHhlguRb6QQdJA2oI\ni0AJ8EQDL4tT6V2TUHdRINdCVCM2SGpLiC1/cdeiSoHB3Tg6edQx+8q7CPwbU/lB\n3fFC5LUWqnoTo+ZsVPsjMwAhjgOr6sj7qUJKXGK0jssWSUbClys5042IHAmVstXo\nmyWIm9K69OQCRR88eShF2oBhdTgI770S3go/tGLaiRuCwLp5ARHk4DcLuDMSjJDK\nuVk0dLzX2FO0JedHGMapyvkiEoUtCOjxnVQXAM5zr1PkGWwd15HzWSKlRdA6Kz9C\nhaBVN+TVuy9KPLEbrRltyeEgKvKoaQZUfWV/r0t2yDruvcMw4OIwSx/ORSYHnF4=\n=Kyrm\n-----END PGP SIGNATURE-----\n",
      "payload": "tree eed7114bfbed4b5e7c4f3ca587cc5e3db6661564\nparent f900050ef4976812363a5cdac6848096b9d12be2\nauthor Wyatt Johnson <wyattjoh@gmail.com> 1578327296 +0000\ncommitter GitHub <noreply@github.com> 1578327296 +0000\n\nfix: package upgrade (#2777)\n\nUpgraded some packages to latest. This should resolve #2774. Fixes were\r\nalso applied after types upgrades that helped discover other errors."
    }
  },
  "url": "https://api.github.com/repos/coralproject/talk/commits/0dc3e8968a345f6f6591bc4cbe0773c06953ace8",
  "html_url": "https://github.com/coralproject/talk/commit/0dc3e8968a345f6f6591bc4cbe0773c06953ace8",
  "comments_url": "https://api.github.com/repos/coralproject/talk/commits/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/comments",
  "author": {
    "login": "wyattjoh",
    "id": 633002,
    "node_id": "MDQ6VXNlcjYzMzAwMg==",
    "avatar_url": "https://avatars2.githubusercontent.com/u/633002?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wyattjoh",
    "html_url": "https://github.com/wyattjoh",
    "followers_url": "https://api.github.com/users/wyattjoh/followers",
    "following_url": "https://api.github.com/users/wyattjoh/following{/other_user}",
    "gists_url": "https://api.github.com/users/wyattjoh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wyattjoh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wyattjoh/subscriptions",
    "organizations_url": "https://api.github.com/users/wyattjoh/orgs",
    "repos_url": "https://api.github.com/users/wyattjoh/repos",
    "events_url": "https://api.github.com/users/wyattjoh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wyattjoh/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "f900050ef4976812363a5cdac6848096b9d12be2",
      "url": "https://api.github.com/repos/coralproject/talk/commits/f900050ef4976812363a5cdac6848096b9d12be2",
      "html_url": "https://github.com/coralproject/talk/commit/f900050ef4976812363a5cdac6848096b9d12be2"
    }
  ],
  "stats": {
    "total": 2051,
    "additions": 1396,
    "deletions": 655
  },
  "files": [
    {
      "sha": "acdf9dd8e3048df7790bd4065f3137760d36bbc2",
      "filename": "package-lock.json",
      "status": "modified",
      "additions": 1320,
      "deletions": 591,
      "changes": 1911,
      "blob_url": "https://github.com/coralproject/talk/blob/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/package-lock.json",
      "raw_url": "https://github.com/coralproject/talk/raw/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/package-lock.json",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/package-lock.json?ref=0dc3e8968a345f6f6591bc4cbe0773c06953ace8"
    },
    {
      "sha": "428038b3bd614e725a6d8d8191d8f847622b40d0",
      "filename": "package.json",
      "status": "modified",
      "additions": 29,
      "deletions": 29,
      "changes": 58,
      "blob_url": "https://github.com/coralproject/talk/blob/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/package.json",
      "raw_url": "https://github.com/coralproject/talk/raw/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/package.json",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/package.json?ref=0dc3e8968a345f6f6591bc4cbe0773c06953ace8",
      "patch": "@@ -58,27 +58,27 @@\n   \"license\": \"Apache-2.0\",\n   \"dependencies\": {\n     \"@coralproject/bunyan-prettystream\": \"^0.1.4\",\n-    \"@fluent/bundle\": \"^0.14.0\",\n+    \"@fluent/bundle\": \"^0.14.1\",\n     \"@fluent/dom\": \"^0.6.0\",\n     \"@metascraper/helpers\": \"^5.7.21\",\n     \"@types/prettier\": \"^1.19.0\",\n     \"abort-controller\": \"^3.0.0\",\n-    \"akismet-api\": \"^4.2.0\",\n-    \"apollo-server-express\": \"^2.8.1\",\n+    \"akismet-api\": \"^5.0.0\",\n+    \"apollo-server-express\": \"^2.9.15\",\n     \"archiver\": \"^3.0.3\",\n     \"basic-auth\": \"^2.0.1\",\n     \"bcryptjs\": \"^2.4.3\",\n-    \"bull\": \"^3.8.1\",\n+    \"bull\": \"^3.12.1\",\n     \"bunyan\": \"^1.8.12\",\n     \"cheerio\": \"^1.0.0-rc.2\",\n     \"consolidate\": \"0.14.0\",\n     \"content-security-policy-builder\": \"^2.0.0\",\n-    \"convict\": \"^4.3.1\",\n+    \"convict\": \"^5.2.0\",\n     \"cookie\": \"^0.4.0\",\n     \"cookie-parser\": \"^1.4.4\",\n-    \"cors\": \"^2.8.4\",\n-    \"cron\": \"^1.7.1\",\n-    \"csv-stringify\": \"^5.3.0\",\n+    \"cors\": \"^2.8.5\",\n+    \"cron\": \"^1.7.2\",\n+    \"csv-stringify\": \"^5.3.6\",\n     \"dataloader\": \"^1.4.0\",\n     \"dompurify\": \"^2.0.7\",\n     \"dotenv\": \"^6.0.0\",\n@@ -93,18 +93,18 @@\n     \"graphql-extensions\": \"^0.2.1\",\n     \"graphql-fields\": \"^1.1.0\",\n     \"graphql-playground-html\": \"^1.6.0\",\n-    \"graphql-redis-subscriptions\": \"^2.1.0\",\n+    \"graphql-redis-subscriptions\": \"^2.1.2\",\n     \"graphql-subscriptions\": \"^1.1.0\",\n     \"graphql-tools\": \"^3.0.5\",\n     \"helmet\": \"^3.21.2\",\n-    \"html-minifier\": \"^3.5.21\",\n-    \"html-to-text\": \"^4.0.0\",\n-    \"ioredis\": \"^4.9.0\",\n-    \"joi\": \"^13.4.0\",\n-    \"jsdom\": \"^15.0.0\",\n-    \"jsonwebtoken\": \"^8.3.0\",\n-    \"juice\": \"^5.2.0\",\n-    \"jwks-rsa\": \"^1.3.0\",\n+    \"html-minifier\": \"^4.0.0\",\n+    \"html-to-text\": \"^5.1.1\",\n+    \"ioredis\": \"^4.14.1\",\n+    \"joi\": \"^14.3.1\",\n+    \"jsdom\": \"^15.2.1\",\n+    \"jsonwebtoken\": \"^8.5.1\",\n+    \"juice\": \"^6.0.0\",\n+    \"jwks-rsa\": \"^1.6.0\",\n     \"keymaster\": \"^1.6.2\",\n     \"linkifyjs\": \"^2.1.8\",\n     \"lodash\": \"^4.17.15\",\n@@ -118,12 +118,12 @@\n     \"mongodb-core\": \"^3.2.7\",\n     \"ms\": \"^2.1.1\",\n     \"node-fetch\": \"^2.6.0\",\n-    \"nodemailer\": \"^4.6.7\",\n+    \"nodemailer\": \"^6.4.2\",\n     \"nunjucks\": \"^3.1.3\",\n     \"on-finished\": \"^2.3.0\",\n-    \"passport\": \"^0.4.0\",\n-    \"passport-facebook\": \"^2.1.1\",\n-    \"passport-google-oauth2\": \"^0.1.6\",\n+    \"passport\": \"^0.4.1\",\n+    \"passport-facebook\": \"^3.0.0\",\n+    \"passport-google-oauth2\": \"^0.2.0\",\n     \"passport-local\": \"^1.0.0\",\n     \"passport-oauth2\": \"^1.4.0\",\n     \"passport-strategy\": \"^1.0.0\",\n@@ -158,7 +158,7 @@\n     \"@types/archiver\": \"^3.0.0\",\n     \"@types/basic-auth\": \"^1.1.2\",\n     \"@types/bcryptjs\": \"^2.4.1\",\n-    \"@types/bull\": \"^3.5.12\",\n+    \"@types/bull\": \"^3.10.6\",\n     \"@types/bunyan\": \"^1.8.4\",\n     \"@types/case-sensitive-paths-webpack-plugin\": \"^2.1.2\",\n     \"@types/cheerio\": \"^0.22.8\",\n@@ -170,10 +170,10 @@\n     \"@types/convict\": \"^4.2.0\",\n     \"@types/cookie\": \"^0.3.3\",\n     \"@types/cookie-parser\": \"^1.4.1\",\n-    \"@types/cors\": \"^2.8.4\",\n+    \"@types/cors\": \"^2.8.6\",\n     \"@types/cron\": \"^1.7.1\",\n     \"@types/cross-spawn\": \"^6.0.0\",\n-    \"@types/dompurify\": \"0.0.33\",\n+    \"@types/dompurify\": \"^2.0.1\",\n     \"@types/dotenv\": \"^4.0.3\",\n     \"@types/enzyme\": \"^3.1.15\",\n     \"@types/enzyme-adapter-react-16\": \"^1.0.3\",\n@@ -187,12 +187,12 @@\n     \"@types/html-minifier\": \"^3.5.2\",\n     \"@types/html-to-text\": \"^1.4.31\",\n     \"@types/html-webpack-plugin\": \"^3.2.0\",\n-    \"@types/ioredis\": \"^4.0.10\",\n+    \"@types/ioredis\": \"^4.14.3\",\n     \"@types/jest\": \"^24.0.23\",\n     \"@types/jest-axe\": \"^3.2.1\",\n-    \"@types/joi\": \"^13.0.8\",\n+    \"@types/joi\": \"^14.3.4\",\n     \"@types/jsdom\": \"^12.2.3\",\n-    \"@types/jsonwebtoken\": \"^7.2.7\",\n+    \"@types/jsonwebtoken\": \"^8.3.5\",\n     \"@types/linkifyjs\": \"^2.1.1\",\n     \"@types/lodash\": \"^4.14.118\",\n     \"@types/lru-cache\": \"^5.1.0\",\n@@ -203,11 +203,11 @@\n     \"@types/ms\": \"^0.7.30\",\n     \"@types/node\": \"^10.5.2\",\n     \"@types/node-fetch\": \"^2.5.3\",\n-    \"@types/nodemailer\": \"^4.6.2\",\n+    \"@types/nodemailer\": \"^6.4.0\",\n     \"@types/nunjucks\": \"^3.1.1\",\n     \"@types/object-diff\": \"0.0.0\",\n     \"@types/on-finished\": \"^2.3.1\",\n-    \"@types/passport\": \"^0.4.6\",\n+    \"@types/passport\": \"^1.0.2\",\n     \"@types/passport-facebook\": \"^2.1.8\",\n     \"@types/passport-local\": \"^1.0.33\",\n     \"@types/passport-oauth2\": \"^1.4.5\","
    },
    {
      "sha": "463ccc3515afc2fc3decdd94b8a47f8b39957a72",
      "filename": "src/core/server/app/middleware/error.ts",
      "status": "modified",
      "additions": 5,
      "deletions": 6,
      "changes": 11,
      "blob_url": "https://github.com/coralproject/talk/blob/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/app/middleware/error.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/app/middleware/error.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/app/middleware/error.ts?ref=0dc3e8968a345f6f6591bc4cbe0773c06953ace8",
      "patch": "@@ -1,9 +1,8 @@\n import { FluentBundle } from \"@fluent/bundle/compat\";\n-import { ErrorRequestHandler } from \"express\";\n \n import { CoralError, InternalError } from \"coral-server/errors\";\n import { I18n } from \"coral-server/services/i18n\";\n-import { Request } from \"coral-server/types/express\";\n+import { ErrorRequestHandler, Request } from \"coral-server/types/express\";\n \n /**\n  * wrapError ensures that the error being propagated is a CoralError.\n@@ -45,10 +44,10 @@ export const JSONErrorHandler = (bundles?: I18n): ErrorRequestHandler => (\n   next\n ) => {\n   // Wrap the error if it needs to be wrapped.\n-  err = wrapError(err);\n+  const e = wrapError(err);\n \n   // Send the response via JSON.\n-  res.status(err.status).json(serializeError(err, req, bundles));\n+  res.status(e.status).json(serializeError(e, req, bundles));\n };\n \n export const HTMLErrorHandler = (bundles?: I18n): ErrorRequestHandler => (\n@@ -58,8 +57,8 @@ export const HTMLErrorHandler = (bundles?: I18n): ErrorRequestHandler => (\n   next\n ) => {\n   // Wrap the error if it needs to be wrapped.\n-  err = wrapError(err);\n+  const e = wrapError(err);\n \n   // Send the response via HTML.\n-  res.status(err.status).render(\"error\", serializeError(err, req, bundles));\n+  res.status(e.status).render(\"error\", serializeError(e, req, bundles));\n };"
    },
    {
      "sha": "10491ef55a7959a3e9471e013196f607ea288ad1",
      "filename": "src/core/server/app/middleware/passport/index.ts",
      "status": "modified",
      "additions": 3,
      "deletions": 1,
      "changes": 4,
      "blob_url": "https://github.com/coralproject/talk/blob/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/app/middleware/passport/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/app/middleware/passport/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/app/middleware/passport/index.ts?ref=0dc3e8968a345f6f6591bc4cbe0773c06953ace8",
      "patch": "@@ -286,7 +286,9 @@ export const authenticate = (\n       }\n \n       // Attach the user to the request.\n-      req.user = user;\n+      if (user) {\n+        req.user = user;\n+      }\n \n       return next();\n     }"
    },
    {
      "sha": "fba8a4d8bec7ccb3fcd98259a18a762eea674e3c",
      "filename": "src/core/server/app/middleware/passport/strategies/oidc/index.ts",
      "status": "modified",
      "additions": 19,
      "deletions": 5,
      "changes": 24,
      "blob_url": "https://github.com/coralproject/talk/blob/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/app/middleware/passport/strategies/oidc/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/app/middleware/passport/strategies/oidc/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/app/middleware/passport/strategies/oidc/index.ts?ref=0dc3e8968a345f6f6591bc4cbe0773c06953ace8",
      "patch": "@@ -1,6 +1,11 @@\n import Joi from \"joi\";\n import jwt from \"jsonwebtoken\";\n-import jwks, { JwksClient } from \"jwks-rsa\";\n+import jwks, {\n+  CertSigningKey,\n+  JwksClient,\n+  RsaSigningKey,\n+  SigningKey,\n+} from \"jwks-rsa\";\n import { isNil } from \"lodash\";\n import { Db } from \"mongodb\";\n import { Strategy as OAuth2Strategy, VerifyCallback } from \"passport-oauth2\";\n@@ -9,7 +14,6 @@ import { Strategy } from \"passport-strategy\";\n import { validate } from \"coral-server/app/request/body\";\n import { reconstructURL } from \"coral-server/app/url\";\n import { IntegrationDisabled, TokenInvalidError } from \"coral-server/errors\";\n-import { GQLUSER_ROLE } from \"coral-server/graph/tenant/schema/__generated__/types\";\n import logger from \"coral-server/logger\";\n import { OIDCAuthIntegration } from \"coral-server/models/settings\";\n import { Tenant } from \"coral-server/models/tenant\";\n@@ -25,6 +29,8 @@ import { findOrCreate } from \"coral-server/services/users\";\n import { validateUsername } from \"coral-server/services/users/helpers\";\n import { Request } from \"coral-server/types/express\";\n \n+import { GQLUSER_ROLE } from \"coral-server/graph/tenant/schema/__generated__/types\";\n+\n export interface Params {\n   id_token?: string;\n }\n@@ -82,6 +88,12 @@ export function isOIDCToken(token: OIDCIDToken | object): token is OIDCIDToken {\n   return isNil(error);\n }\n \n+function isCertSigningKey(\n+  key: SigningKey | RsaSigningKey\n+): key is CertSigningKey {\n+  return Boolean((key as CertSigningKey).publicKey);\n+}\n+\n /**\n  * keyFunc will provide the secret based on the given jwkw client.\n  *\n@@ -104,9 +116,11 @@ const signingKeyFactory = (client: jwks.JwksClient): jwt.KeyFunction => (\n     }\n \n     // Grab the signingKey out of the provided key.\n-    const signingKey = key.publicKey || key.rsaPublicKey;\n-\n-    callback(null, signingKey);\n+    if (isCertSigningKey(key)) {\n+      return callback(null, key.publicKey);\n+    } else {\n+      return callback(null, key.rsaPublicKey);\n+    }\n   });\n };\n "
    },
    {
      "sha": "633d0392e4f0373c912653956ab0eb430214e966",
      "filename": "src/core/server/app/url.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/coralproject/talk/blob/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/app/url.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/app/url.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/app/url.ts?ref=0dc3e8968a345f6f6591bc4cbe0773c06953ace8",
      "patch": "@@ -85,7 +85,7 @@ export function prefixSchemeIfRequired(secure: boolean, url: string) {\n   return url;\n }\n \n-export function extractParentsURL(req: Request) {\n+export function extractParentsURL(req: Pick<Request, \"headers\" | \"query\">) {\n   // The only two places this could be is in the referer header or the parentUrl\n   // query parameter (injected by pym.js). If both of these are empty, then we\n   // can't find anything.\n@@ -116,7 +116,7 @@ export function extractParentsURL(req: Request) {\n  *\n  * @param req the request where we want to extract the parent's hostname from.\n  */\n-export function extractParentsOrigin(req: Request) {\n+export function extractParentsOrigin(req: Pick<Request, \"headers\" | \"query\">) {\n   const url = extractParentsURL(req);\n   if (!url) {\n     return null;"
    },
    {
      "sha": "9f0cd4783d70310f792dbbbb2748d79d93280887",
      "filename": "src/core/server/models/comment/comment.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/coralproject/talk/blob/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/models/comment/comment.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/models/comment/comment.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/comment/comment.ts?ref=0dc3e8968a345f6f6591bc4cbe0773c06953ace8",
      "patch": "@@ -70,7 +70,7 @@ export interface Comment extends TenantResource {\n   /**\n    * authorID stores the ID of the User that created this Comment.\n    */\n-  authorID: string;\n+  authorID: string | null;\n \n   /**\n    * storyID stores the ID of the Story that this Comment was left on.\n@@ -319,7 +319,7 @@ export async function editComment(\n       status: {\n         $in: EDITABLE_STATUSES,\n       },\n-      deletedAt: null,\n+      deletedAt: undefined,\n       createdAt: {\n         $gt: lastEditableCommentCreatedAt,\n       },"
    },
    {
      "sha": "426ede2974050b0d6f5c80141adf127aa6205ee9",
      "filename": "src/core/server/models/story/counts/shared.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 8,
      "changes": 9,
      "blob_url": "https://github.com/coralproject/talk/blob/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/models/story/counts/shared.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/models/story/counts/shared.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/story/counts/shared.ts?ref=0dc3e8968a345f6f6591bc4cbe0773c06953ace8",
      "patch": "@@ -154,14 +154,7 @@ export async function retrieveSharedModerationQueueQueuesCounts(\n   const key = commentCountsModerationQueueQueuesKey(tenantID);\n   const freshKey = freshenKey(key);\n \n-  // Get the values, and the freshness key.\n-  const [[, queues], [, fresh]]: [\n-    [\n-      Error | undefined,\n-      Record<keyof CommentModerationCountsPerQueue, string> | null\n-    ],\n-    [Error | undefined, string | null]\n-  ] = await redis\n+  const [[, fresh], [, queues]] = await redis\n     .pipeline()\n     .hgetall(key)\n     .get(freshKey)"
    },
    {
      "sha": "ce370a732feafecd0a0ce76b6d9e4f83843bcb74",
      "filename": "src/core/server/models/tenant/tenant.ts",
      "status": "modified",
      "additions": 4,
      "deletions": 1,
      "changes": 5,
      "blob_url": "https://github.com/coralproject/talk/blob/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/models/tenant/tenant.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/models/tenant/tenant.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/tenant/tenant.ts?ref=0dc3e8968a345f6f6591bc4cbe0773c06953ace8",
      "patch": "@@ -223,7 +223,10 @@ export async function retrieveTenant(mongo: Db, id: string) {\n   return collection(mongo).findOne({ id });\n }\n \n-export async function retrieveManyTenants(mongo: Db, ids: string[]) {\n+export async function retrieveManyTenants(\n+  mongo: Db,\n+  ids: ReadonlyArray<string>\n+) {\n   const cursor = collection(mongo).find({\n     id: {\n       $in: ids,"
    },
    {
      "sha": "2b65d56992a7c1f3836cc112f1b99719486c0c40",
      "filename": "src/core/server/services/notifications/categories/featured.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/services/notifications/categories/featured.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/services/notifications/categories/featured.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/notifications/categories/featured.ts?ref=0dc3e8968a345f6f6591bc4cbe0773c06953ace8",
      "patch": "@@ -13,7 +13,7 @@ async function processor(\n ): Promise<Notification | null> {\n   // Get the comment that was featured.\n   const comment = await ctx.comments.load(input.commentID);\n-  if (!comment || !hasPublishedStatus(comment)) {\n+  if (!comment || (!hasPublishedStatus(comment) || !comment.authorID)) {\n     return null;\n   }\n "
    },
    {
      "sha": "7632cbe96265b30b7717f1c8cfd8f93756ae98e1",
      "filename": "src/core/server/services/notifications/categories/moderation.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/services/notifications/categories/moderation.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/services/notifications/categories/moderation.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/notifications/categories/moderation.ts?ref=0dc3e8968a345f6f6591bc4cbe0773c06953ace8",
      "patch": "@@ -19,7 +19,7 @@ async function processor(\n \n   // Load the comment in question.\n   const comment = await ctx.comments.load(input.commentID);\n-  if (!comment) {\n+  if (!comment || !comment.authorID) {\n     return null;\n   }\n "
    },
    {
      "sha": "bf55bf06d0730842a505e39e69f46046b5ba3fc2",
      "filename": "src/core/server/services/notifications/categories/reply.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/services/notifications/categories/reply.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/services/notifications/categories/reply.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/notifications/categories/reply.ts?ref=0dc3e8968a345f6f6591bc4cbe0773c06953ace8",
      "patch": "@@ -13,7 +13,7 @@ async function processor(\n   input: CommentReplyCreatedInput\n ): Promise<Notification | null> {\n   const comment = await ctx.comments.load(input.commentID);\n-  if (!comment || !hasPublishedStatus(comment)) {\n+  if (!comment || !hasPublishedStatus(comment) || !comment.authorID) {\n     return null;\n   }\n "
    },
    {
      "sha": "78ac6ced086d997523d3b4427f83b9121b1b38b3",
      "filename": "src/core/server/services/notifications/categories/staffReply.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/services/notifications/categories/staffReply.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/services/notifications/categories/staffReply.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/notifications/categories/staffReply.ts?ref=0dc3e8968a345f6f6591bc4cbe0773c06953ace8",
      "patch": "@@ -14,7 +14,7 @@ async function processor(\n   input: CommentReplyCreatedInput\n ): Promise<Notification | null> {\n   const comment = await ctx.comments.load(input.commentID);\n-  if (!comment || !hasPublishedStatus(comment)) {\n+  if (!comment || !hasPublishedStatus(comment) || !comment.authorID) {\n     return null;\n   }\n "
    },
    {
      "sha": "edab8e0841ab3d055c20baa9e1a68685dcfe321a",
      "filename": "src/core/server/services/slack/publisher.ts",
      "status": "modified",
      "additions": 5,
      "deletions": 5,
      "changes": 10,
      "blob_url": "https://github.com/coralproject/talk/blob/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/services/slack/publisher.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/services/slack/publisher.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/slack/publisher.ts?ref=0dc3e8968a345f6f6591bc4cbe0773c06953ace8",
      "patch": "@@ -78,17 +78,17 @@ async function postCommentToSlack(\n   hookURL: string\n ) {\n   const comment = await ctx.comments.load(commentID);\n-  if (comment === null) {\n-    return;\n-  }\n-  const story = await ctx.stories.load(comment.storyID);\n-  if (story === null) {\n+  if (comment === null || !comment.authorID) {\n     return;\n   }\n   const author = await ctx.users.load(comment.authorID);\n   if (author === null) {\n     return;\n   }\n+  const story = await ctx.stories.load(comment.storyID);\n+  if (story === null) {\n+    return;\n+  }\n \n   // Get some properties about the event.\n   const storyTitle = getStoryTitle(story);"
    },
    {
      "sha": "d2b3d4d3a5d09fa4b96cafeecff033a77f1c15c3",
      "filename": "src/core/server/services/users/delete.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 1,
      "changes": 3,
      "blob_url": "https://github.com/coralproject/talk/blob/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/services/users/delete.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/0dc3e8968a345f6f6591bc4cbe0773c06953ace8/src/core/server/services/users/delete.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/users/delete.ts?ref=0dc3e8968a345f6f6591bc4cbe0773c06953ace8",
      "patch": "@@ -1,5 +1,6 @@\n import { Collection, Db } from \"mongodb\";\n \n+import { ACTION_TYPE } from \"coral-server/models/action/comment\";\n import { Story } from \"coral-server/models/story\";\n import collections from \"coral-server/services/mongodb/collections\";\n \n@@ -96,7 +97,7 @@ async function deleteUserActionCounts(\n   await collections.commentActions(mongo).deleteMany({\n     tenantID,\n     userID,\n-    actionType: \"REACTION\",\n+    actionType: ACTION_TYPE.REACTION,\n   });\n }\n "
    }
  ]
}
