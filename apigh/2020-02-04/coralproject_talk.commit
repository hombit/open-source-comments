{
  "sha": "e42cb59661b0981a4f33d21dcead257e85018ea5",
  "node_id": "MDY6Q29tbWl0NzI0NTQyNDI6ZTQyY2I1OTY2MWIwOTgxYTRmMzNkMjFkY2VhZDI1N2U4NTAxOGVhNQ==",
  "commit": {
    "author": {
      "name": "Wyatt Johnson",
      "email": "wyattjoh@gmail.com",
      "date": "2020-02-04T00:21:14Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2020-02-04T00:21:14Z"
    },
    "message": "feat: added config variable for perspective timeout (#2817)\n\nAdded a configuration timeout variable for changing the perspective\r\ntimeout number.",
    "tree": {
      "sha": "afdcc359f6170c37c68ebc337e205859410da31e",
      "url": "https://api.github.com/repos/coralproject/talk/git/trees/afdcc359f6170c37c68ebc337e205859410da31e"
    },
    "url": "https://api.github.com/repos/coralproject/talk/git/commits/e42cb59661b0981a4f33d21dcead257e85018ea5",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeOLj6CRBK7hj4Ov3rIwAAdHIIAHYVBb2hdkpwvnJJO4L1fxZp\n6FxkiOlWjNzbhV0HbmfIAZSAJf7M/iFkJqYhLkxSUiMmVBtNX1KSM1CCwXyH/IRS\nLZneUbcpbMPECvp2wZGAy6hyCbKB4E+EVeBbEjOuPT2lpbhZXopJFJqTyUj2Ebfn\nuuCMYk+liVk14s6z/KLyzr4saA6YTZeC8hvAqJcRDoMqkuyT1x4yuukTQe2YW3+a\nqonupxhSNr5XUy34/aurKbZQQ+iqkWxdcXpUPLZdBaoxIdIAEHMicBMs1bFdAzFJ\nJUxqTtgc303R7HgeiBQTQU6dx69FCf1gUyhYLQOGDO00N3YlntpTDOdqQBmp0+o=\n=Ok64\n-----END PGP SIGNATURE-----\n",
      "payload": "tree afdcc359f6170c37c68ebc337e205859410da31e\nparent a1a8652f7e6b96b86a53695da60973adee5ef57d\nauthor Wyatt Johnson <wyattjoh@gmail.com> 1580775674 +0000\ncommitter GitHub <noreply@github.com> 1580775674 +0000\n\nfeat: added config variable for perspective timeout (#2817)\n\nAdded a configuration timeout variable for changing the perspective\r\ntimeout number."
    }
  },
  "url": "https://api.github.com/repos/coralproject/talk/commits/e42cb59661b0981a4f33d21dcead257e85018ea5",
  "html_url": "https://github.com/coralproject/talk/commit/e42cb59661b0981a4f33d21dcead257e85018ea5",
  "comments_url": "https://api.github.com/repos/coralproject/talk/commits/e42cb59661b0981a4f33d21dcead257e85018ea5/comments",
  "author": {
    "login": "wyattjoh",
    "id": 633002,
    "node_id": "MDQ6VXNlcjYzMzAwMg==",
    "avatar_url": "https://avatars2.githubusercontent.com/u/633002?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wyattjoh",
    "html_url": "https://github.com/wyattjoh",
    "followers_url": "https://api.github.com/users/wyattjoh/followers",
    "following_url": "https://api.github.com/users/wyattjoh/following{/other_user}",
    "gists_url": "https://api.github.com/users/wyattjoh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wyattjoh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wyattjoh/subscriptions",
    "organizations_url": "https://api.github.com/users/wyattjoh/orgs",
    "repos_url": "https://api.github.com/users/wyattjoh/repos",
    "events_url": "https://api.github.com/users/wyattjoh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wyattjoh/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "a1a8652f7e6b96b86a53695da60973adee5ef57d",
      "url": "https://api.github.com/repos/coralproject/talk/commits/a1a8652f7e6b96b86a53695da60973adee5ef57d",
      "html_url": "https://github.com/coralproject/talk/commit/a1a8652f7e6b96b86a53695da60973adee5ef57d"
    }
  ],
  "stats": {
    "total": 27,
    "additions": 21,
    "deletions": 6
  },
  "files": [
    {
      "sha": "812a7e43083c7e9ac29441e3c715e399e2bd45f9",
      "filename": "src/core/server/config.ts",
      "status": "modified",
      "additions": 16,
      "deletions": 2,
      "changes": 18,
      "blob_url": "https://github.com/coralproject/talk/blob/e42cb59661b0981a4f33d21dcead257e85018ea5/src/core/server/config.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/e42cb59661b0981a4f33d21dcead257e85018ea5/src/core/server/config.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/config.ts?ref=e42cb59661b0981a4f33d21dcead257e85018ea5",
      "patch": "@@ -51,9 +51,15 @@ convict.addFormat({\n convict.addFormat({\n   name: \"ms\",\n   validate: (val: number) => {\n-    Joi.assert(val, Joi.number().min(0));\n+    Joi.assert(\n+      val,\n+      Joi.number()\n+        .positive()\n+        .integer()\n+        .required()\n+    );\n   },\n-  coerce: (val: string) => ms(val),\n+  coerce: (val: string): number => ms(val),\n });\n \n const algorithms = [\n@@ -255,6 +261,14 @@ const config = convict({\n     env: \"SCRAPE_TIMEOUT\",\n     arg: \"scrapeTimeout\",\n   },\n+  perspective_timeout: {\n+    doc:\n+      \"The request timeout (in ms) for perspective comment checking operations.\",\n+    format: \"ms\",\n+    default: \"800 milliseconds\",\n+    env: \"PERSPECTIVE_TIMEOUT\",\n+    arg: \"perspectiveTimeout\",\n+  },\n   disable_force_ssl: {\n     doc:\n       \"Disables forcing SSL in production environments. Should not be used except for testing.\","
    },
    {
      "sha": "9b81fdd5f95801f1e396a07038724f1816e2dcb8",
      "filename": "src/core/server/services/comments/pipeline/phases/toxic.ts",
      "status": "modified",
      "additions": 5,
      "deletions": 4,
      "changes": 9,
      "blob_url": "https://github.com/coralproject/talk/blob/e42cb59661b0981a4f33d21dcead257e85018ea5/src/core/server/services/comments/pipeline/phases/toxic.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/e42cb59661b0981a4f33d21dcead257e85018ea5/src/core/server/services/comments/pipeline/phases/toxic.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/comments/pipeline/phases/toxic.ts?ref=e42cb59661b0981a4f33d21dcead257e85018ea5",
      "patch": "@@ -1,5 +1,4 @@\n import { isNil } from \"lodash\";\n-import ms from \"ms\";\n import fetch from \"node-fetch\";\n import path from \"path\";\n import { URL } from \"url\";\n@@ -32,12 +31,13 @@ export const toxic: IntermediateModerationPhase = async ({\n   nudge,\n   log,\n   htmlStripped,\n+  config,\n   // FEATURE_FLAG:DISABLE_WARN_USER_OF_TOXIC_COMMENT\n   comment: { body },\n }: Pick<\n   ModerationPhaseContext,\n   // FEATURE_FLAG:DISABLE_WARN_USER_OF_TOXIC_COMMENT\n-  \"tenant\" | \"nudge\" | \"log\" | \"htmlStripped\" | \"comment\"\n+  \"tenant\" | \"nudge\" | \"log\" | \"htmlStripped\" | \"comment\" | \"config\"\n >): Promise<IntermediatePhaseResult | void> => {\n   if (!htmlStripped) {\n     return;\n@@ -89,8 +89,9 @@ export const toxic: IntermediateModerationPhase = async ({\n     );\n   }\n \n-  // TODO: (wyattjoh) replace hardcoded default with config.\n-  const timeout = ms(\"800ms\");\n+  // This typecast is needed because the custom `ms` format does not return the\n+  // desired `number` type even though that's the only type it can output.\n+  const timeout = (config.get(\"perspective_timeout\") as unknown) as number;\n \n   try {\n     // FEATURE_FLAG:DISABLE_WARN_USER_OF_TOXIC_COMMENT"
    }
  ]
}
