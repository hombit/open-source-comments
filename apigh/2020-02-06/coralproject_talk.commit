{
  "sha": "86191e388a6e1d0013ad8ef723609fb669b3c953",
  "node_id": "MDY6Q29tbWl0NzI0NTQyNDI6ODYxOTFlMzg4YTZlMWQwMDEzYWQ4ZWY3MjM2MDlmYjY2OWIzYzk1Mw==",
  "commit": {
    "author": {
      "name": "Wyatt Johnson",
      "email": "wyattjoh@gmail.com",
      "date": "2020-02-05T16:35:57Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2020-02-05T16:35:57Z"
    },
    "message": "feat: added support for customUserAgent (#2825)",
    "tree": {
      "sha": "17b6125d95cfb825133232b2c1e0a73461092e1b",
      "url": "https://api.github.com/repos/coralproject/talk/git/trees/17b6125d95cfb825133232b2c1e0a73461092e1b"
    },
    "url": "https://api.github.com/repos/coralproject/talk/git/commits/86191e388a6e1d0013ad8ef723609fb669b3c953",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeOu7tCRBK7hj4Ov3rIwAAdHIIAEPZGga8Pc5W1AMOAPXosznQ\nmDEntfCiMDo02Fd3dkdfNWpx68l0YmwD/0ih6dRWZcXIiqxn9113LvvpV+k9Nawq\nL69TW3W2dBJrMtwACWdgWhnospes4QxehKzawTGdvSIVHc5B1fIeg5gvEE317hpV\n1WHvcuvPa/P6e+nevdfrTHuYZUDbvojPd3CttfBizXIU746q831iPTT7cBmBrgFi\nXFDtAGospZ1C/9X3+KYdfCbhufRTEt1OEgvt4qHJ11i1vF3uf7/gxT+b7054SJrX\nXtsalwJGnJV9AjNFQbDuc3Q7Tb8PKICMqCHVkzJJbkjPazFN7cMsCT1PgK1AwiI=\n=7tpx\n-----END PGP SIGNATURE-----\n",
      "payload": "tree 17b6125d95cfb825133232b2c1e0a73461092e1b\nparent 2bf3e34218b00c73ef082ea7110753d6f5961f7b\nauthor Wyatt Johnson <wyattjoh@gmail.com> 1580920557 +0000\ncommitter GitHub <noreply@github.com> 1580920557 +0000\n\nfeat: added support for customUserAgent (#2825)\n\n"
    }
  },
  "url": "https://api.github.com/repos/coralproject/talk/commits/86191e388a6e1d0013ad8ef723609fb669b3c953",
  "html_url": "https://github.com/coralproject/talk/commit/86191e388a6e1d0013ad8ef723609fb669b3c953",
  "comments_url": "https://api.github.com/repos/coralproject/talk/commits/86191e388a6e1d0013ad8ef723609fb669b3c953/comments",
  "author": {
    "login": "wyattjoh",
    "id": 633002,
    "node_id": "MDQ6VXNlcjYzMzAwMg==",
    "avatar_url": "https://avatars2.githubusercontent.com/u/633002?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wyattjoh",
    "html_url": "https://github.com/wyattjoh",
    "followers_url": "https://api.github.com/users/wyattjoh/followers",
    "following_url": "https://api.github.com/users/wyattjoh/following{/other_user}",
    "gists_url": "https://api.github.com/users/wyattjoh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wyattjoh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wyattjoh/subscriptions",
    "organizations_url": "https://api.github.com/users/wyattjoh/orgs",
    "repos_url": "https://api.github.com/users/wyattjoh/repos",
    "events_url": "https://api.github.com/users/wyattjoh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wyattjoh/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "2bf3e34218b00c73ef082ea7110753d6f5961f7b",
      "url": "https://api.github.com/repos/coralproject/talk/commits/2bf3e34218b00c73ef082ea7110753d6f5961f7b",
      "html_url": "https://github.com/coralproject/talk/commit/2bf3e34218b00c73ef082ea7110753d6f5961f7b"
    }
  ],
  "stats": {
    "total": 119,
    "additions": 114,
    "deletions": 5
  },
  "files": [
    {
      "sha": "75dc9e311e50e9fff82d7f0f98b42eb419c69a7b",
      "filename": "src/core/client/admin/routes/Configure/sections/Advanced/StoryCreationConfig.tsx",
      "status": "modified",
      "additions": 34,
      "deletions": 0,
      "changes": 34,
      "blob_url": "https://github.com/coralproject/talk/blob/86191e388a6e1d0013ad8ef723609fb669b3c953/src/core/client/admin/routes/Configure/sections/Advanced/StoryCreationConfig.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/86191e388a6e1d0013ad8ef723609fb669b3c953/src/core/client/admin/routes/Configure/sections/Advanced/StoryCreationConfig.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Advanced/StoryCreationConfig.tsx?ref=86191e388a6e1d0013ad8ef723609fb669b3c953",
      "patch": "@@ -26,6 +26,7 @@ graphql`\n       scraping {\n         enabled\n         proxyURL\n+        customUserAgent\n       }\n       disableLazy\n     }\n@@ -117,6 +118,39 @@ const StoryCreationConfig: FunctionComponent<Props> = ({ disabled }) => (\n         )}\n       </Field>\n     </FormField>\n+    <FormField>\n+      <FormFieldHeader>\n+        <Localized id=\"configure-advanced-stories-custom-user-agent\">\n+          <Label htmlFor=\"configure-advanced-stories-custom-user-agent\">\n+            Custom Scraper User Agent Header\n+          </Label>\n+        </Localized>\n+        <Localized\n+          id=\"configure-advanced-stories-custom-user-agent-detail\"\n+          code={<code />}\n+        >\n+          <HelperText>\n+            When specified, overrides the <code>User-Agent</code> header sent\n+            with each scrape request.\n+          </HelperText>\n+        </Localized>\n+      </FormFieldHeader>\n+      <Field name=\"stories.scraping.customUserAgent\" parse={parseEmptyAsNull}>\n+        {({ input, meta }) => (\n+          <TextFieldWithValidation\n+            {...input}\n+            id=\"configure-advanced-stories-custom-user-agent\"\n+            disabled={disabled}\n+            fullWidth\n+            autoComplete=\"off\"\n+            autoCorrect=\"off\"\n+            autoCapitalize=\"off\"\n+            spellCheck={false}\n+            meta={meta}\n+          />\n+        )}\n+      </Field>\n+    </FormField>\n   </ConfigBox>\n );\n "
    },
    {
      "sha": "9ecd0a8028463454f03a4921ede7352efdac9cc3",
      "filename": "src/core/client/admin/test/configure/__snapshots__/advanced.spec.tsx.snap",
      "status": "modified",
      "additions": 48,
      "deletions": 0,
      "changes": 48,
      "blob_url": "https://github.com/coralproject/talk/blob/86191e388a6e1d0013ad8ef723609fb669b3c953/src/core/client/admin/test/configure/__snapshots__/advanced.spec.tsx.snap",
      "raw_url": "https://github.com/coralproject/talk/raw/86191e388a6e1d0013ad8ef723609fb669b3c953/src/core/client/admin/test/configure/__snapshots__/advanced.spec.tsx.snap",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/configure/__snapshots__/advanced.spec.tsx.snap?ref=86191e388a6e1d0013ad8ef723609fb669b3c953",
      "patch": "@@ -625,6 +625,54 @@ proxy as parsed by the\n                     </div>\n                   </div>\n                 </div>\n+                <div\n+                  className=\"Box-root HorizontalGutter-root FormField-root HorizontalGutter-spacing-2\"\n+                >\n+                  <div\n+                    className=\"Box-root HorizontalGutter-root FormFieldHeader-root HorizontalGutter-spacing-1\"\n+                  >\n+                    <label\n+                      className=\"Label-root\"\n+                      htmlFor=\"configure-advanced-stories-custom-user-agent\"\n+                    >\n+                      Custom Scraper User Agent Header\n+                    </label>\n+                    <p\n+                      className=\"HelperText-root\"\n+                    >\n+                      When specified, overrides the \n+                      <code>\n+                        User-Agent\n+                      </code>\n+                       header sent with each\n+scrape request.\n+                    </p>\n+                  </div>\n+                  <div\n+                    className=\"Box-root HorizontalGutter-root HorizontalGutter-spacing-2\"\n+                  >\n+                    <div\n+                      className=\"TextField-root TextField-fullWidth\"\n+                    >\n+                      <input\n+                        autoCapitalize=\"off\"\n+                        autoComplete=\"off\"\n+                        autoCorrect=\"off\"\n+                        className=\"TextField-input TextField-colorRegular\"\n+                        disabled={false}\n+                        id=\"configure-advanced-stories-custom-user-agent\"\n+                        name=\"stories.scraping.customUserAgent\"\n+                        onBlur={[Function]}\n+                        onChange={[Function]}\n+                        onFocus={[Function]}\n+                        placeholder=\"\"\n+                        spellCheck={false}\n+                        type=\"text\"\n+                        value=\"\"\n+                      />\n+                    </div>\n+                  </div>\n+                </div>\n               </div>\n             </div>\n           </div>"
    },
    {
      "sha": "d6bb2e90c3dd70bd11006e76d1c3f884f64a72cb",
      "filename": "src/core/server/graph/loaders/Stories.ts",
      "status": "modified",
      "additions": 6,
      "deletions": 3,
      "changes": 9,
      "blob_url": "https://github.com/coralproject/talk/blob/86191e388a6e1d0013ad8ef723609fb669b3c953/src/core/server/graph/loaders/Stories.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/86191e388a6e1d0013ad8ef723609fb669b3c953/src/core/server/graph/loaders/Stories.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/loaders/Stories.ts?ref=86191e388a6e1d0013ad8ef723609fb669b3c953",
      "patch": "@@ -119,9 +119,12 @@ export default (ctx: GraphContext) => ({\n       // This typecast is needed because the custom `ms` format does not return\n       // the desired `number` type even though that's the only type it can\n       // output.\n-      scraper.scrape(url, (ctx.config.get(\n-        \"scrape_timeout\"\n-      ) as unknown) as number)\n+      scraper.scrape(\n+        url,\n+        (ctx.config.get(\"scrape_timeout\") as unknown) as number,\n+        ctx.tenant.stories.scraping.customUserAgent,\n+        ctx.tenant.stories.scraping.proxyURL\n+      )\n     ),\n     {\n       // Disable caching for the DataLoader if the Context is designed to be"
    },
    {
      "sha": "9b3d03912380dd0bd22a1a0121fc7d29de9d134b",
      "filename": "src/core/server/graph/schema/schema.graphql",
      "status": "modified",
      "additions": 12,
      "deletions": 0,
      "changes": 12,
      "blob_url": "https://github.com/coralproject/talk/blob/86191e388a6e1d0013ad8ef723609fb669b3c953/src/core/server/graph/schema/schema.graphql",
      "raw_url": "https://github.com/coralproject/talk/raw/86191e388a6e1d0013ad8ef723609fb669b3c953/src/core/server/graph/schema/schema.graphql",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/schema/schema.graphql?ref=86191e388a6e1d0013ad8ef723609fb669b3c953",
      "patch": "@@ -1150,6 +1150,12 @@ type StoryScrapingConfiguration {\n   the [proxy-agent](https://www.npmjs.com/package/proxy-agent) package.\n   \"\"\"\n   proxyURL: String\n+\n+  \"\"\"\n+  customUserAgent when specified will override the user agent used by fetch\n+  requests made during the scraping process.\n+  \"\"\"\n+  customUserAgent: String\n }\n \n \"\"\"\n@@ -3519,6 +3525,12 @@ input StoryScrapingConfigurationInput {\n   the [proxy-agent](https://www.npmjs.com/package/proxy-agent) package.\n   \"\"\"\n   proxyURL: String\n+\n+  \"\"\"\n+  customUserAgent when specified will override the user agent used by fetch\n+  requests made during the scraping process.\n+  \"\"\"\n+  customUserAgent: String\n }\n \n \"\"\""
    },
    {
      "sha": "9c9277bd671381f1cc45ae090b508a81044178b3",
      "filename": "src/core/server/services/stories/scraper/scraper.ts",
      "status": "modified",
      "additions": 10,
      "deletions": 2,
      "changes": 12,
      "blob_url": "https://github.com/coralproject/talk/blob/86191e388a6e1d0013ad8ef723609fb669b3c953/src/core/server/services/stories/scraper/scraper.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/86191e388a6e1d0013ad8ef723609fb669b3c953/src/core/server/services/stories/scraper/scraper.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/stories/scraper/scraper.ts?ref=86191e388a6e1d0013ad8ef723609fb669b3c953",
      "patch": "@@ -86,6 +86,7 @@ class Scraper {\n   public async download(\n     url: string,\n     abortAfterMilliseconds: number,\n+    customUserAgent?: string,\n     proxyURL?: string\n   ) {\n     const log = this.log.child({ storyURL: url }, true);\n@@ -95,7 +96,7 @@ class Scraper {\n \n     const options: RequestInit = {\n       headers: {\n-        \"User-Agent\": `Talk Scraper/${version}`,\n+        \"User-Agent\": customUserAgent || `Talk Scraper/${version}`,\n       },\n       signal: controller.signal,\n     };\n@@ -136,9 +137,15 @@ class Scraper {\n   public async scrape(\n     url: string,\n     abortAfterMilliseconds: number,\n+    customUserAgent?: string,\n     proxyURL?: string\n   ): Promise<GQLStoryMetadata | null> {\n-    const html = await this.download(url, abortAfterMilliseconds, proxyURL);\n+    const html = await this.download(\n+      url,\n+      abortAfterMilliseconds,\n+      customUserAgent,\n+      proxyURL\n+    );\n     if (!html) {\n       return null;\n     }\n@@ -199,6 +206,7 @@ export async function scrape(\n   const metadata = await scraper.scrape(\n     storyURL,\n     abortAfterMilliseconds,\n+    tenant.stories.scraping.customUserAgent,\n     tenant.stories.scraping.proxyURL\n   );\n   if (!metadata) {"
    },
    {
      "sha": "d213904490b9398cb09856b9639c33d095827adc",
      "filename": "src/locales/en-US/admin.ftl",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/coralproject/talk/blob/86191e388a6e1d0013ad8ef723609fb669b3c953/src/locales/en-US/admin.ftl",
      "raw_url": "https://github.com/coralproject/talk/raw/86191e388a6e1d0013ad8ef723609fb669b3c953/src/locales/en-US/admin.ftl",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/locales/en-US/admin.ftl?ref=86191e388a6e1d0013ad8ef723609fb669b3c953",
      "patch": "@@ -885,6 +885,10 @@ configure-advanced-stories-proxy-detail =\n   When specified, allows scraping requests to use the provided\n   proxy. All requests will then be passed through the appropriote\n   proxy as parsed by the <externalLink>npm proxy-agent</externalLink> package.\n+configure-advanced-stories-custom-user-agent = Custom Scraper User Agent Header\n+configure-advanced-stories-custom-user-agent-detail =\n+  When specified, overrides the <code>User-Agent</code> header sent with each\n+  scrape request.\n \n forgotPassword-forgotPasswordHeader = Forgot password?\n forgotPassword-checkEmailHeader = Check your email"
    }
  ]
}
