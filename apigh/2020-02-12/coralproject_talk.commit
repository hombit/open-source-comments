{
  "sha": "707d65a11901d24b81c3207e125c7a28c2900056",
  "node_id": "MDY6Q29tbWl0NzI0NTQyNDI6NzA3ZDY1YTExOTAxZDI0YjgxYzMyMDdlMTI1YzdhMjhjMjkwMDA1Ng==",
  "commit": {
    "author": {
      "name": "Tessa Thornton",
      "email": "tessathornton@gmail.com",
      "date": "2020-02-12T14:22:07Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2020-02-12T14:22:07Z"
    },
    "message": "Support multisite (#2799)\n\n* resovle import error by removing useContext from ui component\r\n\r\n* update snaps\r\n\r\n* create useUIContext hook\r\n\r\n* add site and community models\r\n\r\n* create sites and communities on install\r\n\r\n* add site name to install wizard\r\n\r\n* add site id to stories\r\n\r\n* pass site id to stream query in embed\r\n\r\n* fix spec\r\n\r\n* add sites query\r\n\r\n* list sites in organization config\r\n\r\n* add route for new sites\r\n\r\n* add create site mutation\r\n\r\n* view and update sites\r\n\r\n* show embed codes for sites\r\n\r\n* add site id to comments\r\n\r\n* allow filtering moderation queues by site id\r\n\r\n* add site selector to queue\r\n\r\n* move sites config routes\r\n\r\n* Revert \"move sites config routes\"\r\n\r\nThis reverts commit 4ed5345d3e1df6263f8390b64214956c43c4d8cd.\r\n\r\n* update sites routes\r\n\r\n* show site name in moderate card\r\n\r\n* remove site selector from queue selector\r\n\r\n* style create site form\r\n\r\n* edit site form\r\n\r\n* clean up ts\r\n\r\n* move :storyID paths to /storeis/:storyID\r\n\r\n* make queues respect site id\r\n\r\n* add site switcher\r\n\r\n* styles for site selector\r\n\r\n* add global notifications\r\n\r\n* style app notifications\r\n\r\n* clear notifications after x miliseconds\r\n\r\n* use notification component in add site form\r\n\r\n* fix types\r\n\r\n* make notifications dismissable\r\n\r\n* dismiss site created notification\r\n\r\n* remove button letter spacing if lowercase\r\n\r\n* filter stories by site in search\r\n\r\n* add site name to story search results\r\n\r\n* add site column to stories table\r\n\r\n* filter stories table by site\r\n\r\n* make sure notification displays after site creation\r\n\r\n* paginate sites table\r\n\r\n* paginage site selector\r\n\r\n* add paginated site filter to stories table\r\n\r\n* fix merge conflicts\r\n\r\n* sort by createdAt\r\n\r\n* default to 20 sites\r\n\r\n* delete comments\r\n\r\n* add translation tags\r\n\r\n* make site ID not mandatory\r\n\r\n* Fix tests and specs\r\n\r\n* only include site id in embed code for multisite\r\n\r\n* update tenant cache when adding first site\r\n\r\n* only show site selector if multiple sites\r\n\r\n* use story url instead of site id for story upsert\r\n\r\n* update snaps\r\n\r\n* make ui conditional on multisite\r\n\r\n* update snaps and remove unnecessary site ID\r\n\r\n* sloppily calculate counts for filtered queues\r\n\r\n* get origins of allowed domains\r\n\r\n* add migration\r\n\r\n* enable migration\r\n\r\n* only show permitted domains if mulltisite is false\r\n\r\n* remove site id from embed code\r\n\r\n* update snaps\r\n\r\n* undo updates to singletonresolver\r\n\r\n* remove refernces to communities\r\n\r\n* fix mints\r\n\r\n* remove community reference\r\n\r\n* update copy in installation\r\n\r\n* use sites services in installer\r\n\r\n* remove unused loader\r\n\r\n* correct error text for useNotification\r\n\r\n* order sites by name\r\n\r\n* make multisite a computed property\r\n\r\n* use map/filter instead of for/of for url origins\r\n\r\n* add missing/incorrect translations\r\n\r\n* remove references to siteID\r\n\r\n* remove references to tenant isURLpermitted\r\n\r\n* add comments to schema updates\r\n\r\n* simplify filtering stories by site\r\n\r\n* remove domains config from advanced\r\n\r\n* fix: adjusted CSP header generation\r\n\r\n* add migration to create indexes on site\r\n\r\n* clear notifications on navigate\r\n\r\n* remove count for filtering by site\r\n\r\n* throw duplicate error for allowed domains\r\n\r\n* handle errors for create/update sites\r\n\r\n* remove contacturl and contactemail from sites\r\n\r\n* fix types for counts\r\n\r\n* sort imports\r\n\r\n* ensure props get passed down to link version of button component\r\n\r\n* add url and email fields back into organization config\r\n\r\n* sort imports\r\n\r\n* fix moderation queues resolver types\r\n\r\n* fix appearance of sites dropdown\r\n\r\n* add status role to notificaiton\r\n\r\n* remove duplicate layout file\r\n\r\n* fix: rename allowedDomains -> allowdOrigins\r\n\r\n* move Link conditional from button to basebutton component\r\n\r\n* fix merge conflict\r\n\r\n* fix mutation optimistic response\r\n\r\n* make sure to prop gets passed to link\r\n\r\n* change labels on install steps\r\n\r\n* show story's site in site selector when moderating by story\r\n\r\n* feat: support site counting\r\n\r\n* update snap\r\n\r\n* remove multisite from settings\r\n\r\n* move paginated select to admin/components\r\n\r\n* fix circular import errors\r\n\r\n* remove uicontext component from v2 timestamp\r\n\r\nCo-authored-by: Wyatt Johnson <accounts+github@wyattjoh.ca>",
    "tree": {
      "sha": "935f17bcc12ecc2f982ff435ba11c214063ef181",
      "url": "https://api.github.com/repos/coralproject/talk/git/trees/935f17bcc12ecc2f982ff435ba11c214063ef181"
    },
    "url": "https://api.github.com/repos/coralproject/talk/git/commits/707d65a11901d24b81c3207e125c7a28c2900056",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeRAoPCRBK7hj4Ov3rIwAAdHIIAJ8QFn3lHWiwl9jjyEyChVmr\n4/KNysPbFbV2a3ZenR3APOSaaPYtOAK3/uMHO+a0w6Ucnbk4piW4gjPD0cg43as3\nneC4pFqYYec48bxEBn9hrRD0APpAkPf5zFczLj13f31b5g99+Op6wDXSygaaMOoq\nkUsGo+FMUWOFGlTJPO/C9lnCbmq7CPcxiwOLun9vHbMGrndCVqS355d9LqsnWNp3\nA3sRKoRJQnVs/Zko7fEGwoPVp7JTj1hoHY6wp3o173vV8H/5z3IPOQfjgR1HT6H3\nVkgcetf39ca/BOLwqwDhwe04+g8sJ5VFRX/2NyRvCEKWSI4DtdxAUGXGxbXfmQM=\n=13wn\n-----END PGP SIGNATURE-----\n",
      "payload": "tree 935f17bcc12ecc2f982ff435ba11c214063ef181\nparent 014aa2d86ad54fc1139c4fef6d05f96426c7ea91\nauthor Tessa Thornton <tessathornton@gmail.com> 1581517327 -0500\ncommitter GitHub <noreply@github.com> 1581517327 -0500\n\nSupport multisite (#2799)\n\n* resovle import error by removing useContext from ui component\r\n\r\n* update snaps\r\n\r\n* create useUIContext hook\r\n\r\n* add site and community models\r\n\r\n* create sites and communities on install\r\n\r\n* add site name to install wizard\r\n\r\n* add site id to stories\r\n\r\n* pass site id to stream query in embed\r\n\r\n* fix spec\r\n\r\n* add sites query\r\n\r\n* list sites in organization config\r\n\r\n* add route for new sites\r\n\r\n* add create site mutation\r\n\r\n* view and update sites\r\n\r\n* show embed codes for sites\r\n\r\n* add site id to comments\r\n\r\n* allow filtering moderation queues by site id\r\n\r\n* add site selector to queue\r\n\r\n* move sites config routes\r\n\r\n* Revert \"move sites config routes\"\r\n\r\nThis reverts commit 4ed5345d3e1df6263f8390b64214956c43c4d8cd.\r\n\r\n* update sites routes\r\n\r\n* show site name in moderate card\r\n\r\n* remove site selector from queue selector\r\n\r\n* style create site form\r\n\r\n* edit site form\r\n\r\n* clean up ts\r\n\r\n* move :storyID paths to /storeis/:storyID\r\n\r\n* make queues respect site id\r\n\r\n* add site switcher\r\n\r\n* styles for site selector\r\n\r\n* add global notifications\r\n\r\n* style app notifications\r\n\r\n* clear notifications after x miliseconds\r\n\r\n* use notification component in add site form\r\n\r\n* fix types\r\n\r\n* make notifications dismissable\r\n\r\n* dismiss site created notification\r\n\r\n* remove button letter spacing if lowercase\r\n\r\n* filter stories by site in search\r\n\r\n* add site name to story search results\r\n\r\n* add site column to stories table\r\n\r\n* filter stories table by site\r\n\r\n* make sure notification displays after site creation\r\n\r\n* paginate sites table\r\n\r\n* paginage site selector\r\n\r\n* add paginated site filter to stories table\r\n\r\n* fix merge conflicts\r\n\r\n* sort by createdAt\r\n\r\n* default to 20 sites\r\n\r\n* delete comments\r\n\r\n* add translation tags\r\n\r\n* make site ID not mandatory\r\n\r\n* Fix tests and specs\r\n\r\n* only include site id in embed code for multisite\r\n\r\n* update tenant cache when adding first site\r\n\r\n* only show site selector if multiple sites\r\n\r\n* use story url instead of site id for story upsert\r\n\r\n* update snaps\r\n\r\n* make ui conditional on multisite\r\n\r\n* update snaps and remove unnecessary site ID\r\n\r\n* sloppily calculate counts for filtered queues\r\n\r\n* get origins of allowed domains\r\n\r\n* add migration\r\n\r\n* enable migration\r\n\r\n* only show permitted domains if mulltisite is false\r\n\r\n* remove site id from embed code\r\n\r\n* update snaps\r\n\r\n* undo updates to singletonresolver\r\n\r\n* remove refernces to communities\r\n\r\n* fix mints\r\n\r\n* remove community reference\r\n\r\n* update copy in installation\r\n\r\n* use sites services in installer\r\n\r\n* remove unused loader\r\n\r\n* correct error text for useNotification\r\n\r\n* order sites by name\r\n\r\n* make multisite a computed property\r\n\r\n* use map/filter instead of for/of for url origins\r\n\r\n* add missing/incorrect translations\r\n\r\n* remove references to siteID\r\n\r\n* remove references to tenant isURLpermitted\r\n\r\n* add comments to schema updates\r\n\r\n* simplify filtering stories by site\r\n\r\n* remove domains config from advanced\r\n\r\n* fix: adjusted CSP header generation\r\n\r\n* add migration to create indexes on site\r\n\r\n* clear notifications on navigate\r\n\r\n* remove count for filtering by site\r\n\r\n* throw duplicate error for allowed domains\r\n\r\n* handle errors for create/update sites\r\n\r\n* remove contacturl and contactemail from sites\r\n\r\n* fix types for counts\r\n\r\n* sort imports\r\n\r\n* ensure props get passed down to link version of button component\r\n\r\n* add url and email fields back into organization config\r\n\r\n* sort imports\r\n\r\n* fix moderation queues resolver types\r\n\r\n* fix appearance of sites dropdown\r\n\r\n* add status role to notificaiton\r\n\r\n* remove duplicate layout file\r\n\r\n* fix: rename allowedDomains -> allowdOrigins\r\n\r\n* move Link conditional from button to basebutton component\r\n\r\n* fix merge conflict\r\n\r\n* fix mutation optimistic response\r\n\r\n* make sure to prop gets passed to link\r\n\r\n* change labels on install steps\r\n\r\n* show story's site in site selector when moderating by story\r\n\r\n* feat: support site counting\r\n\r\n* update snap\r\n\r\n* remove multisite from settings\r\n\r\n* move paginated select to admin/components\r\n\r\n* fix circular import errors\r\n\r\n* remove uicontext component from v2 timestamp\r\n\r\nCo-authored-by: Wyatt Johnson <accounts+github@wyattjoh.ca>\r\n"
    }
  },
  "url": "https://api.github.com/repos/coralproject/talk/commits/707d65a11901d24b81c3207e125c7a28c2900056",
  "html_url": "https://github.com/coralproject/talk/commit/707d65a11901d24b81c3207e125c7a28c2900056",
  "comments_url": "https://api.github.com/repos/coralproject/talk/commits/707d65a11901d24b81c3207e125c7a28c2900056/comments",
  "author": {
    "login": "tessalt",
    "id": 1789029,
    "node_id": "MDQ6VXNlcjE3ODkwMjk=",
    "avatar_url": "https://avatars3.githubusercontent.com/u/1789029?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tessalt",
    "html_url": "https://github.com/tessalt",
    "followers_url": "https://api.github.com/users/tessalt/followers",
    "following_url": "https://api.github.com/users/tessalt/following{/other_user}",
    "gists_url": "https://api.github.com/users/tessalt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tessalt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tessalt/subscriptions",
    "organizations_url": "https://api.github.com/users/tessalt/orgs",
    "repos_url": "https://api.github.com/users/tessalt/repos",
    "events_url": "https://api.github.com/users/tessalt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tessalt/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "014aa2d86ad54fc1139c4fef6d05f96426c7ea91",
      "url": "https://api.github.com/repos/coralproject/talk/commits/014aa2d86ad54fc1139c4fef6d05f96426c7ea91",
      "html_url": "https://github.com/coralproject/talk/commit/014aa2d86ad54fc1139c4fef6d05f96426c7ea91"
    }
  ],
  "stats": {
    "total": 6285,
    "additions": 4674,
    "deletions": 1611
  },
  "files": [
    {
      "sha": "898e934d855f745b816ca33c7b1422b64589b77f",
      "filename": "src/core/build/createWebpackConfig.ts",
      "status": "modified",
      "additions": 0,
      "deletions": 5,
      "changes": 5,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/build/createWebpackConfig.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/build/createWebpackConfig.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/build/createWebpackConfig.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -501,11 +501,6 @@ export default function createWebpackConfig(\n               exclude: [/\\.(js|ts|tsx)$/, /\\.html$/, /\\.json$/],\n               loader: require.resolve(\"file-loader\"),\n               options: {\n-                // Because the resources loaded via CSS can sometimes be loaded\n-                // directly from a CSS file, this will ensure that they are\n-                // relative to those referencing files.\n-                publicPath: (loaderPublicPath: string) =>\n-                  \"../../\" + loaderPublicPath,\n                 name: isProduction\n                   ? \"assets/media/[name].[hash:8].[ext]\"\n                   : \"assets/media/[name].[ext]\","
    },
    {
      "sha": "3c963c459c6c6dc81aa2777c18126a3daad8c936",
      "filename": "src/core/client/admin/App/GlobalNotification/GlobalNotificationContext.tsx",
      "status": "added",
      "additions": 45,
      "deletions": 0,
      "changes": 45,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/App/GlobalNotification/GlobalNotificationContext.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/App/GlobalNotification/GlobalNotificationContext.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/App/GlobalNotification/GlobalNotificationContext.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,45 @@\n+import React, { createContext, ReactNode, useMemo, useReducer } from \"react\";\n+\n+interface State {\n+  message: ReactNode | null;\n+  visible: boolean;\n+}\n+\n+type Action =\n+  | {\n+      type: \"SET_MESSAGE\";\n+    } & State\n+  | {\n+      type: \"CLEAR_MESSAGE\";\n+    };\n+\n+// TODO (tessalt) can't figure out types for this\n+const NotificationContext = createContext<State | any>({\n+  message: null,\n+  visible: false,\n+});\n+\n+function notificationReducer(state: State, action: Action): State {\n+  switch (action.type) {\n+    case \"SET_MESSAGE\": {\n+      return { message: action.message, visible: true };\n+    }\n+    case \"CLEAR_MESSAGE\": {\n+      return { message: null, visible: false };\n+    }\n+    default: {\n+      throw new Error(\"unsupported action\");\n+    }\n+  }\n+}\n+\n+function NotificationProvider(props: any) {\n+  const [state, dispatch] = useReducer(notificationReducer, {\n+    message: null,\n+    visible: false,\n+  });\n+  const value = useMemo(() => [state, dispatch], [state]);\n+  return <NotificationContext.Provider value={value} {...props} />;\n+}\n+\n+export { NotificationProvider, NotificationContext };"
    },
    {
      "sha": "6a9da2619ace2344688e6aaeb69a8dea0d2c92a9",
      "filename": "src/core/client/admin/App/GlobalNotification/NotificationContainer.tsx",
      "status": "added",
      "additions": 12,
      "deletions": 0,
      "changes": 12,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/App/GlobalNotification/NotificationContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/App/GlobalNotification/NotificationContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/App/GlobalNotification/NotificationContainer.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,12 @@\n+import React, { FunctionComponent } from \"react\";\n+import useNotification from \"./useNotification\";\n+\n+const NotificationContainer: FunctionComponent<{}> = () => {\n+  const { state } = useNotification();\n+  if (!state.visible) {\n+    return null;\n+  }\n+  return <div role=\"status\">{state.message}</div>;\n+};\n+\n+export default NotificationContainer;"
    },
    {
      "sha": "896c4d30620712f1f5bae0f665861179c47d1b87",
      "filename": "src/core/client/admin/App/GlobalNotification/index.ts",
      "status": "added",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/App/GlobalNotification/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/App/GlobalNotification/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/App/GlobalNotification/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,3 @@\n+export { NotificationProvider } from \"./GlobalNotificationContext\";\n+export { default as NotificationContainer } from \"./NotificationContainer\";\n+export { default as useNotification } from \"./useNotification\";"
    },
    {
      "sha": "9aea0cac6f7898baf0e9ebcf340d1cc99e201e19",
      "filename": "src/core/client/admin/App/GlobalNotification/useNotification.ts",
      "status": "added",
      "additions": 39,
      "deletions": 0,
      "changes": 39,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/App/GlobalNotification/useNotification.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/App/GlobalNotification/useNotification.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/App/GlobalNotification/useNotification.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,39 @@\n+import { useRouter } from \"found\";\n+import { ReactNode, useContext } from \"react\";\n+\n+import { NotificationContext } from \"./GlobalNotificationContext\";\n+\n+function useNotification() {\n+  const context = useContext(NotificationContext);\n+  if (!context) {\n+    throw new Error(\n+      \"useNotification must be used within a NotificationProvider\"\n+    );\n+  }\n+  const [state, dispatch] = context;\n+\n+  const { router } = useRouter();\n+\n+  const setMessage = (message: ReactNode, timeout?: number) => {\n+    dispatch({ type: \"SET_MESSAGE\", message });\n+    if (timeout) {\n+      setTimeout(() => {\n+        dispatch({ type: \"CLEAR_MESSAGE\" });\n+      }, timeout);\n+    }\n+    router.addTransitionHook(() => {\n+      dispatch({ type: \"CLEAR_MESSAGE\" });\n+      return true;\n+    });\n+  };\n+\n+  const clearMessage = () => dispatch({ type: \"CLEAR_MESSAGE\" });\n+  return {\n+    state,\n+    dispatch,\n+    setMessage,\n+    clearMessage,\n+  };\n+}\n+\n+export default useNotification;"
    },
    {
      "sha": "99d77a780e6082c1f93d2a27af2718b6a9478bc7",
      "filename": "src/core/client/admin/App/Main.tsx",
      "status": "modified",
      "additions": 8,
      "deletions": 1,
      "changes": 9,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/App/Main.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/App/Main.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/App/Main.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -5,6 +5,10 @@ import { LogoHorizontal } from \"coral-ui/components\";\n import { AppBar, Begin, Divider, End } from \"coral-ui/components/v2/AppBar\";\n \n import { DecisionHistoryButton } from \"./DecisionHistory\";\n+import {\n+  NotificationContainer,\n+  NotificationProvider,\n+} from \"./GlobalNotification\";\n import NavigationContainer from \"./Navigation\";\n import UserMenuContainer from \"./UserMenu\";\n import Version from \"./Version\";\n@@ -32,7 +36,10 @@ const Main: FunctionComponent<Props> = ({ children, viewer }) => (\n         <UserMenuContainer viewer={viewer} />\n       </End>\n     </AppBar>\n-    {children}\n+    <NotificationProvider>\n+      <NotificationContainer />\n+      {children}\n+    </NotificationProvider>\n     <Version />\n   </div>\n );"
    },
    {
      "sha": "192e754379e81dee4d5e09478061f3a3fe6151a0",
      "filename": "src/core/client/admin/App/__snapshots__/Main.spec.tsx.snap",
      "status": "modified",
      "additions": 4,
      "deletions": 1,
      "changes": 5,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/App/__snapshots__/Main.spec.tsx.snap",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/App/__snapshots__/Main.spec.tsx.snap",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/App/__snapshots__/Main.spec.tsx.snap?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -28,7 +28,10 @@ exports[`renders correctly 1`] = `\n       />\n     </withPropsOnChange(End)>\n   </withPropsOnChange(AppBar)>\n-  child\n+  <NotificationProvider>\n+    <NotificationContainer />\n+    child\n+  </NotificationProvider>\n   <Version />\n </div>\n `;"
    },
    {
      "sha": "84aafec8f4f225328872241b1b627937a7ce45a5",
      "filename": "src/core/client/admin/components/ModerateCard/ModerateCard.css",
      "status": "modified",
      "additions": 11,
      "deletions": 1,
      "changes": 12,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/components/ModerateCard/ModerateCard.css",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/components/ModerateCard/ModerateCard.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/ModerateCard/ModerateCard.css?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -142,13 +142,23 @@ $moderateCardLinkTextColor: var(--v2-colors-teal-700);\n \n .storyTitle {\n   color: $moderateCardStoryTitleColor;\n+}\n+\n+.commentOn {\n   font-size: var(--v2-font-size-2);\n-  font-weight: var(--v2-font-weight-primary-regular);\n   font-family: var(--v2-font-family-primary);\n   line-height: var(--v2-line-height-reset);\n   margin-bottom: var(--v2-spacing-1);\n }\n \n+.siteName {\n+  font-weight: var(--v2-font-weight-primary-regular);\n+}\n+\n+.storyTitle {\n+  font-weight: var(--v2-font-weight-primary-semi-bold);\n+}\n+\n .borderless {\n   border-width: 0px;\n   box-shadow: none;"
    },
    {
      "sha": "59a505cf77755c330f6f3bfe7ae6e59957fcdb7f",
      "filename": "src/core/client/admin/components/ModerateCard/ModerateCard.spec.tsx",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/components/ModerateCard/ModerateCard.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/components/ModerateCard/ModerateCard.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/ModerateCard/ModerateCard.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -23,6 +23,7 @@ const baseProps: PropTypesOf<typeof ModerateCardN> = {\n   viewContextHref: \"http://localhost/comment\",\n   suspectWords: [\"suspect\"],\n   bannedWords: [\"banned\"],\n+  siteName: null,\n   onApprove: noop,\n   onReject: noop,\n   onFeature: noop,"
    },
    {
      "sha": "32e873a7412b6c2b9d76ce29cd6fc7be1e533044",
      "filename": "src/core/client/admin/components/ModerateCard/ModerateCard.tsx",
      "status": "modified",
      "additions": 12,
      "deletions": 1,
      "changes": 13,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/components/ModerateCard/ModerateCard.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/components/ModerateCard/ModerateCard.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/ModerateCard/ModerateCard.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -16,6 +16,7 @@ import {\n   Card,\n   Flex,\n   HorizontalGutter,\n+  Icon,\n   TextLink,\n   Timestamp,\n } from \"coral-ui/components/v2\";\n@@ -52,6 +53,7 @@ interface Props {\n   showStory: boolean;\n   storyTitle?: React.ReactNode;\n   storyHref?: string;\n+  siteName: string | null;\n   onModerateStory?: React.EventHandler<React.MouseEvent>;\n   onApprove: () => void;\n   onReject: () => void;\n@@ -96,6 +98,7 @@ const ModerateCard: FunctionComponent<Props> = ({\n   storyTitle,\n   storyHref,\n   onModerateStory,\n+  siteName,\n   moderatedBy,\n   selected,\n   onFocusOrClick,\n@@ -250,7 +253,15 @@ const ModerateCard: FunctionComponent<Props> = ({\n                     </Localized>\n                     <span>:</span>\n                   </div>\n-                  <div className={styles.storyTitle}>{storyTitle}</div>\n+                  <div className={styles.commentOn}>\n+                    {siteName && (\n+                      <span className={styles.siteName}>\n+                        {siteName}\n+                        <Icon>keyboard_arrow_right</Icon>\n+                      </span>\n+                    )}\n+                    <span className={styles.storyTitle}>{storyTitle}</span>\n+                  </div>\n                   <div>\n                     <Localized id=\"moderate-comment-moderateStory\">\n                       <TextLink"
    },
    {
      "sha": "fbfeb65a5810f3a1b38aff96479735fd587f0393",
      "filename": "src/core/client/admin/components/ModerateCard/ModerateCardContainer.tsx",
      "status": "modified",
      "additions": 9,
      "deletions": 3,
      "changes": 12,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/components/ModerateCard/ModerateCardContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/components/ModerateCard/ModerateCardContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/ModerateCard/ModerateCardContainer.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -4,12 +4,12 @@ import { graphql } from \"react-relay\";\n \n import NotAvailable from \"coral-admin/components/NotAvailable\";\n import BanModal from \"coral-admin/components/UserStatus/BanModal\";\n-import { getModerationLink } from \"coral-admin/helpers\";\n import {\n   ApproveCommentMutation,\n   RejectCommentMutation,\n } from \"coral-admin/mutations\";\n import FadeInTransition from \"coral-framework/components/FadeInTransition\";\n+import { getModerationLink } from \"coral-framework/helpers\";\n import {\n   MutationProp,\n   withFragmentContainer,\n@@ -162,7 +162,7 @@ const ModerateCardContainer: FunctionComponent<Props> = ({\n \n   const handleModerateStory = useCallback(\n     (e: React.MouseEvent) => {\n-      router.push(getModerationLink(\"default\", comment.story.id));\n+      router.push(getModerationLink({ storyID: comment.story.id }));\n       if (e.preventDefault) {\n         e.preventDefault();\n       }\n@@ -227,6 +227,7 @@ const ModerateCardContainer: FunctionComponent<Props> = ({\n           selected={selected}\n           selectPrev={selectPrev}\n           selectNext={selectNext}\n+          siteName={settings.multisite ? comment.site.name : null}\n           onBan={openBanModal}\n           moderatedBy={\n             <ModeratedByContainer\n@@ -242,7 +243,7 @@ const ModerateCardContainer: FunctionComponent<Props> = ({\n               <NotAvailable />\n             )\n           }\n-          storyHref={getModerationLink(\"default\", comment.story.id)}\n+          storyHref={getModerationLink({ storyID: comment.story.id })}\n           onModerateStory={handleModerateStory}\n           mini={mini}\n           hideUsername={hideUsername}\n@@ -300,6 +301,10 @@ const enhanced = withFragmentContainer<Props>({\n           title\n         }\n       }\n+      site {\n+        id\n+        name\n+      }\n       permalink\n       enteredLive\n       deleted\n@@ -314,6 +319,7 @@ const enhanced = withFragmentContainer<Props>({\n         banned\n         suspect\n       }\n+      multisite\n       ...MarkersContainer_settings\n     }\n   `,"
    },
    {
      "sha": "e6cfd61210988e7617f896162bedc00af0b5baee",
      "filename": "src/core/client/admin/components/ModerateCard/__snapshots__/ModerateCard.spec.tsx.snap",
      "status": "modified",
      "additions": 6,
      "deletions": 2,
      "changes": 8,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/components/ModerateCard/__snapshots__/ModerateCard.spec.tsx.snap",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/components/ModerateCard/__snapshots__/ModerateCard.spec.tsx.snap",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/ModerateCard/__snapshots__/ModerateCard.spec.tsx.snap?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -761,9 +761,13 @@ exports[`renders story info 1`] = `\n               </span>\n             </div>\n             <div\n-              className=\"ModerateCard-storyTitle\"\n+              className=\"ModerateCard-commentOn\"\n             >\n-              Cancer cured!\n+              <span\n+                className=\"ModerateCard-storyTitle\"\n+              >\n+                Cancer cured!\n+              </span>\n             </div>\n             <div>\n               <Localized"
    },
    {
      "sha": "acd4b5af638af6a539b6eee76f2e89f34e844d40",
      "filename": "src/core/client/admin/components/PaginatedSelect/PaginatedSelect.css",
      "status": "added",
      "additions": 45,
      "deletions": 0,
      "changes": 45,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/components/PaginatedSelect/PaginatedSelect.css",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/components/PaginatedSelect/PaginatedSelect.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/PaginatedSelect/PaginatedSelect.css?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,45 @@\n+.root {\n+  margin-top: var(--v2-spacing-2);\n+}\n+\n+.dropdown {\n+  max-height: 15em;\n+  width: calc(20 * var(--mini-unit));\n+  overflow: auto;\n+}\n+\n+.wrapper {\n+  overflow-x: hidden;\n+  /* adjust for button line-height being > 1 */\n+  margin-top: -2px;\n+}\n+\n+.button {\n+  color: var(--v2-colors-mono-500) !important;\n+  border-width: 0;\n+  width: calc(20 * var(--mini-unit));\n+  margin-right: calc(var(--v2-spacing-1) / 2);\n+  font-size: var(--v2-font-size-3);\n+  line-height: var(--v2-line-height-min);\n+  justify-content: space-between;\n+}\n+\n+.buttonIconLeft {\n+  width: 20px;\n+  margin-right: calc(var(--v2-spacing-1) / 2);\n+}\n+\n+.buttonIconRight {\n+  width: 16px;\n+}\n+\n+.buttonIconLeft,\n+.buttonIconRight {\n+  /* adjust for button line-height being > 1 */\n+  margin-top: -2px;\n+}\n+\n+.buttonText {\n+  overflow-x: hidden;\n+  text-overflow: ellipsis;\n+}"
    },
    {
      "sha": "7f33dc8850909625701049430aa723bf002e21f6",
      "filename": "src/core/client/admin/components/PaginatedSelect/PaginatedSelect.tsx",
      "status": "added",
      "additions": 98,
      "deletions": 0,
      "changes": 98,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/components/PaginatedSelect/PaginatedSelect.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/components/PaginatedSelect/PaginatedSelect.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/PaginatedSelect/PaginatedSelect.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,98 @@\n+import cn from \"classnames\";\n+import React, { FunctionComponent } from \"react\";\n+\n+import AutoLoadMore from \"coral-admin/components/AutoLoadMore\";\n+import { IntersectionProvider } from \"coral-framework/lib/intersection\";\n+import {\n+  Button,\n+  ButtonIcon,\n+  ClickOutside,\n+  Dropdown,\n+  Flex,\n+  Popover,\n+  Spinner,\n+} from \"coral-ui/components/v2\";\n+\n+import styles from \"./PaginatedSelect.css\";\n+\n+interface Props {\n+  onLoadMore: () => void;\n+  icon?: string;\n+  hasMore: boolean;\n+  disableLoadMore: boolean;\n+  loading: boolean;\n+  selected: React.ReactNode;\n+  className?: string;\n+}\n+\n+const PaginatedSelect: FunctionComponent<Props> = ({\n+  loading,\n+  onLoadMore,\n+  disableLoadMore,\n+  hasMore,\n+  children,\n+  icon,\n+  selected,\n+  className,\n+}) => {\n+  return (\n+    <Popover\n+      id=\"\"\n+      placement=\"bottom-end\"\n+      modifiers={{ arrow: { enabled: false }, offset: { offset: \"0, 4\" } }}\n+      body={({ toggleVisibility }) => (\n+        <ClickOutside onClickOutside={toggleVisibility}>\n+          <IntersectionProvider>\n+            <Dropdown className={styles.dropdown}>\n+              {children}\n+              {loading && (\n+                <Flex justifyContent=\"center\">\n+                  <Spinner />\n+                </Flex>\n+              )}\n+              {hasMore && (\n+                <Flex justifyContent=\"center\">\n+                  <AutoLoadMore\n+                    disableLoadMore={disableLoadMore}\n+                    onLoadMore={onLoadMore}\n+                  />\n+                </Flex>\n+              )}\n+            </Dropdown>\n+          </IntersectionProvider>\n+        </ClickOutside>\n+      )}\n+    >\n+      {({ toggleVisibility, ref, visible }) => (\n+        <Button\n+          className={cn(styles.button, className)}\n+          variant=\"flat\"\n+          adornmentLeft\n+          color=\"mono\"\n+          onClick={toggleVisibility}\n+          ref={ref}\n+          uppercase={false}\n+        >\n+          {icon && (\n+            <ButtonIcon className={styles.buttonIconLeft}>{icon}</ButtonIcon>\n+          )}\n+          <Flex alignItems=\"center\" className={styles.wrapper}>\n+            {selected}\n+          </Flex>\n+          {!visible && (\n+            <ButtonIcon className={styles.buttonIconRight}>\n+              keyboard_arrow_down\n+            </ButtonIcon>\n+          )}\n+          {visible && (\n+            <ButtonIcon className={styles.buttonIconRight}>\n+              keyboard_arrow_up\n+            </ButtonIcon>\n+          )}\n+        </Button>\n+      )}\n+    </Popover>\n+  );\n+};\n+\n+export default PaginatedSelect;"
    },
    {
      "sha": "bcf587a6a1e2931495f63166c1f5c20576f16e70",
      "filename": "src/core/client/admin/components/PaginatedSelect/index.ts",
      "status": "added",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/components/PaginatedSelect/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/components/PaginatedSelect/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/components/PaginatedSelect/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1 @@\n+export { default } from \"./PaginatedSelect\";"
    },
    {
      "sha": "a8707b1e089ed68f17fdc30b91df66d0a9305987",
      "filename": "src/core/client/admin/helpers/getModerationLink.ts",
      "status": "removed",
      "additions": 0,
      "deletions": 10,
      "changes": 10,
      "blob_url": "https://github.com/coralproject/talk/blob/014aa2d86ad54fc1139c4fef6d05f96426c7ea91/src/core/client/admin/helpers/getModerationLink.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/014aa2d86ad54fc1139c4fef6d05f96426c7ea91/src/core/client/admin/helpers/getModerationLink.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/helpers/getModerationLink.ts?ref=014aa2d86ad54fc1139c4fef6d05f96426c7ea91",
      "patch": "@@ -1,10 +0,0 @@\n-const basePath = \"/admin/moderate\";\n-\n-export default function getModerationLink(\n-  queue?: \"default\" | \"reported\" | \"pending\" | \"unmoderated\" | \"rejected\",\n-  storyID?: string | null\n-) {\n-  const queuePart = queue && queue !== \"default\" ? `/${queue}` : \"\";\n-  const storyPart = storyID ? `/${encodeURIComponent(storyID)}` : \"\";\n-  return `${basePath}${queuePart}${storyPart}`;\n-}"
    },
    {
      "sha": "bded7865a71645816cd143cdb5472cd6d15ba1ce",
      "filename": "src/core/client/admin/helpers/getQueueConnection.ts",
      "status": "modified",
      "additions": 7,
      "deletions": 2,
      "changes": 9,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/helpers/getQueueConnection.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/helpers/getQueueConnection.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/helpers/getQueueConnection.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -13,16 +13,21 @@ import {\n export default function getQueueConnection(\n   store: RecordSourceSelectorProxy | RecordSourceProxy,\n   queue: GQLMODERATION_QUEUE_RL | \"REJECTED\",\n-  storyID?: string | null\n+  storyID?: string | null,\n+  siteID?: string | null\n ): RecordProxy | null | undefined {\n   const root = store.getRoot();\n   if (queue === \"REJECTED\") {\n     return ConnectionHandler.getConnection(root, \"RejectedQueue_comments\", {\n       status: GQLCOMMENT_STATUS.REJECTED,\n       storyID,\n+      siteID,\n     });\n   }\n-  const queuesRecord = root.getLinkedRecord(\"moderationQueues\", { storyID })!;\n+  const queuesRecord = root.getLinkedRecord(\"moderationQueues\", {\n+    storyID,\n+    siteID,\n+  })!;\n   if (!queuesRecord) {\n     return undefined;\n   }"
    },
    {
      "sha": "1555be6e253b14c90f4a7b93de091182024dedf8",
      "filename": "src/core/client/admin/helpers/index.ts",
      "status": "modified",
      "additions": 0,
      "deletions": 1,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/helpers/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/helpers/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/helpers/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,2 +1 @@\n export { default as getQueueConnection } from \"./getQueueConnection\";\n-export { default as getModerationLink } from \"./getModerationLink\";"
    },
    {
      "sha": "a9516b153aa7d6dc5a98227fbb4741fffcdf2c9b",
      "filename": "src/core/client/admin/local/local.graphql",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/local/local.graphql",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/local/local.graphql",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/local/local.graphql?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -31,6 +31,7 @@ type Local {\n   redirectPath: String\n   authView: View\n   authError: String\n+  siteID: String\n }\n \n extend type Query {"
    },
    {
      "sha": "bcc148404c259a8c0099f4eb2ac72198560ed2c3",
      "filename": "src/core/client/admin/routeConfig.tsx",
      "status": "modified",
      "additions": 45,
      "deletions": 5,
      "changes": 50,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routeConfig.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routeConfig.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routeConfig.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -18,6 +18,9 @@ import {\n   SlackConfigRoute,\n   WordListConfigRoute,\n } from \"./routes/Configure/sections\";\n+import { Sites } from \"./routes/Configure/sections/Sites\";\n+import AddSiteRoute from \"./routes/Configure/sections/Sites/AddSiteRoute\";\n+import SiteRoute from \"./routes/Configure/sections/Sites/SiteRoute\";\n import ForgotPasswordRoute from \"./routes/ForgotPassword\";\n import InviteRoute from \"./routes/Invite\";\n import LoginRoute from \"./routes/Login\";\n@@ -45,17 +48,49 @@ export default makeRouteConfig(\n         <Route path=\"moderate\" {...ModerateRoute.routeConfig}>\n           <Redirect from=\"/\" to=\"/admin/moderate/reported\" />\n           <Route path=\"reported\" {...ReportedQueueRoute.routeConfig} />\n-          <Route path=\"reported/:storyID\" {...ReportedQueueRoute.routeConfig} />\n+          <Route\n+            path=\"reported/stories/:storyID\"\n+            {...ReportedQueueRoute.routeConfig}\n+          />\n+          <Route\n+            path=\"reported/sites/:siteID\"\n+            {...ReportedQueueRoute.routeConfig}\n+          />\n           <Route path=\"pending\" {...PendingQueueRoute.routeConfig} />\n-          <Route path=\"pending/:storyID\" {...PendingQueueRoute.routeConfig} />\n+          <Route\n+            path=\"pending/stories/:storyID\"\n+            {...PendingQueueRoute.routeConfig}\n+          />\n+          <Route\n+            path=\"pending/sites/:siteID\"\n+            {...PendingQueueRoute.routeConfig}\n+          />\n           <Route path=\"unmoderated\" {...UnmoderatedQueueRoute.routeConfig} />\n           <Route\n-            path=\"unmoderated/:storyID\"\n+            path=\"unmoderated/stories/:storyID\"\n+            {...UnmoderatedQueueRoute.routeConfig}\n+          />\n+          <Route\n+            path=\"unmoderated/sites/:siteID\"\n             {...UnmoderatedQueueRoute.routeConfig}\n           />\n           <Route path=\"rejected\" {...RejectedQueueRoute.routeConfig} />\n-          <Route path=\"rejected/:storyID\" {...RejectedQueueRoute.routeConfig} />\n-          <Redirect from=\":storyID\" to=\"/admin/moderate/reported/:storyID\" />\n+          <Route\n+            path=\"rejected/stories/:storyID\"\n+            {...RejectedQueueRoute.routeConfig}\n+          />\n+          <Route\n+            path=\"rejected/sites/:siteID\"\n+            {...RejectedQueueRoute.routeConfig}\n+          />\n+          <Redirect\n+            from=\"stories/:storyID\"\n+            to=\"/admin/moderate/reported/stories/:storyID\"\n+          />\n+          <Redirect\n+            from=\"sites/:siteID\"\n+            to=\"/admin/moderate/reported/sites/:siteID\"\n+          />\n         </Route>\n         <Route path=\"stories\" {...StoriesRoute.routeConfig} />\n         <Route path=\"community\" {...CommunityRoute.routeConfig} />\n@@ -78,6 +113,11 @@ export default makeRouteConfig(\n             <Route path=\"email\" {...EmailConfigRoute.routeConfig} />\n             <Route path=\"slack\" {...SlackConfigRoute.routeConfig} />\n           </Route>\n+          <Route path=\"configure/organization/sites\" Component={Sites}>\n+            <Redirect from=\"/\" to=\"/admin/configure/organization/sites/new\" />\n+            <Route path=\"new\" {...AddSiteRoute.routeConfig} />\n+            <Route path=\":siteID\" {...SiteRoute.routeConfig} />\n+          </Route>\n         </Route>\n       </Route>\n     </Route>"
    },
    {
      "sha": "a7c9d2ce69ee47441b551c410798566cecbbe8be",
      "filename": "src/core/client/admin/routes/Configure/Configure.tsx",
      "status": "modified",
      "additions": 2,
      "deletions": 30,
      "changes": 32,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/Configure.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/Configure.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/Configure.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -7,10 +7,9 @@ import { Form, FormSpy } from \"react-final-form\";\n import MainLayout from \"coral-admin/components/MainLayout\";\n import { Button, CallOut, HorizontalGutter } from \"coral-ui/components/v2\";\n \n+import ConfigureLinks from \"./ConfigureLinks\";\n import Layout from \"./Layout\";\n-import Link from \"./Link\";\n import Main from \"./Main\";\n-import Navigation from \"./Navigation\";\n import SideBar from \"./SideBar\";\n \n interface Props {\n@@ -32,34 +31,7 @@ const Configure: FunctionComponent<Props> = ({\n           <Layout>\n             <SideBar>\n               <HorizontalGutter size=\"double\">\n-                <Navigation>\n-                  <Localized id=\"configure-sideBarNavigation-general\">\n-                    <Link to=\"/admin/configure/general\">General</Link>\n-                  </Localized>\n-                  <Localized id=\"configure-sideBarNavigation-organization\">\n-                    <Link to=\"/admin/configure/organization\">Organization</Link>\n-                  </Localized>\n-                  <Localized id=\"configure-sideBarNavigation-moderation\">\n-                    <Link to=\"/admin/configure/moderation\">Moderation</Link>\n-                  </Localized>\n-                  <Localized id=\"configure-sideBarNavigation-bannedAndSuspectWords\">\n-                    <Link to=\"/admin/configure/wordList\">\n-                      Banned and Suspect Words\n-                    </Link>\n-                  </Localized>\n-                  <Localized id=\"configure-sideBarNavigation-authentication\">\n-                    <Link to=\"/admin/configure/auth\">Authentication</Link>\n-                  </Localized>\n-                  <Localized id=\"configure-sideBarNavigation-email\">\n-                    <Link to=\"/admin/configure/email\">Email</Link>\n-                  </Localized>\n-                  <Localized id=\"configure-sideBarNavigation-slack\">\n-                    <Link to=\"/admin/configure/slack\">Slack</Link>\n-                  </Localized>\n-                  <Localized id=\"configure-sideBarNavigation-advanced\">\n-                    <Link to=\"/admin/configure/advanced\">Advanced</Link>\n-                  </Localized>\n-                </Navigation>\n+                <ConfigureLinks />\n               </HorizontalGutter>\n               <HorizontalGutter size=\"double\">\n                 <Localized id=\"configure-sideBar-saveChanges\">"
    },
    {
      "sha": "64c0531dde7ff6fa6cc0a0fa9aba1f7cd64a210e",
      "filename": "src/core/client/admin/routes/Configure/ConfigureLinks.tsx",
      "status": "added",
      "additions": 38,
      "deletions": 0,
      "changes": 38,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/ConfigureLinks.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/ConfigureLinks.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/ConfigureLinks.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,38 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import React, { FunctionComponent } from \"react\";\n+\n+import Link from \"./Link\";\n+import Navigation from \"./Navigation\";\n+\n+const ConfigureLinks: FunctionComponent<{}> = () => {\n+  return (\n+    <Navigation>\n+      <Localized id=\"configure-sideBarNavigation-general\">\n+        <Link to=\"/admin/configure/general\">General</Link>\n+      </Localized>\n+      <Localized id=\"configure-sideBarNavigation-organization\">\n+        <Link to=\"/admin/configure/organization\">Organization</Link>\n+      </Localized>\n+      <Localized id=\"configure-sideBarNavigation-moderation\">\n+        <Link to=\"/admin/configure/moderation\">Moderation</Link>\n+      </Localized>\n+      <Localized id=\"configure-sideBarNavigation-bannedAndSuspectWords\">\n+        <Link to=\"/admin/configure/wordList\">Banned and Suspect Words</Link>\n+      </Localized>\n+      <Localized id=\"configure-sideBarNavigation-authentication\">\n+        <Link to=\"/admin/configure/auth\">Authentication</Link>\n+      </Localized>\n+      <Localized id=\"configure-sideBarNavigation-email\">\n+        <Link to=\"/admin/configure/email\">Email</Link>\n+      </Localized>\n+      <Localized id=\"configure-sideBarNavigation-slack\">\n+        <Link to=\"/admin/configure/slack\">Slack</Link>\n+      </Localized>\n+      <Localized id=\"configure-sideBarNavigation-advanced\">\n+        <Link to=\"/admin/configure/advanced\">Advanced</Link>\n+      </Localized>\n+    </Navigation>\n+  );\n+};\n+\n+export default ConfigureLinks;"
    },
    {
      "sha": "b6de315d4634ec15d670a03d4e5e0b976c742bbb",
      "filename": "src/core/client/admin/routes/Configure/sections/Advanced/AdvancedConfigContainer.tsx",
      "status": "modified",
      "additions": 0,
      "deletions": 7,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Advanced/AdvancedConfigContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Advanced/AdvancedConfigContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Advanced/AdvancedConfigContainer.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -12,8 +12,6 @@ import { AdvancedConfigContainer_settings } from \"coral-admin/__generated__/Adva\n \n import CommentStreamLiveUpdatesContainer from \"./CommentStreamLiveUpdatesContainer\";\n import CustomCSSConfig from \"./CustomCSSConfig\";\n-import EmbedCodeContainer from \"./EmbedCodeContainer\";\n-import PermittedDomainsConfig from \"./PermittedDomainsConfig\";\n import StoryCreationConfig from \"./StoryCreationConfig\";\n \n interface Props {\n@@ -29,13 +27,11 @@ const AdvancedConfigContainer: React.FunctionComponent<Props> = ({\n   useMemo(() => form.initialize(purgeMetadata(settings)), []);\n   return (\n     <HorizontalGutter size=\"double\" data-testid=\"configure-advancedContainer\">\n-      <EmbedCodeContainer settings={settings} />\n       <CustomCSSConfig disabled={submitting} />\n       <CommentStreamLiveUpdatesContainer\n         disabled={submitting}\n         settings={settings}\n       />\n-      <PermittedDomainsConfig disabled={submitting} />\n       <StoryCreationConfig disabled={submitting} />\n     </HorizontalGutter>\n   );\n@@ -45,11 +41,8 @@ const enhanced = withFragmentContainer<Props>({\n   settings: graphql`\n     fragment AdvancedConfigContainer_settings on Settings {\n       ...CustomCSSConfig_formValues @relay(mask: false)\n-      ...PermittedDomainsConfig_formValues @relay(mask: false)\n       ...CommentStreamLiveUpdates_formValues @relay(mask: false)\n       ...StoryCreationConfig_formValues @relay(mask: false)\n-\n-      ...EmbedCodeContainer_settings\n       ...CommentStreamLiveUpdatesContainer_settings\n     }\n   `,"
    },
    {
      "sha": "268e0a0a2d81990d57e4a8f9bda6d13c471a96e9",
      "filename": "src/core/client/admin/routes/Configure/sections/Advanced/EmbedCodeContainer.tsx",
      "status": "removed",
      "additions": 0,
      "deletions": 26,
      "changes": 26,
      "blob_url": "https://github.com/coralproject/talk/blob/014aa2d86ad54fc1139c4fef6d05f96426c7ea91/src/core/client/admin/routes/Configure/sections/Advanced/EmbedCodeContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/014aa2d86ad54fc1139c4fef6d05f96426c7ea91/src/core/client/admin/routes/Configure/sections/Advanced/EmbedCodeContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Advanced/EmbedCodeContainer.tsx?ref=014aa2d86ad54fc1139c4fef6d05f96426c7ea91",
      "patch": "@@ -1,26 +0,0 @@\n-import React, { FunctionComponent } from \"react\";\n-import { graphql } from \"react-relay\";\n-\n-import { withFragmentContainer } from \"coral-framework/lib/relay\";\n-\n-import { EmbedCodeContainer_settings } from \"coral-admin/__generated__/EmbedCodeContainer_settings.graphql\";\n-\n-import EmbedCode from \"./EmbedCode\";\n-\n-interface Props {\n-  settings: EmbedCodeContainer_settings;\n-}\n-\n-const EmbedCodeContainer: FunctionComponent<Props> = ({ settings }) => {\n-  return <EmbedCode staticURI={settings.staticURI} />;\n-};\n-\n-const enhanced = withFragmentContainer<Props>({\n-  settings: graphql`\n-    fragment EmbedCodeContainer_settings on Settings {\n-      staticURI\n-    }\n-  `,\n-})(EmbedCodeContainer);\n-\n-export default enhanced;"
    },
    {
      "sha": "6cf992571e6beec9298d14dc138166db2a42f959",
      "filename": "src/core/client/admin/routes/Configure/sections/Advanced/PermittedDomainsConfig.tsx",
      "status": "removed",
      "additions": 0,
      "deletions": 71,
      "changes": 71,
      "blob_url": "https://github.com/coralproject/talk/blob/014aa2d86ad54fc1139c4fef6d05f96426c7ea91/src/core/client/admin/routes/Configure/sections/Advanced/PermittedDomainsConfig.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/014aa2d86ad54fc1139c4fef6d05f96426c7ea91/src/core/client/admin/routes/Configure/sections/Advanced/PermittedDomainsConfig.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Advanced/PermittedDomainsConfig.tsx?ref=014aa2d86ad54fc1139c4fef6d05f96426c7ea91",
      "patch": "@@ -1,71 +0,0 @@\n-import { Localized } from \"@fluent/react/compat\";\n-import React, { FunctionComponent } from \"react\";\n-import { Field } from \"react-final-form\";\n-import { graphql } from \"react-relay\";\n-\n-import { formatStringList, parseStringList } from \"coral-framework/lib/form\";\n-import { validateStrictURLList } from \"coral-framework/lib/validation\";\n-import { FormField, FormFieldDescription } from \"coral-ui/components/v2\";\n-\n-import ConfigBox from \"../../ConfigBox\";\n-import Header from \"../../Header\";\n-import TextFieldWithValidation from \"../../TextFieldWithValidation\";\n-\n-// eslint-disable-next-line no-unused-expressions\n-graphql`\n-  fragment PermittedDomainsConfig_formValues on Settings {\n-    allowedDomains\n-  }\n-`;\n-\n-interface Props {\n-  disabled: boolean;\n-}\n-\n-const PermittedDomainsConfig: FunctionComponent<Props> = ({ disabled }) => (\n-  <ConfigBox\n-    title={\n-      <Localized id=\"configure-advanced-permittedDomains\">\n-        <Header htmlFor=\"configure-advanced-allowedDomains\">\n-          Permitted domains\n-        </Header>\n-      </Localized>\n-    }\n-  >\n-    <FormField>\n-      <Localized\n-        id=\"configure-advanced-permittedDomains-description\"\n-        strong={<strong />}\n-      >\n-        <FormFieldDescription>\n-          The domains you would like to permit for Coral, e.g. your local,\n-          staging and production environments including the scheme (ex.\n-          http://localhost:3000, https://staging.domain.com,\n-          https://domain.com).\n-        </FormFieldDescription>\n-      </Localized>\n-      <Field\n-        name=\"allowedDomains\"\n-        parse={parseStringList}\n-        format={formatStringList}\n-        validate={validateStrictURLList}\n-      >\n-        {({ input, meta }) => (\n-          <TextFieldWithValidation\n-            {...input}\n-            id={`configure-advanced-${input.name}`}\n-            disabled={disabled}\n-            autoComplete=\"off\"\n-            autoCorrect=\"off\"\n-            autoCapitalize=\"off\"\n-            spellCheck={false}\n-            meta={meta}\n-            fullWidth\n-          />\n-        )}\n-      </Field>\n-    </FormField>\n-  </ConfigBox>\n-);\n-\n-export default PermittedDomainsConfig;"
    },
    {
      "sha": "4ebc7ceabd257aa08d0c1b9d46efd38dd2823a13",
      "filename": "src/core/client/admin/routes/Configure/sections/Organization/EmptySitesMessage.tsx",
      "status": "added",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Organization/EmptySitesMessage.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Organization/EmptySitesMessage.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Organization/EmptySitesMessage.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,10 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import React, { FunctionComponent } from \"react\";\n+\n+const EmptySitesMessage: FunctionComponent = props => (\n+  <Localized id=\"sites-emptyMessage\">\n+    <div>We could not find any sites matching your criteria.</div>\n+  </Localized>\n+);\n+\n+export default EmptySitesMessage;"
    },
    {
      "sha": "ec8e43ab21ac611bc1b7e60f3c124746d4d31814",
      "filename": "src/core/client/admin/routes/Configure/sections/Organization/OrganizationConfigContainer.tsx",
      "status": "modified",
      "additions": 4,
      "deletions": 8,
      "changes": 12,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Organization/OrganizationConfigContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Organization/OrganizationConfigContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Organization/OrganizationConfigContainer.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -6,7 +6,6 @@ import {\n   purgeMetadata,\n   withFragmentContainer,\n } from \"coral-framework/lib/relay\";\n-import { HorizontalGutter } from \"coral-ui/components\";\n \n import { OrganizationConfigContainer_settings as SettingsData } from \"coral-admin/__generated__/OrganizationConfigContainer_settings.graphql\";\n \n@@ -25,22 +24,19 @@ const OrganizationConfigContainer: React.FunctionComponent<Props> = ({\n   const form = useForm();\n   useMemo(() => form.initialize(purgeMetadata(settings)), []);\n   return (\n-    <HorizontalGutter\n-      size=\"double\"\n-      data-testid=\"configure-organizationContainer\"\n-    >\n+    <>\n       <OrganizationNameConfig disabled={submitting} />\n-      <OrganizationContactEmailConfig disabled={submitting} />\n       <OrganizationURLConfig disabled={submitting} />\n-    </HorizontalGutter>\n+      <OrganizationContactEmailConfig disabled={submitting} />\n+    </>\n   );\n };\n const enhanced = withFragmentContainer<Props>({\n   settings: graphql`\n     fragment OrganizationConfigContainer_settings on Settings {\n       ...OrganizationNameConfig_formValues @relay(mask: false)\n-      ...OrganizationContactEmailConfig_formValues @relay(mask: false)\n       ...OrganizationURLConfig_formValues @relay(mask: false)\n+      ...OrganizationContactEmailConfig_formValues @relay(mask: false)\n     }\n   `,\n })(OrganizationConfigContainer);"
    },
    {
      "sha": "1e2d4480e63d27ec8fb3acf68592d4a6e81282d4",
      "filename": "src/core/client/admin/routes/Configure/sections/Organization/OrganizationConfigRoute.tsx",
      "status": "modified",
      "additions": 13,
      "deletions": 5,
      "changes": 18,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Organization/OrganizationConfigRoute.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Organization/OrganizationConfigRoute.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Organization/OrganizationConfigRoute.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -2,11 +2,12 @@ import React from \"react\";\n import { graphql } from \"react-relay\";\n \n import { withRouteConfig } from \"coral-framework/lib/router\";\n-import { Delay, Spinner } from \"coral-ui/components/v2\";\n+import { Delay, HorizontalGutter, Spinner } from \"coral-ui/components/v2\";\n \n import { OrganizationConfigRouteQueryResponse } from \"coral-admin/__generated__/OrganizationConfigRouteQuery.graphql\";\n \n import OrganizationConfigContainer from \"./OrganizationConfigContainer\";\n+import SitesConfigContainer from \"./SitesConfigContainer\";\n \n interface Props {\n   data: OrganizationConfigRouteQueryResponse | null;\n@@ -23,10 +24,16 @@ class OrganizationConfigRoute extends React.Component<Props> {\n       );\n     }\n     return (\n-      <OrganizationConfigContainer\n-        settings={this.props.data.settings}\n-        submitting={this.props.submitting}\n-      />\n+      <HorizontalGutter\n+        spacing={4}\n+        data-testid=\"configure-organizationContainer\"\n+      >\n+        <OrganizationConfigContainer\n+          settings={this.props.data.settings}\n+          submitting={this.props.submitting}\n+        />\n+        <SitesConfigContainer query={this.props.data} />\n+      </HorizontalGutter>\n     );\n   }\n }\n@@ -37,6 +44,7 @@ const enhanced = withRouteConfig<Props>({\n       settings {\n         ...OrganizationConfigContainer_settings\n       }\n+      ...SitesConfigContainer_query\n     }\n   `,\n   cacheConfig: { force: true },"
    },
    {
      "sha": "09aad23a1b6b541bcac772207e93aeaddbdd1004",
      "filename": "src/core/client/admin/routes/Configure/sections/Organization/SiteRowContainer.tsx",
      "status": "added",
      "additions": 49,
      "deletions": 0,
      "changes": 49,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Organization/SiteRowContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Organization/SiteRowContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Organization/SiteRowContainer.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,49 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import React, { FunctionComponent } from \"react\";\n+\n+import { graphql, withFragmentContainer } from \"coral-framework/lib/relay\";\n+import { Button, Flex, Icon } from \"coral-ui/components/v2\";\n+import { TableCell, TableRow } from \"coral-ui/components/v2/Table\";\n+\n+import { SiteRowContainer_site } from \"coral-admin/__generated__/SiteRowContainer_site.graphql\";\n+\n+interface Props {\n+  site: SiteRowContainer_site;\n+}\n+\n+const SiteRowContainer: FunctionComponent<Props> = ({ site }) => {\n+  return (\n+    <TableRow>\n+      <TableCell>{site.name}</TableCell>\n+      <TableCell>\n+        <Flex justifyContent=\"flex-end\">\n+          <Localized\n+            id=\"configure-sites-site-details\"\n+            icon={<Icon>keyboard_arrow_right</Icon>}\n+          >\n+            <Button\n+              variant=\"text\"\n+              to={`/admin/configure/organization/sites/${site.id}`}\n+              iconRight\n+            >\n+              Details\n+              <Icon>keyboard_arrow_right</Icon>\n+            </Button>\n+          </Localized>\n+        </Flex>\n+      </TableCell>\n+    </TableRow>\n+  );\n+};\n+\n+const enhanced = withFragmentContainer<Props>({\n+  site: graphql`\n+    fragment SiteRowContainer_site on Site {\n+      id\n+      name\n+      createdAt\n+    }\n+  `,\n+})(SiteRowContainer);\n+\n+export default enhanced;"
    },
    {
      "sha": "694faf4b17ae2991ec83e292e1004d0c7aaee9ca",
      "filename": "src/core/client/admin/routes/Configure/sections/Organization/SitesConfig.tsx",
      "status": "added",
      "additions": 67,
      "deletions": 0,
      "changes": 67,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Organization/SitesConfig.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Organization/SitesConfig.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Organization/SitesConfig.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,67 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import React, { FunctionComponent } from \"react\";\n+\n+import { PropTypesOf } from \"coral-framework/types\";\n+import { Button, FormFieldDescription, Icon } from \"coral-ui/components/v2\";\n+\n+import ConfigBox from \"../../ConfigBox\";\n+import Header from \"../../Header\";\n+import SiteRowContainer from \"./SiteRowContainer\";\n+import SitesTable from \"./SitesTable\";\n+\n+interface Props {\n+  sites: Array<{ id: string } & PropTypesOf<typeof SiteRowContainer>[\"site\"]>;\n+  onLoadMore: () => void;\n+  hasMore: boolean;\n+  disableLoadMore: boolean;\n+  loading: boolean;\n+}\n+\n+const SitesConfig: FunctionComponent<Props> = ({\n+  sites,\n+  loading,\n+  disableLoadMore,\n+  onLoadMore,\n+  hasMore,\n+}) => {\n+  return (\n+    <ConfigBox\n+      title={\n+        <Localized id=\"configure-organization-sites\">\n+          <Header htmlFor=\"configure-organization-organization.sites\">\n+            Sites\n+          </Header>\n+        </Localized>\n+      }\n+    >\n+      <Localized id=\"configure-organization-sites-explanation\">\n+        <FormFieldDescription>\n+          Add a new site to your organization or edit an existing site's\n+          details.\n+        </FormFieldDescription>\n+      </Localized>\n+      <Localized\n+        id=\"configure-organization-sites-add-site\"\n+        icon={<Icon>add</Icon>}\n+      >\n+        <Button\n+          to=\"/admin/configure/organization/sites/new\"\n+          iconLeft\n+          size=\"large\"\n+        >\n+          <Icon>add</Icon>\n+          Add a site\n+        </Button>\n+      </Localized>\n+      <SitesTable\n+        sites={sites}\n+        loading={loading}\n+        onLoadMore={onLoadMore}\n+        hasMore={hasMore}\n+        disableLoadMore={disableLoadMore}\n+      />\n+    </ConfigBox>\n+  );\n+};\n+\n+export default SitesConfig;"
    },
    {
      "sha": "bd813e1cc3ac5f515b97afc1b2d1ed58e5cac34a",
      "filename": "src/core/client/admin/routes/Configure/sections/Organization/SitesConfigContainer.tsx",
      "status": "added",
      "additions": 94,
      "deletions": 0,
      "changes": 94,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Organization/SitesConfigContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Organization/SitesConfigContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Organization/SitesConfigContainer.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,94 @@\n+import React from \"react\";\n+import { graphql, RelayPaginationProp } from \"react-relay\";\n+\n+import { IntersectionProvider } from \"coral-framework/lib/intersection\";\n+import {\n+  useLoadMore,\n+  useRefetch,\n+  withPaginationContainer,\n+} from \"coral-framework/lib/relay\";\n+\n+import { SitesConfigContainer_query as QueryData } from \"coral-admin/__generated__/SitesConfigContainer_query.graphql\";\n+import { SitesConfigContainerPaginationQueryVariables } from \"coral-admin/__generated__/SitesConfigContainerPaginationQuery.graphql\";\n+\n+import SitesConfig from \"./SitesConfig\";\n+\n+interface Props {\n+  query: QueryData | null;\n+  relay: RelayPaginationProp;\n+}\n+const SitesConfigContainer: React.FunctionComponent<Props> = props => {\n+  const sites = props.query\n+    ? props.query.sites.edges.map(edge => edge.node)\n+    : [];\n+  const [loadMore, isLoadingMore] = useLoadMore(props.relay, 10);\n+  const [, isRefetching] = useRefetch<\n+    SitesConfigContainerPaginationQueryVariables\n+  >(props.relay);\n+  return (\n+    <IntersectionProvider>\n+      <SitesConfig\n+        loading={!props.query || isRefetching}\n+        sites={sites}\n+        onLoadMore={loadMore}\n+        hasMore={!isRefetching && props.relay.hasMore()}\n+        disableLoadMore={isLoadingMore}\n+      />\n+    </IntersectionProvider>\n+  );\n+};\n+\n+type FragmentVariables = SitesConfigContainerPaginationQueryVariables;\n+\n+const enhanced = withPaginationContainer<\n+  Props,\n+  SitesConfigContainerPaginationQueryVariables,\n+  FragmentVariables\n+>(\n+  {\n+    query: graphql`\n+      fragment SitesConfigContainer_query on Query\n+        @argumentDefinitions(\n+          count: { type: \"Int!\", defaultValue: 20 }\n+          cursor: { type: \"Cursor\" }\n+        ) {\n+        sites(first: $count, after: $cursor)\n+          @connection(key: \"SitesConfig_sites\") {\n+          edges {\n+            node {\n+              id\n+              ...SiteRowContainer_site\n+            }\n+          }\n+        }\n+      }\n+    `,\n+  },\n+  {\n+    direction: \"forward\",\n+    getConnectionFromProps(props) {\n+      return props.query && props.query.sites;\n+    },\n+    // This is also the default implementation of `getFragmentVariables` if it isn't provided.\n+    getFragmentVariables(prevVars, totalCount) {\n+      return {\n+        ...prevVars,\n+        count: totalCount,\n+      };\n+    },\n+    getVariables(props, { count, cursor }, fragmentVariables) {\n+      return {\n+        count,\n+        cursor,\n+      };\n+    },\n+    query: graphql`\n+      # Pagination query to be fetched upon calling 'loadMore'.\n+      # Notice that we re-use our fragment, and the shape of this query matches our fragment spec.\n+      query SitesConfigContainerPaginationQuery($count: Int!, $cursor: Cursor) {\n+        ...SitesConfigContainer_query @arguments(count: $count, cursor: $cursor)\n+      }\n+    `,\n+  }\n+)(SitesConfigContainer);\n+export default enhanced;"
    },
    {
      "sha": "246a6625cab0ddb4c651a3b1223ef60f8d26e246",
      "filename": "src/core/client/admin/routes/Configure/sections/Organization/SitesTable.tsx",
      "status": "added",
      "additions": 63,
      "deletions": 0,
      "changes": 63,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Organization/SitesTable.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Organization/SitesTable.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Organization/SitesTable.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,63 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import React, { FunctionComponent } from \"react\";\n+\n+import AutoLoadMore from \"coral-admin/components/AutoLoadMore\";\n+import { PropTypesOf } from \"coral-framework/types\";\n+import {\n+  Flex,\n+  Spinner,\n+  Table,\n+  TableBody,\n+  TableCell,\n+  TableHead,\n+  TableRow,\n+} from \"coral-ui/components/v2\";\n+\n+import EmptySitesMessage from \"./EmptySitesMessage\";\n+import SiteRowContainer from \"./SiteRowContainer\";\n+\n+interface Props {\n+  sites: Array<{ id: string } & PropTypesOf<typeof SiteRowContainer>[\"site\"]>;\n+  onLoadMore: () => void;\n+  hasMore: boolean;\n+  disableLoadMore: boolean;\n+  loading: boolean;\n+}\n+\n+const SitesTable: FunctionComponent<Props> = props => {\n+  return (\n+    <>\n+      <Table fullWidth>\n+        <TableHead>\n+          <TableRow>\n+            <Localized id=\"site-table-siteName\">\n+              <TableCell>Site name</TableCell>\n+            </Localized>\n+            <TableCell />\n+          </TableRow>\n+        </TableHead>\n+        <TableBody>\n+          {props.sites.map(site => (\n+            <SiteRowContainer site={site} key={site.id} />\n+          ))}\n+        </TableBody>\n+      </Table>\n+      {!props.loading && props.sites.length === 0 && <EmptySitesMessage />}\n+      {props.loading && (\n+        <Flex justifyContent=\"center\">\n+          <Spinner />\n+        </Flex>\n+      )}\n+      {props.hasMore && (\n+        <Flex justifyContent=\"center\">\n+          <AutoLoadMore\n+            disableLoadMore={props.disableLoadMore}\n+            onLoadMore={props.onLoadMore}\n+          />\n+        </Flex>\n+      )}\n+    </>\n+  );\n+};\n+\n+export default SitesTable;"
    },
    {
      "sha": "ae1fc9c717a0f3ef712a4380aba174b21125c228",
      "filename": "src/core/client/admin/routes/Configure/sections/Sites/AddSiteRoute.tsx",
      "status": "added",
      "additions": 75,
      "deletions": 0,
      "changes": 75,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/AddSiteRoute.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/AddSiteRoute.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Sites/AddSiteRoute.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,75 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import { useRouter } from \"found\";\n+import React, { FunctionComponent, useCallback } from \"react\";\n+\n+import { useNotification } from \"coral-admin/App/GlobalNotification\";\n+import { graphql } from \"coral-framework/lib/relay\";\n+import { withRouteConfig } from \"coral-framework/lib/router\";\n+import { AppNotification } from \"coral-ui/components/v2\";\n+\n+import { AddSiteRouteQueryResponse } from \"coral-admin/__generated__/AddSiteRouteQuery.graphql\";\n+\n+import ConfigBox from \"../../ConfigBox\";\n+import Header from \"../../Header\";\n+import CreateSiteForm from \"./CreateSiteForm\";\n+\n+interface Props {\n+  data: AddSiteRouteQueryResponse | null;\n+}\n+\n+const AddSiteRoute: FunctionComponent<Props> = props => {\n+  const { router } = useRouter();\n+  const { setMessage, clearMessage } = useNotification();\n+  const onSiteCreate = useCallback(\n+    (id: string, name: string) => {\n+      router.replace(`/admin/configure/organization/sites/${id}`);\n+      setMessage(\n+        <Localized\n+          id=\"configure-sites-add-success\"\n+          $site={name}\n+          $org={props.data && props.data.settings.organization.name}\n+        >\n+          <AppNotification icon=\"check_circle_outline\" onClose={clearMessage}>\n+            {name} has been added to{\" \"}\n+            {props.data && props.data.settings.organization.name}\n+          </AppNotification>\n+        </Localized>\n+      );\n+    },\n+    [props.data]\n+  );\n+  if (!props.data) {\n+    return null;\n+  }\n+  return (\n+    <ConfigBox\n+      title={\n+        <Localized\n+          id=\"configure-sites-add-new-site\"\n+          $site={props.data.settings.organization.name}\n+        >\n+          <Header>\n+            Add a new site to {props.data.settings.organization.name}\n+          </Header>\n+        </Localized>\n+      }\n+    >\n+      <CreateSiteForm onCreate={onSiteCreate} />\n+    </ConfigBox>\n+  );\n+};\n+\n+const enhanced = withRouteConfig<Props>({\n+  query: graphql`\n+    query AddSiteRouteQuery {\n+      settings {\n+        organization {\n+          name\n+        }\n+      }\n+    }\n+  `,\n+  cacheConfig: { force: true },\n+})(AddSiteRoute);\n+\n+export default enhanced;"
    },
    {
      "sha": "37c70577a8aab24cc07fc2edcdcbb6744155af90",
      "filename": "src/core/client/admin/routes/Configure/sections/Sites/CreateSiteForm.tsx",
      "status": "added",
      "additions": 147,
      "deletions": 0,
      "changes": 147,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/CreateSiteForm.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/CreateSiteForm.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Sites/CreateSiteForm.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,147 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import { FormApi } from \"final-form\";\n+import React, { FunctionComponent, useCallback, useState } from \"react\";\n+import { Field, Form } from \"react-final-form\";\n+\n+import { formatStringList, parseStringList } from \"coral-framework/lib/form\";\n+import { useMutation } from \"coral-framework/lib/relay\";\n+import {\n+  required,\n+  validateStrictURLList,\n+} from \"coral-framework/lib/validation\";\n+import {\n+  Button,\n+  ButtonIcon,\n+  CallOut,\n+  Flex,\n+  FormField,\n+  FormFieldHeader,\n+  HorizontalGutter,\n+  Label,\n+} from \"coral-ui/components/v2\";\n+\n+import HelperText from \"../../HelperText\";\n+import TextFieldWithValidation from \"../../TextFieldWithValidation\";\n+import CreateSiteMutation from \"./CreateSiteMutation\";\n+\n+interface Props {\n+  onCreate: (id: string, name: string) => void;\n+}\n+\n+const CreateSiteForm: FunctionComponent<Props> = ({ onCreate }) => {\n+  const createSite = useMutation(CreateSiteMutation);\n+  const [submitError, setSubmitError] = useState<null | string>(null);\n+  const onSubmit = useCallback(\n+    async (input, form: FormApi) => {\n+      try {\n+        const response = await createSite({ site: input });\n+        if (response && response.site) {\n+          onCreate(response.site.id, response.site.name);\n+        }\n+      } catch (error) {\n+        setSubmitError(error.message);\n+      }\n+    },\n+    [onCreate]\n+  );\n+  return (\n+    <div>\n+      <Form onSubmit={onSubmit}>\n+        {({ handleSubmit, invalid, submitting, ...formProps }) => (\n+          <form onSubmit={handleSubmit}>\n+            <HorizontalGutter spacing={4}>\n+              <FormField>\n+                <FormFieldHeader>\n+                  <Localized id=\"configure-sites-site-form-name\">\n+                    <Label>Site name</Label>\n+                  </Localized>\n+                  <Localized id=\"configure-sites-site-form-name-explanation\">\n+                    <HelperText>\n+                      Site name will appear on emails sent by Coral to your\n+                      community and organization members.\n+                    </HelperText>\n+                  </Localized>\n+                </FormFieldHeader>\n+                <Field name=\"name\" validate={required}>\n+                  {({ input, meta }) => (\n+                    <TextFieldWithValidation\n+                      {...input}\n+                      id={input.name}\n+                      fullWidth\n+                      meta={meta}\n+                    />\n+                  )}\n+                </Field>\n+              </FormField>\n+              <FormField>\n+                <FormFieldHeader>\n+                  <Localized id=\"configure-sites-site-form-domains\">\n+                    <Label>Site permitted domains</Label>\n+                  </Localized>\n+                  <Localized id=\"configure-sites-site-form-domains-explanation\">\n+                    <HelperText>\n+                      Domains where your Coral comment streams are allowed to be\n+                      embedded (ex. http://localhost:3000,\n+                      https://staging.domain.com, https://domain.com).\n+                    </HelperText>\n+                  </Localized>\n+                </FormFieldHeader>\n+                <Field\n+                  name=\"allowedOrigins\"\n+                  parse={parseStringList}\n+                  format={formatStringList}\n+                  validate={validateStrictURLList}\n+                >\n+                  {({ input, meta }) => (\n+                    <TextFieldWithValidation\n+                      {...input}\n+                      id={`configure-advanced-${input.name}`}\n+                      autoComplete=\"off\"\n+                      autoCorrect=\"off\"\n+                      autoCapitalize=\"off\"\n+                      spellCheck={false}\n+                      meta={meta}\n+                      fullWidth\n+                    />\n+                  )}\n+                </Field>\n+              </FormField>\n+              {submitError && (\n+                <CallOut fullWidth color=\"error\">\n+                  {submitError}\n+                </CallOut>\n+              )}\n+              <Flex itemGutter justifyContent=\"flex-end\">\n+                <Localized id=\"configure-sites-site-form-cancel\">\n+                  <Button\n+                    variant=\"outline\"\n+                    size=\"large\"\n+                    color=\"mono\"\n+                    to=\"/admin/configure/organization\"\n+                  >\n+                    Cancel\n+                  </Button>\n+                </Localized>\n+                <Localized\n+                  id=\"configure-sites-site-form-submit\"\n+                  icon={<ButtonIcon>add</ButtonIcon>}\n+                >\n+                  <Button\n+                    disabled={submitting}\n+                    iconLeft\n+                    type=\"submit\"\n+                    size=\"large\"\n+                  >\n+                    Add site\n+                  </Button>\n+                </Localized>\n+              </Flex>\n+            </HorizontalGutter>\n+          </form>\n+        )}\n+      </Form>\n+    </div>\n+  );\n+};\n+\n+export default CreateSiteForm;"
    },
    {
      "sha": "6702c5c04a9c6fabaed952362a3a6d03056eef8b",
      "filename": "src/core/client/admin/routes/Configure/sections/Sites/CreateSiteMutation.ts",
      "status": "added",
      "additions": 57,
      "deletions": 0,
      "changes": 57,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/CreateSiteMutation.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/CreateSiteMutation.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Sites/CreateSiteMutation.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,57 @@\n+import { graphql } from \"react-relay\";\n+import { Environment } from \"relay-runtime\";\n+\n+import { CoralContext } from \"coral-framework/lib/bootstrap\";\n+import {\n+  commitMutationPromiseNormalized,\n+  createMutation,\n+  MutationInput,\n+} from \"coral-framework/lib/relay\";\n+\n+import { CreateSiteMutation as MutationTypes } from \"coral-admin/__generated__/CreateSiteMutation.graphql\";\n+\n+let clientMutationId = 0;\n+\n+const CreateSiteMutation = createMutation(\n+  \"createSite\",\n+  (\n+    environment: Environment,\n+    input: MutationInput<MutationTypes>,\n+    { uuidGenerator }: CoralContext\n+  ) => {\n+    const id = uuidGenerator();\n+    const now = new Date();\n+    return commitMutationPromiseNormalized<MutationTypes>(environment, {\n+      mutation: graphql`\n+        mutation CreateSiteMutation($input: CreateSiteInput!) {\n+          createSite(input: $input) {\n+            site {\n+              id\n+              name\n+              createdAt\n+            }\n+            clientMutationId\n+          }\n+        }\n+      `,\n+      variables: {\n+        input: {\n+          ...input,\n+          clientMutationId: clientMutationId.toString(),\n+        },\n+      },\n+      optimisticResponse: {\n+        createSite: {\n+          site: {\n+            id,\n+            createdAt: now.toISOString(),\n+            name: input.site.name,\n+          },\n+          clientMutationId: (clientMutationId++).toString(),\n+        },\n+      },\n+    });\n+  }\n+);\n+\n+export default CreateSiteMutation;"
    },
    {
      "sha": "e4a8ca4ee100bc93995a6f29210fcc481ad9db8d",
      "filename": "src/core/client/admin/routes/Configure/sections/Sites/EditSiteForm.tsx",
      "status": "added",
      "additions": 167,
      "deletions": 0,
      "changes": 167,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/EditSiteForm.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/EditSiteForm.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Sites/EditSiteForm.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,167 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import { FormApi } from \"final-form\";\n+import React, { FunctionComponent, useCallback, useState } from \"react\";\n+import { Field, Form } from \"react-final-form\";\n+import { graphql } from \"react-relay\";\n+\n+import { formatStringList, parseStringList } from \"coral-framework/lib/form\";\n+import { useMutation, withFragmentContainer } from \"coral-framework/lib/relay\";\n+import {\n+  required,\n+  validateStrictURLList,\n+} from \"coral-framework/lib/validation\";\n+import {\n+  Button,\n+  CallOut,\n+  Flex,\n+  FormField,\n+  FormFieldHeader,\n+  HorizontalGutter,\n+  Label,\n+} from \"coral-ui/components/v2\";\n+\n+import { EditSiteForm_settings as SettingsData } from \"coral-admin/__generated__/EditSiteForm_settings.graphql\";\n+import { EditSiteForm_site as SiteData } from \"coral-admin/__generated__/EditSiteForm_site.graphql\";\n+\n+import HelperText from \"../../HelperText\";\n+import TextFieldWithValidation from \"../../TextFieldWithValidation\";\n+import EmbedCode from \"./EmbedCode\";\n+import UpdateSiteMutation from \"./UpdateSiteMutation\";\n+\n+interface Props {\n+  site: SiteData;\n+  settings: SettingsData;\n+  onEditSuccess: (name: string) => void;\n+}\n+\n+const EditSiteForm: FunctionComponent<Props> = ({\n+  site,\n+  settings,\n+  onEditSuccess,\n+}) => {\n+  const updateSite = useMutation(UpdateSiteMutation);\n+  const [submitError, setSubmitError] = useState<null | string>(null);\n+  const onSubmit = useCallback(async (input, form: FormApi) => {\n+    try {\n+      const result = await updateSite({ site: input, id: site.id });\n+      if (result) {\n+        onEditSuccess(result.site.name);\n+      }\n+    } catch (error) {\n+      setSubmitError(error.message);\n+    }\n+  }, []);\n+  return (\n+    <div>\n+      <Form onSubmit={onSubmit}>\n+        {({ handleSubmit, invalid, submitting, ...formProps }) => (\n+          <form onSubmit={handleSubmit}>\n+            <HorizontalGutter spacing={4}>\n+              <FormField>\n+                <FormFieldHeader>\n+                  <Localized id=\"configure-sites-site-form-name\">\n+                    <Label>Site name</Label>\n+                  </Localized>\n+                  <Localized id=\"configure-sites-site-form-name-explanation\">\n+                    <HelperText>\n+                      Site name will appear on emails sent by Coral to your\n+                      community and organization members.\n+                    </HelperText>\n+                  </Localized>\n+                </FormFieldHeader>\n+                <Field name=\"name\" validate={required} defaultValue={site.name}>\n+                  {({ input, meta }) => (\n+                    <TextFieldWithValidation\n+                      {...input}\n+                      id={input.name}\n+                      fullWidth\n+                      meta={meta}\n+                    />\n+                  )}\n+                </Field>\n+              </FormField>\n+              <FormField>\n+                <FormFieldHeader>\n+                  <Localized id=\"configure-sites-site-form-domains\">\n+                    <Label>Site permitted domains</Label>\n+                  </Localized>\n+                  <Localized id=\"configure-sites-site-form-domains-explanation\">\n+                    <HelperText>\n+                      Domains where your Coral comment streams are allowed to be\n+                      embedded (ex. http://localhost:3000,\n+                      https://staging.domain.com, https://domain.com).\n+                    </HelperText>\n+                  </Localized>\n+                </FormFieldHeader>\n+                <Field\n+                  name=\"allowedOrigins\"\n+                  defaultValue={site.allowedOrigins}\n+                  parse={parseStringList}\n+                  format={formatStringList}\n+                  validate={validateStrictURLList}\n+                >\n+                  {({ input, meta }) => (\n+                    <TextFieldWithValidation\n+                      {...input}\n+                      id={`configure-advanced-${input.name}`}\n+                      autoComplete=\"off\"\n+                      autoCorrect=\"off\"\n+                      autoCapitalize=\"off\"\n+                      spellCheck={false}\n+                      meta={meta}\n+                      fullWidth\n+                    />\n+                  )}\n+                </Field>\n+              </FormField>\n+              <FormField>\n+                <FormFieldHeader>\n+                  <Localized id=\"configure-sites-site-form-embed-code\">\n+                    <Label>Embed code</Label>\n+                  </Localized>\n+                </FormFieldHeader>\n+\n+                <EmbedCode staticURI={settings.staticURI} />\n+              </FormField>\n+              {submitError && (\n+                <CallOut fullWidth color=\"error\">\n+                  {submitError}\n+                </CallOut>\n+              )}\n+              <Flex itemGutter justifyContent=\"flex-end\">\n+                <Localized id=\"configure-sites-site-form-save\">\n+                  <Button\n+                    disabled={submitting}\n+                    iconLeft\n+                    type=\"submit\"\n+                    size=\"large\"\n+                  >\n+                    Save changes\n+                  </Button>\n+                </Localized>\n+              </Flex>\n+            </HorizontalGutter>\n+          </form>\n+        )}\n+      </Form>\n+    </div>\n+  );\n+};\n+\n+const enhanced = withFragmentContainer<Props>({\n+  site: graphql`\n+    fragment EditSiteForm_site on Site {\n+      name\n+      createdAt\n+      id\n+      allowedOrigins\n+    }\n+  `,\n+  settings: graphql`\n+    fragment EditSiteForm_settings on Settings {\n+      staticURI\n+    }\n+  `,\n+})(EditSiteForm);\n+\n+export default enhanced;"
    },
    {
      "sha": "2387d0792d59555c91aec4f891013dbad9fa07d0",
      "filename": "src/core/client/admin/routes/Configure/sections/Sites/EmbedCode.css",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/EmbedCode.css",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/EmbedCode.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Sites/EmbedCode.css?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "previous_filename": "src/core/client/admin/routes/Configure/sections/Advanced/EmbedCode.css"
    },
    {
      "sha": "dc85f954d74092c901c9f79368aa541cc8e5a1fc",
      "filename": "src/core/client/admin/routes/Configure/sections/Sites/EmbedCode.tsx",
      "status": "renamed",
      "additions": 4,
      "deletions": 26,
      "changes": 30,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/EmbedCode.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/EmbedCode.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Sites/EmbedCode.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,19 +1,10 @@\n-import { Localized } from \"@fluent/react/compat\";\n import { stripIndent } from \"common-tags\";\n import React, { FunctionComponent, useMemo } from \"react\";\n \n import { CopyButton } from \"coral-framework/components\";\n import { GetMessage, withGetMessage } from \"coral-framework/lib/i18n\";\n import { getLocationOrigin } from \"coral-framework/utils\";\n-import {\n-  FieldSet,\n-  FormFieldDescription,\n-  HorizontalGutter,\n-  Textarea,\n-} from \"coral-ui/components/v2\";\n-\n-import ConfigBox from \"../../ConfigBox\";\n-import Header from \"../../Header\";\n+import { HorizontalGutter, Textarea } from \"coral-ui/components/v2\";\n \n import styles from \"./EmbedCode.css\";\n \n@@ -84,30 +75,17 @@ const EmbedCode: FunctionComponent<Props> = ({ staticURI, getMessage }) => {\n   }, [staticURI]);\n \n   return (\n-    <ConfigBox\n-      title={\n-        <Localized id=\"configure-advanced-embedCode-title\">\n-          <Header container={<legend />}>Embed code</Header>\n-        </Localized>\n-      }\n-      container={<FieldSet />}\n-    >\n-      <Localized id=\"configure-advanced-embedCode-explanation\">\n-        <FormFieldDescription>\n-          Copy and paste the code below into your CMS to embed Coral comment\n-          streams in each of your site’s stories.\n-        </FormFieldDescription>\n-      </Localized>\n+    <>\n       <Textarea\n         rows={embed.rows}\n         className={styles.textArea}\n         readOnly\n         value={embed.text}\n       />\n       <HorizontalGutter className={styles.copyArea}>\n-        <CopyButton text={embed.text} />\n+        <CopyButton variant=\"regular\" color=\"mono\" text={embed.text} />\n       </HorizontalGutter>\n-    </ConfigBox>\n+    </>\n   );\n };\n ",
      "previous_filename": "src/core/client/admin/routes/Configure/sections/Advanced/EmbedCode.tsx"
    },
    {
      "sha": "face8c8372146f3637f249a78b888dc4c468cbc4",
      "filename": "src/core/client/admin/routes/Configure/sections/Sites/SiteRoute.tsx",
      "status": "added",
      "additions": 66,
      "deletions": 0,
      "changes": 66,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/SiteRoute.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/SiteRoute.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Sites/SiteRoute.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,66 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import React, { FunctionComponent, useCallback } from \"react\";\n+\n+import { useNotification } from \"coral-admin/App/GlobalNotification\";\n+import { graphql } from \"coral-framework/lib/relay\";\n+import { withRouteConfig } from \"coral-framework/lib/router\";\n+import { AppNotification } from \"coral-ui/components/v2\";\n+\n+import { SiteRouteQueryResponse } from \"coral-admin/__generated__/SiteRouteQuery.graphql\";\n+\n+import ConfigBox from \"../../ConfigBox\";\n+import Header from \"../../Header\";\n+import EditSiteForm from \"./EditSiteForm\";\n+\n+interface Props {\n+  data: SiteRouteQueryResponse;\n+}\n+\n+const AddSiteRoute: FunctionComponent<Props> = ({ data }) => {\n+  if (!data || !data.site) {\n+    return null;\n+  }\n+  const { site } = data;\n+  const { setMessage, clearMessage } = useNotification();\n+  const onSiteEdit = useCallback((name: string) => {\n+    setMessage(\n+      <Localized id=\"configure-sites-edit-success\" $site={name}>\n+        <AppNotification icon=\"check_circle_outline\" onClose={clearMessage}>\n+          Changes to {name} have been saved\n+        </AppNotification>\n+      </Localized>\n+    );\n+  }, []);\n+  return (\n+    <ConfigBox\n+      title={\n+        <Localized id=\"configure-sites-site-edit\" $site={site.name}>\n+          <Header>Edit {site.name} details</Header>\n+        </Localized>\n+      }\n+    >\n+      <EditSiteForm\n+        onEditSuccess={onSiteEdit}\n+        site={site}\n+        settings={data.settings}\n+      />\n+    </ConfigBox>\n+  );\n+};\n+\n+const enhanced = withRouteConfig<Props>({\n+  query: graphql`\n+    query SiteRouteQuery($siteID: ID!) {\n+      site(id: $siteID) {\n+        name\n+        ...EditSiteForm_site\n+      }\n+      settings {\n+        ...EditSiteForm_settings\n+      }\n+    }\n+  `,\n+  cacheConfig: { force: true },\n+})(AddSiteRoute);\n+\n+export default enhanced;"
    },
    {
      "sha": "3835c2c0ab40ba375017338e4e0f31e4f1170f21",
      "filename": "src/core/client/admin/routes/Configure/sections/Sites/SitesRoute.tsx",
      "status": "added",
      "additions": 27,
      "deletions": 0,
      "changes": 27,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/SitesRoute.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/SitesRoute.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Sites/SitesRoute.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,27 @@\n+import React, { FunctionComponent } from \"react\";\n+\n+import MainLayout from \"coral-admin/components/MainLayout\";\n+\n+import ConfigureLinks from \"../../ConfigureLinks\";\n+import Layout from \"../../Layout\";\n+import Main from \"../../Main\";\n+import SideBar from \"../../SideBar\";\n+\n+interface Props {\n+  children: React.ReactElement;\n+}\n+\n+const SitesRoute: FunctionComponent<Props> = props => {\n+  return (\n+    <MainLayout>\n+      <Layout>\n+        <SideBar>\n+          <ConfigureLinks />\n+        </SideBar>\n+        <Main>{props.children}</Main>\n+      </Layout>\n+    </MainLayout>\n+  );\n+};\n+\n+export default SitesRoute;"
    },
    {
      "sha": "05e85bb587ab7c13c778abae867d6e012d9ef760",
      "filename": "src/core/client/admin/routes/Configure/sections/Sites/UpdateSiteMutation.ts",
      "status": "added",
      "additions": 41,
      "deletions": 0,
      "changes": 41,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/UpdateSiteMutation.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/UpdateSiteMutation.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Sites/UpdateSiteMutation.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,41 @@\n+import { graphql } from \"react-relay\";\n+import { Environment } from \"relay-runtime\";\n+\n+import {\n+  commitMutationPromiseNormalized,\n+  createMutation,\n+  MutationInput,\n+} from \"coral-framework/lib/relay\";\n+\n+import { UpdateSiteMutation as MutationTypes } from \"coral-admin/__generated__/UpdateSiteMutation.graphql\";\n+\n+const clientMutationId = 0;\n+\n+const UpdateSiteMutation = createMutation(\n+  \"updateSite\",\n+  (environment: Environment, input: MutationInput<MutationTypes>) => {\n+    return commitMutationPromiseNormalized<MutationTypes>(environment, {\n+      mutation: graphql`\n+        mutation UpdateSiteMutation($input: UpdateSiteInput!) {\n+          updateSite(input: $input) {\n+            site {\n+              id\n+              name\n+              createdAt\n+              allowedOrigins\n+            }\n+            clientMutationId\n+          }\n+        }\n+      `,\n+      variables: {\n+        input: {\n+          ...input,\n+          clientMutationId: clientMutationId.toString(),\n+        },\n+      },\n+    });\n+  }\n+);\n+\n+export default UpdateSiteMutation;"
    },
    {
      "sha": "ef5391c25f475473f12f31470191ae7f92a62fa9",
      "filename": "src/core/client/admin/routes/Configure/sections/Sites/index.ts",
      "status": "added",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Configure/sections/Sites/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Sites/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1 @@\n+export { default, default as Sites } from \"./SitesRoute\";"
    },
    {
      "sha": "ffefb1403ae626352dd137a8a14eaa9d87336509",
      "filename": "src/core/client/admin/routes/Moderate/Moderate.spec.tsx",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/Moderate.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/Moderate.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/Moderate.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -13,6 +13,13 @@ it(\"renders correctly\", () => {\n     allStories: true,\n     moderationQueues: {},\n     story: {},\n+    site: null,\n+    query: \"\",\n+    routeParams: {},\n+    queueName: \"\",\n+    settings: {\n+      multisite: false,\n+    },\n   };\n   const renderer = createRenderer();\n   renderer.render(<ModerateN {...props} />);"
    },
    {
      "sha": "ceaa5c6f0368f231ed12ca5f2d9e7b610885c3cf",
      "filename": "src/core/client/admin/routes/Moderate/Moderate.tsx",
      "status": "modified",
      "additions": 33,
      "deletions": 2,
      "changes": 35,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/Moderate.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/Moderate.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/Moderate.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -14,24 +14,43 @@ import { SubBar } from \"coral-ui/components/v2/SubBar\";\n import HotkeysModal from \"./HotkeysModal\";\n import ModerateNavigationContainer from \"./ModerateNavigation\";\n import ModerateSearchBarContainer from \"./ModerateSearchBar\";\n+import { SiteSelectorContainer } from \"./SiteSelector\";\n \n import styles from \"./Moderate.css\";\n \n+interface RouteParams {\n+  storyID?: string;\n+  siteID?: string;\n+}\n+\n interface Props {\n   story: PropTypesOf<typeof ModerateNavigationContainer>[\"story\"] &\n     PropTypesOf<typeof ModerateSearchBarContainer>[\"story\"];\n+  site:\n+    | { id: string } & PropTypesOf<typeof ModerateNavigationContainer>[\"site\"] &\n+        PropTypesOf<typeof SiteSelectorContainer>[\"site\"]\n+    | null;\n+  query: PropTypesOf<typeof SiteSelectorContainer>[\"query\"];\n   moderationQueues: PropTypesOf<\n     typeof ModerateNavigationContainer\n   >[\"moderationQueues\"];\n   allStories: boolean;\n+  settings: PropTypesOf<typeof ModerateSearchBarContainer>[\"settings\"] | null;\n   children?: React.ReactNode;\n+  queueName: string;\n+  routeParams: RouteParams;\n }\n \n const Moderate: FunctionComponent<Props> = ({\n   moderationQueues,\n   story,\n+  site,\n+  query,\n   allStories,\n   children,\n+  queueName,\n+  routeParams,\n+  settings,\n }) => {\n   const [showHotkeysModal, setShowHotkeysModal] = useState(false);\n   const closeModal = useCallback(() => {\n@@ -50,14 +69,26 @@ const Moderate: FunctionComponent<Props> = ({\n       key.unbind(HOTKEYS.GUIDE);\n     };\n   }, []);\n-\n   return (\n     <div data-testid=\"moderate-container\">\n-      <ModerateSearchBarContainer story={story} allStories={allStories} />\n+      <ModerateSearchBarContainer\n+        story={story}\n+        settings={settings}\n+        allStories={allStories}\n+        siteID={routeParams.siteID || null}\n+        siteSelector={\n+          <SiteSelectorContainer\n+            queueName={queueName}\n+            site={site}\n+            query={query}\n+          />\n+        }\n+      />\n       <SubBar data-testid=\"moderate-tabBar-container\">\n         <ModerateNavigationContainer\n           moderationQueues={moderationQueues}\n           story={story}\n+          site={story ? null : site}\n         />\n       </SubBar>\n       <div className={styles.background} />"
    },
    {
      "sha": "8cf36fe9481d53118425f2bf581ddc1ee915bf42",
      "filename": "src/core/client/admin/routes/Moderate/ModerateContainer.tsx",
      "status": "modified",
      "additions": 53,
      "deletions": 3,
      "changes": 56,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/ModerateContainer.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -11,6 +11,7 @@ import Moderate from \"./Moderate\";\n \n interface RouteParams {\n   storyID?: string;\n+  siteID?: string;\n }\n \n interface Props {\n@@ -24,18 +25,46 @@ class ModerateContainer extends React.Component<Props> {\n \n   public render() {\n     const allStories = !this.props.match.params.storyID;\n+    // TODO: (tessalt) get active route in a better way\n+    const queueName = [\n+      \"default\",\n+      \"reported\",\n+      \"pending\",\n+      \"unmoderated\",\n+      \"rejected\",\n+    ].find(name => {\n+      return this.props.match.location.pathname.includes(name);\n+    });\n     if (!this.props.data) {\n       return (\n-        <Moderate moderationQueues={null} story={null} allStories={allStories}>\n+        <Moderate\n+          moderationQueues={null}\n+          story={null}\n+          site={null}\n+          settings={null}\n+          query={this.props.data}\n+          routeParams={this.props.match.params}\n+          queueName={queueName || \"default\"}\n+          allStories={allStories}\n+        >\n           <Spinner />\n         </Moderate>\n       );\n     }\n+\n     return (\n       <Moderate\n         moderationQueues={this.props.data.moderationQueues}\n         story={this.props.data.story || null}\n+        site={\n+          this.props.data.site ||\n+          (this.props.data.story ? this.props.data.story.site : null)\n+        }\n+        routeParams={this.props.match.params}\n+        query={this.props.data}\n         allStories={allStories}\n+        settings={this.props.data.settings}\n+        queueName={queueName || \"default\"}\n       >\n         {this.props.children}\n       </Moderate>\n@@ -45,21 +74,42 @@ class ModerateContainer extends React.Component<Props> {\n \n const enhanced = withRouteConfig<Props>({\n   query: graphql`\n-    query ModerateContainerQuery($storyID: ID, $includeStory: Boolean!) {\n+    query ModerateContainerQuery(\n+      $storyID: ID\n+      $includeStory: Boolean!\n+      $siteID: ID\n+      $includeSite: Boolean!\n+    ) {\n+      settings {\n+        ...ModerateSearchBarContainer_settings\n+      }\n       story(id: $storyID) @include(if: $includeStory) {\n         ...ModerateNavigationContainer_story\n         ...ModerateSearchBarContainer_story\n+        site {\n+          id\n+          ...ModerateNavigationContainer_site\n+          ...SiteSelectorSelected_site\n+        }\n+      }\n+      site(id: $siteID) @include(if: $includeSite) {\n+        id\n+        ...ModerateNavigationContainer_site\n+        ...SiteSelectorSelected_site\n       }\n-      moderationQueues(storyID: $storyID) {\n+      moderationQueues(storyID: $storyID, siteID: $siteID) {\n         ...ModerateNavigationContainer_moderationQueues\n       }\n+      ...SiteSelectorContainer_query\n     }\n   `,\n   cacheConfig: { force: true },\n   prepareVariables: (params, match) => {\n     return {\n       storyID: match.params.storyID,\n+      siteID: match.params.siteID,\n       includeStory: Boolean(match.params.storyID),\n+      includeSite: Boolean(match.params.siteID),\n     };\n   },\n })(withRouter(ModerateContainer));"
    },
    {
      "sha": "d2b1ebff46d77312b148df472b3d517022447be5",
      "filename": "src/core/client/admin/routes/Moderate/ModerateNavigation/ModerateNavigationContainer.tsx",
      "status": "modified",
      "additions": 10,
      "deletions": 1,
      "changes": 11,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateNavigation/ModerateNavigationContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateNavigation/ModerateNavigationContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/ModerateNavigation/ModerateNavigationContainer.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -8,6 +8,7 @@ import {\n } from \"coral-framework/lib/relay\";\n \n import { ModerateNavigationContainer_moderationQueues as ModerationQueuesData } from \"coral-admin/__generated__/ModerateNavigationContainer_moderationQueues.graphql\";\n+import { ModerateNavigationContainer_site as SiteData } from \"coral-admin/__generated__/ModerateNavigationContainer_site.graphql\";\n import { ModerateNavigationContainer_story as StoryData } from \"coral-admin/__generated__/ModerateNavigationContainer_story.graphql\";\n \n import ModerateCountsCommentEnteredSubscription from \"./ModerateCountsCommentEnteredSubscription\";\n@@ -17,6 +18,7 @@ import Navigation from \"./Navigation\";\n interface Props {\n   moderationQueues: ModerationQueuesData | null;\n   story: StoryData | null;\n+  site: SiteData | null;\n }\n \n const ModerateNavigationContainer: React.FunctionComponent<Props> = props => {\n@@ -33,6 +35,7 @@ const ModerateNavigationContainer: React.FunctionComponent<Props> = props => {\n     }\n     const vars = {\n       storyID: props.story && props.story.id,\n+      siteID: props.site && props.site.id,\n     };\n     const disposable = combineDisposables(\n       subscribeToCommentEntered(vars),\n@@ -41,7 +44,7 @@ const ModerateNavigationContainer: React.FunctionComponent<Props> = props => {\n     return () => {\n       disposable.dispose();\n     };\n-  }, [Boolean(props.moderationQueues), props.story]);\n+  }, [Boolean(props.moderationQueues), props.story, props.site]);\n \n   if (!props.moderationQueues) {\n     return <Navigation />;\n@@ -52,6 +55,7 @@ const ModerateNavigationContainer: React.FunctionComponent<Props> = props => {\n       reportedCount={props.moderationQueues.reported.count}\n       pendingCount={props.moderationQueues.pending.count}\n       storyID={props.story && props.story.id}\n+      siteID={props.site && props.site.id}\n     />\n   );\n };\n@@ -62,6 +66,11 @@ const enhanced = withFragmentContainer<Props>({\n       id\n     }\n   `,\n+  site: graphql`\n+    fragment ModerateNavigationContainer_site on Site {\n+      id\n+    }\n+  `,\n   moderationQueues: graphql`\n     fragment ModerateNavigationContainer_moderationQueues on ModerationQueues {\n       unmoderated {"
    },
    {
      "sha": "6642d69152d65b150f766f82035e8abc0fe7fba8",
      "filename": "src/core/client/admin/routes/Moderate/ModerateNavigation/Navigation.tsx",
      "status": "modified",
      "additions": 15,
      "deletions": 12,
      "changes": 27,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateNavigation/Navigation.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateNavigation/Navigation.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/ModerateNavigation/Navigation.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,19 +1,21 @@\n import { Localized } from \"@fluent/react/compat\";\n import { Match, Router, withRouter } from \"found\";\n import key from \"keymaster\";\n+import { isNumber } from \"lodash\";\n import React, { FunctionComponent, useEffect, useMemo } from \"react\";\n \n import { HOTKEYS } from \"coral-admin/constants\";\n-import { getModerationLink } from \"coral-admin/helpers\";\n+import { getModerationLink } from \"coral-framework/helpers\";\n import { Counter, Icon, SubBarNavigation } from \"coral-ui/components/v2\";\n \n import NavigationLink from \"./NavigationLink\";\n \n interface Props {\n-  unmoderatedCount?: number;\n-  reportedCount?: number;\n-  pendingCount?: number;\n+  unmoderatedCount?: number | null;\n+  reportedCount?: number | null;\n+  pendingCount?: number | null;\n   storyID?: string | null;\n+  siteID?: string | null;\n   router: Router;\n   match: Match;\n }\n@@ -23,17 +25,18 @@ const Navigation: FunctionComponent<Props> = ({\n   reportedCount,\n   pendingCount,\n   storyID,\n+  siteID,\n   router,\n   match,\n }) => {\n   const moderationLinks = useMemo(() => {\n     return [\n-      getModerationLink(\"reported\", storyID),\n-      getModerationLink(\"pending\", storyID),\n-      getModerationLink(\"unmoderated\", storyID),\n-      getModerationLink(\"rejected\", storyID),\n+      getModerationLink({ queue: \"reported\", storyID, siteID }),\n+      getModerationLink({ queue: \"pending\", storyID, siteID }),\n+      getModerationLink({ queue: \"unmoderated\", storyID, siteID }),\n+      getModerationLink({ queue: \"rejected\", storyID, siteID }),\n     ];\n-  }, [storyID]);\n+  }, [storyID, siteID]);\n \n   useEffect(() => {\n     key(HOTKEYS.SWITCH_QUEUE, () => {\n@@ -67,7 +70,7 @@ const Navigation: FunctionComponent<Props> = ({\n         <Localized id=\"moderate-navigation-reported\">\n           <span>Reported</span>\n         </Localized>\n-        {reportedCount !== undefined && (\n+        {isNumber(reportedCount) && (\n           <Counter data-testid=\"moderate-navigation-reported-count\">\n             {reportedCount}\n           </Counter>\n@@ -78,7 +81,7 @@ const Navigation: FunctionComponent<Props> = ({\n         <Localized id=\"moderate-navigation-pending\">\n           <span>Pending</span>\n         </Localized>\n-        {pendingCount !== undefined && (\n+        {isNumber(pendingCount) && (\n           <Counter data-testid=\"moderate-navigation-pending-count\">\n             {pendingCount}\n           </Counter>\n@@ -89,7 +92,7 @@ const Navigation: FunctionComponent<Props> = ({\n         <Localized id=\"moderate-navigation-unmoderated\">\n           <span>Unmoderated</span>\n         </Localized>\n-        {unmoderatedCount !== undefined && (\n+        {isNumber(unmoderatedCount) && (\n           <Counter data-testid=\"moderate-navigation-unmoderated-count\">\n             {unmoderatedCount}\n           </Counter>"
    },
    {
      "sha": "d1c4a222994121561280c630ce71a62a74b3d133",
      "filename": "src/core/client/admin/routes/Moderate/ModerateSearchBar/Bar.css",
      "status": "modified",
      "additions": 9,
      "deletions": 1,
      "changes": 10,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateSearchBar/Bar.css",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateSearchBar/Bar.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/ModerateSearchBar/Bar.css?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -11,9 +11,17 @@\n   z-index: 100;\n }\n \n+.popover,\n+.popoverNarrow {\n+  border: 0;\n+}\n+\n .popover {\n   width: calc(94 * var(--mini-unit));\n-  border: 0;\n+}\n+\n+.popoverNarrow {\n+  width: calc(84 * var(--mini-unit));\n }\n \n .listBox {"
    },
    {
      "sha": "2b1957951d2b361a3829ece966ce581b0d024aec",
      "filename": "src/core/client/admin/routes/Moderate/ModerateSearchBar/Bar.tsx",
      "status": "modified",
      "additions": 16,
      "deletions": 2,
      "changes": 18,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateSearchBar/Bar.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateSearchBar/Bar.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/ModerateSearchBar/Bar.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -34,12 +34,22 @@ interface Props {\n   options: Array<ListBoxOption & { group: Group }>;\n   /** onSearch will be called whenenver the user submits the search */\n   onSearch?: (value: string) => void;\n+\n+  siteSelector: React.ReactNode;\n+\n+  multisite: boolean;\n }\n \n /**\n  * Bar is the container of the whole search bar.\n  */\n-const Bar: FunctionComponent<Props> = ({ title, options, onSearch }) => {\n+const Bar: FunctionComponent<Props> = ({\n+  title,\n+  options,\n+  onSearch,\n+  siteSelector,\n+  multisite,\n+}) => {\n   const [focused, focusHandlers] = useFocus();\n   const preventFocusLossHandlers = usePreventFocusLoss(focused);\n   const submitHandler = useCallback(\n@@ -80,6 +90,7 @@ const Bar: FunctionComponent<Props> = ({ title, options, onSearch }) => {\n         aria-expanded={focused}\n       >\n         <Backdrop className={styles.bumpZIndex} active={focused} />\n+        {multisite ? siteSelector : null}\n         <Form onSubmit={submitHandler}>\n           {({ handleSubmit }) => (\n             <Localized\n@@ -96,7 +107,9 @@ const Bar: FunctionComponent<Props> = ({ title, options, onSearch }) => {\n                 <Popover\n                   id={\"moderate-searchBar-popover\"}\n                   placement=\"bottom\"\n-                  classes={{ popover: styles.popover }}\n+                  classes={{\n+                    popover: multisite ? styles.popoverNarrow : styles.popover,\n+                  }}\n                   visible={focused}\n                   eventsEnabled={false}\n                   modifiers={{\n@@ -166,6 +179,7 @@ const Bar: FunctionComponent<Props> = ({ title, options, onSearch }) => {\n                   {({ ref }) => (\n                     <div ref={ref}>\n                       <Field\n+                        multisite={multisite}\n                         title={title}\n                         ref={searchInput}\n                         {...combineEventHandlers("
    },
    {
      "sha": "63aff6d22bb262ea1e28a41a7e5b07ca64ab719d",
      "filename": "src/core/client/admin/routes/Moderate/ModerateSearchBar/Field.css",
      "status": "modified",
      "additions": 12,
      "deletions": 2,
      "changes": 14,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateSearchBar/Field.css",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateSearchBar/Field.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/ModerateSearchBar/Field.css?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -5,15 +5,24 @@\n   height: calc(4 * var(--mini-unit));\n }\n \n+.hasSiteSelector {\n+  width: calc(84 * var(--mini-unit));\n+}\n+\n .begin {\n   background-color: $story-search-input-background;\n+  min-width: calc(4 * var(--mini-unit));\n   border-top-left-radius: var(--v2-round-corners);\n   border-bottom-left-radius: var(--v2-round-corners);\n-  min-width: calc(5 * var(--mini-unit));\n   flex-shrink: 0;\n   pointer-events: none;\n }\n \n+.adornmentLeft {\n+  border-top-left-radius: 0;\n+  border-bottom-left-radius: 0;\n+}\n+\n .beginStories {\n   font-size: var(--v2-font-size-2);\n   font-weight: var(--v2-font-weight-primary-semi-bold);\n@@ -93,8 +102,9 @@\n }\n \n .inputWithTitle {\n-  text-align: center;\n   &::placeholder {\n+    font-weight: var(--v2-font-weight-primary-bold);\n+    color: var(--v2-colors-mono-500);\n     opacity: 1;\n   }\n }"
    },
    {
      "sha": "cb68f2cd21fbac00957702f2170c0a1f268ae566",
      "filename": "src/core/client/admin/routes/Moderate/ModerateSearchBar/Field.tsx",
      "status": "modified",
      "additions": 14,
      "deletions": 2,
      "changes": 16,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateSearchBar/Field.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateSearchBar/Field.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/ModerateSearchBar/Field.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -14,6 +14,7 @@ interface Props extends HTMLAttributes<HTMLInputElement> {\n   className?: string;\n   focused?: boolean;\n   forwardRef?: Ref<HTMLInputElement>;\n+  multisite: boolean;\n }\n \n /**\n@@ -26,13 +27,24 @@ const Field: FunctionComponent<Props> = ({\n   onBlur,\n   onChange,\n   forwardRef,\n+  multisite,\n   ...rest\n }) => {\n   return (\n     <FormField name=\"search\">\n       {({ input }) => (\n-        <Flex className={cn(className, styles.root)} alignItems=\"stretch\">\n-          <Flex className={styles.begin} alignItems=\"center\">\n+        <Flex\n+          className={cn(className, styles.root, {\n+            [styles.hasSiteSelector]: multisite,\n+          })}\n+          alignItems=\"stretch\"\n+        >\n+          <Flex\n+            className={cn(styles.begin, {\n+              [styles.adornmentLeft]: multisite,\n+            })}\n+            alignItems=\"center\"\n+          >\n             <Icon className={styles.searchIcon} size=\"md\">\n               search\n             </Icon>"
    },
    {
      "sha": "16279661195a4dc79b9991aaff3b531a95bf829b",
      "filename": "src/core/client/admin/routes/Moderate/ModerateSearchBar/ModerateAllOption.css",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateSearchBar/ModerateAllOption.css",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateSearchBar/ModerateAllOption.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/ModerateSearchBar/ModerateAllOption.css?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -22,3 +22,7 @@\n   font-weight: var(--font-weight-medium);\n   margin-top: -2px;\n }\n+\n+.button {\n+  border-radius: 0;\n+}"
    },
    {
      "sha": "0c6436984a65a4c93d1534dc5480fdc84c89c011",
      "filename": "src/core/client/admin/routes/Moderate/ModerateSearchBar/ModerateAllOption.tsx",
      "status": "modified",
      "additions": 8,
      "deletions": 1,
      "changes": 9,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateSearchBar/ModerateAllOption.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateSearchBar/ModerateAllOption.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/ModerateSearchBar/ModerateAllOption.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -26,7 +26,14 @@ const ModerateAllOption: FunctionComponent<Props> = ({\n       aria-selected={selected}\n       {...rest}\n     >\n-      <Button href={href} color=\"dark\" anchor fullWidth tabIndex={-1}>\n+      <Button\n+        className={styles.button}\n+        href={href}\n+        color=\"dark\"\n+        anchor\n+        fullWidth\n+        tabIndex={-1}\n+      >\n         <Localized id=\"moderate-searchBar-moderateAllStories\">\n           <span>Moderate all stories</span>\n         </Localized>"
    },
    {
      "sha": "74484e81012669c2092664977f886e002e4d8a69",
      "filename": "src/core/client/admin/routes/Moderate/ModerateSearchBar/ModerateSearchBarContainer.tsx",
      "status": "modified",
      "additions": 62,
      "deletions": 11,
      "changes": 73,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateSearchBar/ModerateSearchBarContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateSearchBar/ModerateSearchBarContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/ModerateSearchBar/ModerateSearchBarContainer.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -9,7 +9,7 @@ import React, {\n } from \"react\";\n import { graphql } from \"react-relay\";\n \n-import { getModerationLink } from \"coral-admin/helpers\";\n+import { getModerationLink } from \"coral-framework/helpers\";\n import { useEffectWhenChanged } from \"coral-framework/hooks\";\n import { useFetch, withFragmentContainer } from \"coral-framework/lib/relay\";\n import { PropTypesOf } from \"coral-framework/types\";\n@@ -20,6 +20,7 @@ import {\n   ListBoxOptionElement,\n } from \"coral-ui/hooks/useComboBox\";\n \n+import { ModerateSearchBarContainer_settings as SettingsData } from \"coral-admin/__generated__/ModerateSearchBarContainer_settings.graphql\";\n import { ModerateSearchBarContainer_story as ModerationQueuesData } from \"coral-admin/__generated__/ModerateSearchBarContainer_story.graphql\";\n \n import Bar from \"./Bar\";\n@@ -33,7 +34,10 @@ interface Props {\n   router: Router;\n   match: Match;\n   story: ModerationQueuesData | null;\n+  settings: SettingsData | null;\n   allStories: boolean;\n+  siteSelector: React.ReactNode;\n+  siteID: string | null;\n }\n \n type SearchBarOptions = PropTypesOf<typeof Bar>[\"options\"];\n@@ -111,7 +115,11 @@ function getContextOptionsWhenModeratingStory(\n }\n \n type OnSearchCallback = (search: string) => void;\n-\n+interface SearchParams {\n+  query: string;\n+  limit: number;\n+  siteID?: string;\n+}\n /**\n  * useSearchOptions\n  *\n@@ -120,7 +128,8 @@ type OnSearchCallback = (search: string) => void;\n  */\n function useSearchOptions(\n   onClickOrEnter: ListBoxOptionClickOrEnterHandler,\n-  story: ModerationQueuesData | null\n+  story: ModerationQueuesData | null,\n+  siteID: string | null\n ): [SearchBarOptions, OnSearchCallback] {\n   const searchStory = useFetch(SearchStoryFetch);\n \n@@ -149,7 +158,14 @@ function useSearchOptions(\n         },\n       ]);\n \n-      const stories = await searchStory({ query: search, limit: 5 });\n+      const searchParams: SearchParams = {\n+        query: search,\n+        limit: 5,\n+      };\n+      if (siteID) {\n+        searchParams.siteID = siteID;\n+      }\n+      const stories = await searchStory(searchParams);\n       if (searchCount !== searchCountRef.current) {\n         // This result is old, so we can discard it.\n         return;\n@@ -164,8 +180,13 @@ function useSearchOptions(\n           nextSearchOptions.push({\n             element: (\n               <Option\n-                href={getModerationLink(\"default\", e.node.id)}\n-                details={e.node.metadata && e.node.metadata.author}\n+                href={getModerationLink({ storyID: e.node.id })}\n+                details={\n+                  <Flex itemGutter>\n+                    <strong>{e.node.site.name}</strong>\n+                    {e.node.metadata && e.node.metadata.author}\n+                  </Flex>\n+                }\n               >\n                 <GoToAriaInfo /> {e.node.metadata && e.node.metadata.title}\n               </Option>\n@@ -203,7 +224,7 @@ function useSearchOptions(\n       }\n       setSearchOptions(nextSearchOptions);\n     },\n-    [story, searchStory, setSearchOptions]\n+    [story, searchStory, setSearchOptions, siteID]\n   );\n \n   return [searchOptions, onSearch];\n@@ -217,7 +238,8 @@ const ModerateSearchBarContainer: React.FunctionComponent<Props> = props => {\n \n   const [searchOptions, onSearch] = useSearchOptions(\n     linkNavHandler,\n-    props.story\n+    props.story,\n+    props.siteID\n   );\n \n   const options = [...contextOptions, ...searchOptions];\n@@ -231,23 +253,44 @@ const ModerateSearchBarContainer: React.FunctionComponent<Props> = props => {\n   if (props.allStories) {\n     return (\n       <Localized id=\"moderate-searchBar-allStories\" attrs={{ title: true }}>\n-        <Bar title=\"All stories\" {...childProps} />\n+        <Bar\n+          siteSelector={props.siteSelector}\n+          multisite={props.settings ? props.settings.multisite : false}\n+          title=\"All stories\"\n+          {...childProps}\n+        />\n       </Localized>\n     );\n   }\n   if (!props.story) {\n-    return <Bar title={\"\"} {...childProps} />;\n+    return (\n+      <Bar\n+        multisite={props.settings ? props.settings.multisite : false}\n+        siteSelector={props.siteSelector}\n+        title={\"\"}\n+        {...childProps}\n+      />\n+    );\n   }\n   const t = props.story.metadata && props.story.metadata.title;\n   if (t) {\n-    return <Bar title={t} {...childProps} />;\n+    return (\n+      <Bar\n+        multisite={props.settings ? props.settings.multisite : false}\n+        siteSelector={props.siteSelector}\n+        title={t}\n+        {...childProps}\n+      />\n+    );\n   }\n   return (\n     <Localized\n       id=\"moderate-searchBar-titleNotAvailable\"\n       attrs={{ title: true }}\n     >\n       <Bar\n+        siteSelector={props.siteSelector}\n+        multisite={props.settings ? props.settings.multisite : false}\n         title={\"Title not available\"}\n         options={options}\n         onSearch={onSearch}\n@@ -258,9 +301,17 @@ const ModerateSearchBarContainer: React.FunctionComponent<Props> = props => {\n \n const enhanced = withRouter(\n   withFragmentContainer<Props>({\n+    settings: graphql`\n+      fragment ModerateSearchBarContainer_settings on Settings {\n+        multisite\n+      }\n+    `,\n     story: graphql`\n       fragment ModerateSearchBarContainer_story on Story {\n         id\n+        site {\n+          name\n+        }\n         metadata {\n           title\n           author"
    },
    {
      "sha": "db5f0b4e5075f69880fb5e748b2308cab97966dd",
      "filename": "src/core/client/admin/routes/Moderate/ModerateSearchBar/SearchStoryFetch.ts",
      "status": "modified",
      "additions": 9,
      "deletions": 2,
      "changes": 11,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateSearchBar/SearchStoryFetch.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/ModerateSearchBar/SearchStoryFetch.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/ModerateSearchBar/SearchStoryFetch.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -15,11 +15,18 @@ const SearchStoryFetch = createFetch(\n     return fetchQuery<QueryTypes>(\n       environment,\n       graphql`\n-        query SearchStoryFetchQuery($query: String!, $limit: Int!) {\n-          stories(query: $query, first: $limit) {\n+        query SearchStoryFetchQuery(\n+          $query: String!\n+          $limit: Int!\n+          $siteID: ID\n+        ) {\n+          stories(query: $query, first: $limit, siteID: $siteID) {\n             edges {\n               node {\n                 id\n+                site {\n+                  name\n+                }\n                 metadata {\n                   title\n                   author"
    },
    {
      "sha": "2a040eb3709d18d104c50817903ff3c7bc2b20e3",
      "filename": "src/core/client/admin/routes/Moderate/Queue/QueueRoute.tsx",
      "status": "modified",
      "additions": 23,
      "deletions": 11,
      "changes": 34,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/Queue/QueueRoute.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/Queue/QueueRoute.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/Queue/QueueRoute.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -34,6 +34,7 @@ interface Props {\n   relay: RelayPaginationProp;\n   emptyElement: React.ReactElement;\n   storyID?: string;\n+  siteID?: string;\n   count?: string;\n }\n \n@@ -51,12 +52,17 @@ export const QueueRoute: FunctionComponent<Props> = props => {\n   );\n   const viewNew = useMutation(QueueViewNewMutation);\n   const onViewNew = useCallback(() => {\n-    viewNew({ queue: props.queueName, storyID: props.storyID || null });\n-  }, [props.queueName, props.storyID, viewNew]);\n+    viewNew({\n+      queue: props.queueName,\n+      storyID: props.storyID || null,\n+      siteID: props.siteID || null,\n+    });\n+  }, [props.queueName, props.storyID, props.siteID, viewNew]);\n   useEffect(() => {\n     const vars = {\n       queue: props.queueName,\n       storyID: props.storyID || null,\n+      siteID: props.siteID || null,\n     };\n     const disposable = combineDisposables(\n       subscribeToQueueCommentEntered(vars),\n@@ -67,6 +73,7 @@ export const QueueRoute: FunctionComponent<Props> = props => {\n     };\n   }, [\n     props.storyID,\n+    props.siteID,\n     props.queueName,\n     subscribeToQueueCommentEntered,\n     subscribeToQueueCommentLeft,\n@@ -124,6 +131,7 @@ const createQueueRoute = (\n             viewer={null}\n             emptyElement={emptyElement}\n             storyID={match.params.storyID}\n+            siteID={match.params.siteID}\n           />\n         );\n       }\n@@ -138,6 +146,7 @@ const createQueueRoute = (\n           viewer={data.viewer}\n           emptyElement={emptyElement}\n           storyID={match.params.storyID}\n+          siteID={match.params.siteID}\n         />\n       );\n     },\n@@ -210,8 +219,8 @@ const createQueueRoute = (\n export const PendingQueueRoute = createQueueRoute(\n   GQLMODERATION_QUEUE.PENDING,\n   graphql`\n-    query QueueRoutePendingQuery($storyID: ID, $count: Int) {\n-      moderationQueues(storyID: $storyID) {\n+    query QueueRoutePendingQuery($storyID: ID, $siteID: ID, $count: Int) {\n+      moderationQueues(storyID: $storyID, siteID: $siteID) {\n         pending {\n           ...QueueRoute_queue @arguments(count: $count)\n         }\n@@ -229,10 +238,11 @@ export const PendingQueueRoute = createQueueRoute(\n     # Notice that we re-use our fragment, and the shape of this query matches our fragment spec.\n     query QueueRoutePaginationPendingQuery(\n       $storyID: ID\n+      $siteID: ID\n       $count: Int!\n       $cursor: Cursor\n     ) {\n-      moderationQueues(storyID: $storyID) {\n+      moderationQueues(storyID: $storyID, siteID: $siteID) {\n         pending {\n           ...QueueRoute_queue @arguments(count: $count, cursor: $cursor)\n         }\n@@ -250,8 +260,8 @@ export const PendingQueueRoute = createQueueRoute(\n export const ReportedQueueRoute = createQueueRoute(\n   GQLMODERATION_QUEUE.REPORTED,\n   graphql`\n-    query QueueRouteReportedQuery($storyID: ID) {\n-      moderationQueues(storyID: $storyID) {\n+    query QueueRouteReportedQuery($storyID: ID, $siteID: ID) {\n+      moderationQueues(storyID: $storyID, siteID: $siteID) {\n         reported {\n           ...QueueRoute_queue\n         }\n@@ -269,10 +279,11 @@ export const ReportedQueueRoute = createQueueRoute(\n     # Notice that we re-use our fragment, and the shape of this query matches our fragment spec.\n     query QueueRoutePaginationReportedQuery(\n       $storyID: ID\n+      $siteID: ID\n       $count: Int!\n       $cursor: Cursor\n     ) {\n-      moderationQueues(storyID: $storyID) {\n+      moderationQueues(storyID: $storyID, siteID: $siteID) {\n         reported {\n           ...QueueRoute_queue @arguments(count: $count, cursor: $cursor)\n         }\n@@ -290,8 +301,8 @@ export const ReportedQueueRoute = createQueueRoute(\n export const UnmoderatedQueueRoute = createQueueRoute(\n   GQLMODERATION_QUEUE.UNMODERATED,\n   graphql`\n-    query QueueRouteUnmoderatedQuery($storyID: ID) {\n-      moderationQueues(storyID: $storyID) {\n+    query QueueRouteUnmoderatedQuery($storyID: ID, $siteID: ID) {\n+      moderationQueues(storyID: $storyID, siteID: $siteID) {\n         unmoderated {\n           ...QueueRoute_queue\n         }\n@@ -309,10 +320,11 @@ export const UnmoderatedQueueRoute = createQueueRoute(\n     # Notice that we re-use our fragment, and the shape of this query matches our fragment spec.\n     query QueueRoutePaginationUnmoderatedQuery(\n       $storyID: ID\n+      $siteID: ID\n       $count: Int!\n       $cursor: Cursor\n     ) {\n-      moderationQueues(storyID: $storyID) {\n+      moderationQueues(storyID: $storyID, siteID: $siteID) {\n         unmoderated {\n           ...QueueRoute_queue @arguments(count: $count, cursor: $cursor)\n         }"
    },
    {
      "sha": "c41e2d33cd584c2822305eb061e73bf5f4aeed93",
      "filename": "src/core/client/admin/routes/Moderate/Queue/QueueViewNewMutation.tsx",
      "status": "modified",
      "additions": 7,
      "deletions": 1,
      "changes": 8,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/Queue/QueueViewNewMutation.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/Queue/QueueViewNewMutation.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/Queue/QueueViewNewMutation.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -9,14 +9,20 @@ import { GQLMODERATION_QUEUE } from \"coral-framework/schema\";\n \n interface QueueViewNewInput {\n   storyID: string | null;\n+  siteID: string | null;\n   queue: GQLMODERATION_QUEUE;\n }\n \n const QueueViewNewMutation = createMutation(\n   \"viewNew\",\n   async (environment: Environment, input: QueueViewNewInput) => {\n     await commitLocalUpdatePromisified(environment, async store => {\n-      const connection = getQueueConnection(store, input.queue, input.storyID);\n+      const connection = getQueueConnection(\n+        store,\n+        input.queue,\n+        input.storyID,\n+        input.siteID\n+      );\n       if (!connection) {\n         return;\n       }"
    },
    {
      "sha": "9756af271e97297f80b1c257708e1ea0e8b50090",
      "filename": "src/core/client/admin/routes/Moderate/SiteSelector/SiteSelector.css",
      "status": "added",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelector.css",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelector.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelector.css?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,8 @@\n+.button {\n+  height: calc(4 * var(--mini-unit));\n+}\n+\n+.buttonText {\n+  overflow-x: hidden;\n+  text-overflow: ellipsis;\n+}"
    },
    {
      "sha": "1a107c534ac90582f123c74b93441080a1207a12",
      "filename": "src/core/client/admin/routes/Moderate/SiteSelector/SiteSelector.tsx",
      "status": "added",
      "additions": 76,
      "deletions": 0,
      "changes": 76,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelector.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelector.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelector.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,76 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import React, { FunctionComponent } from \"react\";\n+\n+import PaginatedSelect from \"coral-admin/components/PaginatedSelect\";\n+import { getModerationLink, QUEUE_NAME } from \"coral-framework/helpers\";\n+import { PropTypesOf } from \"coral-framework/types\";\n+\n+import SiteSelectorSelected from \"./SiteSelectorSelected\";\n+import SiteSelectorSite from \"./SiteSelectorSite\";\n+\n+import styles from \"./SiteSelector.css\";\n+\n+interface Props {\n+  sites: Array<{ id: string } & PropTypesOf<typeof SiteSelectorSite>[\"site\"]>;\n+  site:\n+    | { id: string } & PropTypesOf<typeof SiteSelectorSelected>[\"site\"]\n+    | null;\n+  queueName: string;\n+  onLoadMore: () => void;\n+  hasMore: boolean;\n+  disableLoadMore: boolean;\n+  loading: boolean;\n+}\n+\n+const SiteSelector: FunctionComponent<Props> = ({\n+  sites,\n+  site,\n+  queueName,\n+  loading,\n+  onLoadMore,\n+  disableLoadMore,\n+  hasMore,\n+}) => {\n+  return (\n+    <PaginatedSelect\n+      icon=\"web_asset\"\n+      loading={loading}\n+      onLoadMore={onLoadMore}\n+      disableLoadMore={disableLoadMore}\n+      hasMore={hasMore}\n+      className={styles.button}\n+      selected={\n+        <>\n+          {site && <SiteSelectorSelected site={site} />}\n+\n+          {!site && (\n+            <Localized id=\"site-selector-all-sites\">\n+              <span className={styles.buttonText}>All sites</span>\n+            </Localized>\n+          )}\n+        </>\n+      }\n+    >\n+      <>\n+        <SiteSelectorSite\n+          link={getModerationLink({ queue: queueName as QUEUE_NAME })}\n+          site={null}\n+          active={!site}\n+        />\n+        {sites.map(s => (\n+          <SiteSelectorSite\n+            link={getModerationLink({\n+              queue: queueName as QUEUE_NAME,\n+              siteID: s.id,\n+            })}\n+            key={s.id}\n+            site={s}\n+            active={(site && site.id === s.id) || false}\n+          />\n+        ))}\n+      </>\n+    </PaginatedSelect>\n+  );\n+};\n+\n+export default SiteSelector;"
    },
    {
      "sha": "6bb8e53a46f4f1d3289110611ad5bbbc60872f9e",
      "filename": "src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorContainer.tsx",
      "status": "added",
      "additions": 101,
      "deletions": 0,
      "changes": 101,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorContainer.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,101 @@\n+import React from \"react\";\n+import { graphql, RelayPaginationProp } from \"react-relay\";\n+\n+import {\n+  useLoadMore,\n+  useRefetch,\n+  withPaginationContainer,\n+} from \"coral-framework/lib/relay\";\n+import { PropTypesOf } from \"coral-ui/types\";\n+\n+import { SiteSelectorContainer_query as QueryData } from \"coral-admin/__generated__/SiteSelectorContainer_query.graphql\";\n+import { SiteSelectorContainerPaginationQueryVariables } from \"coral-admin/__generated__/SiteSelectorContainerPaginationQuery.graphql\";\n+\n+import SiteSelector from \"./SiteSelector\";\n+\n+interface Props {\n+  query: QueryData | null;\n+  site: PropTypesOf<typeof SiteSelector>[\"site\"] | null;\n+  relay: RelayPaginationProp;\n+  queueName: string;\n+}\n+\n+const SiteSelectorContainer: React.FunctionComponent<Props> = props => {\n+  const sites = props.query\n+    ? props.query.sites.edges.map(edge => edge.node)\n+    : [];\n+  const [loadMore, isLoadingMore] = useLoadMore(props.relay, 10);\n+  const [, isRefetching] = useRefetch<\n+    SiteSelectorContainerPaginationQueryVariables\n+  >(props.relay);\n+  return (\n+    <SiteSelector\n+      loading={!props.query || isRefetching}\n+      sites={sites}\n+      site={props.site}\n+      onLoadMore={loadMore}\n+      hasMore={!isRefetching && props.relay.hasMore()}\n+      disableLoadMore={isLoadingMore}\n+      queueName={props.queueName}\n+    />\n+  );\n+};\n+\n+type FragmentVariables = SiteSelectorContainerPaginationQueryVariables;\n+\n+const enhanced = withPaginationContainer<\n+  Props,\n+  SiteSelectorContainerPaginationQueryVariables,\n+  FragmentVariables\n+>(\n+  {\n+    query: graphql`\n+      fragment SiteSelectorContainer_query on Query\n+        @argumentDefinitions(\n+          count: { type: \"Int!\", defaultValue: 10 }\n+          cursor: { type: \"Cursor\" }\n+        ) {\n+        sites(first: $count, after: $cursor)\n+          @connection(key: \"SitesConfig_sites\") {\n+          edges {\n+            node {\n+              id\n+              ...SiteSelectorSite_site\n+            }\n+          }\n+        }\n+      }\n+    `,\n+  },\n+  {\n+    direction: \"forward\",\n+    getConnectionFromProps(props) {\n+      return props.query && props.query.sites;\n+    },\n+    // This is also the default implementation of `getFragmentVariables` if it isn't provided.\n+    getFragmentVariables(prevVars, totalCount) {\n+      return {\n+        ...prevVars,\n+        count: totalCount,\n+      };\n+    },\n+    getVariables(props, { count, cursor }, fragmentVariables) {\n+      return {\n+        count,\n+        cursor,\n+      };\n+    },\n+    query: graphql`\n+      # Pagination query to be fetched upon calling 'loadMore'.\n+      # Notice that we re-use our fragment, and the shape of this query matches our fragment spec.\n+      query SiteSelectorContainerPaginationQuery(\n+        $count: Int!\n+        $cursor: Cursor\n+      ) {\n+        ...SiteSelectorContainer_query\n+          @arguments(count: $count, cursor: $cursor)\n+      }\n+    `,\n+  }\n+)(SiteSelectorContainer);\n+export default enhanced;"
    },
    {
      "sha": "c7b5db56b161425061d8696e69b50944c77dfa58",
      "filename": "src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorSelected.css",
      "status": "added",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorSelected.css",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorSelected.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorSelected.css?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,4 @@\n+.root {\n+  overflow-x: hidden;\n+  text-overflow: ellipsis;\n+}"
    },
    {
      "sha": "db33241c3ba2cfa3a69eb34902a423ccd0bd8a35",
      "filename": "src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorSelected.tsx",
      "status": "added",
      "additions": 26,
      "deletions": 0,
      "changes": 26,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorSelected.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorSelected.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorSelected.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,26 @@\n+import React, { FunctionComponent } from \"react\";\n+\n+import { graphql, withFragmentContainer } from \"coral-framework/lib/relay\";\n+\n+import { SiteSelectorSelected_site } from \"coral-admin/__generated__/SiteSelectorSelected_site.graphql\";\n+\n+import styles from \"./SiteSelectorSelected.css\";\n+\n+interface Props {\n+  site: SiteSelectorSelected_site;\n+}\n+\n+const SiteSelectorSelected: FunctionComponent<Props> = ({ site }) => {\n+  return <span className={styles.root}>{site.name}</span>;\n+};\n+\n+const enhanced = withFragmentContainer<Props>({\n+  site: graphql`\n+    fragment SiteSelectorSelected_site on Site {\n+      name\n+      id\n+    }\n+  `,\n+})(SiteSelectorSelected);\n+\n+export default enhanced;"
    },
    {
      "sha": "761acd4730c62848b48f4d4792d51328b8c50ef8",
      "filename": "src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorSite.css",
      "status": "added",
      "additions": 14,
      "deletions": 0,
      "changes": 14,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorSite.css",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorSite.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorSite.css?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,14 @@\n+.root {\n+  font-family: var(--v2-font-family-primary);\n+  font-weight: var(--v2-font-weight-primary-regular);\n+  font-size: var(--v2-font-size-1);\n+  color: var(--v2-colors-mono-500);\n+  line-height: var(--v2-line-height-reset);\n+  display: block;\n+  text-decoration: none;\n+  padding: var(--v2-spacing-2) var(--v2-spacing-4);\n+}\n+\n+.active {\n+  font-weight: var(--v2-font-weight-primary-bold);\n+}"
    },
    {
      "sha": "854fd705660664a6544938e039d18b6dd1499f13",
      "filename": "src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorSite.tsx",
      "status": "added",
      "additions": 44,
      "deletions": 0,
      "changes": 44,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorSite.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorSite.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/SiteSelector/SiteSelectorSite.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,44 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import cn from \"classnames\";\n+import { Link } from \"found\";\n+import React, { FunctionComponent } from \"react\";\n+\n+import { graphql, withFragmentContainer } from \"coral-framework/lib/relay\";\n+\n+import { SiteSelectorSite_site } from \"coral-admin/__generated__/SiteSelectorSite_site.graphql\";\n+\n+import styles from \"./SiteSelectorSite.css\";\n+\n+interface Props {\n+  site: SiteSelectorSite_site | null;\n+  active?: boolean;\n+  link?: string;\n+}\n+\n+const SiteSelectorSite: FunctionComponent<Props> = ({ site, link, active }) => {\n+  return (\n+    <Link\n+      className={cn(styles.root, {\n+        [styles.active]: active,\n+      })}\n+      to={link || \"\"}\n+    >\n+      {site ? (\n+        site.name\n+      ) : (\n+        <Localized id=\"sites-selector-allSites\">All sites</Localized>\n+      )}\n+    </Link>\n+  );\n+};\n+\n+const enhanced = withFragmentContainer<Props>({\n+  site: graphql`\n+    fragment SiteSelectorSite_site on Site {\n+      name\n+      id\n+    }\n+  `,\n+})(SiteSelectorSite);\n+\n+export default enhanced;"
    },
    {
      "sha": "b4d2b7853e5a371b8c0b2a5a41b6b315c2d4e2b7",
      "filename": "src/core/client/admin/routes/Moderate/SiteSelector/index.ts",
      "status": "added",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/SiteSelector/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/SiteSelector/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/SiteSelector/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,2 @@\n+export { default, default as SiteSelector } from \"./SiteSelector\";\n+export { default as SiteSelectorContainer } from \"./SiteSelectorContainer\";"
    },
    {
      "sha": "2a720a9d57fed2ec384d5b681245b4e30e05cfde",
      "filename": "src/core/client/admin/routes/Moderate/__snapshots__/Moderate.spec.tsx.snap",
      "status": "modified",
      "additions": 14,
      "deletions": 0,
      "changes": 14,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/__snapshots__/Moderate.spec.tsx.snap",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Moderate/__snapshots__/Moderate.spec.tsx.snap",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Moderate/__snapshots__/Moderate.spec.tsx.snap?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -6,13 +6,27 @@ exports[`renders correctly 1`] = `\n >\n   <ForwardRef(render)\n     allStories={true}\n+    settings={\n+      Object {\n+        \"multisite\": false,\n+      }\n+    }\n+    siteID={null}\n+    siteSelector={\n+      <Relay(SiteSelectorContainer)\n+        query=\"\"\n+        queueName=\"\"\n+        site={null}\n+      />\n+    }\n     story={Object {}}\n   />\n   <withPropsOnChange(SubBar)\n     data-testid=\"moderate-tabBar-container\"\n   >\n     <Relay(ModerateNavigationContainer)\n       moderationQueues={Object {}}\n+      site={null}\n       story={Object {}}\n     />\n   </withPropsOnChange(SubBar)>"
    },
    {
      "sha": "3343004a3ac85c25700dc8dc2920218d1bb0a48b",
      "filename": "src/core/client/admin/routes/Stories/SiteFilter/SiteFilter.css",
      "status": "added",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/SiteFilter/SiteFilter.css",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/SiteFilter/SiteFilter.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Stories/SiteFilter/SiteFilter.css?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,9 @@\n+.buttonText {\n+  font-weight: var(--v2-font-weight-primary-regular);\n+}\n+\n+.root {\n+  border-radius: var(--round-corners);\n+  border: 1px solid var(--v2-palette-input-border);\n+  height: 34px;\n+}"
    },
    {
      "sha": "a6d2e36d366937b9b13e6e079e3dfba991f78802",
      "filename": "src/core/client/admin/routes/Stories/SiteFilter/SiteFilter.tsx",
      "status": "added",
      "additions": 79,
      "deletions": 0,
      "changes": 79,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/SiteFilter/SiteFilter.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/SiteFilter/SiteFilter.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Stories/SiteFilter/SiteFilter.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,79 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import React, { FunctionComponent } from \"react\";\n+\n+import PaginatedSelect from \"coral-admin/components/PaginatedSelect\";\n+import { PropTypesOf } from \"coral-framework/types\";\n+import { FieldSet, HorizontalGutter, Label } from \"coral-ui/components/v2\";\n+\n+import SiteFilterOption from \"./SiteFilterOption\";\n+import SiteFilterSelected from \"./SiteFilterSelected\";\n+\n+import styles from \"./SiteFilter.css\";\n+\n+interface Props {\n+  sites: Array<\n+    { id: string } & PropTypesOf<typeof SiteFilterOption>[\"site\"] &\n+      PropTypesOf<typeof SiteFilterSelected>[\"site\"]\n+  >;\n+  siteID: string | null;\n+  onSelect: (id: string | null) => void;\n+  onLoadMore: () => void;\n+  hasMore: boolean;\n+  disableLoadMore: boolean;\n+  loading: boolean;\n+}\n+\n+const SiteFilter: FunctionComponent<Props> = ({\n+  siteID,\n+  sites,\n+  onSelect,\n+  onLoadMore,\n+  hasMore,\n+  disableLoadMore,\n+  loading,\n+}) => {\n+  const selected = sites.find(s => s.id === siteID);\n+  return (\n+    <FieldSet>\n+      <HorizontalGutter spacing={2}>\n+        <Localized id=\"stories-filter-sites\">\n+          <Label>Site</Label>\n+        </Localized>\n+        <PaginatedSelect\n+          onLoadMore={onLoadMore}\n+          hasMore={hasMore}\n+          disableLoadMore={disableLoadMore}\n+          className={styles.root}\n+          loading={loading}\n+          selected={\n+            <>\n+              {selected ? (\n+                <SiteFilterSelected site={selected} />\n+              ) : (\n+                <Localized id=\"sites-filter-sites-allSites\">\n+                  <span className={styles.buttonText}>All sites</span>\n+                </Localized>\n+              )}\n+            </>\n+          }\n+        >\n+          <SiteFilterOption\n+            onSelect={() => onSelect(null)}\n+            site={null}\n+            active={!siteID}\n+          />\n+          {sites.map(s => (\n+            <SiteFilterOption\n+              onSelect={id => onSelect(id)}\n+              site={s}\n+              active={s.id === siteID}\n+              key={s.id}\n+            />\n+          ))}\n+        </PaginatedSelect>\n+      </HorizontalGutter>\n+    </FieldSet>\n+  );\n+};\n+\n+export default SiteFilter;"
    },
    {
      "sha": "17edf76fb44a655e637ccb00b13909666688df14",
      "filename": "src/core/client/admin/routes/Stories/SiteFilter/SiteFilterContainer.tsx",
      "status": "added",
      "additions": 97,
      "deletions": 0,
      "changes": 97,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/SiteFilter/SiteFilterContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/SiteFilter/SiteFilterContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Stories/SiteFilter/SiteFilterContainer.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,97 @@\n+import React from \"react\";\n+import { graphql, RelayPaginationProp } from \"react-relay\";\n+\n+import {\n+  useLoadMore,\n+  useRefetch,\n+  withPaginationContainer,\n+} from \"coral-framework/lib/relay\";\n+\n+import { SiteFilterContainer_query as QueryData } from \"coral-admin/__generated__/SiteFilterContainer_query.graphql\";\n+import { SiteFilterContainerPaginationQueryVariables } from \"coral-admin/__generated__/SiteFilterContainerPaginationQuery.graphql\";\n+\n+import SiteFilter from \"./SiteFilter\";\n+\n+interface Props {\n+  query: QueryData | null;\n+  relay: RelayPaginationProp;\n+  siteID: string | null;\n+  onSelect: (id: string) => void;\n+}\n+\n+const SiteFilterContainer: React.FunctionComponent<Props> = props => {\n+  const sites = props.query\n+    ? props.query.sites.edges.map(edge => edge.node)\n+    : [];\n+  const [loadMore, isLoadingMore] = useLoadMore(props.relay, 10);\n+  const [, isRefetching] = useRefetch<\n+    SiteFilterContainerPaginationQueryVariables\n+  >(props.relay);\n+  return (\n+    <SiteFilter\n+      onSelect={props.onSelect}\n+      loading={!props.query || isRefetching}\n+      sites={sites}\n+      siteID={props.siteID}\n+      onLoadMore={loadMore}\n+      hasMore={!isRefetching && props.relay.hasMore()}\n+      disableLoadMore={isLoadingMore}\n+    />\n+  );\n+};\n+\n+type FragmentVariables = SiteFilterContainerPaginationQueryVariables;\n+\n+const enhanced = withPaginationContainer<\n+  Props,\n+  SiteFilterContainerPaginationQueryVariables,\n+  FragmentVariables\n+>(\n+  {\n+    query: graphql`\n+      fragment SiteFilterContainer_query on Query\n+        @argumentDefinitions(\n+          count: { type: \"Int!\", defaultValue: 10 }\n+          cursor: { type: \"Cursor\" }\n+        ) {\n+        sites(first: $count, after: $cursor)\n+          @connection(key: \"SitesConfig_sites\") {\n+          edges {\n+            node {\n+              id\n+              ...SiteFilterOption_site\n+              ...SiteFilterSelected_site\n+            }\n+          }\n+        }\n+      }\n+    `,\n+  },\n+  {\n+    direction: \"forward\",\n+    getConnectionFromProps(props) {\n+      return props.query && props.query.sites;\n+    },\n+    // This is also the default implementation of `getFragmentVariables` if it isn't provided.\n+    getFragmentVariables(prevVars, totalCount) {\n+      return {\n+        ...prevVars,\n+        count: totalCount,\n+      };\n+    },\n+    getVariables(props, { count, cursor }, fragmentVariables) {\n+      return {\n+        count,\n+        cursor,\n+      };\n+    },\n+    query: graphql`\n+      # Pagination query to be fetched upon calling 'loadMore'.\n+      # Notice that we re-use our fragment, and the shape of this query matches our fragment spec.\n+      query SiteFilterContainerPaginationQuery($count: Int!, $cursor: Cursor) {\n+        ...SiteFilterContainer_query @arguments(count: $count, cursor: $cursor)\n+      }\n+    `,\n+  }\n+)(SiteFilterContainer);\n+export default enhanced;"
    },
    {
      "sha": "c8e2a52467d66dd14e5f92d5aff34e70f2b0e452",
      "filename": "src/core/client/admin/routes/Stories/SiteFilter/SiteFilterOption.css",
      "status": "added",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/SiteFilter/SiteFilterOption.css",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/SiteFilter/SiteFilterOption.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Stories/SiteFilter/SiteFilterOption.css?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,9 @@\n+.root {\n+  display: block;\n+  font-weight: var(--v2-font-weight-primary-regular);\n+  padding: var(--v2-spacing-2);\n+}\n+\n+.active {\n+  font-weight: var(--v2-font-weight-primary-bold);\n+}"
    },
    {
      "sha": "7cff6836d0b4cad0fbca723c51fcca12a9e1cf46",
      "filename": "src/core/client/admin/routes/Stories/SiteFilter/SiteFilterOption.tsx",
      "status": "added",
      "additions": 56,
      "deletions": 0,
      "changes": 56,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/SiteFilter/SiteFilterOption.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/SiteFilter/SiteFilterOption.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Stories/SiteFilter/SiteFilterOption.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,56 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import cn from \"classnames\";\n+import React, { FunctionComponent, useCallback } from \"react\";\n+\n+import { graphql, withFragmentContainer } from \"coral-framework/lib/relay\";\n+import { Button } from \"coral-ui/components/v2\";\n+\n+import { SiteFilterOption_site } from \"coral-admin/__generated__/SiteFilterOption_site.graphql\";\n+\n+import styles from \"./SiteFilterOption.css\";\n+\n+interface Props {\n+  site: SiteFilterOption_site | null;\n+  onSelect: (id: string | null) => void;\n+  active: boolean;\n+}\n+\n+const SiteFilterOption: FunctionComponent<Props> = ({\n+  site,\n+  onSelect,\n+  active,\n+}) => {\n+  const root = cn(styles.root, {\n+    [styles.active]: active,\n+  });\n+  const onClick = useCallback(() => {\n+    onSelect(site ? site.id : null);\n+  }, [site]);\n+  return (\n+    <Button\n+      uppercase={false}\n+      color=\"mono\"\n+      variant=\"text\"\n+      onClick={onClick}\n+      className={root}\n+    >\n+      {site && site.name}\n+      {!site && (\n+        <Localized id=\"site-filter-option-allSites\">\n+          <span>All sites</span>\n+        </Localized>\n+      )}\n+    </Button>\n+  );\n+};\n+\n+const enhanced = withFragmentContainer<Props>({\n+  site: graphql`\n+    fragment SiteFilterOption_site on Site {\n+      name\n+      id\n+    }\n+  `,\n+})(SiteFilterOption);\n+\n+export default enhanced;"
    },
    {
      "sha": "73deed1fbdd60d800aa617c7c9875b70fe67aa46",
      "filename": "src/core/client/admin/routes/Stories/SiteFilter/SiteFilterSelected.css",
      "status": "added",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/SiteFilter/SiteFilterSelected.css",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/SiteFilter/SiteFilterSelected.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Stories/SiteFilter/SiteFilterSelected.css?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,3 @@\n+.root {\n+  font-weight: var(--v2-font-weight-primary-regular);\n+}"
    },
    {
      "sha": "200b24b9211ceb1d9de7fef4405218871473da5a",
      "filename": "src/core/client/admin/routes/Stories/SiteFilter/SiteFilterSelected.tsx",
      "status": "added",
      "additions": 25,
      "deletions": 0,
      "changes": 25,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/SiteFilter/SiteFilterSelected.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/SiteFilter/SiteFilterSelected.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Stories/SiteFilter/SiteFilterSelected.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,25 @@\n+import React, { FunctionComponent } from \"react\";\n+\n+import { graphql, withFragmentContainer } from \"coral-framework/lib/relay\";\n+\n+import { SiteFilterSelected_site } from \"coral-admin/__generated__/SiteFilterSelected_site.graphql\";\n+\n+import styles from \"./SiteFilterSelected.css\";\n+\n+interface Props {\n+  site: SiteFilterSelected_site;\n+}\n+\n+const SiteFilterSelected: FunctionComponent<Props> = ({ site }) => {\n+  return <span className={styles.root}>{site.name}</span>;\n+};\n+\n+const enhanced = withFragmentContainer<Props>({\n+  site: graphql`\n+    fragment SiteFilterSelected_site on Site {\n+      name\n+    }\n+  `,\n+})(SiteFilterSelected);\n+\n+export default enhanced;"
    },
    {
      "sha": "31cdfe2a330ab01e36a832b4d66e5a518ae1f79b",
      "filename": "src/core/client/admin/routes/Stories/SiteFilter/index.ts",
      "status": "added",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/SiteFilter/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/SiteFilter/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Stories/SiteFilter/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1 @@\n+export { default } from \"./SiteFilterContainer\";"
    },
    {
      "sha": "e282f348dd45202e792af405cfeb06cc57236afd",
      "filename": "src/core/client/admin/routes/Stories/StoryRow.css",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/StoryRow.css",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/StoryRow.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Stories/StoryRow.css?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -17,3 +17,5 @@\n }\n .statusColumn {\n }\n+.siteColumn {\n+}"
    },
    {
      "sha": "751adb8ad9584a1237cfe25fb2bcba67a2f288c3",
      "filename": "src/core/client/admin/routes/Stories/StoryRow.tsx",
      "status": "modified",
      "additions": 12,
      "deletions": 2,
      "changes": 14,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/StoryRow.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/StoryRow.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Stories/StoryRow.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -2,7 +2,7 @@ import { Link } from \"found\";\n import React, { FunctionComponent } from \"react\";\n \n import NotAvailable from \"coral-admin/components/NotAvailable\";\n-import { getModerationLink } from \"coral-admin/helpers\";\n+import { getModerationLink } from \"coral-framework/helpers\";\n import { PropTypesOf } from \"coral-framework/types\";\n import { TableCell, TableRow, TextLink } from \"coral-ui/components/v2\";\n \n@@ -17,18 +17,28 @@ interface Props {\n   publishDate: string | null;\n   story: PropTypesOf<typeof StoryStatus>[\"story\"];\n   viewer: PropTypesOf<typeof StoryStatus>[\"viewer\"];\n+  siteName: string;\n+  siteID: string;\n+  multisite: boolean;\n }\n \n const UserRow: FunctionComponent<Props> = props => (\n   <TableRow>\n     <TableCell className={styles.titleColumn}>\n-      <Link to={getModerationLink(\"default\", props.storyID)} as={TextLink}>\n+      <Link to={getModerationLink({ storyID: props.storyID })} as={TextLink}>\n         {props.title || <NotAvailable />}\n       </Link>\n     </TableCell>\n     <TableCell className={styles.authorColumn}>\n       {props.author || <NotAvailable />}\n     </TableCell>\n+    {props.multisite && (\n+      <TableCell className={styles.siteColumn}>\n+        <Link to={getModerationLink({ siteID: props.siteID })} as={TextLink}>\n+          {props.siteName}\n+        </Link>\n+      </TableCell>\n+    )}\n     <TableCell className={styles.publishDateColumn}>\n       {props.publishDate || <NotAvailable />}\n     </TableCell>"
    },
    {
      "sha": "81156b06e87c1a544a7019a4c93665b1d1335cf7",
      "filename": "src/core/client/admin/routes/Stories/StoryRowContainer.tsx",
      "status": "modified",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/StoryRowContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/StoryRowContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Stories/StoryRowContainer.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -12,6 +12,7 @@ import StoryRow from \"./StoryRow\";\n interface Props {\n   story: StoryData;\n   viewer: ViewerData;\n+  multisite: boolean;\n }\n \n const StoryRowContainer: FunctionComponent<Props> = props => {\n@@ -26,6 +27,9 @@ const StoryRowContainer: FunctionComponent<Props> = props => {\n       author={author}\n       story={props.story}\n       viewer={props.viewer}\n+      siteName={props.story.site.name}\n+      siteID={props.story.site.id}\n+      multisite={props.multisite}\n       publishDate={\n         publishedAt\n           ? new Intl.DateTimeFormat(locales, {\n@@ -57,6 +61,10 @@ const enhanced = withFragmentContainer<Props>({\n         author\n         publishedAt\n       }\n+      site {\n+        name\n+        id\n+      }\n       isClosed\n       ...StoryStatusChangeContainer_story\n     }"
    },
    {
      "sha": "9d94681282b358bc0363134ac44977d6b02fe034",
      "filename": "src/core/client/admin/routes/Stories/StoryTable.css",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/StoryTable.css",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/StoryTable.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Stories/StoryTable.css?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -3,6 +3,9 @@ $tableHeaderAltTextColor: var(--v2-colors-mono-100);\n .titleColumn {\n   width: 50%;\n }\n+.titleColumnNarrow {\n+  width: 32.5%;\n+}\n .authorColumn {\n   width: 17.5%;\n }\n@@ -12,6 +15,9 @@ $tableHeaderAltTextColor: var(--v2-colors-mono-100);\n .statusColumn {\n   width: 15%;\n }\n+.siteColumn {\n+  width: 17.5%;\n+}\n .clickToModerate {\n   font-size: var(--v2-font-size-2);\n   font-weight: var(--v2-font-weight-primary-semi-bold);"
    },
    {
      "sha": "0d6793b8b087e0cda515ddcb5916e30bf9a2e5b7",
      "filename": "src/core/client/admin/routes/Stories/StoryTable.tsx",
      "status": "modified",
      "additions": 18,
      "deletions": 2,
      "changes": 20,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/StoryTable.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/StoryTable.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Stories/StoryTable.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,4 +1,5 @@\n import { Localized } from \"@fluent/react/compat\";\n+import cn from \"classnames\";\n import React, { FunctionComponent } from \"react\";\n \n import AutoLoadMore from \"coral-admin/components/AutoLoadMore\";\n@@ -28,6 +29,7 @@ interface Props {\n   disableLoadMore: boolean;\n   loading: boolean;\n   isSearching: boolean;\n+  multisite: boolean;\n }\n \n const StoryTable: FunctionComponent<Props> = props => (\n@@ -36,7 +38,11 @@ const StoryTable: FunctionComponent<Props> = props => (\n       <Table fullWidth>\n         <TableHead>\n           <TableRow>\n-            <TableCell className={styles.titleColumn}>\n+            <TableCell\n+              className={cn(styles.titleColumn, {\n+                [styles.titleColumnNarrow]: props.multisite,\n+              })}\n+            >\n               <Localized id=\"stories-column-title\">\n                 <span>Title</span>\n               </Localized>{\" \"}\n@@ -52,6 +58,11 @@ const StoryTable: FunctionComponent<Props> = props => (\n             <Localized id=\"stories-column-author\">\n               <TableCell className={styles.authorColumn}>Author</TableCell>\n             </Localized>\n+            {props.multisite && (\n+              <Localized id=\"stories-column-site\">\n+                <TableCell className={styles.siteColumn}>Site</TableCell>\n+              </Localized>\n+            )}\n             <Localized id=\"stories-column-publishDate\">\n               <TableCell className={styles.publishDateColumn}>\n                 Publish Date\n@@ -65,7 +76,12 @@ const StoryTable: FunctionComponent<Props> = props => (\n         <TableBody>\n           {!props.loading &&\n             props.stories.map(u => (\n-              <StoryRowContainer key={u.id} story={u} viewer={props.viewer!} />\n+              <StoryRowContainer\n+                key={u.id}\n+                story={u}\n+                viewer={props.viewer!}\n+                multisite={props.multisite}\n+              />\n             ))}\n         </TableBody>\n       </Table>"
    },
    {
      "sha": "afa4aa428dac75519aef684d4ea76e2eb0b24587",
      "filename": "src/core/client/admin/routes/Stories/StoryTableContainer.tsx",
      "status": "modified",
      "additions": 30,
      "deletions": 8,
      "changes": 38,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/StoryTableContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/StoryTableContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Stories/StoryTableContainer.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -8,11 +8,12 @@ import {\n   withPaginationContainer,\n } from \"coral-framework/lib/relay\";\n import { GQLSTORY_STATUS_RL } from \"coral-framework/schema\";\n-import { HorizontalGutter } from \"coral-ui/components/v2\";\n+import { Flex, HorizontalGutter } from \"coral-ui/components/v2\";\n \n import { StoryTableContainer_query as QueryData } from \"coral-admin/__generated__/StoryTableContainer_query.graphql\";\n import { StoryTableContainerPaginationQueryVariables } from \"coral-admin/__generated__/StoryTableContainerPaginationQuery.graphql\";\n \n+import SiteFilterContainer from \"./SiteFilter\";\n import StoryTable from \"./StoryTable\";\n import StoryTableFilter from \"./StoryTableFilter\";\n \n@@ -34,30 +35,42 @@ const StoryTableContainer: FunctionComponent<Props> = props => {\n   const [statusFilter, setStatusFilter] = useState<GQLSTORY_STATUS_RL | null>(\n     null\n   );\n+  const [siteFilter, setSiteFilter] = useState<string | null>(null);\n   const [, isRefetching] = useRefetch<\n     Pick<\n       StoryTableContainerPaginationQueryVariables,\n-      \"searchFilter\" | \"statusFilter\"\n+      \"searchFilter\" | \"statusFilter\" | \"siteID\"\n     >\n   >(props.relay, {\n     searchFilter: searchFilter || null,\n     statusFilter,\n+    siteID: siteFilter,\n   });\n \n   return (\n     <IntersectionProvider>\n       <HorizontalGutter size=\"double\">\n-        <StoryTableFilter\n-          onSetStatusFilter={setStatusFilter}\n-          statusFilter={statusFilter}\n-          onSetSearchFilter={setSearchFilter}\n-          searchFilter={searchFilter}\n-        />\n+        <Flex itemGutter=\"double\">\n+          <StoryTableFilter\n+            onSetStatusFilter={setStatusFilter}\n+            statusFilter={statusFilter}\n+            onSetSearchFilter={setSearchFilter}\n+            searchFilter={searchFilter}\n+          />\n+          {props.query && props.query.settings.multisite && (\n+            <SiteFilterContainer\n+              query={props.query}\n+              siteID={siteFilter}\n+              onSelect={setSiteFilter}\n+            />\n+          )}\n+        </Flex>\n         <StoryTable\n           viewer={props.query && props.query.viewer}\n           loading={!props.query || isRefetching}\n           stories={stories}\n           onLoadMore={loadMore}\n+          multisite={props.query ? props.query.settings.multisite : false}\n           hasMore={!isRefetching && props.relay.hasMore()}\n           disableLoadMore={isLoadingMore}\n           isSearching={Boolean(statusFilter) || Boolean(searchFilter)}\n@@ -83,15 +96,21 @@ const enhanced = withPaginationContainer<\n           cursor: { type: \"Cursor\" }\n           statusFilter: { type: \"STORY_STATUS\" }\n           searchFilter: { type: \"String\" }\n+          siteID: { type: \"ID\" }\n         ) {\n         viewer {\n           ...StoryRowContainer_viewer\n         }\n+        settings {\n+          multisite\n+        }\n+        ...SiteFilterContainer_query\n         stories(\n           first: $count\n           after: $cursor\n           status: $statusFilter\n           query: $searchFilter\n+          siteID: $siteID\n         ) @connection(key: \"StoryTable_stories\") {\n           edges {\n             node {\n@@ -121,6 +140,7 @@ const enhanced = withPaginationContainer<\n         cursor,\n         statusFilter: fragmentVariables.statusFilter,\n         searchFilter: fragmentVariables.searchFilter,\n+        siteID: fragmentVariables.siteID,\n       };\n     },\n     query: graphql`\n@@ -131,13 +151,15 @@ const enhanced = withPaginationContainer<\n         $cursor: Cursor\n         $statusFilter: STORY_STATUS\n         $searchFilter: String\n+        $siteID: ID\n       ) {\n         ...StoryTableContainer_query\n           @arguments(\n             count: $count\n             cursor: $cursor\n             statusFilter: $statusFilter\n             searchFilter: $searchFilter\n+            siteID: $siteID\n           )\n       }\n     `,"
    },
    {
      "sha": "e023b56493330a80e3c94583513a539cd32a7e2c",
      "filename": "src/core/client/admin/routes/Stories/StoryTableFilter.tsx",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/StoryTableFilter.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/routes/Stories/StoryTableFilter.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Stories/StoryTableFilter.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -83,8 +83,8 @@ const StoryTableFilter: FunctionComponent<Props> = props => (\n     </FieldSet>\n     <FieldSet>\n       <HorizontalGutter spacing={2}>\n-        <Localized id=\"stories-filter-showMe\">\n-          <Label>Show Me</Label>\n+        <Localized id=\"stories-filter-statuses\">\n+          <Label>Status</Label>\n         </Localized>\n         <Localized\n           id=\"stories-filter-statusSelectField\""
    },
    {
      "sha": "bf33a8a6fa7cfb294c92326c40641f6d5bb84921",
      "filename": "src/core/client/admin/test/auth/redirectLoggedIn.spec.tsx",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/auth/redirectLoggedIn.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/auth/redirectLoggedIn.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/auth/redirectLoggedIn.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -17,6 +17,7 @@ import {\n   emptyModerationQueues,\n   emptyRejectedComments,\n   settings,\n+  siteConnection,\n   users,\n } from \"../fixtures\";\n \n@@ -36,6 +37,7 @@ async function createTestRenderer(\n             QueryToModerationQueuesResolver\n           >(() => emptyModerationQueues),\n           comments: () => emptyRejectedComments,\n+          sites: () => siteConnection,\n           viewer: () => viewer,\n         },\n       }),"
    },
    {
      "sha": "b320f730b1ef755ad52865790cde1dfe1faf34d7",
      "filename": "src/core/client/admin/test/auth/redirectLoggedOut.spec.tsx",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/auth/redirectLoggedOut.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/auth/redirectLoggedOut.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/auth/redirectLoggedOut.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -18,6 +18,7 @@ import {\n   emptyModerationQueues,\n   emptyRejectedComments,\n   settings,\n+  siteConnection,\n } from \"../fixtures\";\n \n async function createTestRenderer(\n@@ -30,6 +31,7 @@ async function createTestRenderer(\n       createResolversStub<GQLResolver>({\n         Query: {\n           settings: () => settings,\n+          sites: () => siteConnection,\n           moderationQueues: createQueryResolverStub<\n             QueryToModerationQueuesResolver\n           >(() => emptyModerationQueues),"
    },
    {
      "sha": "faaf4f05abb8360d7511f9749b09267cc863b446",
      "filename": "src/core/client/admin/test/auth/restricted.spec.tsx",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/auth/restricted.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/auth/restricted.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/auth/restricted.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -17,6 +17,7 @@ import {\n   emptyModerationQueues,\n   emptyRejectedComments,\n   settings,\n+  siteConnection,\n   users,\n } from \"../fixtures\";\n \n@@ -35,6 +36,7 @@ async function createTestRenderer(\n           moderationQueues: () => emptyModerationQueues,\n           comments: () => emptyRejectedComments,\n           viewer: () => viewer,\n+          sites: () => siteConnection,\n         },\n       }),\n       params.resolvers"
    },
    {
      "sha": "4d1a496c59e6007df3ebb29916546432fc7cdd8e",
      "filename": "src/core/client/admin/test/auth/signInWithEmail.spec.tsx",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/auth/signInWithEmail.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/auth/signInWithEmail.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/auth/signInWithEmail.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -19,6 +19,7 @@ import {\n   emptyModerationQueues,\n   emptyRejectedComments,\n   settings,\n+  siteConnection,\n } from \"../fixtures\";\n \n async function createTestRenderer(\n@@ -36,6 +37,7 @@ async function createTestRenderer(\n           settings: () => settings,\n           moderationQueues: () => emptyModerationQueues,\n           comments: () => emptyRejectedComments,\n+          sites: () => siteConnection,\n         },\n       }),\n       params.resolvers"
    },
    {
      "sha": "1030f489912309f6f0f064c6899dc418cc1fe2c8",
      "filename": "src/core/client/admin/test/auth/signOut.spec.tsx",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/auth/signOut.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/auth/signOut.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/auth/signOut.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -16,6 +16,7 @@ import {\n   emptyModerationQueues,\n   emptyRejectedComments,\n   settings,\n+  siteConnection,\n   users,\n } from \"../fixtures\";\n \n@@ -32,6 +33,7 @@ async function createTestRenderer(\n         Query: {\n           settings: () => settings,\n           moderationQueues: () => emptyModerationQueues,\n+          sites: () => siteConnection,\n           comments: () => emptyRejectedComments,\n           viewer: () => viewer,\n         },"
    },
    {
      "sha": "2e7d8cbe5cbbb37b4a1bd0c75f5c0d82a638d963",
      "filename": "src/core/client/admin/test/configure/__snapshots__/advanced.spec.tsx.snap",
      "status": "modified",
      "additions": 0,
      "deletions": 139,
      "changes": 139,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/configure/__snapshots__/advanced.spec.tsx.snap",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/configure/__snapshots__/advanced.spec.tsx.snap",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/configure/__snapshots__/advanced.spec.tsx.snap?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -127,85 +127,6 @@ exports[`renders configure advanced 1`] = `\n           className=\"Box-root HorizontalGutter-root HorizontalGutter-double\"\n           data-testid=\"configure-advancedContainer\"\n         >\n-          <fieldset\n-            className=\"FieldSet-root Box-root ConfigBox-root\"\n-          >\n-            <div\n-              className=\"Box-root Flex-root ConfigBox-title Flex-flex Flex-justifySpaceBetween\"\n-            >\n-              <div>\n-                <legend\n-                  className=\"Header-root\"\n-                >\n-                  Embed code\n-                </legend>\n-              </div>\n-              <div />\n-            </div>\n-            <div\n-              className=\"ConfigBox-content\"\n-            >\n-              <fieldset\n-                className=\"FieldSet-root Box-root HorizontalGutter-root HorizontalGutter-spacing-4\"\n-              >\n-                <p\n-                  className=\"FormFieldDescription-root\"\n-                >\n-                  Copy and paste the code below into your CMS to embed Coral comment streams in\n-each of your site’s stories.\n-                </p>\n-                <textarea\n-                  className=\"Textarea-root EmbedCode-textArea\"\n-                  readOnly={true}\n-                  rows={24}\n-                  value=\"<div id=\\\\\"coral_thread\\\\\"></div>\n-<script type=\\\\\"text/javascript\\\\\">\n-  (function() {\n-      var d = document, s = d.createElement('script');\n-      s.src = 'http://localhost/assets/js/embed.js';\n-      s.async = false;\n-      s.defer = true;\n-      s.onload = function() {\n-          Coral.createStreamEmbed({\n-              id: \\\\\"coral_thread\\\\\",\n-              autoRender: true,\n-              rootURL: 'http://localhost',\n-              // Uncomment these lines and replace with the ID of the\n-              // story's ID and URL from your CMS to provide the\n-              // tightest integration. Refer to our documentation at\n-              // https://docs.coralproject.net for all the configuration\n-              // options.\n-              // storyID: '\\${storyID}',\n-              // storyURL: '\\${storyURL}',\n-          });\n-      };\n-      (d.head || d.body).appendChild(s);\n-  })();\n-</script>\"\n-                />\n-                <div\n-                  className=\"Box-root HorizontalGutter-root EmbedCode-copyArea HorizontalGutter-full\"\n-                >\n-                  <button\n-                    className=\"BaseButton-root Button-root Button-sizeRegular Button-colorMono Button-variantFlat Button-uppercase\"\n-                    data-color=\"mono\"\n-                    data-variant=\"flat\"\n-                    onBlur={[Function]}\n-                    onClick={[Function]}\n-                    onFocus={[Function]}\n-                    onMouseOut={[Function]}\n-                    onMouseOver={[Function]}\n-                    onTouchEnd={[Function]}\n-                    type=\"button\"\n-                  >\n-                    <span>\n-                      Copy\n-                    </span>\n-                  </button>\n-                </div>\n-              </fieldset>\n-            </div>\n-          </fieldset>\n           <div\n             className=\"Box-root ConfigBox-root\"\n           >\n@@ -349,66 +270,6 @@ When disabled, users will have to refresh the page to see new comments.\n               </div>\n             </div>\n           </div>\n-          <div\n-            className=\"Box-root ConfigBox-root\"\n-          >\n-            <div\n-              className=\"Box-root Flex-root ConfigBox-title Flex-flex Flex-justifySpaceBetween\"\n-            >\n-              <div>\n-                <label\n-                  className=\"Header-root\"\n-                  htmlFor=\"configure-advanced-allowedDomains\"\n-                >\n-                  Permitted domains\n-                </label>\n-              </div>\n-              <div />\n-            </div>\n-            <div\n-              className=\"ConfigBox-content\"\n-            >\n-              <div\n-                className=\"Box-root HorizontalGutter-root HorizontalGutter-spacing-4\"\n-              >\n-                <div\n-                  className=\"Box-root HorizontalGutter-root FormField-root HorizontalGutter-spacing-2\"\n-                >\n-                  <p\n-                    className=\"FormFieldDescription-root\"\n-                  >\n-                    Domains where your Coral instance is allowed to be embedded\n-including the scheme (ex. http://localhost:3000, https://staging.domain.com,\n-https://domain.com).\n-                  </p>\n-                  <div\n-                    className=\"Box-root HorizontalGutter-root HorizontalGutter-spacing-2\"\n-                  >\n-                    <div\n-                      className=\"TextField-root TextField-fullWidth\"\n-                    >\n-                      <input\n-                        autoCapitalize=\"off\"\n-                        autoComplete=\"off\"\n-                        autoCorrect=\"off\"\n-                        className=\"TextField-input TextField-colorRegular\"\n-                        disabled={false}\n-                        id=\"configure-advanced-allowedDomains\"\n-                        name=\"allowedDomains\"\n-                        onBlur={[Function]}\n-                        onChange={[Function]}\n-                        onFocus={[Function]}\n-                        placeholder=\"\"\n-                        spellCheck={false}\n-                        type=\"text\"\n-                        value=\"http://localhost:8080\"\n-                      />\n-                    </div>\n-                  </div>\n-                </div>\n-              </div>\n-            </div>\n-          </div>\n           <div\n             className=\"Box-root ConfigBox-root\"\n           >"
    },
    {
      "sha": "2c3e878fa7b0cdf30304b5dd4003dc6ef6715f27",
      "filename": "src/core/client/admin/test/configure/__snapshots__/organization.spec.tsx.snap",
      "status": "modified",
      "additions": 167,
      "deletions": 16,
      "changes": 183,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/configure/__snapshots__/organization.spec.tsx.snap",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/configure/__snapshots__/organization.spec.tsx.snap",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/configure/__snapshots__/organization.spec.tsx.snap?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -124,7 +124,7 @@ exports[`renders configure organization 1`] = `\n         className=\"Main-root\"\n       >\n         <div\n-          className=\"Box-root HorizontalGutter-root HorizontalGutter-double\"\n+          className=\"Box-root HorizontalGutter-root HorizontalGutter-spacing-4\"\n           data-testid=\"configure-organizationContainer\"\n         >\n           <div\n@@ -190,9 +190,9 @@ exports[`renders configure organization 1`] = `\n               <div>\n                 <label\n                   className=\"Header-root\"\n-                  htmlFor=\"configure-organization-organization.contactEmail\"\n+                  htmlFor=\"configure-organization-organization.url\"\n                 >\n-                  Organization email\n+                  Organization URL\n                 </label>\n               </div>\n               <div />\n@@ -206,10 +206,7 @@ exports[`renders configure organization 1`] = `\n                 <p\n                   className=\"FormFieldDescription-root\"\n                 >\n-                  This email address will be used as in emails and across the platform\n-for community members to get in touch with the organization should\n-they have any questions about the status of their accounts or\n-moderation questions.\n+                  Your organization url will appear on emails sent by Coral to your community and organization members.\n                 </p>\n                 <div\n                   className=\"Box-root HorizontalGutter-root HorizontalGutter-spacing-2\"\n@@ -223,15 +220,15 @@ moderation questions.\n                       autoCorrect=\"off\"\n                       className=\"TextField-input TextField-colorRegular\"\n                       disabled={false}\n-                      id=\"configure-organization-organization.contactEmail\"\n-                      name=\"organization.contactEmail\"\n+                      id=\"configure-organization-organization.url\"\n+                      name=\"organization.url\"\n                       onBlur={[Function]}\n                       onChange={[Function]}\n                       onFocus={[Function]}\n                       placeholder=\"\"\n                       spellCheck={false}\n                       type=\"text\"\n-                      value=\"coral@test.com\"\n+                      value=\"https://test.com/\"\n                     />\n                   </div>\n                 </div>\n@@ -247,9 +244,9 @@ moderation questions.\n               <div>\n                 <label\n                   className=\"Header-root\"\n-                  htmlFor=\"configure-organization-organization.url\"\n+                  htmlFor=\"configure-organization-organization.contactEmail\"\n                 >\n-                  Organization URL\n+                  Organization email\n                 </label>\n               </div>\n               <div />\n@@ -263,7 +260,10 @@ moderation questions.\n                 <p\n                   className=\"FormFieldDescription-root\"\n                 >\n-                  Your organization url will appear on emails sent by Coral to your community and organization members.\n+                  This email address will be used as in emails and across the platform\n+for community members to get in touch with the organization should\n+they have any questions about the status of their accounts or\n+moderation questions.\n                 </p>\n                 <div\n                   className=\"Box-root HorizontalGutter-root HorizontalGutter-spacing-2\"\n@@ -277,21 +277,172 @@ moderation questions.\n                       autoCorrect=\"off\"\n                       className=\"TextField-input TextField-colorRegular\"\n                       disabled={false}\n-                      id=\"configure-organization-organization.url\"\n-                      name=\"organization.url\"\n+                      id=\"configure-organization-organization.contactEmail\"\n+                      name=\"organization.contactEmail\"\n                       onBlur={[Function]}\n                       onChange={[Function]}\n                       onFocus={[Function]}\n                       placeholder=\"\"\n                       spellCheck={false}\n                       type=\"text\"\n-                      value=\"https://test.com/\"\n+                      value=\"coral@test.com\"\n                     />\n                   </div>\n                 </div>\n               </div>\n             </div>\n           </div>\n+          <div\n+            className=\"Box-root ConfigBox-root\"\n+          >\n+            <div\n+              className=\"Box-root Flex-root ConfigBox-title Flex-flex Flex-justifySpaceBetween\"\n+            >\n+              <div>\n+                <label\n+                  className=\"Header-root\"\n+                  htmlFor=\"configure-organization-organization.sites\"\n+                >\n+                  Sites\n+                </label>\n+              </div>\n+              <div />\n+            </div>\n+            <div\n+              className=\"ConfigBox-content\"\n+            >\n+              <div\n+                className=\"Box-root HorizontalGutter-root HorizontalGutter-spacing-4\"\n+              >\n+                <p\n+                  className=\"FormFieldDescription-root\"\n+                >\n+                  Add a new site to your organization or edit an existing site's details.\n+                </p>\n+                <a\n+                  className=\"BaseButton-root Button-root Button-sizeLarge Button-colorRegular Button-variantRegular Button-uppercase Button-iconLeft\"\n+                  data-color=\"regular\"\n+                  data-variant=\"regular\"\n+                  href=\"/admin/configure/organization/sites/new\"\n+                  onBlur={[Function]}\n+                  onClick={[Function]}\n+                  onFocus={[Function]}\n+                  onMouseOut={[Function]}\n+                  onMouseOver={[Function]}\n+                  onTouchEnd={[Function]}\n+                  type=\"button\"\n+                >\n+                  <i\n+                    aria-hidden=\"true\"\n+                    className=\"Icon-root Icon-sm\"\n+                  >\n+                    add\n+                  </i>\n+                   Add site\n+                </a>\n+                <table\n+                  className=\"Table-root Table-fullWidth\"\n+                >\n+                  <thead\n+                    className=\"TableHead-root\"\n+                  >\n+                    <tr\n+                      className=\"TableRow-root\"\n+                    >\n+                      <th\n+                        className=\"TableCell-root TableCell-header\"\n+                      >\n+                        Site name\n+                      </th>\n+                      <th\n+                        className=\"TableCell-root TableCell-header\"\n+                      />\n+                    </tr>\n+                  </thead>\n+                  <tbody\n+                    className=\"TableBody-root\"\n+                  >\n+                    <tr\n+                      className=\"TableRow-root TableRow-body\"\n+                    >\n+                      <td\n+                        className=\"TableCell-root TableCell-body\"\n+                      >\n+                        Test Site\n+                      </td>\n+                      <td\n+                        className=\"TableCell-root TableCell-body\"\n+                      >\n+                        <div\n+                          className=\"Box-root Flex-root Flex-flex Flex-justifyFlexEnd\"\n+                        >\n+                          <a\n+                            className=\"BaseButton-root Button-root Button-sizeRegular Button-colorRegular Button-variantText Button-uppercase Button-iconRight\"\n+                            data-color=\"regular\"\n+                            data-variant=\"text\"\n+                            href=\"/admin/configure/organization/sites/site-1\"\n+                            onBlur={[Function]}\n+                            onClick={[Function]}\n+                            onFocus={[Function]}\n+                            onMouseOut={[Function]}\n+                            onMouseOver={[Function]}\n+                            onTouchEnd={[Function]}\n+                            type=\"button\"\n+                          >\n+                            Details \n+                            <i\n+                              aria-hidden=\"true\"\n+                              className=\"Icon-root Icon-sm\"\n+                            >\n+                              keyboard_arrow_right\n+                            </i>\n+                          </a>\n+                        </div>\n+                      </td>\n+                    </tr>\n+                    <tr\n+                      className=\"TableRow-root TableRow-body\"\n+                    >\n+                      <td\n+                        className=\"TableCell-root TableCell-body\"\n+                      >\n+                        Second Site\n+                      </td>\n+                      <td\n+                        className=\"TableCell-root TableCell-body\"\n+                      >\n+                        <div\n+                          className=\"Box-root Flex-root Flex-flex Flex-justifyFlexEnd\"\n+                        >\n+                          <a\n+                            className=\"BaseButton-root Button-root Button-sizeRegular Button-colorRegular Button-variantText Button-uppercase Button-iconRight\"\n+                            data-color=\"regular\"\n+                            data-variant=\"text\"\n+                            href=\"/admin/configure/organization/sites/site-2\"\n+                            onBlur={[Function]}\n+                            onClick={[Function]}\n+                            onFocus={[Function]}\n+                            onMouseOut={[Function]}\n+                            onMouseOver={[Function]}\n+                            onTouchEnd={[Function]}\n+                            type=\"button\"\n+                          >\n+                            Details \n+                            <i\n+                              aria-hidden=\"true\"\n+                              className=\"Icon-root Icon-sm\"\n+                            >\n+                              keyboard_arrow_right\n+                            </i>\n+                          </a>\n+                        </div>\n+                      </td>\n+                    </tr>\n+                  </tbody>\n+                </table>\n+              </div>\n+            </div>\n+          </div>\n         </div>\n       </div>\n     </div>"
    },
    {
      "sha": "bb70dfa143eb6d227253fa0704fdd817982c5fd9",
      "filename": "src/core/client/admin/test/configure/advanced.spec.tsx",
      "status": "modified",
      "additions": 0,
      "deletions": 103,
      "changes": 103,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/configure/advanced.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/configure/advanced.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/configure/advanced.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -175,106 +175,3 @@ it(\"renders without live configuration when not configurable\", async () => {\n     within(advancedContainer).queryByLabelText(\"Comment Stream Live Updates\")\n   ).toEqual(null);\n });\n-\n-it(\"change permitted domains to be empty\", async () => {\n-  const resolvers = createResolversStub<GQLResolver>({\n-    Mutation: {\n-      updateSettings: ({ variables }) => {\n-        expectAndFail(variables.settings.allowedDomains).toEqual([]);\n-        return {\n-          settings: pureMerge(settings, variables.settings),\n-        };\n-      },\n-    },\n-  });\n-  const {\n-    configureContainer,\n-    advancedContainer,\n-    saveChangesButton,\n-  } = await createTestRenderer({\n-    resolvers,\n-  });\n-\n-  const permittedDomainsField = within(advancedContainer).getByLabelText(\n-    \"Permitted domains\"\n-  );\n-\n-  // Let's change the permitted domains.\n-  act(() => permittedDomainsField.props.onChange(\"\"));\n-\n-  // Send form\n-  act(() => {\n-    within(configureContainer)\n-      .getByType(\"form\")\n-      .props.onSubmit();\n-  });\n-\n-  // Submit button and text field should be disabled.\n-  expect(saveChangesButton.props.disabled).toBe(true);\n-  expect(permittedDomainsField.props.disabled).toBe(true);\n-\n-  // Wait for submission to be finished\n-  await act(async () => {\n-    await wait(() => {\n-      expect(permittedDomainsField.props.disabled).toBe(false);\n-    });\n-  });\n-\n-  // Should have successfully sent with server.\n-  expect(resolvers.Mutation!.updateSettings!.called).toBe(true);\n-});\n-\n-it(\"change permitted domains to include more domains\", async () => {\n-  const resolvers = createResolversStub<GQLResolver>({\n-    Mutation: {\n-      updateSettings: ({ variables }) => {\n-        expectAndFail(variables.settings.allowedDomains).toEqual([\n-          \"http://localhost:8080\",\n-          \"http://localhost:3000\",\n-        ]);\n-        return {\n-          settings: pureMerge(settings, variables.settings),\n-        };\n-      },\n-    },\n-  });\n-  const {\n-    configureContainer,\n-    advancedContainer,\n-    saveChangesButton,\n-  } = await createTestRenderer({\n-    resolvers,\n-  });\n-\n-  const permittedDomainsField = within(advancedContainer).getByLabelText(\n-    \"Permitted domains\"\n-  );\n-\n-  // Let's change the permitted domains.\n-  act(() =>\n-    permittedDomainsField.props.onChange(\n-      \"http://localhost:8080, http://localhost:3000\"\n-    )\n-  );\n-\n-  // Send form\n-  act(() => {\n-    within(configureContainer)\n-      .getByType(\"form\")\n-      .props.onSubmit();\n-  });\n-\n-  // Submit button and text field should be disabled.\n-  expect(saveChangesButton.props.disabled).toBe(true);\n-  expect(permittedDomainsField.props.disabled).toBe(true);\n-\n-  // Wait for submission to be finished\n-  await act(async () => {\n-    await wait(() => {\n-      expect(permittedDomainsField.props.disabled).toBe(false);\n-    });\n-  });\n-\n-  // Should have successfully sent with server.\n-  expect(resolvers.Mutation!.updateSettings!.called).toBe(true);\n-});"
    },
    {
      "sha": "4d0968d5d1be58bdc268d4320cce860eb64cdd3f",
      "filename": "src/core/client/admin/test/configure/organization.spec.tsx",
      "status": "modified",
      "additions": 2,
      "deletions": 67,
      "changes": 69,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/configure/organization.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/configure/organization.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/configure/organization.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -11,7 +11,7 @@ import {\n } from \"coral-framework/testHelpers\";\n \n import create from \"../create\";\n-import { settings, users } from \"../fixtures\";\n+import { settings, siteConnection, users } from \"../fixtures\";\n \n beforeEach(() => {\n   replaceHistoryLocation(\"http://localhost/admin/configure/organization\");\n@@ -29,6 +29,7 @@ async function createTestRenderer(\n         Query: {\n           settings: () => settings,\n           viewer: () => viewer,\n+          sites: () => siteConnection,\n         },\n       }),\n       params.resolvers\n@@ -126,69 +127,3 @@ it(\"change organization name\", async () => {\n   // Should have successfully sent with server.\n   expect(resolvers.Mutation!.updateSettings!.called).toBe(true);\n });\n-\n-it(\"change organization contact email\", async () => {\n-  const resolvers = createResolversStub<GQLResolver>({\n-    Mutation: {\n-      updateSettings: ({ variables }) => {\n-        expectAndFail(variables.settings.organization!.contactEmail).toEqual(\n-          \"test@coralproject.net\"\n-        );\n-        return {\n-          settings: pureMerge(settings, variables.settings),\n-        };\n-      },\n-    },\n-  });\n-  const {\n-    configureContainer,\n-    organizationContainer,\n-    saveChangesButton,\n-  } = await createTestRenderer({ resolvers });\n-\n-  const organizationEmailField = within(organizationContainer).getByLabelText(\n-    \"Organization email\"\n-  );\n-\n-  // Let's change some organization name.\n-  act(() => organizationEmailField.props.onChange(\"\"));\n-\n-  // Send form\n-  act(() => {\n-    within(configureContainer)\n-      .getByType(\"form\")\n-      .props.onSubmit();\n-  });\n-\n-  // Should show validation error.\n-  within(organizationContainer).getByText(\"This field is required.\");\n-\n-  // Let's change to some valid organization name.\n-  act(() => organizationEmailField.props.onChange(\"test@coralproject.net\"));\n-\n-  // Should not show validation error.\n-  expect(\n-    within(organizationContainer).queryByText(\"This field is required.\")\n-  ).toBeNull();\n-\n-  // Send form\n-  act(() => {\n-    within(configureContainer)\n-      .getByType(\"form\")\n-      .props.onSubmit();\n-  });\n-\n-  // Submit button and text field should be disabled.\n-  expect(saveChangesButton.props.disabled).toBe(true);\n-  expect(organizationEmailField.props.disabled).toBe(true);\n-\n-  // Wait for submission to be finished\n-  await act(async () => {\n-    await wait(() => {\n-      expect(organizationEmailField.props.disabled).toBe(false);\n-    });\n-  });\n-\n-  // Should have successfully sent with server.\n-  expect(resolvers.Mutation!.updateSettings!.called).toBe(true);\n-});"
    },
    {
      "sha": "38c8f579f7818467b734dcabb8aa75ba604d2a36",
      "filename": "src/core/client/admin/test/fixtures.ts",
      "status": "modified",
      "additions": 37,
      "deletions": 1,
      "changes": 38,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/fixtures.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/fixtures.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/fixtures.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -13,6 +13,8 @@ import {\n   GQLMODERATION_MODE,\n   GQLModerationQueues,\n   GQLSettings,\n+  GQLSite,\n+  GQLSitesConnection,\n   GQLStoriesConnection,\n   GQLStory,\n   GQLSTORY_STATUS,\n@@ -65,7 +67,6 @@ export const settings = createFixture<GQLSettings>({\n     smtp: {},\n   },\n   customCSSURL: \"\",\n-  allowedDomains: [\"http://localhost:8080\"],\n   editCommentWindowLength: 30000,\n   communityGuidelines: {\n     enabled: false,\n@@ -169,6 +170,7 @@ export const settings = createFixture<GQLSettings>({\n   slack: {\n     channels: [],\n   },\n+  multisite: false,\n });\n \n export const settingsWithEmptyAuth = createFixture<GQLSettings>(\n@@ -236,6 +238,28 @@ export const settingsWithEmptyAuth = createFixture<GQLSettings>(\n   settings\n );\n \n+export const site = createFixture<GQLSite>({\n+  name: \"Test Site\",\n+  id: \"site-id\",\n+  createdAt: \"2018-05-06T18:24:00.000Z\",\n+  allowedOrigins: [\"http://test-site.com\"],\n+});\n+\n+export const sites = createFixtures<GQLSite>([\n+  {\n+    name: \"Test Site\",\n+    id: \"site-1\",\n+    createdAt: \"2018-07-06T18:24:00.000Z\",\n+    allowedOrigins: [\"http://test-site.com\"],\n+  },\n+  {\n+    name: \"Second Site\",\n+    id: \"site-2\",\n+    createdAt: \"2018-09-06T18:24:00.000Z\",\n+    allowedOrigins: [\"http://test-2-site.com\"],\n+  },\n+]);\n+\n export const moderationActions = createFixtures<GQLCommentModerationAction>([\n   {\n     id: \"07e8f815-e165-4b5d-b438-7163415c8cf7\",\n@@ -463,6 +487,7 @@ export const stories = createFixtures<GQLStory>([\n       title: \"Finally a Cure for Cancer\",\n       publishedAt: \"2018-11-29T16:01:51.897Z\",\n     },\n+    site: sites[0],\n   },\n   {\n     id: \"story-2\",\n@@ -476,6 +501,7 @@ export const stories = createFixtures<GQLStory>([\n       title: \"First Colony on Mars\",\n       publishedAt: \"2018-11-29T16:01:51.897Z\",\n     },\n+    site: sites[1],\n   },\n   {\n     id: \"story-3\",\n@@ -489,6 +515,7 @@ export const stories = createFixtures<GQLStory>([\n       title: \"World hunger has been defeated\",\n       publishedAt: \"2018-11-29T16:01:51.897Z\",\n     },\n+    site: sites[1],\n   },\n ]);\n \n@@ -548,6 +575,7 @@ export const baseComment = createFixture<GQLComment>({\n     nodes: [],\n   },\n   story: stories[0],\n+  site: sites[0],\n   // TODO: Should be allowed to pass null here..\n   parent: undefined,\n   deleted: undefined,\n@@ -828,3 +856,11 @@ export const disabledLocalRegistration = createFixture<GQLSettings>(\n     },\n   })\n );\n+\n+export const siteConnection = createFixture<GQLSitesConnection>({\n+  edges: [\n+    { node: sites[0], cursor: sites[0].createdAt },\n+    { node: sites[1], cursor: sites[1].createdAt },\n+  ],\n+  pageInfo: { endCursor: null, hasNextPage: false },\n+});"
    },
    {
      "sha": "c376462d7205b93143fa8964a5b404f79ef3d376",
      "filename": "src/core/client/admin/test/moderate/__snapshots__/regularQueue.spec.tsx.snap",
      "status": "modified",
      "additions": 49,
      "deletions": 21,
      "changes": 70,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/__snapshots__/regularQueue.spec.tsx.snap",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/__snapshots__/regularQueue.spec.tsx.snap",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/moderate/__snapshots__/regularQueue.spec.tsx.snap?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -134,14 +134,18 @@ exports[`approves comment in reported queue: dangling 1`] = `\n               </span>\n             </div>\n             <div\n-              className=\"ModerateCard-storyTitle\"\n+              className=\"ModerateCard-commentOn\"\n             >\n-              Finally a Cure for Cancer\n+              <span\n+                className=\"ModerateCard-storyTitle\"\n+              >\n+                Finally a Cure for Cancer\n+              </span>\n             </div>\n             <div>\n               <a\n                 className=\"TextLink-root ModerateCard-link\"\n-                href=\"/admin/moderate/story-1\"\n+                href=\"/admin/moderate/stories/story-1\"\n                 onClick={[Function]}\n               >\n                 Moderate Story\n@@ -387,14 +391,18 @@ exports[`rejects comment in reported queue: dangling 1`] = `\n               </span>\n             </div>\n             <div\n-              className=\"ModerateCard-storyTitle\"\n+              className=\"ModerateCard-commentOn\"\n             >\n-              Finally a Cure for Cancer\n+              <span\n+                className=\"ModerateCard-storyTitle\"\n+              >\n+                Finally a Cure for Cancer\n+              </span>\n             </div>\n             <div>\n               <a\n                 className=\"TextLink-root ModerateCard-link\"\n-                href=\"/admin/moderate/story-1\"\n+                href=\"/admin/moderate/stories/story-1\"\n                 onClick={[Function]}\n               >\n                 Moderate Story\n@@ -637,14 +645,18 @@ exports[`renders reported queue with comments 1`] = `\n                     </span>\n                   </div>\n                   <div\n-                    className=\"ModerateCard-storyTitle\"\n+                    className=\"ModerateCard-commentOn\"\n                   >\n-                    Finally a Cure for Cancer\n+                    <span\n+                      className=\"ModerateCard-storyTitle\"\n+                    >\n+                      Finally a Cure for Cancer\n+                    </span>\n                   </div>\n                   <div>\n                     <a\n                       className=\"TextLink-root ModerateCard-link\"\n-                      href=\"/admin/moderate/story-1\"\n+                      href=\"/admin/moderate/stories/story-1\"\n                       onClick={[Function]}\n                     >\n                       Moderate Story\n@@ -874,14 +886,18 @@ exports[`renders reported queue with comments 1`] = `\n                     </span>\n                   </div>\n                   <div\n-                    className=\"ModerateCard-storyTitle\"\n+                    className=\"ModerateCard-commentOn\"\n                   >\n-                    Finally a Cure for Cancer\n+                    <span\n+                      className=\"ModerateCard-storyTitle\"\n+                    >\n+                      Finally a Cure for Cancer\n+                    </span>\n                   </div>\n                   <div>\n                     <a\n                       className=\"TextLink-root ModerateCard-link\"\n-                      href=\"/admin/moderate/story-1\"\n+                      href=\"/admin/moderate/stories/story-1\"\n                       onClick={[Function]}\n                     >\n                       Moderate Story\n@@ -1127,14 +1143,18 @@ exports[`renders reported queue with comments 2`] = `\n                     </span>\n                   </div>\n                   <div\n-                    className=\"ModerateCard-storyTitle\"\n+                    className=\"ModerateCard-commentOn\"\n                   >\n-                    Finally a Cure for Cancer\n+                    <span\n+                      className=\"ModerateCard-storyTitle\"\n+                    >\n+                      Finally a Cure for Cancer\n+                    </span>\n                   </div>\n                   <div>\n                     <a\n                       className=\"TextLink-root ModerateCard-link\"\n-                      href=\"/admin/moderate/story-1\"\n+                      href=\"/admin/moderate/stories/story-1\"\n                       onClick={[Function]}\n                     >\n                       Moderate Story\n@@ -1364,14 +1384,18 @@ exports[`renders reported queue with comments 2`] = `\n                     </span>\n                   </div>\n                   <div\n-                    className=\"ModerateCard-storyTitle\"\n+                    className=\"ModerateCard-commentOn\"\n                   >\n-                    Finally a Cure for Cancer\n+                    <span\n+                      className=\"ModerateCard-storyTitle\"\n+                    >\n+                      Finally a Cure for Cancer\n+                    </span>\n                   </div>\n                   <div>\n                     <a\n                       className=\"TextLink-root ModerateCard-link\"\n-                      href=\"/admin/moderate/story-1\"\n+                      href=\"/admin/moderate/stories/story-1\"\n                       onClick={[Function]}\n                     >\n                       Moderate Story\n@@ -1607,14 +1631,18 @@ exports[`renders reported queue with comments and load more 1`] = `\n               </span>\n             </div>\n             <div\n-              className=\"ModerateCard-storyTitle\"\n+              className=\"ModerateCard-commentOn\"\n             >\n-              Finally a Cure for Cancer\n+              <span\n+                className=\"ModerateCard-storyTitle\"\n+              >\n+                Finally a Cure for Cancer\n+              </span>\n             </div>\n             <div>\n               <a\n                 className=\"TextLink-root ModerateCard-link\"\n-                href=\"/admin/moderate/story-1\"\n+                href=\"/admin/moderate/stories/story-1\"\n                 onClick={[Function]}\n               >\n                 Moderate Story"
    },
    {
      "sha": "84e6286ec99ca11a326e106a6a241960593cf19d",
      "filename": "src/core/client/admin/test/moderate/__snapshots__/rejectedQueue.spec.tsx.snap",
      "status": "modified",
      "additions": 28,
      "deletions": 12,
      "changes": 40,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/__snapshots__/rejectedQueue.spec.tsx.snap",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/__snapshots__/rejectedQueue.spec.tsx.snap",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/moderate/__snapshots__/rejectedQueue.spec.tsx.snap?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -134,14 +134,18 @@ exports[`approves comment in rejected queue: dangling 1`] = `\n               </span>\n             </div>\n             <div\n-              className=\"ModerateCard-storyTitle\"\n+              className=\"ModerateCard-commentOn\"\n             >\n-              Finally a Cure for Cancer\n+              <span\n+                className=\"ModerateCard-storyTitle\"\n+              >\n+                Finally a Cure for Cancer\n+              </span>\n             </div>\n             <div>\n               <a\n                 className=\"TextLink-root ModerateCard-link\"\n-                href=\"/admin/moderate/story-1\"\n+                href=\"/admin/moderate/stories/story-1\"\n                 onClick={[Function]}\n               >\n                 Moderate Story\n@@ -384,14 +388,18 @@ exports[`renders rejected queue with comments 1`] = `\n                     </span>\n                   </div>\n                   <div\n-                    className=\"ModerateCard-storyTitle\"\n+                    className=\"ModerateCard-commentOn\"\n                   >\n-                    Finally a Cure for Cancer\n+                    <span\n+                      className=\"ModerateCard-storyTitle\"\n+                    >\n+                      Finally a Cure for Cancer\n+                    </span>\n                   </div>\n                   <div>\n                     <a\n                       className=\"TextLink-root ModerateCard-link\"\n-                      href=\"/admin/moderate/story-1\"\n+                      href=\"/admin/moderate/stories/story-1\"\n                       onClick={[Function]}\n                     >\n                       Moderate Story\n@@ -621,14 +629,18 @@ exports[`renders rejected queue with comments 1`] = `\n                     </span>\n                   </div>\n                   <div\n-                    className=\"ModerateCard-storyTitle\"\n+                    className=\"ModerateCard-commentOn\"\n                   >\n-                    Finally a Cure for Cancer\n+                    <span\n+                      className=\"ModerateCard-storyTitle\"\n+                    >\n+                      Finally a Cure for Cancer\n+                    </span>\n                   </div>\n                   <div>\n                     <a\n                       className=\"TextLink-root ModerateCard-link\"\n-                      href=\"/admin/moderate/story-1\"\n+                      href=\"/admin/moderate/stories/story-1\"\n                       onClick={[Function]}\n                     >\n                       Moderate Story\n@@ -864,14 +876,18 @@ exports[`renders rejected queue with comments and load more 1`] = `\n               </span>\n             </div>\n             <div\n-              className=\"ModerateCard-storyTitle\"\n+              className=\"ModerateCard-commentOn\"\n             >\n-              Finally a Cure for Cancer\n+              <span\n+                className=\"ModerateCard-storyTitle\"\n+              >\n+                Finally a Cure for Cancer\n+              </span>\n             </div>\n             <div>\n               <a\n                 className=\"TextLink-root ModerateCard-link\"\n-                href=\"/admin/moderate/story-1\"\n+                href=\"/admin/moderate/stories/story-1\"\n                 onClick={[Function]}\n               >\n                 Moderate Story"
    },
    {
      "sha": "23afebaabfde8bb458c7eeb41d2452baac2df65f",
      "filename": "src/core/client/admin/test/moderate/feature.spec.tsx",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/feature.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/feature.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/moderate/feature.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -19,6 +19,8 @@ import {\n   emptyRejectedComments,\n   featuredComments,\n   settings,\n+  site,\n+  siteConnection,\n   unmoderatedComments,\n   users,\n } from \"../fixtures\";\n@@ -37,6 +39,8 @@ async function createTestRenderer(\n           viewer: () => viewer,\n           moderationQueues: () => emptyModerationQueues,\n           comments: () => emptyRejectedComments,\n+          site: () => site,\n+          sites: () => siteConnection,\n         },\n       }),\n       params.resolvers"
    },
    {
      "sha": "1b16a5d50112e4aefd298521f688b1442cdae01c",
      "filename": "src/core/client/admin/test/moderate/liveCounts.spec.tsx",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/liveCounts.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/liveCounts.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/moderate/liveCounts.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -20,6 +20,8 @@ import {\n   emptyRejectedComments,\n   reportedComments,\n   settings,\n+  site,\n+  siteConnection,\n   users,\n } from \"../fixtures\";\n \n@@ -41,6 +43,8 @@ async function createTestRenderer(\n           viewer: () => viewer,\n           moderationQueues: () => emptyModerationQueues,\n           comments: () => emptyRejectedComments,\n+          site: () => site,\n+          sites: () => siteConnection,\n         },\n       }),\n       params.resolvers"
    },
    {
      "sha": "332fdf17da9f141b5b0a7bca461269f513224f74",
      "filename": "src/core/client/admin/test/moderate/regularQueue.spec.tsx",
      "status": "modified",
      "additions": 5,
      "deletions": 1,
      "changes": 6,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/regularQueue.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/regularQueue.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/moderate/regularQueue.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -25,6 +25,8 @@ import {\n   emptyRejectedComments,\n   reportedComments,\n   settings,\n+  site,\n+  siteConnection,\n   users,\n } from \"../fixtures\";\n \n@@ -43,9 +45,11 @@ async function createTestRenderer(\n       createResolversStub<GQLResolver>({\n         Query: {\n           settings: () => settings,\n+          site: () => site,\n           viewer: () => viewer,\n           moderationQueues: () => emptyModerationQueues,\n           comments: () => emptyRejectedComments,\n+          sites: () => siteConnection,\n         },\n       }),\n       params.resolvers\n@@ -267,7 +271,7 @@ it(\"shows a moderate story\", async () => {\n     moderateStory.props.onClick({});\n     // Expect a routing request was made to the right url.\n     expect(transitionControl.history[0].pathname).toBe(\n-      `/admin/moderate/${reportedComments[0].story.id}`\n+      `/admin/moderate/stories/${reportedComments[0].story.id}`\n     );\n   });\n });"
    },
    {
      "sha": "2f1c3d706e8057bfb250e60c9c2fa0a9a8b8e7ce",
      "filename": "src/core/client/admin/test/moderate/regularQueueLiveNewComments.spec.tsx",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/regularQueueLiveNewComments.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/regularQueueLiveNewComments.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/moderate/regularQueueLiveNewComments.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -20,6 +20,8 @@ import {\n   emptyRejectedComments,\n   reportedComments,\n   settings,\n+  site,\n+  siteConnection,\n   users,\n } from \"../fixtures\";\n \n@@ -38,6 +40,8 @@ async function createTestRenderer(\n           viewer: () => viewer,\n           moderationQueues: () => emptyModerationQueues,\n           comments: () => emptyRejectedComments,\n+          sites: () => siteConnection,\n+          site: () => site,\n         },\n       }),\n       params.resolvers"
    },
    {
      "sha": "ae329f243d7c51a747df55e2e993519cc69e6d5f",
      "filename": "src/core/client/admin/test/moderate/regularQueueLiveStatus.spec.tsx",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/regularQueueLiveStatus.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/regularQueueLiveStatus.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/moderate/regularQueueLiveStatus.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -21,6 +21,8 @@ import {\n   emptyRejectedComments,\n   reportedComments,\n   settings,\n+  site,\n+  siteConnection,\n   users,\n } from \"../fixtures\";\n \n@@ -38,6 +40,8 @@ async function createTestRenderer(\n         Query: {\n           settings: () => settings,\n           viewer: () => viewer,\n+          sites: () => siteConnection,\n+          site: () => site,\n           moderationQueues: () =>\n             pureMerge(emptyModerationQueues, {\n               reported: {"
    },
    {
      "sha": "9ee42091e56b30d5a1ae9b18d17bd1b7f7a1d70e",
      "filename": "src/core/client/admin/test/moderate/rejectedQueue.spec.tsx",
      "status": "modified",
      "additions": 5,
      "deletions": 1,
      "changes": 6,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/rejectedQueue.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/rejectedQueue.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/moderate/rejectedQueue.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -22,6 +22,8 @@ import {\n   rejectedComments,\n   reportedComments,\n   settings,\n+  site,\n+  siteConnection,\n   users,\n } from \"../fixtures\";\n \n@@ -43,6 +45,8 @@ async function createTestRenderer(\n           viewer: () => viewer,\n           moderationQueues: () => emptyModerationQueues,\n           comments: () => emptyRejectedComments,\n+          site: () => site,\n+          sites: () => siteConnection,\n         },\n       }),\n       params.resolvers\n@@ -136,7 +140,7 @@ it(\"shows a moderate story\", async () => {\n   moderateStory.props.onClick({});\n   // Expect a routing request was made to the right url.\n   expect(transitionControl.history[0].pathname).toBe(\n-    `/admin/moderate/${reportedComments[0].story.id}`\n+    `/admin/moderate/stories/${reportedComments[0].story.id}`\n   );\n });\n "
    },
    {
      "sha": "98b56888cc8abe338ed0503b95c5ed1301d9ed64",
      "filename": "src/core/client/admin/test/moderate/searchBar.spec.tsx",
      "status": "modified",
      "additions": 8,
      "deletions": 2,
      "changes": 10,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/searchBar.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/searchBar.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/moderate/searchBar.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -20,6 +20,8 @@ import {\n   emptyRejectedComments,\n   emptyStories,\n   settings,\n+  site,\n+  siteConnection,\n   stories,\n   storyConnection,\n   users,\n@@ -43,6 +45,8 @@ async function createTestRenderer(\n           viewer: () => viewer,\n           moderationQueues: () => emptyModerationQueues,\n           comments: () => emptyRejectedComments,\n+          site: () => site,\n+          sites: () => siteConnection,\n         },\n       }),\n       params.resolvers\n@@ -165,7 +169,7 @@ describe(\"all stories\", () => {\n \n       // Expect a routing request was made to the right url.\n       expect(transitionControl.history[0].pathname).toBe(\n-        `/admin/moderate/${story.id}`\n+        `/admin/moderate/stories/${story.id}`\n       );\n     });\n     it(\"search with too many results\", async () => {\n@@ -216,7 +220,9 @@ describe(\"all stories\", () => {\n });\n describe(\"specified story\", () => {\n   beforeEach(() => {\n-    replaceHistoryLocation(`http://localhost/admin/moderate/${stories[0].id}`);\n+    replaceHistoryLocation(\n+      `http://localhost/admin/moderate/stories/${stories[0].id}`\n+    );\n   });\n   it(\"renders search bar\", async () => {\n     await act(async () => {"
    },
    {
      "sha": "c860cff2b18b836b4ee235dbfa82532cfba636a0",
      "filename": "src/core/client/admin/test/moderate/tabBar.spec.tsx",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/tabBar.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/moderate/tabBar.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/moderate/tabBar.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -15,6 +15,7 @@ import {\n   emptyModerationQueues,\n   emptyRejectedComments,\n   settings,\n+  siteConnection,\n   users,\n } from \"../fixtures\";\n \n@@ -35,6 +36,7 @@ async function createTestRenderer(\n           settings: () => settings,\n           viewer: () => viewer,\n           moderationQueues: () => emptyModerationQueues,\n+          sites: () => siteConnection,\n           comments: () => emptyRejectedComments,\n         },\n       }),"
    },
    {
      "sha": "bb67e420c86403fde9ac5e8e108f4c611f730b3f",
      "filename": "src/core/client/admin/test/stories/__snapshots__/stories.spec.tsx.snap",
      "status": "modified",
      "additions": 196,
      "deletions": 188,
      "changes": 384,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/stories/__snapshots__/stories.spec.tsx.snap",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/stories/__snapshots__/stories.spec.tsx.snap",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/stories/__snapshots__/stories.spec.tsx.snap?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -11,115 +11,119 @@ exports[`renders empty stories 1`] = `\n     <div\n       className=\"Box-root Flex-root Flex-flex Flex-doubleItemGutter gutter\"\n     >\n-      <fieldset\n-        className=\"FieldSet-root\"\n+      <div\n+        className=\"Box-root Flex-root Flex-flex Flex-doubleItemGutter gutter\"\n       >\n-        <div\n-          className=\"Box-root HorizontalGutter-root HorizontalGutter-spacing-2\"\n+        <fieldset\n+          className=\"FieldSet-root\"\n         >\n-          <label\n-            className=\"Label-root\"\n+          <div\n+            className=\"Box-root HorizontalGutter-root HorizontalGutter-spacing-2\"\n           >\n-            Search\n-          </label>\n-          <form\n-            autoComplete=\"off\"\n-            id=\"configure-form\"\n-            onSubmit={[Function]}\n-          >\n-            <div\n-              className=\"TextField-root StoryTableFilter-textField\"\n+            <label\n+              className=\"Label-root\"\n+            >\n+              Search\n+            </label>\n+            <form\n+              autoComplete=\"off\"\n+              id=\"configure-form\"\n+              onSubmit={[Function]}\n             >\n-              <input\n-                aria-label=\"Search by story title or author\"\n-                className=\"TextField-input TextField-colorDark TextField-seamlessAdornment\"\n-                name=\"search\"\n-                onBlur={[Function]}\n-                onChange={[Function]}\n-                onFocus={[Function]}\n-                placeholder=\"Search by story title or author...\"\n-                type=\"text\"\n-                value=\"\"\n-              />\n               <div\n-                className=\"TextField-adornment\"\n+                className=\"TextField-root StoryTableFilter-textField\"\n               >\n-                <button\n-                  aria-label=\"Search\"\n-                  className=\"BaseButton-root Button-root Button-sizeRegular Button-colorDark Button-variantRegular Button-uppercase Button-adornmentRight StoryTableFilter-adornment\"\n-                  data-color=\"dark\"\n-                  data-variant=\"regular\"\n+                <input\n+                  aria-label=\"Search by story title or author\"\n+                  className=\"TextField-input TextField-colorDark TextField-seamlessAdornment\"\n+                  name=\"search\"\n                   onBlur={[Function]}\n+                  onChange={[Function]}\n                   onFocus={[Function]}\n-                  onMouseOut={[Function]}\n-                  onMouseOver={[Function]}\n-                  onTouchEnd={[Function]}\n-                  type=\"submit\"\n+                  placeholder=\"Search by story title or author...\"\n+                  type=\"text\"\n+                  value=\"\"\n+                />\n+                <div\n+                  className=\"TextField-adornment\"\n                 >\n-                  <i\n-                    aria-hidden=\"true\"\n-                    className=\"Icon-root Icon-md\"\n+                  <button\n+                    aria-label=\"Search\"\n+                    className=\"BaseButton-root Button-root Button-sizeRegular Button-colorDark Button-variantRegular Button-uppercase Button-adornmentRight StoryTableFilter-adornment\"\n+                    data-color=\"dark\"\n+                    data-variant=\"regular\"\n+                    onBlur={[Function]}\n+                    onFocus={[Function]}\n+                    onMouseOut={[Function]}\n+                    onMouseOver={[Function]}\n+                    onTouchEnd={[Function]}\n+                    type=\"submit\"\n                   >\n-                    search\n-                  </i>\n-                </button>\n+                    <i\n+                      aria-hidden=\"true\"\n+                      className=\"Icon-root Icon-md\"\n+                    >\n+                      search\n+                    </i>\n+                  </button>\n+                </div>\n               </div>\n-            </div>\n-          </form>\n-        </div>\n-      </fieldset>\n-      <fieldset\n-        className=\"FieldSet-root\"\n-      >\n-        <div\n-          className=\"Box-root HorizontalGutter-root HorizontalGutter-spacing-2\"\n+            </form>\n+          </div>\n+        </fieldset>\n+        <fieldset\n+          className=\"FieldSet-root\"\n         >\n-          <label\n-            className=\"Label-root\"\n-          >\n-            Show Me\n-          </label>\n-          <span\n-            className=\"SelectField-root\"\n+          <div\n+            className=\"Box-root HorizontalGutter-root HorizontalGutter-spacing-2\"\n           >\n-            <select\n-              aria-label=\"Search by status\"\n-              className=\"SelectField-select\"\n-              onBlur={[Function]}\n-              onChange={[Function]}\n-              onFocus={[Function]}\n-              value=\"\"\n-            >\n-              <option\n-                value=\"\"\n-              >\n-                All Stories\n-              </option>\n-              <option\n-                value=\"OPEN\"\n-              >\n-                Open Stories\n-              </option>\n-              <option\n-                value=\"CLOSED\"\n-              >\n-                Closed Stories\n-              </option>\n-            </select>\n+            <label\n+              className=\"Label-root\"\n+            >\n+              Status\n+            </label>\n             <span\n-              aria-hidden={true}\n-              className=\"SelectField-afterWrapper\"\n+              className=\"SelectField-root\"\n             >\n-              <i\n-                aria-hidden=\"true\"\n-                className=\"Icon-root Icon-sm\"\n+              <select\n+                aria-label=\"Search by status\"\n+                className=\"SelectField-select\"\n+                onBlur={[Function]}\n+                onChange={[Function]}\n+                onFocus={[Function]}\n+                value=\"\"\n+              >\n+                <option\n+                  value=\"\"\n+                >\n+                  All Stories\n+                </option>\n+                <option\n+                  value=\"OPEN\"\n+                >\n+                  Open Stories\n+                </option>\n+                <option\n+                  value=\"CLOSED\"\n+                >\n+                  Closed Stories\n+                </option>\n+              </select>\n+              <span\n+                aria-hidden={true}\n+                className=\"SelectField-afterWrapper\"\n               >\n-                expand_more\n-              </i>\n+                <i\n+                  aria-hidden=\"true\"\n+                  className=\"Icon-root Icon-sm\"\n+                >\n+                  expand_more\n+                </i>\n+              </span>\n             </span>\n-          </span>\n-        </div>\n-      </fieldset>\n+          </div>\n+        </fieldset>\n+      </div>\n     </div>\n     <div\n       className=\"Box-root HorizontalGutter-root HorizontalGutter-double\"\n@@ -178,7 +182,7 @@ exports[`renders empty stories 1`] = `\n             >\n               <a\n                 className=\"TextLink-root\"\n-                href=\"/admin/moderate/story-1\"\n+                href=\"/admin/moderate/stories/story-1\"\n                 onClick={[Function]}\n               >\n                 Finally a Cure for Cancer\n@@ -249,7 +253,7 @@ exports[`renders empty stories 1`] = `\n             >\n               <a\n                 className=\"TextLink-root\"\n-                href=\"/admin/moderate/story-2\"\n+                href=\"/admin/moderate/stories/story-2\"\n                 onClick={[Function]}\n               >\n                 First Colony on Mars\n@@ -330,115 +334,119 @@ exports[`renders stories 1`] = `\n     <div\n       className=\"Box-root Flex-root Flex-flex Flex-doubleItemGutter gutter\"\n     >\n-      <fieldset\n-        className=\"FieldSet-root\"\n+      <div\n+        className=\"Box-root Flex-root Flex-flex Flex-doubleItemGutter gutter\"\n       >\n-        <div\n-          className=\"Box-root HorizontalGutter-root HorizontalGutter-spacing-2\"\n+        <fieldset\n+          className=\"FieldSet-root\"\n         >\n-          <label\n-            className=\"Label-root\"\n+          <div\n+            className=\"Box-root HorizontalGutter-root HorizontalGutter-spacing-2\"\n           >\n-            Search\n-          </label>\n-          <form\n-            autoComplete=\"off\"\n-            id=\"configure-form\"\n-            onSubmit={[Function]}\n-          >\n-            <div\n-              className=\"TextField-root StoryTableFilter-textField\"\n+            <label\n+              className=\"Label-root\"\n+            >\n+              Search\n+            </label>\n+            <form\n+              autoComplete=\"off\"\n+              id=\"configure-form\"\n+              onSubmit={[Function]}\n             >\n-              <input\n-                aria-label=\"Search by story title or author\"\n-                className=\"TextField-input TextField-colorDark TextField-seamlessAdornment\"\n-                name=\"search\"\n-                onBlur={[Function]}\n-                onChange={[Function]}\n-                onFocus={[Function]}\n-                placeholder=\"Search by story title or author...\"\n-                type=\"text\"\n-                value=\"\"\n-              />\n               <div\n-                className=\"TextField-adornment\"\n+                className=\"TextField-root StoryTableFilter-textField\"\n               >\n-                <button\n-                  aria-label=\"Search\"\n-                  className=\"BaseButton-root Button-root Button-sizeRegular Button-colorDark Button-variantRegular Button-uppercase Button-adornmentRight StoryTableFilter-adornment\"\n-                  data-color=\"dark\"\n-                  data-variant=\"regular\"\n+                <input\n+                  aria-label=\"Search by story title or author\"\n+                  className=\"TextField-input TextField-colorDark TextField-seamlessAdornment\"\n+                  name=\"search\"\n                   onBlur={[Function]}\n+                  onChange={[Function]}\n                   onFocus={[Function]}\n-                  onMouseOut={[Function]}\n-                  onMouseOver={[Function]}\n-                  onTouchEnd={[Function]}\n-                  type=\"submit\"\n+                  placeholder=\"Search by story title or author...\"\n+                  type=\"text\"\n+                  value=\"\"\n+                />\n+                <div\n+                  className=\"TextField-adornment\"\n                 >\n-                  <i\n-                    aria-hidden=\"true\"\n-                    className=\"Icon-root Icon-md\"\n+                  <button\n+                    aria-label=\"Search\"\n+                    className=\"BaseButton-root Button-root Button-sizeRegular Button-colorDark Button-variantRegular Button-uppercase Button-adornmentRight StoryTableFilter-adornment\"\n+                    data-color=\"dark\"\n+                    data-variant=\"regular\"\n+                    onBlur={[Function]}\n+                    onFocus={[Function]}\n+                    onMouseOut={[Function]}\n+                    onMouseOver={[Function]}\n+                    onTouchEnd={[Function]}\n+                    type=\"submit\"\n                   >\n-                    search\n-                  </i>\n-                </button>\n+                    <i\n+                      aria-hidden=\"true\"\n+                      className=\"Icon-root Icon-md\"\n+                    >\n+                      search\n+                    </i>\n+                  </button>\n+                </div>\n               </div>\n-            </div>\n-          </form>\n-        </div>\n-      </fieldset>\n-      <fieldset\n-        className=\"FieldSet-root\"\n-      >\n-        <div\n-          className=\"Box-root HorizontalGutter-root HorizontalGutter-spacing-2\"\n+            </form>\n+          </div>\n+        </fieldset>\n+        <fieldset\n+          className=\"FieldSet-root\"\n         >\n-          <label\n-            className=\"Label-root\"\n-          >\n-            Show Me\n-          </label>\n-          <span\n-            className=\"SelectField-root\"\n+          <div\n+            className=\"Box-root HorizontalGutter-root HorizontalGutter-spacing-2\"\n           >\n-            <select\n-              aria-label=\"Search by status\"\n-              className=\"SelectField-select\"\n-              onBlur={[Function]}\n-              onChange={[Function]}\n-              onFocus={[Function]}\n-              value=\"\"\n-            >\n-              <option\n-                value=\"\"\n-              >\n-                All Stories\n-              </option>\n-              <option\n-                value=\"OPEN\"\n-              >\n-                Open Stories\n-              </option>\n-              <option\n-                value=\"CLOSED\"\n-              >\n-                Closed Stories\n-              </option>\n-            </select>\n+            <label\n+              className=\"Label-root\"\n+            >\n+              Status\n+            </label>\n             <span\n-              aria-hidden={true}\n-              className=\"SelectField-afterWrapper\"\n+              className=\"SelectField-root\"\n             >\n-              <i\n-                aria-hidden=\"true\"\n-                className=\"Icon-root Icon-sm\"\n+              <select\n+                aria-label=\"Search by status\"\n+                className=\"SelectField-select\"\n+                onBlur={[Function]}\n+                onChange={[Function]}\n+                onFocus={[Function]}\n+                value=\"\"\n+              >\n+                <option\n+                  value=\"\"\n+                >\n+                  All Stories\n+                </option>\n+                <option\n+                  value=\"OPEN\"\n+                >\n+                  Open Stories\n+                </option>\n+                <option\n+                  value=\"CLOSED\"\n+                >\n+                  Closed Stories\n+                </option>\n+              </select>\n+              <span\n+                aria-hidden={true}\n+                className=\"SelectField-afterWrapper\"\n               >\n-                expand_more\n-              </i>\n+                <i\n+                  aria-hidden=\"true\"\n+                  className=\"Icon-root Icon-sm\"\n+                >\n+                  expand_more\n+                </i>\n+              </span>\n             </span>\n-          </span>\n-        </div>\n-      </fieldset>\n+          </div>\n+        </fieldset>\n+      </div>\n     </div>\n     <div\n       className=\"Box-root HorizontalGutter-root HorizontalGutter-double\"\n@@ -497,7 +505,7 @@ exports[`renders stories 1`] = `\n             >\n               <a\n                 className=\"TextLink-root\"\n-                href=\"/admin/moderate/story-1\"\n+                href=\"/admin/moderate/stories/story-1\"\n                 onClick={[Function]}\n               >\n                 Finally a Cure for Cancer\n@@ -568,7 +576,7 @@ exports[`renders stories 1`] = `\n             >\n               <a\n                 className=\"TextLink-root\"\n-                href=\"/admin/moderate/story-2\"\n+                href=\"/admin/moderate/stories/story-2\"\n                 onClick={[Function]}\n               >\n                 First Colony on Mars"
    },
    {
      "sha": "5519e5a9d3ee1cbd4556c4bb1d8cf25ef15a4593",
      "filename": "src/core/client/admin/test/stories/stories.spec.tsx",
      "status": "modified",
      "additions": 5,
      "deletions": 1,
      "changes": 6,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/stories/stories.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/admin/test/stories/stories.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/stories/stories.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -24,6 +24,8 @@ import create from \"../create\";\n import {\n   emptyStories,\n   settings,\n+  site,\n+  siteConnection,\n   stories,\n   storyConnection,\n   users,\n@@ -45,6 +47,8 @@ async function createTestRenderer(\n         Query: {\n           settings: () => settings,\n           viewer: () => viewer,\n+          site: () => site,\n+          sites: () => siteConnection,\n           stories: ({ variables }) => {\n             expectAndFail(variables.status).toBeFalsy();\n             return storyConnection;\n@@ -114,7 +118,7 @@ it(\"goes to moderation when clicking on title\", async () => {\n   await act(async () => {\n     await wait(() => {\n       expect(transitionControl.history[0].pathname).toBe(\n-        `/admin/moderate/${story.id}`\n+        `/admin/moderate/stories/${story.id}`\n       );\n     });\n   });"
    },
    {
      "sha": "5d5dbf833aabb4810aa5ddf524712ec627caa24c",
      "filename": "src/core/client/embed/index.html",
      "status": "modified",
      "additions": 12,
      "deletions": 10,
      "changes": 22,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/embed/index.html",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/embed/index.html",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/embed/index.html?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -23,17 +23,19 @@ <h1 style=\"text-align: center\">Coral 5.0 – Embed Stream</h1>\n     <script>\n       const CoralStreamEmbed = Coral.createStreamEmbed({\n         id: \"coralStreamEmbed\",\n+\n         /**\n-        *  You can listen to events using the example below.\n-        *  The argument passed is the event emitter from\n-        *  https://github.com/asyncly/EventEmitter2\n-        *\n-        *  events: function(events) {\n-        *    events.onAny(function(eventName, data) {\n-        *      console.log(eventName, data);\n-        *    });\n-        *  },\n-        */\n+         *\n+         *  You can listen to events using the example below.\n+         *  The argument passed is the event emitter from\n+         *  https://github.com/asyncly/EventEmitter2\n+         *\n+         *  events: function(events) {\n+         *    events.onAny(function(eventName, data) {\n+         *      console.log(eventName, data);\n+         *    });\n+         *  },\n+         */\n       });\n       window.CoralStreamEmbed = CoralStreamEmbed;\n       CoralStreamEmbed.render();"
    },
    {
      "sha": "84af3d325cc05d976ae04f29960108b3e6e6fe9c",
      "filename": "src/core/client/framework/helpers/getModerationLink.spec.ts",
      "status": "added",
      "additions": 46,
      "deletions": 0,
      "changes": 46,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/framework/helpers/getModerationLink.spec.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/framework/helpers/getModerationLink.spec.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/framework/helpers/getModerationLink.spec.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,46 @@\n+import getModerationLink from \"./getModerationLink\";\n+\n+describe(\"getModerationLink\", () => {\n+  it(\"renders the default\", () => {\n+    expect(getModerationLink()).toMatchInlineSnapshot(`\"/admin/moderate\"`);\n+  });\n+  it(\"renders with a specific queue\", () => {\n+    expect(getModerationLink({ queue: \"pending\" })).toMatchInlineSnapshot(\n+      `\"/admin/moderate/pending\"`\n+    );\n+  });\n+  it(\"renders with a specific story\", () => {\n+    expect(getModerationLink({ storyID: \"story_123\" })).toMatchInlineSnapshot(\n+      `\"/admin/moderate/stories/story_123\"`\n+    );\n+  });\n+  it(\"renders with a specific story\", () => {\n+    expect(getModerationLink({ siteID: \"site_123\" })).toMatchInlineSnapshot(\n+      `\"/admin/moderate/sites/site_123\"`\n+    );\n+  });\n+  it(\"renders with only one story or site\", () => {\n+    expect(\n+      getModerationLink({ storyID: \"story_123\", siteID: \"site_123\" })\n+    ).toMatchInlineSnapshot(`\"/admin/moderate/stories/story_123\"`);\n+  });\n+  it(\"renders with a specific story with a queue\", () => {\n+    expect(\n+      getModerationLink({ queue: \"pending\", storyID: \"story_123\" })\n+    ).toMatchInlineSnapshot(`\"/admin/moderate/pending/stories/story_123\"`);\n+  });\n+  it(\"renders with a specific story with a queue\", () => {\n+    expect(\n+      getModerationLink({ queue: \"pending\", siteID: \"site_123\" })\n+    ).toMatchInlineSnapshot(`\"/admin/moderate/pending/sites/site_123\"`);\n+  });\n+  it(\"renders with only one story or site with a queue\", () => {\n+    expect(\n+      getModerationLink({\n+        queue: \"pending\",\n+        storyID: \"story_123\",\n+        siteID: \"site_123\",\n+      })\n+    ).toMatchInlineSnapshot(`\"/admin/moderate/pending/stories/story_123\"`);\n+  });\n+});"
    },
    {
      "sha": "240b278114ee18945388764f6f12f7b235ba0615",
      "filename": "src/core/client/framework/helpers/getModerationLink.ts",
      "status": "added",
      "additions": 31,
      "deletions": 0,
      "changes": 31,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/framework/helpers/getModerationLink.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/framework/helpers/getModerationLink.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/framework/helpers/getModerationLink.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,31 @@\n+import urls from \"./urls\";\n+\n+export type QUEUE_NAME = \"reported\" | \"pending\" | \"unmoderated\" | \"rejected\";\n+\n+interface Options {\n+  queue?: QUEUE_NAME;\n+  storyID?: string | null;\n+  siteID?: string | null;\n+}\n+\n+export default function getModerationLink({\n+  queue,\n+  storyID,\n+  siteID,\n+}: Options = {}) {\n+  const parts = [urls.admin.moderate];\n+\n+  // Add the queue.\n+  if (queue) {\n+    parts.push(queue);\n+  }\n+\n+  // Add the storyID.\n+  if (storyID) {\n+    parts.push(\"stories\", encodeURIComponent(storyID));\n+  } else if (siteID) {\n+    parts.push(\"sites\", encodeURIComponent(siteID));\n+  }\n+\n+  return parts.join(\"/\");\n+}"
    },
    {
      "sha": "9be8f6f8b3478e6c4723238f1fa728e8fd8a6121",
      "filename": "src/core/client/framework/helpers/index.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/framework/helpers/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/framework/helpers/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/framework/helpers/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -17,3 +17,4 @@ export {\n   default as injectConditionalPolyfills,\n } from \"./injectConditionalPolyfills\";\n export { default as polyfillCSSVarsForIE11 } from \"./polyfillCSSVarsForIE11\";\n+export { default as getModerationLink, QUEUE_NAME } from \"./getModerationLink\";"
    },
    {
      "sha": "05d6f188d9b918713aca35fa0ae42ad352d455db",
      "filename": "src/core/client/framework/helpers/urls.tsx",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/framework/helpers/urls.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/framework/helpers/urls.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/framework/helpers/urls.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,6 +1,6 @@\n export default {\n   admin: {\n-    moderateReported: \"/admin/moderate/reported\",\n+    moderate: \"/admin/moderate\",\n   },\n   embed: {\n     stream: \"/embed/stream\","
    },
    {
      "sha": "1f77da3aacfea95463e053956e807bcf0fc8ffcc",
      "filename": "src/core/client/framework/lib/bootstrap/CoralContext.tsx",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/framework/lib/bootstrap/CoralContext.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/framework/lib/bootstrap/CoralContext.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/framework/lib/bootstrap/CoralContext.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -105,6 +105,7 @@ export const CoralContextProvider: FunctionComponent<{\n           timeagoFormatter: value.timeagoFormatter,\n           registerClickFarAway: value.registerClickFarAway,\n           mediaQueryValues: value.mediaQueryValues,\n+          locales: value.locales,\n         }}\n       >\n         {children}"
    },
    {
      "sha": "137216fcb8bf8c47d9e2e0bfa55218ac166af4d0",
      "filename": "src/core/client/framework/lib/bootstrap/withContext.tsx",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/framework/lib/bootstrap/withContext.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/framework/lib/bootstrap/withContext.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/framework/lib/bootstrap/withContext.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,4 +1,4 @@\n-import { createContextHOC } from \"coral-framework/helpers\";\n+import createContextHOC from \"coral-framework/helpers/createContextHOC\";\n \n import { CoralContext, CoralContextConsumer } from \"./CoralContext\";\n "
    },
    {
      "sha": "024e1447451c5cc9ed34d30b49f703d97a116e1a",
      "filename": "src/core/client/framework/lib/relay/withLocalStateContainer.tsx",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/framework/lib/relay/withLocalStateContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/framework/lib/relay/withLocalStateContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/framework/lib/relay/withLocalStateContainer.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -14,7 +14,7 @@ import {\n   Snapshot,\n } from \"relay-runtime\";\n \n-import { withContext } from \"../bootstrap\";\n+import withContext from \"../bootstrap/withContext\";\n import { LOCAL_ID, LOCAL_TYPE } from \"./localState\";\n \n interface Props {"
    },
    {
      "sha": "7f03377fc8a944149783099132849b8c3c6b422f",
      "filename": "src/core/client/framework/rest/install.ts",
      "status": "modified",
      "additions": 6,
      "deletions": 1,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/framework/rest/install.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/framework/rest/install.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/framework/rest/install.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -9,9 +9,14 @@ export interface InstallInput {\n       contactEmail: string;\n       url: string;\n     };\n-    allowedDomains: string[];\n     locale: LanguageCode;\n   };\n+  site: {\n+    name: string;\n+    contactEmail: string;\n+    url: string;\n+    allowedOrigins: string[];\n+  };\n   user: {\n     username: string;\n     password: string;"
    },
    {
      "sha": "8834703efcbc3cf44dcb0bb0c92527fbb4e2e8f1",
      "filename": "src/core/client/install/App/Header.tsx",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/install/App/Header.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/install/App/Header.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/install/App/Header.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -23,7 +23,7 @@ const Header: FunctionComponent<HeaderProps> = ({ main }) => {\n           [styles.headlineMain]: main,\n         })}\n       >\n-        The Coral Project\n+        Coral by Vox Media\n       </Typography>\n       <Localized id=\"install-header-title\">\n         <Typography"
    },
    {
      "sha": "b12435526a344e94d6c19d0bd73d9861e4745a3e",
      "filename": "src/core/client/install/App/InstallWizard.tsx",
      "status": "modified",
      "additions": 20,
      "deletions": 12,
      "changes": 32,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/install/App/InstallWizard.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/install/App/InstallWizard.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/install/App/InstallWizard.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -14,13 +14,14 @@ import Wizard from \"./Wizard\";\n \n interface FormData {\n   organizationName: string;\n-  organizationContactEmail: string;\n-  organizationURL: string;\n+  siteName: string;\n+  siteContactEmail: string;\n+  siteURL: string;\n   email: string;\n   username: string;\n   password: string;\n   confirmPassword: string;\n-  allowedDomains: string[];\n+  allowedOrigins: string[];\n   locale: LanguageCode;\n }\n \n@@ -32,9 +33,10 @@ interface InstallWizardState {\n function shapeFinalData(data: FormData): InstallInput {\n   const {\n     organizationName,\n-    organizationContactEmail,\n-    organizationURL,\n-    allowedDomains,\n+    siteName,\n+    siteContactEmail,\n+    siteURL,\n+    allowedOrigins,\n     username,\n     password,\n     email,\n@@ -45,12 +47,17 @@ function shapeFinalData(data: FormData): InstallInput {\n     tenant: {\n       organization: {\n         name: organizationName,\n-        contactEmail: organizationContactEmail,\n-        url: organizationURL,\n+        contactEmail: siteContactEmail,\n+        url: siteURL,\n       },\n-      allowedDomains,\n       locale,\n     },\n+    site: {\n+      name: siteName,\n+      contactEmail: siteContactEmail,\n+      url: siteURL,\n+      allowedOrigins,\n+    },\n     user: {\n       username,\n       password,\n@@ -67,14 +74,15 @@ class InstallWizard extends Component<Props, InstallWizardState> {\n   public state = {\n     step: 0,\n     data: {\n-      organizationContactEmail: \"\",\n       organizationName: \"\",\n-      organizationURL: \"\",\n+      siteContactEmail: \"\",\n+      siteName: \"\",\n+      siteURL: \"\",\n       email: \"\",\n       username: \"\",\n       password: \"\",\n       confirmPassword: \"\",\n-      allowedDomains: [],\n+      allowedOrigins: [],\n       locale: \"en-US\" as LanguageCode,\n     },\n   };"
    },
    {
      "sha": "1a86247688fa5ce447b515d47ba47fcd4ee9710c",
      "filename": "src/core/client/install/App/steps/AddOrganizationStep.tsx",
      "status": "modified",
      "additions": 47,
      "deletions": 14,
      "changes": 61,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/install/App/steps/AddOrganizationStep.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/install/App/steps/AddOrganizationStep.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/install/App/steps/AddOrganizationStep.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -36,8 +36,9 @@ interface Props {\n \n interface FormProps {\n   organizationName: string;\n-  organizationContactEmail: string;\n-  organizationURL: string;\n+  siteName: string;\n+  siteContactEmail: string;\n+  siteURL: string;\n }\n \n class AddOrganizationStep extends React.Component<Props> {\n@@ -51,8 +52,9 @@ class AddOrganizationStep extends React.Component<Props> {\n         onSubmit={this.onSubmit}\n         initialValues={{\n           organizationName: this.props.data.organizationName,\n-          organizationContactEmail: this.props.data.organizationContactEmail,\n-          organizationURL: this.props.data.organizationURL,\n+          siteName: this.props.data.organizationName,\n+          siteContactEmail: this.props.data.siteContactEmail,\n+          siteURL: this.props.data.siteURL,\n         }}\n       >\n         {({ handleSubmit, submitting, submitError }) => (\n@@ -84,7 +86,7 @@ class AddOrganizationStep extends React.Component<Props> {\n                   <FormField>\n                     <Localized id=\"install-addOrganization-orgName\">\n                       <InputLabel container={<label htmlFor={input.name} />}>\n-                        Organization Name\n+                        Organization name\n                       </InputLabel>\n                     </Localized>\n                     <Localized\n@@ -106,24 +108,24 @@ class AddOrganizationStep extends React.Component<Props> {\n               </Field>\n \n               <Field\n-                name=\"organizationContactEmail\"\n+                name=\"siteContactEmail\"\n                 validate={composeValidators(required, validateEmail)}\n               >\n                 {({ input, meta }) => (\n                   <FormField>\n-                    <Localized id=\"install-addOrganization-orgEmail\">\n+                    <Localized id=\"install-addSite-siteEmail\">\n                       <InputLabel container={<label htmlFor={input.name} />}>\n-                        Organization Contact Email\n+                        Contact email\n                       </InputLabel>\n                     </Localized>\n                     <Localized\n-                      id=\"install-addOrganization-orgEmailTextField\"\n+                      id=\"install-addSite-siteEmailTextField\"\n                       attrs={{ placeholder: true }}\n                     >\n                       <TextField\n                         {...input}\n                         id={input.name}\n-                        placeholder=\"Organization Contact Email\"\n+                        placeholder=\"Contact Email\"\n                         color={colorFromMeta(meta)}\n                         disabled={submitting}\n                         type=\"email\"\n@@ -138,18 +140,18 @@ class AddOrganizationStep extends React.Component<Props> {\n               </Field>\n \n               <Field\n-                name=\"organizationURL\"\n+                name=\"siteURL\"\n                 validate={composeValidators(required, validateURL)}\n               >\n                 {({ input, meta }) => (\n                   <FormField>\n-                    <Localized id=\"install-addOrganization-orgURL\">\n+                    <Localized id=\"install-addSite-siteURL\">\n                       <InputLabel container={<label htmlFor={input.name} />}>\n                         Organization URL\n                       </InputLabel>\n                     </Localized>\n                     <Localized\n-                      id=\"install-addOrganization-orgURLDescription\"\n+                      id=\"install-addSite-siteURLDescription\"\n                       strong={<strong />}\n                     >\n                       <InputDescription>\n@@ -159,7 +161,7 @@ class AddOrganizationStep extends React.Component<Props> {\n                       </InputDescription>\n                     </Localized>\n                     <Localized\n-                      id=\"install-addOrganization-orgURLTextField\"\n+                      id=\"install-addSite-siteURLTextField\"\n                       attrs={{ placeholder: true }}\n                     >\n                       <TextField\n@@ -175,6 +177,37 @@ class AddOrganizationStep extends React.Component<Props> {\n                   </FormField>\n                 )}\n               </Field>\n+              <Field name=\"siteName\" validate={composeValidators(required)}>\n+                {({ input, meta }) => (\n+                  <FormField>\n+                    <Localized id=\"install-addSite-siteName\">\n+                      <InputLabel container={<label htmlFor={input.name} />}>\n+                        Site name\n+                      </InputLabel>\n+                    </Localized>\n+                    <Localized id=\"install-addSite-siteNameDescription\">\n+                      <InputDescription>\n+                        Site name will appear on emails sent by Coral to your\n+                        community and organization members.\n+                      </InputDescription>\n+                    </Localized>\n+                    <Localized\n+                      id=\"install-addSite-siteNameTextField\"\n+                      attrs={{ placeholder: true }}\n+                    >\n+                      <TextField\n+                        {...input}\n+                        id={input.name}\n+                        color={colorFromMeta(meta)}\n+                        disabled={submitting}\n+                        fullWidth\n+                      />\n+                    </Localized>\n+                    <ValidationMessage meta={meta} fullWidth />\n+                  </FormField>\n+                )}\n+              </Field>\n+\n               <Flex direction=\"row-reverse\" itemGutter>\n                 <NextButton submitting={submitting} />\n                 <BackButton"
    },
    {
      "sha": "849315f1d3b7b1e662884105d37b1a6925880244",
      "filename": "src/core/client/install/App/steps/CreateYourAccountStep.tsx",
      "status": "modified",
      "additions": 3,
      "deletions": 3,
      "changes": 6,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/install/App/steps/CreateYourAccountStep.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/install/App/steps/CreateYourAccountStep.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/install/App/steps/CreateYourAccountStep.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -62,7 +62,7 @@ class CreateYourAccountStep extends Component<Props> {\n             <HorizontalGutter size=\"double\">\n               <Localized id=\"install-createYourAccount-title\">\n                 <Typography variant=\"heading1\" align=\"center\">\n-                  Create an Administrator Account\n+                  Create an admin account\n                 </Typography>\n               </Localized>\n \n@@ -118,7 +118,7 @@ class CreateYourAccountStep extends Component<Props> {\n                     <Localized id=\"install-createYourAccount-usernameDescription\">\n                       <InputDescription>\n                         An identifier displayed on your comments. You may use\n-                        “_” and “.”\n+                        “_” and “.” Spaces not permitted.\n                       </InputDescription>\n                     </Localized>\n                     <Localized\n@@ -184,7 +184,7 @@ class CreateYourAccountStep extends Component<Props> {\n                   <FormField>\n                     <Localized id=\"install-createYourAccount-confirmPassword\">\n                       <InputLabel container={<label htmlFor={input.name} />}>\n-                        Confirm Password\n+                        Confirm password\n                       </InputLabel>\n                     </Localized>\n                     <Localized"
    },
    {
      "sha": "3265ba3bb018315af1eb4511620c4da6b0369133",
      "filename": "src/core/client/install/App/steps/FinalStep.tsx",
      "status": "modified",
      "additions": 6,
      "deletions": 13,
      "changes": 19,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/install/App/steps/FinalStep.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/install/App/steps/FinalStep.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/install/App/steps/FinalStep.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,4 +1,5 @@\n import { Localized } from \"@fluent/react/compat\";\n+import { Link } from \"found\";\n import React, { Component } from \"react\";\n \n import { urls } from \"coral-framework/helpers\";\n@@ -8,31 +9,23 @@ class FinalStep extends Component {\n   public render() {\n     return (\n       <Flex direction=\"column\" justifyContent=\"center\" itemGutter=\"double\">\n-        <Localized id=\"install-finalStep-description\">\n+        <Localized\n+          id=\"install-finalStep-description\"\n+          $url={<Link to={urls.admin.moderate}>{urls.admin.moderate}</Link>}\n+        >\n           <Typography variant=\"bodyCopy\">\n             Thanks for installing Coral! We sent an email to verify your email\n             address. While you finish setting up the account, you can start\n             engaging with your readers now.\n           </Typography>\n         </Localized>\n         <Flex direction=\"row\" itemGutter justifyContent=\"center\">\n-          <Localized id=\"install-finalStep-goToTheDocs\">\n-            <Button\n-              anchor\n-              color=\"regular\"\n-              variant=\"filled\"\n-              href=\"https://docs.coralproject.net\"\n-              target=\"_blank\"\n-            >\n-              Go to the Docs\n-            </Button>\n-          </Localized>\n           <Localized id=\"install-finalStep-goToAdmin\">\n             <Button\n               anchor\n               color=\"primary\"\n               variant=\"filled\"\n-              href={urls.admin.moderateReported}\n+              href={urls.admin.moderate}\n             >\n               Go to Admin\n             </Button>"
    },
    {
      "sha": "c44a791ca8f0b675a2ab5bee0f74d140850db08d",
      "filename": "src/core/client/install/App/steps/PermittedDomainsStep.tsx",
      "status": "modified",
      "additions": 7,
      "deletions": 7,
      "changes": 14,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/install/App/steps/PermittedDomainsStep.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/install/App/steps/PermittedDomainsStep.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/install/App/steps/PermittedDomainsStep.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -27,25 +27,25 @@ import {\n import BackButton from \"./BackButton\";\n \n interface FormProps {\n-  allowedDomains: string[];\n+  allowedOrigins: string[];\n }\n \n interface FormSubmitProps extends FormProps, FormError {}\n \n interface Props {\n   onGoToNextStep: () => void;\n   onGoToPreviousStep: () => void;\n-  data: { allowedDomains: string[] };\n-  onInstall: (newData: { allowedDomains: string[] }) => Promise<void>;\n+  data: { allowedOrigins: string[] };\n+  onInstall: (newData: { allowedOrigins: string[] }) => Promise<void>;\n }\n \n class PermittedDomainsStep extends Component<Props> {\n   private onSubmit: OnSubmit<FormSubmitProps> = async (\n-    { allowedDomains },\n+    { allowedOrigins },\n     form\n   ) => {\n     try {\n-      await this.props.onInstall({ allowedDomains });\n+      await this.props.onInstall({ allowedOrigins });\n       return this.props.onGoToNextStep();\n     } catch (error) {\n       return { [FORM_ERROR]: error.message };\n@@ -56,7 +56,7 @@ class PermittedDomainsStep extends Component<Props> {\n       <Form\n         onSubmit={this.onSubmit}\n         initialValues={{\n-          allowedDomains: this.props.data.allowedDomains,\n+          allowedOrigins: this.props.data.allowedOrigins,\n         }}\n       >\n         {({ handleSubmit, submitting, submitError }) => (\n@@ -83,7 +83,7 @@ class PermittedDomainsStep extends Component<Props> {\n               )}\n \n               <Field\n-                name=\"allowedDomains\"\n+                name=\"allowedOrigins\"\n                 parse={parseStringList}\n                 format={formatStringList}\n                 validate={validateStrictURLList}"
    },
    {
      "sha": "fc779be884a60d29678ce82994812eff9414a711",
      "filename": "src/core/client/stream/local/local.graphql",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/stream/local/local.graphql",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/stream/local/local.graphql",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/stream/local/local.graphql?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -65,6 +65,7 @@ type Local {\n   storyID: String\n   storyURL: String\n   commentID: String\n+  siteID: String\n   commentsOrderBy: COMMENT_SORT!\n   profileTab: PROFILE_TAB!\n   commentsTab: COMMENTS_TAB!"
    },
    {
      "sha": "663ed8e6a6f9e14c55e2947dc000eeaaa61d76fe",
      "filename": "src/core/client/stream/tabs/Comments/Stream/StreamContainer.tsx",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/stream/tabs/Comments/Stream/StreamContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/stream/tabs/Comments/Stream/StreamContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/stream/tabs/Comments/Stream/StreamContainer.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -86,6 +86,7 @@ export const StreamContainer: FunctionComponent<Props> = props => {\n   const [local, setLocal] = useLocal<StreamContainerLocal>(\n     graphql`\n       fragment StreamContainerLocal on Local {\n+        siteID\n         commentsTab\n         commentsOrderBy\n       }"
    },
    {
      "sha": "e94202adf295f1efe5d6d04815e701a931e302b5",
      "filename": "src/core/client/stream/tabs/Configure/ModerateStreamContainer.tsx",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/stream/tabs/Configure/ModerateStreamContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/stream/tabs/Configure/ModerateStreamContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/stream/tabs/Configure/ModerateStreamContainer.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -2,7 +2,7 @@ import { Localized } from \"@fluent/react/compat\";\n import React, { FunctionComponent, useMemo } from \"react\";\n import { graphql } from \"react-relay\";\n \n-import { urls } from \"coral-framework/helpers\";\n+import { getModerationLink } from \"coral-framework/helpers\";\n import { ExternalLink } from \"coral-framework/lib/i18n/components\";\n import {\n   withFragmentContainer,\n@@ -26,7 +26,7 @@ const ModerateStreamContainer: FunctionComponent<Props> = ({\n   story: { id },\n }) => {\n   const href = useMemo(() => {\n-    let link = urls.admin.moderateReported + \"/\" + id;\n+    let link = getModerationLink({ storyID: id });\n     if (\n       accessToken &&\n       settings.auth.integrations.sso.enabled &&"
    },
    {
      "sha": "339a07f798c89e96f573c4a064c88ebe943d2271",
      "filename": "src/core/client/stream/test/comments/stream/closedOrDisabledCommentStream.spec.tsx",
      "status": "modified",
      "additions": 3,
      "deletions": 1,
      "changes": 4,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/stream/test/comments/stream/closedOrDisabledCommentStream.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/stream/test/comments/stream/closedOrDisabledCommentStream.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/stream/test/comments/stream/closedOrDisabledCommentStream.spec.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -52,7 +52,9 @@ it(\"renders disabled comment stream\", async () => {\n     },\n   });\n   await waitForElement(() =>\n-    within(testRenderer.root).getByText(\"commenting disabled\", { exact: false })\n+    within(testRenderer.root).getByText(\"commenting disabled\", {\n+      exact: false,\n+    })\n   );\n });\n "
    },
    {
      "sha": "149422b6397bf6f284046b5c02e819e6ba8b074e",
      "filename": "src/core/client/stream/test/configure/__snapshots__/renderConfigure.spec.tsx.snap",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/stream/test/configure/__snapshots__/renderConfigure.spec.tsx.snap",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/stream/test/configure/__snapshots__/renderConfigure.spec.tsx.snap",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/stream/test/configure/__snapshots__/renderConfigure.spec.tsx.snap?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -58,7 +58,7 @@ exports[`renders configure 1`] = `\n         >\n           <a\n             className=\"ExternalLink-root\"\n-            href=\"/admin/moderate/reported/story-1\"\n+            href=\"/admin/moderate/stories/story-1\"\n             rel=\"noopener noreferrer\"\n             target=\"_blank\"\n           >"
    },
    {
      "sha": "a7c5e221505bb79d3324c4c3db0d0f889528c5de",
      "filename": "src/core/client/stream/test/fixtures.ts",
      "status": "modified",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/stream/test/fixtures.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/stream/test/fixtures.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/stream/test/fixtures.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -4,6 +4,7 @@ import {\n   GQLDIGEST_FREQUENCY,\n   GQLMODERATION_MODE,\n   GQLSettings,\n+  GQLSite,\n   GQLStory,\n   GQLTAG,\n   GQLTag,\n@@ -106,6 +107,14 @@ export const settings = createFixture<GQLSettings>({\n     changeUsername: true,\n     deleteAccount: true,\n   },\n+  multisite: false,\n+});\n+\n+export const site = createFixture<GQLSite>({\n+  name: \"Test Site\",\n+  id: \"site-id\",\n+  createdAt: \"2018-05-06T18:24:00.000Z\",\n+  allowedOrigins: [\"http://test-site.com\"],\n });\n \n export const settingsWithoutLocalAuth = createFixture<GQLSettings>(\n@@ -531,6 +540,7 @@ export const baseStory = createFixture<GQLStory>({\n       configurable: true,\n     },\n   },\n+  site,\n });\n \n export const moderators = createFixtures<GQLUser>("
    },
    {
      "sha": "2f7febccf7e4cad409b94a356da254d13ee53ad2",
      "filename": "src/core/client/test/helpers/fixture.ts",
      "status": "modified",
      "additions": 0,
      "deletions": 1,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/test/helpers/fixture.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/test/helpers/fixture.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/test/helpers/fixture.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -269,7 +269,6 @@ export function createSettings() {\n       enabled: true,\n     },\n     customCSSURL: \"\",\n-    allowedDomains: [\"localhost:8080\"],\n     editCommentWindowLength: 30000,\n     communityGuidelines: {\n       enabled: false,"
    },
    {
      "sha": "0fd61dae84275b4050306a2024babd3faf962402",
      "filename": "src/core/client/ui/components/AbsoluteTime/AbsoluteTime.tsx",
      "status": "modified",
      "additions": 9,
      "deletions": 4,
      "changes": 13,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/AbsoluteTime/AbsoluteTime.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/AbsoluteTime/AbsoluteTime.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/ui/components/AbsoluteTime/AbsoluteTime.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,16 +1,21 @@\n import React, { FunctionComponent, useMemo } from \"react\";\n \n-import { useCoralContext } from \"coral-framework/lib/bootstrap\";\n-import { Typography } from \"coral-ui/components\";\n+import { Typography, useUIContext } from \"coral-ui/components\";\n import { PropTypesOf } from \"coral-ui/types\";\n \n interface Props {\n   date: string;\n   className?: string;\n+  locales?: string[];\n }\n \n-const AbsoluteTime: FunctionComponent<Props> = ({ date, className }) => {\n-  const { locales } = useCoralContext();\n+const AbsoluteTime: FunctionComponent<Props> = ({\n+  date,\n+  className,\n+  locales: localesFromProps,\n+}) => {\n+  const { locales: localesFromContext } = useUIContext();\n+  const locales = localesFromProps || localesFromContext || [\"en-US\"];\n   const formatted = useMemo(() => {\n     const formatter = new Intl.DateTimeFormat(locales, {\n       year: \"numeric\","
    },
    {
      "sha": "71faeeaa16360c7d38a4791005d18bcde5d864a1",
      "filename": "src/core/client/ui/components/UIContext/UIContext.ts",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/UIContext/UIContext.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/UIContext/UIContext.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/ui/components/UIContext/UIContext.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -14,8 +14,12 @@ export interface UIContextProps {\n    * current frame for `ClickOutside`\n    */\n   registerClickFarAway?: ClickFarAwayRegister;\n+\n+  locales?: string[];\n }\n \n const UIContext = React.createContext<UIContextProps>({} as any);\n \n+export const useUIContext = () => React.useContext(UIContext);\n+\n export default UIContext;"
    },
    {
      "sha": "22c2050ab79f1022a67806298796037da046b8ea",
      "filename": "src/core/client/ui/components/UIContext/index.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/UIContext/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/UIContext/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/ui/components/UIContext/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1 +1 @@\n-export { default, UIContextProps } from \"./UIContext\";\n+export { default, UIContextProps, useUIContext } from \"./UIContext\";"
    },
    {
      "sha": "09345e163f777fde22e9f56dec5a5db3c0006178",
      "filename": "src/core/client/ui/components/index.ts",
      "status": "modified",
      "additions": 5,
      "deletions": 1,
      "changes": 6,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/ui/components/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -6,7 +6,11 @@ export { default as ButtonIcon } from \"./Button/ButtonIcon\";\n export { default as Typography } from \"./Typography\";\n export { default as Popover } from \"./Popover\";\n export { default as RelativeTime } from \"./RelativeTime\";\n-export { default as UIContext, UIContextProps } from \"./UIContext\";\n+export {\n+  default as UIContext,\n+  UIContextProps,\n+  useUIContext,\n+} from \"./UIContext\";\n export { default as Flex } from \"./Flex\";\n export { default as MatchMedia } from \"./MatchMedia\";\n export { default as TrapFocus } from \"./TrapFocus\";"
    },
    {
      "sha": "3da3fe913587782b6e91ba88a5f15a70ce6a1d3f",
      "filename": "src/core/client/ui/components/v2/AppNotification/AppNotification.css",
      "status": "added",
      "additions": 15,
      "deletions": 0,
      "changes": 15,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/v2/AppNotification/AppNotification.css",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/v2/AppNotification/AppNotification.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/ui/components/v2/AppNotification/AppNotification.css?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,15 @@\n+.root {\n+  font-family: var(--v2-font-family-primary);\n+  font-weight: var(--v2-font-weight-primary-bold);\n+  line-height: var(--v2-line-height-min);\n+  padding: var(--v2-spacing-2);\n+}\n+\n+.inner {\n+  max-width: 1280px;\n+  margin: 0 auto;\n+}\n+\n+.success {\n+  background-color: var(--v2-colors-green-300);\n+}"
    },
    {
      "sha": "72afd22e133058ed514ac511cef9def9313d21bb",
      "filename": "src/core/client/ui/components/v2/AppNotification/AppNotification.tsx",
      "status": "added",
      "additions": 49,
      "deletions": 0,
      "changes": 49,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/v2/AppNotification/AppNotification.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/v2/AppNotification/AppNotification.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/ui/components/v2/AppNotification/AppNotification.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,49 @@\n+import cn from \"classnames\";\n+import React, { FunctionComponent } from \"react\";\n+\n+import { Button, ButtonIcon, Flex, Icon } from \"coral-ui/components/v2\";\n+\n+import styles from \"./AppNotification.css\";\n+\n+interface Props {\n+  icon?: string;\n+  onClose?: () => void;\n+  color?: \"success\" | \"alert\" | \"mono\";\n+}\n+\n+const AppNotification: FunctionComponent<Props> = ({\n+  icon,\n+  children,\n+  onClose,\n+  color,\n+}) => {\n+  const rootClassName = cn(styles.root, {\n+    [styles.success]: color === \"success\",\n+  });\n+\n+  return (\n+    <div className={rootClassName}>\n+      <Flex\n+        alignItems=\"center\"\n+        justifyContent=\"space-between\"\n+        className={styles.inner}\n+      >\n+        <Flex alignItems=\"center\" itemGutter>\n+          {icon && <Icon>{icon}</Icon>}\n+          {children}\n+        </Flex>\n+        {onClose && (\n+          <Button variant=\"text\" color=\"mono\" onClick={onClose}>\n+            <ButtonIcon>close</ButtonIcon>\n+          </Button>\n+        )}\n+      </Flex>\n+    </div>\n+  );\n+};\n+\n+AppNotification.defaultProps = {\n+  color: \"success\",\n+};\n+\n+export default AppNotification;"
    },
    {
      "sha": "adc0c3ba612297092c56112d7c87bb3a63c3aeac",
      "filename": "src/core/client/ui/components/v2/AppNotification/index.ts",
      "status": "added",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/v2/AppNotification/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/v2/AppNotification/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/ui/components/v2/AppNotification/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1 @@\n+export { default } from \"./AppNotification\";"
    },
    {
      "sha": "df70b4d9506dcdc5653b8819929266981aaf13eb",
      "filename": "src/core/client/ui/components/v2/BaseButton/BaseButton.tsx",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/v2/BaseButton/BaseButton.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/v2/BaseButton/BaseButton.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/ui/components/v2/BaseButton/BaseButton.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,4 +1,5 @@\n import cn from \"classnames\";\n+import { Link } from \"found\";\n import React, {\n   ButtonHTMLAttributes,\n   EventHandler,\n@@ -26,6 +27,8 @@ interface Props extends ButtonHTMLAttributes<HTMLButtonElement> {\n   target?: string;\n   rel?: string;\n \n+  to?: string;\n+\n   /**\n    * This prop can be used to add custom classnames.\n    * It is handled by the `withStyles `HOC.\n@@ -68,6 +71,10 @@ const BaseButton: FunctionComponent<Props> = ({\n       React.ClassAttributes<HTMLButtonElement | HTMLAnchorElement>\n   > = \"button\" as any;\n \n+  if (rest.to) {\n+    Element = Link as any;\n+  }\n+\n   if (anchor) {\n     Element = \"a\" as any;\n   }"
    },
    {
      "sha": "6a833192977c64a1cdc38864c5c7b943c2c1fb83",
      "filename": "src/core/client/ui/components/v2/Button/Button.css",
      "status": "modified",
      "additions": 5,
      "deletions": 1,
      "changes": 6,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/v2/Button/Button.css",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/v2/Button/Button.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/ui/components/v2/Button/Button.css?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -117,7 +117,6 @@ $button-text-dark-foreground-active: var(--v2-colors-blue-700);\n   box-sizing: border-box;\n   border: 1px solid transparent;\n \n-  letter-spacing: 0.042em;\n   transition: 0.2s ease-out background-color;\n \n   font-family: var(--v2-font-family-primary);\n@@ -154,6 +153,7 @@ $button-text-dark-foreground-active: var(--v2-colors-blue-700);\n \n .uppercase {\n   text-transform: uppercase;\n+  letter-spacing: 0.042em;\n }\n \n .root.disabled {\n@@ -486,3 +486,7 @@ $button-text-dark-foreground-active: var(--v2-colors-blue-700);\n     }\n   }\n }\n+\n+.linkButton {\n+  text-decoration: none;\n+}"
    },
    {
      "sha": "02c97f0e5f63227d75d08b9e9c8c281e488e8d0f",
      "filename": "src/core/client/ui/components/v2/Button/Button.tsx",
      "status": "modified",
      "additions": 7,
      "deletions": 1,
      "changes": 8,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/v2/Button/Button.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/v2/Button/Button.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/ui/components/v2/Button/Button.tsx?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -14,6 +14,7 @@ interface Props extends Omit<BaseButtonProps, \"ref\"> {\n   anchor?: boolean;\n   href?: string;\n   target?: string;\n+  to?: string;\n   /**\n    * This prop can be used to add custom classnames.\n    * It is handled by the `withStyles `HOC.\n@@ -69,6 +70,7 @@ export class Button extends React.Component<Props> {\n       classes,\n       color,\n       className,\n+      children,\n       size,\n       fullWidth,\n       disabled,\n@@ -80,6 +82,7 @@ export class Button extends React.Component<Props> {\n       iconRight,\n       adornmentLeft,\n       adornmentRight,\n+      to,\n       ...rest\n     } = this.props;\n \n@@ -118,9 +121,12 @@ export class Button extends React.Component<Props> {\n         type={type}\n         data-variant={variant}\n         data-color={color}\n+        to={to}\n         data-active={active}\n         {...rest}\n-      />\n+      >\n+        {children}\n+      </BaseButton>\n     );\n   }\n }"
    },
    {
      "sha": "1cad8cc6383641bfd9a87bf8c8e0abea0433ad16",
      "filename": "src/core/client/ui/components/v2/SelectField/SelectField.css",
      "status": "modified",
      "additions": 3,
      "deletions": 2,
      "changes": 5,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/v2/SelectField/SelectField.css",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/v2/SelectField/SelectField.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/ui/components/v2/SelectField/SelectField.css?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -8,7 +8,7 @@\n   display: inline-flex;\n   justify-content: center;\n   align-items: center;\n-  right: var(--v2-spacing-2);;\n+  right: var(--v2-spacing-2);\n   height: 100%;\n   user-select: none;\n   pointer-events: none;\n@@ -47,7 +47,8 @@\n   border-radius: var(--round-corners);\n   background-color: var(--v2-palette-input-background);\n   border: 1px solid var(--v2-palette-input-border);\n-  padding: var(--v2-spacing-2) var(--v2-spacing-6) var(--v2-spacing-2) var(--v2-spacing-2);\n+  padding: calc(var(--v2-spacing-2) - 2px) var(--v2-spacing-6)\n+    calc(var(--v2-spacing-2) - 2px) var(--v2-spacing-2);\n \n   &::-ms-expand {\n     display: none;"
    },
    {
      "sha": "e3cb88fcaacb62fa148623613ccc012c6bf3de0a",
      "filename": "src/core/client/ui/components/v2/index.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/v2/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/client/ui/components/v2/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/ui/components/v2/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -66,3 +66,4 @@ export {\n } from \"./ValidationMessage\";\n export { BrandName, BrandMark, LogoHorizontal } from \"./Brand\";\n export { default as InputLabel } from \"./InputLabel\";\n+export { default as AppNotification } from \"./AppNotification\";"
    },
    {
      "sha": "e910afd4a659f8834bbea97070474102ff02aa10",
      "filename": "src/core/common/errors.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 6,
      "changes": 8,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/common/errors.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/common/errors.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/common/errors.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -32,12 +32,6 @@ export enum ERROR_CODES {\n    */\n   STORY_URL_NOT_PERMITTED = \"STORY_URL_NOT_PERMITTED\",\n \n-  /**\n-   * URL_NOT_PERMITTED is used when a given URL is provided that can not be\n-   * matched to the Tenant.\n-   */\n-  URL_NOT_PERMITTED = \"URL_NOT_PERMITTED\",\n-\n   /**\n    * TOKEN_NOT_FOUND is used when a Token is referenced by ID but can not be\n    * found to be associated with the given User.\n@@ -338,4 +332,6 @@ export enum ERROR_CODES {\n    * when it is not authorized to do so.\n    */\n   INSTALLATION_FORBIDDEN = \"INSTALLATION_FORBIDDEN\",\n+\n+  DUPLICATE_SITE_ORIGIN = \"DUPLICATE_SITE_ORIGIN\",\n }"
    },
    {
      "sha": "abeecff4ac089139f85bd6b7f41bc6caea8fae4c",
      "filename": "src/core/common/helpers/isNonNullArray.spec.ts",
      "status": "added",
      "additions": 11,
      "deletions": 0,
      "changes": 11,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/common/helpers/isNonNullArray.spec.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/common/helpers/isNonNullArray.spec.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/common/helpers/isNonNullArray.spec.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,11 @@\n+import isNonNullArray from \"./isNonNullArray\";\n+\n+describe(\"isNonNullArray\", () => {\n+  it(\"returns true for an array with no null entries\", () => {\n+    expect(isNonNullArray([-1, undefined, 0, 1, 2, 3, 4, 5])).toBeTruthy();\n+  });\n+\n+  it(\"returns false for an array with some null entries\", () => {\n+    expect(isNonNullArray([-1, 0, null, 2, 3, 4, 5])).toBeFalsy();\n+  });\n+});"
    },
    {
      "sha": "25d17fac86817f2b19aea5aba4020c90a883d383",
      "filename": "src/core/common/helpers/isNonNullArray.ts",
      "status": "added",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/common/helpers/isNonNullArray.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/common/helpers/isNonNullArray.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/common/helpers/isNonNullArray.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,9 @@\n+export default function isNonNullArray<T>(arr: (T | null)[]): arr is T[] {\n+  for (const item of arr) {\n+    if (item === null) {\n+      return false;\n+    }\n+  }\n+\n+  return true;\n+}"
    },
    {
      "sha": "d4f63b5985201f55333ecdc739a68016b64e8f4c",
      "filename": "src/core/common/types.ts",
      "status": "modified",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/common/types.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/common/types.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/common/types.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -60,3 +60,13 @@ export type DeepPartial<T> = T extends object\n         : DeepPartial<T[P]>;\n     }\n   : T;\n+\n+/**\n+ * FirstDeepPartial is like DeepPartial but applies only to the first parameters\n+ * on the object.\n+ */\n+export type FirstDeepPartial<T> = T extends object\n+  ? {\n+      [P in keyof T]: DeepPartial<T[P]>;\n+    }\n+  : T;"
    },
    {
      "sha": "ab347891750d08dfb40049e0f1cd6dd63dc83c1a",
      "filename": "src/core/server/app/handlers/api/install.ts",
      "status": "modified",
      "additions": 14,
      "deletions": 5,
      "changes": 19,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/app/handlers/api/install.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/app/handlers/api/install.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/app/handlers/api/install.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -11,13 +11,15 @@ import {\n   InstallationForbiddenError,\n   TenantInstalledAlreadyError,\n } from \"coral-server/errors\";\n+import { CreateSiteInput } from \"coral-server/models/site\";\n import { LocalProfile } from \"coral-server/models/user\";\n import {\n   createJWTSigningConfig,\n   extractTokenFromRequest,\n   JWTSigningConfig,\n } from \"coral-server/services/jwt\";\n import { verifyInstallationTokenString } from \"coral-server/services/management\";\n+import { create as createSite } from \"coral-server/services/sites\";\n import {\n   install,\n   InstallTenant,\n@@ -92,6 +94,7 @@ export interface TenantInstallBody {\n   tenant: Omit<InstallTenant, \"domain\" | \"locale\"> & {\n     locale: LanguageCode | null;\n   };\n+  site: Omit<CreateSiteInput, \"tenantID\">;\n   user: Required<Pick<CreateUser, \"username\" | \"email\"> & { password: string }>;\n }\n \n@@ -108,16 +111,19 @@ const TenantInstallBodySchema = Joi.object().keys({\n           .lowercase()\n           .email(),\n       }),\n-      allowedDomains: Joi.array().items(\n-        Joi.string()\n-          .trim()\n-          .uri({ scheme: [\"http\", \"https\"] })\n-      ),\n       locale: Joi.string()\n         .default(null)\n         .valid(LOCALES),\n     })\n     .optionalKeys(\"locale\"),\n+  site: Joi.object().keys({\n+    name: Joi.string().trim(),\n+    allowedOrigins: Joi.array().items(\n+      Joi.string()\n+        .trim()\n+        .uri({ scheme: [\"http\", \"https\"] })\n+    ),\n+  }),\n   user: Joi.object().keys({\n     username: Joi.string().trim(),\n     password: Joi.string(),\n@@ -196,6 +202,7 @@ export const installHandler = ({\n       // payload is invalid.\n       const {\n         tenant: { locale: tenantLocale, ...tenantInput },\n+        site: siteInput,\n         user: userInput,\n       }: TenantInstallBody = validate(TenantInstallBodySchema, req.body);\n \n@@ -228,6 +235,8 @@ export const installHandler = ({\n         req.coral.now\n       );\n \n+      await createSite(mongo, tenant, siteInput);\n+\n       // Pull the user details out of the input for the user.\n       const { email, username, password } = userInput;\n "
    },
    {
      "sha": "da857dbcb91f42a4ff7e174a1697491744e307d0",
      "filename": "src/core/server/app/handlers/api/story/count.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/app/handlers/api/story/count.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/app/handlers/api/story/count.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/app/handlers/api/story/count.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,11 +1,11 @@\n-import { RequestHandler } from \"coral-server/types/express\";\n import createDOMPurify from \"dompurify\";\n import { JSDOM } from \"jsdom\";\n \n import { AppOptions } from \"coral-server/app\";\n-import { calculateTotalPublishedCommentCount } from \"coral-server/models/story\";\n+import { calculateTotalPublishedCommentCount } from \"coral-server/models/comment\";\n import { translate } from \"coral-server/services/i18n\";\n import { find } from \"coral-server/services/stories\";\n+import { RequestHandler } from \"coral-server/types/express\";\n \n const NUMBER_CLASSNAME = \"coral-count-number\";\n const TEXT_CLASSNAME = \"coral-count-text\";"
    },
    {
      "sha": "78989bb4fe2549e5b72f8a36d1e92711ea82a7f1",
      "filename": "src/core/server/app/middleware/csp/tenant.spec.ts",
      "status": "modified",
      "additions": 19,
      "deletions": 25,
      "changes": 44,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/app/middleware/csp/tenant.spec.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/app/middleware/csp/tenant.spec.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/app/middleware/csp/tenant.spec.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -2,61 +2,55 @@ import { generateFrameOptions } from \"coral-server/app/middleware/csp/tenant\";\n import { Request } from \"coral-server/types/express\";\n \n it(\"denies when the tenant has no specified domains\", () => {\n-  const tenant = { allowedDomains: [] };\n+  const origins: string[] = [];\n   const req = {} as Request;\n \n-  expect(generateFrameOptions(req, tenant)).toEqual(\"deny\");\n+  expect(generateFrameOptions(req, origins)).toEqual(\"deny\");\n });\n \n it(\"allow-from single domain when there is one domain\", () => {\n-  const tenant = { allowedDomains: [\"https://coralproject.net\"] };\n+  const origins: string[] = [\"https://coralproject.net\"];\n   const req = {} as Request;\n \n-  expect(generateFrameOptions(req, tenant)).toEqual(\n+  expect(generateFrameOptions(req, origins)).toEqual(\n     \"allow-from https://coralproject.net\"\n   );\n });\n \n it(\"deny from the domain when it does not provide and there are multiple tenants domains\", () => {\n-  const tenant = {\n-    allowedDomains: [\n-      \"https://coralproject.net\",\n-      \"https://news.coralproject.net\",\n-    ],\n-  };\n+  const origins: string[] = [\n+    \"https://coralproject.net\",\n+    \"https://news.coralproject.net\",\n+  ];\n   const req = { headers: {}, query: { parentUrl: \"\" } } as Request;\n \n-  expect(generateFrameOptions(req, tenant)).toEqual(\"deny\");\n+  expect(generateFrameOptions(req, origins)).toEqual(\"deny\");\n });\n \n it(\"allows from the domain when it does not provide a match and there are multiple tenants domains\", () => {\n-  const tenant = {\n-    allowedDomains: [\n-      \"https://coralproject.net\",\n-      \"https://news.coralproject.net\",\n-    ],\n-  };\n+  const origins: string[] = [\n+    \"https://coralproject.net\",\n+    \"https://news.coralproject.net\",\n+  ];\n   const req = {\n     headers: {},\n     query: { parentUrl: \"https://blog.coralproject.net/a/page\" },\n   } as Request;\n \n-  expect(generateFrameOptions(req, tenant)).toEqual(\"deny\");\n+  expect(generateFrameOptions(req, origins)).toEqual(\"deny\");\n });\n \n it(\"allows from the domain when it does provide a match and there are multiple tenants domains\", () => {\n-  const tenant = {\n-    allowedDomains: [\n-      \"https://coralproject.net\",\n-      \"https://news.coralproject.net\",\n-    ],\n-  };\n+  const origins: string[] = [\n+    \"https://coralproject.net\",\n+    \"https://news.coralproject.net\",\n+  ];\n   const req = {\n     headers: {},\n     query: { parentUrl: \"https://news.coralproject.net/a/page\" },\n   } as Request;\n \n-  expect(generateFrameOptions(req, tenant)).toEqual(\n+  expect(generateFrameOptions(req, origins)).toEqual(\n     \"allow-from https://news.coralproject.net\"\n   );\n });"
    },
    {
      "sha": "0e6563bedd102241ec399e4a6d3f7274f736912d",
      "filename": "src/core/server/app/middleware/csp/tenant.ts",
      "status": "modified",
      "additions": 85,
      "deletions": 21,
      "changes": 106,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/app/middleware/csp/tenant.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/app/middleware/csp/tenant.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/app/middleware/csp/tenant.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,57 +1,121 @@\n import builder from \"content-security-policy-builder\";\n+import { Db } from \"mongodb\";\n+\n+import { AppOptions } from \"coral-server/app\";\n import { extractParentsURL, getOrigin } from \"coral-server/app/url\";\n-import { Tenant } from \"coral-server/models/tenant\";\n-import { isURLPermitted } from \"coral-server/services/tenant/url\";\n+import { retrieveSite, Site } from \"coral-server/models/site\";\n+import { retrieveStory } from \"coral-server/models/story\";\n+import { findSiteByURL } from \"coral-server/services/sites\";\n+import { isURLPermitted } from \"coral-server/services/sites/url\";\n import { Request, RequestHandler } from \"coral-server/types/express\";\n \n-/**\n- * cspMiddleware handles adding the CSP middleware to each outgoing request.\n- */\n-export const cspTenantMiddleware: RequestHandler = (req, res, next) => {\n+interface RequestQuery {\n+  parentUrl?: string;\n+  storyURL?: string;\n+  storyID?: string;\n+}\n+\n+async function retrieveSiteFromEmbed(\n+  mongo: Db,\n+  req: Request\n+): Promise<Site | null> {\n   if (!req.coral || !req.coral.tenant) {\n     // There is no tenant for the request, don't add any headers.\n-    return next();\n+    return null;\n+  }\n+\n+  // Pull the tenant and the logger from the request.\n+  const {\n+    coral: { tenant },\n+  } = req;\n+\n+  // Attempt to detect the site based on the query parameters.\n+  const {\n+    storyURL = \"\",\n+    storyID = \"\",\n+    parentUrl = \"\",\n+  }: RequestQuery = req.query;\n+\n+  // If the storyURL is available, we can lookup the site directly based on it.\n+  if (storyURL) {\n+    // If the site can't be found based on it's allowed origins and the story\n+    // URL (which is a allowed list), then we know it isn't allowed.\n+    return findSiteByURL(mongo, tenant.id, storyURL);\n+  }\n+\n+  // If the storyID is available, we can lookup the story and then it's site.\n+  if (storyID) {\n+    const story = await retrieveStory(mongo, tenant.id, storyID);\n+    if (!story) {\n+      // We can't lookup the story, therefore we can't lookup the site, abort.\n+      return null;\n+    }\n+\n+    // If the site can't be found based on it's allowed origins and the story\n+    // URL (which is a allowed list), then we know it isn't allowed.\n+    return retrieveSite(mongo, tenant.id, story.siteID);\n   }\n \n-  const tenant = req.coral.tenant;\n+  // As the last fallback, if the storyURL and storyID cannot be found, then pym\n+  // does provide us with a parentUrl that's the URL of the page embedding\n+  // Coral. We'll try to find the site based on this URL.\n+  if (parentUrl) {\n+    return findSiteByURL(mongo, tenant.id, parentUrl);\n+  }\n+\n+  return null;\n+}\n+\n+type Options = Pick<AppOptions, \"mongo\">;\n+\n+/**\n+ * cspMiddleware handles adding the CSP middleware to each outgoing request.\n+ */\n+export const cspSiteMiddleware = ({ mongo }: Options): RequestHandler => async (\n+  req,\n+  res,\n+  next\n+) => {\n+  // Initially, we do not allow any origins.\n+  const site = await retrieveSiteFromEmbed(mongo, req);\n+\n+  // Grab the origins from the site.\n+  const origins = site ? site.allowedOrigins : [];\n \n   res.setHeader(\n     \"Content-Security-Policy\",\n-    generateContentSecurityPolicy(tenant)\n+    generateContentSecurityPolicy(origins)\n   );\n \n   // Add some fallbacks for IE.\n-  res.setHeader(\"X-Frame-Options\", generateFrameOptions(req, tenant));\n+  res.setHeader(\"X-Frame-Options\", generateFrameOptions(req, origins));\n   res.setHeader(\"X-XSS-Protection\", \"1; mode=block\");\n \n   next();\n };\n \n-function generateContentSecurityPolicy(tenant: Pick<Tenant, \"allowedDomains\">) {\n+function generateContentSecurityPolicy(allowedOrigins: string[]) {\n   const directives: Record<string, any> = {};\n \n   // Only the domains that are allowed by the tenant may embed Coral.\n   directives.frameAncestors =\n-    tenant.allowedDomains.length > 0 ? tenant.allowedDomains : [\"'none'\"];\n+    allowedOrigins.length > 0 ? allowedOrigins : [\"'none'\"];\n \n   // Build the directive.\n   const directive = builder({ directives });\n \n   return directive;\n }\n \n-export function generateFrameOptions(\n-  req: Request,\n-  tenant: Pick<Tenant, \"allowedDomains\">\n-) {\n+export function generateFrameOptions(req: Request, allowedOrigins: string[]) {\n   // If there aren't any domains, then we reject it.\n-  if (tenant.allowedDomains.length === 0) {\n+  if (allowedOrigins.length === 0) {\n     return \"deny\";\n   }\n \n   // If there is only one domain on the tenant then return it!\n-  if (tenant.allowedDomains.length === 1) {\n-    return `allow-from ${getOrigin(tenant.allowedDomains[0])}`;\n+  if (allowedOrigins.length === 1) {\n+    return `allow-from ${getOrigin(allowedOrigins[0])}`;\n   }\n \n   const parentsURL = extractParentsURL(req);\n@@ -66,15 +130,15 @@ export function generateFrameOptions(\n   }\n \n   // Determine if this origin is allowed.\n-  if (!isURLPermitted(tenant, parentsURL)) {\n+  if (!isURLPermitted({ allowedOrigins }, parentsURL)) {\n     return \"deny\";\n   }\n \n   // As we can only return a single domain in the `allow-from` directive as per\n   // https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options\n   // We need to find the domain that is asking so we can respond with the right\n   // result, sort of like CORS!\n-  const allowFrom = tenant.allowedDomains\n+  const allowFrom = allowedOrigins\n     .map(domain => getOrigin(domain))\n     .find(origin => origin === parentsOrigin);\n   if (!allowFrom) {"
    },
    {
      "sha": "ceb596606244a662a5b829c6f7c0dbf4aa2e204d",
      "filename": "src/core/server/app/router/client.ts",
      "status": "modified",
      "additions": 18,
      "deletions": 5,
      "changes": 23,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/app/router/client.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/app/router/client.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/app/router/client.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,10 +1,11 @@\n import express, { Router } from \"express\";\n import { minify } from \"html-minifier\";\n+import { Db } from \"mongodb\";\n import path from \"path\";\n \n import { LanguageCode } from \"coral-common/helpers/i18n/locales\";\n import { cacheHeadersMiddleware } from \"coral-server/app/middleware/cacheHeaders\";\n-import { cspTenantMiddleware } from \"coral-server/app/middleware/csp/tenant\";\n+import { cspSiteMiddleware } from \"coral-server/app/middleware/csp/tenant\";\n import { installedMiddleware } from \"coral-server/app/middleware/installed\";\n import { tenantMiddleware } from \"coral-server/app/middleware/tenant\";\n import logger from \"coral-server/logger\";\n@@ -16,6 +17,11 @@ import Entrypoints, { Entrypoint } from \"../helpers/entrypoints\";\n export interface ClientTargetHandlerOptions {\n   defaultLocale: LanguageCode;\n \n+  /**\n+   * mongo is used when trying to infer a site from the request.\n+   */\n+  mongo: Db;\n+\n   /**\n    * entrypoint is the entrypoint entry to load.\n    */\n@@ -43,6 +49,9 @@ function createClientTargetRouter(options: ClientTargetHandlerOptions) {\n   // Create a router.\n   const router = express.Router();\n \n+  // Add CSP headers to the request, which only apply when serving HTML content.\n+  router.use(cspSiteMiddleware(options));\n+\n   // Always send the cache headers.\n   router.use(cacheHeadersMiddleware(options.cacheDuration));\n \n@@ -56,6 +65,7 @@ interface MountClientRouteOptions {\n   defaultLocale: LanguageCode;\n   tenantCache: TenantCache;\n   staticURI: string;\n+  mongo: Db;\n }\n \n const clientHandler = ({\n@@ -96,7 +106,7 @@ const clientHandler = ({\n \n export function mountClientRoutes(\n   router: Router,\n-  { staticURI, tenantCache, defaultLocale }: MountClientRouteOptions\n+  { staticURI, tenantCache, defaultLocale, mongo }: MountClientRouteOptions\n ) {\n   // TODO: (wyattjoh) figure out a better way of referencing paths.\n   // Load the entrypoint manifest.\n@@ -127,9 +137,6 @@ export function mountClientRoutes(\n     })\n   );\n \n-  // Add CSP headers to the request, which only apply when serving HTML content.\n-  router.use(cspTenantMiddleware);\n-\n   // Add the embed targets.\n   router.use(\n     \"/embed/stream\",\n@@ -138,6 +145,7 @@ export function mountClientRoutes(\n       enableCustomCSS: true,\n       entrypoint: entrypoints.get(\"stream\"),\n       defaultLocale,\n+      mongo,\n     })\n   );\n   router.use(\n@@ -147,6 +155,7 @@ export function mountClientRoutes(\n       cacheDuration: false,\n       entrypoint: entrypoints.get(\"authCallback\"),\n       defaultLocale,\n+      mongo,\n     })\n   );\n   router.use(\n@@ -156,6 +165,7 @@ export function mountClientRoutes(\n       cacheDuration: false,\n       entrypoint: entrypoints.get(\"auth\"),\n       defaultLocale,\n+      mongo,\n     })\n   );\n \n@@ -169,6 +179,7 @@ export function mountClientRoutes(\n       cacheDuration: false,\n       entrypoint: entrypoints.get(\"account\"),\n       defaultLocale,\n+      mongo,\n     })\n   );\n   // Add the standalone targets.\n@@ -181,6 +192,7 @@ export function mountClientRoutes(\n       cacheDuration: false,\n       entrypoint: entrypoints.get(\"admin\"),\n       defaultLocale,\n+      mongo,\n     })\n   );\n   router.use(\n@@ -195,6 +207,7 @@ export function mountClientRoutes(\n       cacheDuration: false,\n       entrypoint: entrypoints.get(\"install\"),\n       defaultLocale,\n+      mongo,\n     })\n   );\n "
    },
    {
      "sha": "5e1ec012628c7f1ffa780a0d7d7287aec53fbd69",
      "filename": "src/core/server/app/router/index.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/app/router/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/app/router/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/app/router/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -37,6 +37,7 @@ export function createRouter(app: AppOptions, options: RouterOptions) {\n       // not provided to the default current domain relative \"/\".\n       staticURI: app.config.get(\"static_uri\") || \"/\",\n       tenantCache: app.tenantCache,\n+      mongo: app.mongo,\n     });\n   } else {\n     logger.warn(\"client routes are disabled\");"
    },
    {
      "sha": "d7b00aa67128ce9a7391be3cb06326a73be7e651",
      "filename": "src/core/server/app/url.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/app/url.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/app/url.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/app/url.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -69,7 +69,7 @@ export function getHostname(url: string) {\n \n export function getOrigin(url: string) {\n   try {\n-    return new URL(url).origin;\n+    return new URL(url).origin.toLowerCase();\n   } catch (err) {\n     return null;\n   }"
    },
    {
      "sha": "2ba259383c3b42ca2f3cc2a3e1c80b7714d2184e",
      "filename": "src/core/server/errors/index.ts",
      "status": "modified",
      "additions": 11,
      "deletions": 21,
      "changes": 32,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/errors/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/errors/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/errors/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -242,28 +242,8 @@ export class CommentBodyExceedsMaxLengthError extends CoralError {\n   }\n }\n \n-export class URLInvalidError extends CoralError {\n-  constructor({\n-    url,\n-    ...properties\n-  }: {\n-    url: string;\n-    allowedDomains: string[];\n-    tenantDomain?: string;\n-  }) {\n-    super({\n-      code: ERROR_CODES.URL_NOT_PERMITTED,\n-      context: { pvt: properties, pub: { url } },\n-    });\n-  }\n-}\n-\n export class StoryURLInvalidError extends CoralError {\n-  constructor(properties: {\n-    storyURL: string;\n-    allowedDomains: string[];\n-    tenantDomain?: string;\n-  }) {\n+  constructor(properties: { storyURL: string; tenantDomain?: string }) {\n     super({\n       code: ERROR_CODES.STORY_URL_NOT_PERMITTED,\n       context: { pvt: properties },\n@@ -303,6 +283,16 @@ export class DuplicateStoryURLError extends CoralError {\n   }\n }\n \n+export class DuplicateSiteAllowedOriginError extends CoralError {\n+  constructor(cause: MongoError, id: string | null, domains?: string[]) {\n+    super({\n+      cause,\n+      code: ERROR_CODES.DUPLICATE_SITE_ORIGIN,\n+      context: { pvt: { id, domains } },\n+    });\n+  }\n+}\n+\n export class DuplicateEmailError extends CoralError {\n   constructor(email: string) {\n     super({ code: ERROR_CODES.DUPLICATE_EMAIL, context: { pvt: { email } } });"
    },
    {
      "sha": "4dd193c6731afddc46b4a03e35df17e65ada98d1",
      "filename": "src/core/server/errors/translations.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/errors/translations.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/errors/translations.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/errors/translations.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -21,7 +21,6 @@ export const ERROR_TRANSLATIONS: Record<ERROR_CODES, string> = {\n   STORY_CLOSED: \"error-storyClosed\",\n   STORY_NOT_FOUND: \"error-storyNotFound\",\n   STORY_URL_NOT_PERMITTED: \"error-storyURLNotPermitted\",\n-  URL_NOT_PERMITTED: \"error-urlNotPermitted\",\n   TENANT_INSTALLED_ALREADY: \"error-tenantInstalledAlready\",\n   TENANT_NOT_FOUND: \"error-tenantNotFound\",\n   TOKEN_INVALID: \"error-tokenInvalid\",\n@@ -59,4 +58,5 @@ export const ERROR_TRANSLATIONS: Record<ERROR_CODES, string> = {\n   REPEAT_POST: \"error-repeatPost\",\n   INSTALLATION_FORBIDDEN: \"error-installationForbidden\",\n   SCRAPE_FAILED: \"error-scrapeFailed\",\n+  DUPLICATE_SITE_ORIGIN: \"error-duplicateSiteOrigin\",\n };"
    },
    {
      "sha": "a9ce5ebeab5dd47d2e25678e5b0c3e6467052d10",
      "filename": "src/core/server/graph/loaders/Comments.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 1,
      "changes": 3,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/loaders/Comments.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/loaders/Comments.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/loaders/Comments.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -18,9 +18,9 @@ import {\n   retrieveRejectedCommentUserConnection,\n   retrieveStoryCommentTagCounts,\n } from \"coral-server/models/comment\";\n+import { retrieveSharedModerationQueueQueuesCounts } from \"coral-server/models/comment/counts/shared\";\n import { hasPublishedStatus } from \"coral-server/models/comment/helpers\";\n import { Connection } from \"coral-server/models/helpers\";\n-import { retrieveSharedModerationQueueQueuesCounts } from \"coral-server/models/story/counts/shared\";\n import { User } from \"coral-server/models/user\";\n \n import {\n@@ -233,6 +233,7 @@ export default (ctx: Context) => ({\n       // The cursor passed here is always going to be a number.\n       before: before as number,\n     }).then(primeCommentsFromConnection(ctx)),\n+\n   sharedModerationQueueQueuesCounts: new SingletonResolver(\n     () =>\n       retrieveSharedModerationQueueQueuesCounts("
    },
    {
      "sha": "0391f277521a40af0b2adfb52142990d60c32ba4",
      "filename": "src/core/server/graph/loaders/Sites.ts",
      "status": "added",
      "additions": 25,
      "deletions": 0,
      "changes": 25,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/loaders/Sites.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/loaders/Sites.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/loaders/Sites.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,25 @@\n+import DataLoader from \"dataloader\";\n+import { defaultTo } from \"lodash\";\n+\n+import TenantContext from \"coral-server/graph/context\";\n+import {\n+  retrieveManySites,\n+  retrieveSiteConnection,\n+  Site,\n+} from \"coral-server/models/site\";\n+\n+import { QueryToSitesArgs } from \"coral-server/graph/schema/__generated__/types\";\n+\n+export default (ctx: TenantContext) => ({\n+  site: new DataLoader<string, Site | null>(\n+    ids => retrieveManySites(ctx.mongo, ctx.tenant.id, ids),\n+    {\n+      cache: !ctx.disableCaching,\n+    }\n+  ),\n+  connection: ({ first, after }: QueryToSitesArgs) =>\n+    retrieveSiteConnection(ctx.mongo, ctx.tenant.id, {\n+      first: defaultTo(first, 20),\n+      after,\n+    }),\n+});"
    },
    {
      "sha": "0a597ee73f85f3cbf89c7f12b89cddf9fd8f8c7a",
      "filename": "src/core/server/graph/loaders/Stories.ts",
      "status": "modified",
      "additions": 12,
      "deletions": 2,
      "changes": 14,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/loaders/Stories.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/loaders/Stories.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/loaders/Stories.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -42,6 +42,15 @@ const statusFilter = (\n   }\n };\n \n+const siteFilter = (siteID?: string): StoryConnectionInput[\"filter\"] => {\n+  if (siteID) {\n+    return {\n+      siteID,\n+    };\n+  }\n+  return {};\n+};\n+\n const queryFilter = (query?: string): StoryConnectionInput[\"filter\"] => {\n   if (query) {\n     return { $text: { $search: query } };\n@@ -102,14 +111,15 @@ export default (ctx: GraphContext) => ({\n       cache: !ctx.disableCaching,\n     }\n   ),\n-  connection: ({ first, after, status, query }: QueryToStoriesArgs) =>\n+  connection: ({ first, after, status, query, siteID }: QueryToStoriesArgs) =>\n     retrieveStoryConnection(ctx.mongo, ctx.tenant.id, {\n       first: defaultTo(first, 10),\n       after,\n       filter: {\n+        // Merge the site filter into the connection filter.\n+        ...siteFilter(siteID),\n         // Merge the status filter into the connection filter.\n         ...statusFilter(status),\n-\n         // Merge the query filters into the query.\n         ...queryFilter(query),\n       },"
    },
    {
      "sha": "2242dee8751613a6fdcf47278b912058c5f7a342",
      "filename": "src/core/server/graph/loaders/index.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/loaders/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/loaders/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/loaders/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -4,6 +4,7 @@ import Auth from \"./Auth\";\n import CommentActions from \"./CommentActions\";\n import CommentModerationActions from \"./CommentModerationActions\";\n import Comments from \"./Comments\";\n+import Sites from \"./Sites\";\n import Stories from \"./Stories\";\n import Users from \"./Users\";\n \n@@ -14,4 +15,5 @@ export default (ctx: Context) => ({\n   Stories: Stories(ctx),\n   Comments: Comments(ctx),\n   Users: Users(ctx),\n+  Sites: Sites(ctx),\n });"
    },
    {
      "sha": "6b9822cdd70851ea2fbdf2763c72164cc6d00216",
      "filename": "src/core/server/graph/mutators/Comments.ts",
      "status": "modified",
      "additions": 9,
      "deletions": 4,
      "changes": 13,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/mutators/Comments.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/mutators/Comments.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/mutators/Comments.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -102,7 +102,7 @@ export const Comments = (ctx: GraphContext) => ({\n       ctx.now\n     ),\n   removeReaction: ({ commentID }: GQLRemoveCommentReactionInput) =>\n-    removeReaction(ctx.mongo, ctx.redis, ctx.tenant, ctx.user!, {\n+    removeReaction(ctx.mongo, ctx.redis, ctx.publisher, ctx.tenant, ctx.user!, {\n       commentID,\n     }),\n   createDontAgree: ({\n@@ -128,9 +128,14 @@ export const Comments = (ctx: GraphContext) => ({\n       ctx.now\n     ),\n   removeDontAgree: ({ commentID }: GQLRemoveCommentDontAgreeInput) =>\n-    removeDontAgree(ctx.mongo, ctx.redis, ctx.tenant, ctx.user!, {\n-      commentID,\n-    }),\n+    removeDontAgree(\n+      ctx.mongo,\n+      ctx.redis,\n+      ctx.publisher,\n+      ctx.tenant,\n+      ctx.user!,\n+      { commentID }\n+    ),\n   createFlag: ({\n     commentID,\n     commentRevisionID,"
    },
    {
      "sha": "ebe14c99e9b303e74e8ea7723655fed6dd46b5e9",
      "filename": "src/core/server/graph/mutators/Sites.ts",
      "status": "added",
      "additions": 14,
      "deletions": 0,
      "changes": 14,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/mutators/Sites.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/mutators/Sites.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/mutators/Sites.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,14 @@\n+import TenantContext from \"coral-server/graph/context\";\n+import {\n+  GQLCreateSiteInput,\n+  GQLUpdateSiteInput,\n+} from \"coral-server/graph/schema/__generated__/types\";\n+import { Site } from \"coral-server/models/site\";\n+import { create, update } from \"coral-server/services/sites\";\n+\n+export const Sites = (ctx: TenantContext) => ({\n+  create: async (input: GQLCreateSiteInput): Promise<Readonly<Site> | null> =>\n+    create(ctx.mongo, ctx.tenant, input.site, ctx.now),\n+  update: async (input: GQLUpdateSiteInput): Promise<Readonly<Site> | null> =>\n+    update(ctx.mongo, ctx.tenant, input.id, input.site, ctx.now),\n+});"
    },
    {
      "sha": "da544faaa1d0fb732d600448cd00f482729c54c9",
      "filename": "src/core/server/graph/mutators/Stories.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 7,
      "changes": 8,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/mutators/Stories.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/mutators/Stories.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/mutators/Stories.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -64,13 +64,7 @@ export const Stories = (ctx: GraphContext) => ({\n   open: (input: GQLOpenStoryInput): Promise<Readonly<Story> | null> =>\n     open(ctx.mongo, ctx.tenant, input.id, ctx.now),\n   merge: async (input: GQLMergeStoriesInput): Promise<Readonly<Story> | null> =>\n-    merge(\n-      ctx.mongo,\n-      ctx.redis,\n-      ctx.tenant,\n-      input.destinationID,\n-      input.sourceIDs\n-    ),\n+    merge(ctx.mongo, ctx.tenant, input.destinationID, input.sourceIDs),\n   remove: async (input: GQLRemoveStoryInput): Promise<Readonly<Story> | null> =>\n     remove(ctx.mongo, ctx.tenant, input.id, input.includeComments),\n   scrape: async (input: GQLScrapeStoryInput): Promise<Readonly<Story> | null> =>"
    },
    {
      "sha": "b093748d87c4d11348dc7ddb430ec3770bf3d058",
      "filename": "src/core/server/graph/mutators/index.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/mutators/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/mutators/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/mutators/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -3,6 +3,7 @@ import GraphContext from \"coral-server/graph/context\";\n import { Actions } from \"./Actions\";\n import { Comments } from \"./Comments\";\n import { Settings } from \"./Settings\";\n+import { Sites } from \"./Sites\";\n import { Stories } from \"./Stories\";\n import { Users } from \"./Users\";\n \n@@ -12,4 +13,5 @@ export default (ctx: GraphContext) => ({\n   Settings: Settings(ctx),\n   Stories: Stories(ctx),\n   Users: Users(ctx),\n+  Sites: Sites(ctx),\n });"
    },
    {
      "sha": "f786d0d626de4c18900a7ae0d4b163d7c15182d1",
      "filename": "src/core/server/graph/resolvers/Comment.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/resolvers/Comment.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/resolvers/Comment.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/resolvers/Comment.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -110,6 +110,7 @@ export const Comment: GQLCommentTypeResolver<comment.Comment> = {\n       ? ctx.loaders.Comments.parents(c, input)\n       : createConnection(),\n   story: (c, input, ctx) => ctx.loaders.Stories.story.load(c.storyID),\n+  site: (c, input, ctx) => ctx.loaders.Sites.site.load(c.siteID),\n   permalink: async ({ id, storyID }, input, ctx) => {\n     const story = await ctx.loaders.Stories.story.load(storyID);\n     if (!story) {"
    },
    {
      "sha": "798f1014b925fe656ab4453639eb27e329f38cc7",
      "filename": "src/core/server/graph/resolvers/CommentCounts.ts",
      "status": "modified",
      "additions": 3,
      "deletions": 4,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/resolvers/CommentCounts.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/resolvers/CommentCounts.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/resolvers/CommentCounts.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,8 +1,7 @@\n+import { calculateTotalPublishedCommentCount } from \"coral-server/models/comment\";\n+import { Story } from \"coral-server/models/story\";\n+\n import { GQLCommentCountsTypeResolver } from \"coral-server/graph/schema/__generated__/types\";\n-import {\n-  calculateTotalPublishedCommentCount,\n-  Story,\n-} from \"coral-server/models/story\";\n \n export type CommentCountsInput = Pick<Story, \"commentCounts\" | \"id\">;\n "
    },
    {
      "sha": "2b96742d9c8d69c2116e93136147fda346801e72",
      "filename": "src/core/server/graph/resolvers/ModerationQueue.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/resolvers/ModerationQueue.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/resolvers/ModerationQueue.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/resolvers/ModerationQueue.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -12,7 +12,7 @@ import {\n export interface ModerationQueueInput {\n   selector: string;\n   connection: Partial<CommentConnectionInput>;\n-  count: number;\n+  count: number | null;\n }\n \n export const ModerationQueue: GQLModerationQueueTypeResolver<"
    },
    {
      "sha": "658712e8b9b5ed6ee8a9ac7919335746edd01fbb",
      "filename": "src/core/server/graph/resolvers/ModerationQueues.ts",
      "status": "modified",
      "additions": 37,
      "deletions": 11,
      "changes": 48,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/resolvers/ModerationQueues.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/resolvers/ModerationQueues.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/resolvers/ModerationQueues.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,20 +1,19 @@\n-import { CommentConnectionInput } from \"coral-server/models/comment\";\n-import { FilterQuery } from \"coral-server/models/helpers\";\n import {\n+  CommentConnectionInput,\n   CommentModerationCountsPerQueue,\n-  Story,\n-} from \"coral-server/models/story\";\n+} from \"coral-server/models/comment\";\n+import { FilterQuery } from \"coral-server/models/helpers\";\n+import { Site } from \"coral-server/models/site\";\n+import { Story } from \"coral-server/models/story\";\n import {\n   PENDING_STATUS,\n   REPORTED_STATUS,\n   UNMODERATED_STATUSES,\n } from \"coral-server/services/comments/moderation/counts\";\n \n import {\n-  ApproveCommentPayloadToModerationQueuesResolver,\n   GQLModerationQueuesTypeResolver,\n   QueryToModerationQueuesResolver,\n-  RejectCommentPayloadToModerationQueuesResolver,\n } from \"coral-server/graph/schema/__generated__/types\";\n \n import GraphContext from \"../context\";\n@@ -37,7 +36,27 @@ const mergeModerationInputFilters = (\n       ...filter,\n     },\n   },\n-  count: input.counts[selector],\n+  count: input.counts ? input.counts[selector] : null,\n+});\n+\n+/**\n+ * siteModerationInputResolver can be used to retrieve the moderationQueue for\n+ * a specific site.\n+ *\n+ * @param site the site that will be used to base the comment moderation\n+ *              queues on\n+ */\n+export const siteModerationInputResolver = async (\n+  site: Site\n+): Promise<ModerationQueuesInput> => ({\n+  connection: {\n+    filter: {\n+      // This moderationQueues is being sourced from the Story, so require\n+      // that all the comments for theses queues are also for this Story.\n+      siteID: site.id,\n+    },\n+  },\n+  counts: site.commentCounts.moderationQueue.queues,\n });\n \n /**\n@@ -55,6 +74,7 @@ export const storyModerationInputResolver = (\n       // This moderationQueues is being sourced from the Story, so require\n       // that all the comments for theses queues are also for this Story.\n       storyID: story.id,\n+      siteID: story.siteID,\n     },\n   },\n   counts: story.commentCounts.moderationQueue.queues,\n@@ -88,10 +108,7 @@ export const sharedModerationInputResolver = async (\n  * @param args the args of the payload containing potentially a Story ID\n  * @param ctx the TenantContext for which we can use to retrieve the shared data\n  */\n-export const moderationQueuesResolver:\n-  | QueryToModerationQueuesResolver\n-  | ApproveCommentPayloadToModerationQueuesResolver\n-  | RejectCommentPayloadToModerationQueuesResolver = async (\n+export const moderationQueuesResolver: QueryToModerationQueuesResolver = async (\n   source,\n   args,\n   ctx\n@@ -105,6 +122,15 @@ export const moderationQueuesResolver:\n     return storyModerationInputResolver(story);\n   }\n \n+  if (args.siteID) {\n+    const site = await ctx.loaders.Sites.site.load(args.siteID);\n+    if (!site) {\n+      return null;\n+    }\n+\n+    return siteModerationInputResolver(site);\n+  }\n+\n   return sharedModerationInputResolver(source, args, ctx);\n };\n "
    },
    {
      "sha": "4a1930f37d60549216fe1e31ffd9450dd33ea722",
      "filename": "src/core/server/graph/resolvers/Mutation.ts",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/resolvers/Mutation.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/resolvers/Mutation.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/resolvers/Mutation.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -243,6 +243,13 @@ export const Mutation: Required<GQLMutationTypeResolver<void>> = {\n   }),\n   deleteAnnouncement: async (source, { input }, ctx) => ({\n     settings: await ctx.mutators.Settings.deleteAnnouncement(),\n+  }),\n+  createSite: async (source, { input }, ctx) => ({\n+    site: await ctx.mutators.Sites.create(input),\n+    clientMutationId: input.clientMutationId,\n+  }),\n+  updateSite: async (source, { input }, ctx) => ({\n+    site: await ctx.mutators.Sites.update(input),\n     clientMutationId: input.clientMutationId,\n   }),\n };"
    },
    {
      "sha": "82c51ac8dcfcc169c03d2ebe828b48e7050c7faa",
      "filename": "src/core/server/graph/resolvers/Query.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/resolvers/Query.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/resolvers/Query.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/resolvers/Query.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -23,4 +23,6 @@ export const Query: Required<GQLQueryTypeResolver<void>> = {\n   moderationQueues: moderationQueuesResolver,\n   activeStories: (source, { limit = 10 }, ctx) =>\n     ctx.loaders.Stories.activeStories(limit),\n+  sites: (source, args, ctx) => ctx.loaders.Sites.connection(args),\n+  site: (source, { id }, ctx) => (id ? ctx.loaders.Sites.site.load(id) : null),\n };"
    },
    {
      "sha": "fe0939ab82404b8f58fe84fef19b9f70530af691",
      "filename": "src/core/server/graph/resolvers/Settings.ts",
      "status": "modified",
      "additions": 5,
      "deletions": 1,
      "changes": 6,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/resolvers/Settings.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/resolvers/Settings.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/resolvers/Settings.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -14,7 +14,7 @@ const filterValidFeatureFlags = () => {\n \n   // Return a type guard for the feature flag.\n   return (flag: string | GQLFEATURE_FLAG): flag is GQLFEATURE_FLAG =>\n-    flags.includes(flag);\n+    flags.includes(flag as GQLFEATURE_FLAG);\n };\n \n export const Settings: GQLSettingsTypeResolver<Tenant> = {\n@@ -23,4 +23,8 @@ export const Settings: GQLSettingsTypeResolver<Tenant> = {\n     featureFlags.filter(filterValidFeatureFlags()),\n   announcement: ({ announcement }) =>\n     retrieveAnnouncementIfEnabled(announcement),\n+  multisite: async ({ id }, input, ctx) => {\n+    const sites = await ctx.loaders.Sites.connection({});\n+    return sites.edges.length > 1;\n+  },\n };"
    },
    {
      "sha": "cef8ef679594fc867ef68a8d152404fd269cade2",
      "filename": "src/core/server/graph/resolvers/Story.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/resolvers/Story.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/resolvers/Story.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/resolvers/Story.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -31,4 +31,5 @@ export const Story: GQLStoryTypeResolver<story.Story> = {\n   // options if they exist.\n   settings: (s, input, ctx) => defaultsDeep({}, s.settings, ctx.tenant),\n   moderationQueues: storyModerationInputResolver,\n+  site: (s, input, ctx) => ctx.loaders.Sites.site.load(s.siteID),\n };"
    },
    {
      "sha": "d7938bb88d0b13d59a0906dcf6630fcd6cf35168",
      "filename": "src/core/server/graph/schema/schema.graphql",
      "status": "modified",
      "additions": 134,
      "deletions": 12,
      "changes": 146,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/schema/schema.graphql",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/graph/schema/schema.graphql",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/schema/schema.graphql?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -388,7 +388,7 @@ type ModerationQueue {\n   \"\"\"\n   count will return the number of Comments that are in this queue.\n   \"\"\"\n-  count: Int!\n+  count: Int\n \n   \"\"\"\n   comments are the comments on the ModerationQueue.\n@@ -1271,11 +1271,6 @@ type Settings {\n   \"\"\"\n   staticURI: String @auth(roles: [ADMIN])\n \n-  \"\"\"\n-  allowedDomains is the list of domains that stories can come from.\n-  \"\"\"\n-  allowedDomains: [String!]! @auth(roles: [ADMIN])\n-\n   \"\"\"\n   locale is the specified locale for this Tenant.\n   \"\"\"\n@@ -1404,6 +1399,10 @@ type Settings {\n   newCommenters: NewCommentersConfiguration! @auth(roles: [ADMIN])\n \n   announcement: Announcement\n+  \"\"\"\n+  multisite is whether multiple sites exist for this tenant.\n+  \"\"\"\n+  multisite: Boolean!\n }\n \n ################################################################################\n@@ -2053,6 +2052,40 @@ type UsersConnection {\n   pageInfo: PageInfo!\n }\n \n+\"\"\"\n+SiteEdge represents a unique Site in a SitesConnection.\n+\"\"\"\n+type SiteEdge {\n+  \"\"\"\n+  node is the Site for this edge.\n+  \"\"\"\n+  node: Site!\n+\n+  \"\"\"\n+  cursor is used in pagination.\n+  \"\"\"\n+  cursor: Cursor!\n+}\n+\n+\"\"\"\n+UsersConnection represents a subset of a stories list.\n+\"\"\"\n+type SitesConnection {\n+  \"\"\"\n+  edges are a subset of SiteEdge's.\n+  \"\"\"\n+  edges: [SiteEdge!]!\n+\n+  \"\"\"\n+  nodes is a list of Site's.\n+  \"\"\"\n+  nodes: [Site!]!\n+\n+  \"\"\"\n+  pageInfo is information to aid in pagination.\n+  \"\"\"\n+  pageInfo: PageInfo!\n+}\n ################################################################################\n ## Comment\n ################################################################################\n@@ -2390,6 +2423,8 @@ type Comment {\n   deleted is whether the comment has been deleted.\n   \"\"\"\n   deleted: Boolean\n+\n+  site: Site!\n }\n \n type PageInfo {\n@@ -2698,6 +2733,11 @@ type Story {\n   lastCommentedAt is the last time someone commented on this story.\n   \"\"\"\n   lastCommentedAt: Time @auth(roles: [ADMIN])\n+\n+  \"\"\"\n+  site is the site associated with the story\n+  \"\"\"\n+  site: Site!\n }\n \n \"\"\"\n@@ -2778,6 +2818,7 @@ type Query {\n     after: Cursor\n     status: STORY_STATUS\n     query: String\n+    siteID: ID\n   ): StoriesConnection! @auth(roles: [ADMIN, MODERATOR])\n \n   \"\"\"\n@@ -2800,6 +2841,11 @@ type Query {\n     status: USER_STATUS\n   ): UsersConnection! @auth(roles: [ADMIN, MODERATOR])\n \n+  site(id: ID): Site @auth(roles: [ADMIN, MODERATOR])\n+\n+  sites(first: Int = 10 @constraint(max: 50), after: Cursor): SitesConnection!\n+    @auth(roles: [ADMIN, MODERATOR])\n+\n   \"\"\"\n   viewer is the current logged in User. If no user is currently logged in, it will\n   return null. This is the only nullable field that can be returned that depends\n@@ -2835,7 +2881,7 @@ type Query {\n   moderationQueues returns the set of ModerationQueues that are available for\n   all stories or if given the story identified by the `storyID`.\n   \"\"\"\n-  moderationQueues(storyID: ID): ModerationQueues!\n+  moderationQueues(storyID: ID, siteID: ID): ModerationQueues!\n     @auth(roles: [ADMIN, MODERATOR])\n \n   \"\"\"\n@@ -3691,11 +3737,6 @@ input SettingsInput {\n   \"\"\"\n   live: LiveConfigurationInput\n \n-  \"\"\"\n-  allowedDomains is the list of domains that stories can come from.\n-  \"\"\"\n-  allowedDomains: [String!]\n-\n   \"\"\"\n   moderation is the moderation mode for all Stories on the site.\n   \"\"\"\n@@ -5854,6 +5895,10 @@ type Mutation {\n   deleteAnnouncement(\n     input: DeleteAnnouncementInput!\n   ): DeleteAnnouncementPayload! @auth(roles: [ADMIN])\n+\n+  createSite(input: CreateSiteInput!): CreateSitePayload! @auth(roles: [ADMIN])\n+\n+  updateSite(input: UpdateSiteInput!): UpdateSitePayload! @auth(roles: [ADMIN])\n }\n \n ##################\n@@ -6038,3 +6083,80 @@ type Subscription {\n   commentFeatured(storyID: ID!): CommentFeaturedPayload!\n     @auth(roles: [MODERATOR, ADMIN])\n }\n+\n+type Site {\n+  \"\"\"\n+  id is the identifier of the Site.\n+  \"\"\"\n+  id: ID!\n+\n+  \"\"\"\n+  name is the name of the Site.\n+  \"\"\"\n+  name: String!\n+\n+  \"\"\"\n+  allowedOrigins are the allowed origins for embeds.\n+  \"\"\"\n+  allowedOrigins: [String!]!\n+\n+  \"\"\"\n+  createdAt is when the site was created.\n+  \"\"\"\n+  createdAt: Time!\n+}\n+\n+input CreateSite {\n+  \"\"\"\n+  name is the name of the Site.\n+  \"\"\"\n+  name: String!\n+\n+  \"\"\"\n+  allowedOrigins are the allowed origins for embeds.\n+  \"\"\"\n+  allowedOrigins: [String!]!\n+}\n+\n+input UpdateSite {\n+  \"\"\"\n+  name is the name of the Site.\n+  \"\"\"\n+  name: String\n+\n+  \"\"\"\n+  url is the Site URL, seen in email communications.\n+  \"\"\"\n+  url: String\n+\n+  \"\"\"\n+  contactEmail is the contact email for the Site, seen in email communications.\n+  \"\"\"\n+  contactEmail: String\n+\n+  \"\"\"\n+  allowedOrigins are the allowed origins for embeds.\n+  \"\"\"\n+  allowedOrigins: [String!]\n+}\n+\n+input CreateSiteInput {\n+  clientMutationId: String!\n+  site: CreateSite!\n+}\n+\n+type CreateSitePayload {\n+  clientMutationId: String!\n+  site: Site!\n+}\n+\n+input UpdateSiteInput {\n+  clientMutationId: String!\n+  site: UpdateSite!\n+  id: ID!\n+}\n+\n+type UpdateSitePayload {\n+  clientMutationId: String!\n+  site: Site!\n+}"
    },
    {
      "sha": "b1e103173f19b6df56bbb96793bfe3ba10464d21",
      "filename": "src/core/server/locales/da/errors.ftl",
      "status": "modified",
      "additions": 0,
      "deletions": 1,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/locales/da/errors.ftl",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/locales/da/errors.ftl",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/locales/da/errors.ftl?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -3,7 +3,6 @@ error-storyClosed = Det er ikke muligt at kommentere dette lige nu.\n error-commenatBodyTooShort = Kommentaren skal have mindst {$ min} tegn.\n error-commentBodyExceedsMaxLength = Kommentaren overskrider den maksimale længde på {$ max} tegn.\n error-storyURLNotPermitted = Den angivne historie-URL findes ikke på listen over tilladte domæner.\n-error-urlNotPermitted = Denne URL ({$ url}) er ikke tilladt.\n error-duplicateStoryURL =  Denne URL-adresse findes allerede.\n error-tenantNotFound = ({$ værtsnavn}) ikke fundet.\n error-userNotFound = Bruger ({$userID}) eksisterer ikke."
    },
    {
      "sha": "82e52015fc94e26a76c53698f0bd2641a84efab1",
      "filename": "src/core/server/locales/en-US/errors.ftl",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/locales/en-US/errors.ftl",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/locales/en-US/errors.ftl",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/locales/en-US/errors.ftl?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -5,7 +5,6 @@ error-commentBodyExceedsMaxLength =\n   Comment body exceeds maximum length of {$max} characters.\n error-storyURLNotPermitted =\n   The specified story URL does not exist in the permitted domains list.\n-error-urlNotPermitted = The specified URL ({$url}) is not permitted.\n error-duplicateStoryURL =  The specified story URL already exists.\n error-tenantNotFound = Tenant hostname ({$hostname}) not found.\n error-userNotFound = User ({$userID}) not found.\n@@ -60,3 +59,4 @@ error-rawQueryNotAuthorized = You are not authorized to execute this query.\n error-inviteIncludesExistingUser = A user with the email address { $email } already exists.\n error-repeatPost = Are you sure? This comment is very similar to your previous comment.\n error-installationForbidden = { -product-name } is already installed. To install another Tenant on this domain ({ $domain }) you need to generate an installation token.\n+error-duplicateSiteOrigin = Allowed domains may only be associated with a single site."
    },
    {
      "sha": "9c22968d0bd3b3b8b4375c76fc8614c607bee397",
      "filename": "src/core/server/locales/fi-FI/errors.ftl",
      "status": "modified",
      "additions": 1,
      "deletions": 2,
      "changes": 3,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/locales/fi-FI/errors.ftl",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/locales/fi-FI/errors.ftl",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/locales/fi-FI/errors.ftl?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -5,7 +5,6 @@ error-commentBodyExceedsMaxLength =\n   Kommenttisi on liian pitkä. Se voi olla korkeintaan {$max} merkkiä.\n error-storyURLNotPermitted =\n   The specified story URL does not exist in the permitted domains list.\n-error-urlNotPermitted = The specified URL ({$url}) is not permitted.\n error-duplicateStoryURL =  The specified story URL already exists.\n error-tenantNotFound = Tenant hostname ({$hostname}) not found.\n error-userNotFound = Käyttäjää ({$userID}) ei löydy.\n@@ -59,4 +58,4 @@ error-persistedQueryNotFound = The persisted query with ID { $id } was not found\n error-rawQueryNotAuthorized = You are not authorized to execute this query.\n error-inviteIncludesExistingUser = A user with the email address { $email } already exists.\n error-repeatPost = Oletko varma, että haluat lähettää? Kirjoittamasi kommentti näyttää hyvin samanlaiselta kuin aiempi kommenttisi.\n-error-installationForbidden = { -product-name } is already installed. To install another Tenant on this domain ({ $domain }) you need to generate an installation token.\n\\ No newline at end of file\n+error-installationForbidden = { -product-name } is already installed. To install another Tenant on this domain ({ $domain }) you need to generate an installation token."
    },
    {
      "sha": "58e6539ce5db4a9f9726480bbbc5c6b4a32dc4f5",
      "filename": "src/core/server/locales/fr-FR/errors.ftl",
      "status": "modified",
      "additions": 0,
      "deletions": 1,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/locales/fr-FR/errors.ftl",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/locales/fr-FR/errors.ftl",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/locales/fr-FR/errors.ftl?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -5,7 +5,6 @@ error-commentBodyExceedsMaxLength =\n   Le commentaire ne doit pas dépasser {$max} caractères.\n error-storyURLNotPermitted =\n   L'URL de l'article n'existe pas dans les domaines autorisés.\n-error-urlNotPermitted = L'url spécifiée : ({$url}) n'est pas autorisée.\n error-duplicateStoryURL = L'url spécifiée existe déjà.\n error-tenantNotFound = Le nom d'hôte ({$hostname}) n'a pas été trouvé.\n error-userNotFound = L'utilisateur ({$userID}) n'a pas été trouvé."
    },
    {
      "sha": "be307cb67a412b257510cf2f55c8c128e04c1fe4",
      "filename": "src/core/server/locales/pt-BR/errors.ftl",
      "status": "modified",
      "additions": 0,
      "deletions": 1,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/locales/pt-BR/errors.ftl",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/locales/pt-BR/errors.ftl",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/locales/pt-BR/errors.ftl?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -5,7 +5,6 @@ error-commentBodyExceedsMaxLength =\n   O corpo do comentário excede o comprimento máximo de {$max} caracteres.\n error-storyURLNotPermitted =\n   A URL da história especificada não existe na lista de domínios permitidos.\n-error-urlNotPermitted = A URL especificada ({$url}) não é permitida.\n error-duplicateStoryURL =  A URL da história especificada já existe.\n error-tenantNotFound = Hostname do tenant ({$hostname}) não encontrado.\n error-userNotFound = Usuário ({$userID}) não encontrado."
    },
    {
      "sha": "26306666bbad2c4db221645e162300c11489c1d9",
      "filename": "src/core/server/models/action/comment.spec.ts",
      "status": "modified",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/action/comment.spec.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/action/comment.spec.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/action/comment.spec.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -127,6 +127,7 @@ describe(\"#filterDuplicateActions\", () => {\n     const actions: CreateActionInput[] = [\n       {\n         storyID: \"1\",\n+        siteID: \"1\",\n         actionType: ACTION_TYPE.FLAG,\n         reason: GQLCOMMENT_FLAG_REASON.COMMENT_DETECTED_BANNED_WORD,\n         commentID: \"1\",\n@@ -135,6 +136,7 @@ describe(\"#filterDuplicateActions\", () => {\n       },\n       {\n         storyID: \"1\",\n+        siteID: \"1\",\n         actionType: ACTION_TYPE.FLAG,\n         reason: GQLCOMMENT_FLAG_REASON.COMMENT_DETECTED_BANNED_WORD,\n         commentID: \"1\",\n@@ -143,6 +145,7 @@ describe(\"#filterDuplicateActions\", () => {\n       },\n       {\n         storyID: \"1\",\n+        siteID: \"1\",\n         actionType: ACTION_TYPE.FLAG,\n         reason: GQLCOMMENT_FLAG_REASON.COMMENT_DETECTED_SUSPECT_WORD,\n         commentID: \"1\","
    },
    {
      "sha": "56ccee8c7dc2f2f2761b6ea0f175966a40dac395",
      "filename": "src/core/server/models/action/comment.ts",
      "status": "modified",
      "additions": 6,
      "deletions": 1,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/action/comment.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/action/comment.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/action/comment.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -113,6 +113,11 @@ export interface CommentAction extends TenantResource {\n    */\n   storyID: string;\n \n+  /**\n+   * siteID represents the ID of the Site where the comment was left on.\n+   */\n+  siteID: string;\n+\n   /**\n    * userID is the ID of the User that left this Action. In the event that the\n    * Action was left by Coral, it will be null.\n@@ -474,7 +479,7 @@ export function invertEncodedActionCounts(\n  * encodeActionCountKeys encodes the action into string keys which represents\n  * the groupings as seen in `EncodedActionCounts`.\n  */\n-function encodeActionCountKeys(\n+export function encodeActionCountKeys(\n   action: Pick<CommentAction, \"actionType\" | \"reason\">\n ): string[] {\n   const keys = [action.actionType as string];"
    },
    {
      "sha": "67652fcb04720de625bcb88fab5ee2f73511cbba",
      "filename": "src/core/server/models/comment/comment.ts",
      "status": "modified",
      "additions": 8,
      "deletions": 6,
      "changes": 14,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/comment/comment.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/comment/comment.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/comment/comment.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -33,11 +33,8 @@ import {\n } from \"coral-server/graph/schema/__generated__/types\";\n \n import { PUBLISHED_STATUSES } from \"./constants\";\n-import {\n-  CommentStatusCounts,\n-  createEmptyCommentStatusCounts,\n-  hasAncestors,\n-} from \"./helpers\";\n+import { CommentStatusCounts, createEmptyCommentStatusCounts } from \"./counts\";\n+import { hasAncestors } from \"./helpers\";\n import { Revision } from \"./revision\";\n import { CommentTag } from \"./tag\";\n \n@@ -78,6 +75,11 @@ export interface Comment extends TenantResource {\n    */\n   storyID: string;\n \n+  /**\n+   * siteID stores the ID of the Site that this Comment was left on.\n+   */\n+  siteID: string;\n+\n   /**\n    * revisions stores all the revisions of the Comment body including the most\n    * recent revision, the last revision is the most recent.\n@@ -138,7 +140,7 @@ export type CreateCommentInput = Omit<\n > &\n   Required<Pick<Revision, \"body\">> &\n   Pick<Revision, \"metadata\"> &\n-  Partial<Pick<Comment, \"actionCounts\">>;\n+  Partial<Pick<Comment, \"actionCounts\" | \"siteID\">>;\n \n export async function createComment(\n   mongo: Db,"
    },
    {
      "sha": "1a8bf3ce13e80ad6f1dd7a1fc9e771eda1089dcc",
      "filename": "src/core/server/models/comment/counts/counts.ts",
      "status": "renamed",
      "additions": 91,
      "deletions": 104,
      "changes": 195,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/comment/counts/counts.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/comment/counts/counts.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/comment/counts/counts.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,24 +1,18 @@\n-export * from \"./empty\";\n-export * from \"./shared\";\n-\n import { identity, isEmpty, pickBy } from \"lodash\";\n-import { Db } from \"mongodb\";\n+import { Collection } from \"mongodb\";\n \n import { DeepPartial } from \"coral-common/types\";\n import { dotize } from \"coral-common/utils/dotize\";\n-import { GQLCOMMENT_STATUS } from \"coral-server/graph/schema/__generated__/types\";\n import logger from \"coral-server/logger\";\n import { EncodedCommentActionCounts } from \"coral-server/models/action/comment\";\n import { PUBLISHED_STATUSES } from \"coral-server/models/comment/constants\";\n+\n+import { GQLCOMMENT_STATUS } from \"coral-server/graph/schema/__generated__/types\";\n+\n import {\n-  CommentStatusCounts,\n+  createEmptyCommentModerationQueueCounts,\n   createEmptyCommentStatusCounts,\n-} from \"coral-server/models/comment/helpers\";\n-import { retrieveStory, Story } from \"coral-server/models/story\";\n-import { stories as collection } from \"coral-server/services/mongodb/collections\";\n-import { AugmentedRedis } from \"coral-server/services/redis\";\n-\n-import { updateSharedCommentCounts } from \"./shared\";\n+} from \"./empty\";\n \n /**\n  * CommentModerationCountsPerQueue stores the number of Comments that exist in\n@@ -60,117 +54,49 @@ export interface CommentModerationQueueCounts {\n   queues: CommentModerationCountsPerQueue;\n }\n \n+// TODO: (wyattjoh) write a test to verify that this set of counts is always in sync with GQLCOMMENT_STATUS.\n+\n+/**\n+ * CommentStatusCounts stores the count of Comments that have the particular\n+ * statuses.\n+ */\n+export interface CommentStatusCounts {\n+  [GQLCOMMENT_STATUS.APPROVED]: number;\n+  [GQLCOMMENT_STATUS.NONE]: number;\n+  [GQLCOMMENT_STATUS.PREMOD]: number;\n+  [GQLCOMMENT_STATUS.REJECTED]: number;\n+  [GQLCOMMENT_STATUS.SYSTEM_WITHHELD]: number;\n+}\n+\n /**\n- * StoryCommentCounts stores all the Comment Counts that will be stored on each\n- * Story.\n+ * RelatedCommentCounts stores all the Comment Counts that will be stored on\n+ * each related document (like a Story, or a Site).\n  */\n-export interface StoryCommentCounts {\n+export interface RelatedCommentCounts {\n   /**\n-   * actionCounts stores all the action counts for all Comment's on this Story.\n+   * actionCounts stores all the action counts for all Comment's on this related\n+   * document.\n    */\n   action: EncodedCommentActionCounts;\n \n   /**\n-   * commentCounts stores the different counts for each comment on the Story\n-   * according to their statuses.\n+   * commentCounts stores the different counts for each comment on the related\n+   * document according to their statuses.\n    */\n   status: CommentStatusCounts;\n \n   /**\n-   * moderationQueue stores the number of Comments that exist in\n-   * each of the ModerationQueue's on this Story.\n+   * moderationQueue stores the number of Comments that exist in each of the\n+   * ModerationQueue's on this related document.\n    */\n   moderationQueue: CommentModerationQueueCounts;\n }\n \n-/**\n- * updateStoryCommentStatusCount will update a given Story's status counts.\n- *\n- * @param mongo database handle\n- * @param redis redis database handle\n- * @param tenantID ID of the Tenant where this Story is\n- * @param id ID of the Story where we're updating the counts\n- * @param status the set of counts that we will update\n- */\n-export const updateStoryCommentStatusCount = (\n-  mongo: Db,\n-  redis: AugmentedRedis,\n-  tenantID: string,\n-  id: string,\n-  status: Partial<CommentStatusCounts>\n-) => updateStoryCounts(mongo, redis, tenantID, id, { status });\n-\n-/**\n- * updateStoryCommentModerationQueueCounts will update the moderation queue\n- * counts on a Story.\n- *\n- * @param mongo mongo database handle\n- * @param redis redis database handle\n- * @param tenantID ID of the Tenant where this Story is\n- * @param id ID of the Story where we're updating the counts\n- * @param moderationQueue the set of counts that we will update\n- */\n-export const updateStoryCommentModerationQueueCounts = (\n-  mongo: Db,\n-  redis: AugmentedRedis,\n-  tenantID: string,\n-  id: string,\n-  moderationQueue: DeepPartial<CommentModerationQueueCounts>\n-) => updateStoryCounts(mongo, redis, tenantID, id, { moderationQueue });\n-\n-export const updateStoryActionCounts = (\n-  mongo: Db,\n-  redis: AugmentedRedis,\n-  tenantID: string,\n-  id: string,\n-  action: EncodedCommentActionCounts\n-) => updateStoryCounts(mongo, redis, tenantID, id, { action });\n-\n-/**\n- * updateStoryCounts will update the comment counts for the story indicated.\n- *\n- * @param mongo mongodb database handle\n- * @param redis redis database handle\n- * @param tenantID ID of the Tenant where the Story is on\n- * @param id the ID of the Story that we are updating counts on\n- * @param commentCounts the counts that we are updating\n- */\n-export async function updateStoryCounts(\n-  mongo: Db,\n-  redis: AugmentedRedis,\n-  tenantID: string,\n-  id: string,\n-  commentCounts: DeepPartial<StoryCommentCounts>\n-) {\n-  // Update all the specific comment moderation queue counts.\n-  const update: DeepPartial<Story> = { commentCounts };\n-  const $inc = pickBy(dotize(update), identity);\n-  if (isEmpty($inc)) {\n-    // Nothing needs to be incremented, just return the story.\n-    return retrieveStory(mongo, tenantID, id);\n-  }\n-\n-  logger.trace({ update: { $inc } }, \"incrementing story counts\");\n-\n-  const result = await collection(mongo).findOneAndUpdate(\n-    { id, tenantID },\n-    { $inc },\n-    // False to return the updated document instead of the original\n-    // document.\n-    { returnOriginal: false }\n-  );\n-\n-  // Update the shared counts.\n-  await updateSharedCommentCounts(redis, tenantID, commentCounts);\n-\n-  return result.value || null;\n-}\n-\n /**\n  * mergeCommentStatusCount will merge an array of commentStatusCount's into one.\n  */\n export function mergeCommentStatusCount(\n-  statusCounts: CommentStatusCounts[]\n+  ...statusCounts: CommentStatusCounts[]\n ): CommentStatusCounts {\n   const mergedStatusCounts = createEmptyCommentStatusCounts();\n   for (const commentCounts of statusCounts) {\n@@ -197,6 +123,21 @@ export function mergeCommentStatusCount(\n   return mergedStatusCounts;\n }\n \n+export function mergeCommentModerationQueueCount(\n+  ...moderationQueues: CommentModerationQueueCounts[]\n+): CommentModerationQueueCounts {\n+  const merged = createEmptyCommentModerationQueueCounts();\n+\n+  for (const moderationQueue of moderationQueues) {\n+    merged.total += moderationQueue.total;\n+    merged.queues.unmoderated += moderationQueue.queues.unmoderated;\n+    merged.queues.pending += moderationQueue.queues.pending;\n+    merged.queues.reported += moderationQueue.queues.reported;\n+  }\n+\n+  return merged;\n+}\n+\n /**\n  * calculateTotalCommentCount will compute the total amount of comments left on\n  * an Asset by parsing the `CommentStatusCounts`.\n@@ -239,3 +180,49 @@ export function calculateTotalPublishedCommentCount(\n     0\n   );\n }\n+\n+interface RelatedCommentCountsDocument {\n+  id: string;\n+  tenantID: string;\n+  commentCounts: Partial<RelatedCommentCounts>;\n+}\n+\n+export async function updateRelatedCommentCounts<\n+  T extends RelatedCommentCountsDocument\n+>(\n+  collection: Collection<T>,\n+  tenantID: string,\n+  id: string,\n+  commentCounts: DeepPartial<RelatedCommentCounts>\n+) {\n+  // Update all the specific comment moderation queue counts.\n+  const update: DeepPartial<RelatedCommentCountsDocument> = { commentCounts };\n+\n+  // For each of the paths that we can update, we want to reduce it to a flat\n+  // object that's dotted (via dotize). We then use the `pickBy` with `identity`\n+  // to remove all the increment operations that are zero. This should leave\n+  // only increments that are positive or negative numbers.\n+  const $inc = pickBy(dotize(update), identity);\n+\n+  // If th object is empty, then we don't actually have anything to increment,\n+  // lets return the object directly to stay consistent with the return API.\n+  if (isEmpty($inc)) {\n+    // Nothing needs to be incremented, just return the story.\n+    return collection.findOne({ id, tenantID });\n+  }\n+\n+  logger.trace(\n+    { collection: collection.collectionName, tenantID, id, update: { $inc } },\n+    \"updating related comment counts\"\n+  );\n+\n+  const result = await collection.findOneAndUpdate(\n+    { id, tenantID },\n+    { $inc },\n+    // False to return the updated document instead of the original\n+    // document.\n+    { returnOriginal: false }\n+  );\n+\n+  return result.value || null;\n+}",
      "previous_filename": "src/core/server/models/story/counts/index.ts"
    },
    {
      "sha": "c90639f5e49076c35c8ba3a74f2b29ecd8f9a202",
      "filename": "src/core/server/models/comment/counts/empty.ts",
      "status": "added",
      "additions": 41,
      "deletions": 0,
      "changes": 41,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/comment/counts/empty.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/comment/counts/empty.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/comment/counts/empty.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,41 @@\n+import { GQLCOMMENT_STATUS } from \"coral-server/graph/schema/__generated__/types\";\n+\n+import {\n+  CommentModerationCountsPerQueue,\n+  CommentModerationQueueCounts,\n+  CommentStatusCounts,\n+  RelatedCommentCounts,\n+} from \"./counts\";\n+\n+export function createEmptyCommentModerationCountsPerQueue(): CommentModerationCountsPerQueue {\n+  return {\n+    unmoderated: 0,\n+    reported: 0,\n+    pending: 0,\n+  };\n+}\n+\n+export function createEmptyCommentModerationQueueCounts(): CommentModerationQueueCounts {\n+  return {\n+    total: 0,\n+    queues: createEmptyCommentModerationCountsPerQueue(),\n+  };\n+}\n+\n+export function createEmptyCommentStatusCounts(): CommentStatusCounts {\n+  return {\n+    [GQLCOMMENT_STATUS.APPROVED]: 0,\n+    [GQLCOMMENT_STATUS.NONE]: 0,\n+    [GQLCOMMENT_STATUS.PREMOD]: 0,\n+    [GQLCOMMENT_STATUS.REJECTED]: 0,\n+    [GQLCOMMENT_STATUS.SYSTEM_WITHHELD]: 0,\n+  };\n+}\n+\n+export function createEmptyRelatedCommentCounts(): RelatedCommentCounts {\n+  return {\n+    action: {},\n+    status: createEmptyCommentStatusCounts(),\n+    moderationQueue: createEmptyCommentModerationQueueCounts(),\n+  };\n+}"
    },
    {
      "sha": "fae182b4daf5f0188637584d22f147ad4fd69bdc",
      "filename": "src/core/server/models/comment/counts/index.ts",
      "status": "added",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/comment/counts/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/comment/counts/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/comment/counts/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,3 @@\n+export * from \"./counts\";\n+export * from \"./empty\";\n+export * from \"./shared\";"
    },
    {
      "sha": "4676d7c96ce02bef8e433866b3b2499a0e12f024",
      "filename": "src/core/server/models/comment/counts/shared.ts",
      "status": "renamed",
      "additions": 21,
      "deletions": 39,
      "changes": 60,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/comment/counts/shared.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/comment/counts/shared.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/comment/counts/shared.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -2,13 +2,13 @@ import { flatten, flattenDeep, identity, isEmpty, pickBy } from \"lodash\";\n import { Db } from \"mongodb\";\n import ms from \"ms\";\n \n-import { DeepPartial } from \"coral-common/types\";\n+import { FirstDeepPartial } from \"coral-common/types\";\n import logger from \"coral-server/logger\";\n import {\n   CommentModerationCountsPerQueue,\n-  StoryCommentCounts,\n-} from \"coral-server/models/story/counts\";\n-import { stories as collection } from \"coral-server/services/mongodb/collections\";\n+  RelatedCommentCounts,\n+} from \"coral-server/models/comment/counts\";\n+import { sites } from \"coral-server/services/mongodb/collections\";\n import { AugmentedPipeline, AugmentedRedis } from \"coral-server/services/redis\";\n \n import {\n@@ -29,18 +29,19 @@ const COUNT_FRESHNESS_EXPIRY_SECONDS = Math.floor(ms(\"24h\") / 1000);\n \n const freshenKey = (key: string) => `${key}:fresh`;\n \n-const commentCountsActionKey = (tenantID: string) =>\n-  `${tenantID}:commentCounts:action`;\n-\n-const commentCountsStatusKey = (tenantID: string) =>\n-  `${tenantID}:commentCounts:status`;\n-\n const commentCountsModerationQueueTotalKey = (tenantID: string) =>\n   `${tenantID}:commentCounts:moderationQueue:total`;\n \n const commentCountsModerationQueueQueuesKey = (tenantID: string) =>\n   `${tenantID}:commentCounts:moderationQueue:queues`;\n \n+interface SharedModerationQueueCountsMatch {\n+  tenantID: string;\n+  createdAt: {\n+    $lt: Date;\n+  };\n+}\n+\n /**\n  * recalculateSharedModerationQueueQueueCounts will reset the counts stored for\n  * this Tenant.\n@@ -61,13 +62,18 @@ export async function recalculateSharedModerationQueueQueueCounts(\n   // Clear the existing cached queues.\n   await redis.del(key, freshKey);\n \n+  const match: SharedModerationQueueCountsMatch = {\n+    tenantID,\n+    createdAt: { $lt: now },\n+  };\n+\n   // Fetch all the moderation queue counts.\n-  const queueResults = collection<{\n+  const queueResults = sites<{\n     _id: string;\n     total: number;\n   }>(mongo).aggregate([\n     {\n-      $match: { tenantID, createdAt: { $lt: now } },\n+      $match: match,\n     },\n     {\n       $project: {\n@@ -181,34 +187,11 @@ export async function retrieveSharedModerationQueueQueuesCounts(\n export async function updateSharedCommentCounts(\n   redis: AugmentedRedis,\n   tenantID: string,\n-  commentCounts: DeepPartial<StoryCommentCounts>\n+  commentCounts: FirstDeepPartial<RelatedCommentCounts>\n ) {\n   const pipeline: AugmentedPipeline = redis.pipeline();\n \n-  // HASH ${tenantID}:commentCounts:action\n-\n-  const action = pickBy(commentCounts.action || {}, identity);\n-  if (!isEmpty(action)) {\n-    // Determine the arguments that we will increment.\n-    const args = flattenDeep(Object.entries(action));\n-\n-    // Add the command to the pipeline.\n-    pipeline.mhincrby(commentCountsActionKey(tenantID), ...args);\n-  }\n-\n-  // HASH ${tenantID}:commentCounts:status\n-\n-  const status = pickBy(commentCounts.status || {}, identity);\n-  if (!isEmpty(status)) {\n-    // Determine the arguments that we will increment.\n-    const args = flattenDeep(Object.entries(status));\n-\n-    // Add the command to the pipeline.\n-    pipeline.mhincrby(commentCountsStatusKey(tenantID), ...args);\n-  }\n-\n-  // HASH ${tenantID}:commentCounts:moderationQueue:total\n-\n+  // Update the moderation queue total.\n   const moderationQueue = commentCounts.moderationQueue || {};\n   const moderationQueueTotal =\n     typeof moderationQueue.total === \"number\" ? moderationQueue.total : 0;\n@@ -220,8 +203,7 @@ export async function updateSharedCommentCounts(\n     );\n   }\n \n-  // HASH ${tenantID}:commentCounts:moderationQueue:queues\n-\n+  // Update the moderation queue counts.\n   const moderationQueueQueues = pickBy(moderationQueue.queues || {}, identity);\n   if (!isEmpty(moderationQueueQueues)) {\n     // Determine the arguments that we will increment.",
      "previous_filename": "src/core/server/models/story/counts/shared.ts"
    },
    {
      "sha": "98ac0d3f66c9d798d034d47a3c07eecfc2d11d8d",
      "filename": "src/core/server/models/comment/helpers.ts",
      "status": "modified",
      "additions": 4,
      "deletions": 25,
      "changes": 29,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/comment/helpers.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/comment/helpers.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/comment/helpers.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -3,9 +3,12 @@ import {\n   GQLTAG,\n } from \"coral-server/graph/schema/__generated__/types\";\n \n-import { calculateTotalPublishedCommentCount } from \"../story\";\n import { Comment } from \"./comment\";\n import { MODERATOR_STATUSES, PUBLISHED_STATUSES } from \"./constants\";\n+import {\n+  calculateTotalPublishedCommentCount,\n+  CommentStatusCounts,\n+} from \"./counts\";\n import { Revision } from \"./revision\";\n \n /**\n@@ -44,30 +47,6 @@ export function getLatestRevision(\n   return comment.revisions[comment.revisions.length - 1];\n }\n \n-// TODO: (wyattjoh) write a test to verify that this set of counts is always in sync with GQLCOMMENT_STATUS.\n-\n-/**\n- * CommentStatusCounts stores the count of Comments that have the particular\n- * statuses.\n- */\n-export interface CommentStatusCounts {\n-  [GQLCOMMENT_STATUS.APPROVED]: number;\n-  [GQLCOMMENT_STATUS.NONE]: number;\n-  [GQLCOMMENT_STATUS.PREMOD]: number;\n-  [GQLCOMMENT_STATUS.REJECTED]: number;\n-  [GQLCOMMENT_STATUS.SYSTEM_WITHHELD]: number;\n-}\n-\n-export function createEmptyCommentStatusCounts(): CommentStatusCounts {\n-  return {\n-    [GQLCOMMENT_STATUS.APPROVED]: 0,\n-    [GQLCOMMENT_STATUS.NONE]: 0,\n-    [GQLCOMMENT_STATUS.PREMOD]: 0,\n-    [GQLCOMMENT_STATUS.REJECTED]: 0,\n-    [GQLCOMMENT_STATUS.SYSTEM_WITHHELD]: 0,\n-  };\n-}\n-\n export function calculateRejectionRate(counts: CommentStatusCounts): number {\n   const published = calculateTotalPublishedCommentCount(counts);\n   const rejected = counts[GQLCOMMENT_STATUS.REJECTED];"
    },
    {
      "sha": "341c3945b0c13048b5dc847f4d2be7a0afe9bbdb",
      "filename": "src/core/server/models/comment/index.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/comment/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/comment/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/comment/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,3 +1,4 @@\n export * from \"./comment\";\n export * from \"./revision\";\n export * from \"./helpers\";\n+export * from \"./counts\";"
    },
    {
      "sha": "4f3220d0d70a3b49190fa1d6a8c995972da203f8",
      "filename": "src/core/server/models/site/index.ts",
      "status": "added",
      "additions": 175,
      "deletions": 0,
      "changes": 175,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/site/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/site/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/site/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,175 @@\n+import { identity, isNumber } from \"lodash\";\n+import { Db, MongoError } from \"mongodb\";\n+import uuid from \"uuid\";\n+\n+import { FirstDeepPartial, Omit } from \"coral-common/types\";\n+import { getOrigin } from \"coral-server/app/url\";\n+import { DuplicateSiteAllowedOriginError } from \"coral-server/errors\";\n+import {\n+  Connection,\n+  ConnectionInput,\n+  Query,\n+  resolveConnection,\n+} from \"coral-server/models/helpers\";\n+import { TenantResource } from \"coral-server/models/tenant\";\n+import { sites as collection } from \"coral-server/services/mongodb/collections\";\n+\n+import {\n+  createEmptyRelatedCommentCounts,\n+  RelatedCommentCounts,\n+  updateRelatedCommentCounts,\n+} from \"../comment\";\n+\n+export interface Site extends TenantResource {\n+  readonly id: string;\n+  name: string;\n+  allowedOrigins: string[];\n+  commentCounts: RelatedCommentCounts;\n+  createdAt: Date;\n+}\n+\n+export type CreateSiteInput = Omit<Site, \"id\" | \"commentCounts\" | \"createdAt\">;\n+\n+export type SiteConnectionInput = ConnectionInput<Site>;\n+\n+export function getURLOrigins(urls: ReadonlyArray<string>) {\n+  return urls.map(url => getOrigin(url)).filter(identity) as string[];\n+}\n+\n+/**\n+ * create will create a new Site.\n+ *\n+ * @param mongo the MongoDB connection used to create the Site.\n+ * @param input the customizable parts of the Site available during creation\n+ */\n+export async function createSite(\n+  mongo: Db,\n+  input: CreateSiteInput,\n+  now = new Date()\n+): Promise<Readonly<Site>> {\n+  const site: Site = {\n+    ...input,\n+    id: uuid.v4(),\n+    commentCounts: createEmptyRelatedCommentCounts(),\n+    createdAt: now,\n+  };\n+\n+  try {\n+    await collection(mongo).insertOne(site);\n+    return site;\n+  } catch (err) {\n+    // Evaluate the error, if it is in regards to violating the unique index,\n+    // then return a duplicate Story error.\n+    if (err instanceof MongoError && err.code === 11000) {\n+      throw new DuplicateSiteAllowedOriginError(\n+        err,\n+        null,\n+        input.allowedOrigins\n+      );\n+    }\n+\n+    throw err;\n+  }\n+}\n+\n+export async function retrieveSite(mongo: Db, tenantID: string, id: string) {\n+  return collection(mongo).findOne({ id, tenantID });\n+}\n+\n+export async function retrieveTenantSites(mongo: Db, tenantID: string) {\n+  const cursor = collection(mongo).find({ tenantID });\n+  return cursor.toArray();\n+}\n+\n+export async function retrieveManySites(\n+  mongo: Db,\n+  tenantID: string,\n+  ids: string[]\n+) {\n+  const cursor = collection(mongo).find({\n+    id: { $in: ids },\n+    tenantID,\n+  });\n+  const sites = await cursor.toArray();\n+\n+  return ids.map(id => sites.find(site => site.id === id) || null);\n+}\n+\n+export async function retrieveSiteByOrigin(\n+  mongo: Db,\n+  tenantID: string,\n+  origin: string\n+) {\n+  return collection(mongo).findOne({\n+    tenantID,\n+    allowedOrigins: origin,\n+  });\n+}\n+\n+async function retrieveConnection(\n+  input: SiteConnectionInput,\n+  query: Query<Site>\n+): Promise<Readonly<Connection<Readonly<Site>>>> {\n+  // Apply the pagination arguments to the query.\n+  query.orderBy({ name: 1 });\n+  const skip = isNumber(input.after) ? input.after : 0;\n+  if (skip) {\n+    query.after(skip);\n+  }\n+\n+  // Return a connection.\n+  return resolveConnection(query, input, (_, index) => index + skip + 1);\n+}\n+\n+export async function retrieveSiteConnection(\n+  mongo: Db,\n+  tenantID: string,\n+  input: SiteConnectionInput\n+): Promise<Readonly<Connection<Readonly<Site>>>> {\n+  // Create the query.\n+  const query = new Query(collection(mongo)).where({ tenantID });\n+\n+  return retrieveConnection(input, query);\n+}\n+\n+export type UpdateSiteInput = Partial<Omit<CreateSiteInput, \"tenantID\">>;\n+\n+export async function updateSite(\n+  mongo: Db,\n+  tenantID: string,\n+  id: string,\n+  input: UpdateSiteInput,\n+  now = new Date()\n+) {\n+  const update = {\n+    $set: {\n+      ...input,\n+      updatedAt: now,\n+    },\n+  };\n+  try {\n+    const result = await collection(mongo).findOneAndUpdate(\n+      { id, tenantID },\n+      update,\n+      // False to return the updated document instead of the original\n+      // document.\n+      { returnOriginal: false }\n+    );\n+    return result.value || null;\n+  } catch (err) {\n+    // Evaluate the error, if it is in regards to violating the unique index,\n+    // then return a duplicate Story error.\n+    if (err instanceof MongoError && err.code === 11000) {\n+      throw new DuplicateSiteAllowedOriginError(err, id, input.allowedOrigins);\n+    }\n+\n+    throw err;\n+  }\n+}\n+\n+export const updateSiteCounts = (\n+  mongo: Db,\n+  tenantID: string,\n+  id: string,\n+  commentCounts: FirstDeepPartial<RelatedCommentCounts>\n+) => updateRelatedCommentCounts(collection(mongo), tenantID, id, commentCounts);"
    },
    {
      "sha": "0529d67d9fb3e0bf49d741e0c1722f814d0d8bc0",
      "filename": "src/core/server/models/story/counts/empty.ts",
      "status": "removed",
      "additions": 0,
      "deletions": 19,
      "changes": 19,
      "blob_url": "https://github.com/coralproject/talk/blob/014aa2d86ad54fc1139c4fef6d05f96426c7ea91/src/core/server/models/story/counts/empty.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/014aa2d86ad54fc1139c4fef6d05f96426c7ea91/src/core/server/models/story/counts/empty.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/story/counts/empty.ts?ref=014aa2d86ad54fc1139c4fef6d05f96426c7ea91",
      "patch": "@@ -1,19 +0,0 @@\n-import {\n-  CommentModerationCountsPerQueue,\n-  CommentModerationQueueCounts,\n-} from \".\";\n-\n-export function createEmptyCommentModerationCountsPerQueue(): CommentModerationCountsPerQueue {\n-  return {\n-    unmoderated: 0,\n-    reported: 0,\n-    pending: 0,\n-  };\n-}\n-\n-export function createEmptyCommentModerationQueueCounts(): CommentModerationQueueCounts {\n-  return {\n-    total: 0,\n-    queues: createEmptyCommentModerationCountsPerQueue(),\n-  };\n-}"
    },
    {
      "sha": "fcf5c455c7a6ca246f714eceba5f5f256a85f46c",
      "filename": "src/core/server/models/story/index.ts",
      "status": "modified",
      "additions": 44,
      "deletions": 23,
      "changes": 67,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/story/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/story/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/story/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,7 +1,7 @@\n import { Db, MongoError } from \"mongodb\";\n import uuid from \"uuid\";\n \n-import { DeepPartial, Omit } from \"coral-common/types\";\n+import { DeepPartial, FirstDeepPartial, Omit } from \"coral-common/types\";\n import { dotize } from \"coral-common/utils/dotize\";\n import {\n   DuplicateStoryIDError,\n@@ -22,13 +22,12 @@ import {\n   GQLStorySettings,\n } from \"coral-server/graph/schema/__generated__/types\";\n \n-import { createEmptyCommentStatusCounts } from \"../comment/helpers\";\n import {\n-  createEmptyCommentModerationQueueCounts,\n-  StoryCommentCounts,\n-} from \"./counts\";\n+  createEmptyRelatedCommentCounts,\n+  RelatedCommentCounts,\n+  updateRelatedCommentCounts,\n+} from \"../comment/counts\";\n \n-export * from \"./counts\";\n export * from \"./helpers\";\n \n export type StorySettings = DeepPartial<\n@@ -58,7 +57,7 @@ export interface Story extends TenantResource {\n   /**\n    * commentCounts stores all the comment counters.\n    */\n-  commentCounts: StoryCommentCounts;\n+  commentCounts: RelatedCommentCounts;\n \n   /**\n    * settings provides a point where the settings can be overridden for a\n@@ -81,17 +80,23 @@ export interface Story extends TenantResource {\n    * lastCommentedAt is the last time someone commented on this story.\n    */\n   lastCommentedAt?: Date;\n+\n+  /**\n+   * siteID references the site the story belongs to\n+   */\n+  siteID: string;\n }\n \n export interface UpsertStoryInput {\n   id?: string;\n   url: string;\n+  siteID: string;\n }\n \n export async function upsertStory(\n   mongo: Db,\n   tenantID: string,\n-  { id = uuid.v4(), url }: UpsertStoryInput,\n+  { id = uuid.v4(), url, siteID }: UpsertStoryInput,\n   now = new Date()\n ) {\n   // Create the story, optionally sourcing the id from the input, additionally\n@@ -100,13 +105,10 @@ export async function upsertStory(\n     $setOnInsert: {\n       id,\n       url,\n+      siteID,\n       tenantID,\n       createdAt: now,\n-      commentCounts: {\n-        action: {},\n-        status: createEmptyCommentStatusCounts(),\n-        moderationQueue: createEmptyCommentModerationQueueCounts(),\n-      },\n+      commentCounts: createEmptyRelatedCommentCounts(),\n       settings: {},\n     },\n   };\n@@ -174,23 +176,25 @@ export async function findOrCreateStory(\n   mongo: Db,\n   tenantID: string,\n   { id, url }: FindOrCreateStoryInput,\n+  siteID: string | null,\n   now = new Date()\n ) {\n   if (id) {\n-    if (url) {\n+    if (url && siteID) {\n       // The URL was specified, this is an upsert operation.\n       return upsertStory(\n         mongo,\n         tenantID,\n         {\n           id,\n           url,\n+          siteID,\n         },\n         now\n       );\n     }\n \n-    // The URL was not specified, this is a lookup operation.\n+    // The URL and siteID were not specified, this is a lookup operation.\n     return retrieveStory(mongo, tenantID, id);\n   }\n \n@@ -200,12 +204,18 @@ export async function findOrCreateStory(\n     throw new Error(\"cannot upsert an story without the url\");\n   }\n \n-  return upsertStory(mongo, tenantID, { url }, now);\n+  if (!siteID) {\n+    throw new Error(\"cannot upsert story without site ID\");\n+  }\n+\n+  return upsertStory(mongo, tenantID, { url, siteID }, now);\n }\n \n export type CreateStoryInput = Partial<\n   Pick<Story, \"metadata\" | \"scrapedAt\" | \"closedAt\">\n->;\n+> & {\n+  siteID: string;\n+};\n \n export async function createStory(\n   mongo: Db,\n@@ -222,11 +232,7 @@ export async function createStory(\n     url,\n     tenantID,\n     createdAt: now,\n-    commentCounts: {\n-      action: {},\n-      moderationQueue: createEmptyCommentModerationQueueCounts(),\n-      status: createEmptyCommentStatusCounts(),\n-    },\n+    commentCounts: createEmptyRelatedCommentCounts(),\n     settings: {},\n   };\n \n@@ -291,7 +297,7 @@ export async function retrieveManyStoriesByURL(\n \n export type UpdateStoryInput = Omit<\n   Partial<Story>,\n-  \"id\" | \"tenantID\" | \"closedAt\" | \"createdAt\"\n+  \"id\" | \"tenantID\" | \"closedAt\" | \"createdAt\" | \"siteID\"\n >;\n \n export async function updateStory(\n@@ -501,3 +507,18 @@ export async function updateStoryLastCommentedAt(\n     }\n   );\n }\n+\n+/**\n+ * updateStoryCounts will update the comment counts for the story indicated.\n+ *\n+ * @param mongo mongodb database handle\n+ * @param tenantID ID of the Tenant where the Story is on\n+ * @param id the ID of the Story that we are updating counts on\n+ * @param commentCounts the counts that we are updating\n+ */\n+export const updateStoryCounts = (\n+  mongo: Db,\n+  tenantID: string,\n+  id: string,\n+  commentCounts: FirstDeepPartial<RelatedCommentCounts>\n+) => updateRelatedCommentCounts(collection(mongo), tenantID, id, commentCounts);"
    },
    {
      "sha": "73ed47cf13eed3657e91971c3fcc7fbc2d0d0243",
      "filename": "src/core/server/models/tenant/tenant.ts",
      "status": "modified",
      "additions": 5,
      "deletions": 2,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/tenant/tenant.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/tenant/tenant.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/tenant/tenant.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -39,7 +39,7 @@ export interface TenantResource {\n }\n \n export interface TenantSettings\n-  extends Pick<GQLSettings, \"domain\" | \"allowedDomains\" | \"organization\"> {\n+  extends Pick<GQLSettings, \"domain\" | \"organization\"> {\n   readonly id: string;\n \n   /**\n@@ -65,9 +65,12 @@ export type Tenant = Settings & TenantSettings;\n  */\n export type CreateTenantInput = Pick<\n   Tenant,\n-  \"domain\" | \"allowedDomains\" | \"locale\" | \"organization\"\n+  \"domain\" | \"locale\" | \"organization\"\n >;\n \n+export interface TenantComputedProperties {\n+  multisite: boolean;\n+}\n /**\n  * create will create a new Tenant.\n  *"
    },
    {
      "sha": "dca2d99aa1fa3799d1b6655cdaa2bceb6f1ff5bd",
      "filename": "src/core/server/models/user/user.ts",
      "status": "modified",
      "additions": 3,
      "deletions": 25,
      "changes": 28,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/user/user.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/models/user/user.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/user/user.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,5 +1,4 @@\n import bcrypt from \"bcryptjs\";\n-import { identity, isEmpty, pickBy } from \"lodash\";\n import { DateTime, DurationObject } from \"luxon\";\n import { Db, MongoError } from \"mongodb\";\n import uuid from \"uuid\";\n@@ -45,6 +44,7 @@ import {\n import {\n   CommentStatusCounts,\n   createEmptyCommentStatusCounts,\n+  updateRelatedCommentCounts,\n } from \"../comment\";\n import { getLocalProfile, hasLocalProfile } from \"./helpers\";\n \n@@ -2462,31 +2462,9 @@ export async function deleteModeratorNote(\n   return result.value;\n }\n \n-export async function updateUserCommentCounts(\n+export const updateUserCommentCounts = (\n   mongo: Db,\n   tenantID: string,\n   id: string,\n   commentCounts: DeepPartial<UserCommentCounts>\n-) {\n-  // Update all the specific comment moderation queue counts.\n-  const update: DeepPartial<User> = { commentCounts };\n-  const $inc = pickBy(dotize(update), identity);\n-  if (isEmpty($inc)) {\n-    // Nothing needs to be incremented, just return the User.\n-    return retrieveUser(mongo, tenantID, id);\n-  }\n-\n-  logger.trace({ update: { $inc } }, \"incrementing user comment counts\");\n-\n-  const result = await collection(mongo).findOneAndUpdate(\n-    { id, tenantID },\n-    { $inc },\n-    {\n-      // False to return the updated document instead of the original\n-      // document.\n-      returnOriginal: false,\n-    }\n-  );\n-\n-  return result.value || null;\n-}\n+) => updateRelatedCommentCounts(collection(mongo), tenantID, id, commentCounts);"
    },
    {
      "sha": "c9e71bddf405e83edd0a5569387cba52111dfb0c",
      "filename": "src/core/server/services/comments/actions.ts",
      "status": "modified",
      "additions": 51,
      "deletions": 43,
      "changes": 94,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/comments/actions.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/comments/actions.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/comments/actions.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -2,35 +2,33 @@ import { Db } from \"mongodb\";\n \n import { Omit } from \"coral-common/types\";\n import { CommentNotFoundError } from \"coral-server/errors\";\n-import { GQLCOMMENT_FLAG_REPORTED_REASON } from \"coral-server/graph/schema/__generated__/types\";\n import { Publisher } from \"coral-server/graph/subscriptions/publisher\";\n import {\n   ACTION_TYPE,\n-  CommentAction,\n   CreateActionInput,\n   createActions,\n   encodeActionCounts,\n+  EncodedCommentActionCounts,\n   invertEncodedActionCounts,\n   removeAction,\n   RemoveActionInput,\n   retrieveUserAction,\n } from \"coral-server/models/action/comment\";\n import {\n+  Comment,\n   retrieveComment,\n   updateCommentActionCounts,\n } from \"coral-server/models/comment\";\n-import { Comment } from \"coral-server/models/comment\";\n import { getLatestRevision } from \"coral-server/models/comment/helpers\";\n-import {\n-  updateStoryActionCounts,\n-  updateStoryCounts,\n-} from \"coral-server/models/story\";\n import { Tenant } from \"coral-server/models/tenant\";\n import { User } from \"coral-server/models/user\";\n-import { publishModerationQueueChanges } from \"coral-server/services/events\";\n import { AugmentedRedis } from \"coral-server/services/redis\";\n+import {\n+  publishChanges,\n+  updateAllCommentCounts,\n+} from \"coral-server/stacks/helpers\";\n \n-import { calculateCountsDiff } from \"./moderation/counts\";\n+import { GQLCOMMENT_FLAG_REPORTED_REASON } from \"coral-server/graph/schema/__generated__/types\";\n \n export type CreateAction = CreateActionInput;\n \n@@ -54,11 +52,8 @@ export async function addCommentActionCounts(\n   mongo: Db,\n   tenant: Tenant,\n   oldComment: Readonly<Comment>,\n-  ...actions: CommentAction[]\n+  action: EncodedCommentActionCounts\n ) {\n-  // Compute the action counts.\n-  const action = encodeActionCounts(...actions);\n-\n   // Grab the last revision (the most recent).\n   const revision = getLatestRevision(oldComment);\n \n@@ -81,9 +76,9 @@ export async function addCommentActionCounts(\n async function addCommentAction(\n   mongo: Db,\n   redis: AugmentedRedis,\n-  publish: Publisher,\n+  publisher: Publisher,\n   tenant: Tenant,\n-  input: Omit<CreateActionInput, \"storyID\">,\n+  input: Omit<CreateActionInput, \"storyID\" | \"siteID\">,\n   now = new Date()\n ): Promise<Readonly<Comment>> {\n   const oldComment = await retrieveComment(mongo, tenant.id, input.commentID);\n@@ -95,29 +90,37 @@ async function addCommentAction(\n   const action: CreateAction = {\n     ...input,\n     storyID: oldComment.storyID,\n+    siteID: oldComment.siteID,\n   };\n \n   // Update the actions for the comment.\n   const commentActions = await addCommentActions(mongo, tenant, [action], now);\n   if (commentActions.length > 0) {\n+    // Compute the action counts.\n+    const actionCounts = encodeActionCounts(...commentActions);\n+\n     // Update the comment action counts.\n     const updatedComment = await addCommentActionCounts(\n       mongo,\n       tenant,\n       oldComment,\n-      ...commentActions\n+      actionCounts\n     );\n \n-    const moderationQueue = calculateCountsDiff(oldComment, updatedComment);\n-\n-    // Calculate the new story counts.\n-    await updateStoryCounts(mongo, redis, tenant.id, updatedComment.storyID, {\n-      action: encodeActionCounts(...commentActions),\n-      moderationQueue,\n+    // Update the comment counts onto other documents.\n+    const counts = await updateAllCommentCounts(mongo, redis, {\n+      tenant,\n+      actionCounts,\n+      before: oldComment,\n+      after: updatedComment,\n     });\n \n-    // Publish changes to the queue.\n-    publishModerationQueueChanges(publish, moderationQueue, updatedComment);\n+    // Publish changes to the event publisher.\n+    await publishChanges(publisher, {\n+      ...counts,\n+      before: oldComment,\n+      after: updatedComment,\n+    });\n \n     return updatedComment;\n   }\n@@ -128,12 +131,13 @@ async function addCommentAction(\n export async function removeCommentAction(\n   mongo: Db,\n   redis: AugmentedRedis,\n+  publisher: Publisher,\n   tenant: Tenant,\n   input: Omit<RemoveActionInput, \"commentRevisionID\" | \"reason\">\n ): Promise<Readonly<Comment>> {\n   // Get the Comment that we are leaving the Action on.\n-  const comment = await retrieveComment(mongo, tenant.id, input.commentID);\n-  if (!comment) {\n+  const oldComment = await retrieveComment(mongo, tenant.id, input.commentID);\n+  if (!oldComment) {\n     throw new CommentNotFoundError(input.commentID);\n   }\n \n@@ -147,7 +151,7 @@ export async function removeCommentAction(\n   );\n   if (!action) {\n     // The action that is trying to get removed does not exist!\n-    return comment;\n+    return oldComment;\n   }\n \n   // Grab the revision ID out of the action.\n@@ -172,29 +176,31 @@ export async function removeCommentAction(\n       actionCounts\n     );\n \n-    // Flags can't be removed, an that is the only type of operation that will\n-    // affect the moderation queue counts, so we don't have to interact with\n-    // updating the moderation queue counts.\n-\n-    // Update the Story with the updated action counts.\n-    await updateStoryActionCounts(\n-      mongo,\n-      redis,\n-      tenant.id,\n-      comment.storyID,\n-      actionCounts\n-    );\n-\n     // Check to see if there was an actual comment returned.\n     if (!updatedComment) {\n       // TODO: (wyattjoh) return a better error.\n       throw new Error(\"could not update comment action counts\");\n     }\n \n+    // Update the comment counts onto other documents.\n+    const counts = await updateAllCommentCounts(mongo, redis, {\n+      tenant,\n+      actionCounts,\n+      before: oldComment,\n+      after: updatedComment,\n+    });\n+\n+    // Publish changes to the event publisher.\n+    await publishChanges(publisher, {\n+      ...counts,\n+      before: oldComment,\n+      after: updatedComment,\n+    });\n+\n     return updatedComment;\n   }\n \n-  return comment;\n+  return oldComment;\n }\n \n export type CreateCommentReaction = Pick<\n@@ -231,11 +237,12 @@ export type RemoveCommentReaction = Pick<RemoveActionInput, \"commentID\">;\n export async function removeReaction(\n   mongo: Db,\n   redis: AugmentedRedis,\n+  publisher: Publisher,\n   tenant: Tenant,\n   author: User,\n   input: RemoveCommentReaction\n ) {\n-  return removeCommentAction(mongo, redis, tenant, {\n+  return removeCommentAction(mongo, redis, publisher, tenant, {\n     actionType: ACTION_TYPE.REACTION,\n     commentID: input.commentID,\n     userID: author.id,\n@@ -277,11 +284,12 @@ export type RemoveCommentDontAgree = Pick<RemoveActionInput, \"commentID\">;\n export async function removeDontAgree(\n   mongo: Db,\n   redis: AugmentedRedis,\n+  publisher: Publisher,\n   tenant: Tenant,\n   author: User,\n   input: RemoveCommentDontAgree\n ) {\n-  return removeCommentAction(mongo, redis, tenant, {\n+  return removeCommentAction(mongo, redis, publisher, tenant, {\n     actionType: ACTION_TYPE.DONT_AGREE,\n     commentID: input.commentID,\n     userID: author.id,"
    },
    {
      "sha": "f058dec6467944ce18e65ff87846881618680108",
      "filename": "src/core/server/services/comments/moderation/counts.ts",
      "status": "modified",
      "additions": 6,
      "deletions": 3,
      "changes": 9,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/comments/moderation/counts.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/comments/moderation/counts.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/comments/moderation/counts.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,7 +1,10 @@\n-import { GQLCOMMENT_STATUS } from \"coral-server/graph/schema/__generated__/types\";\n import { decodeActionCounts } from \"coral-server/models/action/comment\";\n-import { Comment } from \"coral-server/models/comment\";\n-import { CommentModerationQueueCounts } from \"coral-server/models/story\";\n+import {\n+  Comment,\n+  CommentModerationQueueCounts,\n+} from \"coral-server/models/comment\";\n+\n+import { GQLCOMMENT_STATUS } from \"coral-server/graph/schema/__generated__/types\";\n \n export const UNMODERATED_STATUSES = [\n   GQLCOMMENT_STATUS.NONE,"
    },
    {
      "sha": "91b4815bf7193b5ae2d54dc96688311f71fed7b5",
      "filename": "src/core/server/services/comments/pipeline/pipeline.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/comments/pipeline/pipeline.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/comments/pipeline/pipeline.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/comments/pipeline/pipeline.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -22,7 +22,7 @@ import { moderationPhases } from \"./phases\";\n \n export type ModerationAction = Omit<\n   CreateActionInput,\n-  \"commentID\" | \"commentRevisionID\" | \"storyID\"\n+  \"commentID\" | \"commentRevisionID\" | \"storyID\" | \"siteID\"\n >;\n \n export interface PhaseResult {"
    },
    {
      "sha": "46b46f3a66ee277083302b4f1461cf041c169a85",
      "filename": "src/core/server/services/events/comments.ts",
      "status": "modified",
      "additions": 4,
      "deletions": 3,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/events/comments.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/events/comments.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/events/comments.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,11 +1,12 @@\n import { SUBSCRIPTION_CHANNELS } from \"coral-server/graph/resolvers/Subscription/types\";\n+import { Publisher } from \"coral-server/graph/subscriptions/publisher\";\n+import { Comment, hasPublishedStatus } from \"coral-server/models/comment\";\n+import { CommentModerationQueueCounts } from \"coral-server/models/comment/counts\";\n+\n import {\n   GQLCOMMENT_STATUS,\n   GQLMODERATION_QUEUE,\n } from \"coral-server/graph/schema/__generated__/types\";\n-import { Publisher } from \"coral-server/graph/subscriptions/publisher\";\n-import { Comment, hasPublishedStatus } from \"coral-server/models/comment\";\n-import { CommentModerationQueueCounts } from \"coral-server/models/story/counts\";\n \n export function publishCommentStatusChanges(\n   publish: Publisher,"
    },
    {
      "sha": "b84f3832596b16fac044f8daa80d8ff4c672bca8",
      "filename": "src/core/server/services/migrate/batch.ts",
      "status": "added",
      "additions": 80,
      "deletions": 0,
      "changes": 80,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/migrate/batch.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/migrate/batch.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/migrate/batch.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,80 @@\n+import { Collection, FilterQuery, UpdateQuery } from \"mongodb\";\n+\n+import { Logger } from \"coral-server/logger\";\n+import { TenantResource } from \"coral-server/models/tenant\";\n+\n+interface UpdateOneOperation<T> {\n+  updateOne: {\n+    filter: FilterQuery<T>;\n+    update: UpdateQuery<T>;\n+  };\n+}\n+\n+type Operation<T> = UpdateOneOperation<T>;\n+\n+class Batch<T extends TenantResource> {\n+  private readonly logger: Logger;\n+  private readonly collection: Collection<T>;\n+  private readonly maxBatchSize: number;\n+  private readonly tenantID: string;\n+  private updates: Array<Operation<T>> = [];\n+\n+  constructor(\n+    logger: Logger,\n+    collection: Collection<T>,\n+    maxBatchSize: number,\n+    tenantID: string\n+  ) {\n+    this.logger = logger;\n+    this.collection = collection;\n+    this.maxBatchSize = maxBatchSize;\n+    this.tenantID = tenantID;\n+  }\n+\n+  private async execute() {\n+    // Write out the updates, indicating that the writes can occur out of order.\n+    const result = await this.collection.bulkWrite(this.updates, {\n+      ordered: false,\n+    });\n+\n+    this.logger.info(\n+      {\n+        updates: this.updates.length,\n+        matchedCount: result.matchedCount,\n+        modifiedCount: result.modifiedCount,\n+        collection: this.collection.collectionName,\n+      },\n+      \"executed bulk write for batch operation\"\n+    );\n+\n+    // Clear the pending updates.\n+    this.updates = [];\n+  }\n+\n+  public async add(filter: FilterQuery<T>, update: UpdateQuery<T>) {\n+    // Add the update to the list of updates.\n+    this.updates.push({\n+      updateOne: {\n+        filter: {\n+          // Merge the filter in with the tenantID.\n+          ...filter,\n+          tenantID: this.tenantID,\n+        },\n+        update,\n+      },\n+    });\n+\n+    // Check to see if we need to execute this batch.\n+    if (this.updates.length >= this.maxBatchSize) {\n+      await this.execute();\n+    }\n+  }\n+\n+  public async finish() {\n+    if (this.updates.length > 0) {\n+      await this.execute();\n+    }\n+  }\n+}\n+\n+export default Batch;"
    },
    {
      "sha": "a6ccd52b66823733853613a443ea692c928f20ba",
      "filename": "src/core/server/services/migrate/migration.ts",
      "status": "modified",
      "additions": 13,
      "deletions": 2,
      "changes": 15,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/migrate/migration.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/migrate/migration.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/migrate/migration.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,9 +1,12 @@\n import Logger from \"bunyan\";\n-import { Db } from \"mongodb\";\n+import { Collection, Db } from \"mongodb\";\n \n import logger from \"coral-server/logger\";\n+import { TenantResource } from \"coral-server/models/tenant\";\n import { I18n } from \"coral-server/services/i18n\";\n \n+import Batch from \"./batch\";\n+\n interface Migration {\n   indexes?(mongo: Db): Promise<void>;\n   up?(mongo: Db, tenantID: string): Promise<void>;\n@@ -26,7 +29,7 @@ abstract class Migration {\n   /**\n    * disabled when true will not run the migration.\n    */\n-  public static disabled?: boolean;\n+  public static readonly disabled?: boolean;\n \n   constructor({ id, name, i18n }: MigrationOptions) {\n     this.id = id;\n@@ -44,6 +47,14 @@ abstract class Migration {\n   protected log(tenantID: string) {\n     return this.logger.child({ tenantID }, true);\n   }\n+\n+  protected batch<T extends TenantResource>(\n+    collection: Collection<T>,\n+    tenantID: string,\n+    size = 500\n+  ) {\n+    return new Batch(this.log(tenantID), collection, size, tenantID);\n+  }\n }\n \n export default Migration;"
    },
    {
      "sha": "bde2efb0d9816d3d45f27e6cfe7892632e31e872",
      "filename": "src/core/server/services/migrate/migrations/1579189174931_create_sites.ts",
      "status": "added",
      "additions": 235,
      "deletions": 0,
      "changes": 235,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/migrate/migrations/1579189174931_create_sites.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/migrate/migrations/1579189174931_create_sites.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/migrate/migrations/1579189174931_create_sites.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,235 @@\n+import { Db } from \"mongodb\";\n+\n+import { dotize } from \"coral-common/utils/dotize\";\n+import {\n+  ACTION_TYPE,\n+  encodeActionCountKeys,\n+  EncodedCommentActionCounts,\n+  FLAG_REASON,\n+  mergeCommentActionCounts,\n+} from \"coral-server/models/action/comment\";\n+import {\n+  createEmptyRelatedCommentCounts,\n+  mergeCommentModerationQueueCount,\n+  mergeCommentStatusCount,\n+} from \"coral-server/models/comment\";\n+import {\n+  createSite,\n+  getURLOrigins,\n+  Site,\n+  updateSiteCounts,\n+} from \"coral-server/models/site\";\n+import { Tenant } from \"coral-server/models/tenant\";\n+import Migration from \"coral-server/services/migrate/migration\";\n+import collections from \"coral-server/services/mongodb/collections\";\n+\n+import { MigrationError } from \"../error\";\n+\n+interface OldTenant extends Tenant {\n+  allowedDomains: string[];\n+}\n+\n+export default class extends Migration {\n+  private async createSite(mongo: Db, tenant: Readonly<OldTenant>) {\n+    const {\n+      organization: { name },\n+      domain,\n+      allowedDomains,\n+    } = tenant;\n+\n+    // Convert a tenant's domains into origins that we will re-use on the site.\n+    const allowedOrigins = getURLOrigins([...allowedDomains, domain]);\n+\n+    // Create the new site.\n+    const site = await createSite(mongo, {\n+      name,\n+      tenantID: tenant.id,\n+      allowedOrigins,\n+    });\n+\n+    this.logger.info({ site }, \"created site\");\n+\n+    // Add the siteID to all the stories.\n+    let result = await collections\n+      .stories(mongo)\n+      .updateMany({ tenantID: tenant.id }, { $set: { siteID: site.id } });\n+\n+    this.log(tenant.id).info(\n+      {\n+        matchedCount: result.matchedCount,\n+        modifiedCount: result.modifiedCount,\n+      },\n+      \"added siteID to stories\"\n+    );\n+\n+    // Add the siteID to all comments.\n+    result = await collections\n+      .comments(mongo)\n+      .updateMany({ tenantID: tenant.id }, { $set: { siteID: site.id } });\n+\n+    this.log(tenant.id).info(\n+      {\n+        matchedCount: result.matchedCount,\n+        modifiedCount: result.modifiedCount,\n+      },\n+      \"added siteID to comments\"\n+    );\n+\n+    // Add the siteID to all commentActions.\n+    result = await collections\n+      .commentActions(mongo)\n+      .updateMany({ tenantID: tenant.id }, { $set: { siteID: site.id } });\n+\n+    this.log(tenant.id).info(\n+      {\n+        matchedCount: result.matchedCount,\n+        modifiedCount: result.modifiedCount,\n+      },\n+      \"added siteID to commentActions\"\n+    );\n+\n+    return site;\n+  }\n+\n+  private async updateStoryActionCommentCounts(mongo: Db, tenant: Tenant) {\n+    // Create the batch writer.\n+    const batch = this.batch(collections.stories(mongo), tenant.id);\n+\n+    // Recalculate the action counts for the stories.\n+    const cursor = collections\n+      .commentActions<{\n+        _id: string;\n+        actions: {\n+          actionType: ACTION_TYPE;\n+          reason?: FLAG_REASON;\n+          sum: number;\n+        }[];\n+      }>(mongo)\n+      .aggregate([\n+        // Find all actions related to this Tenant.\n+        { $match: { tenantID: tenant.id } },\n+        // Group and count them to collect all the actions related to each\n+        // action type, reason, and story.\n+        {\n+          $group: {\n+            _id: {\n+              storyID: \"$storyID\",\n+              actionType: \"$actionType\",\n+              reason: \"$reason\",\n+            },\n+            sum: { $sum: 1 },\n+          },\n+        },\n+        // Group all the entries from storyID together now, and collect their\n+        // action summaries.\n+        {\n+          $group: {\n+            _id: \"$_id.storyID\",\n+            actions: {\n+              $push: {\n+                actionType: \"$_id.actionType\",\n+                reason: \"$_id.reason\",\n+                sum: \"$sum\",\n+              },\n+            },\n+          },\n+        },\n+      ]);\n+\n+    while (await cursor.hasNext()) {\n+      const doc = await cursor.next();\n+      if (!doc) {\n+        break;\n+      }\n+\n+      // Encode these actions.\n+      const encodedActionCounts: EncodedCommentActionCounts = {};\n+      for (const action of doc.actions) {\n+        for (const key of encodeActionCountKeys(action)) {\n+          if (key in encodedActionCounts) {\n+            encodedActionCounts[key] += action.sum;\n+          } else {\n+            encodedActionCounts[key] = action.sum;\n+          }\n+        }\n+      }\n+\n+      // Push the update and process it if we need to.\n+      await batch.add(\n+        // Find the story by ID.\n+        { id: doc._id },\n+        // Dotize set the action counts on the story.\n+        { $set: dotize(encodedActionCounts) }\n+      );\n+    }\n+\n+    // Finish the batch.\n+    await batch.finish();\n+  }\n+\n+  private async updateCommentCounts(mongo: Db, tenant: Tenant, site: Site) {\n+    // Create a cursor for going through all the stories. That way we can find\n+    // all the actions that we can collect in one action.\n+    const cursor = collections.stories(mongo).find({ tenantID: tenant.id });\n+\n+    // Begin accumulating comment counts for the site.\n+    const counts = createEmptyRelatedCommentCounts();\n+\n+    // Walk over every story, collecting and aggregating the comment counts.\n+    while (await cursor.hasNext()) {\n+      // Grab the story from the cursor.\n+      const story = await cursor.next();\n+      if (!story) {\n+        break;\n+      }\n+\n+      // Update the action counts.\n+      counts.action = mergeCommentActionCounts(\n+        counts.action,\n+        story.commentCounts.action\n+      );\n+\n+      // Update the status counts.\n+      counts.status = mergeCommentStatusCount(\n+        counts.status,\n+        story.commentCounts.status\n+      );\n+\n+      // Update the moderation queue counts.\n+      counts.moderationQueue = mergeCommentModerationQueueCount(\n+        counts.moderationQueue,\n+        story.commentCounts.moderationQueue\n+      );\n+    }\n+\n+    // Update the site with the new comment counts.\n+    await updateSiteCounts(mongo, tenant.id, site.id, counts);\n+  }\n+\n+  public async up(mongo: Db, tenantID: string) {\n+    const tenant = await collections\n+      .tenants<OldTenant>(mongo)\n+      .findOne({ id: tenantID });\n+    if (!tenant) {\n+      throw new MigrationError(tenantID, \"could not find tenant\", \"tenants\", [\n+        tenantID,\n+      ]);\n+    }\n+\n+    // Try to find any site to see if this migration is needed.\n+    let site = await collections.sites(mongo).findOne({ tenantID });\n+    if (site) {\n+      this.log(tenantID).info({ site }, \"site has already been created\");\n+      return;\n+    }\n+\n+    // Create the site.\n+    site = await this.createSite(mongo, tenant);\n+\n+    // Update the story action counts on the stories.\n+    await this.updateStoryActionCommentCounts(mongo, tenant);\n+\n+    // Update the site comment counts from the stories.\n+    await this.updateCommentCounts(mongo, tenant, site);\n+  }\n+}"
    },
    {
      "sha": "63cfdbe00cb622ccd17c6915001e10f035573d00",
      "filename": "src/core/server/services/migrate/migrations/1579878509162_add_indexes_to_sites.ts",
      "status": "added",
      "additions": 17,
      "deletions": 0,
      "changes": 17,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/migrate/migrations/1579878509162_add_indexes_to_sites.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/migrate/migrations/1579878509162_add_indexes_to_sites.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/migrate/migrations/1579878509162_add_indexes_to_sites.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,17 @@\n+import { Db } from \"mongodb\";\n+\n+// Use the following collections reference to interact with specific\n+// collections.\n+import collections from \"coral-server/services/mongodb/collections\";\n+\n+import Migration from \"coral-server/services/migrate/migration\";\n+import { createIndexFactory } from \"../indexing\";\n+\n+export default class extends Migration {\n+  public async indexes(mongo: Db) {\n+    const createIndex = createIndexFactory(collections.sites(mongo));\n+    await createIndex({ tenantID: 1, id: 1 }, { background: true });\n+    await createIndex({ tenantID: 1, allowedOrigins: 1 }, { unique: true });\n+    await createIndex({ tenantID: 1, name: 1 }, { background: true });\n+  }\n+}"
    },
    {
      "sha": "4890f2824fe7891e7292d810a9d77035db3ab905",
      "filename": "src/core/server/services/mongodb/collections.ts",
      "status": "modified",
      "additions": 5,
      "deletions": 2,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/mongodb/collections.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/mongodb/collections.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/mongodb/collections.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,11 +1,11 @@\n-import { createCollection } from \"coral-server/models/helpers\";\n-\n import { CommentAction } from \"coral-server/models/action/comment\";\n import { CommentModerationAction } from \"coral-server/models/action/moderation/comment\";\n import { Comment } from \"coral-server/models/comment\";\n+import { createCollection } from \"coral-server/models/helpers\";\n import { Invite } from \"coral-server/models/invite\";\n import { MigrationRecord } from \"coral-server/models/migration\";\n import { PersistedQuery } from \"coral-server/models/queries\";\n+import { Site } from \"coral-server/models/site\";\n import { Story } from \"coral-server/models/story\";\n import { Tenant } from \"coral-server/models/tenant\";\n import { User } from \"coral-server/models/user\";\n@@ -22,6 +22,8 @@ export const stories = createCollection<Story>(\"stories\");\n \n export const commentActions = createCollection<CommentAction>(\"commentActions\");\n \n+export const sites = createCollection<Site>(\"sites\");\n+\n export const commentModerationActions = createCollection<\n   CommentModerationAction\n >(\"commentModerationActions\");\n@@ -40,6 +42,7 @@ const collections = {\n   commentModerationActions,\n   queries,\n   migrations,\n+  sites,\n };\n \n export default collections;"
    },
    {
      "sha": "14f82f8326b1e3248e7e2ec77fff0b6984c5a86a",
      "filename": "src/core/server/services/sites/index.ts",
      "status": "added",
      "additions": 72,
      "deletions": 0,
      "changes": 72,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/sites/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/sites/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/sites/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,72 @@\n+import { Db } from \"mongodb\";\n+\n+import { Omit } from \"coral-common/types\";\n+import { getOrigin } from \"coral-server/app/url\";\n+import {\n+  createSite,\n+  CreateSiteInput,\n+  getURLOrigins,\n+  retrieveSiteByOrigin,\n+  updateSite,\n+  UpdateSiteInput,\n+} from \"coral-server/models/site\";\n+import { Tenant } from \"coral-server/models/tenant\";\n+\n+type CreateSite = Omit<CreateSiteInput, \"tenantID\">;\n+\n+export async function findSiteByURL(mongo: Db, tenantID: string, url: string) {\n+  const origin = getOrigin(url);\n+  if (!origin) {\n+    return null;\n+  }\n+\n+  return retrieveSiteByOrigin(mongo, tenantID, origin);\n+}\n+\n+function conformURLToOrigins(allowedOrigins?: string[]) {\n+  if (allowedOrigins) {\n+    return {\n+      allowedOrigins: getURLOrigins(allowedOrigins),\n+    };\n+  }\n+\n+  return {};\n+}\n+\n+export async function create(\n+  mongo: Db,\n+  tenant: Tenant,\n+  input: CreateSite,\n+  now = new Date()\n+) {\n+  // Create the new site.\n+  return createSite(\n+    mongo,\n+    {\n+      ...input,\n+      ...conformURLToOrigins(input.allowedOrigins),\n+      tenantID: tenant.id,\n+    },\n+    now\n+  );\n+}\n+\n+export const update = (\n+  mongo: Db,\n+  tenant: Tenant,\n+  id: string,\n+  input: UpdateSiteInput,\n+  now = new Date()\n+) => {\n+  // Update the site.\n+  return updateSite(\n+    mongo,\n+    tenant.id,\n+    id,\n+    {\n+      ...input,\n+      ...conformURLToOrigins(input.allowedOrigins),\n+    },\n+    now\n+  );\n+};"
    },
    {
      "sha": "bf0ffacb50a209c8125ef928aee87890ceaecb0f",
      "filename": "src/core/server/services/sites/url.spec.ts",
      "status": "added",
      "additions": 82,
      "deletions": 0,
      "changes": 82,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/sites/url.spec.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/sites/url.spec.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/sites/url.spec.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -0,0 +1,82 @@\n+import { Site } from \"coral-server/models/site\";\n+\n+import { isURLPermitted } from \"./url\";\n+\n+type PartialSite = Pick<Site, \"allowedOrigins\">;\n+\n+function createSite(input: Partial<PartialSite> = {}): PartialSite {\n+  if (!input.allowedOrigins) {\n+    input.allowedOrigins = [];\n+  }\n+\n+  return input as PartialSite;\n+}\n+\n+it(\"denies when the site has no specified domains\", () => {\n+  const site = { allowedOrigins: [] };\n+\n+  expect(isURLPermitted(site, \"\")).toEqual(false);\n+});\n+\n+it(\"denies when site has a domain but not a valid url\", () => {\n+  const site = createSite({ allowedOrigins: [\"https://coralproject.net\"] });\n+\n+  expect(isURLPermitted(site, \"\")).toEqual(false);\n+});\n+\n+it(\"denies when there are multiple sites allowedOrigins and not a valid url\", () => {\n+  const site = createSite({\n+    allowedOrigins: [\n+      \"https://coralproject.net\",\n+      \"https://news.coralproject.net\",\n+    ],\n+  });\n+\n+  expect(isURLPermitted(site, \"\")).toEqual(false);\n+});\n+\n+it(\"denies when there are multiple sites allowedOrigins and a invalid url\", () => {\n+  const site = createSite({\n+    allowedOrigins: [\n+      \"https://coralproject.net\",\n+      \"https://news.coralproject.net\",\n+    ],\n+  });\n+\n+  expect(isURLPermitted(site, \"https://blog.coralproject.net/a/page\")).toEqual(\n+    false\n+  );\n+});\n+\n+it(\"allows when there are multiple sites allowedOrigins and a valid url\", () => {\n+  const site = createSite({\n+    allowedOrigins: [\n+      \"https://coralproject.net\",\n+      \"https://news.coralproject.net\",\n+    ],\n+  });\n+\n+  expect(isURLPermitted(site, \"https://news.coralproject.net/a/page\")).toEqual(\n+    true\n+  );\n+});\n+\n+it(\"allows when there are multiple prefix allowedOrigins and a valid url\", () => {\n+  const site = createSite({\n+    allowedOrigins: [\"coralproject.net\", \"news.coralproject.net\"],\n+  });\n+\n+  expect(isURLPermitted(site, \"http://news.coralproject.net/a/page\")).toEqual(\n+    true\n+  );\n+});\n+\n+it(\"allows when there are some prefix allowedOrigins and a valid url\", () => {\n+  const site = createSite({\n+    allowedOrigins: [\"http://coralproject.net\", \"news.coralproject.net\"],\n+  });\n+\n+  expect(isURLPermitted(site, \"https://news.coralproject.net/a/page\")).toEqual(\n+    true\n+  );\n+});"
    },
    {
      "sha": "082f1079798afc8a0f3fc3e3514174990fe59dae",
      "filename": "src/core/server/services/sites/url.ts",
      "status": "renamed",
      "additions": 6,
      "deletions": 8,
      "changes": 14,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/sites/url.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/sites/url.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/sites/url.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -4,16 +4,16 @@ import {\n   isURLSecure,\n   prefixSchemeIfRequired,\n } from \"coral-server/app/url\";\n-import { Tenant } from \"coral-server/models/tenant\";\n+import { Site } from \"coral-server/models/site\";\n \n export function isURLPermitted(\n-  tenant: Pick<Tenant, \"allowedDomains\">,\n+  site: Pick<Site, \"allowedOrigins\">,\n   targetURL: string,\n   includeTenantDomain?: false\n ): boolean;\n \n export function isURLPermitted(\n-  tenant: Pick<Tenant, \"allowedDomains\" | \"domain\">,\n+  site: Pick<Site, \"allowedOrigins\">,\n   targetURL: string,\n   includeTenantDomain: true\n ): boolean;\n@@ -23,13 +23,13 @@ export function isURLPermitted(\n  * the Tenant's domain configuration.\n  */\n export function isURLPermitted(\n-  tenant: Pick<Tenant, \"allowedDomains\" | \"domain\">,\n+  site: Pick<Site, \"allowedOrigins\">,\n   targetURL: string,\n   includeTenantDomain = false\n ) {\n   // If there aren't any domains, then we reject it, because no url we have can\n   // satisfy those requirements.\n-  if (tenant.allowedDomains.length === 0 && !includeTenantDomain) {\n+  if (site.allowedOrigins.length === 0 && !includeTenantDomain) {\n     return false;\n   }\n \n@@ -47,9 +47,7 @@ export function isURLPermitted(\n   const targetOrigin = getOrigin(targetURL);\n \n   // Create the list of domains to check against.\n-  const domains = includeTenantDomain\n-    ? [tenant.domain, ...tenant.allowedDomains]\n-    : tenant.allowedDomains;\n+  const domains = site.allowedOrigins;\n \n   // Loop over all the Tenant domains provided. Prefix the domain of each if it\n   // is required with the target url scheme. Return if at least one match is",
      "previous_filename": "src/core/server/services/tenant/url.ts"
    },
    {
      "sha": "8edbd0dd964ff78dcfc97fa856a61ecbc44847f2",
      "filename": "src/core/server/services/stories/index.ts",
      "status": "modified",
      "additions": 61,
      "deletions": 84,
      "changes": 145,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/stories/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/services/stories/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/stories/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,61 +1,50 @@\n-import { uniq, zip } from \"lodash\";\n+import { uniq } from \"lodash\";\n import { Db } from \"mongodb\";\n \n+import isNonNullArray from \"coral-common/helpers/isNonNullArray\";\n import { Config } from \"coral-server/config\";\n import { StoryURLInvalidError } from \"coral-server/errors\";\n import logger from \"coral-server/logger\";\n import {\n-  countTotalActionCounts,\n   mergeCommentActionCounts,\n   mergeManyStoryActions,\n   removeStoryActions,\n } from \"coral-server/models/action/comment\";\n import {\n+  calculateTotalCommentCount,\n+  mergeCommentModerationQueueCount,\n+  mergeCommentStatusCount,\n   mergeManyCommentStories,\n   removeStoryComments,\n } from \"coral-server/models/comment\";\n import {\n-  calculateTotalCommentCount,\n   closeStory,\n   createStory,\n   CreateStoryInput,\n   findOrCreateStory,\n   FindOrCreateStoryInput,\n   findStory,\n   FindStoryInput,\n-  mergeCommentStatusCount,\n   openStory,\n   removeStories,\n   removeStory,\n   retrieveManyStories,\n   retrieveStory,\n   Story,\n   updateStory,\n-  updateStoryActionCounts,\n-  updateStoryCommentStatusCount,\n+  updateStoryCounts,\n   UpdateStoryInput,\n   updateStorySettings,\n   UpdateStorySettingsInput,\n } from \"coral-server/models/story\";\n import { Tenant } from \"coral-server/models/tenant\";\n import { ScraperQueue } from \"coral-server/queue/tasks/scraper\";\n+import { findSiteByURL } from \"coral-server/services/sites\";\n import { scrape } from \"coral-server/services/stories/scraper\";\n \n-import { AugmentedRedis } from \"../redis\";\n-import { isURLPermitted } from \"../tenant/url\";\n-\n export type FindStory = FindStoryInput;\n \n export async function find(mongo: Db, tenant: Tenant, input: FindStory) {\n-  // If the URL is provided, and the url is not on a allowed domain, then refuse\n-  // to create the Asset.\n-  if (input.url && !isURLPermitted(tenant, input.url)) {\n-    throw new StoryURLInvalidError({\n-      storyURL: input.url,\n-      allowedDomains: tenant.allowedDomains,\n-    });\n-  }\n-\n   return findStory(mongo, tenant.id, input);\n }\n \n@@ -68,16 +57,20 @@ export async function findOrCreate(\n   scraper: ScraperQueue,\n   now = new Date()\n ) {\n-  // If the URL is provided, and the url is not on a allowed domain, then refuse\n-  // to create the Asset.\n-  if (input.url && !isURLPermitted(tenant, input.url)) {\n-    throw new StoryURLInvalidError({\n-      storyURL: input.url,\n-      allowedDomains: tenant.allowedDomains,\n-    });\n+  let siteID = null;\n+  if (input.url) {\n+    const site = await findSiteByURL(mongo, tenant.id, input.url);\n+    // If the URL is provided, and the url is not associated with a site, then refuse\n+    // to create the Asset.\n+    if (!site) {\n+      throw new StoryURLInvalidError({\n+        storyURL: input.url,\n+      });\n+    }\n+    siteID = site.id;\n   }\n \n-  const story = await findOrCreateStory(mongo, tenant.id, input, now);\n+  const story = await findOrCreateStory(mongo, tenant.id, input, siteID, now);\n   if (!story) {\n     return null;\n   }\n@@ -159,7 +152,10 @@ export async function remove(\n   return removedStory;\n }\n \n-export type CreateStory = CreateStoryInput;\n+// export type CreateStory = CreateStoryInput;\n+export type CreateStory = Partial<\n+  Pick<Story, \"metadata\" | \"scrapedAt\" | \"closedAt\" | \"siteID\">\n+>;\n \n export async function create(\n   mongo: Db,\n@@ -170,16 +166,17 @@ export async function create(\n   { metadata, closedAt }: CreateStory,\n   now = new Date()\n ) {\n-  // Ensure that the given URL is allowed.\n-  if (!isURLPermitted(tenant, storyURL)) {\n+  const site = await findSiteByURL(mongo, tenant.id, storyURL);\n+  // // If the URL is provided, and the url is not associated with a site, then refuse\n+  // // to create the Asset.\n+  if (!site) {\n     throw new StoryURLInvalidError({\n       storyURL,\n-      allowedDomains: tenant.allowedDomains,\n     });\n   }\n \n   // Construct the input payload.\n-  const input: CreateStoryInput = { metadata, closedAt };\n+  const input: CreateStoryInput = { metadata, closedAt, siteID: site.id };\n   if (metadata) {\n     input.scrapedAt = now;\n   }\n@@ -211,12 +208,15 @@ export async function update(\n   input: UpdateStory,\n   now = new Date()\n ) {\n-  // Ensure that the given URL is allowed.\n-  if (input.url && !isURLPermitted(tenant, input.url)) {\n-    throw new StoryURLInvalidError({\n-      storyURL: input.url,\n-      allowedDomains: tenant.allowedDomains,\n-    });\n+  if (input.url) {\n+    const site = await findSiteByURL(mongo, tenant.id, input.url);\n+    // // If the URL is provided, and the url is not associated with a site, then refuse\n+    // // to update the Asset.\n+    if (!site) {\n+      throw new StoryURLInvalidError({\n+        storyURL: input.url,\n+      });\n+    }\n   }\n \n   return updateStory(mongo, tenant.id, storyID, input, now);\n@@ -253,19 +253,12 @@ export async function close(\n \n export async function merge(\n   mongo: Db,\n-  redis: AugmentedRedis,\n   tenant: Tenant,\n   destinationID: string,\n   sourceIDs: string[]\n ) {\n   // Create a logger for this operation.\n-  const log = logger.child(\n-    {\n-      destinationID,\n-      sourceIDs,\n-    },\n-    true\n-  );\n+  const log = logger.child({ destinationID, sourceIDs }, true);\n \n   if (sourceIDs.length === 0) {\n     log.warn(\"cannot merge from 0 stories\");\n@@ -280,22 +273,13 @@ export async function merge(\n \n   // Get the stories referenced.\n   const stories = await retrieveManyStories(mongo, tenant.id, storyIDs);\n+  if (!isNonNullArray(stories)) {\n+    throw new Error(\"cannot find all the stories\");\n+  }\n \n-  // Ensure that these are all defined.\n-  if (\n-    zip(storyIDs, stories).some(([storyID, story]) => {\n-      if (!story) {\n-        log.warn(\n-          { storyID },\n-          \"story that was going to be merged was not found\"\n-        );\n-        return true;\n-      }\n-\n-      return false;\n-    })\n-  ) {\n-    return null;\n+  // We can only merge stories if they are all on the same site.\n+  if (uniq(stories.map(({ siteID }) => siteID)).length > 1) {\n+    throw new Error(\"cannot merge stories on different sites\");\n   }\n \n   // Move all the comment's from the source stories over to the destination\n@@ -323,40 +307,33 @@ export async function merge(\n   // Merge the comment and action counts for all the source stories.\n   const [, ...sourceStories] = stories;\n \n-  let destinationStory = await updateStoryCommentStatusCount(\n+  // Compute the new comment counts from the old stories.\n+  const commentCounts = {\n+    status: mergeCommentStatusCount(\n+      ...sourceStories.map(s => s.commentCounts.status)\n+    ),\n+    moderationQueue: mergeCommentModerationQueueCount(\n+      ...sourceStories.map(s => s.commentCounts.moderationQueue)\n+    ),\n+    action: mergeCommentActionCounts(\n+      ...sourceStories.map(s => s.commentCounts.action)\n+    ),\n+  };\n+\n+  // Update the story that was the destination of the merge.\n+  const destinationStory = await updateStoryCounts(\n     mongo,\n-    redis,\n     tenant.id,\n     destinationID,\n-    mergeCommentStatusCount(\n-      // We perform the type assertion here because above, we already verified\n-      // that none of the stories are null.\n-      (sourceStories as Story[]).map(({ commentCounts: { status } }) => status)\n-    )\n+    commentCounts\n   );\n-\n-  const mergedActionCounts = mergeCommentActionCounts(\n-    // We perform the type assertion here because above, we already verified\n-    // that none of the stories are null.\n-    ...(sourceStories as Story[]).map(({ commentCounts: { action } }) => action)\n-  );\n-  if (countTotalActionCounts(mergedActionCounts) > 0) {\n-    destinationStory = await updateStoryActionCounts(\n-      mongo,\n-      redis,\n-      tenant.id,\n-      destinationID,\n-      mergedActionCounts\n-    );\n-  }\n-\n   if (!destinationStory) {\n     log.warn(\"destination story cannot be updated with new comment counts\");\n     return null;\n   }\n \n   log.debug(\n-    { commentCounts: destinationStory.commentCounts.status },\n+    { commentCounts: destinationStory.commentCounts },\n     \"updated destination story with new comment counts\"\n   );\n "
    },
    {
      "sha": "cc1637fa9a84e5e64e686666459b20ee9c7a3d3b",
      "filename": "src/core/server/services/tenant/url.spec.ts",
      "status": "removed",
      "additions": 0,
      "deletions": 105,
      "changes": 105,
      "blob_url": "https://github.com/coralproject/talk/blob/014aa2d86ad54fc1139c4fef6d05f96426c7ea91/src/core/server/services/tenant/url.spec.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/014aa2d86ad54fc1139c4fef6d05f96426c7ea91/src/core/server/services/tenant/url.spec.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/tenant/url.spec.ts?ref=014aa2d86ad54fc1139c4fef6d05f96426c7ea91",
      "patch": "@@ -1,105 +0,0 @@\n-import { Tenant } from \"coral-server/models/tenant\";\n-import { isURLPermitted } from \"coral-server/services/tenant/url\";\n-\n-type PartialTenant = Pick<Tenant, \"allowedDomains\" | \"domain\">;\n-\n-function createTenant(input: Partial<PartialTenant> = {}): PartialTenant {\n-  if (!input.domain) {\n-    input.domain = \"\";\n-  }\n-\n-  if (!input.allowedDomains) {\n-    input.allowedDomains = [];\n-  }\n-\n-  return input as PartialTenant;\n-}\n-\n-it(\"denies when the tenant has no specified domains\", () => {\n-  const tenant = { allowedDomains: [] };\n-\n-  expect(isURLPermitted(tenant, \"\")).toEqual(false);\n-});\n-\n-it(\"denies when tenant has a domain but not a valid url\", () => {\n-  const tenant = createTenant({ allowedDomains: [\"https://coralproject.net\"] });\n-\n-  expect(isURLPermitted(tenant, \"\")).toEqual(false);\n-});\n-\n-it(\"denies when there are multiple tenants allowedDomains and not a valid url\", () => {\n-  const tenant = createTenant({\n-    allowedDomains: [\n-      \"https://coralproject.net\",\n-      \"https://news.coralproject.net\",\n-    ],\n-  });\n-\n-  expect(isURLPermitted(tenant, \"\")).toEqual(false);\n-});\n-\n-it(\"denies when there are multiple tenants allowedDomains and a invalid url\", () => {\n-  const tenant = createTenant({\n-    allowedDomains: [\n-      \"https://coralproject.net\",\n-      \"https://news.coralproject.net\",\n-    ],\n-  });\n-\n-  expect(\n-    isURLPermitted(tenant, \"https://blog.coralproject.net/a/page\")\n-  ).toEqual(false);\n-});\n-\n-it(\"allows when there are multiple tenants allowedDomains and a valid url\", () => {\n-  const tenant = createTenant({\n-    allowedDomains: [\n-      \"https://coralproject.net\",\n-      \"https://news.coralproject.net\",\n-    ],\n-  });\n-\n-  expect(\n-    isURLPermitted(tenant, \"https://news.coralproject.net/a/page\")\n-  ).toEqual(true);\n-});\n-\n-it(\"allows when there are multiple prefix allowedDomains and a valid url\", () => {\n-  const tenant = createTenant({\n-    allowedDomains: [\"coralproject.net\", \"news.coralproject.net\"],\n-  });\n-\n-  expect(isURLPermitted(tenant, \"http://news.coralproject.net/a/page\")).toEqual(\n-    true\n-  );\n-});\n-\n-it(\"allows when there are some prefix allowedDomains and a valid url\", () => {\n-  const tenant = createTenant({\n-    allowedDomains: [\"http://coralproject.net\", \"news.coralproject.net\"],\n-  });\n-\n-  expect(\n-    isURLPermitted(tenant, \"https://news.coralproject.net/a/page\")\n-  ).toEqual(true);\n-});\n-\n-it(\"allows and validates with the tenant domain\", () => {\n-  const tenant = createTenant({\n-    domain: \"coralproject.net\",\n-  });\n-\n-  expect(\n-    isURLPermitted(tenant, \"https://coralproject.net/admin/login\", true)\n-  ).toEqual(true);\n-});\n-\n-it(\"denies and validates with the tenant domain\", () => {\n-  const tenant = createTenant({\n-    domain: \"coral.coralproject.net\",\n-  });\n-\n-  expect(\n-    isURLPermitted(tenant, \"https://coralproject.net/admin/login\", true)\n-  ).toEqual(false);\n-});"
    },
    {
      "sha": "91e6aeea264d6ec90c403fc5d55d599e156274c3",
      "filename": "src/core/server/stacks/approveComment.ts",
      "status": "modified",
      "additions": 5,
      "deletions": 3,
      "changes": 8,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/stacks/approveComment.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/stacks/approveComment.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/stacks/approveComment.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -9,7 +9,7 @@ import { AugmentedRedis } from \"coral-server/services/redis\";\n \n import { GQLCOMMENT_STATUS } from \"coral-server/graph/schema/__generated__/types\";\n \n-import { publishChanges, updateAllCounts } from \"./helpers\";\n+import { publishChanges, updateAllCommentCounts } from \"./helpers\";\n \n const approveComment = async (\n   mongo: Db,\n@@ -36,9 +36,11 @@ const approveComment = async (\n   );\n \n   // Update all the comment counts on stories and users.\n-  const counts = await updateAllCounts(mongo, redis, {\n-    tenant,\n+  const counts = await updateAllCommentCounts(mongo, redis, {\n     ...result,\n+    tenant,\n+    // Rejecting a comment does not change the action counts.\n+    actionCounts: {},\n   });\n \n   // Publish changes to the event publisher."
    },
    {
      "sha": "326a436a5aedc82ea4661ce2aecefe9b072eff2f",
      "filename": "src/core/server/stacks/createComment.ts",
      "status": "modified",
      "additions": 11,
      "deletions": 12,
      "changes": 23,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/stacks/createComment.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/stacks/createComment.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/stacks/createComment.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -12,6 +12,7 @@ import { Publisher } from \"coral-server/graph/subscriptions/publisher\";\n import logger from \"coral-server/logger\";\n import {\n   encodeActionCounts,\n+  EncodedCommentActionCounts,\n   filterDuplicateActions,\n } from \"coral-server/models/action/comment\";\n import {\n@@ -47,11 +48,11 @@ import { AugmentedRedis } from \"coral-server/services/redis\";\n import { updateUserLastCommentID } from \"coral-server/services/users\";\n import { Request } from \"coral-server/types/express\";\n \n-import { publishChanges, updateAllCounts } from \"./helpers\";\n+import { publishChanges, updateAllCommentCounts } from \"./helpers\";\n \n export type CreateComment = Omit<\n   CreateCommentInput,\n-  \"status\" | \"metadata\" | \"ancestorIDs\" | \"actionCounts\" | \"tags\"\n+  \"status\" | \"metadata\" | \"ancestorIDs\" | \"actionCounts\" | \"tags\" | \"siteID\"\n >;\n \n export default async function create(\n@@ -151,14 +152,11 @@ export default async function create(\n   // for the first time to ensure that the data is there for when the next flag\n   // is added, that it can already know that the comment is already in the\n   // queue.\n-  let actionCounts = {};\n+  let actionCounts: EncodedCommentActionCounts = {};\n   if (actions.length > 0) {\n     // Determine the unique actions, we will use this to compute the comment\n     // action counts. This should match what is added below.\n-    const deDuplicatedActions = filterDuplicateActions(actions);\n-\n-    // Encode the action counts.\n-    actionCounts = encodeActionCounts(...deDuplicatedActions);\n+    actionCounts = encodeActionCounts(...filterDuplicateActions(actions));\n   }\n \n   // Create the comment!\n@@ -167,6 +165,7 @@ export default async function create(\n     tenant.id,\n     {\n       ...input,\n+      siteID: story.siteID,\n       tags,\n       body,\n       status,\n@@ -177,6 +176,7 @@ export default async function create(\n     now\n   );\n \n+  // Updating some associated data.\n   await Promise.all([\n     updateUserLastCommentID(redis, tenant, author, comment.id),\n     updateStoryLastCommentedAt(mongo, tenant.id, story.id, now),\n@@ -207,7 +207,7 @@ export default async function create(\n   if (actions.length > 0) {\n     // Actually add the actions to the database. This will not interact with the\n     // counts at all.\n-    const upsertedActions = await addCommentActions(\n+    await addCommentActions(\n       mongo,\n       tenant,\n       actions.map(\n@@ -218,25 +218,24 @@ export default async function create(\n \n           // Store the Story ID on the action.\n           storyID: story.id,\n+          siteID: story.siteID,\n         })\n       ),\n       now\n     );\n-\n-    log.trace({ actions: upsertedActions.length }, \"added actions to comment\");\n   }\n \n   // Update all the comment counts on stories and users.\n-  const counts = await updateAllCounts(mongo, redis, {\n+  const counts = await updateAllCommentCounts(mongo, redis, {\n     tenant,\n+    actionCounts,\n     after: comment,\n   });\n \n   // Publish changes to the event publisher.\n   await publishChanges(publisher, {\n     ...counts,\n     after: comment,\n-    moderatorID: null,\n   });\n \n   // If this is a reply, publish it."
    },
    {
      "sha": "b4e471f8b0ae34d4278cb43e9fe0ef785a5f7518",
      "filename": "src/core/server/stacks/editComment.ts",
      "status": "modified",
      "additions": 10,
      "deletions": 20,
      "changes": 30,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/stacks/editComment.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/stacks/editComment.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/stacks/editComment.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -8,6 +8,7 @@ import { Publisher } from \"coral-server/graph/subscriptions/publisher\";\n import logger from \"coral-server/logger\";\n import {\n   encodeActionCounts,\n+  EncodedCommentActionCounts,\n   filterDuplicateActions,\n } from \"coral-server/models/action/comment\";\n import { createCommentModerationAction } from \"coral-server/models/action/moderation/comment\";\n@@ -28,7 +29,7 @@ import { processForModeration } from \"coral-server/services/comments/pipeline\";\n import { AugmentedRedis } from \"coral-server/services/redis\";\n import { Request } from \"coral-server/types/express\";\n \n-import { publishChanges, updateAllCounts } from \"./helpers\";\n+import { publishChanges, updateAllCommentCounts } from \"./helpers\";\n \n /**\n  * getLastCommentEditableUntilDate will return the `createdAt` date that will\n@@ -116,18 +117,13 @@ export default async function edit(\n     now,\n   });\n \n-  let actionCounts = {};\n+  let actionCounts: EncodedCommentActionCounts = {};\n   if (actions.length > 0) {\n     // Encode the new action counts that are going to be added to the new\n     // revision.\n     actionCounts = encodeActionCounts(...filterDuplicateActions(actions));\n   }\n \n-  log.trace(\n-    { predictedActionCounts: actionCounts },\n-    \"associating action counts with comment\"\n-  );\n-\n   // Perform the edit.\n   const result = await editComment(\n     mongo,\n@@ -149,9 +145,10 @@ export default async function edit(\n \n   log = log.child({ revisionID: result.revision.id }, true);\n \n+  // If there were actions to insert, then insert them into the commentActions\n+  // collection.\n   if (actions.length > 0) {\n-    // Insert and handle creating the actions.\n-    const upsertedActions = await addCommentActions(\n+    await addCommentActions(\n       mongo,\n       tenant,\n       actions.map(\n@@ -160,22 +157,15 @@ export default async function edit(\n           commentID: result.after.id,\n           commentRevisionID: result.revision.id,\n           storyID: story.id,\n+          siteID: story.siteID,\n         })\n       ),\n       now\n     );\n-\n-    log.trace(\n-      {\n-        actualActionCounts: encodeActionCounts(...upsertedActions),\n-        actions: upsertedActions.length,\n-      },\n-      \"added actions to comment\"\n-    );\n   }\n \n   // If the comment status changed as a result of a pipeline operation, create a\n-  // moderation action.\n+  // moderation action (but don't associate it with a moderator).\n   if (result.before.status !== result.after.status) {\n     await createCommentModerationAction(\n       mongo,\n@@ -191,16 +181,16 @@ export default async function edit(\n   }\n \n   // Update all the comment counts on stories and users.\n-  const counts = await updateAllCounts(mongo, redis, {\n+  const counts = await updateAllCommentCounts(mongo, redis, {\n     tenant,\n+    actionCounts,\n     ...result,\n   });\n \n   // Publish changes to the event publisher.\n   await publishChanges(publisher, {\n     ...result,\n     ...counts,\n-    moderatorID: null,\n   });\n \n   // Return the resulting comment."
    },
    {
      "sha": "24be18cf483a738e717f3e4869a82425216f72a9",
      "filename": "src/core/server/stacks/helpers/index.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/stacks/helpers/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/stacks/helpers/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/stacks/helpers/index.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,2 +1,2 @@\n export { default as publishChanges } from \"./publishChanges\";\n-export { default as updateAllCounts } from \"./updateAllCounts\";\n+export { default as updateAllCommentCounts } from \"./updateAllCommentCounts\";"
    },
    {
      "sha": "2461615ce8910c9057de98047f7cf8c112635e2f",
      "filename": "src/core/server/stacks/helpers/publishChanges.ts",
      "status": "modified",
      "additions": 3,
      "deletions": 3,
      "changes": 6,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/stacks/helpers/publishChanges.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/stacks/helpers/publishChanges.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/stacks/helpers/publishChanges.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,10 +1,10 @@\n import { Publisher } from \"coral-server/graph/subscriptions/publisher\";\n import {\n   Comment,\n+  CommentModerationQueueCounts,\n   hasModeratorStatus,\n   hasPublishedStatus,\n } from \"coral-server/models/comment\";\n-import { CommentModerationQueueCounts } from \"coral-server/models/story\";\n import {\n   publishCommentReleased,\n   publishCommentStatusChanges,\n@@ -15,7 +15,7 @@ interface PublishChangesInput {\n   before?: Readonly<Comment>;\n   after: Readonly<Comment>;\n   moderationQueue: CommentModerationQueueCounts;\n-  moderatorID: string | null;\n+  moderatorID?: string;\n }\n \n export default async function publishChanges(\n@@ -33,7 +33,7 @@ export default async function publishChanges(\n       input.before.status,\n       input.after.status,\n       input.after.id,\n-      input.moderatorID\n+      input.moderatorID || null\n     );\n \n     if (hasModeratorStatus(input.before) && hasPublishedStatus(input.after)) {"
    },
    {
      "sha": "9663b34f609190e0671cd0707812dda0a627bc1e",
      "filename": "src/core/server/stacks/helpers/updateAllCommentCounts.ts",
      "status": "renamed",
      "additions": 43,
      "deletions": 13,
      "changes": 56,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/stacks/helpers/updateAllCommentCounts.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/stacks/helpers/updateAllCommentCounts.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/stacks/helpers/updateAllCommentCounts.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -1,10 +1,14 @@\n import { Db } from \"mongodb\";\n \n-import { Comment, CommentStatusCounts } from \"coral-server/models/comment\";\n+import { EncodedCommentActionCounts } from \"coral-server/models/action/comment\";\n import {\n+  Comment,\n   CommentModerationQueueCounts,\n-  updateStoryCounts,\n-} from \"coral-server/models/story\";\n+  CommentStatusCounts,\n+  updateSharedCommentCounts,\n+} from \"coral-server/models/comment\";\n+import { updateSiteCounts } from \"coral-server/models/site\";\n+import { updateStoryCounts } from \"coral-server/models/story\";\n import { Tenant } from \"coral-server/models/tenant\";\n import { updateUserCommentCounts } from \"coral-server/models/user\";\n import {\n@@ -13,14 +17,25 @@ import {\n } from \"coral-server/services/comments/moderation\";\n import { AugmentedRedis } from \"coral-server/services/redis\";\n \n-interface UpdateAllCountsInput {\n+interface UpdateAllCommentCountsInput {\n   tenant: Readonly<Tenant>;\n-  before?: Readonly<Comment>;\n   after: Readonly<Comment>;\n+\n+  /**\n+   * actionCounts when provided will increment the related entries for an\n+   * operation that creates actions.\n+   */\n+  actionCounts: Readonly<EncodedCommentActionCounts>;\n+\n+  /**\n+   * before when provided is used when a comment has been changed. A comment\n+   * that has just been created should not provide before.\n+   */\n+  before?: Readonly<Comment>;\n }\n \n function calculateModerationQueue(\n-  input: UpdateAllCountsInput\n+  input: UpdateAllCommentCountsInput\n ): CommentModerationQueueCounts {\n   if (input.before) {\n     return calculateCountsDiff(input.before, input.after);\n@@ -30,7 +45,7 @@ function calculateModerationQueue(\n }\n \n function calculateStatus(\n-  input: UpdateAllCountsInput\n+  input: UpdateAllCommentCountsInput\n ): Partial<CommentStatusCounts> {\n   if (input.before) {\n     if (input.before.status !== input.after.status) {\n@@ -48,10 +63,10 @@ function calculateStatus(\n   };\n }\n \n-export default async function updateAllCounts(\n+export default async function updateAllCommentCounts(\n   mongo: Db,\n   redis: AugmentedRedis,\n-  input: UpdateAllCountsInput\n+  input: UpdateAllCommentCountsInput\n ) {\n   // Compute the queue difference as a result of the old status and the new\n   // status and the action counts.\n@@ -63,23 +78,38 @@ export default async function updateAllCounts(\n   // Pull out some params from the input for easier usage.\n   const {\n     tenant,\n-    after: { storyID, authorID },\n+    actionCounts: action,\n+    after: { storyID, authorID, siteID },\n   } = input;\n \n-  // Update the story comment counts.\n-  await updateStoryCounts(mongo, redis, tenant.id, storyID, {\n+  // Update the story, site, and user comment counts.\n+  await updateStoryCounts(mongo, tenant.id, storyID, {\n+    action,\n+    status,\n+    moderationQueue,\n+  });\n+\n+  await updateSiteCounts(mongo, tenant.id, siteID, {\n+    action,\n     status,\n     moderationQueue,\n   });\n \n   if (authorID) {\n-    // Update the user comment counts.\n     await updateUserCommentCounts(mongo, tenant.id, authorID, {\n       status,\n     });\n   }\n \n+  // Update the shared counts.\n+  await updateSharedCommentCounts(redis, tenant.id, {\n+    action,\n+    status,\n+    moderationQueue,\n+  });\n+\n   return {\n+    action,\n     status,\n     moderationQueue,\n   };",
      "previous_filename": "src/core/server/stacks/helpers/updateAllCounts.ts"
    },
    {
      "sha": "0a1d166113032c987622a335faf173b467b7bc0b",
      "filename": "src/core/server/stacks/rejectComment.ts",
      "status": "modified",
      "additions": 5,
      "deletions": 3,
      "changes": 8,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/stacks/rejectComment.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/core/server/stacks/rejectComment.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/stacks/rejectComment.ts?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -14,7 +14,7 @@ import {\n   GQLTAG,\n } from \"coral-server/graph/schema/__generated__/types\";\n \n-import { publishChanges, updateAllCounts } from \"./helpers\";\n+import { publishChanges, updateAllCommentCounts } from \"./helpers\";\n \n const rejectComment = async (\n   mongo: Db,\n@@ -41,9 +41,11 @@ const rejectComment = async (\n   );\n \n   // Update all the comment counts on stories and users.\n-  const counts = await updateAllCounts(mongo, redis, {\n-    tenant,\n+  const counts = await updateAllCommentCounts(mongo, redis, {\n     ...result,\n+    tenant,\n+    // Rejecting a comment does not change the action counts.\n+    actionCounts: {},\n   });\n \n   // Publish changes to the event publisher."
    },
    {
      "sha": "bee9b1707e5973fbc34cba4f5e1d2b9f5f105f63",
      "filename": "src/locales/en-US/admin.ftl",
      "status": "modified",
      "additions": 33,
      "deletions": 0,
      "changes": 33,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/locales/en-US/admin.ftl",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/locales/en-US/admin.ftl",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/locales/en-US/admin.ftl?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -164,8 +164,12 @@ configure-general-closedStreamMessage-explanation = Write a message to appear wh\n \n ### Organization\n configure-organization-name = Organization name\n+configure-organization-sites = Sites\n configure-organization-nameExplanation =\n   Your organization name will appear on emails sent by { -product-name } to your community and organization members.\n+configure-organization-sites-explanation =\n+  Add a new site to your organization or edit an existing site's details.\n+configure-organization-sites-add-site = <icon>add</icon> Add site\n configure-organization-email = Organization email\n configure-organization-emailExplanation =\n   This email address will be used as in emails and across the platform\n@@ -176,6 +180,35 @@ configure-organization-url = Organization URL\n configure-organization-urlExplanation =\n   Your organization url will appear on emails sent by { -product-name } to your community and organization members.\n \n+### Sites\n+configure-sites-site-details = Details <icon>keyboard_arrow_right</icon>\n+configure-sites-add-new-site = Add a new site to { $site }\n+configure-sites-add-success = { $site } has been added to { $org }\n+configure-sites-edit-success = Changes to { $site } have been saved.\n+configure-sites-site-form-name = Site name\n+configure-sites-site-form-name-explanation = Site name will appear on emails sent by Coral to your community and organization members.\n+configure-sites-site-form-url = Site URL\n+configure-sites-site-form-url-explanation = This url will appear on emails sent by Coral to your community members.\n+configure-sites-site-form-email = Site email address\n+configure-sites-site-form-url-explanation = This email address is for community members to contact you with questions or if they need help. e.g. comments@yoursite.com\n+configure-sites-site-form-domains = Site permitted domains\n+configure-sites-site-form-domains-explanation = Domains where your Coral comment streams are allowed to be embedded (ex. http://localhost:3000, https://staging.domain.com, https://domain.com).\n+configure-sites-site-form-submit = <icon>add</icon> Add site\n+configure-sites-site-form-cancel = Cancel\n+configure-sites-site-form-save = Save changes\n+configure-sites-site-edit = Edit { $site } details\n+configure-sites-site-form-embed-code = Embed code\n+sites-emptyMessage = We could not find any sites matching your criteria.\n+sites-selector-allSites = All sites\n+sites-filter-sites-allSites = All sites\n+\n+site-selector-all-sites = All sites\n+stories-filter-sites-allSites = All sites\n+stories-filter-statuses = Status\n+stories-column-site = Site\n+site-table-siteName = Site name\n+stories-filter-sites = Site\n+\n ### Email\n \n configure-email = Email settings"
    },
    {
      "sha": "5d5be28e0830f4aa4e9adb898ce11b7277e5e187",
      "filename": "src/locales/en-US/install.ftl",
      "status": "modified",
      "additions": 41,
      "deletions": 23,
      "changes": 64,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/locales/en-US/install.ftl",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/locales/en-US/install.ftl",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/locales/en-US/install.ftl?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -8,56 +8,74 @@ install-header-title = { -product-name } Installation Wizard\n install-initialStep-theRemainder = The remainder of the installation wizard will take about 10 minutes. Once you are finished, you will have your own instance of { -product-name }.\n install-initialStep-getStarted = Get Started\n \n-install-selectLanguage-stepTitleSelect = Select Language\n-install-selectLanguage-selectLanguage = Select language for Coral\n+install-selectLanguage-stepTitleSelect = Select language\n+install-selectLanguage-selectLanguage = Select a language for Coral\n install-selectLanguage-description =\n   Choose the language to be used during the installation process.\n   This will also be the default language for your Coral community.\n install-selectLanguage-language = Language\n \n-install-addOrganization-stepTitle = Add Organization Details\n-install-addOrganization-title = Add Organization\n-install-addOrganization-description = Please tell us the name of your organization. This will appear in emails when inviting new team members.\n-install-addOrganization-orgName = Organization Name\n+install-addOrganization-stepTitle = Organization and site details\n+install-addOrganization-title = Add Organization and site details\n+install-addOrganization-description =\n+  Please provide your organization name and information for your site. If your organization has multiple sites, you can add them after this installer is completed from the Coral Admin.\n+install-addOrganization-orgName = Organization name\n install-addOrganization-orgNameTextField =\n-   .placeholder = Organization Name\n-install-addOrganization-orgEmail = Organization Contact Email\n+   .placeholder = Organization name\n+install-addSite-siteName = Site name\n+install-addSite-siteNameTextField =\n+   .placeholder = Site name\n+install-addSite-siteNameDescription =\n+  Site name will appear on emails sent by Coral to your community and organization members.\n+install-addOrganization-orgEmail = Organization contact email\n install-addOrganization-orgEmailTextField =\n-  .placeholder = Organization Contact Email\n+  .placeholder = Organization contact email\n+install-addSite-siteEmail = Contact email address\n+install-addSite-siteEmailTextField =\n+  .placeholder = Contact email\n+install-addSite-siteEmailDescription =\n+  This email address is for community members to contact you with questions or if they need help. e.g. comments@yoursite.com\n install-addOrganization-orgURL = Organization URL\n install-addOrganization-orgURLTextField =\n   .placeholder = Organization URL\n+install-addSite-siteURL = Organization URL\n+install-addSite-siteURLTextField =\n+  .placeholder = Organization URL\n+install-addSite-siteURLDescription =\n+  This url will appear on emails sent by Coral to your community members.\n install-addOrganization-orgURLDescription = Be sure to include <strong>http://</strong> or <strong>https://</strong> in your URL\n \n-install-createYourAccount-stepTitle = Create Admin Account\n-install-createYourAccount-title = Create an Administrator Account\n-install-createYourAccount-email = Email\n+install-createYourAccount-stepTitle = Create admin account\n+install-createYourAccount-title = Create an admin account\n+install-createYourAccount-email = Email address\n install-createYourAccount-emailTextField =\n   .placeholder = Email\n install-createYourAccount-username = Username\n install-createYourAccount-usernameTextField =\n   .placeholder = Username\n-install-createYourAccount-usernameDescription = An identifier displayed on your comments. You may use “_” and “.”\n+install-createYourAccount-usernameDescription = An identifier displayed on your comments. You may use “_” and “.” Spaces not permitted\n install-createYourAccount-password = Password\n install-createYourAccount-passwordTextField =\n   .placeholder = Password\n install-createYourAccount-passwordDescription = Must be at least 8 characters\n-install-createYourAccount-confirmPassword = Confirm Password\n+install-createYourAccount-confirmPassword = Confirm password\n install-createYourAccount-confirmPasswordTextField =\n-  .placeholder = Confirm Password\n+  .placeholder = Confirm password\n \n-install-permittedDomains-stepTitle = Add Permitted Domains\n-install-permittedDomains-title = Permitted Domains\n+install-permittedDomains-stepTitle = Permitted domains\n+install-permittedDomains-title = Site permitted Domains\n install-permittedDomains-description-with-scheme =\n-  Enter the domains you would like to permit for { -product-name }, e.g.\n-  your local, staging and production environments including the\n-  scheme (ex. http://localhost:3000, https://staging.domain.com,\n+  Domains where your { -product-name } comment streams are allowed to be embedded\n+  (ex. http://localhost:3000, https://staging.domain.com,\n   https://domain.com).\n-install-permittedDomains-permittedDomains = Permitted Domains\n+install-permittedDomains-permittedDomains = Permitted domains\n install-permittedDomains-permittedDomainsTextField =\n   .placeholder = Domains\n-install-permittedDomains-permittedDomainsDescription = Insert domains separated by comma\n+install-permittedDomains-permittedDomainsDescription = Enter domains separated by comma\n \n-install-finalStep-description = Thanks for installing { -product-name }! We sent an email to verify your email address. While you finish setting up the account, you can start engaging with your readers now.\n+install-finalStep-stepTitle = Complete\n+install-finalStep-title = Installation complete\n+install-finalStep-description =\n+  Continue to the { -product-name } Admin to complete the setup of your organization and site.\n install-finalStep-goToTheDocs = Go to the Docs\n install-finalStep-goToAdmin = Go to Admin"
    },
    {
      "sha": "49a5d78dd6d85844dc7f90df938f854a5800786b",
      "filename": "src/locales/pt-BR/install.ftl",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/707d65a11901d24b81c3207e125c7a28c2900056/src/locales/pt-BR/install.ftl",
      "raw_url": "https://github.com/coralproject/talk/raw/707d65a11901d24b81c3207e125c7a28c2900056/src/locales/pt-BR/install.ftl",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/locales/pt-BR/install.ftl?ref=707d65a11901d24b81c3207e125c7a28c2900056",
      "patch": "@@ -48,7 +48,7 @@ install-createYourAccount-confirmPasswordTextField =\n \n install-permittedDomains-stepTitle = Adicionar domínios permitidos\n install-permittedDomains-title =  Domínios Permitidos\n-install-permittedDomains-description-with-schema =\n+install-allowedOrigins-description-with-schema =\n    Digite os domínios que você deseja permitir para { -product-name }, por exemplo\n    seus ambientes locais, de preparação e produção, incluindo o\n    protocolo (por exemplo, http: // localhost: 3000, https://staging.domain.com,"
    }
  ]
}
