{
  "sha": "453bec9394d260f38a6ec90ac0dfe5af3c9b0ff0",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODo0NTNiZWM5Mzk0ZDI2MGYzOGE2ZWM5MGFjMGRmZTVhZjNjOWIwZmYw",
  "commit": {
    "author": {
      "name": "Gerhard Schlager",
      "email": "mail@gerhard-schlager.at",
      "date": "2020-02-11T14:48:58Z"
    },
    "committer": {
      "name": "Gerhard Schlager",
      "email": "mail@gerhard-schlager.at",
      "date": "2020-02-12T15:23:17Z"
    },
    "message": "FEATURE: Add small action post to indicate forwarded email\n\nThis happens only when the sender of the email didn't write anything in their email.",
    "tree": {
      "sha": "b6cf840a2034fc5a761e40ad859996477a7141b0",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/b6cf840a2034fc5a761e40ad859996477a7141b0"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/453bec9394d260f38a6ec90ac0dfe5af3c9b0ff0",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/453bec9394d260f38a6ec90ac0dfe5af3c9b0ff0",
  "html_url": "https://github.com/discourse/discourse/commit/453bec9394d260f38a6ec90ac0dfe5af3c9b0ff0",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/453bec9394d260f38a6ec90ac0dfe5af3c9b0ff0/comments",
  "author": {
    "login": "gschlager",
    "id": 473736,
    "node_id": "MDQ6VXNlcjQ3MzczNg==",
    "avatar_url": "https://avatars3.githubusercontent.com/u/473736?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gschlager",
    "html_url": "https://github.com/gschlager",
    "followers_url": "https://api.github.com/users/gschlager/followers",
    "following_url": "https://api.github.com/users/gschlager/following{/other_user}",
    "gists_url": "https://api.github.com/users/gschlager/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gschlager/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gschlager/subscriptions",
    "organizations_url": "https://api.github.com/users/gschlager/orgs",
    "repos_url": "https://api.github.com/users/gschlager/repos",
    "events_url": "https://api.github.com/users/gschlager/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gschlager/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "gschlager",
    "id": 473736,
    "node_id": "MDQ6VXNlcjQ3MzczNg==",
    "avatar_url": "https://avatars3.githubusercontent.com/u/473736?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gschlager",
    "html_url": "https://github.com/gschlager",
    "followers_url": "https://api.github.com/users/gschlager/followers",
    "following_url": "https://api.github.com/users/gschlager/following{/other_user}",
    "gists_url": "https://api.github.com/users/gschlager/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gschlager/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gschlager/subscriptions",
    "organizations_url": "https://api.github.com/users/gschlager/orgs",
    "repos_url": "https://api.github.com/users/gschlager/repos",
    "events_url": "https://api.github.com/users/gschlager/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gschlager/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "0adab26e454625b266e972c94a52811d8832d938",
      "url": "https://api.github.com/repos/discourse/discourse/commits/0adab26e454625b266e972c94a52811d8832d938",
      "html_url": "https://github.com/discourse/discourse/commit/0adab26e454625b266e972c94a52811d8832d938"
    }
  ],
  "stats": {
    "total": 34,
    "additions": 33,
    "deletions": 1
  },
  "files": [
    {
      "sha": "8c36aa47ddada01dce2b62fd7e193324cf4f57d4",
      "filename": "config/locales/client.en.yml",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/discourse/discourse/blob/453bec9394d260f38a6ec90ac0dfe5af3c9b0ff0/config/locales/client.en.yml",
      "raw_url": "https://github.com/discourse/discourse/raw/453bec9394d260f38a6ec90ac0dfe5af3c9b0ff0/config/locales/client.en.yml",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/config/locales/client.en.yml?ref=453bec9394d260f38a6ec90ac0dfe5af3c9b0ff0",
      "patch": "@@ -184,6 +184,7 @@ en:\n       banner:\n         enabled: \"made this a banner %{when}. It will appear at the top of every page until it is dismissed by the user.\"\n         disabled: \"removed this banner %{when}. It will no longer appear at the top of every page.\"\n+      forwarded: \"forwarded the above email\"\n \n     topic_admin_menu: \"topic actions\"\n "
    },
    {
      "sha": "69f7ccf2704f3e8ce640bf510c03335960d4e063",
      "filename": "lib/email/receiver.rb",
      "status": "modified",
      "additions": 3,
      "deletions": 1,
      "changes": 4,
      "blob_url": "https://github.com/discourse/discourse/blob/453bec9394d260f38a6ec90ac0dfe5af3c9b0ff0/lib/email/receiver.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/453bec9394d260f38a6ec90ac0dfe5af3c9b0ff0/lib/email/receiver.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/lib/email/receiver.rb?ref=453bec9394d260f38a6ec90ac0dfe5af3c9b0ff0",
      "patch": "@@ -844,7 +844,7 @@ def forwarded_email_create_replies(destination, user)\n                                           embedded_user: lambda { find_or_create_user(email, display_name) })\n       return false unless post\n \n-      if post&.topic\n+      if post.topic\n         # mark post as seen for the forwarder\n         PostTiming.record_timing(user_id: user.id, topic_id: post.topic_id, post_number: post.post_number, msecs: 5000)\n \n@@ -859,6 +859,8 @@ def forwarded_email_create_replies(destination, user)\n                        topic: post.topic,\n                        post_type: post_type,\n                        skip_validations: user.staged?)\n+        else\n+          post.topic.add_small_action(user, \"forwarded\")\n         end\n       end\n "
    },
    {
      "sha": "a7dd5e6b71cc3e69e7abc81a1762cdab9e2e53de",
      "filename": "spec/components/email/receiver_spec.rb",
      "status": "modified",
      "additions": 12,
      "deletions": 0,
      "changes": 12,
      "blob_url": "https://github.com/discourse/discourse/blob/453bec9394d260f38a6ec90ac0dfe5af3c9b0ff0/spec/components/email/receiver_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/453bec9394d260f38a6ec90ac0dfe5af3c9b0ff0/spec/components/email/receiver_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/components/email/receiver_spec.rb?ref=453bec9394d260f38a6ec90ac0dfe5af3c9b0ff0",
      "patch": "@@ -888,6 +888,18 @@ def create_post_reply_key(value)\n         expect { process(:forwarded_email_3) }.to change(Topic, :count)\n       end\n \n+      it \"adds a small action post to explain who forwarded the email when the sender didn't write anything\" do\n+        expect { process(:forwarded_email_4) }.to change(Topic, :count)\n+\n+        forwarded_post, last_post = *Post.last(2)\n+\n+        expect(forwarded_post.user.email).to eq(\"some@one.com\")\n+        expect(forwarded_post.raw).to match(/XoXo/)\n+\n+        expect(last_post.user.email).to eq(\"ba@bar.com\")\n+        expect(last_post.post_type).to eq(Post.types[:small_action])\n+        expect(last_post.action_code).to eq(\"forwarded\")\n+      end\n     end\n \n     context \"with forwarded emails behaviour set to quote\" do"
    },
    {
      "sha": "c50c1d129a16d9bddc1bb4ce6ae076f06dca3bef",
      "filename": "spec/fixtures/emails/forwarded_email_4.eml",
      "status": "added",
      "additions": 17,
      "deletions": 0,
      "changes": 17,
      "blob_url": "https://github.com/discourse/discourse/blob/453bec9394d260f38a6ec90ac0dfe5af3c9b0ff0/spec/fixtures/emails/forwarded_email_4.eml",
      "raw_url": "https://github.com/discourse/discourse/raw/453bec9394d260f38a6ec90ac0dfe5af3c9b0ff0/spec/fixtures/emails/forwarded_email_4.eml",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/fixtures/emails/forwarded_email_4.eml?ref=453bec9394d260f38a6ec90ac0dfe5af3c9b0ff0",
      "patch": "@@ -0,0 +1,17 @@\n+Message-ID: <62@foo.bar.mail>\n+From: Ba Bar <ba@bar.com>\n+To: Team <team@bar.com>\n+Date: Mon, 1 Dec 2016 13:37:42 +0100\n+Subject: Fwd: Discoursing much?\n+\n+---------- Forwarded message ---------\n+From: Some One <some@one.com>\n+To: Ba Bar <ba@bar.com>\n+Date: Mon, 1 Dec 2016 00:13:37 +0100\n+Subject: Discoursing much?\n+\n+Hello Ba Bar,\n+\n+Discoursing much today?\n+\n+XoXo"
    }
  ]
}
