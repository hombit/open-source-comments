{
  "sha": "cf0c6d5761a0430ec8d5d2875008dd7487865d64",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODpjZjBjNmQ1NzYxYTA0MzBlYzhkNWQyODc1MDA4ZGQ3NDg3ODY1ZDY0",
  "commit": {
    "author": {
      "name": "Dan Ungureanu",
      "email": "dan@ungureanu.me",
      "date": "2020-02-21T14:59:00Z"
    },
    "committer": {
      "name": "Dan Ungureanu",
      "email": "dan@ungureanu.me",
      "date": "2020-02-21T15:02:40Z"
    },
    "message": "FIX: Ensure web hooks are retried at most 5 times",
    "tree": {
      "sha": "db08273e0524ebbb19b57c3e94d13ce16a655e83",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/db08273e0524ebbb19b57c3e94d13ce16a655e83"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/cf0c6d5761a0430ec8d5d2875008dd7487865d64",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\niQJFBAABCAAvFiEEZFlnr23WAUkE+3y4CqKgDWrMi4QFAl5P8RARHGRhbkB1bmd1\ncmVhbnUubWUACgkQCqKgDWrMi4SGVQ/+JxPBw2aLZN1ScrcX//GAwSdGF1T8BQEf\nQfJlWVo59XHcuQHNXRogk1k+mPNlapVlqhSX/ZIuyTwvFGmp+2q0p0PlldiGj2yr\nsmTZxMi55MvwbD0ynHwVG/DALp2m9s2lkUYBt8PyMfTfkHXYX+9xkQYsDYKBB1iD\nyllCGW969sNSaO+ijSWkuyY6vbGrCpuwMrrwIB5G5kOxki50lnYlX8vX/1/yE8XA\n54Xz6uOr1TVMn+x4uq/Sia9R2kGlpZTRlSijyotr9fcdVrPZoiO5aK3PrjGxjEwp\nyW6UiaUUz7vqtOP2KybmnuEAYYcH47MGHmSZRMp+NrjxZkRk0h51M2KB9RM1XJkx\ncbCu1+F6ENO/IyjR0LZlwTZcP3IUFjSZd1u63ZlhdMteGRRSvG3oCdSiJ2kjOtOu\nvFz0uM01nbueIF72HrYPl9iTefUhtwiQMs6pSpPYf+yR5vfMzyjmaiv8JehS0opW\neijk1Ode1Y4r9qLiLUSmMnffvEMKTXh7DNp6MXn3Vr7gu5HvP7OulMHi6191IYB2\nAbsNZaxaBhq03PWRBAaQL4bCDTpd1ChCYArYkQQoEXD5Jko0raT4kbyIfA4kVHfj\nmb2PyvCveWJRleDPMhqVximDASHdB8V4/kQO+X9TqtpVuYuFq14AO240CFgl7yEF\nhYe1oRy9RSI=\n=YlTI\n-----END PGP SIGNATURE-----",
      "payload": "tree db08273e0524ebbb19b57c3e94d13ce16a655e83\nparent 6ba326a9f4051e0fa897a7663bcb581bdcbc8abd\nauthor Dan Ungureanu <dan@ungureanu.me> 1582297140 +0200\ncommitter Dan Ungureanu <dan@ungureanu.me> 1582297360 +0200\n\nFIX: Ensure web hooks are retried at most 5 times\n"
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/cf0c6d5761a0430ec8d5d2875008dd7487865d64",
  "html_url": "https://github.com/discourse/discourse/commit/cf0c6d5761a0430ec8d5d2875008dd7487865d64",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/cf0c6d5761a0430ec8d5d2875008dd7487865d64/comments",
  "author": {
    "login": "udan11",
    "id": 4147664,
    "node_id": "MDQ6VXNlcjQxNDc2NjQ=",
    "avatar_url": "https://avatars1.githubusercontent.com/u/4147664?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/udan11",
    "html_url": "https://github.com/udan11",
    "followers_url": "https://api.github.com/users/udan11/followers",
    "following_url": "https://api.github.com/users/udan11/following{/other_user}",
    "gists_url": "https://api.github.com/users/udan11/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/udan11/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/udan11/subscriptions",
    "organizations_url": "https://api.github.com/users/udan11/orgs",
    "repos_url": "https://api.github.com/users/udan11/repos",
    "events_url": "https://api.github.com/users/udan11/events{/privacy}",
    "received_events_url": "https://api.github.com/users/udan11/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "udan11",
    "id": 4147664,
    "node_id": "MDQ6VXNlcjQxNDc2NjQ=",
    "avatar_url": "https://avatars1.githubusercontent.com/u/4147664?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/udan11",
    "html_url": "https://github.com/udan11",
    "followers_url": "https://api.github.com/users/udan11/followers",
    "following_url": "https://api.github.com/users/udan11/following{/other_user}",
    "gists_url": "https://api.github.com/users/udan11/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/udan11/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/udan11/subscriptions",
    "organizations_url": "https://api.github.com/users/udan11/orgs",
    "repos_url": "https://api.github.com/users/udan11/repos",
    "events_url": "https://api.github.com/users/udan11/events{/privacy}",
    "received_events_url": "https://api.github.com/users/udan11/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "6ba326a9f4051e0fa897a7663bcb581bdcbc8abd",
      "url": "https://api.github.com/repos/discourse/discourse/commits/6ba326a9f4051e0fa897a7663bcb581bdcbc8abd",
      "html_url": "https://github.com/discourse/discourse/commit/6ba326a9f4051e0fa897a7663bcb581bdcbc8abd"
    }
  ],
  "stats": {
    "total": 14,
    "additions": 14,
    "deletions": 0
  },
  "files": [
    {
      "sha": "ffd8e410ec58db74cba1d27ac9b471bf871ff054",
      "filename": "app/jobs/regular/emit_web_hook_event.rb",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/discourse/discourse/blob/cf0c6d5761a0430ec8d5d2875008dd7487865d64/app/jobs/regular/emit_web_hook_event.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/cf0c6d5761a0430ec8d5d2875008dd7487865d64/app/jobs/regular/emit_web_hook_event.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/jobs/regular/emit_web_hook_event.rb?ref=cf0c6d5761a0430ec8d5d2875008dd7487865d64",
      "patch": "@@ -93,6 +93,7 @@ def retry_web_hook\n         @retry_count += 1\n         return if @retry_count > MAX_RETRY_COUNT\n         delay = RETRY_BACKOFF**(@retry_count - 1)\n+        @arguments[:retry_count] = @retry_count\n         ::Jobs.enqueue_in(delay.minutes, :emit_web_hook_event, @arguments)\n       end\n     end"
    },
    {
      "sha": "e87d6b7c7c4419179d07c78a7cbfa653241f0614",
      "filename": "spec/jobs/emit_web_hook_event_spec.rb",
      "status": "modified",
      "additions": 13,
      "deletions": 0,
      "changes": 13,
      "blob_url": "https://github.com/discourse/discourse/blob/cf0c6d5761a0430ec8d5d2875008dd7487865d64/spec/jobs/emit_web_hook_event_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/cf0c6d5761a0430ec8d5d2875008dd7487865d64/spec/jobs/emit_web_hook_event_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/jobs/emit_web_hook_event_spec.rb?ref=cf0c6d5761a0430ec8d5d2875008dd7487865d64",
      "patch": "@@ -90,6 +90,19 @@\n         end.to change { Jobs::EmitWebHookEvent.jobs.size }.by(1)\n       end\n \n+      it 'retries at most 5 times' do\n+        Jobs.run_immediately!\n+\n+        expect(Jobs::EmitWebHookEvent::MAX_RETRY_COUNT + 1).to eq(5)\n+\n+        expect do\n+          subject.execute(\n+            web_hook_id: post_hook.id,\n+            event_type: described_class::PING_EVENT\n+          )\n+        end.to change { WebHookEvent.count }.by(Jobs::EmitWebHookEvent::MAX_RETRY_COUNT + 1)\n+      end\n+\n       it 'does not retry for more than maximum allowed times' do\n         expect do\n           subject.execute("
    }
  ]
}
