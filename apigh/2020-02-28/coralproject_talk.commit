{
  "sha": "2478e9a2502d43bb336634b5e8c09b94d9fc8fea",
  "node_id": "MDY6Q29tbWl0NzI0NTQyNDI6MjQ3OGU5YTI1MDJkNDNiYjMzNjYzNGI1ZThjMDliOTRkOWZjOGZlYQ==",
  "commit": {
    "author": {
      "name": "Tessa Thornton",
      "email": "tessathornton@gmail.com",
      "date": "2020-02-27T23:28:07Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2020-02-27T23:28:07Z"
    },
    "message": "[CORL-770] save comment sort order preference in local storage (#2854)\n\n* save comment sort order preference in local storage\r\n\r\n* await async localstorage operation\r\n\r\nCo-authored-by: Wyatt Johnson <accounts+github@wyattjoh.ca>",
    "tree": {
      "sha": "a2c3edc019028953d4091fdffa809295729cb4f9",
      "url": "https://api.github.com/repos/coralproject/talk/git/trees/a2c3edc019028953d4091fdffa809295729cb4f9"
    },
    "url": "https://api.github.com/repos/coralproject/talk/git/commits/2478e9a2502d43bb336634b5e8c09b94d9fc8fea",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeWFCHCRBK7hj4Ov3rIwAAdHIIAIB0tJjOjvY4WcNlBPCbA59N\nx6+16JMgn0GjbrwFv+FT27xDUXf4OgqWiQPCOIp3Dk50TxOGf6uvtKlJJvz69Wxg\nutf25NrTk2zS0EWUmQgFekTSoeQgTySwxGQ65UEHE4hJgJL6LcWM8Z5PzyQrOckv\nTM9WKwP8kRwFmH8tylUnrpKaTytFNNx6dUfbSsrmTnWwnFkUJK9JqgS6pQXCluyT\nh8WdzoNWSLa6bNwRfM9nMxY2ML9qFeIB64a4qnB0TNPrOhg0Yum/g0h6exEihgSj\n/U+csnK4B/uexh14DO3OQPLRAAHD5H/2EMT/nmq8Targetpj5tpUeuZ8NQPcHv4=\n=xT3p\n-----END PGP SIGNATURE-----\n",
      "payload": "tree a2c3edc019028953d4091fdffa809295729cb4f9\nparent fe8b6535a94cda65ed48146d07aac9f21fabae71\nauthor Tessa Thornton <tessathornton@gmail.com> 1582846087 -0500\ncommitter GitHub <noreply@github.com> 1582846087 +0000\n\n[CORL-770] save comment sort order preference in local storage (#2854)\n\n* save comment sort order preference in local storage\r\n\r\n* await async localstorage operation\r\n\r\nCo-authored-by: Wyatt Johnson <accounts+github@wyattjoh.ca>\r\n"
    }
  },
  "url": "https://api.github.com/repos/coralproject/talk/commits/2478e9a2502d43bb336634b5e8c09b94d9fc8fea",
  "html_url": "https://github.com/coralproject/talk/commit/2478e9a2502d43bb336634b5e8c09b94d9fc8fea",
  "comments_url": "https://api.github.com/repos/coralproject/talk/commits/2478e9a2502d43bb336634b5e8c09b94d9fc8fea/comments",
  "author": {
    "login": "tessalt",
    "id": 1789029,
    "node_id": "MDQ6VXNlcjE3ODkwMjk=",
    "avatar_url": "https://avatars3.githubusercontent.com/u/1789029?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tessalt",
    "html_url": "https://github.com/tessalt",
    "followers_url": "https://api.github.com/users/tessalt/followers",
    "following_url": "https://api.github.com/users/tessalt/following{/other_user}",
    "gists_url": "https://api.github.com/users/tessalt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tessalt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tessalt/subscriptions",
    "organizations_url": "https://api.github.com/users/tessalt/orgs",
    "repos_url": "https://api.github.com/users/tessalt/repos",
    "events_url": "https://api.github.com/users/tessalt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tessalt/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "fe8b6535a94cda65ed48146d07aac9f21fabae71",
      "url": "https://api.github.com/repos/coralproject/talk/commits/fe8b6535a94cda65ed48146d07aac9f21fabae71",
      "html_url": "https://github.com/coralproject/talk/commit/fe8b6535a94cda65ed48146d07aac9f21fabae71"
    }
  ],
  "stats": {
    "total": 17,
    "additions": 14,
    "deletions": 3
  },
  "files": [
    {
      "sha": "d02f367dab3b13f8bd5749b9218215a8a0318931",
      "filename": "src/core/client/stream/constants.ts",
      "status": "added",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/coralproject/talk/blob/2478e9a2502d43bb336634b5e8c09b94d9fc8fea/src/core/client/stream/constants.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/2478e9a2502d43bb336634b5e8c09b94d9fc8fea/src/core/client/stream/constants.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/stream/constants.ts?ref=2478e9a2502d43bb336634b5e8c09b94d9fc8fea",
      "patch": "@@ -0,0 +1 @@\n+export const COMMENTS_ORDER_BY = \"coral:localState:commentsOrderBy\";"
    },
    {
      "sha": "0490242aa673de5aa9b3262b087aea7ce51dead6",
      "filename": "src/core/client/stream/local/initLocalState.ts",
      "status": "modified",
      "additions": 6,
      "deletions": 1,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/2478e9a2502d43bb336634b5e8c09b94d9fc8fea/src/core/client/stream/local/initLocalState.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/2478e9a2502d43bb336634b5e8c09b94d9fc8fea/src/core/client/stream/local/initLocalState.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/stream/local/initLocalState.ts?ref=2478e9a2502d43bb336634b5e8c09b94d9fc8fea",
      "patch": "@@ -5,6 +5,7 @@ import { CoralContext } from \"coral-framework/lib/bootstrap\";\n import { getExternalConfig } from \"coral-framework/lib/externalConfig\";\n import { createAndRetain, initLocalBaseState } from \"coral-framework/lib/relay\";\n \n+import { COMMENTS_ORDER_BY } from \"../constants\";\n import { AUTH_POPUP_ID, AUTH_POPUP_TYPE } from \"./constants\";\n \n /**\n@@ -21,6 +22,10 @@ export default async function initLocalState(\n     config ? config.accessToken : undefined\n   );\n \n+  const commentsOrderBy =\n+    (await context.localStorage.getItem(COMMENTS_ORDER_BY)) ||\n+    \"CREATED_AT_DESC\";\n+\n   commitLocalUpdate(environment, s => {\n     const root = s.getRoot();\n     const localRecord = root.getLinkedRecord(\"local\")!;\n@@ -40,7 +45,7 @@ export default async function initLocalState(\n       localRecord.setValue(query.commentID, \"commentID\");\n     }\n     // Set sort\n-    localRecord.setValue(\"CREATED_AT_DESC\", \"commentsOrderBy\");\n+    localRecord.setValue(commentsOrderBy, \"commentsOrderBy\");\n \n     // Create authPopup Record\n     const authPopupRecord = createAndRetain("
    },
    {
      "sha": "ddbded6978980e3c8a8b2d926eb644ea1c5bd35c",
      "filename": "src/core/client/stream/mutations/SignOutMutation.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 1,
      "changes": 3,
      "blob_url": "https://github.com/coralproject/talk/blob/2478e9a2502d43bb336634b5e8c09b94d9fc8fea/src/core/client/stream/mutations/SignOutMutation.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/2478e9a2502d43bb336634b5e8c09b94d9fc8fea/src/core/client/stream/mutations/SignOutMutation.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/stream/mutations/SignOutMutation.ts?ref=2478e9a2502d43bb336634b5e8c09b94d9fc8fea",
      "patch": "@@ -2,15 +2,16 @@ import { Environment } from \"relay-runtime\";\n \n import { CoralContext } from \"coral-framework/lib/bootstrap\";\n import { createMutation } from \"coral-framework/lib/relay\";\n-\n import { commit as signOut } from \"coral-framework/mutations/SignOutMutation\";\n+import { COMMENTS_ORDER_BY } from \"coral-stream/constants\";\n import { SignOutEvent } from \"coral-stream/events\";\n \n const SignOutMutation = createMutation(\n   \"signOut\",\n   async (environment: Environment, input: undefined, ctx: CoralContext) => {\n     const signOutEvent = SignOutEvent.begin(ctx.eventEmitter);\n     try {\n+      await ctx.localStorage.removeItem(COMMENTS_ORDER_BY);\n       await signOut(environment, input, ctx);\n       signOutEvent.success();\n     } catch (error) {"
    },
    {
      "sha": "b358741e4767dabbf0b56e93015eb92aae9e3631",
      "filename": "src/core/client/stream/tabs/Comments/Stream/StreamContainer.tsx",
      "status": "modified",
      "additions": 5,
      "deletions": 1,
      "changes": 6,
      "blob_url": "https://github.com/coralproject/talk/blob/2478e9a2502d43bb336634b5e8c09b94d9fc8fea/src/core/client/stream/tabs/Comments/Stream/StreamContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/2478e9a2502d43bb336634b5e8c09b94d9fc8fea/src/core/client/stream/tabs/Comments/Stream/StreamContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/stream/tabs/Comments/Stream/StreamContainer.tsx?ref=2478e9a2502d43bb336634b5e8c09b94d9fc8fea",
      "patch": "@@ -3,12 +3,14 @@ import cn from \"classnames\";\n import React, { FunctionComponent, useCallback, useEffect } from \"react\";\n import { graphql } from \"react-relay\";\n \n+import { useCoralContext } from \"coral-framework/lib/bootstrap\";\n import { useViewerEvent } from \"coral-framework/lib/events\";\n import { useLocal, withFragmentContainer } from \"coral-framework/lib/relay\";\n import { GQLSTORY_MODE, GQLUSER_STATUS } from \"coral-framework/schema\";\n import CLASSES from \"coral-stream/classes\";\n import Counter from \"coral-stream/common/Counter\";\n import { UserBoxContainer } from \"coral-stream/common/UserBox\";\n+import { COMMENTS_ORDER_BY } from \"coral-stream/constants\";\n import {\n   SetCommentsOrderByEvent,\n   SetCommentsTabEvent,\n@@ -91,6 +93,7 @@ const TabWithFeaturedTooltip: FunctionComponent<TooltipTabProps> = ({\n export const StreamContainer: FunctionComponent<Props> = props => {\n   const emitSetCommentsTabEvent = useViewerEvent(SetCommentsTabEvent);\n   const emitSetCommentsOrderByEvent = useViewerEvent(SetCommentsOrderByEvent);\n+  const { localStorage } = useCoralContext();\n   const [local, setLocal] = useLocal<StreamContainerLocal>(\n     graphql`\n       fragment StreamContainerLocal on Local {\n@@ -101,12 +104,13 @@ export const StreamContainer: FunctionComponent<Props> = props => {\n     `\n   );\n   const onChangeOrder = useCallback(\n-    (order: React.ChangeEvent<HTMLSelectElement>) => {\n+    async (order: React.ChangeEvent<HTMLSelectElement>) => {\n       if (local.commentsOrderBy === order.target.value) {\n         return;\n       }\n       setLocal({ commentsOrderBy: order.target.value as any });\n       emitSetCommentsOrderByEvent({ orderBy: order.target.value });\n+      await localStorage.setItem(COMMENTS_ORDER_BY, order.target.value);\n     },\n     [setLocal, local.commentsOrderBy]\n   );"
    }
  ]
}
