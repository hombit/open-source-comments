{
  "sha": "27bc4f51c723ba4b55e22ac323e6675dd8f0e119",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODoyN2JjNGY1MWM3MjNiYTRiNTVlMjJhYzMyM2U2Njc1ZGQ4ZjBlMTE5",
  "commit": {
    "author": {
      "name": "Roman Rizzi",
      "email": "rizziromanalejandro@gmail.com",
      "date": "2020-03-14T11:47:53Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2020-03-14T11:47:53Z"
    },
    "message": "FIX: Ignore suspect users that were migrated or users who were created more than six months ago (#9205)",
    "tree": {
      "sha": "3d7a4060e39ec2e4fe3c6415d5873961f915ae41",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/3d7a4060e39ec2e4fe3c6415d5873961f915ae41"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/27bc4f51c723ba4b55e22ac323e6675dd8f0e119",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJebMRpCRBK7hj4Ov3rIwAAdHIIAEppevX0xcUTb+apMJ/JfVzi\nvzNzN46CkXNOeV+ObVwavj1ZnDuFbRWRgMcIEwGDojhKkcHYmiW2rUbBuQm/rxy4\niZJU0cMFxx6W2+aj+iOoVoNo+kyNWJmAD8Tkb24StU5GwIafKN3sD0cY5pqLN09k\n0j0n8ICFP8W2BSfzn5zNT4d4iTWiL6a90VjzBsyX7lQ/BEJb8l1LneyFT1gqzRT7\nUBlocbor1P+n26Dro9qne+HFW71TPxbSEw5XUtdOFX2qwAOdFSs7DezFgbvt0H01\nQwV1Dd7go/Ft8xUr1g1Eb/KifwP61xfxiccTicY74SmUAsXoCYKys7DtQawn+5M=\n=CRQ+\n-----END PGP SIGNATURE-----\n",
      "payload": "tree 3d7a4060e39ec2e4fe3c6415d5873961f915ae41\nparent e825f47daadc551c18e50077771673e2367214aa\nauthor Roman Rizzi <rizziromanalejandro@gmail.com> 1584186473 -0300\ncommitter GitHub <noreply@github.com> 1584186473 -0300\n\nFIX: Ignore suspect users that were migrated or users who were created more than six months ago (#9205)\n\n"
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/27bc4f51c723ba4b55e22ac323e6675dd8f0e119",
  "html_url": "https://github.com/discourse/discourse/commit/27bc4f51c723ba4b55e22ac323e6675dd8f0e119",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/27bc4f51c723ba4b55e22ac323e6675dd8f0e119/comments",
  "author": {
    "login": "romanrizzi",
    "id": 5025816,
    "node_id": "MDQ6VXNlcjUwMjU4MTY=",
    "avatar_url": "https://avatars1.githubusercontent.com/u/5025816?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/romanrizzi",
    "html_url": "https://github.com/romanrizzi",
    "followers_url": "https://api.github.com/users/romanrizzi/followers",
    "following_url": "https://api.github.com/users/romanrizzi/following{/other_user}",
    "gists_url": "https://api.github.com/users/romanrizzi/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/romanrizzi/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/romanrizzi/subscriptions",
    "organizations_url": "https://api.github.com/users/romanrizzi/orgs",
    "repos_url": "https://api.github.com/users/romanrizzi/repos",
    "events_url": "https://api.github.com/users/romanrizzi/events{/privacy}",
    "received_events_url": "https://api.github.com/users/romanrizzi/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "e825f47daadc551c18e50077771673e2367214aa",
      "url": "https://api.github.com/repos/discourse/discourse/commits/e825f47daadc551c18e50077771673e2367214aa",
      "html_url": "https://github.com/discourse/discourse/commit/e825f47daadc551c18e50077771673e2367214aa"
    }
  ],
  "stats": {
    "total": 30,
    "additions": 29,
    "deletions": 1
  },
  "files": [
    {
      "sha": "b88118a3a3131c32cfab0d331103ac70d99970df",
      "filename": "app/jobs/scheduled/enqueue_suspect_users.rb",
      "status": "modified",
      "additions": 5,
      "deletions": 1,
      "changes": 6,
      "blob_url": "https://github.com/discourse/discourse/blob/27bc4f51c723ba4b55e22ac323e6675dd8f0e119/app/jobs/scheduled/enqueue_suspect_users.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/27bc4f51c723ba4b55e22ac323e6675dd8f0e119/app/jobs/scheduled/enqueue_suspect_users.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/jobs/scheduled/enqueue_suspect_users.rb?ref=27bc4f51c723ba4b55e22ac323e6675dd8f0e119",
      "patch": "@@ -9,15 +9,19 @@ def execute(_args)\n       return if SiteSetting.must_approve_users\n \n       users = User\n+        .distinct\n         .activated\n         .human_users\n         .where(approved: false)\n         .joins(:user_profile, :user_stat)\n-        .where(\"users.created_at <= ?\", 1.day.ago)\n+        .where(\"users.created_at <= ? AND users.created_at >= ?\", 1.day.ago, 6.months.ago)\n         .where(\"LENGTH(COALESCE(user_profiles.bio_raw, user_profiles.website, '')) > 0\")\n         .where(\"user_stats.posts_read_count <= 1 AND user_stats.topics_entered <= 1\")\n         .joins(\"LEFT OUTER JOIN reviewables r ON r.target_id = users.id AND r.target_type = 'User'\")\n         .where('r.id IS NULL')\n+        .joins('LEFT OUTER JOIN user_custom_fields ucf ON users.id = ucf.user_id')\n+        .group('users.id, ucf.id')\n+        .having('ucf.id IS NULL OR NOT bool_or(ucf.name = ?)', 'import_id')\n         .limit(10)\n \n       users.each do |user|"
    },
    {
      "sha": "b1b30e779525c2b5c1c742c09301c86e923e3729",
      "filename": "spec/jobs/enqueue_suspect_users_spec.rb",
      "status": "modified",
      "additions": 24,
      "deletions": 0,
      "changes": 24,
      "blob_url": "https://github.com/discourse/discourse/blob/27bc4f51c723ba4b55e22ac323e6675dd8f0e119/spec/jobs/enqueue_suspect_users_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/27bc4f51c723ba4b55e22ac323e6675dd8f0e119/spec/jobs/enqueue_suspect_users_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/jobs/enqueue_suspect_users_spec.rb?ref=27bc4f51c723ba4b55e22ac323e6675dd8f0e119",
      "patch": "@@ -56,5 +56,29 @@\n \n       expect(ReviewableUser.where(target: suspect_user).exists?).to eq(false)\n     end\n+\n+    it 'ignores users created more than six months ago' do\n+      suspect_user.update!(created_at: 1.year.ago)\n+\n+      subject.execute({})\n+\n+      expect(ReviewableUser.where(target: suspect_user).exists?).to eq(false)\n+    end\n+\n+    it 'ignores users that were imported from another site' do\n+      suspect_user.upsert_custom_fields({ import_id: 'fake_id' })\n+\n+      subject.execute({})\n+\n+      expect(ReviewableUser.where(target: suspect_user).exists?).to eq(false)\n+    end\n+\n+    it 'enqueues a suspect users with custom fields' do\n+      suspect_user.upsert_custom_fields({ field_a: 'value', field_b: 'value' })\n+\n+      subject.execute({})\n+\n+      expect(ReviewableUser.where(target: suspect_user).exists?).to eq(true)\n+    end\n   end\n end"
    }
  ]
}
