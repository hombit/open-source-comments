{
  "sha": "919e405c4832c5901a616953e1df947717c37743",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODo5MTllNDA1YzQ4MzJjNTkwMWE2MTY5NTNlMWRmOTQ3NzE3YzM3NzQz",
  "commit": {
    "author": {
      "name": "Blake Erickson",
      "email": "o.blakeerickson@gmail.com",
      "date": "2020-03-17T16:39:24Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2020-03-17T16:39:24Z"
    },
    "message": "FIX: Don't display webhooks for inactive plugins (#9206)\n\n* FIX: Don't display webhooks for inactive plugins\r\n\r\nThis commit ensures that we don't show webhooks for plugins that are not\r\ninstalled or that are disabled.\r\n\r\nBug report:\r\n\r\nhttps://meta.discourse.org/t/webhookeventtype-and-the-solved-and-assign-plugins/144180\r\n\r\n* rename to just 'active', it's cleaner",
    "tree": {
      "sha": "d9add23c415449b99875ec0c2fd3f50d717bda6f",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/d9add23c415449b99875ec0c2fd3f50d717bda6f"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/919e405c4832c5901a616953e1df947717c37743",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJecP08CRBK7hj4Ov3rIwAAdHIIAHk2VyZfOg6vnWWmbz/zntNE\nGjHdcbIG6uveIUmbGZkYgNzsM+LnAojInClmAPNyKeBI1k4ydfnSGfhyyPseBLzd\nz6dfDYyGfdiy254cQ8n0emKC0vcnyFX5WGRayyze+qZcrpb8t3e8ZBVXUVZT6HXs\nVAk2imYUxdIJtim4ZxFhh1IfZctNG8M9U5c9qcNSb3FOkwhb3NmWGDuwq2/Al/le\nMGw/HHYhi2iiBog3ea4k6TtyRIkVGYcisAz5/mSg4IAAUrxERViEAZytihVqKjyL\nDPyNBV7RITHWMd4rrd8ZjBE9GbJNOyE7jkAWx+fpRZZbmXHlnSCJUDTGIK5GoXI=\n=QJKl\n-----END PGP SIGNATURE-----\n",
      "payload": "tree d9add23c415449b99875ec0c2fd3f50d717bda6f\nparent e950471c0f779ce86453b8a87d4925e0e8db996b\nauthor Blake Erickson <o.blakeerickson@gmail.com> 1584463164 -0600\ncommitter GitHub <noreply@github.com> 1584463164 -0600\n\nFIX: Don't display webhooks for inactive plugins (#9206)\n\n* FIX: Don't display webhooks for inactive plugins\r\n\r\nThis commit ensures that we don't show webhooks for plugins that are not\r\ninstalled or that are disabled.\r\n\r\nBug report:\r\n\r\nhttps://meta.discourse.org/t/webhookeventtype-and-the-solved-and-assign-plugins/144180\r\n\r\n* rename to just 'active', it's cleaner"
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/919e405c4832c5901a616953e1df947717c37743",
  "html_url": "https://github.com/discourse/discourse/commit/919e405c4832c5901a616953e1df947717c37743",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/919e405c4832c5901a616953e1df947717c37743/comments",
  "author": {
    "login": "oblakeerickson",
    "id": 1490496,
    "node_id": "MDQ6VXNlcjE0OTA0OTY=",
    "avatar_url": "https://avatars1.githubusercontent.com/u/1490496?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/oblakeerickson",
    "html_url": "https://github.com/oblakeerickson",
    "followers_url": "https://api.github.com/users/oblakeerickson/followers",
    "following_url": "https://api.github.com/users/oblakeerickson/following{/other_user}",
    "gists_url": "https://api.github.com/users/oblakeerickson/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/oblakeerickson/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/oblakeerickson/subscriptions",
    "organizations_url": "https://api.github.com/users/oblakeerickson/orgs",
    "repos_url": "https://api.github.com/users/oblakeerickson/repos",
    "events_url": "https://api.github.com/users/oblakeerickson/events{/privacy}",
    "received_events_url": "https://api.github.com/users/oblakeerickson/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "e950471c0f779ce86453b8a87d4925e0e8db996b",
      "url": "https://api.github.com/repos/discourse/discourse/commits/e950471c0f779ce86453b8a87d4925e0e8db996b",
      "html_url": "https://github.com/discourse/discourse/commit/e950471c0f779ce86453b8a87d4925e0e8db996b"
    }
  ],
  "stats": {
    "total": 27,
    "additions": 26,
    "deletions": 1
  },
  "files": [
    {
      "sha": "084af1d085d55a98765862c35ed372735736bbe6",
      "filename": "app/controllers/admin/web_hooks_controller.rb",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/discourse/discourse/blob/919e405c4832c5901a616953e1df947717c37743/app/controllers/admin/web_hooks_controller.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/919e405c4832c5901a616953e1df947717c37743/app/controllers/admin/web_hooks_controller.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/controllers/admin/web_hooks_controller.rb?ref=919e405c4832c5901a616953e1df947717c37743",
      "patch": "@@ -16,7 +16,7 @@ def index\n     json = {\n       web_hooks: serialize_data(web_hooks, AdminWebHookSerializer),\n       extras: {\n-        event_types: WebHookEventType.all,\n+        event_types: WebHookEventType.active,\n         default_event_types: WebHook.default_event_types,\n         content_types: WebHook.content_types.map { |name, id| { id: id, name: name } },\n         delivery_statuses: WebHook.last_delivery_statuses.map { |name, id| { id: id, name: name.to_s } },"
    },
    {
      "sha": "d3822d1ede41afe150ab3be3c0ef63103936d04f",
      "filename": "app/models/web_hook_event_type.rb",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/discourse/discourse/blob/919e405c4832c5901a616953e1df947717c37743/app/models/web_hook_event_type.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/919e405c4832c5901a616953e1df947717c37743/app/models/web_hook_event_type.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/models/web_hook_event_type.rb?ref=919e405c4832c5901a616953e1df947717c37743",
      "patch": "@@ -19,6 +19,15 @@ class WebHookEventType < ActiveRecord::Base\n   default_scope { order('id ASC') }\n \n   validates :name, presence: true, uniqueness: true\n+\n+  def self.active\n+    ids_to_exclude = []\n+    ids_to_exclude << SOLVED unless defined?(SiteSetting.solved_enabled) && SiteSetting.solved_enabled\n+    ids_to_exclude << ASSIGN unless defined?(SiteSetting.assign_enabled) && SiteSetting.assign_enabled\n+\n+    self.where.not(id: ids_to_exclude)\n+  end\n+\n end\n \n # == Schema Information"
    },
    {
      "sha": "47b4c20bb72e823dbd6ec3a9f72de1fb4c164a9a",
      "filename": "spec/models/web_hook_spec.rb",
      "status": "modified",
      "additions": 16,
      "deletions": 0,
      "changes": 16,
      "blob_url": "https://github.com/discourse/discourse/blob/919e405c4832c5901a616953e1df947717c37743/spec/models/web_hook_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/919e405c4832c5901a616953e1df947717c37743/spec/models/web_hook_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/models/web_hook_spec.rb?ref=919e405c4832c5901a616953e1df947717c37743",
      "patch": "@@ -44,6 +44,22 @@\n       expect(post_hook.payload_url).to eq(\"https://example.com\")\n     end\n \n+    it \"excludes disabled plugin web_hooks\" do\n+      web_hook_event_types = WebHookEventType.active.find_by(name: 'solved')\n+      expect(web_hook_event_types).to eq(nil)\n+    end\n+\n+    it \"includes non-plugin web_hooks\" do\n+      web_hook_event_types = WebHookEventType.active.where(name: 'topic')\n+      expect(web_hook_event_types.count).to eq(1)\n+    end\n+\n+    it \"includes enabled plugin web_hooks\" do\n+      SiteSetting.stubs(:solved_enabled).returns(true)\n+      web_hook_event_types = WebHookEventType.active.where(name: 'solved')\n+      expect(web_hook_event_types.count).to eq(1)\n+    end\n+\n     describe '#active_web_hooks' do\n       it \"returns unique hooks\" do\n         post_hook.web_hook_event_types << WebHookEventType.find_by(name: 'topic')"
    }
  ]
}
