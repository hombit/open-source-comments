{
  "sha": "8fd266deeb4c8ec0016bc05a80c567be4929d76f",
  "node_id": "MDY6Q29tbWl0NzI0NTQyNDI6OGZkMjY2ZGVlYjRjOGVjMDAxNmJjMDVhODBjNTY3YmU0OTI5ZDc2Zg==",
  "commit": {
    "author": {
      "name": "Wyatt Johnson",
      "email": "me@wyattjoh.ca",
      "date": "2020-03-23T18:20:18Z"
    },
    "committer": {
      "name": "Wyatt Johnson",
      "email": "me@wyattjoh.ca",
      "date": "2020-03-23T18:20:18Z"
    },
    "message": "Merge branch 'master' into release/6",
    "tree": {
      "sha": "15a528d3868df93a4f5fab72eeab7f2c42f07a7a",
      "url": "https://api.github.com/repos/coralproject/talk/git/trees/15a528d3868df93a4f5fab72eeab7f2c42f07a7a"
    },
    "url": "https://api.github.com/repos/coralproject/talk/git/commits/8fd266deeb4c8ec0016bc05a80c567be4929d76f",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/coralproject/talk/commits/8fd266deeb4c8ec0016bc05a80c567be4929d76f",
  "html_url": "https://github.com/coralproject/talk/commit/8fd266deeb4c8ec0016bc05a80c567be4929d76f",
  "comments_url": "https://api.github.com/repos/coralproject/talk/commits/8fd266deeb4c8ec0016bc05a80c567be4929d76f/comments",
  "author": {
    "login": "wyattjoh",
    "id": 633002,
    "node_id": "MDQ6VXNlcjYzMzAwMg==",
    "avatar_url": "https://avatars2.githubusercontent.com/u/633002?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wyattjoh",
    "html_url": "https://github.com/wyattjoh",
    "followers_url": "https://api.github.com/users/wyattjoh/followers",
    "following_url": "https://api.github.com/users/wyattjoh/following{/other_user}",
    "gists_url": "https://api.github.com/users/wyattjoh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wyattjoh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wyattjoh/subscriptions",
    "organizations_url": "https://api.github.com/users/wyattjoh/orgs",
    "repos_url": "https://api.github.com/users/wyattjoh/repos",
    "events_url": "https://api.github.com/users/wyattjoh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wyattjoh/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "wyattjoh",
    "id": 633002,
    "node_id": "MDQ6VXNlcjYzMzAwMg==",
    "avatar_url": "https://avatars2.githubusercontent.com/u/633002?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wyattjoh",
    "html_url": "https://github.com/wyattjoh",
    "followers_url": "https://api.github.com/users/wyattjoh/followers",
    "following_url": "https://api.github.com/users/wyattjoh/following{/other_user}",
    "gists_url": "https://api.github.com/users/wyattjoh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wyattjoh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wyattjoh/subscriptions",
    "organizations_url": "https://api.github.com/users/wyattjoh/orgs",
    "repos_url": "https://api.github.com/users/wyattjoh/repos",
    "events_url": "https://api.github.com/users/wyattjoh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wyattjoh/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "1b73a5fcd7d3849ba506c11e84d869fd9b53e479",
      "url": "https://api.github.com/repos/coralproject/talk/commits/1b73a5fcd7d3849ba506c11e84d869fd9b53e479",
      "html_url": "https://github.com/coralproject/talk/commit/1b73a5fcd7d3849ba506c11e84d869fd9b53e479"
    },
    {
      "sha": "9a58673545e0d720b1719c273746f2a65b38e45c",
      "url": "https://api.github.com/repos/coralproject/talk/commits/9a58673545e0d720b1719c273746f2a65b38e45c",
      "html_url": "https://github.com/coralproject/talk/commit/9a58673545e0d720b1719c273746f2a65b38e45c"
    }
  ],
  "stats": {
    "total": 3277,
    "additions": 2361,
    "deletions": 916
  },
  "files": [
    {
      "sha": "5802278e16942b4ef448dddbf2fe1f1a7c264a82",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOConfig.tsx",
      "status": "modified",
      "additions": 21,
      "deletions": 5,
      "changes": 26,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOConfig.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOConfig.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOConfig.tsx?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -2,12 +2,13 @@ import { Localized } from \"@fluent/react/compat\";\n import React, { FunctionComponent } from \"react\";\n import { graphql } from \"react-relay\";\n \n-import { PropTypesOf } from \"coral-framework/types\";\n+import { ExternalLink } from \"coral-framework/lib/i18n/components\";\n+import { FormFieldDescription } from \"coral-ui/components/v2\";\n \n import Header from \"../../Header\";\n import ConfigBoxWithToggleField from \"./ConfigBoxWithToggleField\";\n import RegistrationField from \"./RegistrationField\";\n-import SSOKeyFieldContainer from \"./SSOKeyFieldContainer\";\n+import SSOKeyRotationQuery from \"./SSOKeyRotation/SSOKeyRotationQuery\";\n import TargetFilterField from \"./TargetFilterField\";\n \n // eslint-disable-next-line no-unused-expressions\n@@ -28,10 +29,9 @@ graphql`\n \n interface Props {\n   disabled?: boolean;\n-  sso: PropTypesOf<typeof SSOKeyFieldContainer>[\"sso\"];\n }\n \n-const SSOConfig: FunctionComponent<Props> = ({ disabled, sso }) => (\n+const SSOConfig: FunctionComponent<Props> = ({ disabled }) => (\n   <ConfigBoxWithToggleField\n     title={\n       <Localized id=\"configure-auth-sso-loginWith\">\n@@ -44,7 +44,23 @@ const SSOConfig: FunctionComponent<Props> = ({ disabled, sso }) => (\n   >\n     {disabledInside => (\n       <>\n-        <SSOKeyFieldContainer sso={sso} disabled={disabledInside} />\n+        <Localized\n+          id=\"configure-auth-sso-description\"\n+          IntroLink={\n+            <ExternalLink href=\"https://jwt.io/introduction/\"></ExternalLink>\n+          }\n+          DocLink={\n+            <ExternalLink href=\"https://docs.coralproject.net/coral/v5/integrating/sso/\"></ExternalLink>\n+          }\n+        >\n+          <FormFieldDescription>\n+            To enable integration with your existing authentication system, you\n+            will need to create a JWT Token to connect. You can learn more about\n+            creating a JWT Token with this introduction. See our documentation\n+            for additional information on single sign on.\n+          </FormFieldDescription>\n+        </Localized>\n+        <SSOKeyRotationQuery disabled={disabledInside}></SSOKeyRotationQuery>\n         <TargetFilterField\n           label={\n             <Localized id=\"configure-auth-sso-useLoginOn\">"
    },
    {
      "sha": "775eb044136428af59eda88c2fcf28545e8498fc",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOConfigContainer.tsx",
      "status": "modified",
      "additions": 2,
      "deletions": 6,
      "changes": 8,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOConfigContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOConfigContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOConfigContainer.tsx?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -16,17 +16,13 @@ const SSOConfigContainer: React.FunctionComponent<Props> = ({\n   disabled,\n   auth,\n }) => {\n-  return <SSOConfig disabled={disabled} sso={auth.integrations.sso} />;\n+  return <SSOConfig disabled={disabled} />;\n };\n \n const enhanced = withFragmentContainer<Props>({\n   auth: graphql`\n     fragment SSOConfigContainer_auth on Auth {\n-      integrations {\n-        sso {\n-          ...SSOKeyFieldContainer_sso\n-        }\n-      }\n+      ...SSOConfig_formValues\n     }\n   `,\n })(SSOConfigContainer);"
    },
    {
      "sha": "1b2f8e3c559ccb127912f068bf2ace408d2f81eb",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOKeyField.css",
      "status": "removed",
      "additions": 0,
      "deletions": 29,
      "changes": 29,
      "blob_url": "https://github.com/coralproject/talk/blob/1b73a5fcd7d3849ba506c11e84d869fd9b53e479/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyField.css",
      "raw_url": "https://github.com/coralproject/talk/raw/1b73a5fcd7d3849ba506c11e84d869fd9b53e479/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyField.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyField.css?ref=1b73a5fcd7d3849ba506c11e84d869fd9b53e479",
      "patch": "@@ -1,29 +0,0 @@\n-.root {\n-  padding-bottom: var(--spacing-4);\n-}\n-\n-.keyGenerated {\n-  composes: button from \"coral-ui/shared/typography.css\";\n-  color: var(--palette-text-secondary);\n-  flex-shrink: 0;\n-}\n-\n-.warnIcon {\n-  color: var(--palette-text-secondary);\n-  flex-shrink: 0;\n-  padding-top: 3px;\n-  padding-right: var(--spacing-1);\n-}\n-\n-.warn {\n-  color: var(--palette-text-secondary);\n-}\n-\n-.warningSection {\n-  padding-top: var(--spacing-1);\n-  padding-bottom: var(--spacing-1);\n-}\n-\n-.regenerateButton {\n-  float: right;\n-}"
    },
    {
      "sha": "83d47b43cfad925c148a8295fde39500eb640dd0",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOKeyField.tsx",
      "status": "removed",
      "additions": 0,
      "deletions": 79,
      "changes": 79,
      "blob_url": "https://github.com/coralproject/talk/blob/1b73a5fcd7d3849ba506c11e84d869fd9b53e479/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyField.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/1b73a5fcd7d3849ba506c11e84d869fd9b53e479/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyField.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyField.tsx?ref=1b73a5fcd7d3849ba506c11e84d869fd9b53e479",
      "patch": "@@ -1,79 +0,0 @@\n-import { Localized } from \"@fluent/react/compat\";\n-import React, { FunctionComponent } from \"react\";\n-\n-import {\n-  Button,\n-  Flex,\n-  FormField,\n-  Icon,\n-  Label,\n-  PasswordField,\n-} from \"coral-ui/components/v2\";\n-\n-import HelperText from \"../../HelperText\";\n-\n-import styles from \"./SSOKeyField.css\";\n-\n-interface Props {\n-  disabled?: boolean;\n-  generatedKey?: string;\n-  keyGeneratedAt?: any;\n-  onRegenerate?: () => void;\n-}\n-\n-const SSOKeyField: FunctionComponent<Props> = ({\n-  generatedKey,\n-  keyGeneratedAt,\n-  disabled,\n-  onRegenerate,\n-}) => (\n-  <FormField className={styles.root}>\n-    <Localized id=\"configure-auth-sso-key\">\n-      <Label htmlFor=\"configure-auth-sso-key\">Key</Label>\n-    </Localized>\n-    <PasswordField\n-      id=\"configure-auth-sso-key\"\n-      name=\"key\"\n-      value={generatedKey}\n-      readOnly\n-      // TODO: (wyattjoh) figure out how to add translations to these props\n-      hidePasswordTitle=\"Show SSO Key\"\n-      showPasswordTitle=\"Hide SSO Key\"\n-      fullWidth\n-    />\n-    {keyGeneratedAt && (\n-      <Localized\n-        id=\"configure-auth-sso-regenerateAt\"\n-        $date={new Date(keyGeneratedAt)}\n-      >\n-        <HelperText className={styles.keyGenerated}>\n-          KEY GENERATED AT: {keyGeneratedAt}\n-        </HelperText>\n-      </Localized>\n-    )}\n-    <div className={styles.warningSection}>\n-      <Flex direction=\"row\" itemGutter=\"half\">\n-        <Icon className={styles.warnIcon}>warning</Icon>\n-        <Localized id=\"configure-auth-sso-regenerateHonoredWarning\">\n-          <HelperText>\n-            When regenerating a key, tokens signed with the previous key will be\n-            honored for 30 days.\n-          </HelperText>\n-        </Localized>\n-      </Flex>\n-    </div>\n-\n-    <Localized id=\"configure-auth-sso-regenerate\">\n-      <Button\n-        id=\"configure-auth-sso-regenerate\"\n-        disabled={disabled}\n-        onClick={onRegenerate}\n-        className={styles.regenerateButton}\n-      >\n-        Regenerate\n-      </Button>\n-    </Localized>\n-  </FormField>\n-);\n-\n-export default SSOKeyField;"
    },
    {
      "sha": "4c1fa0eff11e2968c99c81c3a57e9bc5621e87bf",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOKeyFieldContainer.tsx",
      "status": "removed",
      "additions": 0,
      "deletions": 60,
      "changes": 60,
      "blob_url": "https://github.com/coralproject/talk/blob/1b73a5fcd7d3849ba506c11e84d869fd9b53e479/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyFieldContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/1b73a5fcd7d3849ba506c11e84d869fd9b53e479/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyFieldContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyFieldContainer.tsx?ref=1b73a5fcd7d3849ba506c11e84d869fd9b53e479",
      "patch": "@@ -1,60 +0,0 @@\n-import React from \"react\";\n-import { graphql } from \"react-relay\";\n-\n-import {\n-  MutationProp,\n-  withFragmentContainer,\n-  withMutation,\n-} from \"coral-framework/lib/relay\";\n-\n-import { SSOKeyFieldContainer_sso as SSOData } from \"coral-admin/__generated__/SSOKeyFieldContainer_sso.graphql\";\n-\n-import RegenerateSSOKeyMutation from \"./RegenerateSSOKeyMutation\";\n-import SSOKeyField from \"./SSOKeyField\";\n-\n-interface Props {\n-  sso: SSOData;\n-  disabled?: boolean;\n-  regenerateSSOKey: MutationProp<typeof RegenerateSSOKeyMutation>;\n-}\n-\n-interface State {\n-  awaitingResponse: boolean;\n-}\n-\n-class SSOKeyFieldContainer extends React.Component<Props, State> {\n-  public state = {\n-    awaitingResponse: false,\n-  };\n-\n-  private handleRegenerate = async () => {\n-    this.setState({ awaitingResponse: true });\n-    await this.props.regenerateSSOKey();\n-    this.setState({ awaitingResponse: false });\n-  };\n-\n-  public render() {\n-    const { disabled } = this.props;\n-    return (\n-      <SSOKeyField\n-        disabled={disabled || this.state.awaitingResponse}\n-        generatedKey={this.props.sso.key || undefined}\n-        keyGeneratedAt={this.props.sso.keyGeneratedAt || undefined}\n-        onRegenerate={this.handleRegenerate}\n-      />\n-    );\n-  }\n-}\n-\n-const enhanced = withMutation(RegenerateSSOKeyMutation)(\n-  withFragmentContainer<Props>({\n-    sso: graphql`\n-      fragment SSOKeyFieldContainer_sso on SSOAuthIntegration {\n-        key\n-        keyGeneratedAt\n-      }\n-    `,\n-  })(SSOKeyFieldContainer)\n-);\n-\n-export default enhanced;"
    },
    {
      "sha": "dee544d71c37e9ccb781dc285c79f787da2aff71",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/DateField.css",
      "status": "added",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/DateField.css",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/DateField.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/DateField.css?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -0,0 +1,10 @@\n+.label {\n+  padding-bottom: var(--v2-spacing-2);\n+}\n+\n+.date {\n+  font-family: var(--v2-font-family-primary);\n+  font-weight: var(--v2-font-weight-primary-regular);\n+  font-size: var(--v2-font-size-2);\n+  line-height: var(--v2-line-height-reset);\n+}"
    },
    {
      "sha": "5288759808a13dbb2dbcb97e34eaa459b5ce9367",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/DateField.tsx",
      "status": "added",
      "additions": 97,
      "deletions": 0,
      "changes": 97,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/DateField.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/DateField.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/DateField.tsx?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -0,0 +1,97 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import React, { FunctionComponent } from \"react\";\n+\n+import { Flex, Label } from \"coral-ui/components/v2\";\n+\n+import { SSOKeyStatus } from \"./StatusField\";\n+\n+import styles from \"./DateField.css\";\n+\n+export interface SSOKeyDates {\n+  readonly createdAt: string;\n+  readonly lastUsedAt: string | null;\n+  readonly rotatedAt: string | null;\n+  readonly inactiveAt: string | null;\n+}\n+\n+interface Props {\n+  status: SSOKeyStatus;\n+  dates: SSOKeyDates;\n+}\n+\n+const DateField: FunctionComponent<Props> = ({ status, dates }) => {\n+  switch (status) {\n+    case SSOKeyStatus.ACTIVE:\n+      return (\n+        <>\n+          <div className={styles.label}>\n+            <Localized id=\"configure-auth-sso-rotate-activeSince\">\n+              <Label>Active Since</Label>\n+            </Localized>\n+          </div>\n+          <Localized\n+            id=\"configure-auth-sso-rotate-date\"\n+            $date={new Date(dates.createdAt)}\n+          >\n+            <span className={styles.date}>{dates.createdAt}</span>\n+          </Localized>\n+        </>\n+      );\n+    case SSOKeyStatus.EXPIRING:\n+      return (\n+        <>\n+          <div className={styles.label}>\n+            <Localized id=\"configure-auth-sso-rotate-inactiveAt\">\n+              <Label>Inactive At</Label>\n+            </Localized>\n+          </div>\n+          <Flex\n+            alignItems=\"center\"\n+            justifyContent=\"center\"\n+            className={styles.date}\n+          >\n+            <Localized\n+              id=\"configure-auth-sso-rotate-date\"\n+              $date={\n+                dates.inactiveAt\n+                  ? new Date(dates.inactiveAt)\n+                  : new Date(dates.createdAt)\n+              }\n+            >\n+              {dates.inactiveAt}\n+            </Localized>\n+          </Flex>\n+        </>\n+      );\n+    case SSOKeyStatus.EXPIRED:\n+      return (\n+        <>\n+          <div className={styles.label}>\n+            <Localized id=\"configure-auth-sso-rotate-inactiveSince\">\n+              <Label>Inactive Since</Label>\n+            </Localized>\n+          </div>\n+          <Flex\n+            alignItems=\"center\"\n+            justifyContent=\"center\"\n+            className={styles.date}\n+          >\n+            <Localized\n+              id=\"configure-auth-sso-rotate-date\"\n+              $date={\n+                dates.inactiveAt\n+                  ? new Date(dates.inactiveAt)\n+                  : new Date(dates.createdAt)\n+              }\n+            >\n+              {dates.inactiveAt}\n+            </Localized>\n+          </Flex>\n+        </>\n+      );\n+    default:\n+      return null;\n+  }\n+};\n+\n+export default DateField;"
    },
    {
      "sha": "16bab846dcec348c806c80017b6a975487555b5d",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/DeactivateSSOKeyMutation.ts",
      "status": "added",
      "additions": 52,
      "deletions": 0,
      "changes": 52,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/DeactivateSSOKeyMutation.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/DeactivateSSOKeyMutation.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/DeactivateSSOKeyMutation.ts?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -0,0 +1,52 @@\n+import { graphql } from \"react-relay\";\n+import { Environment } from \"relay-runtime\";\n+\n+import {\n+  commitMutationPromiseNormalized,\n+  createMutation,\n+  MutationInput,\n+} from \"coral-framework/lib/relay\";\n+\n+import { DeactivateSSOKeyMutation as MutationTypes } from \"coral-admin/__generated__/DeactivateSSOKeyMutation.graphql\";\n+\n+const clientMutationId = 0;\n+\n+const DeactivateSSOKeyMutation = createMutation(\n+  \"deactivateSSOKey\",\n+  (environment: Environment, input: MutationInput<MutationTypes>) => {\n+    return commitMutationPromiseNormalized<MutationTypes>(environment, {\n+      mutation: graphql`\n+        mutation DeactivateSSOKeyMutation($input: DeactivateSSOKeyInput!) {\n+          deactivateSSOKey(input: $input) {\n+            settings {\n+              auth {\n+                integrations {\n+                  sso {\n+                    enabled\n+                    keys {\n+                      kid\n+                      secret\n+                      createdAt\n+                      lastUsedAt\n+                      rotatedAt\n+                      inactiveAt\n+                    }\n+                  }\n+                }\n+              }\n+            }\n+            clientMutationId\n+          }\n+        }\n+      `,\n+      variables: {\n+        input: {\n+          ...input,\n+          clientMutationId: clientMutationId.toString(),\n+        },\n+      },\n+    });\n+  }\n+);\n+\n+export default DeactivateSSOKeyMutation;"
    },
    {
      "sha": "b459854c1457c9780321a1ffe4eb8af4ad80fd34",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/DeleteSSOKeyMutation.ts",
      "status": "added",
      "additions": 52,
      "deletions": 0,
      "changes": 52,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/DeleteSSOKeyMutation.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/DeleteSSOKeyMutation.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/DeleteSSOKeyMutation.ts?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -0,0 +1,52 @@\n+import { graphql } from \"react-relay\";\n+import { Environment } from \"relay-runtime\";\n+\n+import {\n+  commitMutationPromiseNormalized,\n+  createMutation,\n+  MutationInput,\n+} from \"coral-framework/lib/relay\";\n+\n+import { DeleteSSOKeyMutation as MutationTypes } from \"coral-admin/__generated__/DeleteSSOKeyMutation.graphql\";\n+\n+const clientMutationId = 0;\n+\n+const DeleteSSOKeyMutation = createMutation(\n+  \"deleteSSOKey\",\n+  (environment: Environment, input: MutationInput<MutationTypes>) => {\n+    return commitMutationPromiseNormalized<MutationTypes>(environment, {\n+      mutation: graphql`\n+        mutation DeleteSSOKeyMutation($input: DeleteSSOKeyInput!) {\n+          deleteSSOKey(input: $input) {\n+            settings {\n+              auth {\n+                integrations {\n+                  sso {\n+                    enabled\n+                    keys {\n+                      kid\n+                      secret\n+                      createdAt\n+                      lastUsedAt\n+                      rotatedAt\n+                      inactiveAt\n+                    }\n+                  }\n+                }\n+              }\n+            }\n+            clientMutationId\n+          }\n+        }\n+      `,\n+      variables: {\n+        input: {\n+          ...input,\n+          clientMutationId: clientMutationId.toString(),\n+        },\n+      },\n+    });\n+  }\n+);\n+\n+export default DeleteSSOKeyMutation;"
    },
    {
      "sha": "8010a0aa8811c275aee626220283c3af3b8ec1c8",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/RotateSSOKeyMutation.ts",
      "status": "added",
      "additions": 52,
      "deletions": 0,
      "changes": 52,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/RotateSSOKeyMutation.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/RotateSSOKeyMutation.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/RotateSSOKeyMutation.ts?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -0,0 +1,52 @@\n+import { graphql } from \"react-relay\";\n+import { Environment } from \"relay-runtime\";\n+\n+import {\n+  commitMutationPromiseNormalized,\n+  createMutation,\n+  MutationInput,\n+} from \"coral-framework/lib/relay\";\n+\n+import { RotateSSOKeyMutation as MutationTypes } from \"coral-admin/__generated__/RotateSSOKeyMutation.graphql\";\n+\n+const clientMutationId = 0;\n+\n+const RotateSSOKeyMutation = createMutation(\n+  \"rotateSSOKey\",\n+  (environment: Environment, input: MutationInput<MutationTypes>) => {\n+    return commitMutationPromiseNormalized<MutationTypes>(environment, {\n+      mutation: graphql`\n+        mutation RotateSSOKeyMutation($input: RotateSSOKeyInput!) {\n+          rotateSSOKey(input: $input) {\n+            settings {\n+              auth {\n+                integrations {\n+                  sso {\n+                    enabled\n+                    keys {\n+                      kid\n+                      secret\n+                      createdAt\n+                      lastUsedAt\n+                      rotatedAt\n+                      inactiveAt\n+                    }\n+                  }\n+                }\n+              }\n+            }\n+            clientMutationId\n+          }\n+        }\n+      `,\n+      variables: {\n+        input: {\n+          ...input,\n+          clientMutationId: clientMutationId.toString(),\n+        },\n+      },\n+    });\n+  }\n+);\n+\n+export default RotateSSOKeyMutation;"
    },
    {
      "sha": "5f3824668ee6b594684ac7c003b6c880c0664db1",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/RotationDropdown.css",
      "status": "added",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/RotationDropdown.css",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/RotationDropdown.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/RotationDropdown.css?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -0,0 +1,3 @@\n+.rotate {\n+  margin-right: var(--v2-spacing-1)\n+}"
    },
    {
      "sha": "f3eea1458d06f4e360cd9bae460b921d2e587217",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/RotationDropdown.tsx",
      "status": "added",
      "additions": 72,
      "deletions": 0,
      "changes": 72,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/RotationDropdown.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/RotationDropdown.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/RotationDropdown.tsx?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -0,0 +1,72 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import React, { FunctionComponent } from \"react\";\n+\n+import {\n+  Button,\n+  ClickOutside,\n+  Dropdown,\n+  DropdownButton,\n+  Icon,\n+  Popover,\n+} from \"coral-ui/components/v2\";\n+\n+import RotateOption, { RotateOptions } from \"./RotationOption\";\n+\n+import styles from \"./RotationDropdown.css\";\n+\n+interface Props {\n+  onRotateKey: (rotation: string) => void;\n+  disabled?: boolean;\n+}\n+\n+const RotationDropDown: FunctionComponent<Props> = ({\n+  onRotateKey,\n+  disabled,\n+}) => {\n+  return (\n+    <Localized\n+      id=\"configure-auth-sso-rotate-dropdown-description\"\n+      attrs={{ description: true }}\n+    >\n+      <Popover\n+        id=\"sso-key-rotate\"\n+        placement=\"bottom-start\"\n+        description=\"A dropdown to rotate the SSO key\"\n+        body={({ toggleVisibility }) => (\n+          <ClickOutside onClickOutside={toggleVisibility}>\n+            <Dropdown>\n+              {Object.keys(RotateOptions).map((opt: string) => (\n+                <DropdownButton\n+                  key={opt}\n+                  onClick={() => {\n+                    onRotateKey(opt);\n+                    toggleVisibility();\n+                  }}\n+                  disabled={disabled}\n+                >\n+                  <RotateOption value={opt}></RotateOption>\n+                </DropdownButton>\n+              ))}\n+            </Dropdown>\n+          </ClickOutside>\n+        )}\n+      >\n+        {({ toggleVisibility, ref, visible }) => (\n+          <Button\n+            onClick={toggleVisibility}\n+            ref={ref}\n+            color=\"regular\"\n+            disabled={disabled}\n+          >\n+            <Localized id=\"configure-auth-sso-rotate-rotate\">\n+              <span className={styles.rotate}>Rotate</span>\n+            </Localized>\n+            <Icon>arrow_drop_down</Icon>\n+          </Button>\n+        )}\n+      </Popover>\n+    </Localized>\n+  );\n+};\n+\n+export default RotationDropDown;"
    },
    {
      "sha": "e0a02cbb59471fbf4069fd37c92a628f441b8120",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/RotationOption.tsx",
      "status": "added",
      "additions": 46,
      "deletions": 0,
      "changes": 46,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/RotationOption.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/RotationOption.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/RotationOption.tsx?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -0,0 +1,46 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import React, { FunctionComponent } from \"react\";\n+\n+export enum RotateOptions {\n+  NOW = \"NOW\",\n+  IN1DAY = \"IN1DAY\",\n+  IN1WEEK = \"IN1WEEK\",\n+  IN30DAYS = \"IN30DAYS\",\n+}\n+\n+interface Props {\n+  value: string;\n+}\n+\n+const RotationOption: FunctionComponent<Props> = ({ value }) => {\n+  switch (value) {\n+    case RotateOptions.NOW: {\n+      return <Localized id=\"configure-auth-sso-rotate-now\">Now</Localized>;\n+    }\n+    case RotateOptions.IN1DAY: {\n+      return (\n+        <Localized id=\"configure-auth-sso-rotate-1day\">\n+          1 day from now\n+        </Localized>\n+      );\n+    }\n+    case RotateOptions.IN1WEEK: {\n+      return (\n+        <Localized id=\"configure-auth-sso-rotate-1week\">\n+          1 week from now\n+        </Localized>\n+      );\n+    }\n+    case RotateOptions.IN30DAYS: {\n+      return (\n+        <Localized id=\"configure-auth-sso-rotate-30days\">\n+          30 days from now\n+        </Localized>\n+      );\n+    }\n+    default:\n+      return <Localized id=\"configure-auth-sso-rotate-now\">Now</Localized>;\n+  }\n+};\n+\n+export default RotationOption;"
    },
    {
      "sha": "2b4e295fe0276ecae3e2bb11c675193fa5216745",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/SSOKeyCard.css",
      "status": "added",
      "additions": 23,
      "deletions": 0,
      "changes": 23,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/SSOKeyCard.css",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/SSOKeyCard.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/SSOKeyCard.css?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -0,0 +1,23 @@\n+.label {\n+  padding-bottom: var(--v2-spacing-2);\n+}\n+\n+.keySection {\n+  flex-grow: 1;\n+  min-width: 50px;\n+\n+  padding-right: var(--v2-spacing-3);\n+}\n+\n+.statusSection {\n+  margin-right: var(--v2-spacing-3);\n+}\n+\n+.secretSection {\n+  flex-grow: 1;\n+  min-width: 50px;\n+}\n+\n+.action {\n+  margin-right: var(--v2-spacing-1)\n+}"
    },
    {
      "sha": "39df183405090e8d14515169bf1f8601e980bd35",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/SSOKeyCard.tsx",
      "status": "added",
      "additions": 187,
      "deletions": 0,
      "changes": 187,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/SSOKeyCard.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/SSOKeyCard.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/SSOKeyCard.tsx?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -0,0 +1,187 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import React, { FunctionComponent, useCallback } from \"react\";\n+import CopyToClipboard from \"react-copy-to-clipboard\";\n+\n+import { useMutation } from \"coral-framework/lib/relay\";\n+import {\n+  Button,\n+  Card,\n+  Flex,\n+  HorizontalGutter,\n+  Icon,\n+  Label,\n+  PasswordField,\n+  TextField,\n+} from \"coral-ui/components/v2\";\n+\n+import DateField from \"./DateField\";\n+import DeactivateSSOKeyMutation from \"./DeactivateSSOKeyMutation\";\n+import DeleteSSOKeyMutation from \"./DeleteSSOKeyMutation\";\n+import RotateSSOKeyMutation from \"./RotateSSOKeyMutation\";\n+import RotationDropDown from \"./RotationDropdown\";\n+import { RotateOptions } from \"./RotationOption\";\n+import StatusField, { SSOKeyStatus } from \"./StatusField\";\n+\n+import styles from \"./SSOKeyCard.css\";\n+\n+export interface SSOKeyDates {\n+  readonly createdAt: string;\n+  readonly lastUsedAt: string | null;\n+  readonly rotatedAt: string | null;\n+  readonly inactiveAt: string | null;\n+}\n+\n+interface Props {\n+  id: string;\n+  secret: string;\n+  status: SSOKeyStatus;\n+  dates: SSOKeyDates;\n+  disabled?: boolean;\n+}\n+\n+function createActionButton(\n+  status: SSOKeyStatus,\n+  onRotateKey: (rotation: string) => void,\n+  onDeactivateKey: () => void,\n+  onDelete: () => void,\n+  disabled?: boolean\n+) {\n+  switch (status) {\n+    case SSOKeyStatus.ACTIVE:\n+      return <RotationDropDown onRotateKey={onRotateKey} disabled={disabled} />;\n+    case SSOKeyStatus.EXPIRING:\n+      return (\n+        <Localized id=\"configure-auth-sso-rotate-deactivateNow\">\n+          <Button color=\"alert\" onClick={onDeactivateKey} disabled={disabled}>\n+            Deactivate Now\n+          </Button>\n+        </Localized>\n+      );\n+    case SSOKeyStatus.EXPIRED:\n+      return (\n+        <Localized id=\"configure-auth-sso-rotate-delete\">\n+          <Button color=\"alert\" onClick={onDelete} disabled={disabled}>\n+            Delete\n+          </Button>\n+        </Localized>\n+      );\n+    default:\n+      return null;\n+  }\n+}\n+\n+const SSOKeyCard: FunctionComponent<Props> = ({\n+  id,\n+  secret,\n+  status,\n+  dates,\n+  disabled,\n+}) => {\n+  const rotateSSOKey = useMutation(RotateSSOKeyMutation);\n+  const deactivateSSOKey = useMutation(DeactivateSSOKeyMutation);\n+  const deleteSSOKey = useMutation(DeleteSSOKeyMutation);\n+\n+  const onRotate = useCallback(\n+    (rotation: string) => {\n+      switch (rotation) {\n+        case RotateOptions.NOW:\n+          rotateSSOKey({ inactiveIn: 0 });\n+          break;\n+        case RotateOptions.IN1DAY:\n+          rotateSSOKey({ inactiveIn: 24 * 60 * 60 });\n+          break;\n+        case RotateOptions.IN1WEEK:\n+          rotateSSOKey({ inactiveIn: 7 * 24 * 60 * 60 });\n+          break;\n+        case RotateOptions.IN30DAYS:\n+          rotateSSOKey({ inactiveIn: 30 * 24 * 60 * 60 });\n+          break;\n+        default:\n+          rotateSSOKey({ inactiveIn: 0 });\n+      }\n+    },\n+    [rotateSSOKey]\n+  );\n+  const onDeactivate = useCallback(() => {\n+    deactivateSSOKey({\n+      kid: id,\n+    });\n+  }, [deactivateSSOKey, id]);\n+  const onDelete = useCallback(() => {\n+    deleteSSOKey({\n+      kid: id,\n+    });\n+  }, [deleteSSOKey, id]);\n+\n+  return (\n+    <Card>\n+      <HorizontalGutter>\n+        <Flex alignItems=\"center\" justifyContent=\"space-between\">\n+          <div className={styles.keySection}>\n+            <div className={styles.label}>\n+              <Localized id=\"configure-auth-sso-rotate-keyID\">\n+                <Label>Key ID</Label>\n+              </Localized>\n+            </div>\n+            <TextField value={id} readOnly fullWidth data-testid=\"SSO-Key-ID\" />\n+          </div>\n+          <div className={styles.secretSection}>\n+            <div className={styles.label}>\n+              <Localized id=\"configure-auth-sso-rotate-secret\">\n+                <Label>Secret</Label>\n+              </Localized>\n+            </div>\n+            <Flex alignItems=\"center\" justifyContent=\"flex-start\">\n+              <PasswordField\n+                id=\"configure-auth-sso-rotate-secretField\"\n+                name=\"key\"\n+                value={secret}\n+                readOnly\n+                // TODO: (nick-funk) figure out how to add translations to these props\n+                hidePasswordTitle=\"Show Secret\"\n+                showPasswordTitle=\"Hide Secret\"\n+                fullWidth\n+              />\n+              <CopyToClipboard text={secret}>\n+                <Button color=\"mono\" variant=\"flat\">\n+                  <Localized\n+                    id=\"configure-auth-sso-rotate-copySecret\"\n+                    attrs={{ \"aria-label\": true }}\n+                  >\n+                    <Icon size=\"md\" aria-label=\"Copy Secret\">\n+                      content_copy\n+                    </Icon>\n+                  </Localized>\n+                </Button>\n+              </CopyToClipboard>\n+            </Flex>\n+          </div>\n+        </Flex>\n+        <Flex alignItems=\"flex-end\" justifyContent=\"space-between\">\n+          <Flex alignItems=\"center\" justifyContent=\"flex-start\">\n+            <div className={styles.statusSection}>\n+              <div className={styles.label}>\n+                <Localized id=\"configure-auth-sso-rotate-status\">\n+                  <Label>Status</Label>\n+                </Localized>\n+              </div>\n+              <StatusField status={status}></StatusField>\n+            </div>\n+            <div>\n+              <DateField status={status} dates={dates} />\n+            </div>\n+          </Flex>\n+          {createActionButton(\n+            status,\n+            onRotate,\n+            onDeactivate,\n+            onDelete,\n+            disabled\n+          )}\n+        </Flex>\n+      </HorizontalGutter>\n+    </Card>\n+  );\n+};\n+\n+export default SSOKeyCard;"
    },
    {
      "sha": "34f828982931a181e33cefc234f77b3879bf6b23",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/SSOKeyRotationContainer.tsx",
      "status": "added",
      "additions": 130,
      "deletions": 0,
      "changes": 130,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/SSOKeyRotationContainer.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/SSOKeyRotationContainer.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/SSOKeyRotationContainer.tsx?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -0,0 +1,130 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import React, { FunctionComponent, useMemo } from \"react\";\n+\n+import { graphql, withFragmentContainer } from \"coral-framework/lib/relay\";\n+import { Label } from \"coral-ui/components/v2\";\n+\n+import { SSOKeyRotationContainer_settings } from \"coral-admin/__generated__/SSOKeyRotationContainer_settings.graphql\";\n+\n+import SSOKeyCard, { SSOKeyDates } from \"./SSOKeyCard\";\n+import { SSOKeyStatus } from \"./StatusField\";\n+\n+interface Props {\n+  settings: SSOKeyRotationContainer_settings;\n+  disabled?: boolean;\n+}\n+\n+interface Key {\n+  readonly kid: string;\n+  readonly secret: string;\n+  readonly createdAt: string;\n+  readonly lastUsedAt: string | null;\n+  readonly rotatedAt: string | null;\n+  readonly inactiveAt: string | null;\n+}\n+\n+function getStatus(dates: SSOKeyDates) {\n+  if (\n+    dates.inactiveAt &&\n+    dates.rotatedAt &&\n+    new Date(dates.inactiveAt) > new Date()\n+  ) {\n+    return SSOKeyStatus.EXPIRING;\n+  }\n+\n+  if (dates.inactiveAt && new Date(dates.inactiveAt) <= new Date()) {\n+    return SSOKeyStatus.EXPIRED;\n+  }\n+\n+  return SSOKeyStatus.ACTIVE;\n+}\n+\n+const SSOKeyRotationContainer: FunctionComponent<Props> = ({\n+  disabled,\n+  settings,\n+}) => {\n+  const {\n+    auth: {\n+      integrations: {\n+        sso: { keys },\n+      },\n+    },\n+  } = settings;\n+\n+  const sortedKeys = useMemo(\n+    () =>\n+      keys\n+        // Copy this map because we don't want to modify the underlying copy.\n+        .map(key => key)\n+        .sort((a: Key, b: Key) => {\n+          // Both active, sort on createdAt date.\n+          if (!a.inactiveAt && !b.inactiveAt) {\n+            return (\n+              new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime()\n+            );\n+          }\n+          // A is active, B is not, A comes before B.\n+          if (!a.inactiveAt && b.inactiveAt) {\n+            return -1;\n+          }\n+          // B is active, A is not, B comes before A.\n+          if (a.inactiveAt && !b.inactiveAt) {\n+            return 1;\n+          }\n+\n+          // Sort primarily on inactiveAt, fall back to createdAt if\n+          // for some reason it's not available.\n+          const aDate = a.inactiveAt\n+            ? new Date(a.inactiveAt)\n+            : new Date(a.createdAt);\n+          const bDate = b.inactiveAt\n+            ? new Date(b.inactiveAt)\n+            : new Date(b.createdAt);\n+\n+          return bDate.getTime() - aDate.getTime();\n+        }),\n+    [keys]\n+  );\n+\n+  return (\n+    <>\n+      <Localized id=\"configure-auth-sso-rotate-keys\">\n+        <Label htmlFor=\"configure-auth-sso-rotate-keys\">Keys</Label>\n+      </Localized>\n+      {sortedKeys.map(key => (\n+        <SSOKeyCard\n+          key={key.kid}\n+          id={key.kid}\n+          secret={key.secret}\n+          status={getStatus(key)}\n+          dates={key}\n+          disabled={disabled}\n+        />\n+      ))}\n+    </>\n+  );\n+};\n+\n+const enhanced = withFragmentContainer<Props>({\n+  settings: graphql`\n+    fragment SSOKeyRotationContainer_settings on Settings {\n+      auth {\n+        integrations {\n+          sso {\n+            enabled\n+            keys {\n+              kid\n+              secret\n+              createdAt\n+              lastUsedAt\n+              rotatedAt\n+              inactiveAt\n+            }\n+          }\n+        }\n+      }\n+    }\n+  `,\n+})(SSOKeyRotationContainer);\n+\n+export default enhanced;"
    },
    {
      "sha": "dcf7c62b27fd0e44ed999adf9761d827a9b7cf60",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/SSOKeyRotationQuery.tsx",
      "status": "added",
      "additions": 54,
      "deletions": 0,
      "changes": 54,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/SSOKeyRotationQuery.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/SSOKeyRotationQuery.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/SSOKeyRotationQuery.tsx?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -0,0 +1,54 @@\n+import React, { FunctionComponent } from \"react\";\n+\n+import {\n+  graphql,\n+  QueryRenderData,\n+  QueryRenderer,\n+} from \"coral-framework/lib/relay\";\n+import { CallOut, Spinner } from \"coral-ui/components/v2\";\n+\n+import { SSOKeyRotationQuery as QueryTypes } from \"coral-admin/__generated__/SSOKeyRotationQuery.graphql\";\n+\n+import SSOKeyRotationContainer from \"./SSOKeyRotationContainer\";\n+\n+interface Props {\n+  disabled?: boolean;\n+}\n+\n+const SSOKeyRotationQuery: FunctionComponent<Props> = ({ disabled }) => {\n+  return (\n+    <QueryRenderer<QueryTypes>\n+      query={graphql`\n+        query SSOKeyRotationQuery {\n+          settings {\n+            ...SSOKeyRotationContainer_settings\n+          }\n+        }\n+      `}\n+      variables={{}}\n+      cacheConfig={{ force: true }}\n+      render={({ error, props }: QueryRenderData<QueryTypes>) => {\n+        if (error) {\n+          return <CallOut>{error.message}</CallOut>;\n+        }\n+\n+        if (!props) {\n+          return <Spinner />;\n+        }\n+\n+        if (!props.settings) {\n+          return <Spinner />;\n+        }\n+\n+        return (\n+          <SSOKeyRotationContainer\n+            settings={props.settings}\n+            disabled={disabled}\n+          />\n+        );\n+      }}\n+    />\n+  );\n+};\n+\n+export default SSOKeyRotationQuery;"
    },
    {
      "sha": "9c8630cd480aa705913d8d7546212ab21d6a83f0",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/StatusField.css",
      "status": "added",
      "additions": 35,
      "deletions": 0,
      "changes": 35,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/StatusField.css",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/StatusField.css",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/StatusField.css?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -0,0 +1,35 @@\n+.status {\n+  font-family: var(--v2-font-family-primary);\n+  font-weight: var(--v2-font-weight-primary-regular);\n+  font-size: var(--v2-font-size-2);\n+  line-height: var(--v2-line-height-reset);\n+\n+  border-radius: 2px;\n+  padding-left: var(--v2-spacing-1);\n+  padding-right: var(--v2-spacing-1);\n+}\n+\n+.active {\n+  background-color: var(--v2-colors-green-500);\n+  color: var(--v2-colors-pure-white);\n+}\n+\n+.expiring {\n+  background-color: var(--v2-colors-yellow-500);\n+  color: var(--v2-colors-mono-500);\n+\n+  padding-top: var(--v2-spacing-1);\n+  padding-bottom: var(--v2-spacing-1);\n+}\n+\n+.expired {\n+  background-color: var(--v2-colors-red-500);\n+  color: var(--v2-colors-pure-white);\n+\n+  padding-top: var(--v2-spacing-1);\n+  padding-bottom: var(--v2-spacing-1);\n+}\n+\n+.icon {\n+  padding-right: var(--v2-spacing-1);\n+}"
    },
    {
      "sha": "c6f8355543ff6438b1685449c9924beca83ed917",
      "filename": "src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/StatusField.tsx",
      "status": "added",
      "additions": 117,
      "deletions": 0,
      "changes": 117,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/StatusField.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/StatusField.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/routes/Configure/sections/Auth/SSOKeyRotation/StatusField.tsx?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -0,0 +1,117 @@\n+import { Localized } from \"@fluent/react/compat\";\n+import cn from \"classnames\";\n+import React, { FunctionComponent } from \"react\";\n+\n+import { Flex, Icon, Tooltip, TooltipButton } from \"coral-ui/components/v2\";\n+\n+import styles from \"./StatusField.css\";\n+\n+export enum SSOKeyStatus {\n+  EXPIRED,\n+  EXPIRING,\n+  ACTIVE,\n+}\n+\n+interface Props {\n+  status: SSOKeyStatus;\n+}\n+\n+const StatusField: FunctionComponent<Props> = ({ status }) => {\n+  switch (status) {\n+    case SSOKeyStatus.ACTIVE:\n+      return (\n+        <Localized id=\"configure-auth-sso-rotate-statusActive\">\n+          <span\n+            className={cn(styles.status, styles.active)}\n+            data-testid=\"SSO-Key-Status\"\n+          >\n+            Active\n+          </span>\n+        </Localized>\n+      );\n+    case SSOKeyStatus.EXPIRING:\n+      return (\n+        <Flex alignItems=\"center\" justifyContent=\"center\">\n+          <Flex\n+            alignItems=\"center\"\n+            justifyContent=\"center\"\n+            className={cn(styles.status, styles.expiring)}\n+          >\n+            <Icon className={styles.icon}>alarm</Icon>\n+            <Localized id=\"configure-auth-sso-rotate-statusExpiring\">\n+              <span data-testid=\"SSO-Key-Status\">Expiring</span>\n+            </Localized>\n+          </Flex>\n+          <Tooltip\n+            id=\"configure-auth-sso-rotate-expiringTooltip\"\n+            title=\"\"\n+            body={\n+              <Localized id=\"configure-auth-sso-rotate-expiringTooltip\">\n+                <span>\n+                  An SSO key is expiring when it is scheduled for rotation.\n+                </span>\n+              </Localized>\n+            }\n+            button={({ toggleVisibility, ref, visible }) => (\n+              <Localized\n+                id=\"configure-auth-sso-rotate-expiringTooltip-toggleButton\"\n+                attrs={{ \"aria-label\": true }}\n+              >\n+                <TooltipButton\n+                  active\n+                  aria-label=\"Toggle expiring tooltip visibility\"\n+                  toggleVisibility={toggleVisibility}\n+                  ref={ref}\n+                />\n+              </Localized>\n+            )}\n+          />\n+        </Flex>\n+      );\n+    case SSOKeyStatus.EXPIRED:\n+      return (\n+        <Flex alignItems=\"center\" justifyContent=\"center\">\n+          <Localized id=\"configure-auth-sso-rotate-statusExpired\">\n+            <span\n+              className={cn(styles.status, styles.expired)}\n+              data-testid=\"SSO-Key-Status\"\n+            >\n+              Expired\n+            </span>\n+          </Localized>\n+          <Tooltip\n+            id=\"configure-auth-sso-rotate-expiredTooltip\"\n+            title=\"\"\n+            body={\n+              <Localized id=\"configure-auth-sso-rotate-expiredTooltip\">\n+                <span>\n+                  An SSO key is expired when it has been rotated out of use.\n+                </span>\n+              </Localized>\n+            }\n+            button={({ toggleVisibility, ref, visible }) => (\n+              <Localized\n+                id=\"configure-auth-sso-rotate-expiredTooltip-toggleButton\"\n+                attrs={{ \"aria-label\": true }}\n+              >\n+                <TooltipButton\n+                  active\n+                  aria-label=\"Toggle expired tooltip visibility\"\n+                  toggleVisibility={toggleVisibility}\n+                  ref={ref}\n+                />\n+              </Localized>\n+            )}\n+          />\n+        </Flex>\n+      );\n+    default:\n+      return (\n+        <Localized id=\"configure-auth-sso-rotate-statusUnknown\">\n+          <span data-testid=\"SSO-Key-Status\">Unknown</span>\n+        </Localized>\n+      );\n+  }\n+};\n+\n+export default StatusField;"
    },
    {
      "sha": "c261b3c9a21015715d2c646007ac79f825f8206d",
      "filename": "src/core/client/admin/test/configure/__snapshots__/auth.spec.tsx.snap",
      "status": "modified",
      "additions": 210,
      "deletions": 63,
      "changes": 273,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/test/configure/__snapshots__/auth.spec.tsx.snap",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/test/configure/__snapshots__/auth.spec.tsx.snap",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/configure/__snapshots__/auth.spec.tsx.snap?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -1242,86 +1242,233 @@ integration to register for a new account.\n                 <div\n                   className=\"Box-root HorizontalGutter-root HorizontalGutter-spacing-4\"\n                 >\n-                  <div\n-                    className=\"Box-root HorizontalGutter-root FormField-root SSOKeyField-root HorizontalGutter-spacing-2\"\n+                  <p\n+                    className=\"FormFieldDescription-root\"\n                   >\n-                    <label\n-                      className=\"Label-root\"\n-                      htmlFor=\"configure-auth-sso-key\"\n+                    To enable integration with your existing authentication system,\n+you will need to create a JWT Token to connect. You can learn\n+more about creating a JWT Token with \n+                    <a\n+                      className=\"ExternalLink-root\"\n+                      href=\"https://jwt.io/introduction/\"\n+                      rel=\"noopener noreferrer\"\n+                      target=\"_blank\"\n                     >\n-                      Key\n-                    </label>\n+                      this introduction\n+                    </a>\n+                    . See our\n+\n+                    <a\n+                      className=\"ExternalLink-root\"\n+                      href=\"https://docs.coralproject.net/coral/v5/integrating/sso/\"\n+                      rel=\"noopener noreferrer\"\n+                      target=\"_blank\"\n+                    >\n+                      documentation\n+                    </a>\n+                     for additional information on single sign on.\n+                  </p>\n+                  <label\n+                    className=\"Label-root\"\n+                    htmlFor=\"configure-auth-sso-rotate-keys\"\n+                  >\n+                    Keys\n+                  </label>\n+                  <div\n+                    className=\"Card-root\"\n+                  >\n                     <div\n-                      className=\"PasswordField-fullWidth PasswordField-root\"\n+                      className=\"Box-root HorizontalGutter-root HorizontalGutter-full\"\n                     >\n                       <div\n-                        className=\"PasswordField-wrapper\"\n+                        className=\"Box-root Flex-root Flex-flex Flex-justifySpaceBetween Flex-alignCenter\"\n                       >\n-                        <input\n-                          autoCapitalize=\"off\"\n-                          autoComplete=\"off\"\n-                          autoCorrect=\"off\"\n-                          className=\"PasswordField-colorRegular PasswordField-fullWidth PasswordField-input\"\n-                          data-testid=\"password-field\"\n-                          id=\"configure-auth-sso-key\"\n-                          name=\"key\"\n-                          placeholder=\"\"\n-                          readOnly={true}\n-                          spellCheck={false}\n-                          type=\"password\"\n-                        />\n                         <div\n-                          className=\"PasswordField-icon\"\n-                          onClick={[Function]}\n-                          onKeyUp={[Function]}\n-                          role=\"button\"\n-                          tabIndex={0}\n-                          title=\"Hide SSO Key\"\n+                          className=\"SSOKeyCard-keySection\"\n                         >\n-                          <i\n-                            aria-hidden=\"true\"\n-                            className=\"Icon-root Icon-sm\"\n+                          <div\n+                            className=\"SSOKeyCard-label\"\n                           >\n-                            visibility\n-                          </i>\n+                            <label\n+                              className=\"Label-root\"\n+                            >\n+                              Key ID\n+                            </label>\n+                          </div>\n+                          <div\n+                            className=\"TextField-root TextField-fullWidth\"\n+                          >\n+                            <input\n+                              className=\"TextField-input TextField-colorRegular\"\n+                              data-testid=\"SSO-Key-ID\"\n+                              placeholder=\"\"\n+                              readOnly={true}\n+                              type=\"text\"\n+                              value=\"kid-01\"\n+                            />\n+                          </div>\n+                        </div>\n+                        <div\n+                          className=\"SSOKeyCard-secretSection\"\n+                        >\n+                          <div\n+                            className=\"SSOKeyCard-label\"\n+                          >\n+                            <label\n+                              className=\"Label-root\"\n+                            >\n+                              Secret\n+                            </label>\n+                          </div>\n+                          <div\n+                            className=\"Box-root Flex-root Flex-flex Flex-justifyFlexStart Flex-alignCenter\"\n+                          >\n+                            <div\n+                              className=\"PasswordField-fullWidth PasswordField-root\"\n+                            >\n+                              <div\n+                                className=\"PasswordField-wrapper\"\n+                              >\n+                                <input\n+                                  autoCapitalize=\"off\"\n+                                  autoComplete=\"off\"\n+                                  autoCorrect=\"off\"\n+                                  className=\"PasswordField-colorRegular PasswordField-fullWidth PasswordField-input\"\n+                                  data-testid=\"password-field\"\n+                                  id=\"configure-auth-sso-rotate-secretField\"\n+                                  name=\"key\"\n+                                  placeholder=\"\"\n+                                  readOnly={true}\n+                                  spellCheck={false}\n+                                  type=\"password\"\n+                                  value=\"secret\"\n+                                />\n+                                <div\n+                                  className=\"PasswordField-icon\"\n+                                  onClick={[Function]}\n+                                  onKeyUp={[Function]}\n+                                  role=\"button\"\n+                                  tabIndex={0}\n+                                  title=\"Hide Secret\"\n+                                >\n+                                  <i\n+                                    aria-hidden=\"true\"\n+                                    className=\"Icon-root Icon-sm\"\n+                                  >\n+                                    visibility\n+                                  </i>\n+                                </div>\n+                              </div>\n+                            </div>\n+                            <button\n+                              className=\"BaseButton-root Button-root Button-sizeRegular Button-colorMono Button-variantFlat Button-uppercase\"\n+                              data-color=\"mono\"\n+                              data-variant=\"flat\"\n+                              onBlur={[Function]}\n+                              onClick={[Function]}\n+                              onFocus={[Function]}\n+                              onMouseOut={[Function]}\n+                              onMouseOver={[Function]}\n+                              onTouchEnd={[Function]}\n+                              type=\"button\"\n+                            >\n+                              <i\n+                                aria-hidden=\"true\"\n+                                aria-label=\"Copy Secret\"\n+                                className=\"Icon-root Icon-md\"\n+                              >\n+                                content_copy\n+                              </i>\n+                            </button>\n+                          </div>\n                         </div>\n                       </div>\n-                    </div>\n-                    <div\n-                      className=\"SSOKeyField-warningSection\"\n-                    >\n                       <div\n-                        className=\"Box-root Flex-root Flex-flex Flex-halfItemGutter Flex-directionRow gutter\"\n+                        className=\"Box-root Flex-root Flex-flex Flex-justifySpaceBetween Flex-alignFlexEnd\"\n                       >\n-                        <i\n-                          aria-hidden=\"true\"\n-                          className=\"Icon-root Icon-sm SSOKeyField-warnIcon\"\n+                        <div\n+                          className=\"Box-root Flex-root Flex-flex Flex-justifyFlexStart Flex-alignCenter\"\n                         >\n-                          warning\n-                        </i>\n-                        <p\n-                          className=\"HelperText-root\"\n+                          <div\n+                            className=\"SSOKeyCard-statusSection\"\n+                          >\n+                            <div\n+                              className=\"SSOKeyCard-label\"\n+                            >\n+                              <label\n+                                className=\"Label-root\"\n+                              >\n+                                Status\n+                              </label>\n+                            </div>\n+                            <span\n+                              className=\"StatusField-status StatusField-active\"\n+                              data-testid=\"SSO-Key-Status\"\n+                            >\n+                              Active\n+                            </span>\n+                          </div>\n+                          <div>\n+                            <div\n+                              className=\"DateField-label\"\n+                            >\n+                              <label\n+                                className=\"Label-root\"\n+                              >\n+                                Active Since\n+                              </label>\n+                            </div>\n+                            <span\n+                              className=\"DateField-date\"\n+                            >\n+                              1/1/2020, 1:00 AM\n+                            </span>\n+                          </div>\n+                        </div>\n+                        <div\n+                          className=\"Popover-root\"\n                         >\n-                          When regenerating a key, tokens signed with the previous key will be honored for 30 days.\n-                        </p>\n+                          <button\n+                            className=\"BaseButton-root Button-root Button-sizeRegular Button-colorRegular Button-variantRegular Button-uppercase Button-disabled\"\n+                            data-color=\"regular\"\n+                            data-variant=\"regular\"\n+                            disabled={true}\n+                            onBlur={[Function]}\n+                            onClick={[Function]}\n+                            onFocus={[Function]}\n+                            onMouseOut={[Function]}\n+                            onMouseOver={[Function]}\n+                            onTouchEnd={[Function]}\n+                            type=\"button\"\n+                          >\n+                            <span\n+                              className=\"RotationDropdown-rotate\"\n+                            >\n+                              Rotate\n+                            </span>\n+                            <i\n+                              aria-hidden=\"true\"\n+                              className=\"Icon-root Icon-sm\"\n+                            >\n+                              arrow_drop_down\n+                            </i>\n+                          </button>\n+                          <div\n+                            aria-hidden={true}\n+                            aria-labelledby=\"sso-key-rotate-ariainfo\"\n+                            id=\"sso-key-rotate\"\n+                            role=\"dialog\"\n+                          >\n+                            <div\n+                              className=\"AriaInfo-root\"\n+                              id=\"sso-key-rotate-ariainfo\"\n+                            >\n+                              A dropdown to rotate the SSO key\n+                            </div>\n+                          </div>\n+                        </div>\n                       </div>\n                     </div>\n-                    <button\n-                      className=\"BaseButton-root Button-root Button-sizeRegular Button-colorRegular Button-variantRegular Button-uppercase Button-disabled SSOKeyField-regenerateButton\"\n-                      data-color=\"regular\"\n-                      data-variant=\"regular\"\n-                      disabled={true}\n-                      id=\"configure-auth-sso-regenerate\"\n-                      onBlur={[Function]}\n-                      onClick={[Function]}\n-                      onFocus={[Function]}\n-                      onMouseOut={[Function]}\n-                      onMouseOver={[Function]}\n-                      onTouchEnd={[Function]}\n-                      type=\"button\"\n-                    >\n-                      Regenerate\n-                    </button>\n                   </div>\n                   <div\n                     className=\"Box-root HorizontalGutter-root FormField-root HorizontalGutter-spacing-2\""
    },
    {
      "sha": "b018430086e6d3427baa2f238bf4a054d7844849",
      "filename": "src/core/client/admin/test/configure/auth.spec.tsx",
      "status": "modified",
      "additions": 50,
      "deletions": 10,
      "changes": 60,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/test/configure/auth.spec.tsx",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/test/configure/auth.spec.tsx",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/configure/auth.spec.tsx?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -9,6 +9,7 @@ import {\n   CreateTestRendererParams,\n   findParentWithType,\n   replaceHistoryLocation,\n+  toJSON,\n   wait,\n   waitForElement,\n   within,\n@@ -57,20 +58,34 @@ it(\"renders configure auth\", async () => {\n   expect(within(configureContainer).toJSON()).toMatchSnapshot();\n });\n \n-it(\"regenerate sso key\", async () => {\n+it(\"rotate sso key\", async () => {\n   const { testRenderer } = await createTestRenderer({\n     resolvers: createResolversStub<GQLResolver>({\n       Mutation: {\n-        regenerateSSOKey: () => {\n+        rotateSSOKey: () => {\n           return {\n             settings: pureMerge<typeof settingsWithEmptyAuth>(\n               settingsWithEmptyAuth,\n               {\n                 auth: {\n                   integrations: {\n                     sso: {\n-                      key: \"==GENERATED_KEY==\",\n-                      keyGeneratedAt: \"2018-11-12T23:26:06.239Z\",\n+                      enabled: true,\n+                      keys: [\n+                        {\n+                          kid: \"kid-01\",\n+                          secret: \"secret\",\n+                          createdAt: \"2015-01-01T00:00:00.000Z\",\n+                          lastUsedAt: \"2016-01-01T01:45:00.000Z\",\n+                          rotatedAt: \"2016-01-01T01:45:00.000Z\",\n+                          inactiveAt: \"2016-01-01T01:45:00.000Z\",\n+                        },\n+                        {\n+                          kid: \"kid-02\",\n+                          secret: \"new-secret\",\n+                          createdAt: \"2019-01-01T01:45:00.000Z\",\n+                        },\n+                      ],\n                     },\n                   },\n                 },\n@@ -90,15 +105,40 @@ it(\"regenerate sso key\", async () => {\n \n   act(() => {\n     within(container)\n-      .getByText(\"Regenerate\", { selector: \"button\" })\n+      .getByText(\"Rotate\", { selector: \"button\" })\n       .props.onClick();\n   });\n \n-  await wait(() =>\n-    expect(within(container).getByLabelText(\"Key\").props.value).toBe(\n-      \"==GENERATED_KEY==\"\n-    )\n-  );\n+  const rotateNow = await waitForElement(() => {\n+    return within(container).getByText(\"Now\", { selector: \"button\" });\n+  });\n+\n+  act(() => {\n+    rotateNow.props.onClick();\n+  });\n+\n+  await wait(() => {\n+    // Check that we have two SSO Keys that match\n+    // our expected key IDs\n+    const keyIDs = within(container).getAllByTestID(\"SSO-Key-ID\");\n+    const hasOldKey = keyIDs.some(k => k.props.value === \"kid-01\");\n+    const hasNewKey = keyIDs.some(k => k.props.value === \"kid-02\");\n+    expect(hasNewKey).toBe(true);\n+    expect(hasOldKey).toBe(true);\n+\n+    const statuses = within(container).getAllByTestID(\"SSO-Key-Status\");\n+    expect(statuses.length).toBe(2);\n+    const firstStatus: any = toJSON(statuses[0]);\n+    const firstStatusIsActive = firstStatus.children.some(\n+      (s: string) => s === \"Active\"\n+    );\n+    expect(firstStatusIsActive).toBe(true);\n+    const secondStatus: any = toJSON(statuses[1]);\n+    const secondStatusIsActive = secondStatus.children.some(\n+      (s: string) => s === \"Active\"\n+    );\n+    expect(secondStatusIsActive).toBe(false);\n+  });\n });\n \n it(\"prevents admin lock out\", async () => {"
    },
    {
      "sha": "ae14ee502ae66405136acb1b9e3f2ac3ec1455e6",
      "filename": "src/core/client/admin/test/fixtures.ts",
      "status": "modified",
      "additions": 20,
      "deletions": 0,
      "changes": 20,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/test/fixtures.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/admin/test/fixtures.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/admin/test/fixtures.ts?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -114,6 +114,16 @@ export const settings = createFixture<GQLSettings>({\n           admin: true,\n           stream: true,\n         },\n+        keys: [\n+          {\n+            kid: \"kid-01\",\n+            secret: \"secret\",\n+            createdAt: \"2020-01-01T01:00:00.000Z\",\n+            lastUsedAt: undefined,\n+            rotatedAt: undefined,\n+            inactiveAt: undefined,\n+          },\n+        ],\n         key: \"\",\n         keyGeneratedAt: null,\n       },\n@@ -202,6 +212,16 @@ export const settingsWithEmptyAuth = createFixture<GQLSettings>(\n             stream: true,\n           },\n           key: \"\",\n+          keys: [\n+            {\n+              kid: \"kid-01\",\n+              secret: \"secret\",\n+              createdAt: \"2020-01-01T01:00:00.000Z\",\n+              lastUsedAt: undefined,\n+              rotatedAt: undefined,\n+              inactiveAt: undefined,\n+            },\n+          ],\n           keyGeneratedAt: null,\n         },\n         google: {"
    },
    {
      "sha": "9398587430f70326c8cf501dd3bc6a82276f4125",
      "filename": "src/core/client/stream/tabs/Configure/Q&A/AddExpertMutation.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/stream/tabs/Configure/Q&A/AddExpertMutation.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/stream/tabs/Configure/Q&A/AddExpertMutation.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/stream/tabs/Configure/Q&A/AddExpertMutation.ts?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -16,7 +16,7 @@ const AddExpertMutation = createMutation(\n   (environment: Environment, input: MutationInput<AddExpertMutation>) =>\n     commitMutationPromiseNormalized<AddExpertMutation>(environment, {\n       mutation: graphql`\n-        mutation AddExpertMutation($input: AddExpertInput!) {\n+        mutation AddExpertMutation($input: AddStoryExpertInput!) {\n           addStoryExpert(input: $input) {\n             story {\n               id"
    },
    {
      "sha": "9c559e8dd919e262dbf0a0953f1f0e72daca91b5",
      "filename": "src/core/client/stream/tabs/Configure/Q&A/RemoveExpertMutation.ts",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/stream/tabs/Configure/Q&A/RemoveExpertMutation.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/client/stream/tabs/Configure/Q&A/RemoveExpertMutation.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/client/stream/tabs/Configure/Q&A/RemoveExpertMutation.ts?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -16,7 +16,7 @@ const RemoveExpertMutation = createMutation(\n   (environment: Environment, input: MutationInput<RemoveExpertMutation>) =>\n     commitMutationPromiseNormalized<RemoveExpertMutation>(environment, {\n       mutation: graphql`\n-        mutation RemoveExpertMutation($input: RemoveExpertInput!) {\n+        mutation RemoveExpertMutation($input: RemoveStoryExpertInput!) {\n           removeStoryExpert(input: $input) {\n             story {\n               id"
    },
    {
      "sha": "111f23d39c9b4e2713868b06051548cc48b8b855",
      "filename": "src/core/server/app/middleware/passport/strategies/verifiers/sso.ts",
      "status": "modified",
      "additions": 29,
      "deletions": 4,
      "changes": 33,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/app/middleware/passport/strategies/verifiers/sso.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/app/middleware/passport/strategies/verifiers/sso.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/app/middleware/passport/strategies/verifiers/sso.ts?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -1,12 +1,17 @@\n+import { Redis } from \"ioredis\";\n import Joi from \"joi\";\n-import { isNil } from \"lodash\";\n+import { isNil, throttle } from \"lodash\";\n import { DateTime } from \"luxon\";\n import { Db } from \"mongodb\";\n \n import { validate } from \"coral-server/app/request/body\";\n import { IntegrationDisabled, TokenInvalidError } from \"coral-server/errors\";\n+import logger from \"coral-server/logger\";\n import { Secret, SSOAuthIntegration } from \"coral-server/models/settings\";\n-import { Tenant } from \"coral-server/models/tenant\";\n+import {\n+  Tenant,\n+  updateLastUsedAtTenantSSOKey,\n+} from \"coral-server/models/tenant\";\n import {\n   retrieveUserWithProfile,\n   SSOProfile,\n@@ -163,6 +168,22 @@ export async function findOrCreateSSOUser(\n   return user;\n }\n \n+const updateLastUsedAtKID = throttle(\n+  async (redis: Redis, tenantID: string, kid: string, now: Date) => {\n+    try {\n+      await updateLastUsedAtTenantSSOKey(redis, tenantID, kid, now);\n+      logger.trace({ tenantID, kid }, \"updated last used tenant sso key\");\n+    } catch (err) {\n+      logger.error(\n+        { err, tenantID, kid },\n+        \"could not update the last used tenant sso key\"\n+      );\n+    }\n+  },\n+  // Only let this update the last used time stamp every minute.\n+  60 * 1000\n+);\n+\n export interface SSOVerifierOptions {\n   mongo: Db;\n   redis: AugmentedRedis;\n@@ -285,9 +306,13 @@ export class SSOVerifier implements Verifier<SSOToken> {\n         continue;\n       }\n \n+      // The verification did not throw an error, which means the verification\n+      // succeeded! Mark the key as used last now and break out. We should do\n+      // this in the nextTick because it's not important to have it recorded at\n+      // the same time.\n+      updateLastUsedAtKID(this.redis, tenant.id, key.kid, now);\n+\n       // TODO: [CORL-754] (wyattjoh) reintroduce when we amend the front-end to display the kid\n-      // // The verification did not throw an error, which means the verification\n-      // // succeeded! Break out now.\n       // if (!kid) {\n       //   logger.warn(\n       //     { tenantID: tenant.id, kid: config.kid },"
    },
    {
      "sha": "0768303068a02007122a5f12a015f59cea9941ed",
      "filename": "src/core/server/graph/loaders/Auth.ts",
      "status": "modified",
      "additions": 6,
      "deletions": 1,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/graph/loaders/Auth.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/graph/loaders/Auth.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/loaders/Auth.ts?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -1,9 +1,11 @@\n import DataLoader from \"dataloader\";\n \n import GraphContext from \"coral-server/graph/context\";\n-import { GQLDiscoveredOIDCConfiguration } from \"coral-server/graph/schema/__generated__/types\";\n+import { retrieveLastUsedAtTenantSSOKeys } from \"coral-server/models/tenant\";\n import { discoverOIDCConfiguration } from \"coral-server/services/tenant\";\n \n+import { GQLDiscoveredOIDCConfiguration } from \"coral-server/graph/schema/__generated__/types\";\n+\n export default (ctx: GraphContext) => ({\n   discoverOIDCConfiguration: new DataLoader<\n     string,\n@@ -17,4 +19,7 @@ export default (ctx: GraphContext) => ({\n       cache: !ctx.disableCaching,\n     }\n   ),\n+  retrieveSSOKeyLastUsedAt: new DataLoader((kids: string[]) =>\n+    retrieveLastUsedAtTenantSSOKeys(ctx.redis, ctx.tenant.id, kids)\n+  ),\n });"
    },
    {
      "sha": "cda89b2b100e5e6d1936d4e14ffeab1fa611df29",
      "filename": "src/core/server/graph/mutators/Settings.ts",
      "status": "modified",
      "additions": 12,
      "deletions": 0,
      "changes": 12,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/graph/mutators/Settings.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/graph/mutators/Settings.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/mutators/Settings.ts?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -3,13 +3,16 @@ import { Tenant } from \"coral-server/models/tenant\";\n import {\n   createAnnouncement,\n   createWebhookEndpoint,\n+  deactivateSSOKey,\n   deleteAnnouncement,\n+  deleteSSOKey,\n   deleteWebhookEndpoint,\n   disableFeatureFlag,\n   disableWebhookEndpoint,\n   enableFeatureFlag,\n   enableWebhookEndpoint,\n   regenerateSSOKey,\n+  rotateSSOKey,\n   rotateWebhookEndpointSecret,\n   update,\n   updateWebhookEndpoint,\n@@ -18,10 +21,13 @@ import {\n import {\n   GQLCreateAnnouncementInput,\n   GQLCreateWebhookEndpointInput,\n+  GQLDeactivateSSOKeyInput,\n+  GQLDeleteSSOKeyInput,\n   GQLDeleteWebhookEndpointInput,\n   GQLDisableWebhookEndpointInput,\n   GQLEnableWebhookEndpointInput,\n   GQLFEATURE_FLAG,\n+  GQLRotateSSOKeyInput,\n   GQLRotateWebhookEndpointSecretInput,\n   GQLUpdateSettingsInput,\n   GQLUpdateWebhookEndpointInput,\n@@ -43,6 +49,12 @@ export const Settings = ({\n     update(mongo, redis, tenantCache, config, tenant, input.settings),\n   regenerateSSOKey: (): Promise<Tenant | null> =>\n     regenerateSSOKey(mongo, redis, tenantCache, tenant, now),\n+  rotateSSOKey: ({ inactiveIn }: GQLRotateSSOKeyInput) =>\n+    rotateSSOKey(mongo, redis, tenantCache, tenant, inactiveIn, now),\n+  deactivateSSOKey: ({ kid }: GQLDeactivateSSOKeyInput) =>\n+    deactivateSSOKey(mongo, redis, tenantCache, tenant, kid, now),\n+  deleteSSOKey: ({ kid }: GQLDeleteSSOKeyInput) =>\n+    deleteSSOKey(mongo, redis, tenantCache, tenant, kid),\n   enableFeatureFlag: (flag: GQLFEATURE_FLAG) =>\n     enableFeatureFlag(mongo, redis, tenantCache, tenant, flag),\n   disableFeatureFlag: (flag: GQLFEATURE_FLAG) =>"
    },
    {
      "sha": "2a2e67c7c34b1214fc6e6939ed08a8677f58c835",
      "filename": "src/core/server/graph/mutators/Stories.ts",
      "status": "modified",
      "additions": 4,
      "deletions": 4,
      "changes": 8,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/graph/mutators/Stories.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/graph/mutators/Stories.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/mutators/Stories.ts?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -19,12 +19,12 @@ import {\n import { scrape } from \"coral-server/services/stories/scraper\";\n \n import {\n-  GQLAddExpertInput,\n+  GQLAddStoryExpertInput,\n   GQLCloseStoryInput,\n   GQLCreateStoryInput,\n   GQLMergeStoriesInput,\n   GQLOpenStoryInput,\n-  GQLRemoveExpertInput,\n+  GQLRemoveStoryExpertInput,\n   GQLRemoveStoryInput,\n   GQLScrapeStoryInput,\n   GQLUpdateStoryInput,\n@@ -78,8 +78,8 @@ export const Stories = (ctx: GraphContext) => ({\n     scrape(ctx.mongo, ctx.config, ctx.tenant.id, input.id),\n   updateStoryMode: async (input: GQLUpdateStoryModeInput) =>\n     updateStoryMode(ctx.mongo, ctx.tenant, input.storyID, input.mode),\n-  addStoryExpert: async (input: GQLAddExpertInput) =>\n+  addStoryExpert: async (input: GQLAddStoryExpertInput) =>\n     addStoryExpert(ctx.mongo, ctx.tenant, input.storyID, input.userID),\n-  removeStoryExpert: async (input: GQLRemoveExpertInput) =>\n+  removeStoryExpert: async (input: GQLRemoveStoryExpertInput) =>\n     removeStoryExpert(ctx.mongo, ctx.tenant, input.storyID, input.userID),\n });"
    },
    {
      "sha": "141a515d496bc3f24bf1abdeb08178a3e3c28066",
      "filename": "src/core/server/graph/resolvers/Mutation.ts",
      "status": "modified",
      "additions": 12,
      "deletions": 2,
      "changes": 14,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/graph/resolvers/Mutation.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/graph/resolvers/Mutation.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/resolvers/Mutation.ts?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -1,7 +1,5 @@\n import { GQLMutationTypeResolver } from \"coral-server/graph/schema/__generated__/types\";\n \n-// TODO: (wyattjoh) add rate limiting to these edges\n-\n export const Mutation: Required<GQLMutationTypeResolver<void>> = {\n   editComment: async (source, { input }, ctx) => ({\n     comment: await ctx.mutators.Comments.edit(input),\n@@ -81,6 +79,18 @@ export const Mutation: Required<GQLMutationTypeResolver<void>> = {\n     settings: await ctx.mutators.Settings.regenerateSSOKey(),\n     clientMutationId: input.clientMutationId,\n   }),\n+  rotateSSOKey: async (source, { input }, ctx) => ({\n+    settings: await ctx.mutators.Settings.rotateSSOKey(input),\n+    clientMutationId: input.clientMutationId,\n+  }),\n+  deactivateSSOKey: async (source, { input }, ctx) => ({\n+    settings: await ctx.mutators.Settings.deactivateSSOKey(input),\n+    clientMutationId: input.clientMutationId,\n+  }),\n+  deleteSSOKey: async (source, { input }, ctx) => ({\n+    settings: await ctx.mutators.Settings.deleteSSOKey(input),\n+    clientMutationId: input.clientMutationId,\n+  }),\n   createStory: async (source, { input }, ctx) => ({\n     story: await ctx.mutators.Stories.create(input),\n     clientMutationId: input.clientMutationId,"
    },
    {
      "sha": "dccbb155adf8de655051129def4490b4c7354911",
      "filename": "src/core/server/graph/resolvers/Secret.ts",
      "status": "added",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/graph/resolvers/Secret.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/graph/resolvers/Secret.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/resolvers/Secret.ts?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -0,0 +1,8 @@\n+import * as settings from \"coral-server/models/settings\";\n+\n+import { GQLSecretTypeResolver } from \"coral-server/graph/schema/__generated__/types\";\n+\n+export const Secret: GQLSecretTypeResolver<settings.Secret> = {\n+  lastUsedAt: async ({ kid }, args, ctx) =>\n+    ctx.loaders.Auth.retrieveSSOKeyLastUsedAt.load(kid),\n+};"
    },
    {
      "sha": "7b78a0a38fe2c3dd52cbbf1f19e35d0edb52b48f",
      "filename": "src/core/server/graph/resolvers/index.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/graph/resolvers/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/graph/resolvers/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/resolvers/index.ts?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -37,6 +37,7 @@ import { Profile } from \"./Profile\";\n import { Query } from \"./Query\";\n import { RecentCommentHistory } from \"./RecentCommentHistory\";\n import { RejectCommentPayload } from \"./RejectCommentPayload\";\n+import { Secret } from \"./Secret\";\n import { Settings } from \"./Settings\";\n import { SlackConfiguration } from \"./SlackConfiguration\";\n import { SSOAuthIntegration } from \"./SSOAuthIntegration\";\n@@ -89,6 +90,7 @@ const Resolvers: GQLResolver = {\n   RecentCommentHistory,\n   RejectCommentPayload,\n   SSOAuthIntegration,\n+  Secret,\n   Story,\n   StorySettings,\n   Subscription,"
    },
    {
      "sha": "2b63a86752293927f6485288599a9aa7ba577a24",
      "filename": "src/core/server/graph/schema/schema.graphql",
      "status": "modified",
      "additions": 289,
      "deletions": 101,
      "changes": 390,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/graph/schema/schema.graphql",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/graph/schema/schema.graphql",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/graph/schema/schema.graphql?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -65,6 +65,13 @@ rate enforces a rate limit on requests made by the user.\n \"\"\"\n directive @rate(max: Int = 1, seconds: Int!, key: String) on FIELD_DEFINITION\n \n+\"\"\"\n+deprecated indicates that a field should not be used in the future.\n+\"\"\"\n+directive @deprecated(\n+  reason: String = \"No longer supported\"\n+) on FIELD_DEFINITION | ENUM_VALUE\n+\n ################################################################################\n ## Custom Scalar Types\n ################################################################################\n@@ -483,6 +490,40 @@ type LocalAuthIntegration {\n ## SSOAuthIntegration\n ##########################\n \n+type Secret {\n+  \"\"\"\n+  kid is the identifier for the key used when verifying tokens issued by the\n+  provider.\n+  \"\"\"\n+  kid: String!\n+\n+  \"\"\"\n+  secret is the actual underlying secret used to verify the tokens with.\n+  \"\"\"\n+  secret: String!\n+\n+  \"\"\"\n+  createdAt is the date that the key was created at.\n+  \"\"\"\n+  createdAt: Time!\n+\n+  \"\"\"\n+  lastUsedAt is the time that the\n+  \"\"\"\n+  lastUsedAt: Time\n+\n+  \"\"\"\n+  rotatedAt is the time that the token was rotated out.\n+  \"\"\"\n+  rotatedAt: Time\n+\n+  \"\"\"\n+  inactiveAt is the date that the token can no longer be used to validate\n+  tokens.\n+  \"\"\"\n+  inactiveAt: Time\n+}\n+\n \"\"\"\n SSOAuthIntegration is an AuthIntegration that provides a secret to the admins\n of a tenant, where they can sign a SSO payload with it to provide to the\n@@ -504,15 +545,24 @@ type SSOAuthIntegration {\n   \"\"\"\n   targetFilter: AuthenticationTargetFilter!\n \n+  \"\"\"\n+  keys are the different SSOKey's used by this Tenant.\n+  \"\"\"\n+  keys: [Secret!]! @auth(roles: [ADMIN])\n+\n   \"\"\"\n   key is the secret that is used to sign tokens.\n   \"\"\"\n-  key: String @auth(roles: [ADMIN])\n+  key: String\n+    @auth(roles: [ADMIN])\n+    @deprecated(reason: \"field is deprecated in favour of `keys`\")\n \n   \"\"\"\n   keyGeneratedAt is the Time that the key was effective from.\n   \"\"\"\n-  keyGeneratedAt: Time @auth(roles: [ADMIN])\n+  keyGeneratedAt: Time\n+    @auth(roles: [ADMIN])\n+    @deprecated(reason: \"field is deprecated in favour of `keys`\")\n }\n \n ##########################\n@@ -1234,21 +1284,6 @@ enum WEBHOOK_EVENT_NAME {\n   STORY_CREATED\n }\n \n-\"\"\"\n-TODO: merge with SSOKey with PR #2732\n-\"\"\"\n-type Secret {\n-  \"\"\"\n-  secret is the actual underlying secret used to verify the tokens with.\n-  \"\"\"\n-  secret: String!\n-\n-  \"\"\"\n-  createdAt is the date that the key was created at.\n-  \"\"\"\n-  createdAt: Time!\n-}\n-\n type WebhookEndpoint {\n   \"\"\"\n   id is the unique identifier for this specific endpoint.\n@@ -1342,6 +1377,28 @@ type Announcement {\n   content: String!\n }\n \n+type Site {\n+  \"\"\"\n+  id is the identifier of the Site.\n+  \"\"\"\n+  id: ID!\n+\n+  \"\"\"\n+  name is the name of the Site.\n+  \"\"\"\n+  name: String!\n+\n+  \"\"\"\n+  allowedOrigins are the allowed origins for embeds.\n+  \"\"\"\n+  allowedOrigins: [String!]!\n+\n+  \"\"\"\n+  createdAt is when the site was created.\n+  \"\"\"\n+  createdAt: Time!\n+}\n+\n \"\"\"\n Settings stores the global settings for a given Tenant.\n \"\"\"\n@@ -5855,6 +5912,92 @@ type EnableFeatureFlagPayload {\n   flags: [FEATURE_FLAG!]!\n }\n \n+#########################\n+## rotateSSOKey\n+#########################\n+\n+input RotateSSOKeyInput {\n+  \"\"\"\n+  clientMutationId is required for Relay support.\n+  \"\"\"\n+  clientMutationId: String!\n+\n+  \"\"\"\n+  inactiveIn is the number of seconds that the current active SSOKey should be\n+  kept active (allow signed tokens signed with this secret) before rejecting\n+  them.\n+  \"\"\"\n+  inactiveIn: Int!\n+}\n+\n+type RotateSSOKeyPayload {\n+  \"\"\"\n+  clientMutationId is required for Relay support.\n+  \"\"\"\n+  clientMutationId: String!\n+\n+  \"\"\"\n+  settings is the Settings that the SSO key was regenerated on.\n+  \"\"\"\n+  settings: Settings\n+}\n+\n+#########################\n+## deactivateSSOKey\n+#########################\n+\n+input DeactivateSSOKeyInput {\n+  \"\"\"\n+  clientMutationId is required for Relay support.\n+  \"\"\"\n+  clientMutationId: String!\n+\n+  \"\"\"\n+  kid is the ID of the SSOKey being deactivated.\n+  \"\"\"\n+  kid: ID!\n+}\n+\n+type DeactivateSSOKeyPayload {\n+  \"\"\"\n+  clientMutationId is required for Relay support.\n+  \"\"\"\n+  clientMutationId: String!\n+\n+  \"\"\"\n+  settings is the Settings that the SSO key was regenerated on.\n+  \"\"\"\n+  settings: Settings\n+}\n+\n+#########################\n+## deleteSSOKey\n+#########################\n+\n+input DeleteSSOKeyInput {\n+  \"\"\"\n+  clientMutationId is required for Relay support.\n+  \"\"\"\n+  clientMutationId: String!\n+\n+  \"\"\"\n+  kid is the ID of the SSOKey being deleted.\n+  \"\"\"\n+  kid: ID!\n+}\n+\n+type DeleteSSOKeyPayload {\n+  \"\"\"\n+  clientMutationId is required for Relay support.\n+  \"\"\"\n+  clientMutationId: String!\n+\n+  \"\"\"\n+  settings is the Settings that the SSO key was regenerated on.\n+  \"\"\"\n+  settings: Settings\n+}\n+\n #########################\n # disableFeatureFlag\n #########################\n@@ -5884,10 +6027,10 @@ type DisableFeatureFlagPayload {\n }\n \n #########################\n-# Add / Remove Expert\n+# addStoryExpert\n #########################\n \n-input AddExpertInput {\n+input AddStoryExpertInput {\n   \"\"\"\n   clientMutationId is required for Relay support.\n   \"\"\"\n@@ -5904,7 +6047,7 @@ input AddExpertInput {\n   userID: ID!\n }\n \n-type AddExpertPayload {\n+type AddStoryExpertPayload {\n   \"\"\"\n   clientMutationId is required for Relay support.\n   \"\"\"\n@@ -5916,7 +6059,11 @@ type AddExpertPayload {\n   story: Story!\n }\n \n-input RemoveExpertInput {\n+#########################\n+# removeStoryExpert\n+#########################\n+\n+input RemoveStoryExpertInput {\n   \"\"\"\n   clientMutationId is required for Relay support.\n   \"\"\"\n@@ -5933,7 +6080,7 @@ input RemoveExpertInput {\n   userID: ID!\n }\n \n-type RemoveExpertPayload {\n+type RemoveStoryExpertPayload {\n   \"\"\"\n   clientMutationId is required for Relay support.\n   \"\"\"\n@@ -5945,6 +6092,10 @@ type RemoveExpertPayload {\n   story: Story!\n }\n \n+#########################\n+## updateStoryMode\n+#########################\n+\n input UpdateStoryModeInput {\n   \"\"\"\n   storyID is the story id to enable Q&A on.\n@@ -5963,15 +6114,110 @@ input UpdateStoryModeInput {\n }\n \n type UpdateStoryModePayload {\n+  \"\"\"\n+  clientMutationId is required for Relay support.\n+  \"\"\"\n+  clientMutationId: String!\n+\n   \"\"\"\n   story is the resultant story that Q&A was enabled on.\n   \"\"\"\n   story: Story!\n+}\n \n+##################\n+## createSite\n+##################\n+\n+input CreateSite {\n+  \"\"\"\n+  name is the name of the Site.\n+  \"\"\"\n+  name: String!\n+\n+  \"\"\"\n+  allowedOrigins are the allowed origins for embeds.\n+  \"\"\"\n+  allowedOrigins: [String!]!\n+}\n+\n+input CreateSiteInput {\n   \"\"\"\n   clientMutationId is required for Relay support.\n   \"\"\"\n   clientMutationId: String!\n+\n+  \"\"\"\n+  site is the input for the Site to create.\n+  \"\"\"\n+  site: CreateSite!\n+}\n+\n+type CreateSitePayload {\n+  \"\"\"\n+  clientMutationId is required for Relay support.\n+  \"\"\"\n+  clientMutationId: String!\n+\n+  \"\"\"\n+  site is the Site that was newly created.\n+  \"\"\"\n+  site: Site!\n+}\n+\n+##################\n+## updateSite\n+##################\n+\n+input UpdateSite {\n+  \"\"\"\n+  name is the name of the Site.\n+  \"\"\"\n+  name: String\n+\n+  \"\"\"\n+  url is the Site URL, seen in email communications.\n+  \"\"\"\n+  url: String\n+\n+  \"\"\"\n+  contactEmail is the contact email for the Site, seen in email communications.\n+  \"\"\"\n+  contactEmail: String\n+\n+  \"\"\"\n+  allowedOrigins are the allowed origins for embeds.\n+  \"\"\"\n+  allowedOrigins: [String!]\n+}\n+\n+input UpdateSiteInput {\n+  \"\"\"\n+  clientMutationId is required for Relay support.\n+  \"\"\"\n+  clientMutationId: String!\n+\n+  \"\"\"\n+  id is the ID of the Site to update.\n+  \"\"\"\n+  id: ID!\n+\n+  \"\"\"\n+  site is the updates for the Site.\n+  \"\"\"\n+  site: UpdateSite!\n+}\n+\n+type UpdateSitePayload {\n+  \"\"\"\n+  clientMutationId is required for Relay support.\n+  \"\"\"\n+  clientMutationId: String!\n+\n+  \"\"\"\n+  site is the newly updated Site.\n+  \"\"\"\n+  site: Site!\n }\n \n ##################\n@@ -6012,6 +6258,25 @@ type Mutation {\n   \"\"\"\n   regenerateSSOKey(input: RegenerateSSOKeyInput!): RegenerateSSOKeyPayload!\n     @auth(roles: [ADMIN])\n+    @deprecated(reason: \"deprecated in favour of `rotateSSOKey`\")\n+\n+  \"\"\"\n+  rotateSSOKey can be used to rotate a given active SSOKey.\n+  \"\"\"\n+  rotateSSOKey(input: RotateSSOKeyInput!): RotateSSOKeyPayload!\n+    @auth(roles: [ADMIN])\n+\n+  \"\"\"\n+  deactivateSSOKey will deactivate a given deactivated SSOKey.\n+  \"\"\"\n+  deactivateSSOKey(input: DeactivateSSOKeyInput!): DeactivateSSOKeyPayload!\n+    @auth(roles: [ADMIN])\n+\n+  \"\"\"\n+  deleteSSOKey will delete a given inactive SSOKey.\n+  \"\"\"\n+  deleteSSOKey(input: DeleteSSOKeyInput!): DeleteSSOKeyPayload!\n+    @auth(roles: [ADMIN])\n \n   \"\"\"\n   createCommentReaction will create a Reaction authored by the current logged in\n@@ -6416,13 +6681,13 @@ type Mutation {\n   \"\"\"\n   addStoryExpert adds an expert to a story.\n   \"\"\"\n-  addStoryExpert(input: AddExpertInput!): AddExpertPayload!\n+  addStoryExpert(input: AddStoryExpertInput!): AddStoryExpertPayload!\n     @auth(roles: [ADMIN, MODERATOR])\n \n   \"\"\"\n   removeStoryExpert removes an expert from a story.\n   \"\"\"\n-  removeStoryExpert(input: RemoveExpertInput!): RemoveExpertPayload!\n+  removeStoryExpert(input: RemoveStoryExpertInput!): RemoveStoryExpertPayload!\n     @auth(roles: [ADMIN, MODERATOR])\n }\n \n@@ -6608,80 +6873,3 @@ type Subscription {\n   commentFeatured(storyID: ID!): CommentFeaturedPayload!\n     @auth(roles: [MODERATOR, ADMIN])\n }\n-\n-type Site {\n-  \"\"\"\n-  id is the identifier of the Site.\n-  \"\"\"\n-  id: ID!\n-\n-  \"\"\"\n-  name is the name of the Site.\n-  \"\"\"\n-  name: String!\n-\n-  \"\"\"\n-  allowedOrigins are the allowed origins for embeds.\n-  \"\"\"\n-  allowedOrigins: [String!]!\n-\n-  \"\"\"\n-  createdAt is when the site was created.\n-  \"\"\"\n-  createdAt: Time!\n-}\n-\n-input CreateSite {\n-  \"\"\"\n-  name is the name of the Site.\n-  \"\"\"\n-  name: String!\n-\n-  \"\"\"\n-  allowedOrigins are the allowed origins for embeds.\n-  \"\"\"\n-  allowedOrigins: [String!]!\n-}\n-\n-input UpdateSite {\n-  \"\"\"\n-  name is the name of the Site.\n-  \"\"\"\n-  name: String\n-\n-  \"\"\"\n-  url is the Site URL, seen in email communications.\n-  \"\"\"\n-  url: String\n-\n-  \"\"\"\n-  contactEmail is the contact email for the Site, seen in email communications.\n-  \"\"\"\n-  contactEmail: String\n-\n-  \"\"\"\n-  allowedOrigins are the allowed origins for embeds.\n-  \"\"\"\n-  allowedOrigins: [String!]\n-}\n-\n-input CreateSiteInput {\n-  clientMutationId: String!\n-  site: CreateSite!\n-}\n-\n-type CreateSitePayload {\n-  clientMutationId: String!\n-  site: Site!\n-}\n-\n-input UpdateSiteInput {\n-  clientMutationId: String!\n-  site: UpdateSite!\n-  id: ID!\n-}\n-\n-type UpdateSitePayload {\n-  clientMutationId: String!\n-  site: Site!\n-}"
    },
    {
      "sha": "7fbaa82560c83681e8a7576bc65691976e38cd69",
      "filename": "src/core/server/models/tenant/tenant.ts",
      "status": "modified",
      "additions": 84,
      "deletions": 2,
      "changes": 86,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/models/tenant/tenant.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/models/tenant/tenant.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/models/tenant/tenant.ts?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -1,3 +1,4 @@\n+import { Redis } from \"ioredis\";\n import { isEmpty } from \"lodash\";\n import { DateTime } from \"luxon\";\n import { Db } from \"mongodb\";\n@@ -10,7 +11,6 @@ import { DeepPartial, Omit, Sub } from \"coral-common/types\";\n import { isBeforeDate } from \"coral-common/utils\";\n import { dotize } from \"coral-common/utils/dotize\";\n import logger from \"coral-server/logger\";\n-import { Secret, Settings } from \"coral-server/models/settings\";\n import { I18n } from \"coral-server/services/i18n\";\n import { tenants as collection } from \"coral-server/services/mongodb/collections\";\n \n@@ -22,6 +22,7 @@ import {\n   GQLWEBHOOK_EVENT_NAME,\n } from \"coral-server/graph/schema/__generated__/types\";\n \n+import { Secret, Settings } from \"../settings\";\n import {\n   generateSecret,\n   getDefaultReactionConfiguration,\n@@ -388,7 +389,7 @@ export async function createTenantSSOKey(mongo: Db, id: string, now: Date) {\n   return result.value || null;\n }\n \n-export async function rotateTenantSSOKey(\n+export async function deactivateTenantSSOKey(\n   mongo: Db,\n   id: string,\n   kid: string,\n@@ -463,6 +464,24 @@ export async function disableTenantFeatureFlag(\n \n   return result.value || null;\n }\n+export async function deleteTenantSSOKey(mongo: Db, id: string, kid: string) {\n+  // Update the tenant.\n+  const result = await collection(mongo).findOneAndUpdate(\n+    { id },\n+    {\n+      $pull: {\n+        \"auth.integrations.sso.keys\": { kid },\n+      },\n+    },\n+    {\n+      // False to return the updated document instead of the original\n+      // document.\n+      returnOriginal: false,\n+    }\n+  );\n+\n+  return result.value || null;\n+}\n \n export interface CreateAnnouncementInput {\n   content: string;\n@@ -767,3 +786,66 @@ export async function deleteTenantWebhookEndpoint(\n \n   return result.value;\n }\n+\n+function lastUsedAtTenantSSOKey(id: string): string {\n+  return `${id}:lastUsedSSOKey`;\n+}\n+\n+/**\n+ * updateLastUsedAtTenantSSOKey will update the time stamp that the SSO key was\n+ * last used at.\n+ *\n+ * @param redis the Redis connection to use to update the timestamp on\n+ * @param id the ID of the Tenant\n+ * @param kid the kid of the token that was used\n+ * @param when the date that the token was last used at\n+ */\n+export async function updateLastUsedAtTenantSSOKey(\n+  redis: Redis,\n+  id: string,\n+  kid: string,\n+  when: Date\n+) {\n+  await redis.hset(lastUsedAtTenantSSOKey(id), kid, when.toISOString());\n+}\n+\n+/**\n+ *\n+ * @param redis the Redis connection to use to remove the last used on.\n+ * @param id the ID of the Tenant\n+ * @param kid the kid of the token that is being deleted\n+ */\n+export async function deleteLastUsedAtTenantSSOKey(\n+  redis: Redis,\n+  id: string,\n+  kid: string\n+) {\n+  await redis.hdel(lastUsedAtTenantSSOKey(id), kid);\n+}\n+\n+/**\n+ * retrieveLastUsedAtTenantSSOKeys will get the dates that the requested sso\n+ * keys were last used on.\n+ *\n+ * @param redis the Redis connection to use to update the timestamp on\n+ * @param id the ID of the Tenant\n+ * @param kids the kids of the tokens that we want to know when they were last used\n+ */\n+export async function retrieveLastUsedAtTenantSSOKeys(\n+  redis: Redis,\n+  id: string,\n+  kids: string[]\n+) {\n+  const results: Array<string | null> = await redis.hmget(\n+    lastUsedAtTenantSSOKey(id),\n+    ...kids\n+  );\n+\n+  return results.map(lastUsedAt => {\n+    if (!lastUsedAt) {\n+      return null;\n+    }\n+\n+    return new Date(lastUsedAt);\n+  });\n+}"
    },
    {
      "sha": "36a1b843c4f75e946382b301e3ece57e3a05475a",
      "filename": "src/core/server/services/tenant/index.ts",
      "status": "modified",
      "additions": 2,
      "deletions": 548,
      "changes": 550,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/services/tenant/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/services/tenant/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/tenant/index.ts?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -1,548 +1,2 @@\n-import { Redis } from \"ioredis\";\n-import { isUndefined, lowerCase, uniqBy } from \"lodash\";\n-import { DateTime } from \"luxon\";\n-import { Db } from \"mongodb\";\n-import { URL } from \"url\";\n-\n-import { discover } from \"coral-server/app/middleware/passport/strategies/oidc/discover\";\n-import { Config } from \"coral-server/config\";\n-import { TenantInstalledAlreadyError } from \"coral-server/errors\";\n-import logger from \"coral-server/logger\";\n-import {\n-  CreateAnnouncementInput,\n-  createTenant,\n-  createTenantAnnouncement,\n-  CreateTenantInput,\n-  createTenantSSOKey,\n-  createTenantWebhookEndpoint,\n-  CreateTenantWebhookEndpointInput,\n-  deleteTenantAnnouncement,\n-  deleteTenantWebhookEndpoint,\n-  disableTenantFeatureFlag,\n-  enableTenantFeatureFlag,\n-  getWebhookEndpoint,\n-  rollTenantWebhookEndpointSecret,\n-  rotateTenantSSOKey,\n-  Tenant,\n-  updateTenant,\n-  updateTenantWebhookEndpoint,\n-  UpdateTenantWebhookEndpointInput,\n-} from \"coral-server/models/tenant\";\n-import { I18n } from \"coral-server/services/i18n\";\n-\n-import {\n-  GQLFEATURE_FLAG,\n-  GQLSettingsInput,\n-  GQLSettingsWordListInput,\n-  GQLWEBHOOK_EVENT_NAME,\n-} from \"coral-server/graph/schema/__generated__/types\";\n-\n-import TenantCache from \"./cache\";\n-\n-export type UpdateTenant = GQLSettingsInput;\n-\n-function cleanWordList(\n-  list: GQLSettingsWordListInput\n-): GQLSettingsWordListInput {\n-  if (list.banned) {\n-    list.banned = uniqBy(list.banned.filter(Boolean), lowerCase) as string[];\n-  }\n-\n-  if (list.suspect) {\n-    list.suspect = uniqBy(list.suspect.filter(Boolean), lowerCase) as string[];\n-  }\n-\n-  return list;\n-}\n-\n-export async function update(\n-  mongo: Db,\n-  redis: Redis,\n-  cache: TenantCache,\n-  config: Config,\n-  tenant: Tenant,\n-  input: UpdateTenant\n-): Promise<Tenant | null> {\n-  // If the environment variable for disabling live updates is provided, then\n-  // ensure we don't permit changes to the database model.\n-  if (\n-    config.get(\"disable_live_updates\") &&\n-    input.live &&\n-    !isUndefined(input.live.enabled)\n-  ) {\n-    delete input.live.enabled;\n-  }\n-\n-  // If the word list was specified, we should validate it to ensure there isn't\n-  // any empty spaces.\n-  if (input.wordList) {\n-    input.wordList = cleanWordList(input.wordList);\n-  }\n-\n-  const updatedTenant = await updateTenant(mongo, tenant.id, input);\n-  if (!updatedTenant) {\n-    return null;\n-  }\n-\n-  // Update the tenant cache.\n-  await cache.update(redis, updatedTenant);\n-\n-  return updatedTenant;\n-}\n-\n-/**\n- * isInstalled will return a promise that if true, indicates that a Tenant has\n- * been installed.\n- */\n-export async function isInstalled(cache: TenantCache, domain?: string) {\n-  const count = await cache.count();\n-  if (count === 0) {\n-    return false;\n-  }\n-\n-  if (domain) {\n-    const tenant = await cache.retrieveByDomain(domain);\n-    if (tenant) {\n-      return true;\n-    }\n-\n-    return false;\n-  }\n-\n-  return true;\n-}\n-\n-export type InstallTenant = CreateTenantInput;\n-\n-export async function install(\n-  mongo: Db,\n-  redis: Redis,\n-  cache: TenantCache,\n-  i18n: I18n,\n-  input: InstallTenant,\n-  now = new Date()\n-) {\n-  // Ensure that this Tenant isn't being installed onto a domain that already\n-  // exists.\n-  if (await isInstalled(cache, input.domain)) {\n-    throw new TenantInstalledAlreadyError();\n-  }\n-\n-  logger.info(\"installing tenant\");\n-\n-  // Create the Tenant.\n-  const tenant = await createTenant(mongo, i18n, input, now);\n-\n-  // Update the tenant cache.\n-  await cache.update(redis, tenant);\n-\n-  logger.info({ tenantID: tenant.id }, \"a tenant has been installed\");\n-\n-  return tenant;\n-}\n-\n-/**\n- * canInstall will return a promise that determines if a given install can\n- * proceed.\n- */\n-export async function canInstall(cache: TenantCache) {\n-  return (await cache.count()) === 0;\n-}\n-\n-/**\n- * regenerateSSOKey will regenerate the Single Sign-On key for the specified\n- * Tenant and notify all other Tenant's connected that the Tenant was updated.\n- */\n-export async function regenerateSSOKey(\n-  mongo: Db,\n-  redis: Redis,\n-  cache: TenantCache,\n-  tenant: Tenant,\n-  now: Date\n-) {\n-  // Deprecate the old Tenant SSO key if it exists.\n-  if (tenant.auth.integrations.sso.keys.length > 0) {\n-    // Get the old keys that are not deprecated.\n-    const keysToDeprecate = tenant.auth.integrations.sso.keys.filter(key => {\n-      return !key.rotatedAt;\n-    });\n-\n-    // Check to see if there are keys to deprecate.\n-    if (keysToDeprecate.length > 0) {\n-      // All the keys will be deprecated a month from now.\n-      // TODO: [CORL-754] (wyattjoh) take input for the deprecation duration later.\n-      const deprecateAt = DateTime.fromJSDate(now)\n-        .plus({ month: 1 })\n-        .toJSDate();\n-\n-      // Deprecate all the keys that are associated on the tenant that haven't\n-      // been done.\n-      for (const key of keysToDeprecate) {\n-        await rotateTenantSSOKey(mongo, tenant.id, key.kid, deprecateAt, now);\n-      }\n-    }\n-  }\n-\n-  // Create the new Tenant.\n-  const updatedTenant = await createTenantSSOKey(mongo, tenant.id, now);\n-  if (!updatedTenant) {\n-    return null;\n-  }\n-\n-  // Update the tenant cache.\n-  await cache.update(redis, updatedTenant);\n-\n-  return updatedTenant;\n-}\n-\n-/**\n- * discoverOIDCConfiguration will discover the OpenID Connect configuration as\n- * is required by any OpenID Connect compatible service:\n- *\n- * https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig\n- *\n- * @param issuerString the issuer that should be used as the discovery root.\n- */\n-export async function discoverOIDCConfiguration(issuerString: string) {\n-  // Parse the issuer.\n-  const issuer = new URL(issuerString);\n-\n-  // Discover the configuration.\n-  return discover(issuer);\n-}\n-\n-interface WebhookEndpointInput {\n-  url: string;\n-  all: boolean;\n-  events: GQLWEBHOOK_EVENT_NAME[];\n-}\n-\n-export function validateWebhookEndpointInput(\n-  config: Config,\n-  input: WebhookEndpointInput\n-) {\n-  // Check to see that this URL is valid and has a https:// scheme if in\n-  // production mode.\n-  const url = new URL(input.url);\n-  if (config.get(\"env\") === \"production\" && url.protocol !== \"https:\") {\n-    throw new Error(`invalid scheme provided in production: ${url.protocol}`);\n-  }\n-\n-  // Ensure that either the \"all\" or \"events\" is provided but not both.\n-  if (input.all && input.events.length > 0) {\n-    throw new Error(\"both all events and specific events were requested\");\n-  }\n-}\n-\n-export async function createWebhookEndpoint(\n-  mongo: Db,\n-  redis: Redis,\n-  config: Config,\n-  cache: TenantCache,\n-  tenant: Tenant,\n-  input: CreateTenantWebhookEndpointInput,\n-  now: Date\n-) {\n-  // Validate the input.\n-  validateWebhookEndpointInput(config, input);\n-\n-  // Looks good in create this, send it off to be created.\n-  const result = await createTenantWebhookEndpoint(\n-    mongo,\n-    tenant.id,\n-    input,\n-    now\n-  );\n-  if (!result.tenant) {\n-    throw new Error(\"could not create the tenant endpoint, tenant not found\");\n-  }\n-\n-  // Update the tenant cache.\n-  await cache.update(redis, result.tenant);\n-\n-  return {\n-    endpoint: result.endpoint,\n-    settings: result.tenant,\n-  };\n-}\n-\n-export async function updateWebhookEndpoint(\n-  mongo: Db,\n-  redis: Redis,\n-  config: Config,\n-  cache: TenantCache,\n-  tenant: Tenant,\n-  endpointID: string,\n-  input: UpdateTenantWebhookEndpointInput\n-) {\n-  // Find the endpoint.\n-  let endpoint = getWebhookEndpoint(tenant, endpointID);\n-  if (!endpoint) {\n-    throw new Error(\"referenced endpoint was not found on tenant\");\n-  }\n-\n-  // Extract the input.\n-  const {\n-    url = endpoint.url,\n-    all = endpoint.all,\n-    events = endpoint.events,\n-  } = input;\n-\n-  // Validate the input.\n-  validateWebhookEndpointInput(config, {\n-    url,\n-    all,\n-    events,\n-  });\n-\n-  const updatedTenant = await updateTenantWebhookEndpoint(\n-    mongo,\n-    tenant.id,\n-    endpointID,\n-    input\n-  );\n-  if (!updatedTenant) {\n-    throw new Error(\"tenant not found\");\n-  }\n-\n-  // Update the tenant cache.\n-  await cache.update(redis, updatedTenant);\n-\n-  // Find the updated endpoint.\n-  endpoint = getWebhookEndpoint(updatedTenant, endpointID);\n-  if (!endpoint) {\n-    throw new Error(\"referenced endpoint was not found on tenant\");\n-  }\n-\n-  return endpoint;\n-}\n-\n-export async function enableWebhookEndpoint(\n-  mongo: Db,\n-  redis: Redis,\n-  cache: TenantCache,\n-  tenant: Tenant,\n-  endpointID: string\n-) {\n-  // Find the endpoint.\n-  let endpoint = getWebhookEndpoint(tenant, endpointID);\n-  if (!endpoint) {\n-    throw new Error(\"referenced endpoint was not found on tenant\");\n-  }\n-\n-  // Endpoint is already enabled.\n-  if (endpoint.enabled === true) {\n-    return endpoint;\n-  }\n-\n-  const updatedTenant = await updateTenantWebhookEndpoint(\n-    mongo,\n-    tenant.id,\n-    endpointID,\n-    { enabled: true }\n-  );\n-  if (!updatedTenant) {\n-    throw new Error(\"tenant not found\");\n-  }\n-\n-  // Update the tenant cache.\n-  await cache.update(redis, updatedTenant);\n-\n-  // Find the updated endpoint.\n-  endpoint = getWebhookEndpoint(updatedTenant, endpointID);\n-  if (!endpoint) {\n-    throw new Error(\"referenced endpoint was not found on tenant\");\n-  }\n-\n-  return endpoint;\n-}\n-\n-export async function disableWebhookEndpoint(\n-  mongo: Db,\n-  redis: Redis,\n-  cache: TenantCache,\n-  tenant: Tenant,\n-  endpointID: string\n-) {\n-  // Find the endpoint.\n-  let endpoint = getWebhookEndpoint(tenant, endpointID);\n-  if (!endpoint) {\n-    throw new Error(\"referenced endpoint was not found on tenant\");\n-  }\n-\n-  // Endpoint is already disabled.\n-  if (endpoint.enabled === false) {\n-    return endpoint;\n-  }\n-\n-  const updatedTenant = await updateTenantWebhookEndpoint(\n-    mongo,\n-    tenant.id,\n-    endpointID,\n-    { enabled: false }\n-  );\n-  if (!updatedTenant) {\n-    throw new Error(\"tenant not found\");\n-  }\n-\n-  // Update the tenant cache.\n-  await cache.update(redis, updatedTenant);\n-\n-  // Find the updated endpoint.\n-  endpoint = getWebhookEndpoint(updatedTenant, endpointID);\n-  if (!endpoint) {\n-    throw new Error(\"referenced endpoint was not found on tenant\");\n-  }\n-\n-  return endpoint;\n-}\n-\n-export async function deleteWebhookEndpoint(\n-  mongo: Db,\n-  redis: Redis,\n-  cache: TenantCache,\n-  tenant: Tenant,\n-  endpointID: string\n-) {\n-  // Find the endpoint.\n-  const endpoint = getWebhookEndpoint(tenant, endpointID);\n-  if (!endpoint) {\n-    throw new Error(\"referenced endpoint was not found on tenant\");\n-  }\n-\n-  const updatedTenant = await deleteTenantWebhookEndpoint(\n-    mongo,\n-    tenant.id,\n-    endpointID\n-  );\n-  if (!updatedTenant) {\n-    throw new Error(\"tenant not found\");\n-  }\n-\n-  // Update the tenant cache.\n-  await cache.update(redis, updatedTenant);\n-\n-  return endpoint;\n-}\n-\n-export async function rotateWebhookEndpointSecret(\n-  mongo: Db,\n-  redis: Redis,\n-  cache: TenantCache,\n-  tenant: Tenant,\n-  endpointID: string,\n-  inactiveIn: number,\n-  now: Date\n-) {\n-  // Compute the inactiveAt dates for the current active secrets.\n-  const inactiveAt = DateTime.fromJSDate(now)\n-    .plus({ seconds: inactiveIn })\n-    .toJSDate();\n-\n-  // Rotate the secrets.\n-  const updatedTenant = await rollTenantWebhookEndpointSecret(\n-    mongo,\n-    tenant.id,\n-    endpointID,\n-    inactiveAt,\n-    now\n-  );\n-  if (!updatedTenant) {\n-    throw new Error(\"tenant not found\");\n-  }\n-\n-  // Update the tenant cache.\n-  await cache.update(redis, updatedTenant);\n-\n-  // Find the updated endpoint.\n-  const endpoint = getWebhookEndpoint(updatedTenant, endpointID);\n-  if (!endpoint) {\n-    throw new Error(\"referenced endpoint was not found on tenant\");\n-  }\n-\n-  return endpoint;\n-}\n-\n-export async function enableFeatureFlag(\n-  mongo: Db,\n-  redis: Redis,\n-  cache: TenantCache,\n-  tenant: Tenant,\n-  flag: GQLFEATURE_FLAG\n-) {\n-  // If the Tenant already has this flag, don't bother adding it again.\n-  if (tenant.featureFlags && tenant.featureFlags.includes(flag)) {\n-    return tenant.featureFlags;\n-  }\n-\n-  // Enable the feature flag.\n-  const updated = await enableTenantFeatureFlag(mongo, tenant.id, flag);\n-  if (!updated || !updated.featureFlags) {\n-    // As we just added the feature flag, we would expect that the Tenant would\n-    // always have the feature flags set to some array.\n-    throw new Error(\"tenant not found\");\n-  }\n-\n-  // Update the tenant cache.\n-  await cache.update(redis, updated);\n-\n-  // Return the updated feature flags.\n-  return updated.featureFlags;\n-}\n-\n-export async function disableFeatureFlag(\n-  mongo: Db,\n-  redis: Redis,\n-  cache: TenantCache,\n-  tenant: Tenant,\n-  flag: GQLFEATURE_FLAG\n-) {\n-  // If the feature flag doesn't exist on the Tenant (or the Tenant has no\n-  // feature flags), don't bother trying to remove it again.\n-  if (!tenant.featureFlags || !tenant.featureFlags.includes(flag)) {\n-    return tenant.featureFlags || [];\n-  }\n-\n-  // Remove the feature flag.\n-  const updated = await disableTenantFeatureFlag(mongo, tenant.id, flag);\n-  if (!updated) {\n-    throw new Error(\"tenant not found\");\n-  }\n-\n-  // Update the tenant cache.\n-  await cache.update(redis, updated);\n-\n-  // Return the updated feature flags (or [] if there was no feature flags to\n-  // begin with).\n-  return updated.featureFlags || [];\n-}\n-\n-export async function createAnnouncement(\n-  mongo: Db,\n-  redis: Redis,\n-  cache: TenantCache,\n-  tenant: Tenant,\n-  input: CreateAnnouncementInput,\n-  now = new Date()\n-) {\n-  const updated = await createTenantAnnouncement(mongo, tenant.id, input);\n-  if (!updated) {\n-    throw new Error(\"tenant not found\");\n-  }\n-  await cache.update(redis, updated);\n-  return updated;\n-}\n-\n-export async function deleteAnnouncement(\n-  mongo: Db,\n-  redis: Redis,\n-  cache: TenantCache,\n-  tenant: Tenant\n-) {\n-  const updated = await deleteTenantAnnouncement(mongo, tenant.id);\n-  if (!updated) {\n-    throw new Error(\"tenant not found\");\n-  }\n-  await cache.update(redis, updated);\n-  return updated;\n-}\n+export * from \"./tenant\";\n+export * from \"./sso\";"
    },
    {
      "sha": "9bc9a25a856640c3f1e1831c47cb18bde94036d6",
      "filename": "src/core/server/services/tenant/sso.ts",
      "status": "added",
      "additions": 133,
      "deletions": 0,
      "changes": 133,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/services/tenant/sso.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/services/tenant/sso.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/tenant/sso.ts?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -0,0 +1,133 @@\n+import { Redis } from \"ioredis\";\n+import { DateTime } from \"luxon\";\n+import { Db } from \"mongodb\";\n+\n+import {\n+  createTenantSSOKey,\n+  deactivateTenantSSOKey,\n+  deleteLastUsedAtTenantSSOKey,\n+  deleteTenantSSOKey,\n+  Tenant,\n+} from \"coral-server/models/tenant\";\n+\n+import TenantCache from \"./cache\";\n+\n+/**\n+ * regenerateSSOKey will regenerate the Single Sign-On key for the specified\n+ * Tenant and notify all other Tenant's connected that the Tenant was updated.\n+ */\n+export async function regenerateSSOKey(\n+  mongo: Db,\n+  redis: Redis,\n+  cache: TenantCache,\n+  tenant: Tenant,\n+  now: Date\n+) {\n+  // Regeneration is the same as rotating but with a specific 30 day window.\n+  return rotateSSOKey(mongo, redis, cache, tenant, 30 * 24 * 60 * 60, now);\n+}\n+\n+export async function rotateSSOKey(\n+  mongo: Db,\n+  redis: Redis,\n+  cache: TenantCache,\n+  tenant: Tenant,\n+  inactiveIn: number,\n+  now: Date\n+) {\n+  // Deprecate the old Tenant SSO key if it exists.\n+  if (tenant.auth.integrations.sso.keys.length > 0) {\n+    // Get the old keys that are not deprecated.\n+    const keysToDeprecate = tenant.auth.integrations.sso.keys.filter(key => {\n+      return !key.rotatedAt;\n+    });\n+\n+    // Check to see if there are keys to deprecate.\n+    if (keysToDeprecate.length > 0) {\n+      const deprecateAt = DateTime.fromJSDate(now)\n+        .plus({ seconds: inactiveIn })\n+        .toJSDate();\n+\n+      // Deprecate all the keys that are associated on the tenant that haven't\n+      // been done.\n+      for (const key of keysToDeprecate) {\n+        await deactivateTenantSSOKey(\n+          mongo,\n+          tenant.id,\n+          key.kid,\n+          deprecateAt,\n+          now\n+        );\n+      }\n+    }\n+  }\n+\n+  // Create the new SSOKey.\n+  const updatedTenant = await createTenantSSOKey(mongo, tenant.id, now);\n+  if (!updatedTenant) {\n+    return null;\n+  }\n+\n+  // Update the tenant cache.\n+  await cache.update(redis, updatedTenant);\n+\n+  return updatedTenant;\n+}\n+\n+export async function deactivateSSOKey(\n+  mongo: Db,\n+  redis: Redis,\n+  cache: TenantCache,\n+  tenant: Tenant,\n+  kid: string,\n+  now: Date\n+) {\n+  const key = tenant.auth.integrations.sso.keys.find(k => k.kid === kid);\n+  if (!key) {\n+    throw new Error(\"specified kid not found on tenant\");\n+  }\n+\n+  // Deactivate the sso key now.\n+  const updatedTenant = await deactivateTenantSSOKey(\n+    mongo,\n+    tenant.id,\n+    kid,\n+    now,\n+    now\n+  );\n+  if (!updatedTenant) {\n+    return null;\n+  }\n+\n+  // Update the tenant cache.\n+  await cache.update(redis, updatedTenant);\n+\n+  return updatedTenant;\n+}\n+\n+export async function deleteSSOKey(\n+  mongo: Db,\n+  redis: Redis,\n+  cache: TenantCache,\n+  tenant: Tenant,\n+  kid: string\n+) {\n+  const key = tenant.auth.integrations.sso.keys.find(k => k.kid === kid);\n+  if (!key) {\n+    throw new Error(\"specified kid not found on tenant\");\n+  }\n+\n+  // Deactivate the sso key now.\n+  const updatedTenant = await deleteTenantSSOKey(mongo, tenant.id, kid);\n+  if (!updatedTenant) {\n+    return null;\n+  }\n+\n+  // Remove the last used date entry from the Redis hash.\n+  await deleteLastUsedAtTenantSSOKey(redis, tenant.id, kid);\n+\n+  // Update the tenant cache.\n+  await cache.update(redis, updatedTenant);\n+\n+  return updatedTenant;\n+}"
    },
    {
      "sha": "1d806540a630475b51e90b3a1e6e9b4825487842",
      "filename": "src/core/server/services/tenant/tenant.ts",
      "status": "added",
      "additions": 500,
      "deletions": 0,
      "changes": 500,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/services/tenant/tenant.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/core/server/services/tenant/tenant.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/services/tenant/tenant.ts?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -0,0 +1,500 @@\n+import { Redis } from \"ioredis\";\n+import { isUndefined, lowerCase, uniqBy } from \"lodash\";\n+import { DateTime } from \"luxon\";\n+import { Db } from \"mongodb\";\n+import { URL } from \"url\";\n+\n+import { discover } from \"coral-server/app/middleware/passport/strategies/oidc/discover\";\n+import { Config } from \"coral-server/config\";\n+import { TenantInstalledAlreadyError } from \"coral-server/errors\";\n+import logger from \"coral-server/logger\";\n+import {\n+  CreateAnnouncementInput,\n+  createTenant,\n+  createTenantAnnouncement,\n+  CreateTenantInput,\n+  createTenantWebhookEndpoint,\n+  CreateTenantWebhookEndpointInput,\n+  deleteTenantAnnouncement,\n+  deleteTenantWebhookEndpoint,\n+  disableTenantFeatureFlag,\n+  enableTenantFeatureFlag,\n+  getWebhookEndpoint,\n+  rollTenantWebhookEndpointSecret,\n+  Tenant,\n+  updateTenant,\n+  updateTenantWebhookEndpoint,\n+  UpdateTenantWebhookEndpointInput,\n+} from \"coral-server/models/tenant\";\n+import { I18n } from \"coral-server/services/i18n\";\n+\n+import {\n+  GQLFEATURE_FLAG,\n+  GQLSettingsInput,\n+  GQLSettingsWordListInput,\n+  GQLWEBHOOK_EVENT_NAME,\n+} from \"coral-server/graph/schema/__generated__/types\";\n+\n+import TenantCache from \"./cache\";\n+\n+export type UpdateTenant = GQLSettingsInput;\n+\n+function cleanWordList(\n+  list: GQLSettingsWordListInput\n+): GQLSettingsWordListInput {\n+  if (list.banned) {\n+    list.banned = uniqBy(list.banned.filter(Boolean), lowerCase) as string[];\n+  }\n+\n+  if (list.suspect) {\n+    list.suspect = uniqBy(list.suspect.filter(Boolean), lowerCase) as string[];\n+  }\n+\n+  return list;\n+}\n+\n+export async function update(\n+  mongo: Db,\n+  redis: Redis,\n+  cache: TenantCache,\n+  config: Config,\n+  tenant: Tenant,\n+  input: UpdateTenant\n+): Promise<Tenant | null> {\n+  // If the environment variable for disabling live updates is provided, then\n+  // ensure we don't permit changes to the database model.\n+  if (\n+    config.get(\"disable_live_updates\") &&\n+    input.live &&\n+    !isUndefined(input.live.enabled)\n+  ) {\n+    delete input.live.enabled;\n+  }\n+\n+  // If the word list was specified, we should validate it to ensure there isn't\n+  // any empty spaces.\n+  if (input.wordList) {\n+    input.wordList = cleanWordList(input.wordList);\n+  }\n+\n+  const updatedTenant = await updateTenant(mongo, tenant.id, input);\n+  if (!updatedTenant) {\n+    return null;\n+  }\n+\n+  // Update the tenant cache.\n+  await cache.update(redis, updatedTenant);\n+\n+  return updatedTenant;\n+}\n+\n+/**\n+ * isInstalled will return a promise that if true, indicates that a Tenant has\n+ * been installed.\n+ */\n+export async function isInstalled(cache: TenantCache, domain?: string) {\n+  const count = await cache.count();\n+  if (count === 0) {\n+    return false;\n+  }\n+\n+  if (domain) {\n+    const tenant = await cache.retrieveByDomain(domain);\n+    if (tenant) {\n+      return true;\n+    }\n+\n+    return false;\n+  }\n+\n+  return true;\n+}\n+\n+export type InstallTenant = CreateTenantInput;\n+\n+export async function install(\n+  mongo: Db,\n+  redis: Redis,\n+  cache: TenantCache,\n+  i18n: I18n,\n+  input: InstallTenant,\n+  now = new Date()\n+) {\n+  // Ensure that this Tenant isn't being installed onto a domain that already\n+  // exists.\n+  if (await isInstalled(cache, input.domain)) {\n+    throw new TenantInstalledAlreadyError();\n+  }\n+\n+  logger.info(\"installing tenant\");\n+\n+  // Create the Tenant.\n+  const tenant = await createTenant(mongo, i18n, input, now);\n+\n+  // Update the tenant cache.\n+  await cache.update(redis, tenant);\n+\n+  logger.info({ tenantID: tenant.id }, \"a tenant has been installed\");\n+\n+  return tenant;\n+}\n+\n+/**\n+ * canInstall will return a promise that determines if a given install can\n+ * proceed.\n+ */\n+export async function canInstall(cache: TenantCache) {\n+  return (await cache.count()) === 0;\n+}\n+\n+/**\n+ * discoverOIDCConfiguration will discover the OpenID Connect configuration as\n+ * is required by any OpenID Connect compatible service:\n+ *\n+ * https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig\n+ *\n+ * @param issuerString the issuer that should be used as the discovery root.\n+ */\n+export async function discoverOIDCConfiguration(issuerString: string) {\n+  // Parse the issuer.\n+  const issuer = new URL(issuerString);\n+\n+  // Discover the configuration.\n+  return discover(issuer);\n+}\n+\n+interface WebhookEndpointInput {\n+  url: string;\n+  all: boolean;\n+  events: GQLWEBHOOK_EVENT_NAME[];\n+}\n+\n+export function validateWebhookEndpointInput(\n+  config: Config,\n+  input: WebhookEndpointInput\n+) {\n+  // Check to see that this URL is valid and has a https:// scheme if in\n+  // production mode.\n+  const url = new URL(input.url);\n+  if (config.get(\"env\") === \"production\" && url.protocol !== \"https:\") {\n+    throw new Error(`invalid scheme provided in production: ${url.protocol}`);\n+  }\n+\n+  // Ensure that either the \"all\" or \"events\" is provided but not both.\n+  if (input.all && input.events.length > 0) {\n+    throw new Error(\"both all events and specific events were requested\");\n+  }\n+}\n+\n+export async function createWebhookEndpoint(\n+  mongo: Db,\n+  redis: Redis,\n+  config: Config,\n+  cache: TenantCache,\n+  tenant: Tenant,\n+  input: CreateTenantWebhookEndpointInput,\n+  now: Date\n+) {\n+  // Validate the input.\n+  validateWebhookEndpointInput(config, input);\n+\n+  // Looks good in create this, send it off to be created.\n+  const result = await createTenantWebhookEndpoint(\n+    mongo,\n+    tenant.id,\n+    input,\n+    now\n+  );\n+  if (!result.tenant) {\n+    throw new Error(\"could not create the tenant endpoint, tenant not found\");\n+  }\n+\n+  // Update the tenant cache.\n+  await cache.update(redis, result.tenant);\n+\n+  return {\n+    endpoint: result.endpoint,\n+    settings: result.tenant,\n+  };\n+}\n+\n+export async function updateWebhookEndpoint(\n+  mongo: Db,\n+  redis: Redis,\n+  config: Config,\n+  cache: TenantCache,\n+  tenant: Tenant,\n+  endpointID: string,\n+  input: UpdateTenantWebhookEndpointInput\n+) {\n+  // Find the endpoint.\n+  let endpoint = getWebhookEndpoint(tenant, endpointID);\n+  if (!endpoint) {\n+    throw new Error(\"referenced endpoint was not found on tenant\");\n+  }\n+\n+  // Extract the input.\n+  const {\n+    url = endpoint.url,\n+    all = endpoint.all,\n+    events = endpoint.events,\n+  } = input;\n+\n+  // Validate the input.\n+  validateWebhookEndpointInput(config, {\n+    url,\n+    all,\n+    events,\n+  });\n+\n+  const updatedTenant = await updateTenantWebhookEndpoint(\n+    mongo,\n+    tenant.id,\n+    endpointID,\n+    input\n+  );\n+  if (!updatedTenant) {\n+    throw new Error(\"tenant not found\");\n+  }\n+\n+  // Update the tenant cache.\n+  await cache.update(redis, updatedTenant);\n+\n+  // Find the updated endpoint.\n+  endpoint = getWebhookEndpoint(updatedTenant, endpointID);\n+  if (!endpoint) {\n+    throw new Error(\"referenced endpoint was not found on tenant\");\n+  }\n+\n+  return endpoint;\n+}\n+\n+export async function enableWebhookEndpoint(\n+  mongo: Db,\n+  redis: Redis,\n+  cache: TenantCache,\n+  tenant: Tenant,\n+  endpointID: string\n+) {\n+  // Find the endpoint.\n+  let endpoint = getWebhookEndpoint(tenant, endpointID);\n+  if (!endpoint) {\n+    throw new Error(\"referenced endpoint was not found on tenant\");\n+  }\n+\n+  // Endpoint is already enabled.\n+  if (endpoint.enabled === true) {\n+    return endpoint;\n+  }\n+\n+  const updatedTenant = await updateTenantWebhookEndpoint(\n+    mongo,\n+    tenant.id,\n+    endpointID,\n+    { enabled: true }\n+  );\n+  if (!updatedTenant) {\n+    throw new Error(\"tenant not found\");\n+  }\n+\n+  // Update the tenant cache.\n+  await cache.update(redis, updatedTenant);\n+\n+  // Find the updated endpoint.\n+  endpoint = getWebhookEndpoint(updatedTenant, endpointID);\n+  if (!endpoint) {\n+    throw new Error(\"referenced endpoint was not found on tenant\");\n+  }\n+\n+  return endpoint;\n+}\n+\n+export async function disableWebhookEndpoint(\n+  mongo: Db,\n+  redis: Redis,\n+  cache: TenantCache,\n+  tenant: Tenant,\n+  endpointID: string\n+) {\n+  // Find the endpoint.\n+  let endpoint = getWebhookEndpoint(tenant, endpointID);\n+  if (!endpoint) {\n+    throw new Error(\"referenced endpoint was not found on tenant\");\n+  }\n+\n+  // Endpoint is already disabled.\n+  if (endpoint.enabled === false) {\n+    return endpoint;\n+  }\n+\n+  const updatedTenant = await updateTenantWebhookEndpoint(\n+    mongo,\n+    tenant.id,\n+    endpointID,\n+    { enabled: false }\n+  );\n+  if (!updatedTenant) {\n+    throw new Error(\"tenant not found\");\n+  }\n+\n+  // Update the tenant cache.\n+  await cache.update(redis, updatedTenant);\n+\n+  // Find the updated endpoint.\n+  endpoint = getWebhookEndpoint(updatedTenant, endpointID);\n+  if (!endpoint) {\n+    throw new Error(\"referenced endpoint was not found on tenant\");\n+  }\n+\n+  return endpoint;\n+}\n+\n+export async function deleteWebhookEndpoint(\n+  mongo: Db,\n+  redis: Redis,\n+  cache: TenantCache,\n+  tenant: Tenant,\n+  endpointID: string\n+) {\n+  // Find the endpoint.\n+  const endpoint = getWebhookEndpoint(tenant, endpointID);\n+  if (!endpoint) {\n+    throw new Error(\"referenced endpoint was not found on tenant\");\n+  }\n+\n+  const updatedTenant = await deleteTenantWebhookEndpoint(\n+    mongo,\n+    tenant.id,\n+    endpointID\n+  );\n+  if (!updatedTenant) {\n+    throw new Error(\"tenant not found\");\n+  }\n+\n+  // Update the tenant cache.\n+  await cache.update(redis, updatedTenant);\n+\n+  return endpoint;\n+}\n+\n+export async function rotateWebhookEndpointSecret(\n+  mongo: Db,\n+  redis: Redis,\n+  cache: TenantCache,\n+  tenant: Tenant,\n+  endpointID: string,\n+  inactiveIn: number,\n+  now: Date\n+) {\n+  // Compute the inactiveAt dates for the current active secrets.\n+  const inactiveAt = DateTime.fromJSDate(now)\n+    .plus({ seconds: inactiveIn })\n+    .toJSDate();\n+\n+  // Rotate the secrets.\n+  const updatedTenant = await rollTenantWebhookEndpointSecret(\n+    mongo,\n+    tenant.id,\n+    endpointID,\n+    inactiveAt,\n+    now\n+  );\n+  if (!updatedTenant) {\n+    throw new Error(\"tenant not found\");\n+  }\n+\n+  // Update the tenant cache.\n+  await cache.update(redis, updatedTenant);\n+\n+  // Find the updated endpoint.\n+  const endpoint = getWebhookEndpoint(updatedTenant, endpointID);\n+  if (!endpoint) {\n+    throw new Error(\"referenced endpoint was not found on tenant\");\n+  }\n+\n+  return endpoint;\n+}\n+\n+export async function enableFeatureFlag(\n+  mongo: Db,\n+  redis: Redis,\n+  cache: TenantCache,\n+  tenant: Tenant,\n+  flag: GQLFEATURE_FLAG\n+) {\n+  // If the Tenant already has this flag, don't bother adding it again.\n+  if (tenant.featureFlags && tenant.featureFlags.includes(flag)) {\n+    return tenant.featureFlags;\n+  }\n+\n+  // Enable the feature flag.\n+  const updated = await enableTenantFeatureFlag(mongo, tenant.id, flag);\n+  if (!updated || !updated.featureFlags) {\n+    // As we just added the feature flag, we would expect that the Tenant would\n+    // always have the feature flags set to some array.\n+    throw new Error(\"tenant not found\");\n+  }\n+\n+  // Update the tenant cache.\n+  await cache.update(redis, updated);\n+\n+  // Return the updated feature flags.\n+  return updated.featureFlags;\n+}\n+\n+export async function disableFeatureFlag(\n+  mongo: Db,\n+  redis: Redis,\n+  cache: TenantCache,\n+  tenant: Tenant,\n+  flag: GQLFEATURE_FLAG\n+) {\n+  // If the feature flag doesn't exist on the Tenant (or the Tenant has no\n+  // feature flags), don't bother trying to remove it again.\n+  if (!tenant.featureFlags || !tenant.featureFlags.includes(flag)) {\n+    return tenant.featureFlags || [];\n+  }\n+\n+  // Remove the feature flag.\n+  const updated = await disableTenantFeatureFlag(mongo, tenant.id, flag);\n+  if (!updated) {\n+    throw new Error(\"tenant not found\");\n+  }\n+\n+  // Update the tenant cache.\n+  await cache.update(redis, updated);\n+\n+  // Return the updated feature flags (or [] if there was no feature flags to\n+  // begin with).\n+  return updated.featureFlags || [];\n+}\n+\n+export async function createAnnouncement(\n+  mongo: Db,\n+  redis: Redis,\n+  cache: TenantCache,\n+  tenant: Tenant,\n+  input: CreateAnnouncementInput,\n+  now = new Date()\n+) {\n+  const updated = await createTenantAnnouncement(mongo, tenant.id, input, now);\n+  if (!updated) {\n+    throw new Error(\"tenant not found\");\n+  }\n+  await cache.update(redis, updated);\n+  return updated;\n+}\n+\n+export async function deleteAnnouncement(\n+  mongo: Db,\n+  redis: Redis,\n+  cache: TenantCache,\n+  tenant: Tenant\n+) {\n+  const updated = await deleteTenantAnnouncement(mongo, tenant.id);\n+  if (!updated) {\n+    throw new Error(\"tenant not found\");\n+  }\n+  await cache.update(redis, updated);\n+  return updated;\n+}"
    },
    {
      "sha": "36a53526d1507f6fa9865253b095be9a2d0d452c",
      "filename": "src/locales/en-US/admin.ftl",
      "status": "modified",
      "additions": 45,
      "deletions": 0,
      "changes": 45,
      "blob_url": "https://github.com/coralproject/talk/blob/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/locales/en-US/admin.ftl",
      "raw_url": "https://github.com/coralproject/talk/raw/8fd266deeb4c8ec0016bc05a80c567be4929d76f/src/locales/en-US/admin.ftl",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/locales/en-US/admin.ftl?ref=8fd266deeb4c8ec0016bc05a80c567be4929d76f",
      "patch": "@@ -427,6 +427,51 @@ configure-auth-sso-regenerateAt = KEY GENERATED AT:\n configure-auth-sso-regenerateHonoredWarning =\n   When regenerating a key, tokens signed with the previous key will be honored for 30 days.\n \n+configure-auth-sso-description =\n+  To enable integration with your existing authentication system,\n+  you will need to create a JWT Token to connect. You can learn\n+  more about creating a JWT Token with <IntroLink>this introduction</IntroLink>. See our\n+  <DocLink>documentation</DocLink> for additional information on single sign on.\n+\n+configure-auth-sso-rotate-keys = Keys\n+configure-auth-sso-rotate-keyID = Key ID\n+configure-auth-sso-rotate-secret = Secret\n+configure-auth-sso-rotate-copySecret =\n+  .aria-label = Copy Secret\n+\n+configure-auth-sso-rotate-date =\n+  { DATETIME($date, year: \"numeric\", month: \"numeric\", day: \"numeric\", hour: \"numeric\", minute: \"numeric\") }\n+configure-auth-sso-rotate-activeSince = Active Since\n+configure-auth-sso-rotate-inactiveAt = Inactive At\n+configure-auth-sso-rotate-inactiveSince = Inactive Since\n+\n+configure-auth-sso-rotate-status = Status\n+configure-auth-sso-rotate-statusActive = Active\n+configure-auth-sso-rotate-statusExpiring = Expiring\n+configure-auth-sso-rotate-statusExpired = Expired\n+configure-auth-sso-rotate-statusUnknown = Unknown\n+\n+configure-auth-sso-rotate-expiringTooltip =\n+  An SSO key is expiring when it is scheduled for rotation.\n+configure-auth-sso-rotate-expiringTooltip-toggleButton =\n+  .aria-label = Toggle expiring tooltip visibility\n+configure-auth-sso-rotate-expiredTooltip =\n+  An SSO key is expired when it has been rotated out of use.\n+configure-auth-sso-rotate-expiredTooltip-toggleButton =\n+  Toggle expired tooltip visibility\n+\n+configure-auth-sso-rotate-rotate = Rotate\n+configure-auth-sso-rotate-deactivateNow = Deactivate Now\n+configure-auth-sso-rotate-delete = Delete\n+\n+configure-auth-sso-rotate-now = Now\n+configure-auth-sso-rotate-10seconds = 10 seconds from now\n+configure-auth-sso-rotate-1day = 1 day from now\n+configure-auth-sso-rotate-1week = 1 week from now\n+configure-auth-sso-rotate-30days = 30 days from now\n+configure-auth-sso-rotate-dropdown-description =\n+  .description = A dropdown to rotate the SSO key\n+\n configure-auth-local-loginWith = Login with email authentication\n configure-auth-local-useLoginOn = Use email authentication login on\n "
    }
  ]
}
