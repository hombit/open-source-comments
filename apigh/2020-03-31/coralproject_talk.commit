{
  "sha": "94ece10284b3a8bfea24c6c409437f5848352eaf",
  "node_id": "MDY6Q29tbWl0NzI0NTQyNDI6OTRlY2UxMDI4NGIzYThiZmVhMjRjNmM0MDk0MzdmNTg0ODM1MmVhZg==",
  "commit": {
    "author": {
      "name": "Wyatt Johnson",
      "email": "wyattjoh@gmail.com",
      "date": "2020-03-30T20:35:18Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2020-03-30T20:35:18Z"
    },
    "message": "[CORL-996] Force SSL Configuration (#2917)\n\n* fix: added new FORCE_SSL config, reverted production SSL handling\r\n\r\n* fix: added another test to handle purify testing",
    "tree": {
      "sha": "9141ae2a6c34bd6bc00986f402854a217259167c",
      "url": "https://api.github.com/repos/coralproject/talk/git/trees/9141ae2a6c34bd6bc00986f402854a217259167c"
    },
    "url": "https://api.github.com/repos/coralproject/talk/git/commits/94ece10284b3a8bfea24c6c409437f5848352eaf",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeglgHCRBK7hj4Ov3rIwAAdHIIABsXCN/zDNrBzh9YGvXHCoVL\ntrsUTA9zletvyBUNqt+17HQUjs5aCR/4LsZFWk7in1kLL1MlP0qPynEmym9IRDzp\necVDIkHN2h+K4thpIWfjU7kY/Nld2fSaDU2ReDDOL4qWTZotLbmn4QxgLfNHGEKc\n3SBh/0S/9elmseermYyUBZMpWmMQIJM+ZT4gUGVamJUk89YLHrXF7hRi2/GM1e0E\nvcSxk0XjQqwlb08hGpQEB5NmmbezuyJVj6iWsOObY8g3+G9WYk+m/XumaAz6U6l8\noxbyGagUCJ5zJfyJOj7WsyhwpNe43kqRROd3PuO5q8cKpMUoWKG4gcc2Td/6SZg=\n=+6ns\n-----END PGP SIGNATURE-----\n",
      "payload": "tree 9141ae2a6c34bd6bc00986f402854a217259167c\nparent ef01f427de29848c7a31d9b0f3e48ae2ed022af5\nauthor Wyatt Johnson <wyattjoh@gmail.com> 1585600518 +0000\ncommitter GitHub <noreply@github.com> 1585600518 +0000\n\n[CORL-996] Force SSL Configuration (#2917)\n\n* fix: added new FORCE_SSL config, reverted production SSL handling\r\n\r\n* fix: added another test to handle purify testing"
    }
  },
  "url": "https://api.github.com/repos/coralproject/talk/commits/94ece10284b3a8bfea24c6c409437f5848352eaf",
  "html_url": "https://github.com/coralproject/talk/commit/94ece10284b3a8bfea24c6c409437f5848352eaf",
  "comments_url": "https://api.github.com/repos/coralproject/talk/commits/94ece10284b3a8bfea24c6c409437f5848352eaf/comments",
  "author": {
    "login": "wyattjoh",
    "id": 633002,
    "node_id": "MDQ6VXNlcjYzMzAwMg==",
    "avatar_url": "https://avatars2.githubusercontent.com/u/633002?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wyattjoh",
    "html_url": "https://github.com/wyattjoh",
    "followers_url": "https://api.github.com/users/wyattjoh/followers",
    "following_url": "https://api.github.com/users/wyattjoh/following{/other_user}",
    "gists_url": "https://api.github.com/users/wyattjoh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wyattjoh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wyattjoh/subscriptions",
    "organizations_url": "https://api.github.com/users/wyattjoh/orgs",
    "repos_url": "https://api.github.com/users/wyattjoh/repos",
    "events_url": "https://api.github.com/users/wyattjoh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wyattjoh/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "ef01f427de29848c7a31d9b0f3e48ae2ed022af5",
      "url": "https://api.github.com/repos/coralproject/talk/commits/ef01f427de29848c7a31d9b0f3e48ae2ed022af5",
      "html_url": "https://github.com/coralproject/talk/commit/ef01f427de29848c7a31d9b0f3e48ae2ed022af5"
    }
  ],
  "stats": {
    "total": 42,
    "additions": 32,
    "deletions": 10
  },
  "files": [
    {
      "sha": "88426454b8810a24275ad2697d2f4a58dcdcb7e4",
      "filename": "src/core/common/utils/__snapshots__/purify.spec.ts.snap",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/coralproject/talk/blob/94ece10284b3a8bfea24c6c409437f5848352eaf/src/core/common/utils/__snapshots__/purify.spec.ts.snap",
      "raw_url": "https://github.com/coralproject/talk/raw/94ece10284b3a8bfea24c6c409437f5848352eaf/src/core/common/utils/__snapshots__/purify.spec.ts.snap",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/common/utils/__snapshots__/purify.spec.ts.snap?ref=94ece10284b3a8bfea24c6c409437f5848352eaf",
      "patch": "@@ -16,6 +16,13 @@ exports[`allows anchor tags and counts them correctly 1`] = `\n   \"\n `;\n \n+exports[`allows mailto links 1`] = `\n+Object {\n+  \"body\": \"<a href=\\\\\"mailto:email@example.com\\\\\" target=\\\\\"_blank\\\\\" rel=\\\\\"noopener noreferrer\\\\\">email@example.com</a>\",\n+  \"linkCount\": 1,\n+}\n+`;\n+\n exports[`sanitizes out attributes not allowed 1`] = `\n Object {\n   \"body\": \"<div>Test</div>\","
    },
    {
      "sha": "f8978da81573284b31c3d3aa51ad0915d11a558c",
      "filename": "src/core/common/utils/purify.spec.ts",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/coralproject/talk/blob/94ece10284b3a8bfea24c6c409437f5848352eaf/src/core/common/utils/purify.spec.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/94ece10284b3a8bfea24c6c409437f5848352eaf/src/core/common/utils/purify.spec.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/common/utils/purify.spec.ts?ref=94ece10284b3a8bfea24c6c409437f5848352eaf",
      "patch": "@@ -33,6 +33,15 @@ it(\"allows anchor links\", () => {\n   ).toMatchSnapshot();\n });\n \n+it(\"allows mailto links\", () => {\n+  expect(\n+    sanitizeCommentBody(\n+      DOMPurify,\n+      '<a href=\"mailto:email@example.com\">email@example.com</a>'\n+    )\n+  ).toMatchSnapshot();\n+});\n+\n it(\"allows anchor tags and counts them correctly\", () => {\n   const { body, linkCount } = sanitizeCommentBody(\n     DOMPurify,"
    },
    {
      "sha": "12373dd6108f94422d7a6baf08a7cc98e866b94f",
      "filename": "src/core/server/app/index.ts",
      "status": "modified",
      "additions": 12,
      "deletions": 6,
      "changes": 18,
      "blob_url": "https://github.com/coralproject/talk/blob/94ece10284b3a8bfea24c6c409437f5848352eaf/src/core/server/app/index.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/94ece10284b3a8bfea24c6c409437f5848352eaf/src/core/server/app/index.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/app/index.ts?ref=94ece10284b3a8bfea24c6c409437f5848352eaf",
      "patch": "@@ -147,22 +147,28 @@ function configureApplication(options: AppOptions) {\n function configureApplicationHTTPS(options: AppOptions) {\n   const { parent, config } = options;\n \n+  const log = logger.child(\n+    { env: config.get(\"env\"), forceSSL: config.get(\"force_ssl\") },\n+    true\n+  );\n+\n   // If we're in production mode, configure some production security settings.\n   if (config.get(\"env\") === \"production\") {\n-    if (config.get(\"disable_force_ssl\")) {\n-      logger.warn(\n-        \"SSL enforcement has been disabled in production, this should not be used except for testing\"\n-      );\n-    } else {\n+    if (config.get(\"force_ssl\")) {\n       // Coral in production requires SSL, so we'll send the HSTS headers here as\n       // well as force the use of HTTPS with a 301 redirect.\n       parent.use(\n         hsts({\n-          // We don't want to break existing other services that run with SSL.\n+          // We don't want to break existing other services that don't run with\n+          // SSL.\n           includeSubDomains: false,\n         })\n       );\n       parent.use(enforceHTTPSMiddleware());\n+    } else {\n+      log.warn(\n+        \"FORCE_SSL=true should be set when a SSL terminating proxy has been configured\"\n+      );\n     }\n   }\n }"
    },
    {
      "sha": "20ab8155e809943dd317fdc9f7d4a9e1671638a7",
      "filename": "src/core/server/config.ts",
      "status": "modified",
      "additions": 4,
      "deletions": 4,
      "changes": 8,
      "blob_url": "https://github.com/coralproject/talk/blob/94ece10284b3a8bfea24c6c409437f5848352eaf/src/core/server/config.ts",
      "raw_url": "https://github.com/coralproject/talk/raw/94ece10284b3a8bfea24c6c409437f5848352eaf/src/core/server/config.ts",
      "contents_url": "https://api.github.com/repos/coralproject/talk/contents/src/core/server/config.ts?ref=94ece10284b3a8bfea24c6c409437f5848352eaf",
      "patch": "@@ -269,13 +269,13 @@ const config = convict({\n     env: \"PERSPECTIVE_TIMEOUT\",\n     arg: \"perspectiveTimeout\",\n   },\n-  disable_force_ssl: {\n+  force_ssl: {\n     doc:\n-      \"Disables forcing SSL in production environments. Should not be used except for testing.\",\n+      \"Forces SSL in production by redirecting all HTTP requests to HTTPS, and sending HSTS headers.\",\n     format: Boolean,\n     default: false,\n-    env: \"DISABLE_FORCE_SSL\",\n-    arg: \"disableForceSSL\",\n+    env: \"FORCE_SSL\",\n+    arg: \"forceSSL\",\n   },\n });\n "
    }
  ]
}
