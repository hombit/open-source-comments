{
  "sha": "f70eaf315ab0d9fc7cab244492d27fd5c95c62e8",
  "node_id": "MDY6Q29tbWl0NjI2ODQxOTpmNzBlYWYzMTVhYjBkOWZjN2NhYjI0NDQ5MmQyN2ZkNWM5NWM2MmU4",
  "commit": {
    "author": {
      "name": "Lucas Cimon",
      "email": "lucas.cimon@gmail.com",
      "date": "2020-04-16T18:28:50Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2020-04-16T18:28:50Z"
    },
    "message": "Using .access_route instead of .remote_addr to take into account HTTP_X_FORWARDED_FOR header (#636)",
    "tree": {
      "sha": "aee5bbd7d7395d1474b98abc47561ab559084f51",
      "url": "https://api.github.com/repos/posativ/isso/git/trees/aee5bbd7d7395d1474b98abc47561ab559084f51"
    },
    "url": "https://api.github.com/repos/posativ/isso/git/commits/f70eaf315ab0d9fc7cab244492d27fd5c95c62e8",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJemKPiCRBK7hj4Ov3rIwAAdHIIAKSNnUFFF4csb1uyGyl986TM\nq3bwAR+ZlJ+iZ5PBUI0mReBNGyyf18S6IIh5xTJCw6UIfx1LV77nB3x3JdDpHAUe\nkTkcXINY9yGjqfk+QmHxzJ0/BpKBAVGj/Ryx6QJjzEf2XOHO6TGK4LUq8oz1nkrs\nOfEFkLZhzpjgc4byX+iNoyMNFsbI/N1HZ+ItRMuMNYTfeXzUmfmfTqf2uSSRXDfJ\niAW5sY48m3Wz+I602jFOjMvx7JckFd/MbJ/fgFNbtyNFZ7mnr/SxYvex9oFCLV8b\nYCYDyLYDXZMWl0UfE2yhib+sVoQrHoZy+cVYNn1ehH7D+QKbN8Er5ipWX0votoA=\n=4INg\n-----END PGP SIGNATURE-----\n",
      "payload": "tree aee5bbd7d7395d1474b98abc47561ab559084f51\nparent 04d138dc77f19a79d34d17245efca1cf6c954ac4\nauthor Lucas Cimon <lucas.cimon@gmail.com> 1587061730 +0200\ncommitter GitHub <noreply@github.com> 1587061730 +0000\n\nUsing .access_route instead of .remote_addr to take into account HTTP_X_FORWARDED_FOR header (#636)\n\n"
    }
  },
  "url": "https://api.github.com/repos/posativ/isso/commits/f70eaf315ab0d9fc7cab244492d27fd5c95c62e8",
  "html_url": "https://github.com/posativ/isso/commit/f70eaf315ab0d9fc7cab244492d27fd5c95c62e8",
  "comments_url": "https://api.github.com/repos/posativ/isso/commits/f70eaf315ab0d9fc7cab244492d27fd5c95c62e8/comments",
  "author": {
    "login": "Lucas-C",
    "id": 925560,
    "node_id": "MDQ6VXNlcjkyNTU2MA==",
    "avatar_url": "https://avatars1.githubusercontent.com/u/925560?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Lucas-C",
    "html_url": "https://github.com/Lucas-C",
    "followers_url": "https://api.github.com/users/Lucas-C/followers",
    "following_url": "https://api.github.com/users/Lucas-C/following{/other_user}",
    "gists_url": "https://api.github.com/users/Lucas-C/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Lucas-C/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Lucas-C/subscriptions",
    "organizations_url": "https://api.github.com/users/Lucas-C/orgs",
    "repos_url": "https://api.github.com/users/Lucas-C/repos",
    "events_url": "https://api.github.com/users/Lucas-C/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Lucas-C/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "04d138dc77f19a79d34d17245efca1cf6c954ac4",
      "url": "https://api.github.com/repos/posativ/isso/commits/04d138dc77f19a79d34d17245efca1cf6c954ac4",
      "html_url": "https://github.com/posativ/isso/commit/04d138dc77f19a79d34d17245efca1cf6c954ac4"
    }
  ],
  "stats": {
    "total": 42,
    "additions": 37,
    "deletions": 5
  },
  "files": [
    {
      "sha": "db1602e5520bb8dbfb922f2b6220efa715b004b4",
      "filename": "CONTRIBUTORS.txt",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/posativ/isso/blob/f70eaf315ab0d9fc7cab244492d27fd5c95c62e8/CONTRIBUTORS.txt",
      "raw_url": "https://github.com/posativ/isso/raw/f70eaf315ab0d9fc7cab244492d27fd5c95c62e8/CONTRIBUTORS.txt",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/CONTRIBUTORS.txt?ref=f70eaf315ab0d9fc7cab244492d27fd5c95c62e8",
      "patch": "@@ -74,6 +74,10 @@ In chronological order:\n * Lucas Cimon @Lucas-C\n   * Added the possibility to define CORS origins through ISSO_CORS_ORIGIN environment variable\n   * Fix a bug with <a> in <svg>\n+  * Fixing likes counter of replies not being displayed\n+  * Adding contrib/dump_comments.py\n+  * Adding a [server] proxy-fix-enable-x-prefix configuration option\n+  * Using .access_route instead of .remote_addr to take into account HTTP_X_FORWARDED_FOR header\n \n * Yuchen Pei @ycpei\n   * Fix link in moderation emails when isso is installed in a sub URL"
    },
    {
      "sha": "46c2ede17e2f3949cd70e9c80b47df37cba51e02",
      "filename": "docs/docs/configuration/server.rst",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/posativ/isso/blob/f70eaf315ab0d9fc7cab244492d27fd5c95c62e8/docs/docs/configuration/server.rst",
      "raw_url": "https://github.com/posativ/isso/raw/f70eaf315ab0d9fc7cab244492d27fd5c95c62e8/docs/docs/configuration/server.rst",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/docs/docs/configuration/server.rst?ref=f70eaf315ab0d9fc7cab244492d27fd5c95c62e8",
      "patch": "@@ -190,6 +190,13 @@ profile\n     show 10 most time consuming function in Isso after each request. Do\n     not use in production.\n \n+trusted-proxies\n+    an optional list of reverse proxies IPs behind which you have deployed\n+    your Isso web service (e.g. `127.0.0.1`).\n+    This allow for proper remote address resolution based on a\n+    `X-Forwarded-For` HTTP header, which is important for the mechanism\n+    forbiding several comment votes coming from the same subnet.\n+\n .. _configure-smtp:\n \n SMTP"
    },
    {
      "sha": "5610a372eb9581b9487b7e08ec2c3c1e2e153afc",
      "filename": "isso/views/comments.py",
      "status": "modified",
      "additions": 19,
      "deletions": 5,
      "changes": 24,
      "blob_url": "https://github.com/posativ/isso/blob/f70eaf315ab0d9fc7cab244492d27fd5c95c62e8/isso/views/comments.py",
      "raw_url": "https://github.com/posativ/isso/raw/f70eaf315ab0d9fc7cab244492d27fd5c95c62e8/isso/views/comments.py",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/isso/views/comments.py?ref=f70eaf315ab0d9fc7cab244492d27fd5c95c62e8",
      "patch": "@@ -140,6 +140,7 @@ def __init__(self, isso, hasher):\n         self.moderated = isso.conf.getboolean(\"moderation\", \"enabled\")\n         # this is similar to the wordpress setting \"Comment author must have a previously approved comment\"\n         self.approve_if_email_previously_approved = isso.conf.getboolean(\"moderation\", \"approve-if-email-previously-approved\")\n+        self.trusted_proxies = list(isso.conf.getiter(\"server\", \"trusted-proxies\"))\n \n         self.guard = isso.db.guard\n         self.threads = isso.db.threads\n@@ -275,7 +276,7 @@ def new(self, environ, request, uri):\n             data[\"website\"] = normalize(data[\"website\"])\n \n         data['mode'] = 2 if self.moderated else 1\n-        data['remote_addr'] = utils.anonymize(str(request.remote_addr))\n+        data['remote_addr'] = self._remote_addr(request)\n \n         with self.isso.lock:\n             if uri not in self.threads:\n@@ -336,6 +337,21 @@ def new(self, environ, request, uri):\n         resp.headers.add(\"X-Set-Cookie\", cookie(\"isso-%i\" % rv[\"id\"]))\n         return resp\n \n+    def _remote_addr(self, request):\n+        \"\"\"Return the anonymized IP address of the requester.\n+\n+        Takes into consideration a potential X-Forwarded-For HTTP header\n+        if a necessary server.trusted-proxies configuration entry is set.\n+\n+        Recipe source: https://stackoverflow.com/a/22936947/636849\n+        \"\"\"\n+        remote_addr = request.remote_addr\n+        if self.trusted_proxies:\n+            route = request.access_route + [remote_addr]\n+            remote_addr = next((addr for addr in reversed(route)\n+                                if addr not in self.trusted_proxies), remote_addr)\n+        return utils.anonymize(str(remote_addr))\n+\n     \"\"\"\n     @api {get} /id/:id view\n     @apiGroup Comment\n@@ -890,8 +906,7 @@ def _process_fetched_list(self, fetched_list, plain=False):\n     @xhr\n     def like(self, environ, request, id):\n \n-        nv = self.comments.vote(\n-            True, id, utils.anonymize(str(request.remote_addr)))\n+        nv = self.comments.vote(True, id, self._remote_addr(request))\n         return JSON(nv, 200)\n \n     \"\"\"\n@@ -917,8 +932,7 @@ def like(self, environ, request, id):\n     @xhr\n     def dislike(self, environ, request, id):\n \n-        nv = self.comments.vote(\n-            False, id, utils.anonymize(str(request.remote_addr)))\n+        nv = self.comments.vote(False, id, self._remote_addr(request))\n         return JSON(nv, 200)\n \n     # TODO: remove someday (replaced by :func:`counts`)"
    },
    {
      "sha": "3f66982ebb41d9d20593cabd1e9e272016dc7b98",
      "filename": "share/isso.conf",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/posativ/isso/blob/f70eaf315ab0d9fc7cab244492d27fd5c95c62e8/share/isso.conf",
      "raw_url": "https://github.com/posativ/isso/raw/f70eaf315ab0d9fc7cab244492d27fd5c95c62e8/share/isso.conf",
      "contents_url": "https://api.github.com/repos/posativ/isso/contents/share/isso.conf?ref=f70eaf315ab0d9fc7cab244492d27fd5c95c62e8",
      "patch": "@@ -112,6 +112,13 @@ reload = off\n # in production.\n profile = off\n \n+# an optional list of reverse proxies IPs behind which you have deployed\n+# your Isso web service (e.g. `127.0.0.1`).\n+# This allow for proper remote address resolution based on a\n+# `X-Forwarded-For` HTTP header, which is important for the mechanism\n+# forbiding several comment votes coming from the same subnet.\n+trusted-proxies =\n+\n \n [smtp]\n # Isso can notify you on new comments via SMTP. In the email notification, you"
    }
  ]
}
