{
  "sha": "a6f986b50fe70ac92a5e43862cfa625254b09623",
  "node_id": "MDY6Q29tbWl0NzU2OTU3ODphNmY5ODZiNTBmZTcwYWM5MmE1ZTQzODYyY2ZhNjI1MjU0YjA5NjIz",
  "commit": {
    "author": {
      "name": "Joffrey JAFFEUX",
      "email": "j.jaffeux@gmail.com",
      "date": "2020-04-28T16:24:24Z"
    },
    "committer": {
      "name": "GitHub",
      "email": "noreply@github.com",
      "date": "2020-04-28T16:24:24Z"
    },
    "message": "FEATURE: allows to to style published page with themes/plugins (#9570)",
    "tree": {
      "sha": "1e0971fecfe97762777c4fefed43b20aa84c16f1",
      "url": "https://api.github.com/repos/discourse/discourse/git/trees/1e0971fecfe97762777c4fefed43b20aa84c16f1"
    },
    "url": "https://api.github.com/repos/discourse/discourse/git/commits/a6f986b50fe70ac92a5e43862cfa625254b09623",
    "comment_count": 0,
    "verification": {
      "verified": true,
      "reason": "valid",
      "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeqFi4CRBK7hj4Ov3rIwAAdHIIAIRs0c/mOGYHWa5JIJSuE0Go\nzMHCXYgLqQqnXiTQoSBQ27c9ejzucwRA+5E+678NUKVN/q0Dgm562X60CMUOf1mR\nBeCVd9RsccxbTTRt4d3BWVQ5FIzYcnx1QFkh6i2Nf8o59PzpaDkOB2IOQAcqU/+2\ntEjE9VOelPC5KBIwgEaxXXLcNrbIGsBnE4cxeXekkCTZs3oRowO7N1z+wJRA7zFV\nQoY7j5ZxUVZ40yMsWz+yCMvkFaQ4BSwiU/BQfSQ45FMd1JFtaaMzVfggZ6DRaRGK\n9GMP7itgtPFI0vP7u43SYUT94f9MWMVkd16QQuRX/4K2rnnQBLsRZe4ADQmlAC0=\n=gzDO\n-----END PGP SIGNATURE-----\n",
      "payload": "tree 1e0971fecfe97762777c4fefed43b20aa84c16f1\nparent b19dcac2722fe1a97c898837834132d40731ac20\nauthor Joffrey JAFFEUX <j.jaffeux@gmail.com> 1588091064 +0200\ncommitter GitHub <noreply@github.com> 1588091064 +0200\n\nFEATURE: allows to to style published page with themes/plugins (#9570)\n\n"
    }
  },
  "url": "https://api.github.com/repos/discourse/discourse/commits/a6f986b50fe70ac92a5e43862cfa625254b09623",
  "html_url": "https://github.com/discourse/discourse/commit/a6f986b50fe70ac92a5e43862cfa625254b09623",
  "comments_url": "https://api.github.com/repos/discourse/discourse/commits/a6f986b50fe70ac92a5e43862cfa625254b09623/comments",
  "author": {
    "login": "jjaffeux",
    "id": 339945,
    "node_id": "MDQ6VXNlcjMzOTk0NQ==",
    "avatar_url": "https://avatars3.githubusercontent.com/u/339945?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jjaffeux",
    "html_url": "https://github.com/jjaffeux",
    "followers_url": "https://api.github.com/users/jjaffeux/followers",
    "following_url": "https://api.github.com/users/jjaffeux/following{/other_user}",
    "gists_url": "https://api.github.com/users/jjaffeux/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jjaffeux/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jjaffeux/subscriptions",
    "organizations_url": "https://api.github.com/users/jjaffeux/orgs",
    "repos_url": "https://api.github.com/users/jjaffeux/repos",
    "events_url": "https://api.github.com/users/jjaffeux/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jjaffeux/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "web-flow",
    "id": 19864447,
    "node_id": "MDQ6VXNlcjE5ODY0NDQ3",
    "avatar_url": "https://avatars3.githubusercontent.com/u/19864447?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/web-flow",
    "html_url": "https://github.com/web-flow",
    "followers_url": "https://api.github.com/users/web-flow/followers",
    "following_url": "https://api.github.com/users/web-flow/following{/other_user}",
    "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions",
    "organizations_url": "https://api.github.com/users/web-flow/orgs",
    "repos_url": "https://api.github.com/users/web-flow/repos",
    "events_url": "https://api.github.com/users/web-flow/events{/privacy}",
    "received_events_url": "https://api.github.com/users/web-flow/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "b19dcac2722fe1a97c898837834132d40731ac20",
      "url": "https://api.github.com/repos/discourse/discourse/commits/b19dcac2722fe1a97c898837834132d40731ac20",
      "html_url": "https://github.com/discourse/discourse/commit/b19dcac2722fe1a97c898837834132d40731ac20"
    }
  ],
  "stats": {
    "total": 92,
    "additions": 63,
    "deletions": 29
  },
  "files": [
    {
      "sha": "6fadf0b9b427b023c03353be819be74650b7f200",
      "filename": "app/assets/javascripts/discourse/app/templates/topic.hbs",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/discourse/discourse/blob/a6f986b50fe70ac92a5e43862cfa625254b09623/app/assets/javascripts/discourse/app/templates/topic.hbs",
      "raw_url": "https://github.com/discourse/discourse/raw/a6f986b50fe70ac92a5e43862cfa625254b09623/app/assets/javascripts/discourse/app/templates/topic.hbs",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/assets/javascripts/discourse/app/templates/topic.hbs?ref=a6f986b50fe70ac92a5e43862cfa625254b09623",
      "patch": "@@ -87,7 +87,7 @@\n       {{/topic-title}}\n \n       {{#if model.publishedPage}}\n-        <div class=\"published-page\">\n+        <div class=\"published-page-notice\">\n           <div class=\"details\">\n             {{i18n \"topic.publish_page.topic_published\"}}\n             <div>"
    },
    {
      "sha": "02b267ab134413047530aebe4d91f2005df0ef47",
      "filename": "app/assets/stylesheets/common/base/topic.scss",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/discourse/discourse/blob/a6f986b50fe70ac92a5e43862cfa625254b09623/app/assets/stylesheets/common/base/topic.scss",
      "raw_url": "https://github.com/discourse/discourse/raw/a6f986b50fe70ac92a5e43862cfa625254b09623/app/assets/stylesheets/common/base/topic.scss",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/assets/stylesheets/common/base/topic.scss?ref=a6f986b50fe70ac92a5e43862cfa625254b09623",
      "patch": "@@ -296,7 +296,7 @@ a.topic-featured-link {\n   }\n }\n \n-.published-page {\n+.published-page-notice {\n   display: flex;\n   justify-content: space-between;\n   padding-bottom: 1em;"
    },
    {
      "sha": "f06ff9881ae42e199e9e83ad4b9c543e75e7e6b4",
      "filename": "app/assets/stylesheets/publish.scss",
      "status": "modified",
      "additions": 21,
      "deletions": 21,
      "changes": 42,
      "blob_url": "https://github.com/discourse/discourse/blob/a6f986b50fe70ac92a5e43862cfa625254b09623/app/assets/stylesheets/publish.scss",
      "raw_url": "https://github.com/discourse/discourse/raw/a6f986b50fe70ac92a5e43862cfa625254b09623/app/assets/stylesheets/publish.scss",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/assets/stylesheets/publish.scss?ref=a6f986b50fe70ac92a5e43862cfa625254b09623",
      "patch": "@@ -1,32 +1,32 @@\n @import \"common\";\n \n-body {\n-  background-color: $secondary;\n-  color: $primary;\n+.published-page-wrapper {\n+  margin: 2em auto;\n+  max-width: 800px;\n }\n \n .published-page {\n-  margin: 2em auto;\n-  max-width: 800px;\n+  background-color: $secondary;\n+  color: $primary;\n+}\n \n-  h1 {\n-    color: $header_primary;\n-  }\n+.published-page-title {\n+  color: $header_primary;\n+}\n \n-  .published-page-author {\n-    margin-top: 1em;\n-    margin-bottom: 2em;\n-    display: flex;\n+.published-page-author {\n+  margin-top: 1em;\n+  margin-bottom: 2em;\n+  display: flex;\n \n-    .avatar {\n-      margin-right: 1em;\n-    }\n-    .topic-created-at {\n-      color: $primary-medium;\n-    }\n+  .avatar {\n+    margin-right: 1em;\n   }\n-\n-  .published-page-body {\n-    font-size: 1.25em;\n+  .topic-created-at {\n+    color: $primary-medium;\n   }\n }\n+\n+.published-page-body {\n+  font-size: 1.25em;\n+}"
    },
    {
      "sha": "67d3fb8bdabbf3212b23fc9a3986485d8cdb9d3d",
      "filename": "app/controllers/published_pages_controller.rb",
      "status": "modified",
      "additions": 12,
      "deletions": 0,
      "changes": 12,
      "blob_url": "https://github.com/discourse/discourse/blob/a6f986b50fe70ac92a5e43862cfa625254b09623/app/controllers/published_pages_controller.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/a6f986b50fe70ac92a5e43862cfa625254b09623/app/controllers/published_pages_controller.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/controllers/published_pages_controller.rb?ref=a6f986b50fe70ac92a5e43862cfa625254b09623",
      "patch": "@@ -15,6 +15,18 @@ def show\n     guardian.ensure_can_see!(pp.topic)\n     @topic = pp.topic\n     @canonical_url = @topic.url\n+\n+    @body_classes = Set.new([\n+      'published-page',\n+      params[:slug],\n+      \"topic-#{@topic.id}\",\n+      @topic.tags.pluck(:name)\n+    ].flatten.compact)\n+\n+    if @topic.category\n+      @body_classes << @topic.category.slug\n+    end\n+\n     render layout: 'publish'\n   end\n "
    },
    {
      "sha": "458aaff65fce12bd596e4c7f22c0b0448974bf0e",
      "filename": "app/views/common/_discourse_publish_stylesheet.html.erb",
      "status": "added",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/discourse/discourse/blob/a6f986b50fe70ac92a5e43862cfa625254b09623/app/views/common/_discourse_publish_stylesheet.html.erb",
      "raw_url": "https://github.com/discourse/discourse/raw/a6f986b50fe70ac92a5e43862cfa625254b09623/app/views/common/_discourse_publish_stylesheet.html.erb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/views/common/_discourse_publish_stylesheet.html.erb?ref=a6f986b50fe70ac92a5e43862cfa625254b09623",
      "patch": "@@ -0,0 +1,9 @@\n+<%= discourse_stylesheet_link_tag 'publish', theme_ids: nil %>\n+\n+<%- Discourse.find_plugin_css_assets(include_official: allow_plugins?, include_unofficial: allow_third_party_plugins?, mobile_view: mobile_view?, desktop_view: !mobile_view?, request: request).each do |file| %>\n+  <%= discourse_stylesheet_link_tag(file) %>\n+<%- end %>\n+\n+<%- if theme_ids.present? %>\n+  <%= discourse_stylesheet_link_tag(mobile_view? ? :mobile_theme : :desktop_theme) %>\n+<%- end %>"
    },
    {
      "sha": "5bb0f957c58334e56bc908d76b73e29289815793",
      "filename": "app/views/layouts/publish.html.erb",
      "status": "modified",
      "additions": 3,
      "deletions": 2,
      "changes": 5,
      "blob_url": "https://github.com/discourse/discourse/blob/a6f986b50fe70ac92a5e43862cfa625254b09623/app/views/layouts/publish.html.erb",
      "raw_url": "https://github.com/discourse/discourse/raw/a6f986b50fe70ac92a5e43862cfa625254b09623/app/views/layouts/publish.html.erb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/views/layouts/publish.html.erb?ref=a6f986b50fe70ac92a5e43862cfa625254b09623",
      "patch": "@@ -3,13 +3,14 @@\n   <head>\n     <meta charset=\"utf-8\">\n     <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover\">\n-    <%= discourse_stylesheet_link_tag 'publish', theme_ids: nil %>\n+\n+    <%= render partial: \"common/discourse_publish_stylesheet\" %>\n \n     <%- if @canonical_url -%>\n       <link rel=\"canonical\" href=\"<%= @canonical_url %>\" />\n     <%- end -%>\n   </head>\n-  <body>\n+  <body class=\"<%= @body_classes.to_a.join(' ') %>\">\n     <%= yield %>\n   </body>\n </html>"
    },
    {
      "sha": "4f51c094059f704a5169fc10d7e05e762ca85c40",
      "filename": "app/views/published_pages/show.html.erb",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/discourse/discourse/blob/a6f986b50fe70ac92a5e43862cfa625254b09623/app/views/published_pages/show.html.erb",
      "raw_url": "https://github.com/discourse/discourse/raw/a6f986b50fe70ac92a5e43862cfa625254b09623/app/views/published_pages/show.html.erb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/app/views/published_pages/show.html.erb?ref=a6f986b50fe70ac92a5e43862cfa625254b09623",
      "patch": "@@ -1,4 +1,4 @@\n-<div class=\"published-page\">\n+<div class=\"published-page-wrapper\">\n   <div class=\"published-page-header\">\n     <h1 class=\"published-page-title\"><%= @topic.title %></h1>\n "
    },
    {
      "sha": "6793761791284fa84a144d7e56ff5407de152c97",
      "filename": "spec/requests/published_pages_controller_spec.rb",
      "status": "modified",
      "additions": 15,
      "deletions": 3,
      "changes": 18,
      "blob_url": "https://github.com/discourse/discourse/blob/a6f986b50fe70ac92a5e43862cfa625254b09623/spec/requests/published_pages_controller_spec.rb",
      "raw_url": "https://github.com/discourse/discourse/raw/a6f986b50fe70ac92a5e43862cfa625254b09623/spec/requests/published_pages_controller_spec.rb",
      "contents_url": "https://api.github.com/repos/discourse/discourse/contents/spec/requests/published_pages_controller_spec.rb?ref=a6f986b50fe70ac92a5e43862cfa625254b09623",
      "patch": "@@ -76,9 +76,21 @@\n         expect(response.status).to eq(404)\n       end\n \n-      it \"returns 200 for a valid article\" do\n-        get published_page.path\n-        expect(response.status).to eq(200)\n+      context \"the article is valid\" do\n+        before do\n+          SiteSetting.tagging_enabled = true\n+          published_page.topic.tags = [Fabricate(:tag, name: \"recipes\")]\n+        end\n+\n+        it \"returns 200\" do\n+          get published_page.path\n+          expect(response.status).to eq(200)\n+        end\n+\n+        it \"defines correct css classes on body\" do\n+          get published_page.path\n+          expect(response.body).to include(\"<body class=\\\"published-page published-page-test topic-#{published_page.topic_id} recipes uncategorized\\\">\")\n+        end\n       end\n     end\n "
    }
  ]
}
